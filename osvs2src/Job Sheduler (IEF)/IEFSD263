         TITLE 'IEFSD263, INITIATOR ATTACH ROUTINE'                     00050002
IEFSD263 CSECT                                                          00100000
* SD63010 A                                                    @ZA05673 00108040
* A STATEMENTS NEAR LABEL SETPRIV                              @ZA11857 00116040
* A STATEMENTS NEAR LABEL BYPASS                               @ZA11857 00124040
* A STATEMENTS NEAR LABEL CHKCSCB                              @ZA11857 00132040
* A STATEMENTS NEAR LABEL NOFREER                              @ZA11857 00140040
* D STMTS WHICH WERE ADDED FOR ZA11857 NEAR CHKCSCB & NOFREER  @ZA16879 00141040
* A STMTS FOLLOWING SECTION 'TAKE PRE FREEPART EXIT'           @ZA16879 00142040
* CHANGED SECTION FOR 'ISSUE REQSWAP SYSEVENT'                 @ZA16879 00143040
* A SECTION FOR 'ISSUE TRANSWAP... '                           @ZA16879 00143340
* D STMTS NEAR LABEL GETREG                                    @ZA16879 00144040
* A STMTS NEAR LABEL SETPRIV                                   @ZA16879 00144540
* A STMTS IN 'SPECIAL PROCESSING FOR GETPART ERROR' SECTION    @ZA16879 00145040
* A CONSTANTS FOLLOWING DECLARE FOR 'ABENCODE'                 @ZA16879 00147040
*        SEE CHANGE LEVEL IN PROLOG FOR FLAGGING INFORMATION.           00150002
**********************************************************************  03450002
*                                                                       03500002
*   MODULE NAME= IEFSD263                                               03550002
*                                                                       03600002
*   DESCRIPTIVE NAME= ATTACH MODULE                                     03650002
*                                                                       03700002
*   COPYRIGHT= NONE                                                     03750002
*                                                                       03760002
*   STATUS= SU7 PTF                                            @ZA16879 03765040
*                                                                       03780002
*   FUNCTION= GET A REGION FOR THE JOB STEP IF REQUIRED. ATTACH         03790002
*   THE JOB STEP, WAIT ON THE EOT AND CANCEL ECB'S,                     03790402
*   AND EVENTUALLY DETACH THE JOB STEP.                                 03790802
*                                                                       03791202
*      OPERATION=                                                       03792002
*      1. TAKE THE PRE-FREEPART EXIT INDICATED BY THE IXL       YM00047 03793002
*                                                                       03794002
*      1A. IF THE JOB STEP IS AUTHORIZED TO USE THE 1ST, 2ND   @ZA16879 03794940
*      OR 'NOT 2ND' LEVEL PREFERRED STORAGE SET THE APPROPRI-  @ZA16879 03795940
*      ATE BITS IN THE ASCB.                                   @ZA16879 03796640
*                                                              @ZA16879 03796740
*      1B. IF THE JOB STEP IS V=R OR NON-SWAPPABLE, ISSUE      @ZA16879 03796840
*      SYSEVENT 'TRANSWAP'.  WAIT ON AN ECB, WHICH WILL BE     @ZA16879 03796940
*      POSTED WHEN ALL PROCESSING CAUSED BY THE TRANSWAP IS    @ZA16879 03797040
*      COMPLETE.                                               @ZA16879 03797140
*                                                                       03800002
*      1C. IF THE JOB STEP IS NOT V=R, NOT NONSWAPPABLE, AND   @ZA16879 03802040
*      THE 1ST LEVEL PREFERRED STORAGE USAGE IS REQUESTED,     @ZA16879 03804040
*      ISSUE SYSEVENT 'REQSWAP'.  WAIT ON AN ECB, WHICH WILL   @ZA16879 03806040
*      BE POSTED WHEN ALL PROCESSING CAUSED BY THE REQSWAP     @ZA16879 03808040
*      IS COMPLETE.                                            @ZA16879 03810040
*                                                              @ZA16879 03812040
*      2. FREE THE REGION.                                       Y02669 03817602
*                                                                       03818402
*      3. IF NO GWT EXISTS, GET A V=V REGION OF THE DEFAULT      Y02669 03820002
*      SIZE. THEN CONTINUE WITH STEP 9.                          Y02669 03820802
*                                                                       03821602
*      4. IF A GWT EXISTS, A SPECIAL REGION IS REQUIRED.         Y02669 03822402
*      (A GWT WILL EXIST ONLY IF ONE OF THE FOLLOWING IS TRUE:)  Y02669 03823202
*                                                                       03824002
*         A. SUBPOOL 242 IS INDICATED IN THE GWT (IE, V=R)       Y02669 03825302
*                                                                       03826802
*         B. A NON-ZERO REGION SIZE IS INDICATED IN THE GWT      Y02669 03827702
*         (ZERO WOULD INDICATE THE DEFAULT).                     Y02669 03828102
*                                                                       03829702
*         C. A SPECIFIC ADDRESS IS GIVEN IN THE GWT (IE, A       Y02669 03830502
*         CHECKPOINT RESTART).                                   Y02669 03831302
*                                                                       03832502
*      THE PROCESSING REQUIRED TO GET A SPECIAL REGION IS        Y02669 03834002
*      DESCRIBED IN STEPS 6 - 8.                                 Y02669 03834502
*                                                                       03835402
*      6. ISSUE GETMAIN, TO GET THE REGION INDICATED BY THE    @ZA16879 03836240
*         GWT.                                                 @ZA16879 03839740
*                                                                       03840602
*         A. IF THE RC=0, PROCEED WITH STEP 9.                          03841502
*                                                                       03842702
*         B. IF THE RC=4 OR 12, CONTINUE WITH STEP 7.                   03843402
*                                                                       03844802
*         C. FOR ANY OTHER RETURN CODE, CONTINUE WITH STEP 8.           03845502
*                                                                       03846302
*      7. ISSUE MESSAGE IEFO92I IF IT HAS NOT PREVIOUSLY BEEN    Y02669 03847602
*      ISSUED FOR THAT STEP. THEN WAIT ON THE GETPART AND CANCEL Y02669 03848402
*      ECB'S (LONG WAIT).                                        Y02669 03849302
*                                                                       03850502
*         A. IF THE CANCEL ECB IS POSTED, ISSUE FREEPART TO      Y02669 03851202
*         DELETE THE REQUEST AND GET A V=V REGION OF THE DEFAULT Y02669 03852002
*         SIZE. CONTINUE WITH STEP 10.                           Y02669 03853302
*                                                                       03854102
*         B. IF THE GETPART ECB IS POSTED WITH A CODE OF 0, THE  Y02669 03855702
*         REQUEST IS SATISFIED SO PROCEED WITH STEP 9.           Y02669 03856602
*                                                                       03857602
*         C. IF THE GETPART ECB IS POSTED WITH A CODE OF 4,      Y02669 03858402
*         CONTINUE WITH STEP 6 TO RETRY THE GETPART.             Y02669 03859602
*                                                                       03860402
*         D. IF THE GETPART ECB IS POSTED WITH A CODE OF 16,     Y02669 03861602
*         ISSUE A FREEPART TO DELETE THE REQUEST. IF THE REQUEST Y02669 03862802
*         WAS NOT FOR A SPECIFIC REGION ADDRESS, CONTINUE WITH   Y02669 03864002
*         STEP 6 TO RETRY THE GETPART. IF THE REQUEST WAS FOR A  Y02669 03864802
*         SPECIFIC REGION ADDRESS, RETRY IS NOT PRACTICAL SO     Y02669 03865602
*         CONTINUE WITH STEP 8.                                  Y02669 03866402
*                                                                       03867602
*      8. GET A V=V REGION OF THE DEFAULT SIZE. ISSUE EITHER     Y02669 03868402
*      IEF085I OR IEF186I, DEPENDING UPON WHETHER OR NOT THE     Y02669 03870002
*      REQUEST WAS FOR A SPECIFIC REGION ADDRESS. SET A          Y02669 03870402
*      GETPART-ERROR INDICATOR IN THE GWT.                       Y02669 03872002
*                                                                       03872802
*      9. IF A V=R REGION WAS GOTTEN, STORE THE BEGINNING        Y02669 03874002
*      ADDRESS OF THE REGION AND THE SIZE IN THE CSCB (FOR       Y02669 03874802
*      DISPLAY JOBS).                                            Y02669 03875602
*                                                                       03876402
*      9A. TAKE THE PRE-ATTACH EXIT AS INDICATED BY THE IXL.     Y02669 03877602
*                                                                       03878402
*      10. SET TASK NON-CANCELABLE, IF INDICATED BY LCT.                03879202
*                                                                       03880802
*      11. CALL IEFSMFAT TO BUILD THE TCTIOT.                           03882002
*                                                                       03882802
*      12. MOVE THE USER PARAMETER AREA FROM SP 253 TO SP 0.            03883602
*                                                                       03884402
*      13. IF THE GETPART HAS FAILED, CONTINUE PROCESSING WITH   Y02669 03885602
*      STEP 27.                                                  Y02669 03886402
*                                                                       03888002
*      15. ATTACH THE JOB STEP. SAVE THE CURRECT ASCB PRIORITY          03888140
*      IN IEFPARAM. THEN ISSUE THE SYSEVENT FOR 'INITATT,'       Y02655 03890002
*      PASSING THE FOLLOWING INFORMATION:                        Y02655 03890802
*        .     THE PERFORMANCE GROUP NUMBER FROM IEFPARAM OR 0,  Y02655 03892002
*              IF THE LCT INDICATES THE TASK IS PRIVILEGED.      Y02655 03892802
*        .     THE MEMORY DISPATCHING PRIORITY, AS CALCULATED BY Y02655 03893602
*              IEFSD103 AND SAVED IN IEFPARAM.                   Y02655 03894402
*        .     SET FLAG IN REGISTER 1 TO INDICATE AUTHORITY    @ZA16879 03894540
*              TO ISSUE OKSWAP AND DONTSWAP FOR A NONSWAPPABLE @ZA16879 03894640
*              JOB STEP.                                       @ZA16879 03894740
*        .     IF THE ATTACH WAS NOT SUCCESSFUL ISSUE AN ABEND  YM07020 03894940
*              FOR DIAGNOSTIC PURPOSES,  THE INITIATOR ESTAE    YM07020 03895240
*              WILL TAKE CARE OF CLEAN UP AND PROVIDE A DUMP.   YM07020 03895302
*                                                                       03895602
*      15A. CLEAR BIT ASCBCEXT IN CASE IT IS ON.                 Y02669 03896402
*                                                                       03897602
*      16. CLEAR THE ELAPSED TIME FIELDS IN THE ASCB. IF THE     Y02669 03898802
*      STEP IS TO BE TIMED, SET THE STEP TIME LIMIT IN THE ASCB  Y02669 03899602
*      AND TURN OFF THE INDICATOR IN THE ASCB WHICH PREVENTS     Y02669 03900802
*      CHECKING OF TIME LIMITS. INITIALIZE THE FIELD IN THE ASCB Y02669 03901702
*      WHICH CONTAINS THE WAIT TIME LIMIT.                       Y02669 03902602
*                                                                       03903502
*      17. IF THE CANCEL ECB HAS BEEN POSTED, SKIP TO STEP 20.          03904402
*                                                                       03905302
*      18. ISSUE STATUS TO MAKE THE JOB STEP TCB DISPATCHABLE.          03906202
*                                                                       03908002
*      19. ISSUE WAIT ON A LIST OF THE EOT AND CANCEL ECB'S.    YM06276 03908802
*                                                                       03910102
*      20. IF THE CANCEL ECB IS POSTED, ISSUE STATUS TO MAKE THE        03911602
*      DAUGHTER(S) NON-DISPATCHABLE AND INVOKE MGCR FOR ABTERM.         03912602
*      THEN RETURN TO STEP 19, UNTIL THE EOT ECB IS POSTED OR           03913602
*      THE CANCEL ECB IS POSTED A SECOND TIME. (BECAUSE OF USER         03914602
*      ESTAE/ESTAI WITH TERM=YES, MULTIPLE CANCEL MAY BE                03915602
*      NECESSARY.)                                                      03916602
*                                                                       03917602
*      21. (RESUME PROCESSING HERE AFTER THE EOT                 Y02669 03918602
*      ECB IS POSTED.)                                                  03918840
*                                                                       03922602
*      21A. SET THE CPU-TASK AFFINITY MASK IN THE ASCB TO BINARY Y02651 03924002
*      1'S, TO INDICATE THE MEMORY CAN NOW BE RUN ON ANY ONLINE  Y02651 03924402
*      CPU (IN CASE AFFINITY HAD BEEN REQUIRED FOR THE STEP).    Y02651 03925202
*                                                                       03927002
*      22. PUT THE CURRENT TCB POINTER IN THE PQE. (IN CASE THE         03927902
*      INITIATOR IS TERMINATING, IT IS NECESSARY TO PUT A               03928802
*      POINTER TO STC'S TCB IN THE PQE. IF ANY REGIONS WERE             03929702
*      GOTTEN DURING THE LIFE OF THE INITIATOR, THE TCB WILL BE         03930602
*      POINTED TO BY THE PQE. THE TCB POINTER MUST BE UPDATED           03932002
*      BECAUSE THE INITIATOR IS ABOUT TO BE DETACHED.)                  03932802
*                                                                       03933602
*      25. IF THE STEP WAS TIMED, SAVE THE STEP TIME ALLOWED,    Y02669 03938802
*      SRB TIME USED,                                            Y02669 03939702
*      AND STEP TIME USED FROM THE ASCB AND CALCULATE THE STEP   Y02669 03940602
*      TIME REMAINING.                                           Y02651 03941040
*                                                                       03941540
*                                                                       03942702
*      26. SAVE THE TASK COMPLETION CODE IN THE LCT.            YM01961 03943002
*                                                                       03943302
*      27. TAKE THE POST=ATTACH EXIT AS INDICATED BY THE IXL.    Y02669 03944202
*                                                                       03945602
*      29. IF THE GETPART HAS FAILED:                            Y02669 03946402
*                                                                       03946902
*         A. SET THE STEP TIME USED TO 0.                       YA02494 03947402
*                                                                       03948002
*         B. FREE THE GWT.                                       Y02669 03948802
*                                                                       03949602
*         C. BUILD A PARAMETER LIST FOR TERMINATION AS IF THE           03950402
*         STEP HAD FAILED WITH AN 822 SYSTEM COMPLETION CODE.           03951202
*                                                                       03952402
*         D. IF SYSEVENT TRANSWAP HAD PREVIOUSLY BEEN ISSUED   @ZA16879 03952740
*         OR IF ANY OF ASCB1LPU, ASCB2LPU, OR ASCBN2LP ARE     @ZA16879 03953040
*         TURNED ON, ISSUE SYSEVENTS 'INITATT' AND 'INITDET'.  @ZA16879 03953340
*         THE INITATT IS ISSUED TO ALLOW FOR THE INITDET WHICH @ZA16879 03953640
*         MUST BE ISSUED TO CLEANUP FROM THE GETPART ERROR.    @ZA16879 03953940
*                                                                       03955602
*         E. CONTINUE WITH STEP 33.                              Y02669 03956402
*                                                                       03958002
*      30. BUILD PARAMETER LIST FOR IEFSD164 WITH INFORMATION           03958602
*      FOR THE DUMMY TCB.                                               03959202
*                                                                       03961002
*      32. FREE THE CURRENTLY OWNED REGION AND GET A V=V REGION  Y02669 03963702
*      OF THE DEFAULT SIZE. IF THEY ARE NON-ZERO, CLEAR THE CSCB Y02669 03964602
*      FIELDS WHICH CONTAIN THE SIZE AND BEGINNING ADDRESS OF    Y02669 03966002
*      THE REGION.  ISSUE SYSEVENT                             @ZA16879 03966440
*      'INITDET' TO INDICATE THAT A JOB STEP IS ABOUT TO BE    @ZA03278 03967040
*      DETACHED. PASS THE FORMER ASCB PRIORITY,WHICH HAD BEEN  @ZA03278 03967140
*      SAVED IN IEFPARAM BY THIS MODULE. CLEAR THE TIME LIMIT  @ZA03278 03967240
*      AND ELAPSED TIME LIMIT FIELDS IN THE ASCB. DETACH THE   @ZA03278 03967340
*      DAUGHTER TASK. FREE THE GWT IF IT EXISTS.               @ZA03278 03967440
*                                                                       03967602
*      33. EXIT TO IEFSD164.                                            03968402
*                                                                       03970002
*   NOTES                                                               03970802
*                                                                       03971602
*      CHARACTER CODE DEPENDENCIES= NONE                                03972802
*                                                                       03973702
*      DEPENDENCIES= MODULE IEFIB650 CONTAINS MESSAGE TEXTS.            03974602
*                                                                       03975502
*      RESTRICTIONS= NONE                                               03976402
*                                                                       03977302
*      REGISTER CONVENTIONS= STANDARD                                   03978202
*                                                                       03979602
*      PATCH-LABEL= PATCH                                               03980402
*                                                                       03982002
*   MODULE TYPE= PROCEDURE                                              03982802
*                                                                       03983602
*      PROCESSOR= ASSEMBLER (XF)                                        03984402
*                                                                       03985202
*      MODULE SIZE= 4096 BYTES                                          03986402
*                                                                       03987302
*      ATTRIBUTES= PAGED LPA, ZERO PSW PROTECT KEY, REENTRANT,          03988202
*      REUSABLE, REFRESHABLE, SUPERVISOR STATE                          03990002
*                                                                       03990902
*   ENTRY POINT= IEFSD263                                               03991802
*                                                                       03992502
*      PURPOSE= SAME AS FUNCTION                                        03994002
*                                                                       03994802
*      LINKAGE= FROM IEFSD103, VIA BRANCH                               03995602
*                                                                       03996402
*      INPUT DATA= REGISTER 1 POINTS TO IEFPARAM                        03998002
*                  IEFLCTAD POINTS TO LCT                               03998802
*                  LCTPARM3 POINTS TO GWT                               04000002
*                  CHCECB IS CANCEL ECB                                 04000902
*                                                                       04001802
*      REGISTERS SAVED= NONE                                            04002702
*                                                                       04003602
*      REGISTER CONTENTS DURING PROCESSING=                             04004502
*                                                                       04005402
*      REGISTER 5 FREQUENTLY POINTS TO THE CURRENT TCB.                 04006302
*      REGISTER 11 FREQUENTLY POINTS TO THE SUBTASK TCB. OTHER          04007202
*      REGISTERS ARE ALSO USED TO ADDRESS THE TCB.                      04009002
*                                                                       04009902
*      REGISTERS RESTORED= NONE                                         04010802
*                                                                       04011702
*   EXIT - NORMAL= TO IEFSD164 VIA BRANCH                               04012602
*                                                                       04013502
*      CONDITIONS= EITHER NO SPECIAL REGION WAS REQUIRED OR A           04014402
*      REGION WAS REQUIRED AND WAS SUCCESSFULLY GOTTEN.                 04015302
*                                                                       04016202
*      OUTPUT DATA= REGISTER 1 POINTS TO IEFPARAM                       04018002
*                   LCTPARM1 CONTAINS THE FOLLOWING:                    04018902
*                      TCBFLGS                                          04019802
*                      TCT POINTER                                      04020702
*                      DISPATCHING PRIORITY                             04021602
*                      TASK COMPLETION CODE                             04022502
*                                                                       04023402
*      RETURN CODES= NONE                                               04024302
*                                                                       04025202
*   EXIT - ERROR= TO IEFSD164 VIA BRANCH                                04027002
*                                                                       04027902
*      CONDITIONS= UNABLE TO OBTAIN REQUIRED REGION FOR JOB STEP.       04028802
*                                                                       04029702
*      OUTPUT DATA= REGISTER 1 POINTS TO IEFPARAM                       04030602
*                   LCTPARM1 CONTAINS THE FOLLOWING:                    04031502
*                      TCBFLGS (TCBFA SET ON)                           04032402
*                      TCT POINTER                                      04033302
*                      DISPATCHING PRIORITY                             04034202
*                      TASK COMPLETION CODE OF 822                      04036002
*                                                                       04036902
*      RETURN CODES= NONE                                               04037802
*                                                                       04038702
*   EXIT - ABEND                                                YM07020 04039002
*                                                                       04039302
*      CONDITIONS= ERROR RETURN FROM ATTACH WHILE TRYING        YM07020 04039602
*                  TO ATTACH THE JOB STEP.                      YM07020 04043202
*      OUTPUT DATA= REGISTER 1 CONTAINS THE ABEND CODE.         YM07020 04045002
*                   REGISTER 15 CONTAINS THE ATTACH ERROR CODE. YM07020 04045402
*                                                                       04045902
*      RETURN CODES= NONE                                       YM07020 04046102
*                                                                       04046302
*   EXTERNAL REFERENCES=                                                04046502
*                                                                       04046802
*      ROUTINES= IEFSMFAT VIA BALR, TO BUILD TCTIOT AND                 04048602
*      INITIALIZE TCT CORE MAP. REGISTER 0 POINTS TO CURRENT            04050002
*      TCB AND REGISTER 1 POINTS TO TIOT POINTER.                       04052002
*      OUTPUT= REG 15 POINTS TO TCT.                                    04054002
*                                                                       04055002
*      THIS ROUTINE WILL TAKE THE FOLLOWING GENERALIZED EXITS,          04057002
*      IF INDICATED BY THE INITIATOR EXIT LIST OF THE IEL.              04059002
*                                                                       04060002
*         PRE-FREEPART                                          YM00047 04062002
*         INPUT= LCT                                            YM00047 04065002
*         OUTPUT= NONE                                          YM00047 04066002
*         RETURN CODES= NONE                                    YM00047 04067002
*                                                                       04069002
*         PRE-INVOCATION                                         Y02669 04071002
*         INPUT= LCT, TIOT                                       Y02669 04072002
*         OUTPUT= NONE                                           Y02669 04074002
*         RETURN CODES= 0 (SUCCESSFUL), NON-ZERO (NOT            Y02669 04076002
*            SUCCESSFUL)                                         Y02669 04077002
*                                                                       04079002
*         POST-INVOCATION                                               04082002
*         INPUT= REG 1 POINTS DIRECTLY TO LCT                           04083002
*         OUTPUT= NONE                                                  04084002
*         RETURN CODES= 0 (SUCCESSFUL), NON-0 (NOT                      04086002
*            SUCCESSFUL)                                                04088002
*                                                                       04089002
*      DATA AREAS= IEFIB650 (CONTAINS MESSAGE TEXTS)                    04091002
*                                                                       04093002
*      CONTROL BLOCKS= PQE, TCT, LCT, CSCB, JSCB, TIOT,                 04094002
*      TCB, ASCB, IEL, GDA (GLOBAL DATA AREA), PSA             @ZA11857 04095040
*                                                                       04099002
*      TABLES= GWT (GETPART WORK TABLE)                                 04100002
*              ATTACH PARAMETER LIST                                    04101002
*              IEFPARAM (TO PASS DATA BETWEEN INITIATOR MODULES)        04102002
*                                                                       04103002
*      MACROS= GETMAIN, FREEMAIN, ATTACH, STATUS, WAIT, POST,    Y02655 04104002
*              MGCR, DETACH, SYSEVENT, XCTL, LINK, ABEND        YM07020 04105002
*                                                                       04106002
*      ENQUEUE RESOURCES= NONE                                          04107002
*                                                                       04108002
*      CHANGE LEVEL= SEE MODID MACRO AT BEGINNING OF MODULE             04109002
*      CODE HAS BEEN ADDED FOR THE FOLLOWING SUPPORT CODES:             04110002
*                                                                Y02669 04111002
*                                                                Y02655 04112002
*                                                                Y02652 04113002
*                                                                Y02651 04114002
*                                                              @Z30DNPJ 04114140
*      CODE HAS BEEN ADDED FOR THE FOLLOWING APARS:                     04114240
*                                                              @ZA03278 04114340
*                                                              @ZA05650 04114540
*                                                              @ZA05662 04114740
*                                                              @ZA05673 04114940
*                                                              @ZA11857 04115140
*                                                              @ZA16879 04115340
*                                                                       04115840
*   MESSAGES=                                                           04116002
*   IEF092I JJJ SSS PPP WAITING FOR XXXXXK REAL STORAGE          Y02669 04117002
*   IEF085I REGION UNAVAILABLE, ERROR CODE=XX                    Y02669 04118002
*   IEF186I REGION UNAVAILABLE FOR RESTART, ERROR CODE=XX        Y02669 04119002
*                                                                       04120002
*   ABEND CODE = X'0BB'  ATTACH FAILED                          YM07020 04121002
*                                                                       04122002
**********************************************************************  04123002
R0       EQU   0                                                        04124002
R1       EQU   1                                                        04125002
R2       EQU   2                                                        04126002
R3       EQU   3                                                        04127002
R4       EQU   4                                                        04128002
R5       EQU   5                                                        04129002
R6       EQU   6                                                        04130002
R7       EQU   7                                                        04150000
R8       EQU   8                                                        04200000
R9       EQU   9                                                        04250000
R10      EQU   10                                                       04300000
R11      EQU   11                                                       04350000
R12      EQU   12                                                       04400000
R13      EQU   13                                                       04450000
R14      EQU   14                                                       04500000
R15      EQU   15                                                       04550000
         BALR  R12,0                    SET BASE REGISTER               05050000
         USING *,R12                                                    05100000
         USING  IEFPARAM,R8                                             05150000
         USING  IEFLOT,R4                                               05200000
*********************************************************************** 05350000
*                                                                     * 05400000
*  THIS SECTION OF CODE IS FOR PROVIDING A METHOD OF IDENTIFYING      * 05450000
*                THIS MODULE IN A MEMORY DUMP                         * 05500000
*                                                                     * 05550000
IEFSD263 MODID                                                   Y01886 05600000
*                                                                     * 05650000
*********************************************************************** 05700000
         EJECT                                                          05750000
         LR    R8,R1               SAVE PTR. TO IEFPARAM                05800002
         L     R4,IEFLCTAD         LOAD LCT POINTER              Y02669 05850002
*****************************************************************       05900002
*                                                                       05950002
*        TAKE THE PRE FREEPART EXIT INDICATED BY THE IEL        YM00047 06000002
*                                                                       06050002
*****************************************************************       06100002
         LA    R3,LCTPARM4         SET UP FOR PARM LIST         YM00047 06110002
*                                  WHILE REG 4 POINTS TO LCT    YM00047 06120002
         L     R4,LCTENTR          LOAD POINTER TO IEL          YM00047 06150002
         USING IEL,R4                                           YM00047 06200002
         L     R4,IELEXIT          LOAD PTR TO INIT EXIT LIST   YM00047 06250002
*                                  TO PASS TO SUBROUTINE        YM00047 06260002
         DROP  R4                                               YM00047 06300002
         LA    R2,IELPRFRE         INDICATE PRE FREEPART EXIT   YM00047 06350002
         MVC   0(X4,R3),IEFLCTAD   SET POINTER TO LCT IN LIST   YM00047 06380402
         BAL   R9,SETEXIT          CALL SUBROUTINE WHICH TAKES  YM00047 06382602
*                                  EXIT                         YM00047 06383002
         L     R4,IEFLCTAD                                      YM00047 06384302
         USING IEFLOT,R4                                        YM00047 06384402
***************************************************************@ZA16879 06384940
*                                                              @ZA16879 06385440
*        SET PREFERRED STORAGE BITS IN ASCB                    @ZA16879 06386140
*                                                              @ZA16879 06386240
***************************************************************@ZA16879 06386340
         TM    LCTPUBYT,LCT1LPU+LCT2LPU+LCTN2LP                @ZA16879 06386440
*                                  ANY PREFERRED USAGE WANTED? @ZA16879 06386540
         BZ    TESTRAN             NO, TEST IF TRANSWAP NEC.   @ZA16879 06386640
         ICM   R7,MSKBYT0,LCTPUBYT PUT FLAG BYTE IN BYTE 0     @ZA16879 06386740
         N     R7,E0000000         ZERO UNWANTED BITS          @ZA16879 06386840
         L     R10,LCTASCBA        GET ADDR OF ASCB            @ZA16879 06386940
         USING ASCB,R10            ESTAB. ADDRESSABILITY       @ZA16879 06387040
         L     R6,ASCBRSM          GET ORIGINAL VALUE          @ZA16879 06387140
MODASCB  EQU   *                                               @ZA16879 06387240
         LR    R5,R6               OBTAIN COPY TO MODIFY       @ZA16879 06387340
         OR    R5,R7               MODIFY: TURN ON APPROPRIATE @ZA16879 06387440
*                                  FLAGS                       @ZA16879 06387540
         CS    R6,R5,ASCBRSM       STORE NEW FLAGS UNLESS ASCB @ZA16879 06387640
*                                  VALUES WERE CHANGED         @ZA16879 06387740
         BNE   MODASCB             TRY AGAIN IF NO SWAP MADE   @ZA16879 06387840
         DROP  R10                                             @ZA16879 06387940
TESTRAN  EQU   *                                               @ZA16879 06388040
*****************************************************************       06388140
*                                                                       06388540
*        ISSUE TRANSWAP SYSEVENT IF JOB STEP IS TO BE          @ZA16879 06389240
*        NON-SWAPPABLE OR V=R                                  @ZA16879 06389940
*                                                              @ZA16879 06390640
*****************************************************************       06392602
         L     R11,LCTPARM3        ADDRESS OF GWT              @ZA16879 06392940
         USING GETPTWT,R11                                     @ZA16879 06393240
         CLI   GPSUBP,GPREAL       IS STEP V=R?                @ZA16879 06393540
         BE    TRANSWAP            YES, ISSUE TRANSWAP         @ZA16879 06393840
         DROP  R11                                             @ZA16879 06394140
         TM    LCTPUBYT,LCTNSWP    NON-SWAPPABLE?              @ZA16879 06394640
         BNO   REQSWAP             NO, SKIP TRANSWAP           @ZA16879 06395240
TRANSWAP EQU   *                                               @ZA16879 06396640
*        THE SRM WILL POST THE ECB POINTED TO BY REG 1 WHEN THE YM03531 06414602
*        TRANSWAP PROCESSING IS COMPLETE.                      @ZA16879 06414940
         LA    R1,PARSRMEC         POINT TO THE ECB IN LSQA     YM03531 06417002
*        (THE ECB WAS CLEARED WHEN IEFPARAM WAS GOTTEN.)        YM03531 06417602
*                                                                       06418602
         SYSEVENT TRANSWAP         ISSUE 'TRANSWAP'            @ZA16879 06419640
*                                                                       06424602
*        CHECK THE RETURN CODE FROM THE SRM, WHICH IS BYTE 3 OF YM03531 06425002
*        REG 1. IF THE RETURN CODE WAS NON-ZERO, (I.E. X'04'), @ZA16879 06426040
*        THEN THE TRANSWAP WAS ALREADY ISSUED, SO BYPASS       @ZA16879 06427040
*        WAITING ON THE ECB, BECAUSE IT WILL NOT BE POSTED.     YM03531 06433602
*        NOTE: IF TRANSWAP PROCESSING FINDS THE ADDRESS        @ZA16879 06433740
*        SPACE NONSWAPPABLE FOR A REASON OTHER THAN A PREVIOUS @ZA16879 06433840
*        TRANSWAP, THE ISSUER IS ABENDED EXCEPT WHEN THE       @ZA16879 06435640
*        MASTER SCHEDULER IS BEING INITIATED. WHEN THE MASTER  @ZA16879 06436140
*        SCHEDULER IS BEING INITIATED, EVEN THOUGH ITS ADDRESS @ZA16879 06436640
*        SPACE IS NONSWAPPABLE, THE TRANSWAP PROCESSING PASSES @ZA16879 06437140
*        A RETURN CODE=4.                                      @ZA16879 06437240
*                                                              @ZA16879 06437640
         CLM   R1,B'0001',RC0                                   YM03531 06437840
         BNZ   TSWPCOMP            DO NOT WAIT IF REJECTED     @ZA16879 06438040
*        WAIT TO INSURE THAT THE SWAP IS COMPLETE.              YM03531 06438602
         LA    R1,PARSRMEC                                      YM03531 06442602
         WAIT  ECB=(R1)                                         YM03531 06446602
*        CHECK POST CODE FROM TRANSWAP                         @ZA16879 06446940
         CLC   PARSRMEC(X4),ZEROPOST  IS POST CODE = 0  ?      @ZA16879 06447240
         BNE   TSWPERR                NO, PROCESS ERROR        @ZA16879 06447540
TSWPCOMP EQU   *                                               @ZA16879 06447840
         OI    LCTINTS2,LCTTSWPC      TRANSWAP COMPLETE        @ZA16879 06448140
         B     DONTSWAP               PROCEED                  @ZA16879 06448440
TSWPERR  EQU   *                                               @ZA16879 06448740
*        ISSUE ABEND 35F TO INDICATE TRANSWAP ERROR.  IEFIB620 @ZA16879 06448840
*        WILL GET CONTROL TO TAKE DUMP, THEN IEFIB621 WILL     @ZA16879 06448940
*        ISSUE ABEND 922, AND THIS JOB WILL FAIL.              @ZA16879 06449040
         ABEND X'35F',,,SYSTEM        ISSUE ABEND 35F          @ZA16879 06449140
         SPACE 2                                                        06449240
***************************************************************@ZA16879 06449640
*                                                              @ZA16879 06450040
*        ISSUE REQSWAP SYSEVENT IF NECESSARY                   @ZA16879 06450440
*                                                              @ZA16879 06450840
***************************************************************@ZA16879 06451240
*                                                              @ZA16879 06451640
*        REQSWAP IS ISSUED IF THE JOB STEP IS NOT NONSWAPPABLE @ZA16879 06452040
*        AND NOT V=R, AND THE 1ST LEVEL PREFERRED USAGE IS     @ZA16879 06452440
*        SPECIFIED.                                            @ZA16879 06453640
*                                                              @ZA16879 06453740
REQSWAP  EQU   *                                               @ZA16879 06453840
         TM    LCTPUBYT,LCT1LPU    IS 1ST LEVEL PREF. REQUIRED @ZA16879 06453940
         BZ    DONTSWAP            NO, BYPASS REQSWAP          @ZA16879 06454040
         LA    R1,PARSRMEC         POINT TO THE ECB IN LSQA    @ZA16879 06454140
*        (THE ECB WAS CLEARED WHEN IEFPARAM WAS GOTTEN.)       @ZA16879 06454240
*                                                              @ZA16879 06454340
         SYSEVENT REQSWAP          ISSUE 'SWAP' SYSEVENT       @ZA16879 06454440
*                                                              @ZA16879 06454540
*        CHECK THE RETURN CODE FROM THE SRM,WHICH IS BYTE 3 OF @ZA16879 06454640
*        REG 1.  IF THE RETURN CODE WAS NON-ZERO, THE REQSWAP  @ZA16879 06454740
*        WAS REJECTED, THEREFORE BYPASS WAITING ON THE ECB,    @ZA16879 06454840
*        BECAUSE IT WILL NOT BE POSTED.                        @ZA16879 06454940
*                                                              @ZA16879 06455040
         CLM   R1,B'0001',RC0      TEST RETURN CODE            @ZA16879 06455140
         BNZ   DONTSWAP            DO NOT WAIT IF REJCTED      @ZA16879 06455240
*        WAIT TO INSURE REQSWAP IS COMPLETE.                   @ZA16879 06455340
         LA    R1,PARSRMEC         POINT TO ECB                @ZA16879 06455440
         WAIT  ECB=(R1)                                        @ZA16879 06455540
         SPACE 2                                                        06455640
*        CONTINUE NORMAL PROCESSING WHEN COMPLETE.              YM03531 06455740
DONTSWAP EQU   *                                                 Y02669 06457940
         EJECT                                                          06458002
*****************************************************************       06462002
*                                                                       06466002
*        GET A REGION                                                   06470002
*                                                                       06474002
*****************************************************************       06478002
*                                                                Y02669 06482002
*        A SPECIAL REGION IS GOTTEN ONLY IF ONE OR MORE OF THE   Y02669 06486002
*        FOLLOWING IS TRUE:                                      Y02669 06490002
*              A SPECIFIC REGION SIZE WAS REQUESTED              Y02669 06494002
*              A V=R REGION WAS REQUESTED                        Y02669 06500002
*              A CHECKPOINT RESTART IS BEING DONE (SPECIFIC ADDR)Y02669 06550002
*        HOWEVER, A FREEPART/GETPART IS ALWAYS DONE TO INSURE    Y02669 06600002
*        THAT NO STORAGE IS ALLOCATED WITHIN THE REGION WHEN THE Y02669 06610002
*        JOB STEP IS ATTACHED EXCEPT FOR:                        Y02669 06620002
*              THE USER PARM FIELD (GOTTEN BY THIS MODULE)       Y02669 06630002
*              ANY STORAGE GOTTEN BY THE PRE-ATTACH EXIT         Y02669 06640002
*              THE REGISTER SAVE AREA GOTTEN BY ATTACH           Y02669 06642002
         L     R0,SP247            SET V=V SUBPOOL              YM00408 06644002
         LA    R1,POSITIVE         SET POSITIVE TO INDICATE A   YM00408 06648002
*                                  FREEMAIN BUT NOT A SUBPOOL   YM00408 06648402
*                                  FREEMAIN                     YM00408 06648802
         FREEMAIN R,LV=(0),A=(1)   ISSUE FREEPART               YM00408 06649202
         L     R11,LCTPARM3        ADDRESS OF GWT                  I272 06650000
         USING GETPTWT,R11                                       Y02669 06660002
         LA    R11,X0(R11)        ZERO HIGH ORDER BYTE             I272 06700000
         LTR   R11,R11             DOES GWT EXIST                  I272 06750000
         BNZ   GETREG              GET A SPECIAL REGION          Y02669 06800002
*        GET A V=V REGION OF THE DEFAULT SIZE                    Y02669 06850002
         L     R0,SP247                                          Y02669 06900002
         GETMAIN R,LV=(0)                                        Y02669 06950002
         B     SD06305             SKIP ELSE CLAUSE (GETTING A   Y02669 07000002
*                                  SPECIAL REGION)               Y02669 07050002
GETREG   EQU   *                                                 Y01054 07400002
         L     R1,LCTTCBAD         GET POINTER TO CURRENT TCB    Y01054 07450000
         L     R1,TCBJSCB-TCB(R1)  GET POINTER TO JSCB           Y01054 07500001
         USING IEZJSCB,R1                                        Y01054 07550000
         XC    JSCBSECB(X4),JSCBSECB  CLEAR ECB IN CASE IT WAS   Y01054 07600000
*                                  POSTED AFTER A PREVIOUS       Y01054 07650000
*                                  GETPART                       Y01054 07700000
*        (THE ECB MUST NOT BE CLEARED AFTER THE GETPART IS       Y02669 07710002
*        ISSUED, BECAUSE THE ECB MAY BE POSTED ANY TIME AFTER    Y02669 07730002
*        THE GETPART IS ISSUED.)                                 Y02669 07740002
         DROP  R1                                                Y01054 07750000
         SPACE                                                          07760002
SKIPNSWP EQU   *                                                YM03531 07830002
         LR    R1,R11              POINT TO GWT                  Y01054 07850000
         GETMAIN  ,MF=(E,(1))      GET REGION                    Y01054 07900002
         LTR   R15,R15                                           Y01054 07950000
         BZ    SD06305             SUCCESSFUL GETPART            Y02669 08000002
         STC   R15,GPERROR         SAVE ERROR CODE FOR MESSAGE   Y02669 08050002
         CH    R15,RC4             CHECK FOR RC=4                Y02669 08100002
         BE    RC4OR12             GO WAIT FOR REGION            Y01054 08150000
         CH    R15,RC12            CHECK FOR RC=12               Y02669 08200002
         BNE   ERROR               UNSUCCESSFUL, WRITE ERROR MSG Y01054 08300000
*****************************************************************       08310002
*                                                                       08320002
*        ISSUE MESSAGE IEF092I PRIOR TO WAITING FOR A REGION            08330002
*                                                                       08340002
*****************************************************************       08342002
RC4OR12  EQU   *                                                 Y01054 08350000
         TM    GPFLGS,GPMSG        CHECK WHETHER IEFO92I WAS     Y01054 08400000
*                                  WRITTEN                       Y01054 08450000
         BO    REGWAIT             SKIP WRITING MESSAGE TWICE    Y01054 08500000
         OI    GPFLGS,GPMSG        SET MESSAGE IEFO92I SWITCH    Y01054 08550000
         L     R0,GETMAIN1         GET STORAGE FOR MESSAGE       Y01054 08600000
         GETMAIN R,LV=(0)                                        Y01054 08650000
         LR    R9,R1                                             Y01054 08700000
         USING MSG092I,R9                                        Y02669 08710002
         L     R14,LCTIMSG         GET POINTER TO IEFIB650       Y01054 08750000
         LA    R15,MSG3(0,R14)     GET POINTER TO ENTRY IN TABLE Y01054 08800000
*                                  AT BEGINNING OF IEFIB650      Y01054 08850000
         AH    R14,X2(0,R15)       GET ADDRESS OF MSG IEF092I    Y01054 08900000
         IC    R15,X1(0,R15)       GET LENGTH OF MESSAGE         Y01054 08950000
         BCTR  R15,0               REDUCE LENGTH FOR EXECUTE     Y01054 09000000
         EX    R15,MOVE            MOVE MSG TO BUFFER            Y01054 09050000
         L     R15,IEFTIOTA        GET PTR TO JOB STEP TIOT PTR  Y01054 09100000
         L     R15,0(0,R15)        GET POINTER TO JOB STEP TIOT  Y01054 09150000
         USING TIOT,R15                                          Y01054 09200000
         MVC   MSG3J,TIOCNJOB      MOVE JOBNAME TO MSG           Y01054 09250002
         MVC   MSG3S,TIOCSTEP      MOVE STEPNAME                 Y01054 09300002
         MVC   MSG3P,TIOCSTEP+8    MOVE PROCSTEP NAME            Y01054 09350002
         L     R1,GPSIZEH0         GET REGION SIZE FOR MESSAGE   Y02669 09360002
         LA    R1,0(0,R1)          CLEAR END OF LIST INDICATOR   Y02669 09370002
         LTR   R1,R1                                             Y02669 09380002
         BNZ   NOTDEFLT            REGION SIZE WAS SPECIFIED     Y02669 09390002
*                                  OTHERWISE GET DEFAULT VALUE   Y02669 09392002
         L     R15,CVTPTR                                        Y02669 09392402
         USING CVTMAP,R15                                        Y02669 09392802
         L     R15,CVTGDA          POINT TO GLOBAL DATA AREA     Y02669 09394002
         USING GDA,R15                                           Y02669 09396002
         L     R1,VRDREG           GET V=R DEFAULT SIZE          Y02669 09398002
NOTDEFLT EQU   *                                                 Y02669 09398402
         SRL   R1,TWOTO10          CONVERT FROM BYTES TO         Y02669 09398502
*                                  NUMBER OF 1024 UNITS ('K')    Y02669 09398602
         MH    R1,H10              THIS MULTIPLICATION HAS THE   Y02669 09398802
*              EFFECT OF SHIFTING LEFT ONE DECIMAL POSITION.     Y02669 09399202
*              THEREFORE, WHEN THE NUMBER IS CONVERTED TO        Y02669 09399602
*              DECIMAL, THE LOW ORDER DIGIT CAN BE DISCARDED.    Y02669 09399702
*              (OTHERWISE, IT WOULD BE NECESSARY TO HAVE         Y02669 09399802
*              CHARACTER DEPENDENT CODE.)                        Y02669 09399902
         CVD   R1,PACKED           CONVERT REGION SIZE TO PACKED Y02669 09416602
*                                  DECIMAL                       Y02669 09426602
         UNPK  ZONED,PACKED        UNPACK REGION SIZE            Y02669 09428602
         MVC   MSG3R,ZONED         MOVE THE SIZE TO MESSAGE (THE Y02669 09430602
*                                  EXTRA BYTE WITH +0 IS LEFT)   Y02669 09432602
         DROP  R15                                               Y02651 09432902
         WTO   MF=(E,(R9))                                       Y01054 09433302
         L     R0,GETMAIN1         FREE MESSAGE BUFFER           Y01054 09450000
         FREEMAIN R,LV=(0),A=(R9)                                Y01054 09500000
*                                                                Y01054 09550000
*        SET UP ECB LIST                                         Y01054 09600000
         L     R7,LCTTCBAD         GET POINTER TO CURRENT TCB    Y01054 09650000
         L     R7,TCBJSCB-TCB(R7)                                Y01054 09700001
         USING IEZJSCB,R7                                        Y01054 09750000
         LA    R1,JSCBSECB                                       Y01054 09800000
         ST    R1,GPGPECBP                                       Y01054 09850000
         L     R9,LCTQDRTY         GET POINTER TO CSCB           Y01054 09900000
         USING IEFCSCB,R9                                        Y01054 09950000
         LA    R1,CHCECB                                         Y01054 10000000
         ST    R1,GPCECBP                                        Y01054 10050000
         OI    GPCECBP,GPBIT       SET END OF ECB LIST           Y01054 10100000
         OI    CHACT,CHCL          SET TASK CANCELABLE DURING    Y02669 10110002
*                                  WAIT (IN CASE NOT ALREADY SO) Y02669 10120002
REGWAIT  EQU   *                                                 Y01054 10150000
*****************************************************************       10170002
*                                                                       10180002
         WAIT  ECBLIST=GPECBLST    WAIT FOR REGION              YM03531 10200002
*                                                                       10202002
*****************************************************************       10210002
         L     R9,LCTQDRTY         (THE CSCB PTR. IS NOT         Y02669 10220002
*                                  INITIALIZED IF MESSAGE        Y02669 10230002
*                                  IEF092I IS NOT WRITTEN THIS   Y02669 10242002
*                                  PATH.)                        Y02669 10244002
         TM    CHCECB,POSTBIT                                    Y01054 10250000
         BNO   NOTCANCL            CANCEL ECB WAS NOT POSTED     Y02669 10300002
*                                                                Y02669 10302002
*        CANCEL ECB WAS POSTED                                   Y02669 10304002
*                                                                Y02669 10306002
*        ISSUE FREEPART TO DELETE REQUEST                        Y02669 10310002
         L     R0,SP242            V=R                           Y02669 10346002
*        (A REQUEST FOR A REAL REGION IS THE ONLY CONDITION     YM00408 10348002
*        WHICH CAN RESULT IN A WAIT FOR A REGION.)              YM00408 10348402
         LA    R1,POSITIVE         SET POSITIVE TO INDICATE A   YM00408 10348502
*                                  FREEMAIN BUT NOT A SUBPOOL   YM00408 10348602
*                                  FREEMAIN                     YM00408 10348702
         FREEMAIN R,LV=(0),A=(1)   FREE REGION                   Y02669 10348802
*                                                                Y02669 10349202
*        GET A V=V REGION OF THE DEFAULT SIZE                    Y02669 10349602
         L     R0,SP247                                          Y02669 10349702
         GETMAIN R,LV=(0)          GET REGION                    Y02669 10349902
         B     SD06305             CONTINUE MAINLINE PROCESSING  Y02669 10366602
NOTCANCL EQU   *                                                 Y02669 10376602
         TM    JSCBSECB,POSTBIT                                  Y01054 10383302
         BNO   REGWAIT             NEITHER ECB WAS POSTED        Y01054 10400000
*                                                                Y02669 10410002
*        GETPART ECB WAS POSTED                                  Y02669 10420002
*                                                                Y02669 10430002
         XR    R14,R14                                           Y01054 10450000
         CH    R14,JSCBSECB+2      CHECK FOR POST CODE 0         Y01054 10500000
         BE    SD06305             GETPART SUCCESSFUL            Y02669 10550002
         LA    R14,X4                                            Y01054 10600000
         CH    R14,JSCBSECB+2      CHECK FOR POST CODE 4         Y01054 10650000
         BE    GETREG              RETRY GETPART                 Y01054 10700000
*                                                                Y02669 10750002
*        IF NOT 0 OR 4, THE POST CODE MUST BE 16. FOR A POST     Y02669 10800002
*        CODE OF 16, PROCESSING WILL DEPEND ON WHETHER THE       Y02669 10850002
*        REQUEST WAS FOR A SPECIFIC ADDRESS (CHECKPOINT RESTART) Y02669 10860002
*        OR A NON-SPECIFIC ADDRESS.                              Y02669 10862002
*                                                                Y02669 10864002
*        IF NON-SPECIFIC, THE REQUEST SHOULD BE RE-ISSUED (AFTER Y02669 10866002
*        FREEPART IS ISSUED TO DELETE THE REQUEST). THE          Y02669 10868002
*        SUPERVISOR WILL ATTEMPT TO SATISFY THE REQUEST WITH A   Y02669 10868402
*        DIFFERENT ADDRESS RANGE. IF THE REQUEST CANNOT BE       Y02669 10868802
*        SATISFIED, THE SUPERVISOR WILL PROVIDE A RETURN CODE    Y02669 10869202
*        OTHER THAN 0, 4, OR 12.                                 Y02669 10869602
*                                                                Y02669 10869702
*        IT IS NOT DESIRABLE TO RE-ISSUE A SPECIFIC REQUEST,     Y02669 10869802
*        BECAUSE A DIFFERENT ADDRESS RANGE CANNOT BE USED.       Y02669 10869902
*                                                                Y02669 10873202
*        IN EITHER CASE, THE INITIAL REQUEST MUST BE DELETED BY  Y02669 10875202
*        A FREEPART.                                             Y02669 10875602
*                                                                Y02669 10876002
         L     R0,SP242            V=R                           Y02669 10896002
*        (A REQUEST FOR A REAL REGION IS THE ONLY CONDITION     YM00408 10898002
*        WHICH CAN RESULT IN A WAIT FOR A REGION.)              YM00408 10898402
         LA    R1,POSITIVE         SET POSITIVE TO INDICATE A   YM00408 10898502
*                                  FREEMAIN BUT NOT A SUBPOOL   YM00408 10898602
*                                  FREEMAIN                     YM00408 10898702
         FREEMAIN R,LV=(0),A=(1)   FREE REGION                   Y02669 10898802
         L     R1,GPADDH0                                        Y02669 10899702
         LTR   R1,R1               CHECK FOR GETPART SPECIFIC    Y02669 10899802
         BZ    GETREG              RETRY REQUEST IF NOT SPECIFIC Y02669 10899902
*                                  (THE SUPERVISOR WILL TRY A    Y02669 10900002
*                                  DIFFERENT ADDRESS RANGE.)     Y02669 10903202
         MVC   GPERROR,JSCBSECB+3  SAVE POST CODE FOR MESSAGE    Y02669 10905602
ERROR    EQU   *                                                 Y01054 10906702
*****************************************************************       10908702
*                                                                       10909102
*        AN ERROR INDICATOR WAS RETURNED BY GETPART                     10909502
*                                                                       10909902
*****************************************************************       10913202
*        GET A V=V REGION OF THE DEFAULT SIZE                    Y02669 10916702
         L     R0,SP247                                          Y02669 10920002
         GETMAIN R,LV=(0)          GET REGION                    Y02669 10940002
         OI    LCTPARM3,X1         SET ERROR INDICATOR SO TASK   Y01054 11050000
*                                  WILL NOT BE SET DISPATCHABLE  Y01054 11100000
*                                                                Y01054 11150000
*        THE FOLLOWING PROCESSING IS TO ISSUE MESSAGE IEF085I OR Y02669 11200002
*        MESSAGE IEF186I.                                        Y02669 11210002
         L     R0,GETMAIN1         GET MESSAGE BUFFER            Y02669 11250002
         GETMAIN R,LV=(0)                                        Y01054 11300000
         DROP  R9                                                Y02669 11310002
         LR    R9,R1                                             Y01054 11350000
*        CONVERT ERROR CODE TO DECIMAL BEFORE CHECKING WHICH     Y02669 11360002
*        MESSAGE IS TO BE ISSUED.                                Y02669 11370002
         XR    R14,R14                                           Y02669 11380002
         IC    R14,GPERROR                                       Y02669 11390002
         MH    R14,H10             THIS MULTIPLICATION HAS THE   Y02669 11392002
*              EFFECT OF SHIFTING LEFT ONE DECIMAL POSITION.     Y02669 11394002
*              THEREFORE, WHEN THE NUMBER IS CONVERTED TO        Y02669 11396002
*              DECIMAL, THE LOW ORDER DIGIT CAN BE DISCARDED.    Y02669 11398002
*              (OTHERWISE, IT WOULD BE NECESSARY TO HAVE         Y02669 11398402
*              CHARACTER DEPENDENT CODE.)                        Y02669 11398802
*                                                                Y02669 11399202
*        THE DSECT USED TO BUILD MESSAGE IEF092I IS USED HERE    Y02669 11399602
*        ONLY TO CONVERT THE ERROR CODE TO DECIMAL.              Y02669 11399702
         USING MSG092I,R9                                        Y02669 11399802
         CVD   R14,PACKED                                        Y02669 11399902
         UNPK  ZONED(X3),PACKED                                  Y02669 11416602
         L     R14,LCTIMSG         GET POINTER TO IEFIB650       Y01054 11450002
         L     R1,GPADDH0                                        Y02669 11500002
         LTR   R1,R1               CHECK FOR GETPART SPECIFIC    Y02669 11510002
         BZ    ISSUE085            NOT SPECIFIC                  Y02669 11550002
         LA    R15,MSGA(0,R14)     GET POINTER TO ENTRY IN TABLE Y02669 11600002
*                                  AT BEGINNING OF IEFIB650      Y02669 11650002
         AH    R14,X2(0,R15)       GET ADDRESS OF MSG IEF186I    Y02669 11700002
         MVC   0(MSGAE,R9),0(R14)  MOVE MESSAGE TO BUFFER        Y02669 11750002
         MVC   MSGAC(X2,R9),ZONED  MOVE ERROR CODE               Y02669 11800002
         B     ISSUEMSG            ISSUE MESSAGE                 Y02669 11850002
ISSUE085 EQU   *                                                 Y02669 11900002
         LA    R15,MSG9(0,R14)     GET POINTER TO ENTRY IN TABLE Y02669 11950002
*                                  AT BEGINNING OF IEFIB650      Y02669 12000002
         AH    R14,X2(0,R15)       GET ADDRESS OF MSG IEF085I    Y02669 12050002
         MVC   0(MSG9E,R9),0(R14)  MOVE MESSAGE                  Y02669 12100002
         MVC   MSG9C(X2,R9),ZONED  MOVE ERROR CODE               Y02669 12150002
ISSUEMSG EQU   *                                                 Y02669 12200002
         WTO   MF=(E,(R9))                                       Y01054 13550000
         L     R0,GETMAIN1         FREE MESSAGE BUFFER           Y02669 13750002
         FREEMAIN R,LV=(0),A=(R9)                                Y01054 13800000
*****************************************************************       13810002
*                                                                       13812002
*        END OF PROCESSING TO GET A REGION                              13814002
*                                                                       13816002
*****************************************************************       13818002
         EJECT                                                          13818402
SD06305  EQU   *                                                   CR17 13820002
*****************************************************************       13824002
*                                                                       13826002
*        IF A V=R REGION IS SUCCESSFULLY GOTTEN, STORE THE SIZE  Y02669 13830002
*        AND BEGINNING ADDRESS OF THE REGION IN THE CSCB FOR     Y02669 13840002
*        DISPLAY JOBS.                                           Y02669 13850002
*                                                                       13852002
*****************************************************************       13860002
         L     R5,LCTQDRTY                                      YM01857 13862002
         USING IEFCSCB,R5                                       YM01857 13863040
         L     R7,LCTTCBAD         POINT TO CURRENT TCB          Y02669 13898002
         USING TCB,R7                                          @ZA05650 13898140
         TM    TCBFLGS6,TCBRV      CHECK FOR V=R               @ZA05650 13898240
         BNO   NOSTORE             DO NOT STORE DESCRIPTION OF THE      13898340
*                                  REGION IF IT HASN'T BEEN GOTTEN      13898440
*                                  YET                         @ZA05650 13898740
         L     R7,TCBPQE-TCB(R7)   POINT TO DUMMY PQE            Y02669 13898840
         USING PQESECT,R7                                        Y02669 13899140
         L     R7,PQEFPQE          POINT TO REAL PQE             Y02669 13899202
*        THESE FIELDS MUST BE SET IN THIS ORDER SO DISPLAY       Y02669 13909502
*        JOBS WILL PICK UP EITHER BOTH A REGION SIZE AND A       Y02669 13911502
*        REGION ADDRESS OR NEITHER A REGION SIZE NOR A REGION    Y02669 13911602
*        ADDRESS.                                                Y02669 13911702
         MVC   CHRGNSZ,PQESIZE     MOVE SIZE                     Y02669 13911802
         MVC   CHRGNAD,PQEREGN     MOVE ADDRESS OF BEGINNING OF  Y02669 13914202
*                                  REGION                        Y02669 13916602
         DROP  R7                                                Y02669 13926602
NOSTORE  EQU   *                                                 Y02669 13948602
*****************************************************************Y02669 13949002
*                                                                Y02669 13949402
*        TAKE THE PRE-INVOCATION EXIT INDICATED BY THE IEL       Y02669 13949802
*                                                                Y02669 13949902
*****************************************************************Y02669 13966602
*        THE PRE-INVOCATION EXIT MUST BE TAKEN AFTER ANY         Y02669 13968602
*        FREEPART/GETPART IS DONE. THIS IS BECAUSE THE EXIT MAY  Y02669 13970602
*        LEAVE INFORMATION WITHIN THE REGION. (THE LOGON PRE-    Y02669 13972602
*        INVOCATION EXIT DOES LEAVE INFORMATION IN SP 0.)        Y02669 13974602
         LA    R3,LCTPARM1         SET UP FOR PARM LSIT WHILE    Y02669 13978602
*                                  REG 4 POINTS TO LCT           T02669 13982602
         L     R4,LCTENTR          LOAD POINTER TO IEL           Y02669 13986602
         USING IEL,R4                                            Y02669 13996602
         L     R4,IELEXIT          LOAD PTR TO INIT EXIT LIST    Y02669 13998602
         DROP  R4                                                Y02669 13999002
         LA    R2,IELPREIN         INDICATE PRE-INVOCATION EXIT  Y02669 13999402
         MVC   0(X4,R3),IEFLCTAD   SET POINTER TO LCT IN LIST    Y02669 14026602
         L     R1,IEFTIOTA         GET POINTER TO TIOT POINTER   Y02669 14036602
         MVC   X4(X4,R3),0(R1)     MOVE PTR TO TIOT TO LIST      Y02669 14046602
         BAL   R9,SETEXIT          CALL SUBROUTINE WHICH TAKES   Y02669 14048602
*                                  EXIT                          Y02669 14049002
         L     R4,IEFLCTAD                                       Y02669 14066602
         USING IEFLOT,R4                                         Y02669 14076602
         LTR   R10,R10             WAS ERROR CODE RETURNED       Y02669 14086602
         BZ    NORMA               ZERO RETURN CODE - CONTINUE    M3140 14096602
         L     R11,LCTENTR         GET ADDR OF IEL               Y02669 14098602
         USING IEL,R11             IEL ADDRESSABILITY            Y02669 14099002
         L     R11,IELEXIT         ADDR OF INIT EXIT LIST        Y02669 14099402
         DROP  R11                                               Y02669 14099802
         USING IELEXITS,R11        EXIT LIST ADDRESSABILITY      Y02669 14099902
         CLI   IELRTNCD,IELRTGD    CHECK WHETHER OTHER CODE WAS  Y02668 14109902
*                                  ALREADY STORED                Y02668 14111902
         BNE   LEAVERC             DO NOT DESTROY OLDER CODE     Y02668 14113902
         MVI   IELRTNCD,IELRTPRI   SET PRE-PROC ERROR IN IEL     Y02669 14116602
         MVI   IELRCXT,IELINIT     SET RETURN CODE ORIGIN AS     Y02669 14126602
*                                  'INITIATOR'                   Y02668 14126702
LEAVERC  EQU   *                                                 Y02668 14126802
         DROP  R11                                               Y02669 14127002
         LA    R1,CHCECB           ADDRESS OF CANCEL ECB          M3140 14132602
         L     R0,CAN622           CANCEL CODE OF 622             M3140 14133002
         POST  (1),(0)             POST CANCEL ECB                M3140 14133102
NORMA    EQU   *                                                  M3140 14133202
         TM    LCTOPSW1,LCTCANF    CHECK WHETHER TASK IS TO BE   Y01054 14133302
*                                  NON-CANCELABLE                Y01054 14150000
         BNO   LVCANCEL            LEAVE CANCELABLE              Y02669 14200002
         NI    CHACT,X'FF'-CHCL    SET NON-CANCELABLE            Y01054 14400000
         DROP  R5                                               YM00096 14402002
LVCANCEL EQU   *                                                 Y02669 14410002
*****************************************************************       14450002
*                                                                       14460002
*        CALL IEFSMFAT FOR SMF PROCESSING                               14470002
*                                                                       14480002
*****************************************************************       14490002
*        THIS CHECK IS MADE PRIMARILY TO PREVENT A P/P FROM     YM03491 14490302
*        BEING CHARGED FOR THE USE OF STORAGE WHEN THE JOB      YM03491 14490602
*        STEP NEVER EVEN GOT ATTACHED (BECAUSE OF A GETPART     YM03491 14490902
*        ERROR). THE USE OF STORAGE IS CHARGED DURING THE TIME  YM03491 14491202
*        WHEN TCBSMFGF IS ON.                                   YM03491 14491502
         TM    LCTPARM3,X1         CHECK GETPART ERROR          YM03491 14492002
*                                  INDICATOR                    YM03491 14494002
         BO    SD63007             SKIP SMF PROCESSING          YM03491 14496002
         L     R0,IEFTCBAD         PASS PTR. TO TCB              Y02652 14500002
         L     R1,IEFTIOTA         PASS PTR. TO TIOT PTR.        Y02652 14550002
         L     R15,SMFAT                *                          SMF1 14600000
         BALR  R14,R15                  GO TO SMF TO BUILD TCTIOT  SMF1 14650000
         LTR   R9,R15                   IF THERE WAS SMF PRESENT   SMF1 14700000
*                                           FOR THIS JOB, R9 NOW   SMF1 14750000
*                                           POINTS TO TCT          SMF1 14800000
         USING SMFTCT,R9                                                14850000
         BZ    SD63007                  *                               14900000
         MVC   TCTSW(1),LCTTMWRK+8      MOVE INDICATOR SET BY      SMF1 15000000
*                                           IEFSD162 OF WHETHER    SMF1 15050000
*                                           TIME LIMIT IS JOB OR   SMF1 15100000
*                                           STEP                   SMF1 15150000
*****************************************************************       15160002
*                                                                       15170002
*        MOVE USER PARM. FIELD FROM SP 253 TO SP 0                      15180002
*                                                                       15190002
*****************************************************************       15192002
SD63007  EQU   *                        *                               15200000
         L     R7,IEFUSADD           MOVE USER PARAMETER AREA FROM      15250000
*                                    SUBPOOL 253 TO SUBPOOL 0           15252002
         DROP  R4                                                Y02652 15260002
         L     R4,4(R7)            GET SIZE OF PARM FIELD         18428 15300002
         LA    R4,HEADER(0,R4)     ADD SIZE OF HEADER            Y02669 15350002
         LR    R0,R4                                             Y02669 15360002
         O     R0,REGPOOL          SET SUBPOOL                   Y02669 15400002
         GETMAIN R,LV=(0)            CORE FROM SUBPOOL ZERO             15450000
         LR    R0,R4          RESTORE LENGTH VALUE                 M409 15500000
         BCTR  R4,R0                 SUBTRACT ONE FROM R4               15550000
         EX    R4,IEFUSEP            MOVE USER PARM                     15600000
         LA    R4,6(0,R1)          SET UP USER PARM                     15650000
         ST    R4,0(0,R1)               AREA                            15700000
         OI    0(R1),128                SET HIGH ORDER BIT TO ONE       15750000
         ST    R1,IEFUSADD         REPLACE USER PARM ADDR         M0204 15800000
         LR R1,R7                  LOAD ADDR OF USER PARM AREA          15850002
         L     R7,SPOOL253        FREE SUBPOOL 253                M3441 15900000
         OR    R0,R7                                                    15950000
         FREEMAIN  R,LV=(0),A=(1)       FREE USER PARM IN 253           16000000
         L     R1,IEFUSADD         PASS PARM FIELD VIA ATTACH    Y02652 16060002
         L     R4,IEFLCTAD                                       Y02652 16062002
         L     R5,IEFTCBAD         PTR. TO INIT. TCB             Y02652 16064002
         L     R6,IEFTIOTA         PTR. TO P/P TIOT POINTER      Y02652 16066002
         USING IEFLOT,R4                                         Y02652 16070002
         TM    LCTPARM3,X1         CHECK ERROR INDICATOR         Y01054 16100000
         BO    NOATTACH            SKIP THE ATTACH IF GETPART    Y01054 16150002
*                                  ERROR                         Y01054 16200000
         EJECT                                                          16202002
*****************************************************************       16210002
*                                                                       16220002
*        ATTACH JOB STEP                                                16230002
*                                                                       16240002
*****************************************************************       16242002
         MVC   PARTIOTB,TCBTIO-TCB(R5)  SAVE THE POINTER TO THE  Y02652 16250002
*                                       INITIATOR'S TIOT                16300000
*        (THE TIOT PTR. IS SAVED IN IEFPARAM SO IEFZB620 CAN            16310002
*        RESTORE THE INITIATOR TIOT PTR. IF NECESSARY.)                 16320002
         MVC   TCBTIO-TCB(X4,R5),0(R6)  STORE PTR TO THE JOB STEP TIOT  16350001
*                                       INTO INITIATOR'S TCB FOR ATTACH 16400000
*                                       (R6 POINTS TO TIOT LIST)        16450000
         L     R15,IEFREMLS        LOAD PTR TO ATTACH LIST       Y02669 16510002
         ATTACH  MF=(E,(1)),SF=(E,(15))                                 18650000
*        THE STORAGE FOR THE ATTACH PARAMETER LIST IS GOTTEN BY  Y02652 18660002
*        IEFSD162 AND THE LIST IS INITIALIZED BY IEFSD103.       Y02652 18670002
*                                                                       18670202
*     TEST REGISTER 15 FOR A RETURN CODE OF ZERO TO SEE IF THE          18670402
*     ATTACH WAS SUCCESSFUL.  IF IT WAS NOT THEN ISSUE AN ABEND         18670602
*     FOR DIAGNOSTIC PURPOSES SINCE THIS IS AN UNUSUAL CONDITION.       18670802
*     THE INITIATOR ESTAE SHOULD TAKE CARE OF CLEAN UP AND              18671002
*     PROVIDE A DUMP.  REGISTER 15 WILL CONTAIN THE ERROR CODE          18671202
*     FROM ATTACH.                                              YM07020 18671402
         LTR   R15,R15             TEST FOR RETURN CODE FROM ATTACH     18672002
*                                                               YM07020 18673002
         BZ    SD263210            ZERO, CONTINUE               YM07020 18674002
         L     R1,ABENCODE         ATTACH DID NOT GO, LOAD ABEND CODE   18674302
*                                  IN TO REGISTER 1             YM07020 18674602
         ABEND (1),,,SYSTEM        ISSUE THE ABEND              YM07020 18674902
         SPACE 2                                                        18675202
SD263210 LR    R11,R1              SAVE ATTACHED JOBSTEP TCB ADDR       18675502
         ST    R11,JOBSTCB         TCB ADDRESS OF JOB STEP        20030 18676002
         MVC   TCBTIO-TCB(X4,R5),PARTIOTB  RESTORE THE PTR. TO   Y02652 18678002
*                                       INITIATOR'S TIOT                18678402
         XR    R1,R1                                             Y02652 18679602
         ST    R1,PARTIOTB         CLEAR, SO THE INITIATOR TASK  Y02652 18680602
*                                  RECOVERY ROUTINE WILL NOT     Y02652 18681602
*                                  ATTEMPT TO RESTORE TIOT PTR.  Y02652 18682602
*****************************************************************       18683602
*                                                                       18684602
*        ISSUE SYSEVENT 'INITATT'                                Y02655 18690002
*                                                                       18692002
*****************************************************************       18692402
*        (REG 1 WAS JUST ZEROED)                                 Y02669 18694002
         TM    LCTINTSW,LCTPRIV    IS PROGRAM 'PRIVILEGED'       Y02655 18698802
         BO    SETPRIV             YES, PASS A PERFORMANCE GROUP Y02655 18699202
*                                  OF 0 TO INDICATE PRIVILEGED   Y02655 18699602
         IC    R1,PARPRFMF         PASS PERFORMANCE GROUP        Y02655 18699702
SETPRIV  EQU   *                                                 Y02655 18699802
         SLL   R1,S8               SHIFT PERFORMANCE GROUP TO    Y02655 18699902
*                                  BYTE 2                        Y02655 18716602
         L     R10,LCTASCBA                                      Y02655 18718602
         USING ASCB,R10                                          Y02655 18720602
         MVC   PAROMEMP,ASCBDP     SAVE CURRENT MEMORY PRIORITY  Y02655 18726602
         IC    R1,PARNMEMP         PASS NEW MEMORY PRIORITY      Y02655 18728602
         TM    LCTPUBYT,LCTNSWP    IF JOB STEP IS NON-         @ZA16879 18728840
*                                  SWAPPABLE, IT IS AUTHORIZED @ZA16879 18729040
*                                  TO ISSUE DONTSWAP & OKSWAP  @ZA16879 18729240
*                                                              @ZA16879 18729440
         BZ    SYSATTCH            SWAPPABLE: DO NOT AUTHORIZE @ZA16879 18729640
         O     R1,BYT1BIT6         SET FLAG AUTHORIZING        @ZA16879 18729840
*                                  DONTSWAP AND OKSWAP         @ZA16879 18730040
SYSATTCH EQU   *                                               @ZA16879 18730240
*                                                                       18730440
         SYSEVENT INITATT                                        Y02655 18730602
         OI    LCTINTS2,LCTATTC    INITATT HAS BEEN DONE       @ZA16879 18750640
*                                                                       18780602
*****************************************************************       19360002
*                                                                       19370002
*        SET UP JOB STEP TIME LIMIT                                     19380002
*                                                                       19390002
*****************************************************************       19392002
*                                                                       19394002
*        FIRST TURN OFF ASCBCEXT IN CASE IT IS ON. THE BIT IS    Y02669 19396002
*        SET BY THE SUPERVISOR IF EOT PROCESSING IS STARTED FOR  Y02669 19398002
*        THE JOB STEP TCB. THE BIT IS CHECKED TO PREVENT         Y02669 19398402
*        IEATLEXT FROM BEING SCHEDULED IF THE JOB STEP HAS       Y02669 19398802
*        ALREADY ABENDED. (IEATLEXT IS SCHEDULED IF THERE IS A   Y02669 19399202
*        TIME LIMIT OVERFLOW.)                                   Y02669 19399402
*        OBTAIN LOCAL LOCK WHILE UPDATING ASCB                 @ZA11857 19399540
         USING PSA,0                                           @ZA11857 19399640
         SETLOCK OBTAIN,TYPE=LOCAL,REGS=USE,MODE=UNCOND,               C19399940
               RELATED=(ASCB)                                  @ZA11857 19401940
         NI    ASCBFLG2,X'FF'-ASCBCEXT                           Y02669 19403940
         SR    R7,R7               USED BOTH AS A SWITCH AND TO  Y02669 19408040
*                                  CLEAR FIELDS IN THE ASCB      Y02669 19410002
         XC    ASCBEJST,ASCBEJST   CLEAR ELAPSED TIME FIELD,     Y02669 19420002
*                                  EVEN IF STEP IS NOT TO BE     Y02669 19450002
*                                  TIMED                         Y02669 19460002
         XC    ASCBSRBT,ASCBSRBT   CLEAR SRB TIME USED           Y02669 19480002
         L     R3,LCTTSTL4         GET STEP TIME (IN .01 SEC.)   Y02669 19500002
         C     R3,HOURS24          CHECK FOR 24 HOURS            Y02669 19550002
         BL    SETTIME             SET TIME IF LIMIT LESS THAN   Y02669 19600002
*                                  THE MAXIMUM (24 HOURS)        Y02669 19650002
         ST    R3,LCTTSTR4         SET TIME REMAINING FIELD OF   Y02669 19700002
*                                  TIMER WORK AREA TO 1440 MIN          19750002
*                                  SO THAT IF THIS IS A CATALOGED       19800002
*                                  PROCEDURE THE REMAINING STEPS        19850002
*                                  WILL ALSO NOT BE TIMED               19900002
         ST    R7,LCTTSTU4         CLEAR TIME USED FOR           Y02669 19910002
*                                  IEFSD164 IF NOT TIMED         Y02669 19920002
         LA    R7,1                SET SWITCH TO INDICATE TIMER         19950002
*                                  WAS NOT SET                          20000002
         B     BYPASS              BRANCH AROUND SETTING TIME LIMIT     20300002
SETTIME  EQU   *                                                 Y02669 20350002
*        LEAVE R7 = 0 TO INDICATE STEP WAS TIMED.                Y02669 20400002
         M     R2,TEN1000          CONVERT .01 SEC. TO .000001   Y02669 20450002
*                                  SECONDS (MICROSECONDS)        Y02669 20460002
         LR    R1,R3               SAVE BEFORE SHIFT, SO THE    YM03761 20463002
*                                  RESULT CAN BE ROUNDED        YM03761 20466002
         SRDL  R2,TWOTO20          CONVERT MICROSECONDS TO       Y02669 20470002
*                                  2 TO THE 20TH MICROSECONDS    Y02669 20480002
*        (THESE UNITS ARE EQUAL TO APPROXIMATELY 1.04 SECONDS.)  Y02669 20482002
         N     R1,ROUNDMSK         BIT 12 REPRESENTS THE MOST   YM03761 20482802
*                                  SIGNIFICANT BIT WHICH WILL   YM03761 20483602
*                                  NOT BE PRESENT IN THE        YM03761 20484402
*                                  ANSWER. IF IT IS ON, ROUND   YM03761 20485202
*                                  UP, BECAUSE THE BITS SHIFTED YM03761 20486002
*                                  OUT HAD A VALUE GREATER THAN YM03761 20486802
*                                  ONE HALF.                    YM03761 20487602
         BZ    NOROUND1            DO NOT ROUND                 YM03761 20488402
         A     R3,ROUNDUP          ROUND                        YM03761 20489202
NOROUND1 EQU   *                                                YM03761 20490002
         ST    R3,ASCBJSTL         SET TIME LIMIT IN ASCB        Y02669 20491502
*        SET THE WAIT TIME LIMIT FOR THE STEP IN THE ASCB. THE   Y02651 20500002
*        ASCB IS USED, BECAUSE THE FIELD IS UPDATED WHENEVER     Y02651 20503002
*        THE WAIT TIME LIMIT FOR A STEP EXPIRES AND IS EXTENDED. Y02651 20506002
         L     R15,CVTPTR                                        Y02651 20509002
         USING CVTMAP,R15                                        Y02651 20512002
         L     R15,CVTSMCA                                       Y02651 20515002
         USING SMCABASE,R15                                      Y02651 20520002
         MVC   ASCBSWTL,SMCAJWT    COPY WAIT TIME LIMIT          Y02651 20540002
         DROP R15                                                Y02651 20560002
         NI    ASCBFLG1,X'FF'-ASCBTOFF  INDICATE TIME LIMIT      Y02669 20580002
*                                  SHOULD BE CHECKED             Y02669 20600002
BYPASS   EQU   *                                                        20620002
*        RELEASE LOCAL LOCK AFTER UPDATING ASCB                @ZA11857 20640040
         SETLOCK RELEASE,TYPE=LOCAL,REGS=USE,                          C20660040
               RELATED=(ASCB)                                  @ZA11857 20680040
         L     R2,CANECBAD        ADDRESS OF CANCEL ECB          A28953 20700002
         TM    X0(R2),POSTBIT     IF JOB HAS BEEN CANCELED BYPASS 20032 21200000
         BO    BYPASDSP                SETTING THE TCB DISPATHEABL20032 21300000
*****************************************************************       21654002
*                                                                       21660002
*        MAKE TASK DISPATCHABLE                                         21670002
*                                                                       21680002
*****************************************************************Y02669 21694002
         STATUS RESET,ND,(R11),(12),E                            Y01054 21700000
WAITAGN  EQU   *                                                  20032 21750000
         LA    R1,IEFECBLT        ADDRESS OF ECB LIST             20051 21850000
         WAIT  ECBLIST=(1)                                      YM06276 21900002
         EJECT                                                          21902002
*****************************************************************       21910002
*                                                                       21920002
*        WAIT WHILE JOB STEP IS RUNNING                                 21930002
*                                                                       21940002
*****************************************************************       21942002
BYPASDSP EQU   *                                                  20032 21950002
         TM    0(R2),POSTBIT            WAS CANCEL SPECIFIED ?          22000002
         BZ    SD63010                  NO                              22050002
*****************************************************************       22060002
*                                                                       22070002
*        PROCESS FOR CANCEL                                             22080002
*                                                                       22090002
*****************************************************************       22092002
*        THE STATUS SET,SD REPLACES THE STATUS STOP WHICH HAD    Y02669 22100002
*        BEEN LOCATED HERE BEFORE RELEASE 2. STATUS STOP WOULD   Y02669 22150002
*        NOT BE EFFECTIVE FOR A TASK FOR WHICH BIT TCBFX IS ON.  Y02669 22160002
*        (IF A TASK WITH BIT TCBFX ON WERE LOOPING IT WOULD      Y02669 22170002
*        CONTINUE LOOPING IF ONLY STATUS STOP IS ISSUED.) THE    Y02669 22180002
*        BIT MAY BE ON FOR AN SVRB OR AN IRB (PERHAPS AN         Y02669 22190002
*        ATTENTION EXIT).                                        Y02669 22200002
         STATUS SET,SD,(R11),(32)                                Y02669 22210002
         L     R3,LCTQDRTY             ADDRESS OF CSCB             I272 22260002
         USING IEFCSCB,R3          CSCB ADDRESSABLIITY             I272 22280002
         L     R1,X0(R2)          CANCEL ECB IN REGISTER         A42853 22300002
         LA    R1,0(0,R1)          CLEAR POST BIT                Y02652 22350002
         ST    R1,COMPCODE        CODE IN PARM LIST FOR SVC 34    20030 22400002
         OI    TCBFLGS2-TCB(R11),TCBFSTI INDIC NO STAE OPERATIONS  I272 22450002
         OI    CHSTS,CHABTERM      INDICATE ABTERM FOR SVC 34      I272 22500002
         LR    R15,R8             PARM LIST FOR SVC 34            20030 22550002
         LA    R1,X0(R3)           ADDRESS OF CSCB                 I272 22600002
         MGCR  (1),CHAIN                GO TO ABTERM VIA MASTER    I272 22650002
         XR    R1,R1                                            YM00083 22660002
         ST    R1,0(R2)            CLEAR CANCEL ECB BEFORE      YM00083 22670002
*                                  WAITING AGAIN                YM00083 22680002
         B     WAITAGN             WAIT FOR EOT ECB TO BE POSTED Y02669 22700002
*                                  (OR A SECOND POST OF THE      Y02669 22750002
*                                  CANCEL ECB)                   Y02669 22800002
SD63010  EQU   *                                                  20032 22850002
         L     R2,ATTECBAD         POINT TO EOT ECB              Y02652 22852002
         TM    0(R2),POSTBIT       CHECK WHETHER EOT IS POSTED   Y02652 22854002
         L     R2,CANECBAD         RESET POINTER TO CANCEL ECB @ZA05673 22855040
         BZ    WAITAGN             NO, RETURN AND RE-ISSUE WAIT  Y02652 22856002
*        (THIS BRANCH SHOULD NEVER BE TAKEN, BUT IT IS BETTER    Y02652 22858002
*        TO MAKE AN EXPLICIT CHECK. IF WE WAIT ON AN ECB WHICH   Y02652 22858402
*        HAS THE WAIT BIT ON, THE TASK WILL ABEND, WHICH IS      Y02652 22858802
*        DESIRABLE IF THE SITUATION EVER OCCURS.)                Y02652 22859202
*****************************************************************       22860002
*                                                                       22870002
*        EOT ECB HAS BEEN POSTED                                        22880002
*                                                                       22910002
*****************************************************************       22920002
         MVC   ASCBAFFN,NOAFFIN    SET TO INDICATE MEMORY CAN    Y02651 22926002
*                                  RUN ON ANY ONLINE CPU, IN     Y02651 22932002
*                                  CASE AFFINITY HAD BEEN SET    Y02651 22938002
*                                  FOR THE JOB STEP              Y02651 22944002
         L     R1,TCBPQE-TCB(R11)  GET DUMMY PQE PTR             A39401 23000001
*        IT IS NECESSARY TO CHECK FOR A 0 PQE PTR. BECAUSE      YM08312 23008002
*        THE PQE PTR. MAY BE CLEARED BY GETPART'S RECOVERY      YM08312 23016002
*        ROUTINE.                                               YM08312 23024002
         LTR   R1,R1                                            YM08312 23032002
         BZ    NOPQE                                            YM08312 23040002
         L     R1,X8(R1)           GET JOBSTEP PQE PTR           A39401 23050000
         LTR   R1,R1                                            YM08312 23060002
         BZ    NOPQE                                            YM08312 23070002
         USING PQESECT,R1          PQE ADDRESSABILITY            A39401 23100000
TCBMOVE  ST    R5,PQETCB           PUT INIT TCB PTR IN JOB PQE   A39401 23150000
         L     R1,PQEFPQE          GET PTR TO NEXT PQE           A39401 23200000
         LA    R1,X0(R1)           CLEAR HIGH-ORDER BYTE         A39401 23250000
         LTR   R1,R1               IS THERE ANOTHER PQE          A39401 23300000
         BNZ   TCBMOVE             YES...BRANCH                  A39401 23350000
NOPQE    EQU   *                                                YM08312 23355002
         L     R9,TCBTCT-TCB(R5)  GET PTR TO                       I272 24150001
         LA    R9,0(R9)                 TCT                         SMF 24200000
         LTR   R9,R9              DOES SMF APPLY                  M1255 24210001
         BZ    NOSMF              NO                              M1255 24220001
         NI    TCBTCTGF-TCB(R5),X'FF'-TCBSMFGF  TURN OFF INDIC SO M1255 24250001
*                                      TCT CORE TABLE WILL NOT BE M1255 24300001
*                                      UPDATED                    M1255 24302001
NOSMF    EQU   *                                                  M1255 24600001
*****************************************************************       24602002
*                                                                       24604002
*        SAVE TIME USED BY JOB STEP                                     24606002
*                                                                       24608002
*****************************************************************       24608402
         LTR   R7,R7                   CHECK TO SEE IF TIMER WAS SET    24610002
         BC    2,NOTEST                IF NOT BRANCH AROUND             24620002
         SPACE 2                                                        24630002
         LM    R2,R3,ASCBEJST      GET ELAPSED TIME             YM03761 24650002
*        THE UNITS IN R2 ARE 2 TO THE TWENTIETH MICROSECONDS            24651002
*        (APPROX. 1.04 SEC.). THE UNITS IN R3 PROVIDE MORE              24652002
*        ACCURACY, BECAUSE THE ANSWER IS NEEDED IN HUNDREDTHS           24653002
*        OF A SECOND. TO CONVERT TO MICROSECONDS, THE CODE              24654002
*        SHOULD SHIFT LEFT 20 BITS (IE, MULTIPLY BY 2 TO THE            24655002
*        TWENTIETH). INSTEAD OF SHIFTING LEFT 20 BITS,                  24656002
*        SHIFTING RIGHT 12 BITS PROVIDES AN EQUIVALENT                  24657002
*        RESULT. BECAUSE THE HARDWARE USES AN EVEN-ODD PAIR             24658002
*        OF REGISTERS, THIS EQUIVALENT CALCULATION WORKS                24659002
*        PROPERLY, WHILE A SHIFT TO THE LEFT COULD LOSE                 24660002
*        SIGNIFICANT BITS FROM R2. (THE SHIFT TO THE RIGHT              24663002
*        ONLY DROPS INSIGNIFICANT BITS FROM R3.)                        24666002
         SRDL  R2,12                                            YM03761 24670002
         D     R2,TEN1000          CONVERT MICROSECONDS TO .01   Y02669 24692002
*                                  SECONDS                       Y02669 24694002
         C     R2,FIVE1000         CHECK WHETHER REMAINDER IS   YM03761 24694302
*                                  AT LEAST HALF OF DIVISOR     YM03761 24694602
         BL    NOROUND2            NO, DO NOT ROUND UP          YM03761 24694902
         A     R3,ROUNDUP          ROUND UP                     YM03761 24695202
NOROUND2 EQU   *                                                YM03761 24695502
         ST    R3,LCTTSTU4         SAVE ELAPSED TIME IN .01      Y02669 24696002
*                                  SECONDS                       Y02669 24698002
         SPACE 2                                                        24698102
         LM    R2,R3,ASCBSRBT      GET SRB TIME USED            YM03761 24702902
         SRDL  R2,12               SEE COMMENT ON CONVERSION    YM03761 24707902
*                                  OF ELAPSED TASK TIME         YM03761 24708902
         D     R2,TEN1000          CONVERT MICROSECONDS TO .01   Y02669 24716602
*                                  SECONDS                       Y02669 24720602
         C     R2,FIVE1000         CHECK WHETHER REMAINDER IS   YM03761 24722602
*                                  AT LEAST HALF OF DIVISOR     YM03761 24728602
         BL    NOROUND3            NO, DO NOT ROUND UP          YM03761 24732602
         A     R3,ROUNDUP          ROUND UP                     YM03761 24733302
NOROUND3 EQU   *                                                YM03761 24738302
         ST    R3,LCTTSRB4         SAVE SRB TIME USED IN         Y02669 24743302
*                                  .01 MICROSECONDS              Y02669 24750002
         SPACE 2                                                        24753002
         L     R3,ASCBJSTL         GET STEP TIME LIMIT INCLUDING Y02669 24756002
*                                  EXTENSIONS IN 2 TO THE        Y02669 24759002
*                                  TWENTIETH MICROSECONDS        Y02669 24762002
         SR    R2,R2               CLEAR FOR SHIFT               Y02669 24765002
         SLDL  R2,TWOTO20          CONVERT 2 TO THE TWENTIETH    Y02669 24768002
*                                  MICROSECONDS TO MICROSECONDS  Y02669 24771002
         D     R2,TEN1000          CONVERT MICROSECONDS TO .01   Y02669 24774002
*                                  SECONDS                       Y02669 24777002
         C     R2,FIVE1000         CHECK WHETHER REMAINDER IS   YM03761 24780002
*                                  AT LEAST HALF OF DIVISOR     YM03761 24783002
         BL    NOROUND4            NO, DO NOT ROUND UP          YM03761 24786002
         A     R3,ROUNDUP          ROUND UP                     YM03761 24800002
NOROUND4 EQU   *                                                YM03761 24804002
         ST    R3,LCTTSTL4         SAVE STEP TIME LIMIT IN .01   Y02669 24808002
*                                  SECONDS                       Y02669 24812002
         S     R3,LCTTSTU4         CALCULATE TIME REMAINING      Y02669 24816002
*        (IT WILL BE USED TO TIME SUBSEQUENT STEPS OF A PROC IF  Y02669 24820002
*        THE INDIVIDUAL STEPS DO NOT SPECIFY A TIME LIMIT.       Y02669 24824002
*        IF IT IS A NEGITIVE NUMBER NO STEP TIME REMAINS,       YM06129 24824802
*        STORE ZERO SO THE JOB WILL BE ENDED.)                  YM06129 24825602
         BNM   STREMAIN            TEST FOR MINUS-NO TIME LEFT  YM06129 24826402
         XR    R3,R3               SET NO JOB/STEP TIME REMAINS YM06129 24827202
STREMAIN ST    R3,LCTTSTR4         SAVE TIME REMAINING           Y02669 24828002
         SPACE 2                                                        24832002
NOTEST   EQU   *                                                        24836002
         SPACE 2                                                        25650002
NOATTACH EQU   *                                                 Y02669 25950002
*        THE TASK'S RETURN CODE MUST BE SET BEFORE THE POST-    YM01961 25950102
*        INVOCATION EXIT IS TAKEN. (IT IS USED BY THE LOGON/    YM01961 25950202
*        LOGOFF POST INVOCATION EXIT.) ACTUALLY, THE FIELD MAY  YM01961 25950302
*        BE EITHER A RETURN CODE OR AN ABEND CODE.              YM01961 25950402
         TM    LCTPARM3,X1         CHECK FOR GETPART ERROR      YM01961 25952002
         BNO   NOERROR             NO ERROR OCCURRED, PERFORM   YM01961 25952302
*                                  NORMAL PROCESSING            YM01961 25952602
         MVC   LCTPARM4,CODE822    SET COMP. CODE OF 822 FOR    YM01961 25952902
*                                  GETPART ERROR                YM01961 25953202
         B     PIEXIT              SKIP ELSE CLAUSE             YM01961 25953502
NOERROR  EQU   *                                                YM01961 25954002
         MVC   LCTPARM4,TCBCMP-TCB(R11)  SAVE TASK COMP. CODE   YM01961 25954202
PIEXIT   EQU   *                                                YM01961 25954802
*****************************************************************Y02669 25955002
*                                                                Y02669 25955202
*        TAKE THE POST-INVOCATION EXIT INIDCATED BY THE IEL      Y02669 25955602
*                                                                Y02669 25956602
*****************************************************************Y02669 25958002
         L     R4,IEFLCTAD                                       Y02652 25959602
         USING IEFLOT,R4                                         Y02652 25960602
         L     R4,LCTENTR         ADDRESS OF IEL                  20032 25963202
         USING IEL,R4              IEL ADDRESSABILITY            Y02669 25964202
         L     R4,IELEXIT          GET ADDR OF EXIT LIST          20032 25965202
         DROP  R4                                                Y02669 25966702
         LA    R2,IELPSTIN         PUT SEARCH ID IN R2           Y02669 25967702
         L     R3,IEFLCTAD         PASS LCT AS PARM              Y02669 25970002
         BAL   R9,SETEXIT          CALL SUBROUTINE WHICH TAKES   Y02669 25971002
*                                  EXIT                          Y02669 25972002
         L     R4,IEFLCTAD                                       Y02669 25973002
         USING IEFLOT,R4                                         Y02669 25974002
         LTR   R10,R10             WAS THERE AN EXIT RETURN CODE  M0397 25975002
         BZ    NORMB               NO, CONTINUE NORMAL PROCESSINGY02669 25976002
         L     R11,LCTENTR          ADDRESS OF IEL               Y02669 25980002
         USING IEL,R11             IEL ADDRESSABILITY            Y02669 25990002
         L     R11,IELEXIT          ADDRESS OF INIT EXIT LIST    Y02669 25992002
         DROP  R11                                               Y02669 25994002
         USING IELEXITS,R11        EXIT LIST ADDRESSABILITY      Y02669 25996002
         CLI   IELRTNCD,IELRTGD    IS ERROR CODE ALREADY SET     Y02668 25998002
         BNE   NORMB               YES, BYPASS THIS SETTING      Y02669 25998402
         MVI   IELRTNCD,IELRTPTI   SET POST-PROCESSING ERROR     Y02669 25998802
         MVI   IELRCXT,IELINIT     SET RETURN CODE ORIGIN AS     Y02668 25998902
*                                  'INITIATOR'                   Y02668 25999002
         DROP  R11                                               Y02669 25999202
NORMB    EQU   *                                                 Y02669 25999602
         L     R11,JOBSTCB         RESTORE REGISTER USED BY      Y02669 26149602
*                                  SUBROUTINE                    Y02669 26159602
*****************************************************************       26850002
*                                                                       26900002
*        SPECIAL PROCESSING FOR GETPART ERROR                           26950002
*                                                                       26952002
*****************************************************************       26954002
         TM    LCTPARM3,X1         CHECK FOR GETPART ERROR       Y02669 26960002
         BNO   CHKCSCB             SKIP PROCESSING IF NOT ERROR  Y02669 26970002
*        BECAUSE THERE WAS A GETPART FAILURE, THE TIME          YA02494 26970602
*        PROCESSING IN THIS MODULE WAS SKIPPED. BECAUSE THE     YA02494 26971202
*        STEP WAS NOT RUN AND IEFSD164 CAN NOT EASILY DETERMINE YA02494 26971802
*        THIS, FIELDS IN THE LCT MUST BE SET UP TO SHOW THAT    YA02494 26972402
*        THE STEP USED NO TIME.                                 YA02494 26973002
         XR    R1,R1                                            YA02494 26973602
         ST    R1,LCTTSTU4         SET TCB TIME USED TO 0       YA02494 26974202
*        (OTHERWISE, THE TIME USED FOR THE PREVIOUS STEP OF     YA02494 26974802
*        THE JOB, IF ANY, WOULD BE PASSED TO SMF.)              YA02494 26975402
*        SET UP STEP TIME REMAINING, IN CASE COND=EVEN OR       YA02494 26976002
*        ONLY IS SPECIFIED FOR SUCCEEDING STEPS AND A           YA02494 26976602
*        TIME LIMIT IS BEING USED FOR AN ENTIRE PROC.           YA02494 26977202
         L     R1,LCTTSTL4                                      YA02494 26977802
         ST    R1,LCTTSTR4                                      YA20494 26978402
         SPACE 2                                                        26979002
         L     R0,GETMAIN2         FREE GWT                      Y02669 26980002
         L     R1,LCTPARM3         POINTER TO GWT                Y02669 26982002
         FREEMAIN R,LV=(0),A=(1)                                 Y02669 26990002
         SPACE                                                          26991002
*        WHEN A V=R GETPART FAILS, FIELDS ARE SAVED FOR THE      Y01054 26992002
*        DUMMY TCB AND TERMINATION AS IF THE SUBTASK HAD ABENDED Y01054 26994002
*        WITH A COMPLETION CODE OF 822. THIS IS DONE SO THAT     Y01054 26996002
*        DATA SETS WILL BE DISPOSED OF PROPERLY.                 Y01054 26998002
         MVC   LCTPARM3(X1),TCBDSP-TCB(R5)  SAVE DISP. PRTY.     Y02652 26998402
*                                  FROM INIT. TCB                Y02652 27008402
         MVI   LCTPARM1,TCBFA      SET ABEND FLAG                Y02652 27010402
         MVC   LCTPARM1+X1(X3),TCBTCTB-TCB(R5)  SAVE TCT POINTER Y02652 27010802
*        THE COMPLETION CODE IS SET IN LCTPARM4 BEFORE THE      YM01961 27011202
*        POST-INVOCATION EXIT IS TAKEN.                         YM01961 27011602
         L     R10,LCTASCBA        ADDR OF ASCB                @ZA16879 27011840
         USING ASCB,R10                                        @ZA16879 27011940
         TM    LCTINTS2,LCTTSWPC  SYSEVENT 'TRANSWAP' COMPLETE @ZA16879 27012040
         BO    ISSUEDET            GO ISSUE SYSEVENT 'DETACH'  @ZA16879 27012440
         TM    ASCBRSM,ASCB1LPU+ASCB2LPU+ASCBN2LP ANY PREFERRED         27013640
*                                  STORAGE USAGE INDICATED     @ZA16879 27013740
         BZ    SD06330             NO, SKIP DETACH             @ZA16879 27014040
ISSUEDET EQU   *                                               @ZA16879 27014640
*        SRM REQUIRES THAT INITATT AND INITDET BE ISSUED IN    @ZA16879 27014740
*        PAIRS.  ON A GETPART ERROR, NO INITATT HAS BEEN       @ZA16879 27014840
*        ISSUED BECAUSE NO ATTACH HAS BEEN DONE.  IN ORDER TO  @ZA16879 27014940
*        CLEAN UP FROM THE GETPART ERROR AN INITDET WILL BE    @ZA16879 27015040
*        ISSUED, BUT FIRST AN INITATT IS ISSUED.  NOTE THAT NO @ZA16879 27015140
*        NO ATTACH WILL BE DONE.                               @ZA16879 27015240
         XR    R1,R1               CLEAR REGISTER              @ZA16879 27015540
         MVC   PAROMEMP,ASCBDP     SAVE CURRENT MEMORY PRIORITY@ZA16879 27015640
         IC    R1,PARNMEMP         PASS NEW MEMORY PRIORITY    @ZA16879 27015940
         SYSEVENT INITATT          ACTUAL ATTACH IS NOT DONE   @ZA16879 27016040
         OI    LCTINTS2,LCTATTC    INITATT HAS BEEN DONE       @ZA16879 27016140
         XR    R1,R1               CLEAR REGISTER              @ZA16879 27016240
         IC    R1,PAROMEMP         PASS MEMORY PRIORITY IN     @ZA16879 27016340
*                                  EFFECT BEFORE THE ATTACH    @ZA16879 27016540
         SYSEVENT INITDET          NOTIFY SRM OF DETACH        @ZA16879 27026540
         NI    LCTINTS2,X'FF'-LCTATTC  RESET INITATT FLAG      @ZA16879 27036540
         B     SD06330             EXIT                          Y02669 27056640
         EJECT                                                          27061640
*****************************************************************       27066602
*                                                                       27116602
*        CONTINUE WITH NORMAL PROCESSING                                27166602
*                                                                       27176602
*****************************************************************       27186602
CHKCSCB  EQU   *                                                 Y02669 27210002
*                                                                       27220002
*        SAVE FIELDS FROM TCB IF NOT A GETPART ERROR             Y02652 27260002
*                                                                       27310002
         MVC   LCTPARM3(X1),TCBDSP-TCB(R11)  SAVE DISP. PRTY.    Y02652 29150002
         MVC   LCTPARM1(X1),TCBFLGS-TCB(R11)  SAVE TCBFLAGS      Y02652 29250002
         MVC   LCTPARM1+X1(X3),TCBTCTB-TCB(R11)  SAVE TCT PTR.   Y02652 29300002
*        THE TASK COMPLETION CODE IS SET IN LCTPARM4 BEFORE THE YM01961 29350002
*        POST-INVOCATION EXIT IS TAKEN.                         YM01961 29351002
*****************************************************************       29460002
*                                                                       29470002
*        FREE THE CURRENTLY OWNED REGION AND GET A NEW V=V       Y02669 29480002
*        REGION OF THE DEFAULT SIZE. THIS IS DONE BECAUSE:       Y02669 29484002
*        1. IT IS NECESSARY TO FREE ANY STORAGE WHICH MAY        Y02669 29486002
*           BE ALLOCATED WITHIN THE REGION.                      Y02669 29488002
*        2. IF A SPECIAL REGION WAS GOTTEN FOR THE JOB STEP,     Y02669 29488402
*           A DEFAULT REGION MUST BE GOTTEN FOR TERMINATION.     Y02669 29488802
*        THE MEMORY SIZE AVAILABLE FIELD FOR THE JOB IN THE TCT YM07263 29489002
*        FILLED IN BY GETPART IS SAVED FOR SMF SINCE IT IS      YM07263 29489202
*        OVERLAID BY GETPART WHEN A DEFAULT REGION IS GOTTEN    YM07263 29489402
*        FOR TERMINATION.  THIS IS DUE TO GETPART CONSIDERING   YM07263 29489602
*        THE ONLY SPACE GOTTEN IS FOR THE JOB.                  YM07263 29489802
*                                                                       29490002
*****************************************************************       29492002
         L     R3,TCBTCT-TCB(R5)   SAVE THE TCT PTR IN REG 3    YM07263 29572002
*                                  OVER THE FREEPART/GETPART    YM07263 29652002
         L     R10,LCTSTEPL        GET STAE EXIT LIST ADDR     @ZA05662 29662040
         USING STEPL,R10           ADDR TO STAE EXIT PARAMETER @ZA05662 29672040
*                                  LIST                        @ZA05662 29682040
         ST    R3,STESMFTC      SAVE TCT PTR IN STAE EXIT LIST @ZA05662 29692040
         XR    R0,R0               CLEAR REG 0                  YM07263 29732002
         ST    R0,TCBTCT-TCB(R5)   CLEAR THE TCT PTR            YM07263 29812002
         TM    TCBFLGS6-TCB(R5),TCBRV  CHECK FOR V=R OR V=V      Y02669 29900002
         BO    FREEREA3            V=R                           Y02669 29950002
         L     R0,SP247            V=V                           Y02669 30000002
         B     FREEREG3            PRESERVE SP 247 IN REG 0      Y02669 30050002
FREEREA3 EQU   *                                                 Y02669 30100002
         L     R0,SP242            V=R                           Y02669 30150002
FREEREG3 EQU   *                                                 Y02669 30200002
         LA    R1,POSITIVE         SET POSITIVE TO INDICATE A   YM00408 30250002
*                                  FREEMAIN BUT NOT A SUBPOOL   YM00408 30260002
*                                  FREEMAIN                     YM00408 30270002
         FREEMAIN R,LV=(0),A=(1)   FREE REGION                   Y02669 30300002
*                                                                Y02669 30350002
*        GET A V=V REGION OF THE DEFAULT SIZE                    Y02669 30400002
         L     R0,SP247                                          Y02669 30450002
         GETMAIN R,LV=(0)          GET REGION                    Y02669 30550002
         ST    R3,TCBTCT-TCB(R5)   RESTORE THE TCT PTR IN TCB   YM07263 30555002
*****************************************************************       30560002
*                                                                       30570002
*        CLEAR FIELDS IN THE CSCB WHICH CONTAIN V=R REGION SIZE  Y02669 30580002
*        AND BEGINNING ADDRESS.                                  Y02669 30582002
*                                                                       30590002
*****************************************************************       30592002
         L     R3,LCTQDRTY                                       Y02669 30594002
         USING IEFCSCB,R3                                        Y02669 30596002
         L     R5,CHRGNSZ          CHECK WHETHER FIELDS SHOULD   Y02669 30598002
*                                  BE CLEARED (THEY WILL BE NON- Y02669 30598402
*                                  ZERO ONLY IF V=R)             Y02669 30598802
         LTR   R5,R5                                             Y02669 30599202
         BZ    NOFREER             ZERO, DO NOT CLEAR FIELDS     Y02669 30599602
         SR    R5,R5                                             Y02669 30616602
*        THESE FIELDS MUST BE CLEARED IN THIS ORDER SO DISPLAY   Y02669 30617002
*        JOBS WILL PICK UP EITHER BOTH A REGION SIZE AND A       Y02669 30617802
*        REGION ADDRESS OR NEITHER.                              Y02669 30618202
         ST    R5,CHRGNAD          CLEAR REGION ADDRESS          Y02669 30618602
         ST    R5,CHRGNSZ          CLEAR REGION SIZE             Y02669 30626602
*********************************************************************** 30627540
*   THE FOLLOWING FUNCTIONS ARE PERFORMED NOW IN ORDER TO      @ZA03278 30628440
*   PREVENT THE MEMORY FROM BEING SWAPPED BEFORE THE FREEPART  @ZA03278 30629340
*   WAS DONE FOR V=R REQUESTS.                                 @ZA03278 30630240
*********************************************************************** 30631140
NOFREER  EQU   *                                               @ZA03278 30632040
         L     R10,LCTASCBA        GET ASCB ADDR               @ZA03278 30633340
         USING ASCB,R10                                        @ZA05662 30633840
         SR    R1,R1               CLEAR R1 FOR USE LATER      @ZA03278 30636840
*        (R1 MUST BE 0 TO REACH THIS INSTRUCTION.)             @ZA03278 30637340
         IC    R1,PAROMEMP         PASS MEMORY PRIORITY IN     @ZA03278 30637840
*                                  EFFECT BEFORE THE ATTACH    @ZA03278 30638340
         SYSEVENT INITDET                                      @ZA03278 30638840
         NI    LCTINTS2,X'FF'-LCTATTC  RESET INITATT FLAG      @ZA16879 30639040
*                                                              @ZA03278 30639340
***************************************************************@ZA03278 30639840
         XR    R1,R1                                           @ZA03278 30640340
         ST    R1,ASCBJSTL         CLEAR TIME LIMIT            @ZA03278 30640840
         XC    ASCBEJST,ASCBEJST   CLEAR ELAPSED TIME          @ZA03278 30641340
         XC    ASCBSRBT,ASCBSRBT   CLEAR SRB TIME USED         @ZA03278 30641840
*  THE INITIATOR DOES NOT SET ASCBTOFF HERE, BECAUSE THE       @ZA03278 30642340
*  BIT IS SET BY THE SUPERVISOR.                               @ZA03278 30643340
*                                                              @ZA03278 30643440
***************************************************************@ZA03278 30643540
*                                                              @ZA03278 30643640
*        DETACH THE JOB STEP                                   @ZA03278 30643740
*                                                              @ZA03278 30643840
***************************************************************@ZA03278 30643940
         XC    TCBFSAB-TCB(,R11),TCBFSAB-TCB(R11) CLEAR REG SAVE        30644040
*                                  AREA ADDRESS FROM TCB TO             30644140
*                                  PREVENT DETACH FROM                  30644240
*                                  ATTEMPTING TO FREE THE               30644340
*                                  SAVE AREA. IT WAS FREED              30644440
*                                  BY THE FREEPART.            @ZA03278 30644540
         LA    R1,JOBSTCB          ADDR OF PTR TO JOB TCB      @ZA03278 30644640
         DETACH (1)                                            @ZA03278 30644740
         L     R10,LCTPARM3        CHECK WHETHER GWT EXISTS      Y02669 30644840
         LA    R10,0(0,R10)        CLEAR DISPATCHING PRIORITY    Y02669 30645302
*                                  WHICH WAS SAVED IN LCTPARM3   Y02669 30647302
         LTR   R10,R10                                           Y02669 30649302
         BZ    SD06330             NO GWT TO FREE                Y02669 30649702
         L     R0,GETMAIN2         FREE GWT                      Y02669 30650002
         FREEMAIN R,LV=(0),A=(R10)                               Y02669 30700002
SD06330  EQU   *                                                   I272 31300000
         MVC   LCTADDR,IEFLCTAD    PASS FOR IEFSD164             Y02652 31350002
         LR    R1,R8               PARAMETER LIST POINTER               31500000
         L     R15,VCON064                                       Y02652 31550002
         BR    R15                 EXIT TO IEFSD164              Y02652 31600002
         EJECT                                                          32050002
* THIS IS A GENERALIZED SUBROUTINE TO HANDLE ALL INITIATOR EXITS  20032 32100002
*   INPUT TO IT IS                                                20032 32150002
*              REGISTER 4 POINTING TO THE INTIATOR EXIT LIST      20032 32200002
*              LOW ORDER BYTE OF REGISTER 2 CONTAINS THE EXIT ID        32250002
*                    AS A SEARCH ARGUMENT.                        20032 32300002
*              REGISTER 9 CONTAINS THE ADDRESS TO WHICH THIS     Y02669 32450002
*                    SUBROUTINE SHOULD RETURN                    Y02669 32460002
*              R3 SHOULD CONTAIN THE PARM POINTER TO BE PASSED    20032 32500002
SETEXIT  EQU   *                                                 Y02669 32510002
         DROP  R4                                                Y02669 32520002
         L     R13,IEFLCTAD                                      Y02669 32530002
         USING IEFLOT,R13                                        Y02669 32540002
         LA    R13,REGSAVE         PASS REGISTER SAVE AREA       Y02669 32560002
         SR    R10,R10             PREZERO RETURN CODE            M0397 32700002
         USING IELEXITS,R4         EXIT LIST ADDRESSABILITY       20032 32750002
         LA    R4,ZERO(R4)         CLEAR HIGH-ORDER BYTE          20032 32800002
         LTR   R4,R4               IS THERE AN EXIT LIST          20032 32850002
         BZ    RETURN              NO, RETURN TO CALLER           20032 32900002
         LH    R7,IELXTLEN         LENGTH OF EXIT LIST            20032 32910002
         AR    R7,R4               R7 POINTS TO END OF EXIT LIST  20032 32920002
XITLOOP  EQU   *                                                  20032 32930002
         LA    R4,X8(R4)           R4 NOW POINTS TO FIRST ENTRY   20032 32940002
         CR    R4,R7               HAS LIST BEEN EXCEEDED         20032 32942002
         BNL   RETURN              YES, RETURN TO CALLER          20032 32944002
         EX    R2,XIDCHECK         IS THIS THE ID WE WANT         20032 32946002
         BE    GETOUT              YES, SET UP THE EXIT LINKAGE   20032 32948002
         B     XITLOOP             NO, TRY NEXT ENTRY             20032 32948402
XIDCHECK CLI   X1(R4),X0           THE EXECUTE CAUSES EXITID TO   20032 32948802
*                                       BE COMPARED AGAINST THE   20032 32949202
*                                       THE LOW ORDER BYTE IN R2  20032 32949602
GETOUT   EQU   *                                                  20032 32949702
         CLI   X0(R4),IELEXADD     IS THIS A BRANCH EXIT          20032 32949802
         BE    BRANCH              YES, PREPARE TO BRANCH         20032 32949902
         LA    R0,X16              REMOTE LIST + SUPV PARMLIST    20032 32966602
         GETMAIN R,LV=(0)          GET CORE                       20032 32976602
         XC    0(X16,R1),0(R1)     CLEAR CORE                     20032 32978602
         LR    R15,R1              ADDR OF SUPV PARMLIST          20032 32980602
         LR    R11,R1              SAVE GOTTEN CORE ADDRESS       M0397 32982602
         LA    R2,X8(R1)           ADDR OF REMOTE LIST            20032 32983002
         LR    R1,R3               EXIT LIST ADDRESS              20032 32983102
         MVC   ZERO(X6,R2),X2(R4)  MOVE IN EXIT NAME              20032 32983202
         MVI   X6(R2),BLANK        PAD NAME WITH BLANKS           20032 32988802
         MVI   X7(R2),BLANK        PAD NAME WITH BLANKS           20032 32990802
         ST    R2,ZERO(R15)        REMOTE LIST ADDRESS            20032 32992802
         CLI   X0(R4),IELEXXTL     IS EXIT BY XCTL                20032 32993202
         BE    GOXCTL              YES, PREPARE TO XCTL           20032 32993602
*  IF EXIT IS  NOT BY BRANCH OR XCTL, LINK IS ASSUMED             20032 32994002
         B     GOLINK              EXIT IS BY LINK                20032 32994102
GOXCTL   EQU   *                                                  20032 32994202
         XCTL  ,MF=(E,(1)),SF=(E,(15))  GO TO EXIT ROUTINE        20032 32994302
BRANCH   EQU   *                                                  20032 33008202
         LR    R1,R3               R1 & R3 CONTAIN EXIT PARM      20032 33018202
         L     R15,X4(R4)          ADDRESS OF EXIT ROUTINE        20032 33020202
         BALR  R14,R15             TAKE EXIT                     Y02669 33020602
         LR    R10,R15             SAVE RETURN CODE FOR CALLER @Z30DNPJ 33020803
         B     RETURN              BRANCH TO EXIT POINT OF       Y02669 33021002
*                                  SUBROUTINE                    Y02669 33021402
GOLINK   EQU    *                                                 20032 33021902
         LINK   MF=(E,(1)),SF=(E,(15))  GO TO EXIT ROUTINE        20032 33022002
         DROP  R4                                                 20032 33022102
         LR    R10,R15             SAVE RETURN CODE               M0397 33026702
         LA    R0,X16              LENGTH OF GOTTEN CORE          M0397 33028702
         LR    R1,R11              ADDR OF GOTTEN SUPRV LIST      M0397 33030702
         FREEMAIN   R,LV=(0),A=(1) FREE SUPRV LIST                M0397 33031102
RETURN   EQU   *                                                  20032 33034802
         BR    R9                  RETURN                        Y02669 33038902
         EJECT                                                          33042602
HOURS24  DC    F'8640000'              1440 MINUTES(IN HUNDREDTHS OF    33046302
*                                      SECONDS)                         33050000
SPOOL253 DC    X'FD000000'                                        M3441 33400000
GETMAIN1 DS    0F                                                Y01054 33450000
         DC    AL1(253)            SUBPOOL                       Y02669 33500002
         DC    AL3(MSG3E-MSG092I)  SIZE                          Y02669 33560002
GETMAIN2 DS    0F                  TO FREE GWT                   Y02669 33570002
         DC    AL1(TCORE)                                        Y02669 33580002
         DC    AL3(GPSIZE)                                       Y02669 33590002
SP242    DC    AL1(242)            SUBPOOL                       Y01054 33850000
         DC    AL3(0)              ENTIRE SUBPOOL                Y01054 33900000
SP247    DC    AL1(247)            SUBPOOL                       Y01054 33950000
         DC    AL3(0)              ENTIRE SUBPOOL                Y01054 34000000
SMFAT    DC    V(IEFSMFAT)              SMF TCT BUILDER            SMF1 34150000
VCON064  DC    V(IEFSD064)         EXIT POINT                    Y02652 34150402
CAN622   DC    X'00000622'         FOR PRE-INVOCATION EXIT       Y02669 34152002
*                                  FAILURE                       Y02669 34154002
CODE822  DC    X'00822000'         ABEND CODE                    Y01054 34154402
TEN1000  DC    F'10000'                                          Y02669 34154802
ROUNDMSK DC    X'00080000'         TO CHECK FOR ROUNDING        YM03761 34154902
ROUNDUP  DC    F'1'                TO ROUND UP                  YM03761 34157202
FIVE1000 DC    F'5000'             TO COMPARE AGAINST REMAINDER YM03761 34157702
*                                  AFTER DIVIDING BY 10000 TO   YM03761 34158202
*                                  DETERMINE WHETHER TO ROUND   YM03761 34158702
ABENCODE DC    X'000000BB'         ABEND CODE FOR ATTACH FAILED YM07020 34159102
MSKBYT0  EQU   B'1000'             USED TO INSERT A BYTE INTO  @ZA16879 34159340
*                                  BYTE 0 OF A REGISTER        @ZA16879 34159540
BYT1BIT6 DC    X'00020000'         USED TO TURN ON BIT 6 IN    @ZA16879 34159740
*                                  BYTE 1 OF A REGISTER        @ZA16879 34159940
E0000000 DC    X'E0000000'         'AND' MASK TO KEEP ONLY     @ZA16879 34160340
*                                  BITS 0-2 IF THEY ARE ON     @ZA16879 34160440
ZEROPOST DC    X'40000000'         FOR POST CODE = 0 TEST      @ZA16879 34160640
REGPOOL  DS    0F                                                Y02669 34161340
         DC    AL1(250)            USED TO GET SP 0 WHEN KEY 0   Y02669 34161540
*                                  AND SUPERVISOR STATE          Y02669 34161602
         DC    AL3(0)                                            Y02669 34163702
         SPACE                                                          34165802
MOVE     MVC   0(0,R9),0(R14)      TO FILL IN MESSAGES           Y01054 34167902
IEFUSEP  MVC   0(0,R1),0(R7) MOVE USER PARM FROM 253 TO ZERO            34170002
         SPACE                                                          34172002
RC4      DC    H'4'                RETURN CODE                   Y02669 34174002
RC12     DC    H'12'               RETURN CODE                   Y02669 34176002
H10      DC    H'10'               USED TO CONVERT TO DECIMAL    Y02669 34180002
NOAFFIN  DC    X'FFFF'             TO CLEAR AFFINITY             Y02651 34180202
RC0      DC    X'00'               RETURN CODE                  YM03531 34180302
         SPACE                                                          34180402
PATCH    DC    50F'0'              PATCH AREA                    Y02669 34190002
         EJECT                                                          34202002
PC16     EQU   16                  POST CODE                     Y02669 34210002
X0       EQU   0                                                   I272 34250000
X1       EQU   1                                                   I272 34300000
X2       EQU   2                                                 Y01054 34350000
X3       EQU   3                                                   I272 34400000
X4       EQU   4                                                   I272 34450000
X8       EQU   8                                                   I272 34500000
X16      EQU   16                  DISPLACEMENT                    I272 34600000
HEX00    EQU   X'00'                                             Y02669 35220002
ZERO     EQU   X'00'                                             Y02669 35230002
BLANK    EQU   C' '                                              Y02669 35240002
POSTBIT  EQU   X'40'                                                    35350000
PKEZERO  EQU   X'00'                                               I272 35400000
X6       EQU   6                                                   I272 35600000
X7       EQU   7                                                  M2696 35650000
X12      EQU   12                                                  I272 35700000
TCORE    EQU   253                                                 I272 35800000
MSG3     EQU   8                   TO LOCATE MESSAGE IEF092I     Y01054 36050000
MSG9     EQU   32                  TO LOCATE MESSAGE IEF085I     Y01054 36250000
MSG9C    EQU   43                  DISPLCAEMENT OF CODE IN MSG   Y02669 36300002
MSG9E    EQU   MSG9C+6             TO MOVE MESSAGE               Y02669 36350002
*        THERE ARE 6 BYTES FOLLOWING THE BEGINNING OF THE CODE   Y02669 36360002
*              2 BYTES FOR THE CODE                              Y02669 36370002
*              4 BYTES FOR ROUTING AND DESC. CODES               Y02669 36380002
MSGA     EQU   36                  TO LOCATE MESSAGE IEF186I     Y02669 36400002
MSGAC    EQU   55                  DISPLACEMENT OF CODE IN MSG   Y02669 36450002
MSGAE    EQU   MSGAC+6             TO MOVE MESSAGE               Y02669 36500002
*        THERE ARE 6 BYTES FOLLOWING THE BEGINNING OF THE CODE   Y02669 36550002
*              2 BYTES FOR THE CODE                              Y02669 36600002
*              4 BYTES FOR ROUTING AND DESC. CODES               Y02669 36650002
S8       EQU   8                   TO SHIFT 1 BYTE               Y02655 36814002
TWOTO20  EQU   20                  TO MULTIPLY AND DIVIDE BY     Y02669 36824002
*                                  SHIFTING                      Y02669 36834002
TWOTO10  EQU   10                  TO DIVIDE BY 1024 BY SHIFTING Y02669 36847902
HEADER   EQU   8                   LENGTH OF HEADER TO USER PARM Y02669 36860902
*                                  FIELD                         Y02669 36870902
POSITIVE EQU   1                                                YM00408 36872902
         SPACE                                                          36874002
MSG092I  DSECT                                                   Y02669 36887002
         DS    CL12                                              Y02669 36900002
MSG3J    DS    CL8                 JOBNAME                       Y02669 36950002
         DS    C                                                 Y02669 37000002
MSG3S    DS    CL8                 STEPNAME                      Y02669 37050002
         DS    C                                                 Y02669 37100002
MSG3P    DS    CL8                 PROCSTEP NAME                 Y02669 37150002
         DS    C' WAITING FOR '                                  Y02669 37200002
MSG3R    DS    CL5                 REGION SIZE REQUILED          Y02669 37250002
         DS    C'K REAL STORAGE'                                 Y02669 37300002
         DS    CL4                 ROUTING AND DESC. CODES       Y02669 37350002
ZONED    DS    CL6                 TO CONVERT TO ZONED DECIMAL   Y02669 37400002
PACKED   DS    D                   TO CONVERT TO PACKED DECIMAL  Y02669 37450002
MSG3E    EQU   *                   END OF BUFFER                 Y02669 37500002
         EJECT                                                          37520002
         IEFZB630                                                       37522002
         SPACE 4                                                        37524002
IEFLOT   DSECT                                                          37530002
         IEFALLCT                                                       37540002
         SPACE 4                                                        37550002
         IEFZB600                                                Y01054 37590002
         SPACE 4                                                        37600002
         IEZJSCB                                                        37640002
         SPACE 4                                                        37642002
         IHAASCB                                                        37650002
         SPACE 4                                                        37660002
IEL      DSECT                                                   Y02669 37700002
         IEZIEL EXITS=RTN                                        Y02669 37750002
         SPACE 4                                                        37760002
         IKJTCB                                                         37800002
         SPACE 4                                                        37850002
         IHAPQE                                                  A39401 37950002
         SPACE 4                                                        38000002
         IEFTCT                                                         38050000
         SPACE 4                                                        38100002
IEFCSCB  DSECT                                                     I272 38900000
         IEECHAIN                                                       38950002
         SPACE 4                                                        39000002
TIOT     DSECT                                                   Y01054 39200000
         IEFTIOT1                                                       39250000
         SPACE 4                                                        39300002
CVTDSECT DSECT                                                          39400000
         CVT                                                            39450000
         SPACE 4                                                        39460002
         IHAGDA                                                         39500002
         SPACE 4                                                        39510002
         IEESMCA                                                        39520002
         SPACE 4                                               @ZA05662 39530040
         IEFZB622                                              @ZA05662 39540040
         IHAPSA                                                @ZA11857 39543040
         SPACE 4                                                        39546040
         END                                                            39550000
