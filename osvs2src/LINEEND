         MACRO                                                          00020022
&NAME    LINEEND  &GEN=                                                 00022022
.*CHANGE ACTIVITY= AS FOLLOWS:                                   S21903 00024022
.*A104830-104950,107200-107330,312650                            S22027 00025022
.*A027410-027500,117820-118160,155420-155520,189010-189160       S99228 00025122
.*A199020-199140,297410-297580,298400-299400,334840-334960       S99228 00025222
.*A411810,411900                                                 S99228 00025322
.*C127600-128000                                                 S99228 00025422
.*C330000-330400,429800-429980,700000-702160,719400-719580       S99228 00025522
.*A302610-302700,351620-351740,489610-489700,291210-591320       S22029 00025622
.*C411300,657400,683800-684600                                   S22029 00025722
.*A052650-052750,058610-058720,073230-073350                     S22028 00025822
.*A481000                                                        A42376 00025922
.*C030400,461600,481600-482600,484600                            A42376 00026022
.*A589000                                                         M6293 00026122
.*C030400                                                         M6293 00026222
.*A057800,164600,167800,250600,260800,275400,280000,280900       S21101 00026322
.*A350600,393800,505600,549200,653000,657400                     S21101 00026422
.*C030400,106800,129600-134400,141400-141600,151400              S21101 00026522
.*C162600-162800,166200-166400,184600-184800,204200,204800       S21101 00026622
.*C205200-205600,218800,238200-238800,288000,341600,355400       S21101 00026722
.*C368200-368600,398400-398800,399600,400400,432600              S21101 00026822
.*C489800-490200,490400-491400,492000,505400,508800              S21101 00026922
.*C524000-525000,529000-530200,603600,651200,653800-654600       S21101 00027022
.*C716600                                                        S21101 00027122
.*A040000,420600                                                  M5953 00027422
.*C030400,040000                                                  M5953 00027522
.*C030400,216400                                                SA51068 00027622
.*A310000,430000                                                SA44892 00027722
.*C030400,489800-501200,512600-517400                           SA44892 00027822
.*A283000,598400                                                SA44983 00027922
.*C599000-601600                                                SA44983 00028022
.*C030400,645200                                                SA44894 00028122
.*A238200,454200,581800,669200,671000,671400,671800,674400       S22025 00028222
.*A676200,685000,686000,689800,690600,691200                     S22025 00028322
.*C029200,055000-055200,129200-134800,242800-246000              S22025 00028422
.*C300800-301000,335000,412000,489600,490600-490620,490740       S22025 00028522
.*C492800,504800,580600-581000,584000,587200-587600              S22025 00028622
.*C589198-589266,594200,671800,672000,674200,685200              S22025 00028722
.*C719700-719750                                                 S22025 00028822
.*D037600,111400,118000,145200-147200,298400-298800              S22025 00028922
.*D357000-357200,411400,490810-490870,585800-586400              S22025 00029022
.*D598400-598800,670200-670400,674200                            S22025 00029122
.*A034800,207800,275200,297800,312600,315800,327600,330400       S22026 00029222
.*A336600,346000,347000,351400,352600,356800,452600,522400       S22026 00029322
.*A654800,692200,692400,700200                                   S22026 00029422
.*C357000-357200,522600-522800                                   S22026 00029522
.*D145200-147200,291000,656600                                   S22026 00029622
.*A446800                               MODIFIED 11/15/71        A42413 00030522
.*A022000,368200,369400,380400,719600                           SA48278 00030622
.*A593000                                                       SA49233 00030722
.*A369500,719630                                                SA51061 00030822
.*C368650                                                       SA51061 00030922
.*A448000                               MODIFIED 12/02/71        A42413 00031022
.*A448180                                                         M2561 00031122
.*C030400                                                         M2561 00031222
.*D447600,447800                                                  M2561 00031322
.*C663200,664000                                                SA51097 00031422
.*C104600                                                       SA51791 00031522
.*A366800                                                       SA52517 00031622
.*C466800,467800,468200,468600                                  SA54276 00031722
.*A469800                                                       SA55941 00031822
.*A086220,097620,168010,176007                                  SA48276 00032022
.*D168610-168710                                                SA48276 00032122
.*A228040                                                       SA50194 00032222
.*A022000,064000,119600                                         SA51090 00032322
.*C118200-118400,120400,702010                                  SA51090 00032422
.*D119000                                                       SA51090 00032522
.*A689040                                                       SA52946 00032622
.*C172600,173400,413400,414400,A414500                          SA54923 00032722
.*A000200,002000,616800,618400                                  SA56617 00032822
.*C000400,000410-000426,000600-000800,001000,615200-615400      SA56617 00032922
.*D002200-019600                                                SA56617 00033022
.*A038410                                                       SA56915 00033122
.*C384200                                                       SA57329 00033222
.*A049060-049120                                                 A56906 00033322
.*C049000                                                        A56906 00033422
.*A162000,692200,692400                                          S99244 00033522
.*C149400,22220                                                  S99244 00033622
.*C466800,467800,468200,468600                                  SA54276 00033722
.*A469950,477000,477600                                         SA57685 00034122
.*C477000                                                       SA57685 00034222
.*C228040                                                       SA58997 00034322
.*D591203-591206,591230                                         SA59020 00034422
.*D521800-522400,523000,705400                                   S21903 00034522
.*A547600                                                       SA57695 00034622
.*C470000,547800,552200                                         SA57695 00034722
.*D552600-555000                                                SA57695 00034822
.*A469950                                                       SA59538 00034922
.*C466000                                                       SA59538 00035022
.*C062600                                                       SA59027 00035122
.*C061000,086300-086301,097680,301800,335200,411775-411795      SA59028 00035222
.*C411806-411810,451400,719560                                  SA59028 00035305
.*A125400                                                       SA59992 00035405
.*A117800                                                       SA61780 00035505
.*D121400                                                       SA61780 00035605
.*A199080                                                       SA62341 00035705
.*A311800                                                       SA61094 00035805
.*C046000                                                       SA62408 00035905
.*D432926                                                       SA62383 00036005
.*A608400                                                       SA62329 00036105
.*C609200,609800-610000                                         SA62329 00036205
.*451480                                                        SA62984 00036305
.*A172400                                                       SA61779 00036405
.*C058710                                                       SA61779 00036505
.*A411830                                                       SA63959 00036605
.*D411809-411812                                                SA63959 00036705
.*A036200                                                       SA65392 00036854
.*A398610,720091                                                SA62991 00036954
.*D 300600                                                      SA61794 00037054
.*C 301200-301900                                               SA61794 00037154
.*A049000                                                       SA64676 00037254
.*A634800,643000                                                SA65359 00037354
.*C618470-618480                                                SA65359 00037454
.*A701740,701800                                                SA65374 00037554
.*A471600,472000                                                SA65357 00037654
.*A700010,700900                                                SA65397 00037754
.*A613000                                                       OX02181 00037854
.*D613800                                                       OX02181 00037954
.*C569600-569800                                                SA65389 00038054
.*C398510                                                       SA66594 00038154
.*A577800                                                       SA65865 00038254
.*D577000-577200                                                SA65865 00038354
.*A376000                                                       SA65387 00038454
.*D376800                                                       SA65387 00038554
.*A115200                                                       SA66616 00038654
.*A035200                                                       SA65906 00038754
.*D689001-689002                                                SA66937 00038854
.*A007600,054800,414400,415000,418200,455000,702800,710810       X01004 00038954
.*C030800-034400,054800,124440,137800,179000,275500,             X01004 00039054
.*C291200-291400,300000-300400,352000-352400,352800,358000,      X01004 00039154
.*C398730,413200-414400,414600-415000,432930,534600-536400,      X01004 00039254
.*C655660                                                        X01004 00039354
.*D006000-006400,022050,034600,055000-055090,124600-124800,      X01004 00039454
.*D138000,179200-179400,291600-291800,300600-300630,353000,      X01004 00039554
.*D358200,453200-453800,455200,536600,537400-537600              X01004 00039654
.*A000000                                                        Y01948 00039754
.*C035400,054012,054168,107203,107243,118080,127600,282000,      Y01948 00039854
.*C282800,293000,315870,327685,341780,354100,378200,385600,      Y01948 00039954
.*C395600,404600,405400,420600,443600,444200,587800,592600,      Y01948 00040054
.*C655800,698600-698800,701054,701057                            Y01948 00040154
.*D000200-000240,035600,054013-054014,                           Y01948 00040254
.*D054175-054182,118100-118120,127800-128000,282200,284800,      Y01948 00040354
.*D293200-293400,315880-315910,327690-327695,341784-341788,      Y01948 00040454
.*D354120-354140,376600,378400-378600,385800-386000,             Y01948 00040554
.*D395800-396000,404800-405000,405600-405800,420640-420680,      Y01948 00040654
.*D443800-444000,444400-444600,588000-588200,592800-593000,      Y01948 00040754
.*D656000-656200,698200,701055,701058-701059                     Y01948 00040854
.*A025600,036000,036220,049200,488800,702020,702030,720091       X02004 00040954
.*C030960-034160,035400,036000,064060,120456,294920,             X02004 00041054
.*C300400,300740,368300,489490,489550,589163-589165,589179,      X02004 00041154
.*C589181,720000                                                 X02004 00041254
.*D021000,030800-030840,034180-034920,294930,300900-301000,      X02004 00041354
.*D488800-489070,489200,489600                                   X02004 00041454
.*C418296,418300                                                 Y00482 00041554
* A580200                                                       SA66604 00041605
* C301350-301920                                                SA66604 00041705
* C329780                                                       SA66598 00041805
* A700340                                                       SA65428 00041905
* D700370                                                       SA65428 00042005
* A432799                                                       SA65874 00042105
* A700880                                                       SA66946 00042205
* A330020,330146,348000                                         SA66632 00042305
* C057800,111200-112400                                         SA67139 00042405
* A110600                                                       S167139 00042505
* D686100,686150                                                SA62379 00042605
* A411720                                                       SA63595 00042705
* D411760-411765                                                SA63595 00042805
* A056200                                                       OX03963 00042905
* A701057                                                       OX03941 00043005
* A101600                                                       OY00507 00043105
* A054021,054189                                                OY03460 00043205
* D053800-054000                                                OY03460 00043305
* C330480-330500                                                SA68026 00043405
* A236600,297000,428600                                         SA68035 00043505
* A168600                                                       SA69087 00043605
* D172500                                                       SA69087 00043705
* A301290                                                       SA64386 00043805
* 376400                                                       @YA04894 00043961
* C113400                                                      @SA70316 00044061
* C484720                                                      @SA70874 00044161
* A552300                                                      @SA69964 00044261
* A204000                                                      @SA69968 00044361
* C678600                                                      @ZO2X6I0 00044461
*A483600                                                       @SA71694 00044561
*C411830                                                       @SA71658 00044661
*A327000                                                       @SA71963 00044761
*A279000                                                       @SA71490 00044861
*A137200                                                       @SA61090 00044961
*C036070-036090,036095                                         @ZA02096 00045061
*A049320                                                       @ZA02096 00045161
*C449630                                                       @ZA02095 00045261
*A720151                                                       @ZA02095 00045361
*A279600                                                       @YA06316 00045461
*C330148                                                       @YA06327 00045561
*A118080                                                       @YA06889 00045661
*A633600                                                       @XA07517 00046600
*A117860,118080,124400,580320,587800                           @SA62375 00047600
*C149400-149800,222200                                         @SA72446 00048600
*A577800                                                       @XA06335 00049600
*A469800,469950                                                @YA08108 00050600
*C196800                                                       @YA06307 00051600
*A575800,577817                                                @YA05167 00052600
*C577801,577803-577808,577811-577812,577920                    @YA05167 00053600
*A477600                                                       @SA73826 00054600
*D137300                                                       @SA73574 00055600
*A137400                                                       @SA73574 00056600
*C214000                                                       @SA74852 00057600
*A117810                                                       @SA74852 00058600
*C547920                                                       @SA74852 00059600
*D348050,348150                                                @XA09327 00060600
*A373600                                                       @XA09327 00061600
*C049330,049360                                                @ZA03108 00062600
*A646600                                                       @YA09751 00063600
*D117863-117866,C119400,A119400,A118100                        @YA10052 00064600
*A577950,D577801-577823                                        @YA10237 00065600
*C312000-312200                                                @SA75453 00066600
*A162550,163000                                                @YA10410 00067600
*A118600,A120470                                               @YA10673 00068600
*C196800-196950                                                @SA75722 00069600
*C118100                                                       @YA10695 00070600
*C048400                                                       @SA75471 00071600
*A149000                                                       @YA11157 00072600
*D149600                                                       @YA11157 00073600
*C503900-505200                                                @XA11311 00074600
*C312200,312260                                                @YA11162 00075600
*D433066-436600,D275600,D347400,D599000,D342400                @YA11151 00076600
*C560000                                                       @XA11338 00077600
*A190800                                                       @YA11495 00078600
*C503900                                                       @OS76474 00079600
*C429900-429960                                                @OS76301 00079791
*A119200,A119600                                               @OY11504 00079891
*D054009-054011                                                @OS76307 00079991
*A316800                                                       @OS76271 00080091
*A111000                                                       @OY11520 00080191
*A162099,C222200                                               @OS76283 00080291
*C428680                                                       @OY11499 00080391
*C411735,D411766-411767                                        @OS76490 00080491
*C188600                                                       @OY12393 00080591
*D376100                                                       @OS76479 00080691
*C162570                                                       @OY12287 00080791
*D163020-163160                                                @OY12287 00080891
*D196820-196960                                                @OY12287 00080991
*A339600,D340200-340800,C342000,C344600,D345000-345400,C346100 @OZ07786 00081091
*A250800,C251800-252000                                        @OY10984 00081191
*A374200                                                       @OX11954 00081291
*C519000-519800                                                @OY11983 00081391
*A023000,603700,653120,710850                                  @XA08073 00081491
*C162090,603600,653100,657580-657730                           @XA08073 00081591
*A204130                                                       @OZ09265 00081691
*D190840,190960                                                @OS76981 00081791
*C330280,330286,A330290                                        @OX12505 00081891
*C353800                                                       @OX12508 00081991
*C621400                                                       @OX12509 00082091
*C187000                                                       @OS76996 00082191
*A246800                                                       @OY12676 00082291
*A689800                                                       @OX12511 00082391
*A120568                                                       @OZ09957 00082491
*A310200,C311870-311890                                        @OZ09279 00082591
*C353800                                                       @OY13656 00082691
*A166200                                                       @OX12567 00082791
*C643040                                                       @OZ08362 00082891
*D643120                                                       @OY13667 00082991
*C621400                                                       @OZ08362 00083091
*A058800                                                       @OS77837 00083191
*D201800-202000,208400-208600                                  @OY14092 00083291
*A232000                                                       @OS77835 00083391
*A086200,408400,C270600-270800,431400,D409400,A097720          @OY14057 00083491
*D250810-250900,251820-252090,C086300-086320                   @OY14057 00083591
*C398650-398700                                                @OX12579 00083691
*A207200,C657614-657668                                        @OY13632 00083791
*A376000                                                       @OS77376 00083891
*A493000                                                       @OX14778 00083991
*A127350                                                       @OZ14176 00084091
*D127230-127350,A133200                                        @OZ14197 00084191
*A101640,A101700                                               @OS77954 00084291
*A683800,A694800                                               @OX14796 00084391
*C166215                                                       @OX16385 00084491
*D429900,429930                                                @OZ16530 00084591
*A432886                                                       @OS77965 00084691
*A029800,451480,C701954,702020                                 @OZ16540 00084791
*D035250,035300                                                @OX16693 00087791
*A235000                                                       @OX16686 00090791
*C133230-133320                                                @OZ17622 00093791
*A428685                                                       @OZ18753 00093891
*C101641                                                       @OS78332 00093991
*A270650                                                       @OX16703 00094091
* C001810,012000,035400,035600,454340,701404                   @G36XRIV 00098000
*D106800-107200,C107210-107220,162600,288000,A448920           @OX17153 00098100
*C036288,A036296,D101641-101655,D101710                        @OZ24288 00099100
*C225600                                                       @OX19180 00100100
*127200                                                        @OZ25091 00100500
*D133220,133270                                                @OZ25091 00100900
*C230000                                                       @OS79864 00101300
*D493060_493120                                                @OZ25700 00101700
*D166203-166212,D166221                                        @OZ26326 00102100
*C451440                                                       @OZ25960 00102500
*D451480,451481,493060,493120                                  @OZ25960 00102900
*A036288                                                       @OZ27868 00103100
.*A527200                                                      @OY19728 00103300
*A366200                                                       @OY20569 00103486
.*****        DEVELOPMENT                                       ******* 00103586
.*A022460-022520,442600-444700,448186-448193,720160-720187       Y02027 00103686
.*C030860,030980                                                 Y02027 00103786
.*D033940,442600-445800,448020-448160,448186-448192              Y02027 00103886
*A522909                                                       @OZ29663 00103986
*C216000                                                       @OY19793 00104086
*A451400                                                       @OX21187 00104186
*A693000                                                       @OZ30260 00104286
*A033800                                                       @OY20488 00104386
*C719428,719500                                                @OY20488 00104486
*C242800                                                       @OZ31566 00104586
*********************************************************************** 00120020
*                                                                     * 00121022
         TITLE '&NAME     LINE END APPENDAGE'                           00122022
&NAME    CSECT                                                          00123022
*                                                                     * 00124022
*********************************************************************** 00125022
*TITLE -- LINE END APPENDAGE                                          * 00140020
*                                                                     * 00160020
         AIF   ('&GEN' NE 'MINI').TAG1                                  00161022
*       MODULE NAME = IGG019Q4 (MINI)                                 * 00162022
         AGO   .TAG5                                                    00163022
.TAG1    AIF   ('&GEN' NE 'STSP').TAG2                                  00164022
*       MODULE NAME = IGG019Q3 (START/STOP)                           * 00165022
         AGO   .TAG5                                                    00166022
.TAG2    AIF   ('&GEN' NE 'BISC').TAG3                                  00167022
*       MODULE NAME = IGG019Q2 (BI-SYNC)                              * 00168022
         AGO   .TAG5                                                    00169022
.TAG3    AIF   ('&GEN' NE 'QTAM').TAG4                                  00170022
*       MODULE NAME = IGG019Q5 (QTAM)                                 * 00171022
         AGO   .TAG5                                                    00172022
.TAG4    AIF   ('&GEN' NE '').TAG5                                      00173022
*       MODULE NAME = IGG019R0 (BOTH)(BLANK)                          * 00174022
.TAG5    ANOP                                                           00175022
*                                                                     * 00176022
*       DESCRIPTIVE NAME = LINE END APPENDAGE                         * 00177022
*                                                                     * 00178022
*       COPYRIGHT = 'NONE'                                            * 00179022
*                                                                     * 00180022
*       STATUS: CHANGE LEVEL 10                                @G36XRIV 00181000
*                                                                     * 00200020
*FUNCTION -- AS A LOGICAL EXTENSION OF IOS LINE END APPENDAGE OBTAINS * 00220020
*   CONTROL WHEN AN I/O INTERRUPT OCCURS WITH ENDING STATUS, WHEN AN  * 00240020
*   ERROR IS DETERMINED TO BE PERMANENT BY ERP, OR WHEN AN ERROR IS   * 00260020
*   CLEARED BY ERP.                                                   * 00280020
*                                                                     * 00300020
*ENTRY POINTS -- FIRST EXECUTABLE INSTRUCTION                         * 00320020
*                                                                     * 00340020
*INPUT -- R2  IOB ADDRESS                                             * 00360020
*   R14 RETURN ADDRESS                                                * 00380020
*   R15 ENTRY POINT ADDRESS                                           * 00400020
*                                                                     * 00420020
*OUTPUT -- REGISTERS 0-9,14,15 REMAIN TRANSPARENT TO IOS UPON EXIT    * 00440020
*   FROM THIS MODULE                                                  * 00460020
*                                                                     * 00480020
*EXTERNAL ROUTINES --                                                 * 00500020
*   OS POST - TO POST MCP WAIT COMPLETE                               * 00520020
*                                                                     * 00540020
*   STAGE TWO OF EXIT EFFECTOR - TO SCHEDULE IQE                      * 00560020
*                                                                     * 00580020
*                                                                     * 00600020
*   'TCB REMOVAL ROUTINE' - TO MAKE MCP TCB NON-DISPATCHABLE FOR MP   * 00620020
*   65 ONLY.                                                          * 00640020
*                                                                     * 00660020
*   'IEDQKA02' - I/O GENERATOR SUBROUTINE TO BUILD CONTINUE CHANNEL   * 00680020
*   PROGRAMS.                                                         * 00700020
*                                                                     * 00720020
*   'IEDQTNT' - TO OBTAIN TERMINAL TABLE ENTRY ADDRESS FROM TNT OFFSET* 00740020
*                                                                     * 00760020
*   'IEAPTRV' - TO CONVERT REAL ADDRESS TO VIRTUAL               X01004 00766005
*                                                                X01004 00772005
*EXITS-NORMAL --                                                      * 00780020
*   B  4(14) - TO SKIP POST AND FREE REQUEST ELEMENT                  * 00800020
*   B  8(14) - TO RESTART A CHANNEL PROGRAM                           * 00820020
*                                                                     * 00840020
*EXITS-ERROR --                                                       * 00860020
*   BR  14 TO SCHEDULE ERP UPON 1ST DETECTION OF ERROR                * 00880020
*                                                                     * 00900020
*TABLES/WORK AREAS -- DSECTS OF CONTROL BLOCKS GENERATED BY MACROS:   * 00920020
*   TAVTD                                                             * 00940020
*   TLCBD                                                             * 00960020
*   TQCBD                                                             * 00980020
*   TTRMD                                                             * 01000020
*   TTSID                                                             * 01020020
*   TCCWD                                                             * 01040020
*   TSCBD                                                             * 01060020
*   TPRFD                                                             * 01080020
*   DCBD                                                              * 01100020
*   TRECBD                                                            * 01120020
*   TTNTD                                                             * 01140020
*   TDEBD                                                             * 01160020
*                                                                     * 01180020
*ATTRIBUTES -- REFRESHABLE, SUPERVISOR MODE, ENABLED.          @G36XRIV 01200000
*                                                                     * 01220020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 01240020
*   PARTICUALR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 01260020
*   SET.                                                              * 01280020
*                                                                     * 01300020
*   IF A PERMANENT ERROR HAS NOT OCCURRED, ENDING STATUS IS EXAMINED  * 01320020
*   TO DETERMINE IF ERP IS TO BE SCHEDULED.  UNUSUAL ENDING STATUS    * 01340020
*   RESULTS IN A RETURN TO IOS TO SCHEDULE THE FIRST LOA: OF ERP FOR  * 01360020
*   THIS DEVICE.                                                      * 01380020
*                                                                     * 01400020
*   WHEN ERP ACTION IS NOT REQUIRED, LINE END APPENDAGE OBTAINS THE   * 01420020
*   TP OP CODE FOR THE FAILING CCW BY USING THE ADDRESS IN THE CSW AS * 01440020
*   AN INDEX ARGUMENT INTO A LIST OF TP OP CODES (LCBTPCD).  THE TP   * 01460020
*   OP CODE IS USED AS AN INDEX INTO A BRANCH TABLE, TO TAKE          * 01480022
*   SPECIFIC ACTION FOR THIS INTERRUPT.  TWO TABLES ARE EMPLOYED.     * 01500020
*   ONE IS FOR NORMAL ENDING STATUS.  THE OTHER FOR ERROR CONDTIONS   * 01520020
*   DETTECTED BY ERP.                                                 * 01540020
*                                                                     * 01560020
*   FOR ERRORS THAT HAVE OCCURRED PRIOR TO TEXT TRANSFER, A ZERO      * 01580020
*   LENGTH BUFFER IS POSTED TO MH FOR INMSG/OUTMSG PROCESSING.        * 01600020
*                                                                     * 01620020
*   IF AN EOB INTERRUPT OCCURS WHILE RECEIVING A MESSAGE, A RESTART   * 01640020
*   IS MADE FROM THE APPENDAGE UNLESS MH PROCESSING IS REQUIRED.      * 01660020
*   WHEN EOT IS RECEIVED, THE FILLED BUFFER(S) ARE POSTED TO MH       * 01680020
*   INDICATING THAT THIS IS END OF MESSAGE.  FOR AN EOB INTERRUPT ON  * 01700020
*   OUTPUT, PREVIOUS BUFFERS ARE POSTED TO THE BUFFER RETURN QCB AND  * 01720020
*   A RESTART IS ACCOMPLISHED.  THE LAST BUFFER  OF A SUCCESSFULLY    * 01740020
*   SENT MESSAGE IS POSTED TO BUFFER DISPOSITION FOR OUTMSG EXITS.    * 01760020
*                                                                     * 01780020
*   IN THE EVENT OF A TEXT MODE ERROR, THE ABOVE ACTION IS TAKEN      * 01800020
*   EXCEPT THAT THE BUFFER REFLECTING THE INTERRUPT IS POSTED TO MH   * 01820020
*   TO OBSERVE USER SELECTED OPTIONS.                                 * 01840020
*                                                                     * 01860020
*   THE 'SCAN' ROUTINE IS ENTERED FROM PCI APPENDAGE AS WELL AS FROM  * 01880020
*   LINE END APPENDAGE.  ITS ADDRESS IS ALWAYS AT AN OFFSET OF 4 INTO * 01900020
*   THIS MODULE.  OPEN MOVES THIS ADDRESS INTO THE AVT FOR ACCESS BY  * 01920020
*   PCI APPENDAGE.                                                    * 01940020
*********************************************************************** 01960020
         EJECT                                                          01980020
         USING IEDQPRF,RPREFIX                                          02000020
         USING IEDQLCB,RLCB                                             02020020
         USING IEDQCCW,RCCW                                             02040020
         USING IEDQAVTD,RAVT                                            02060020
         USING IEDQSCB,RSCB                                             02080020
         USING IEDQLCBX,RE                                       S99228 02090022
*                                                                       02140020
*        REGISTER EQUATES                                               02160020
*                                                                       02180020
R0       EQU   0                                                        02200020
R1       EQU   1 .                     GENERAL REGISTER         SA48278 02210022
RLCB     EQU   2                        LCB BASE                        02220020
RWKA     EQU   3                                                        02240020
CURR     EQU   3 .                      ADDR OF CURRENT ELEMENT  Y02027 02246006
*                                  ON ASYNCHRONOUS READY QUEUE   Y02027 02252006
RBASE    EQU   4                                                        02260020
RF       EQU   5                        WORK REGISGER                   02280020
RPREFIX  EQU   6                                                        02300020
RLIST    EQU   6                        INVITATION LIST REG    @XA08073 02310091
RA       EQU   7                        WORK REGISTER                   02320020
RB       EQU   8                        WORK REGISTER                   02340020
RC       EQU   9                        WORK REGISTER                   02360020
RD       EQU   10                       WORK REGISTER                   02380020
RDCB     EQU   10                                                       02400020
RE       EQU   11                       WORK REGISTER                   02420020
R11      EQU   11                                                       02440020
RCCW     EQU   12                       CCW BASE                        02460020
RAVT     EQU   13                       AVT BASE                        02480020
RSCB     EQU   14                       SCB BASE                        02500020
R14      EQU   14                                                       02520020
R15      EQU   15                                                       02540020
         EJECT                                                          02560020
         DC    A(ELINEND-&NAME)         LENGTH OF MODULE         X02004 02566005
         USING *,R15                                             X02004 02572005
         B     ID                                                       02580020
         AIF   ('&GEN' EQ 'MINI').L6                                    02600022
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ '').LL41           S99228 02605022
SCANAD   DC    A(0)                     DUMMY SCAN ROUTINE ADCON S99228 02610022
*                                       TO PRESERVE DISPLACEMENTSS99228 02615022
*                                       OF LOOKAD AND SORCEAD FORS99228 02620022
*                                       START-STOP               S99228 02625022
         AGO   .LL42                                             S99228 02630022
.LL41    ANOP                                                    S99228 02635022
* * * * * * * * * * * * * * * * * * * * * *  * * *  * * * * * * * * * * 02640020
* * *    SCANAD MUST ALWAYS BE AT AN OFFSET OF FOUR IN TO THIS    * * * 02660020
* * *    APPENDAGE.                                               * * * 02680020
* * * * * * * * * * * * * * * * * * * * * *  * * *  * * * * * * * * * * 02700020
SCANAD   DC    A(SCAN)                  SCAN FOR BSC READ TEXT          02720020
* * * * * * * * * * * * * * * * * * * * * *  * * *  * * * * * * * * * * 02740020
*                                                                S99228 02741022
*                                                                S99228 02742022
* LOOKAD AND SORCEAD MUST BE AT OFFSET EIGHT AND TWELVE          S99228 02743022
* RESPECTIVELY                                                   S99228 02744022
*                                                                S99228 02745022
.LL42    ANOP                                                    S99228 02745522
LOOKAD   DC    A(LOOKER)                ADDR DVCCSTCS LOC RTN    S99228 02746022
SORCEAD  DC    A(SOURCER)               ADDR GENPOLL SRC DET RTN S99228 02747022
FNDQCBAD DC    A(FINDQCB) .             FIND DEST QCB ROUTINE    S22029 02747222
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'QTAM').L6         S99228 02747522
FINDAD   DC    A(FINDER)                ADDR INVLIST ENT LOC RTN S99228 02748022
*                                                                S99228 02749022
*                                                                S99228 02750022
BSCRSPAD DC    A(BSCRSP)                BSC READ RESPONSE TO TEXT       02760020
CHACKAD  DC    A(CHACK)                 CHECK RESPONSE -BSC             02780020
BSC27AD  DC    A(BSC270X)               CSW ADJUST BSC WRITES TEXT      02800020
.L6      AIF   ('&GEN' EQ 'MINI').L701                                  02820020
IDCHKAD  DC    A(IDCHK)                 ID CHECK ROUTINE                02840020
         AIF   ('&GEN' EQ 'BISC').L7                                    02860020
         AIF   ('&GEN' EQ 'QTAM').CA                                    02900022
DYNCAD   DC    A(DYNC) .                                         TSO    02910022
.CA      ANOP                                                    S22025 02920022
TSOCHKAD DC    A(TSOCHK)                                                02930022
OPCHKAD  DC    A(OPCHK1)                                                02940020
.L7      ANOP                                                           02960020
POLLAD   DC    A(POLLRT)               AUTOPOLL ROUTINE                 02980020
POLLADR  DC    A(POLLCK)                                       @OZ16540 02990091
.L701    ANOP                                                           03000020
&NAME    IEDHJN , .                     MODULE ID AND DATE       S22025 03020022
ID       DS    0H                                                       03060020
         L     R11,CVTPTR .            PICKUP CVT ADDRESS        Y02027 03080006
         L     RAVT,AVTCVTPT(,R11) .    LOAD LIST                X01004 03083005
         L     RAVT,ZERO(,RAVT) .       AVT BASE                 X01004 03086005
         STM   R0,RC,AVTSAVEX .         SAVE REGISTERS           X01004 03089005
         ST    R14,AVTDPARM .           SAVE RETURN ADDRESS      X01004 03092005
         LA    RCCW,DEBNMSUB-DEBAPVT    OFFSET TO DEB PREFIX     Y02027 03095006
         LA    R15,0(RWKA)              COPY DEB ADDRESS         Y02027 03096006
         SR    R15,RCCW                 DEB PREFIX               Y02027 03097006
         L     R15,SIOPTR(,R15)         ADDRESS OF SIO APPENDAGE X02004 03100005
         BAL   RCCW,INTENTRY(R15)       LINK TO SIO APPENDAGE TO X02004 03140005
*                                       TRANSLATE CCW'S REAL TO  X02004 03180005
*                                       VIRTUAL.                 X02004 03220005
         DROP  R15                                               X02004 03260005
         USING *,RCCW                   SET TEMPORARY BASE       X02004 03300005
TEMPBASE EQU   *                                                 Y02027 03320006
         SPACE 2                                                 X02004 03340005
         SH    RLCB,LCBSIZE             BACK UP TO LCB           X02004 03380005
         NI    LCBERBST,AVTEFF-LCBLOGDV RESET LOG REQUESTED    @OY20488 03385086
         TM    LCBINCAM+1,AVTEFF        DID IOHALT INTERRIPT AN  Y02027 03390006
*                                       INTERIM I/O OPERATION           03400006
*                                       OF ERP. EG BREAK FOR UE         03410006
         BZ    NOIOHLT                  BRANCH NO ERP FLAGS SET  Y02027 03420006
         BM    IOHLT                    YES, SET IOHALT FLAGS    Y02027 03420506
*        IF LCBINCAM+1=X'FF' , ENTRY FROM CLOSE FOR END OF DAY   Y02027 03421006
*        OBR/SDR RECORDING.                                      Y02027 03421506
         LA    RBASE,DEBNMSUB-DEBAPVT   OFFSET TO DEBPREFIX      Y02027 03422006
         LA    R15,0(RWKA)              COPY DEB ADDRESS         Y02027 03422506
         SR    R15,RBASE                DEB PREFIX               Y02027 03423006
         L     R15,CEPTR(,R15)          ADDRESS OF LINE END      Y02027 03423506
         DROP RCCW                                                      03424006
         USING &NAME+FOUR,R15,RBASE                                     03424506
         LA    RBASE,FOUR095(,R15)      SET UP SECOND BASE       Y02027 03425006
         LA    RBASE,ONE(,RBASE)        CLEAR HIGH-ORDER BYTE    Y02027 03425506
         LA    RCCW,LCBCPA              SET CCW ADDR. FOR CLOSE  Y02027 03426006
         B     PERMENT                  GO TO ERP FOR END OF DAY Y02027 03426506
*                                       OBR/SDR RECORDING        Y02027 03427006
         DROP  R15,RBASE                                                03427506
         USING TEMPBASE,RCCW                                            03428006
IOHLT    EQU   *                                                 Y02027 03428506
         SPACE 1                                                        03430006
         MVI   LCBINCAM+1,ZERO           RESET ERP FLAG                 03440006
         MVI   LCBECBCC,X48             SET HIO COMPLETION              03450006
NOIOHLT  EQU   *                                                        03460006
.CONC1   ANOP                                                    S22026 03494022
         MVI   LCBCSW+5,0               CLEAR FIRST BYTE OF CSW         03500020
*                                         INVALID ON PROG CHECK         03520020
*                                         INT ALREADY TRACED    SA65906 03535054
         LA    R14,NOTRACE              SET RETURN ADDRESS       Y02027 03537006
         SR    R15,R15                  CLEAR FOR ICM          @G36XRIV 03540000
         ICM   R15,AD,AVTIOT+1          ADDRESS OF I/O TRACE   @G36XRIV 03560000
         BNZR  R15                      LINK TO IGG019Q0         Y02027 03580000
         DROP  RCCW                     DROP TEMPORARY BASE      X02004 03601005
         USING IEDQCCW,RCCW             SET CCW ADDRESSABILITY   X02004 03602005
NOTRACE  EQU   *                                                        03603005
         LA    RBASE,DEBNMSUB-DEBAPVT   OFFSET TO DEB PREFIX     Y02027 03604006
         LA    R15,0(RWKA)              COPY DEB ADDRESS         Y02027 03604606
         SR    R15,RBASE                DEB PREFIX               Y02027 03605206
         L     R15,CEPTR(,R15)          ADDRESS OF LINEEND       X02004 03606005
         USING &NAME+FOUR,R15,RBASE                                     03607061
         LA    RBASE,FOUR095(,R15)      SET UP SECOND BASE     @ZA02096 03607361
         LA    RBASE,ONE(,RBASE)        CLEAR HIGH-ORDER BYTE  @ZA02096 03607661
         TM    LCBCSW+FOUR,SIX          POSSIBLE ACR           @ZA02096 03607961
         BNZ   ACRCK                    GO CHECK ACR           @ZA03108 03608200
TESTCC3  EQU   *                                               @ZA02096 03608561
         TM    LCBSIOCC,CC3             SIO COND. CODE THREE     Y02027 03609106
         BO    ERPEXT                   YES, EXIT TO ERP         Y02027 03609206
         TM    LCBSIOCC,CC1             SIO COND. CODE ONE       Y02027 03609306
         BNO   NOTCC1                   BRANCH NOT CONDITION 1   Y02027 03609406
SETLCBCS EQU   *                                               @ZA02096 03609561
         ICM   R14,AD,LCBSTART          START OF CHANN PROG    @ZA02096 03609861
         LA    R14,EIGHT(R14)           BUMP BY EIGHT            Y02027 03610161
         STCM  R14,AD,LCBCSW            UPDTE CSW FOR SIOCCC=1   Y02027 03610461
NOTCC1   EQU   *                                                 Y02027 03610761
         L     RSCB,LCBSCBA-1           SCB ADDRESS              X02004 03611061
         TM    SCBQTYPE,SCBCONC         IS THIS A CONCENTRATOR   X02004 03611361
         BNO   NOTCONCA                 BRANCH NO                X02004 03612005
         L     RSCB,LCBSCBDA-1          CONC SCB ADDRESS         X02004 03613005
         OI    SCBQTYPE,SCBCONC         SET CONC FLAG            X02004 03614005
NOTCONCA EQU   *                                                 X02004 03615005
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR         SA65392 03620852
         BE    NOTHRESH                 BR YES, DO NOT UPDATE   SA65392 03621652
*                                         THRESHHOLD COUNTERS   SA65392 03622452
         USING DEBTCBAD,RWKA            DEB ADDRESSIBILITY      SA65392 03623252
         SR    RCCW,RCCW                CLEAR WORK              SA65392 03624052
         LR    RF,RCCW                  REGISTERS               SA65392 03624852
         IC    RCCW,DEBNMEXT            GET NUMBER EXTENTS      SA65392 03625652
         SLL   RCCW,TWO                 SIZE OF UCB ADDRESSES   SA65392 03626452
         L     RCCW,DEBUCBAD(RCCW)      THRESHHOLD AREA         SA65392 03627252
         IC    RF,LCBUCBX               RLN MINUS ONE           SA65392 03628052
         SLL   RF,THREE                 THRESHOLD INDEX        @OZ24288 03628800
         AR    RCCW,RF                  ADD 8 TIMES RLN AND    @OZ27868 03629200
         SRL   RF,1                     ADD HALF AGAIN FOR     @OZ24288 03629600
         AR    RCCW,RF                  ERRMSG SAVE AREA       @OZ24288 03629800
         CLC   ZERO(ONE,RCCW),AVTHRESH  TRANSMISSIONS REACHED   SA65392 03630452
         BNL   INIT                     BR YES, INITIALIZE      SA65392 03631252
         IC    RF,ZERO(RCCW)            INCREMENT               SA65392 03632052
         LA    RF,ONE(RF)               THRESHHOLD              SA65392 03632852
         STC   RF,ZERO(RCCW)            COUNTER                 SA65392 03633652
         B     NOTHRESH                 AND CONTINUE            SA65392 03634452
INIT     EQU   *                                                SA65392 03635252
         MVC   ZERO(FOUR,RCCW),AVTFZERO INITIALIZE COUNTERS     SA65392 03636052
         MVI   ZERO(RCCW),ONE           INITIALIZE TRANS CNT    SA65392 03636852
NOTHRESH EQU   *                                                SA65392 03637652
TSO2     EQU   *                                                    TSO 03640020
          L     RCCW,LCBCSW-1            FAILING CCW+8                  03660020
         LA    RCCW,AVTEZERO(,RCCW)     CLEAR HI ORDER BYTE             03680020
         SH    RCCW,H8                  BACK UP TO INTRPT CCW           03700020
         AIF   ('&GEN' EQ 'MINI').L8A                                   03720020
         AIF   ('&GEN' EQ 'BISC').L8A                                   03740020
* PLEASE NOTE THAT THE FOLLOWING CODE TO SET AND RESET LCBCIRCD WILL    03770020
* WORK FOR A 1050 ONLY SO LONG AS THE RESPONSE TO POLL OR ADDRESSING    03780020
* GENERATES AN INTERRUPT. THE BIT IS USED TO DETERMINE WHETHER OR NOT   03790020
* A WRITE BREAK COMMAND WILL BE EXECUTED AFTER A HALT I/O.              03800020
         L     RWKA,LCBSTART-1          ADDRESS OF START CCW        TSO 03820020
         LA    RWKA,0(RWKA)             CLEAR HIGH ORDER BYTE       TSO 03840020
         LA    RF,LCBCPA-1              IS CCW IN CH PGM AREA   SA56915 03841022
         CR    RWKA,RF                  COMPARE ADDRESS         SA56915 03842022
         BNH   NOT2741                  BR IF RESTART OCCURED   SA56915 03843022
         SR    RF,RF                    CLEAR FOR INSERT CHAR   SA56915 03844022
         L     RA,LCBDCBPT              POINT TO DCB            SA56915 03845022
         USING IHADCB,RA                ADDRESSABILITY          SA56915 03846022
         IC    RF,DCBEIOBX              SIZE OF LCB             SA56915 03847022
         DROP  RA                       ELIMINATE DCB REG       SA56915 03848022
         LA    RF,0(RLCB,RF)            POINT TO END OF LCB     SA56915 03849022
         CR    RWKA,RF                  CCW IN LCB ?            SA56915 03850022
         BH    NOT2741                  BRANCH NO               SA56915 03851022
         CLI   0(RWKA),CCWWRITE         WAS START CCW A WRITE       TSO 03860020
         BNE   NOT2741                  BRANCH ON NO                TSO 03880020
         CR    RCCW,RWKA                IS FIRST CCW THE            TSO 03900020
*                                       INTERRUPT CCW               TSO 03920020
         BNE   NOTINT                   BRANCH ON NO                TSO 03940020
         SR    R0,R0                    CLEAR REGISTER              TSO 03960020
         CH    R0,LCBCSW+5              IS RESIDUAL COUNT ZERO      TSO 03980020
         BE    NOTINT                   BRANCH IF SO              M5953 04000020
         CLI   4(RWKA),X20              IS THIS RESPONSE OWED CCW M5953 04010020
         BNE   NOT2741                  IF NOT, CONTINUE          M5953 04012020
         OI    LCBTSOB,LCBCIRCD         INDICATE IN TEXT MODE     M5953 04014020
         OI    LCBSTAT2,LCBRESP         INDICATE RESPONSE OWED    M5953 04016020
         B     NOT2741                  BRANCH TO CONTINUE        M5953 04018020
NOTINT   EQU   *                                                    TSO 04020020
         L     RWKA,0(RWKA)             DATA ADDRESS FROM CCW       TSO 04040020
         CLI   0(RWKA),CIRCD            WAS FIRST CHAR A CIRCLE-D   TSO 04060020
         BNE   NOTCIRCD                 BRANCH ON NO                TSO 04080020
         OI    LCBTSOB,LCBCIRCD         INDICATE CIRCLE-D SENT      TSO 04100020
         B     NOT2741                                              TSO 04120020
NOTCIRCD EQU   *                                                    TSO 04140020
         CLI   0(RWKA),CIRCC            WAS FIRST CHAR CIRCLE-C     TSO 04160020
         BNE   NOT2741                  BRANCH ON NO                TSO 04180020
         NI    LCBTSOB,X'FF'-LCBCIRCD   INDICATE CIRCLE-C SENT      TSO 04200020
NOT2741  EQU   *                                                    TSO 04220020
         CLI   LCBTPCD+11,X'AC'         OPEN LINE CHECK?            TSO 04240020
         BE    OPCHK                    YES. GO PUT UP PREPARE      TOS 04260020
.L8A     ANOP                                                           04280020
         CLI   LCBECBCC,X48 .           HIO INTERRUPT               TSO 04300020
         BNE   TSO8 .                   BRANCH NO                   TSO 04320020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L8                04340020
         AIF   ('&GEN' EQ 'QTAM').L8                                    04360020
         TM    LCBTSOB,LCBPREP          IS PREPARE ON LINE          TSO 04380020
         BO    RTPREP                   BRANCH ON YES               TSO 04400020
         TM    LCBTSOB,LCBWRBRK         WAS A BREAK REQUESTED?      TSO 04420020
         BNZ   CHKBRK                   CHECK IF BREAK                  04440020
         SPACE                                                          04460020
.L8      ANOP                                                           04480020
CHKMSGEN EQU   *                                                        04500020
         TM    LCBSTAT2,LCBMSGNN        MSGGEN                          04520020
         BO    ERBPOST                  BRANCH IF YES                   04540020
         CLI   LCBTPCD,TPOPEN .         INITIALIZATION SEQUENCE         04580020
         BE    EROPEN                   BRANCH YES              SA62408 04600005
         L     RCCW,LCBLSPCI-1          FREE ALL BUFFERS UP TO HERE     04640020
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY                    04660020
         TM    LCBSTAT1,LCBRECVN        RECEVIE STATE                   04680020
         BZ    ADDERR                   NO, IT'S ON SEND SIDE           04700020
         MVC   PRFSIZE-IEDQPRF(2,RCCW),PRFEOB-IEDQPRF(RCCW)    @SA75471 04740000
         TM    PRFSTAT1-IEDQPRF(RCCW),PRFNHDRN HEADER                   04880020
         BO    POSTALL                  NO, FREE UP PREVIOUS BFR A56906 04900022
*                                               TO ZERO IF HDR  SA64676 04904051
         TM    LCBERBST,LCBDLNKN        IS ERB AVAILABLE (NO PCI)A56906 04906022
         BO    CLEANUP                  YES, POST LCB TO BD             04912022
         B     POSTALL                  FREE UP PREVIOUS BUFFERS        04920020
         SPACE 1                                                 X02004 04926005
LCBSIZE  DC    AL2(LCBFLAG1-IEDQLCB)    LCB PRIOR TO IOB         X02004 04932005
ACRCK    EQU   *                                               @ZA03108 04933000
         L     R14,LCBSTART-1           START OF CCWS          @ZA03108 04933500
         LA    R14,EIGHT(R14)           BUMP TO END OF FIRST   @ZA03108 04934000
         STCM  R14,AD,LCBCSW            SET NEW CCW ADDR IN CSW@ZA03108 04935000
         B     TESTCC3                  NO, TEST FOUND CODE    @ZA02096 04937061
         SPACE                                                          04940020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L8B               04960020
         AIF   ('&GEN' EQ 'QTAM').L8B                                   04980020
CHKBRK   EQU   *                                                        05000020
         MVI   LCBCPA,CCWBREAK .        BREAK COMMAND               TSO 05020020
         LA    RA,THREE                                             TSO 05040020
         ST    RA,LCBCPA+4 .            LENGTH FOR BREAK            TSO 05060020
         MVI   LCBTPCD,X12 .            TP OP CODE                  TSO 05080020
         LA    RA,LCBCPA .              START ADDR FOR IOS          TSO 05100020
         ST    RA,LCBSTART-1            MOVE IN START ADDRESS       TSO 05120020
         MVC   LCBCSWSV(7),LCBCSW .     SAVE ENDING STATUS          TSO 05140020
         MVI   LCBECBCC,X'7F'           RESET COMPLETION CODE       TSO 05160020
         TM    LCBTSOB,LCBCIRCD         IS TERMINAL IN TEXT MODE    TSO 05180020
         BO    RTWRBRK                  BRANCH IF YES, DONT WR BRK  TSO 05200020
         B     RESTART                  BRANCH TO ISSUE BREAK       TSO 05220020
.L8B     ANOP                                                           05240020
TSO8     EQU   *                                                    TSO 05260020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L8C               05280020
         AIF   ('&GEN' EQ 'QTAM').L8C                                   05300020
         CLI   LCBTPCD+11,X'BE'         IS SMI/WCC FLAG SET   S22028TSO 05305022
         BE    CHK3270R                 YES, BRANCH           S22028TSO 05310022
TSO8A    EQU   *                                              S22028TSO 05315022
         CLI   LCBTPCD+10,X'AE'         5041 CHECK?                 TSO 05320020
         BE    GODYNC                                               TSO 05340020
.L8C     ANOP                                                           05360020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE?            S99228 05400722
         BNE   CEDETOG                  BRANCH NO                S99228 05400822
         ICM   RA,AD,LCBCSW             INTERRUPT ADDR = 0       Y01948 05401205
         BNZ   CEDETOG                  BRANCH NO                S99228 05401522
         L     RA,LCBSTART-ONE          LOAD START ADDRESS       S99228 05402122
         CLI   LCBECBCC,PERMERR         PREMANENT ERROR ?       OY03460 05402205
         BE    INTERSET                 YES, BRANCH             OY03460 05402305
         CLI   ZERO(RA),CCWEAU          3270 EAU COMMAND?        S99228 05402422
         BNE   MAYBESEL                 BRANCH NO                S99228 05402822
         LA    RA,LCBCPA+16             LOAD ADDR EAU CCW        S99228 05403522
         B     INTERSET                 SET INTERRUPT ADDRESS    S99228 05404222
MAYBESEL EQU   *                                                 S99228 05404922
         CLI   ZERO(RA),CCWSEL          3270 SELECT CHANNEL PGM? S99228 05405622
         BNE   MAYBEGEN                 BRANCH NO                S99228 05406322
         L     RA,LCBLSPCI-ONE          LOAD BUFFER ADDRESS      S99228 05409822
         B     BEGIN                    ENTER LOOP               S99228 05410522
MAYBEGEN EQU   *                                                 S99228 05410622
         LA    RA,LCBCPA                LOAD ADDR MSGGEN CCW     S99228 05410722
         B     INTERSET                 SET INTERRUPT ADDRESS    S99228 05410822
NEWCCW   EQU   *                                                 S99228 05411222
         L     RA,EIGHT(R0,RA)          LOAD TIC CCW             S99228 05411922
BEGIN    EQU   *                                                 S99228 05412622
         CLI   TICEND(RA),TWO           END OF CHANNEL PROGRAM?  S99228 05413322
         BNE   NEWCCW                   BRANCH NO                S99228 05414022
INTERSET EQU   *                                                 S99228 05414722
         LR    RCCW,RA                  SET INTERRUPT ADDRESS    S99228 05415422
         LA    RCCW,ZERO(,RCCW)                                 OY03460 05415705
         LA    RA,EIGHT(R0,RA)          INCREASE ADDR FOR CSW    S99228 05416122
         STCM  RA,AD,LCBCSW             SET INTERRUPT ADDRESS    Y01948 05416805
CEDETOG  EQU   *                                                 S99228 05418922
         CLI   LCBECBCC,PERMERR         PREMANENT ERROR ?       OY03460 05419205
         BE    PERMENT                  YES, BRANCH             OY03460 05419505
         TM    LCBCSW+4,X'20'           CHAN PROG CHECK                 05420020
         BZ    NOPC                     NO                              05440020
         TM    CCWOPCDE,SEVEN           IS OP CODE A TIC         X01004 05480005
         BZ    ITSPC                    YES                      X01004 05490005
         CLI   CCWCOUNT+1,AVTEZERO .    ZERO COUNT CCW           S22025 05515022
         BNE   ERP .                    BRANCH IF NO             S22025 05518022
         TM    CCWFLAGS,CCWCD+CCWCC .   ANY CHAINING FLAGS       S22025 05524022
         BZ    NOPC .                   NO, NORMAL END OF MSG    S22025 05527022
         B     ERP .                    LET ERP PROCESS          S22025 05533022
ITSPC    EQU   * .                                               S22025 05536022
         TM    CCWADDR+2,X'01'          BUFFER BEING ASSIGNED           05540020
         BZ    NOTASGN                  NO                              05560020
ASGN     EQU   *                                                        05600020
         NI    CCWADDR+2,AVTEFF-X'01'   CLAR BIT                        05620020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE             X03963 05622005
         BNE   NEXTBUF                  BR NO, GET NEXT BUFFER   X03963 05624005
         L     RA,AVTSAVEX+REG7         UCB ADDRESS              X03963 05626005
         CLI   TTY4(RA),LCL3277         3270 LOCAL               X03963 05628005
         BL    NEXTBUF                  BR NO, GET NEXT BUFFER   X03963 05630005
         LA    RCCW,LCBCPA+16           RESTART ON SELECT COM    X03963 05632005
         B     EXIT3                    TO RESTART               X03963 05634005
NEXTBUF  EQU   *                                                 X03963 05636005
         L     RCCW,CCWADDR-1           GET NEXT BUFFER                 05640020
         B     EXIT3                    RESTART ON NEXT BUFFER          05660020
NOTASGN  EQU   *                                                        05680020
         TM    CCWADDR+2,X'02'          VALID PROGRAM CHECK             05700020
         BZ    ASGN                     NO                              05720020
         TM    SCBERR1,SCBCUTFN         CUT OFF EXECUTED                05760020
         BNZ   RTOPCUT                  POST LCB TO CUTOFF       A67139 05780054
         OI    SCBERR1,SCBNOBFN .       SET INSUFFICINET BUFFERS S21101 05790020
         TM    LCBCSW+3,X'02'           UNIT CHECK ALSO                 05800020
         BO    ERP                      BRANCH IFYES TO CLEAR ERROR     05820020
         B     TEXT                     POST PREVIOUS BUFFERS           05860020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L8D               05860322
         AIF   ('&GEN' EQ 'QTAM').L8D                                   05860622
CHK3270R EQU   *                                              S22028TSO 05861022
         LH    RC,LCBTTCIN              TERMINAL OFFSET       S22028TSO 05862022
         L     RA,AVTRNMPT              TNT CODE BASE         S22028TSO 05863022
         USING IEDQTNTD,RA                                    S22028TSO 05864022
         BAL   RPREFIX,TNTDCODE         FIND TERMINAL TYPE    S22028TSO 05865022
         DROP  RA                                             S22028TSO 05866022
         USING IEDQTRM,RB                                     S22028TSO 05867022
         L     RB,TRMDESTQ-1            GET QCB ADDRESS       S22028TSO 05868022
         DROP  RB                                             S22028TSO 05869022
         TM    QCBTSOF2-IEDQQCB(RB),QCBDSSMI HAS WCC BEEN SENTS22028TSO 05870022
         BO    SKIPUE                   BRANCH NOT SENT         SA61779 05871005
         B     TSO8A                    BRANCH NOT SENT       S22028TSO 05872022
.L8D     ANOP                                                           05876022
PCSTART  EQU   *                                                        05880020
         NI    SCBERR1,AVTEFF-SCBNOBFN  RESET INSUFF BFRS ERROR@OS77837 05890091
         MVI   LCBCPA+12,X'20'         FLAG TO ASSIGN BUFFERS FROM      05900020
         LA    RCCW,LCBCPA              FOR TIC                         05920020
         ST    RCCW,LCBCPA+8            SET IN TIC ADDRESS              05940020
         MVI   LCBCPA+8,CCWTIC          SET COMMAND CODE                05960020
         B     EXIT3                    RESTART ON NEXT BUFFER          05980020
*                                         IDLES OR SKIP LOOP            06000020
NOPC     EQU   *                                                        06020020
         TM    LCBCSW+4,X'1F'           SEVERE CHANNEL ERRORS           06040020
         BNZ   ERP                      YES                             06060020
         TM    LCBCSW+3,X'D2'           DEVICE ERROR            SA59028 06100022
         AIF   ('&GEN' EQ '').LI2                                       06120020
         AIF   ('&GEN' EQ 'STSP').LI2                                   06140020
         AIF   ('&GEN' EQ 'QTAM').LI2                                   06150022
         BNZ   ERP                                                      06160020
         AGO   .L10                                                     06180020
.LI2     ANOP                                                           06200020
         BZ    NOUC                     BRANCH NO UNIT CHECK            06220020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE?            S99228 06240022
         BE    ERPEXIT                  RETURN TO IOS FOR ERP   SA59027 06260022
         L     RA,TSOCHKAD                                              06280020
         BR    RA                                                       06300020
NOUC     EQU   *                                                        06320020
.L10     ANOP                                                           06340020
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION                  06380020
         BZ    PERMENT                  NO                              06400020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L10A      SA51090 06403022
         L     RC,AVTSAVEX+UCBOFFST     UCB ADDRESS FROM SAVE    X02004 06406005
         CLI   UNITYPE(RC),AVTEZERO     IS THIS AUDIO           SA51090 06409022
         BE    ERP                      IF SO, TRY ERP          SA51090 06412022
.L10A    ANOP                                                   SA51090 06415022
         CLI   CCWOPCDE,CCWREAD         READ COMMCAN                    06420020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L11               06440020
         AIF   ('&GEN' EQ 'QTAM').L11                                   06460020
         BE    PERMENT                  YES, NORMAL                     06480020
         CLI   CCWOPCDE,CCWINHIB        INHIBIT                         06520020
.L11     ANOP                                                           06540020
         BNE   ERP                      NO, NOT NORMAL                  06560020
         EJECT                                                          06580020
*                                                                       06600020
*        THE TP OP CODE FOR THE INTERRUPTED CCW IS OBTAINED BY          06620020
* USING THE ADDRESS IN THE CSW AS AN INDEX ARGUMENT INTO A LIST OF      06640020
* TP OP CODES (LCBTPCD).  AN ENEN VALUED TP OP CODE REPRESENTS A TEXT   06660020
* OR NON-TEXT RELATED CCW FOR WHICH AN INTERRUPT IS ANTICIPATED.  AN    06680020
* EVEN VALUED TP OP CODE IS USED AS AN INDEX INTO A BRANCH TABLE        06700020
* IN ORDER TO TAKE SPECIFIC ACTION FOR THIS INTERRUPT.  TWO TABLES      06720020
* ARE EMPLOYED:  ONE FOR NORMAL ENDING STATUS AND THE OTHER FOR         06740020
* ERROR CONDITIONS (SET BY ERP).                                        06760020
*        IF THE TP OP CODE HAS AN ODD VALUE, TESTS ARE MADE TO          06780020
* DETERMINE IF IT IS A TEXT OR NON-TEXT RELATED CCW.                    06800020
*                                                                       06820020
PERMENT  EQU   *                                                        06840020
         LA    RC,LCBCPA                START OF CHAN PROG AREA         06880020
         SR    RC,RCCW                  DIFFERENCE BETWEEN TWO          06900020
         BP    TEXT                     BRANCH IF TEXT                  06920020
         SR    RB,RB                    CLEAR WORK REGISTER             06960020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 06980020
         USING IHADCB,RA                                                07000020
         IC    RB,DCBEIOBX              SIZE OF LCB                     07020020
         DROP  RA                                                       07040020
         LA    RB,AVTEZERO(RLCB,RB)     POINT TO END OF LCB             07060020
         SR    RB,RCCW                  CCW IN CHAN PROG AREA           07080020
         BNP   TEXT                     BRANCH IF TEXT                  07100020
         LPR   RC,RC                    MAKE DIFFERENCE POSITIVE        07140020
         SRL   RC,THREE                 DIVIDE BY 8                     07160020
         IC    RC,LCBTPCD(RC)           GET TP OP CODE FOR BRANCG       07180020
         STC   RC,AVTDOUBX              SAVE TP OP CODE                 07200020
         TM    AVTDOUBX,X01             NON EXPECTED INTERRUPT          07220020
         BO    TRYTXTER                 BRANCH YES                      07240020
         LH    RB,TABLE(RC)             OFFSET INTO TABLE               07260020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 07280020
         BNE   TABLE1(RB)               BRANCH NO                       07300020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L8E               07321022
         AIF   ('&GEN' EQ 'QTAM').L8E                                   07322022
         CLI   LCBTPCD+11,X'BE'         IS SMI/WCC FLAG ON    S22028TSO 07323022
         BNE   PERMENT1                 NO, BRANCH            S22028TSO 07326022
         MVI   LCBTPCD+11,X'00'         CLEAR SMI/WCC FLAG    S22028TSO 07329022
PERMENT1 EQU   *                                              S22028TSO 07332022
.L8E     ANOP                                                           07337022
         LH    RB,ERRTABLE(RC)          ENTRY INTO ERROR TABLE          07340020
         B     ERRTABLE(RB)             BRANCH TO ENTRY                 07360020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').LC1               07400020
         AIF   ('&GEN' EQ 'QTAM').LC1                                   07420020
GODYNC   EQU   *                                                        07440020
         L     RF,DYNCAD                                            TSO 07460020
         BR    RF                                                   TSO 07480020
.LC1     ANOP                                                           07520020
TABLE    EQU   *                                                        07540020
         DC    AL2(RTERROR-TABLE1)      ERROR ENTRY                     07560020
         DC    AL2(RTOPEN-TABLE1)       OPEN AND START LINE             07580020
         DC    AL2(RTPOLL-TABLE1)       READ RESPONSE TO POLL           07600020
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'BISC').L12               07620020
         DC    AL2(RTENAB-TABLE1)       ENABLE ON DIAL                  07640020
         AGO   .L13                                                     07660020
.L12     DC    AL2(RTERROR-TABLE1)                                      07680020
.L13     ANOP                                                           07700020
         DC    AL2(RTRSPADD-TABLE1)     RESPONSE TO ADDRESSING          07720020
         DC    AL2(RTRSPEB-TABLE1)      READ RESPONS TO EOB             07740020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L14               07760020
         AIF   ('&GEN' EQ 'QTAM').L14                                   07780020
         DC    AL2(RTRDENQ-TABLE1)      READ ENQ                        07800020
         DC    AL2(RTRSPENQ-TABLE1)     READ RESPONSE TO ENQ            07820020
         AGO   .L15                                                     07840020
.L14     DC    AL2(RTERROR-TABLE1)                                      07860020
         DC    AL2(RTERROR-TABLE1)                                      07880020
.L15     AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L16               07900020
         AIF   ('&GEN' EQ 'QTAM').L16                                   07920020
         DC    AL2(RTPREP-TABLE1)       PREPARE                     TSO 07940020
         DC    AL2(RTWRBRK-TABLE1)      WRITE BREAK                 TSO 07960020
         AGO   .L17                                                     07980020
.L16     ANOP                                                           08000020
         DC    AL2(RTERROR-TABLE1)                                      08020020
         DC    AL2(RTERROR-TABLE1)                                      08040020
.L17     AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L18               08060020
         AIF   ('&GEN' EQ 'QTAM').L18                                   08080020
         DC    AL2(RDLCOUT-TABLE1)      RD STX,/DLE STX                 08100020
         AGO   .L19                                                     08120020
.L18     ANOP                                                           08140020
         DC    AL2(RTERROR-TABLE1)                                      08160020
.L19     ANOP                                                           08180020
         DC    AL2(RTWRRSP-TABLE1)      WRITE RESPONSE OFFSET           08200020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L20               08220020
         AIF   ('&GEN' EQ 'QTAM').L20                                   08240020
         DC    AL2(RTIDENQ-TABLE1)      READ ID ENQ                     08260020
         DC    AL2(RTIDACK-TABLE1)      READ ID ACK                     08280020
         AGO   .L21                                                     08300020
.L20     ANOP                                                           08320020
         DC    AL2(RTERROR-TABLE1)                                      08340020
         DC    AL2(RTERROR-TABLE1)                                      08360020
.L21     ANOP                                                           08380020
         DC    AL2(RTTXTRST-TABLE1)     TEXT ABORT                      08400020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ '').L22                   08420020
         AIF   ('&GEN' EQ 'QTAM').L22                                   08440020
         DC    AL2(RTERROR-TABLE1)                                      08460020
         AGO   .L23                                                     08480020
.L22     ANOP                                                           08500020
         DC    AL2(RTTWXID-TABLE1)      READ TWX ID                     08520020
.L23     ANOP                                                           08540020
         DC    AL2(RTBUFEOT-TABLE1)     RESET LINE AFTER A BLOCK        08560020
         DC    AL2(RTCLOSE-TABLE1)      CLOSE ENTRY                     08580020
         DC    AL2(RTRSPAD-TABLE1)      RESET AFTER UNUSUAL RESP        08600020
*                                         TO ADDRESSING OR ENQ          08620020
         DC    AL2(RTEAU-TABLE1)        ERASE ALL UNPROTECTED  @OY14057 08621091
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ '').TS96          SA48276 08622022
         DC    AL2(RTERROR-TABLE1)                              SA48276 08624022
         AGO   .TS97                                            SA48276 08626022
.TS96    ANOP                                                   SA48276 08628022
         DC    AL2(RTRSPMG-TABLE1)      2260 RESP TO MSGGEN    @OY14057 08630091
.TS97    ANOP                                                  @OY14057 08633091
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ '').TS97A        @OY14057 08636091
         DC    AL2(RTERROR-TABLE1)                             @OY14057 08639091
         AGO   .TS97B                                          @OY14057 08642091
.TS97A   ANOP                                                  @OY14057 08645091
         DC    AL2(RTRS3270-TABLE1)     3270 FORMAT ERR RECOVRY@OY14057 08648091
.TS97B   ANOP                                                  @OY14057 08651091
ERRTABLE EQU   *                                                        08660020
         DC    AL2(ERERROR-ERRTABLE)                                    08680020
         DC    AL2(EROPEN-ERRTABLE)                                     08700020
         DC    AL2(ERPOLL-ERRTABLE)                                     08720020
         AIF   ('&GEN' EQ 'MINI').L24                                   08740020
         DC    AL2(ERENAB-ERRTABLE)                                     08760020
         AGO   .L25                                                     08780020
.L24     ANOP                                                           08800020
         DC    AL2(ERERROR-ERRTABLE)                                    08820020
.L25     ANOP                                                           08840020
         DC    AL2(ERRSPAD-ERRTABLE)                                    08860020
         DC    AL2(ERRSPEB-ERRTABLE)                                    08880020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L26               08900020
         AIF   ('&GEN' EQ 'QTAM').L26                                   08920020
         DC    AL2(ERRDENQ-ERRTABLE)                                    08940020
         DC    AL2(ERRSPENQ-ERRTABLE)                                   08960020
         AGO   .L27                                                     08980020
.L26     ANOP                                                           09000020
         DC    AL2(ERERROR-ERRTABLE)                                    09020020
         DC    AL2(ERERROR-ERRTABLE)                                    09040020
.L27     AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L27A              09060020
         AIF   ('&GEN' EQ 'QTAM').L27A                                  09080020
         DC    AL2(RTPREP-ERRTABLE)                                     09100020
         DC    AL2(ERERROR-ERRTABLE)                                    09120020
         AGO   .L27B                                                    09140020
.L27A    ANOP                                                           09160020
         DC    AL2(ERERROR-ERRTABLE)                                    09180020
         DC    AL2(ERERROR-ERRTABLE)                                    09200020
.L27B    ANOP                                                           09220020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L28               09240020
         AIF   ('&GEN' EQ 'QTAM').L28                                   09260020
         DC    AL2(ERLCOUT-ERRTABLE)                                    09280020
         AGO   .L29                                                     09300020
.L28     ANOP                                                           09320020
         DC    AL2(ERERROR-ERRTABLE)                                    09340020
.L29     ANOP                                                           09360020
         DC    AL2(ERWRRSP-ERRTABLE)                                    09380020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').LA                09400020
         AIF   ('&GEN' EQ 'QTAM').LA                                    09420020
         DC    AL2(ERIDENQ-ERRTABLE)    READ ID ENQ                     09440020
         DC    AL2(ERIDACK-ERRTABLE)                                    09460020
         AGO   .LB                                                      09480020
.LA      ANOP                                                           09500020
         DC    AL2(ERERROR-ERRTABLE)                                    09520020
         DC    AL2(ERERROR-ERRTABLE)                                    09540020
.LB      ANOP                                                           09560020
         DC    AL2(ERTXTRST-ERRTABLE)   TEXT ABORT                      09580020
         AIF   ('&GEN' EQ 'MINI').L30                                   09600020
         DC    AL2(ERTWXID-ERRTABLE)    ERRROR ON TWX ID                09620020
         AGO   .L31                                                     09640020
.L30     ANOP                                                           09660020
         DC    AL2(ERERROR-ERRTABLE)                                    09680020
.L31     ANOP                                                           09700020
         DC    AL2(ERBUFEOT-ERRTABLE)   RESET LINE AFTER BLOCK          09720020
         DC    AL2(ERCLOSE-ERRTABLE)    ERP RETURN AFTER OBR            09740020
         DC    AL2(ERRSPAD-ERRTABLE)                            SA59028 09750022
         DC    AL2(ERERROR-ERRTABLE)    EAU ERROR               SA59028 09760022
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ '').TS98          SA48276 09762022
         DC    AL2(ERERROR-ERRTABLE)                            SA48276 09764022
         AGO   .TS99                                            SA48276 09766022
.TS98    ANOP                                                   SA48276 09768022
         DC    AL2(ERRSPMG-ERRTABLE)                            SA48276 09770022
.TS99    ANOP                                                   SA48276 09772022
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ '').TS99A        @OY14057 09773091
         DC    AL2(ERERROR-ERRTABLE)    3270 FORMAT ERR RECOVRY@OY14057 09774091
         AGO   .TS99B                                          @OY14057 09775091
.TS99A   ANOP                                                  @OY14057 09776091
         DC    AL2(ERRS3270-ERRTABLE)   3270 FORMAT ERROR      @OY14057 09777091
.TS99B   ANOP                                                  @OY14057 09778091
         EJECT                                                          09780020
*                                                                       09800020
*        INTERRUPTS ON CCW'S WITH ODD VALUED TP OP CODES ARE            09820020
* HANDLED HERE.                                                         09840020
*                                                                       09860020
TRYTXTER EQU   *                                                        09880020
         CLI   AVTDOUBX,TPRDSKIP        PRIOR TO TEXT                   09900020
         BL    ERERROR                  BRANCH IF YES                   09920020
         BH    TRYIDLES                 NOT READ SKIP                   09960020
         L     RCCW,LCBCPA+12           CCW BEFORE TIC PROGRAM CHECK    09980020
ITSSYNC  EQU   *                                                        10000020
         OI    LCBCSW+3,UNEX            INDICATE END OF MSG             10020020
         MVI   LCBCSW+6,0               RESIDUAL COUNT 0                10040020
         MVI   LCBECBCC,PERMERR         INDICATE ERROR                  10060020
         B     TEXT                     PROCESS BUFFERS                 10080020
TRYIDLES EQU   *                                                        10100020
         CLI   AVTDOUBX,TPWRIDLE        ERROR ON WRITE IDLES            10120020
         BNE   CKSNDRCV                 NO, CHECK TYPE OF OPERATION     10140020
GOIDLES  EQU   *                                                        10160020
         TM    LCBSENS0,IR              INTERVENTION REQUIRED   OY00507 10162005
         BNO   NOIR                     BR NO, CONTINUE         OY00507 10164005
         LA    RCCW,LCBCPA              WRITE IDLES, TIC LOOP   OY00507 10166005
         CLM   RCCW,AD,LCBCPA+NINE      WRITE IDLES LOOP INTACT OY00507 10168005
         BNE   NOIR                     BR NO, CONTINUE         OY00507 10170005
         MVI   LCBINCAM,AVTEFF          SET EXCP INDICATOR FOR  OY00507 10172005
*                                         RESTART BY IEDQGA     OY00507 10174005
         B     FREERQE                  GO FREE RQE, RETURN     OY00507 10176005
NOIR     EQU   *                                                OY00507 10178005
         MVI   LCBINCAM,0               RESET RETRY COUNT               10180020
         L     RCCW,LCBCPA+8            RESTART TO ET A BUFFER          10200020
         B     EXIT3                    EXIT                            10220020
CKSNDRCV EQU   *                                                        10260020
         TM    LCBSTAT1,LCBRECVN        RECEIVE OPERATION               10280020
         BO    ERWRRSP                  BRANCH IF YES                   10300020
         B     ERRSPEB                  POST FORSEND ERROR              10320020
TABLE1   EQU   *                                                        10340020
RTERROR  EQU   *                                                        10360020
         AIF   ('&GEN' EQ 'MINI').M2                                    10380020
         CLI   CCWOPCDE,CCWNOP          AUTOPOLL-TIC'S AFTER POLL'S     10400020
         BNE   NOTNOP                   NO                              10420020
         BAL   RD,POLLEXIT              FOR EXIT FORCE END OF LIST      10440020
         DC    X'FEFE' .               FORCED END OF LIST       SA51791 10460022
NOTNOP   EQU   *                                                        10480020
         AIF   ('&GEN' NE '' AND '&GEN' NE 'BISC').NT3670        S22027 10483022
         NC    LCBTTCIN,LCBTTCIN        IS DESTINATION DETERMINEDS22027 10484022
         BZ    NT367A                   BRANCH IF NO             S22027 10485022
         BAL   RD,DCTBASE .             GET BASE ADDR OF DCT     S22027 10486022
         TM    TWO(RA),CBRDCAST .       BROADCAST TERMINAL       S22027 10489022
         BO    ERBPOST .                BRANCH IF YES            S22027 10492022
NT367A   EQU   *                                                 S22027 10493022
.NT3670  ANOP                                                    S22027 10495022
         AIF   ('&GEN' EQ '').Z1                                        10500020
         AIF   ('&GEN' NE 'BISC').M2                                    10520020
         B     RDRSP                    PUT UP READ RESPONSE            10540020
         AGO   .M2                                                      10560020
.Z1      ANOP                                                           10580020
         TM    LCBSTAT2,LCBSYNC         BSC                             10600020
         BNZ   RDRSP                    BRANCH IF YES-READ RESP         10620020
.M2      ANOP                                                           10640020
ERBPOST  EQU   *                                                        10660020
         NI    LCBSTAT2,AVTEFF-LCBRESP  RESET RESPONSE OWED BIT MH      10666020
*                                        DOES NOT RESET IT ON MSGGEN    10672020
         ICM   RD,THREE,LCBTTCIN        IS DESTINATION DETERMND  Y01948 10720305
         BZ    NT367AA                  BRANCH IF NO             S22027 10720622
         AIF   ('&GEN' NE 'MINI').NTMINI                       @OX17153 10721000
         LH    RC,LCBTTCIN              TERMINAL OFFSET        @OX17153 10721100
         L     RA,AVTRNMPT              TNT CODE BASE          @OX17153 10721200
         USING IEDQTNTD,RA                                     @OX17153 10721300
         BAL   RPREFIX,TNTDCODE         FIND TERMINAL TYPE     @OX17153 10721400
         AGO   .NTMIN2                                         @OX17153 10721900
.NTMINI  ANOP                                                  @OX17153 10722000
         BAL   RD,DCTBASE               GET BASE ADDR OF DCT     S22027 10722100
.NTMIN2  ANOP                                                  @OX17153 10722200
         USING IEDQTRM,RB                                      @OX17153 10722300
         L     RB,TRMDESTQ-1            GET QCB ADDRESS        @OX17153 10722900
         USING IEDQQCB,RB                                      @OX17153 10723000
         NI    QCBELCHN+2,AVTEFF-QCBCNTEN RESET FLG ON MSGGEN  @OX17153 10723100
*                                         SO SCHEDULER WILL NOT@OX17153 10723200
*                                         ADJUST STCB CHAIN    @OX17153 10723300
         DROP  RB                                              @OX17153 10723400
NT367AA  EQU   *                                                 S22027 10723500
.NT3670A ANOP                                                    S22027 10723600
         LA    RPREFIX,LCBERB .         POST ERB TO DISP         S22027 10723900
         MVI   PRFPRI,PRIRCQCB          POST PRIORITY            S22027 10724022
         ICM   RF,THREE,LCBTTCIN        IS DEST DETERMINED       Y01948 10724305
         BZ    CKTSOPST                 BRANCH IF NO             S22027 10724622
         AIF   ('&GEN' NE '' AND '&GEN' NE 'BISC').NT3670B       S22027 10725022
         TM    TWO(RA),CBRDCAST .       IS POST TO CB SCHED REQ  S22027 10726022
         BZ    CKTSOPST .               BRANCH IF NO             S22027 10727022
         L     RF,AVTCMBSS .            CB SEND SCHED            S22027 10728022
         BCTR  RF,0 .                   DECR FOR QCB ADDR        S22027 10729022
         BCTR  RF,0 .                   DECR FOR QCB ADDR        S22027 10730022
         B     POSTEXIT .               EXIT                     S22027 10731022
.NT3670B ANOP                                                           10731522
CKTSOPST EQU   *                                                 S22027 10732022
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').Z11A              10740020
         AIF   ('&GEN' EQ 'QTAM').Z11A                                  10760020
         TM    LCBTSOB,LCBSATRD         IS POST TO AYM REQUESTED?   TSO 10780020
         BZ    DISP                     BRANCH ON NO                TSO 10800020
         L     RF,AVTTSOPT              ADDRESS OF TSO AREA         TSO 10820020
         L     RF,TSIMSGEN-IEDQTSI(,RF) ADDRESS OF AYM              TSO 10840020
         B     POSTEXIT                                                 10860020
         AGO   .Z11B                                                    10880020
.Z11A    ANOP                                                           10900020
         B     DISP                     POST TO DISPOSTION              10920020
.Z11B    ANOP                                                           10940020
*                                                                       10980020
*        THE LCB WILL BE POSTED TO THE QCB POINTED TO BY LCBQCBA        11000020
*                                                                       11020020
EROPEN   EQU   *                                                        11040020
RTOPEN   EQU   *                                                        11060020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L32               11062054
         TM    LCBTSOB,LCB2741N         2741?                       TSO 11064054
         BZ    NONO                     NOT 2741                        11066054
         MVI   LCBTPCD+11,X'AB'         INDICATE FIRST TIME FOR 2741TSO 11068054
NONO     EQU   *                                                        11070054
.L32     ANOP                                                           11072054
RTOPCUT  EQU   *                                                 A67139 11074054
         LA    RLCB,AVTEZERO(,RLCB)     CLEAR HI ORDER BYTE FOR COM     11080020
         MVI   LCBTPCD,AVTEZERO         CLEAR OPEN INDICATOR            11100020
         NI   LCBCHAIN,X'FF'-LCBERMSG   RESET ERR MSG PENDING  @OY11520 11180091
         L     RF,LCBRCB                POST ADDRESS SET BY OPEN        11260020
          TM     LCBSTAT1,LCBRECVN+LCBSENDN+LCBOCNI            @SA70316 11340061
*                                 TEST STATUS OF LCB           @SA70316 11390061
         BZ    FREERQE                  FALL THROUGH IF OP CONTRL       11440020
*                                         HAS STOP REQUEST ON LINE      11460020
*                                         ELSE EXIT-LINE IS STOPPED     11480020
         MVI   LCBPRI,PRILNFRE          POST PRIORITY                   11520020
         LA    RF,AVTEZERO(,RF)         CLEAR HIGH BYTE         SA66616 11524054
         CR    RLCB,RF                  POST LCB TO ITSELF      SA66616 11528054
         BNE   POSTQ                    BRANCH IF NO            SA66616 11532054
         NI    LCBSTAT1,AVTEFF-LCBSENDN SET NOT SENDING         SA66616 11536054
POSTQ    EQU   *                                                        11540020
         LR    RPREFIX,RLCB             PARAMETER TO ENQUEUE            11560020
POSTEXIT EQU   *                                                        11580020
         BAL   RC,ENQUEUE               PUT ON READYBQUEUE              11600020
         B     FREERQE                  SKIP POST                       11620020
*                                                                       11660020
*        READ RESPONSE TO INVITATION                                    11680020
*                                                                       11700020
ERRDENQ  EQU   *                                                        11720020
ERENAB   EQU   *                                                        11740020
ERPOLL   EQU   *                                                        11760020
RTPOLL   EQU   *                                                        11780020
         MVI   LCBTSTSW,XF0             RESET FOR 2260L         SA61780 11781005
RTPOLL1  EQU   *                                               @SA74852 11781500
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'QTAM').LL44       S99228 11782022
         L     RF,LOOKAD                LOAD ADDR DVCCSTCS LOCRTNS99228 11783022
         BALR  RD,RF                    BRANCH TO DVCCSTCS LOCRTNS99228 11784022
         ST    RE,AVTDOUBX+FOUR         SAVE INVLIST CWORD ADDR  S99228 11785022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 11786022
         TM    LCBDCT1,CUMASK           GENERAL POLL IN PROGRESS?S99228 11787022
         BZ    ITERATE                  NO, LCBSTART SET         S99228 11788022
         L     RE,AVTDOUBX+FOUR         LOAD INVLIST CWORD ADDR  S99228 11789022
         OI    LCBMSGFM,LCBACKI         SET ACK-0 FOR READ INIT  S99228 11790022
         LA    RA,LCBCPA+ONESIX         LOAD CHL PGM START ADDR  S99228 11792022
         ST    RA,LCBSTART-ONE          SET LCBSTART AT CHL PGM  S99228 11794022
         TM    THREE(RE),AUTOPL         AUTOPOLL IN PROGRESS?    S99228 11796022
         BZ    ITERATE                  NO, SKIP INVPTR UPDATE   S99228 11798022
         SR    RC,RC                    CLEAR WORK REGISTER      S99228 11800022
         IC    RC,TWO(R0,RE)            INSERT ENTRY LENGTH      S99228 11802022
         L     RD,LCBINVPT-ONE          LOAD CURRENT INVLIST ENT S99228 11804022
         AR    RD,RC                    INCREMENT INVLIST PTR AD S99228 11806022
         STCM  RD,AD,LCBINVPT           SET NEXT INVLIST ENTRY   Y01948 11808005
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR?       @YA06889 11809000
         BE    ERERROR                  BRANCH YES             @YA10695 11810000
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR@YA10052 11811000
         MVC   LCBERADR(THREE),LCBINVPT SET POLL ADDRESS       @SA62375 11812000
         B     CLEANUP                  NO RESTART ON NEG RESP   S99228 11814022
ITERATE  EQU   *                                                 S99228 11816022
.LL44    ANOP                                                    S99228 11818022
         LA    RC,CLEANUP               NORMAL BRANCH ADDRESS   SA51090 11820022
         TM    SCBSTATE,SCBLCK1N        IS THIS LOCK MODE       SA51090 11824022
         AIF   ('&GEN' NE 'BISC').L32A                          SA51090 11828022
         BO    ERRINIT                  BRANCH IF SO            SA51090 11832022
         AGO   .L32B                                            SA51090 11836022
.L32A    ANOP                                                   SA51090 11840022
         BO    TESTARU                  BRANCH IF SO            SA51090 11844022
.L32B    ANOP                                                   SA51090 11848022
         SPACE                                                          11852022
         SPACE                                                          11860020
         AIF   ('&GEN' EQ 'BISC').L32Z                         @YA10673 11862000
         L     RC,AVTSAVEX+UCBOFFST     GET UCB ADDRESS        @YA10673 11864000
         CLI   UNITYPE(RC),AVTEZERO     IS THIS AUDIO?         @YA10673 11866000
         BE    AUDIO                    BRANCH YES             @YA10673 11868000
         LA    RC,CLEANUP               NORMAL BRANCH ADDRESS  @YA10673 11870000
.L32Z    ANOP                                                  @YA10673 11872000
         OI    LCBSTAT2,LCBNEGRP        INDIC NEG RESP TO POLL          11880020
         TM    LCBSTAT2,LCBDIAL         DIAL LCB                        11920020
         AIF   ('&GEN' NE 'QTAM' AND '&GEN' NE 'MINI').L3222   @OY11504 11924091
         BZ    NOTDIAL                   NO-BRANCH             @OY11504 11928091
         AGO   .L322Z                                          @OY11504 11932091
.L3222   ANOP                                                  @OY11504 11936091
         BO    ERRTEST                  BRANCH IF DIAL         @YA10052 11940000
         L     RE,AVTDOUBX              LOAD LCB EXTNSION ADDR @YA10052 11943000
         TM    LCBDCT1,C3270            3270 DEVICE            @YA10052 11946000
         BZ    NOTDIAL                  NO,UPDATE LCBINVPT     @YA10052 11949000
         CLC   LCBINVPT,LCBERADR        WAS POLL FOR SOH MSG   @YA10052 11952000
         BE    NOTDIAL                  NO,UPDATE LCBINVPT     @YA10052 11955000
         SPACE                                                          11960020
.L322Z   ANOP                                                  @OY11504 11965091
ERRTEST  EQU   *                                                SA51090 11970022
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 11980020
         BE    ERERROR                  BRANCH IF YES                   12000020
         SPACE                                                          12020020
         BR    RC                       PROCEED NORMALLY        SA51090 12040022
         SPACE 2                                                        12040722
ERRINIT  EQU   *                                                SA51090 12041422
         LA    RC,RESTART               LOCK BRANCH ADDRESS     SA51090 12042122
         B     ERRTEST                  TEST FOR PERM ERROR     SA51090 12042822
         AIF   ('&GEN' EQ 'BISC').L32C                          SA51090 12043522
         SPACE 2                                                        12044222
TESTARU  EQU   *                                                SA51090 12044922
         L     RC,AVTSAVEX+UCBOFFST     UCB ADDRESS              X02004 12045605
         CLI   UNITYPE(RC),AVTEZERO     IS THIS AUDIO           SA51090 12046322
         BNE   ERRINIT                  BRANCH IF NOT           SA51090 12047022
AUDIO    EQU   *                                               @YA10673 12047300
         SPACE                                                          12047722
         CLI   LCBCSW+6,TWO             HAS TEXT BEEN ENTERED   SA51090 12048422
         BE    ERERROR                  BRANCH IF NOT           SA51090 12049122
         SPACE                                                          12049822
         L     RPREFIX,LCBLSPCI-1       GET ADDRESS OF BUFFER   SA51090 12050522
         LH    RC,PRFSIZE               GET BUFFER LENGTH       SA51090 12051222
         LA    RC,TWO(,RC)              ASSUME TEXT OF 2 BYTES  SA51090 12051922
         CLI   LCBCSW+6,ONE             WAS ONLY ONE CHAR READ  SA51090 12052622
         BNE   POSTASIS                 BRANCH IF NOT           SA51090 12053322
         SPACE                                                          12054022
         BCTR  RC,ZERO                  DECREMENT LENGTH BY ONE SA51090 12054722
         SPACE                                                          12055422
POSTASIS EQU   *                                                SA51090 12056122
         STH   RC,PRFSIZE               RESTORE BUFFER LENGTH   SA51090 12056822
         STCM  RPREFIX,AD,LCBRECAD      SET REC ADDR           @OZ09957 12057191
         B     POSTMH                   POST BUFFER TO MH       SA51090 12057522
.L32C    ANOP                                                   SA51090 12058222
         SPACE 2                                                        12060020
NOTDIAL  EQU   *                                                        12080020
TSO1     EQU   *                                                    TSO 12100020
.L33     ANOP                                                           12120020
NEXTENT  EQU   *                                                        12160020
         SR    RC,RC                    CLEAR WORK REG                  12180020
         IC    RC,LCBUCBX               RLN MINUS 1                     12200020
         SLL   RC,2                     MULTIPLY BY 4                   12220020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 12240020
         USING IHADCB,RA                                                12260020
         L     RF,DCBINVLI(RC)          ILIST  FOR THIS LINE            12280020
         DROP  RA                                                       12300020
         L     RD,LCBINVPT-1            CURRENT ENTRY IN I LIST         12320020
         SR    RE,RE                    CLEAR INDEX  REGISTER           12340020
         IC    RE,TWO(R0,RF)            SIZE OF EACH ENTRY              12360020
         AR    RD,RE                    POINT TO NEXT ENTRY             12380020
         MVI   SCBRCVCT,0               RESET RECEIVE LIMIT             12400020
POLLEXIT EQU   *                                                        12420020
         STCM  RD,AD,LCBINVPT .         NEXT ENTRY               X01004 12440005
         L     RA,LCBDCBPT              GET DCB ADDRESS        @SA62375 12446000
         USING IHADCB,RA                                       @SA62375 12452000
         SR    RC,RC                    CLEAR FOR IC           @SA62375 12458000
         IC    RC,DCBEIOBX              GET OFFSET TO LCB END  @SA62375 12464000
         DROP  RA                                              @SA62375 12470000
         LA    RA,EIGHT                 LENGTH OF EXTENSION    @SA62375 12476000
         SR    RC,RA                    OFFSET TO EXTENSION    @SA62375 12482000
         ALR   RC,RLCB                  ADDR. OF LCB EXTENSION @SA62375 12488000
         MVC   LCBERADR-IEDQLCBX(THREE,RC),LCBINVPT POLL ADDR. @SA62375 12494000
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 12500020
         BE    ERERROR                  BRANCH YES                      12520020
         CLI   ZERO(RD),FE              END OF LIST                     12560020
         BE    CLEANUP                  BRANCH YES                      12580020
.Z25     AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').Z24               12600020
         AIF   ('&GEN' EQ 'QTAM').Z24                                   12620020
         CLI   1(RD),FE                 END OF AUTOPOLL BSC             12640020
         BE    CLEANUP                  YES                             12660020
.Z24     ANOP                                                           12680020
         TM    LCBSTAT2,LCBSNDPR        SEND SWITCH SET BY SCHED        12700020
         BO    CLEANUP                  BRANCH YES                      12720020
         TM    AVTBIT1,AVTTSON          TSO IN THE SYSTEM      @OZ25091 12725000
         BO    CLEANUP                  BRANCH YES             @OZ25091 12730000
         TM    AVTBIT3,AVTRECVN+AVTRFULN CORE Q OR REUS FULL?  @OZ14176 12736091
         BNZ   CLEANUP                  BRANCH YES TO CLEANUP  @OZ14176 12737091
         LA    RCCW,LCBCPA+24           WRITE POLLING CHRS CCW          12740020
         STCM  RD,AD,CCWADDR            SET CCW ADDRESS          Y01948 12760005
         BCTR  RE,R0                    DECREMENT TO ACCESS INDEX       12820020
         IC    RE,0(RE,RD)              GET INDEX BYTE                  12840020
         SLL   RE,ONE                   MULTIPLY BY 2                   12860020
         SR    RF,RE                    POINT TI OFFSET IN TNT          12880020
         LH    RC,0(RF)                GET TNT OFFSET                   12900020
         AIF   ('&GEN' NE 'MINI').Z2                             S22025 12920022
         STH   RC,LCBTTCIN .            NEW CONNCTED             S22025 12970022
         AGO   .Z26A .                                           S22025 13020022
.Z2      ANOP .                                                  S22025 13070022
         L     RF,POLLAD .              AUTOPOLL ROUTINE         S22025 13120022
         BAL   RD,FINDSCBQ-POLLRT(RF) . SCB/QCB FOR NEXT ENTRY   S22025 13170022
*                                         AND GET QCB ADDRESS    S22025 13220022
         TM    QCBSTAT-IEDQQCB(RB),QCBSEND SEND MODE             S22025 13270022
         BO    NEXTENT .                BRANCH YES TO NEXT ENTRY S22025 13320022
         NI    LCBSTAT2,X'FF'-LCBNEGRP . RESET NEGATIVE RESPONSE S22025 13340022
.Z26A    ANOP .                                                  S22025 13370022
         B     RESTART                  RESTART ON NEXT ENTRY           13680020
         SPACE                                                          13700020
CLEANUP  EQU   *                                                        13720020
         MVI   LCBPRI,PRIFSPCI-1        CLEANUP PRIORITY                13740020
         L     RSCB,LCBSCBA-1           SCB BASE               @SA73574 13742000
         TM    SCBERR1,SCBCUTFN         CUTOFF RUNNING?        @SA73574 13744000
         BNO   LEAVE                    BRANCH IF NO           @SA73574 13746000
         LA    RF,AVTBFRTB              BFR RETURN QCB ADDR    @SA73574 13748000
         ST    RF,AVTDOUBX              SET FOR COMPARE        @SA73574 13750000
         CLC   AVTDOUBX+1(3),LCBERBQB   ERB POSTED TO BFR RTN? @SA73574 13752000
         BE    LEAVE                    EXIT IF YES            @SA73574 13754000
         OI    LCBERBST,LCBDLNKN        SET ERB POSTABLE       @SA73574 13756000
LEAVE    EQU   *                                                        13760020
         L     RF,AVTBSCAN .            ADDRESS OF IEDQBD        X01004 13780005
         B     POSTQ                    USE COMMON CODE                 13820020
         AIF   ('&GEN' EQ 'MINI').L37A                                  13840020
         AIF   ('&GEN' EQ 'BISC').Z3                                    13860020
         SPACE 10                                                       13880020
*                                                                       13900020
*        INTERRUPTS ON ENABLE FOR S/S DIAL LINES                        13920020
*                                                                       13940020
RTENAB   EQU   *                                                        13960020
         SPACE                                                          13980020
         TS    LCBTSTSW                 HIO TO BE DONE                  14000020
         BNZ   CLEANUP                  YES                             14020020
         B     EXIT2                    RESTART AFTER ENABLE            14040020
*                                                                       14060020
         EJECT                                                          14080020
*        READ  RESPONSE TO ADDRESSING                                   14100020
*                                                                       14120020
.Z3      AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'QTAM').L37B       S22025 14140022
RTRSPADD EQU   *                                                        14180020
         AIF   ('&GEN' NE '').L36                                       14200020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        14220020
         BZ    NOBSC                                                    14240020
.L36     ANOP                                                           14260020
         SPACE                                                          14280020
         L     RF,CHACKAD               CHECK RESPONSE ROUTINE          14300020
         BALR  RD,RF                    LINK TO ROUTINE                 14320020
BSCADD   EQU   *                                                        14340020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER         S21101 14360020
         TM    LCBMSGFM,LCBACKI .       TEST ACK COUNTER         S21101 14370020
         BZ    TRYACK1                  TRY ACK-1                       14400020
         SPACE                                                          14420020
         TM    LCBERCCW,RACK0           SET CONDITION CODE              14440020
ACKTEST  EQU   *                                                        14460020
         BO    ADDROK                   RIGHT ACK RECEIVED              14480020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER BACK    S21101 14500020
         USING IEDQTRM,RB .                                      S22025 14510022
         BAL   RD,DCTBASE .             GET BASE ADDR OF DCT     S22025 14590022
         L     RB,TRMDESTQ-1 .          QCB ADDRESS              S22025 14670022
         DROP    RB                                                     14760020
         USING IEDQQCB,RB                                               14780020
         TM    LCBERCCW,RENQ            ENQ                             14800020
         BNO   TRYWK                    NO, TRY WACK                    14820020
         SPACE                                                          14840020
         TM    2(RA),MPT                MULTIPOINT                      14860020
         BO    TSTRTRY                  WRITE ENQ                       14880020
         SPACE                                                          14900020
OWERESP  EQU   *                                               @YA11157 14910000
         TM    3(RA),ENDCTL             END-END CONTROL                 14920020
         BO    TSTRTRY                  YES, SEND ENQ AGAIN    @SA72446 14940000
         SPACE 1                                               @SA72446 14950000
         OI    LCBSTAT2,LCBRESP         SET RESPONSE OWED      @SA72446 14960000
         B     CONTENT                  GO HANDLE CONTENTION   @SA72446 14980000
         SPACE                                                          15000020
TRYWK    EQU   *                                                        15020020
         TM    LCBERCCW,RWACK           WACK RECEIVED                   15040020
         BZ    NOWK                     NO                              15060020
         SPACE                                                          15080020
         TM    2(RA),MPT                MULTIPT                         15100020
         BZ    AGAINTRY                 NO                              15120020
.L37B    ANOP .                                                  S21101 15140020
TEST1ST  EQU   *                                                 S21101 15150020
         TM    QCBSTAT-IEDQQCB(RB),QCBBUFRD HEADER BUFFER        S21101 15152020
         BZ    DONTSEND                 NO                              15160020
         SPACE                                                          15180020
.L37A    ANOP                                                           15200020
RESETMM  EQU   *                                                        15220020
         NI    SCBQTYPE,AVTEFF-SCBBFMM  RESET MIDDLE OF SMG             15240020
         AIF   ('&GEN' EQ 'MINI').L37                                   15260020
         AIF   ('&GEN' EQ 'STSP').L37                                   15280020
         AIF   ('&GEN' EQ 'QTAM').L37                                   15300020
         B     DONTSEND                 EXIT                            15320020
         SPACE                                                          15340020
NOWK     EQU   *                                                        15360020
         TM    LCBERCCW,REOT            EOT                             15380020
         BO    ERRSPAD                  YES, TERMINAL NOT READY         15400020
         SPACE                                                          15420020
         TM    LCBERCCW,RRVI            RVI RECEIED                     15440020
         BZ    NORVI                    NO                              15460020
         TM    2(RA),MPT                MULTIPT                         15480020
         BZ    NOMPT                    NO                              15500020
         TM    QCBSTAT,QCBBUFRD                                         15520020
         BO    RESETMM                  YES                             15540020
         TM    ONE(RA),C3270            3270 DEVICE?             S99228 15542022
         BZ    NORVIERP                 NO, NO DVC DEP ERP       S99228 15544022
         L     RF,LOOKAD                LOAD ADDR DVCCSTCS LOCRTNS99228 15544522
         BALR  RD,RF                    BRANCH TO DVCCSTCS LOCRTNS99228 15545022
         ST    RE,AVTDOUBX+FOUR         SAVE INVLIST CWORD ADDR  S99228 15545522
         L     RF,FINDAD                LOAD ADDR DVC DEP SRC RT S99228 15546022
         BALR  RD,RF                    BRANCH TO DVC DEP SRC RT S99228 15548022
         B     ERRSPAD                  SKIP FLAG SET            S99228 15550022
NORVIERP EQU   *                                                 S99228 15552022
         SPACE                                                          15560020
         OI    SCBERR4,SCBTXTTN         SET TEXTY ERROR                 15580020
         OI    SCBERR1,SCBRVISL         SET RVI TO SELECTION            15600020
         B     RESETMM                  EXIT                            15620020
NOMPT    EQU   *                                                        15640020
         DROP  RB                                                       15660020
         SPACE                                                          15680020
         TM    3(RA),ENDCTL             END-END CONTROL                 15700020
         BO    DONTSEND                 RESCHEDULE                      15720020
         SPACE                                                          15740020
         B     TSTRTRY                  RETRY WITE ENQ                  15760020
         SPACE                                                          15780020
NORVI    EQU   *                                                        15800020
         TM    LCBERCCW,RNAK            NAK RECEIVED                    15820020
         BZ    TSTRTRY                  NO                              15840020
         SPACE                                                          15860020
         TM    2(RA),MPT                MULTIPT                         15880020
         BO    ERRSPAD                  YES                             15900020
         SPACE                                                          15920020
         TM    3(RA),ENDCTL             END-END CTL                     15940020
         BZ    RESETTM                  NINVALID RESPONSE               15960020
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             15980020
         BNL   RESETTM                  YES                             16000020
         IC    RWKA,LCBINCAM            RETRY COUNT                     16020020
         LA    RWKA,1(,RWKA)            BUMP                            16040020
         STC   RWKA,LCBINCAM            SET BACK                        16060020
         SH    RCCW,H8                  BACK UP TO PREVIOUS CCW         16080020
         B     EXIT3                    RESTART                         16100020
         SPACE                                                          16120020
         SPACE                                                          16140020
TRYACK1  EQU   *                                                        16160020
         TM    LCBERCCW,RACK1           SET CONDITION CODE              16180020
         B     ACKTEST                  USE COMMON BRANCHES             16200020
CONTENT  EQU   *                                                 S99244 16200922
         L     RA,LCBDCBPT              GET DCB ADDRESS          S99244 16201822
         USING IHADCB,RA                                         S99244 16202722
         SR    RC,RC                    CLEAR WORK REGISTER      S99244 16203622
         IC    RC,LCBUCBX               GET RLN MINUS 1          S99244 16204522
         SLL   RC,2                     (RLN-1)*4 IS INVITATION  S99244 16205422
*                                         LIST ADDRESS INDEX     S99244 16206322
         L     RA,DCBINVLI(RC)          INVITATION LIST ADDRESS  S99244 16207222
         DROP  RA                                                S99244 16208122
         TM    3(RA),MASTER             MASTER=YES SPECIFIED   @XA08073 16209091
         BNO   DONTSEND                 NO, FORGET IT            S99244 16209922
         NI    LCBSTAT2,X'FF'-LCBRESP   RESET RESPONSE OWED    @OS76283 16210391
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED      S99244 16210822
         BH    SLCTNERR                 YES, SELECTION ERROR     S99244 16211722
         IC    RA,LCBINCAM              GET RETRY COUNT          S99244 16212622
         LA    RA,1(RA)                 INCREMENT                S99244 16213522
         STC   RA,LCBINCAM              AND SAVE                 S99244 16214422
         SH    RCCW,H8                  BACK UP TO WRITE ENQ CCW S99244 16215322
         B     EXIT3                    GO RESTART ON WRITE ENQ  S99244 16216222
SLCTNERR EQU   *                                                 S99244 16217122
         OI    SCBERR4,SCBSLCTN         INDICATE SELECTION ERR   S99244 16218022
.L37     ANOP                                                           16220020
DONTSEND EQU   *                                                        16240020
         NC    SCBDEOB(4),SCBDEOB .     IS IT START OF MSG       S99244 16243022
         BNZ   NOSDFFO .                NO, BYPASS NEXT          S99244 16246022
         NI    QCBFLAG-IEDQQCB(RB),AVTEFF-QCBSDFFO RESET TO      S99244 16249022
*                                         NEUTRAL                S99244 16252022
NOSDFFO  EQU   * .                                               S99244 16255022
         TM    QCBFLAG-IEDQQCB(RB),QCBTSSES TSO IN SESSION     @YA10410 16256000
         BO    ERRSPAD                  ADDRESSING ERROR       @OY12287 16257091
         USING IEDQQCB,RB                                      @OX17153 16260000
         OI    QCBELCHN+2,QCBCNTEN      SET FLAG FOR SCHEDULER @OX17153 16260100
         DROP  RB                                              @OX17153 16260200
*                                         TO DETERMININE NEXT TYPS21101 16270020
*                                         OF OPERATION           S21101 16280020
         B     ERRSPAD                 FREE UP BUFFERS                  16300020
ADDROK   EQU   *                                                        16320020
         LA    RCCW,LCBCPA-8           ADJUST TO START IDLES            16340020
         AIF   ('&GEN' EQ 'BISC').LC                                    16360020
         B     NOTMOD2                  POST BUFFERS                    16380020
         AIF   ('&GEN' EQ '').L35                                       16400020
RTRSPADD EQU   *                                                        16420020
.L35     ANOP                                                           16440020
NOBSC    EQU   *                                                        16460020
         AIF   ('&GEN' EQ 'MINI').L35A                           S21101 16470020
         CLI   LCBCSW+6,7               2740/2                          16480020
         BNE   NOTMOD2                  NO                              16500020
         SPACE                                                          16520020
         NI    LCBERCCW+12,X'7F'        TURN OFF PARITY BIT             16540020
         CLI   LCBERCCW+13,X'76'        CIRCLE Y RESPONSE               16560020
         BE    GOODRSP                  YES                             16580020
         CLI   LCBERCCW+12,8             ENTER, BID, PRINT, LOCAL       16600020
         BH    ERERROR .               REAL ERROR                S21101 16620020
         TM    LCBERCCW+12,X'06'        BID,ENTER,OR LOCAL     @OX16385 16621591
         BNZ   ERERROR                  YES-REAL ERROR         @OX12567 16621891
         LH    RC,LCBTTCIN .            CURRENT  CONNECTED       S21101 16623020
         L     RA,AVTRNMPT .            CONVERSION CODE          S21101 16626020
         USING IEDQTNTD,RA                                       S21101 16629020
         BAL   RPREFIX,TNTDCODE .       LINK TO IT               S21101 16632020
         DROP  RA .                                              S21101 16635020
         L     RB,TRMDESTQ-1-IEDQTRM(,RB) . GET QCB ADDRESS      S21101 16638020
         B     TEST1ST .                TEST IF HEADER           S21101 16638620
GOODRSP  EQU   *                                                        16660020
         CLI   LCBERCCW+12,X'01'        UNUSUAL POSITVE RESPONSE        16680020
         BE    NOTMOD2                  BRANCH NORMAL RESPONSE          16700020
         SPACE                                                          16720020
         CLI   LCBRCB,X'0F'             HAVE WE RECORDED YET            16740020
         MVI   LCBRCB,X'0F'             SET RECORD FLAG                 16760020
         BNE   ERPEXIT                  ERP WILL RECORD UNUSUAL         16780020
.L35A    ANOP                                                    S21101 16790020
NOTMOD2  EQU   *                                                        16800020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').Z41XX             16801022
         AIF   ('&GEN' EQ 'QTAM').Z41XX                                 16802022
         CLI   LCBTPCD+10,X'BD'         IS THIS FOR ERASURE         TSO 16803022
         BNE   NOTERASE                 BRANCH ON NO                TSO 16804022
         LR    RF,RCCW                  ADDRESS OF INTERRUPT CCW    TSO 16805022
         SH    RF,H8                    POINT TO WRITE ADDR CCW     TSO 16806022
         L     RF,0(RF)                 GET ADDRESS OF ADDR CHARS   TSO 16807022
         NI    2(RF),X'BF'              SET TO NO ERASE             TSO 16808022
         MVI   LCBTPCD+10,X'00'         RESET TP CODE               TSO 16809022
NOTERASE EQU   *                                                        16810022
.Z41XX   ANOP                                                           16811022
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION                  16820020
         BNZ   ERERROR                  YES, ERROR                      16840020
.LC      ANOP                                                           16860020
SKIPUE   EQU   *                                                SA69087 16870005
         TM    LCBSTAT2,LCBMSGNN        IS THIS MESSAGE GEN             16880020
         AIF   ('&GEN' NE 'BISC').Z41                                   16900020
         BO    EXIT2                                                    16920020
         AGO   .Z42                                                     16940020
.Z41     ANOP                                                           16960020
         BO    TESTEX                   BRANCH YES                      16980020
.Z42     ANOP                                                           17000020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').Z4                17020020
         AIF   ('&GEN' EQ 'QTAM').Z4                                    17040020
         CLI   LCBTPCD+11,X'BE'         IS THIS ENTRY FOR SMI     \>3   17220020
         BNE   LDENQ                    NO, BRANCH               \>3    17240020
         ST    R15,LCBERCCW+4           SAVE REG                SA54923 17260022
         L     12,AVTKA02               GET ADDRESS OF IOGENER    \>3   17280020
         LA    RAVT,AVTSAVE2            SET AVT BASE FOR IOGENER   \>3  17300020
         BALR  5,12                     LINK TO IOGENER           TSO   17320020
         L     R15,LCBERCCW+4           RESTORE REG             SA54923 17340022
         LA    RBASE,4095(R15)          RESET SECOND BASE REGISTER TSO  17360020
         LA    RBASE,1(RBASE)                                     TSO   17380020
         SH    RAVT,AVTBACK             RESET AVT ADDRESS         TSO   17400020
         B     RESTART                  RESTART CHANNEL PROGRAM    TSO  17420020
LDENQ    EQU   *                                                  TSO   17440020
.Z4      ANOP                                                           17460020
         L     RB,LCBERBCH-1            1ST BUFFER IN CHAIN             17480020
         B     ENTER2                   ENTER LOOP                      17500020
LOOP5    EQU   *                                                        17520020
         LA    RD,0(,RD)                CLEAR HI ORDER BYTE             17540020
         LTR   RB,RD                    ADDRESS NEXT BUFFER AND         17560020
*                                         TEST IF LAST                  17580020
         BZ    EXIT1                    BRANCH NO MORE BUFFERS          17600020
         SPACE                                                          17620020
ENTER2   EQU   *                                                        17640020
         L     RD,PRFLINK-1-IEDQPRF(,RB) SAVE LINK FIELD                17660020
         LR    RPREFIX,RB               ADDRESS FO BUFFER FOR READY     17680020
         MVI   PRFPRI,PRIMHBFR          POST PRIORITY                   17700020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 17720020
         USING IHADCB,RA                                                17740020
         L     RF,DCBMH-1               QCB FOR POST                    17760020
         DROP  RA                                                       17780020
         BAL   RC,ENQUEUE               PUT ON READYBQUEUE              17800020
         SPACE                                                          17820020
         B     LOOP5                    TEST IF MORE TO POST            17840020
         SPACE                                                          17860020
EXIT1    EQU   *                                                        17880020
         STCM  RB,AD,LCBERBCH .         CLEAR FIELD              X01004 17900005
         AIF   ('&GEN' EQ 'BISC').Z5                                    17960020
TESTEX   EQU   *                                                        17980020
         TM    LCBCHAIN,LCBEXCP         NO IDLES LOOP DEFINED           18000020
         BZ    EXIT2                    BRANCH NO                       18020020
         SPACE                                                          18040020
         TM    LCBSTAT2,LCBMSGNN        MSGGEN                          18060020
         BZ    FREERQE                  NO                              18080020
         LA    RCCW,LCBCPA-8            START ON MSGGEN MSG             18100020
.Z5      ANOP                                                           18120020
EXIT2    EQU   *                                                        18140020
         LA    RCCW,8(,RCCW)            RESTART ON NEXT CCW             18160020
EXIT3    EQU   *                                                        18180020
         ST    RCCW,LCBSTART-1          START ADDRESS FOR IOS           18200020
         B     RESTART                  RESTART CHANNEL PROGRA,         18220020
         SPACE 5                                                        18240020
         AIF   ('&GEN' EQ 'BISC').L39                                   18260020
RTRSPEB  EQU   *                                                        18280020
         AIF   ('&GEN' NE '').L38                                       18300020
         TM    LCBSTAT2,LCBSYNC         BI SYNC                         18320020
         BNZ   TRYBSC                   YES                             18340020
.L38     ANOP                                                           18360020
         L     RCCW,LCBCPA+12           CURRENT CCW                     18380020
         TM    LCBCSW+3,UNEX            EOT RECEIVED                    18400020
         BO    ERRSPEB                  BRANCH IF YES                   18420020
         CLI   CCWCOUNT+1,AVTEZERO .    DID PGM CHECK OCCUR      S21101 18440020
         BE    IDLEST .                 BRANCH IF YES            S21101 18450020
         SPACE 1                                                 S21101 18460020
         MVC   SCBDEOB+1(3),LCBRECAD .  SET RESTART IN SCB       S21101 18470020
         MVC   SCBDEOB(1),LCBNTXT .     SET DISK Q INFORMATION   S21101 18472020
         MVC   SCBEOB,LCBRECOF .        SET OFSET INTO BUFFER    S21101 18474020
         MVI   LCBTPCD+2,TPBUFEOT .     SET TP OP CODE           S21101 18476020
         B     RESETEOT .               RESET LINE               S21101 18478020
         SPACE 1                                                 S21101 18478420
IDLEST   EQU   *                                                 S21101 18478820
         TM    LCBCHAIN,LCBEXCP         IDLES LOOP DEFINED              18480020
         BO    FREERQE                  BRANCH IF NO                    18500020
         B     PCSTART                  START ON WRITE IDLES            18520020
.L39     ANOP                                                           18540020
*        SEND EOT FOR BUFFERED TERMINALS AND ALSO FOR END OF TRANSP     18560020
*        MODE MESSAGE                                                   18580020
RTBUFEOT EQU   *                                                        18600020
ERBUFEOT EQU   *                                                        18620020
         L     RCCW,LCBCPA+12           CURRENT CCW                     18640020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   18660020
         BAL   RA,FINDBUFF              LINK TO FREE UP RPEVIOUS        18680020
         MVI   PRFPRI-IEDQPRF(RPREFIX),PRIRCQCB E0 PRIORITY    @OS76996 18700091
         B     DISP                     TO BFR DISPOSITION     @OS76996 18710091
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L40               18720020
         AIF   ('&GEN' EQ 'QTAM').L40                                   18740020
         AIF   ('&GEN' EQ '').LM4                                       18760020
RTRSPEB  EQU   *                                                        18780020
.LM4     ANOP                                                           18800020
TRYBSC   EQU   *                                                        18820020
         TM    LCBSTAT2,LCBMSGNN        MSGGEN                          18840020
         BZ    NOTMSGN                  BRANCH NO              @OY12393 18860091
         TM    LCBSTAT2,LCBDIAL         DIAL LINE?             @OY12393 18863091
         BZ    RESETTM                  BRANCH NO,SEND EOT     @OY12393 18866091
         OI    SCBBSCFM,SCBNOEOT        NO EOT SENT            @OY12393 18869091
         B     ERBPOST                  EXIT                   @OY12393 18872091
NOTMSGN  EQU   *                                               @OY12393 18875091
         L     RF,CHACKAD               CHECK RESPONSE ROUTINE          18880020
         BALR  RD,RF                    LINK TO ROUTINE                 18900020
         TM    LCBERCCW,RWACK .         WACK RECEIVED            S99228 18900322
         BZ    REGWACK .                BRANCH IF NO             S99228 18900622
         L     RF,LOOKAD                LOAD ADDR DVCCSTCS LOCRTNS99228 18901022
         BALR  RD,RF                    BRANCH TO DVCCSTCS LOCRTNS99228 18901622
         ST    RE,AVTDOUBX+FOUR         SAVE INVLIST CWORD ADDR  S99228 18902222
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 18902822
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 18903422
         BZ    REGWACK                  NO, NOT 3270 USUAL WACK  S99228 18904022
         XI    LCBMSGFM,LCBACKI         FLIP ACK COUNTER         S99228 18907022
         TM    LCBMSGFM,LCBACKI         ACK-0 EXPECTED?          S99228 18908022
         BZ    ZACK                     ACK-1 EXPECTED           S99228 18909022
         MVI   LCBERCCW,RACK0           SET ACK-0                S99228 18910022
         B     GOBACK                   BYPASS SET FOR ACK-0     S99228 18911022
ZACK     EQU   *                                                 S99228 18912022
         MVI   LCBERCCW,RACK1           SET ACK-1                S99228 18913022
GOBACK   EQU   *                                                 S99228 18914022
         XI    LCBMSGFM,LCBACKI         RETURN ACK COUNTER       S99228 18915022
REGWACK  EQU   *                                                 S99228 18916022
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER         S21101 18920020
         TM    LCBMSGFM,LCBACKI .       TEST ACK COUNTER         S21101 18930020
         BZ    ITSACK1                  BANCH ACK-1 EXPECTED            18960020
         TM    LCBERCCW,RACK0           SET CONDITION CODE              18980020
TESTACK  EQU   *                                                        19000020
         BO    ACKSET                   BRANCH RIGHT ACK RECEIVED       19020020
         BZ    CHKRVI                   NO, CHECK FOR RVI               19040020
*        TO HERE IF WRIONG ACK-I                                        19060020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER         S21101 19080020
CHKRTRY  EQU   *                                                        19100020
         CLI   LCBINCAM,0               RETRY COUNT                     19120020
         BNE   TESTCNT                  NOT FIRST TIME                  19140020
         SPACE                                                          19160020
         MVC   LCBCSWSV,LCBCSW          SAVE CSW                        19180020
TESTCNT  EQU   *                                                        19200020
         CLI   LCBINCAM,RETRY           RESTRY EXHAUSTED                19220020
         BL    BUMPCNT                  RETRY AGAIN                     19240020
         SPACE                                                          19260020
WREOT    EQU   *                                                        19280020
         OI    LCBCHAIN,LCBNORTY        NO RETRY                        19300020
         MVI   LCBTPCD+2,TPRESET        SET TP OPCDE                    19320020
         B     RESETEOT                 SEND EOT TO RESET LINE          19340020
         SPACE                                                          19360020
BUMPCNT  EQU   *                                                        19380020
         IC    RWKA,LCBINCAM            GET RETRY COUNT                 19400020
         LA    RWKA,1(,RWKA)            BUMP                            19420020
         STC   RWKA,LCBINCAM            SET BACK                        19440020
         B     ENQSND                   WRITE ENQ                       19460020
*                                         READ RESPONSE CCW             19480020
         SPACE 3                                                        19500020
ITSACK1  EQU   *                                                        19520020
         TM    LCBERCCW,RACK1           TET FOR ACK1 RECIVED            19540020
         B     TESTACK                  USE COMMON CODE                 19560020
CHKNAK   EQU   *                                                        19580020
         TM    LCBERCCW,RNAK            TEST FOR NAK                    19600020
         BZ    EOTTST                   BRANCH NO                       19620020
NAKSAME  EQU   *                                                        19640020
         CLI   LCBINCAM,RETRY           RETRY COUNTEXHAUSTED            19660020
         BNL   WREOT                    YES WRITE EOT          @SA75722 19680000
         SPACE 2                                                        19700020
MHEXIT   EQU   *                                                        19720020
         MVI   LCBECBCC,PERMERR         SET ERROR INDICAOTR             19740020
         L     RPREFIX,LCBLSPCI-1       LAST SERVICED BUFFER            19760020
           SPACE                                                        19780020
         B     ERRSPEB                  POST BUFFER TO MH               19800020
*                                         MH ERROR HANDLING             19820020
EOTTST   EQU   *                                                        19840020
         TM    LCBERCCW,REOT            EOT SENT                        19860020
         BZ    CHKRTRY                  C HECK RETRY COUNT              19880020
         L     RF,LOOKAD .              LOAD ADDR DVCCSTCS       S99228 19900022
         BALR  RD,RF .                  LINK TO ROUTINE          S99228 19901022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 19902022
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 19905022
         BZ    NOEOTERP                 NO, SKIP ERP FLAG SET    S99228 19908022
         ST    R0,AVTDOUBX+FOUR         SAVE INVLIST POINTER    SA62341 19909005
         L     RF,FINDAD                LOAD ADDR DVC DEP SRC RT S99228 19910022
         BALR  RD,RF                    BRANCH TO DVC DEP SRC RT S99228 19912022
NOEOTERP EQU   *                                                 S99228 19914022
         SPACE                                                          19920020
         OI    SCBERR2,SCBABRTN         SET ABORT RECEIVED              19980020
         B     ERRSPEB                  POST SENDING ERROR              20020020
CHKENQ   EQU   *                                                        20040020
         TM    LCBERCCW,RENQ            ENQ RECEIVED                    20060020
         BZ    CHKRTRY                  BEANCH IF NO                    20080020
         SPACE                                                          20100020
*        ENQ IS VALID RESPONSE IF THIS IS FIRST BLOCK OF CONVERSE       20120020
*      RESPONSE.  DESTINATION DID NOT SEE RESPONSE AND IS STILL         20140020
*      IN MASTER STATUS.                                                20160020
         SPACE                                                          20220020
CHKWK    EQU   *                                                        20240020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER BACK    S21101 20260020
         TM    LCBERCCW,RWACK           TEST FOR WACK RECEIVED          20280020
         BZ    CHKNAK                   TRY NAK                         20300020
         CLI   LCBRSKEY,BUFF            BUFFERED LINE                   20320020
         BNE   ENQSND                   WRITE ENQ                       20340020
         L     RF,BSCRSPAD              LINK TO RWUTINE                 20360020
         BALR  RD,RF                    LINK TO IT                      20380020
ENQSND   EQU   *                                                        20400020
*                                       SET TP OPCODE FOR WRITE@SA69968 20401061
         MVI   LCBTPCD+10,TPENQAD       ENQ ADDRESSING DEFAULT @SA69968 20402061
         L     RWKA,LCBCSW-1            GET TRUE               @SA69968 20403061
         LA    RWKA,AVTEZERO(,RWKA)      INTERRUPTED           @SA69968 20404061
         SH    RWKA,H8                    CCW ADDRESS          @SA69968 20405061
         LA    RA,LCBCPA                DERIVE                 @SA69968 20406061
         SR    RWKA,RA                   TP                    @SA69968 20407061
         SRL   RWKA,THREE                 OPCODE               @SA69968 20408061
         AR    RWKA,RLCB                   OFFSET              @SA69968 20409061
         DROP  RLCB                                            @SA69968 20410061
         USING IEDQLCB,RWKA             INTERRUPTED ON READ    @SA69968 20411061
         CLI   LCBTPCD,TPRDRSPD          RESPONSE TO ADDR      @SA69968 20412061
         BE    SNDENQ                   YES, BRANCH            @SA69968 20413061
         CLI   LCBTPCD,TPRSPENQ         RESPONSE TO ENQ        @OZ09265 20413391
         BE    SNDENQ                   BRANCH IF YES          @OZ09265 20413691
         DROP  RWKA                                            @SA69968 20414061
         USING IEDQLCB,RLCB                                    @SA69968 20415061
         MVI   LCBTPCD+10,TPENQRSP .    SET TP OP CODE           S21101 20420020
SNDENQ   EQU   *                                                        20440020
         LA    RA,ENQCH                SET ENQ INDEX                    20460020
         LA    RWKA,LCBCPA+80 .         SET CCW ADDRESS          S21101 20480020
         BAL   RD,CCWBLD                LINK TO ROUTINE                 20500020
         MVI   LCBCPA+84,CCWCC+CCWSLI . SET FLAGS                S21101 20520020
         ST    RCCW,LCBCPA+88 .         SET FOR TIC              S21101 20530020
         MVI   LCBCPA+88,CCWTIC .       SET TIC                  S21101 20540020
         B     RESTCOM                 RESTART                          20580020
         SPACE                                                          20600020
CHKRVI   EQU   *                                                        20620020
         TM    LCBERCCW,RRVI           RVI RECEIVED                     20640020
         BZ    CHKWK                    TRY WACK                        20660020
         TM    LCBMSGFM,DBLRVI          TWO RVI'S BACK TO BACK          20680020
         BNZ   CHKRTRY                  BRANCH YES                      20700020
         OI    LCBMSGFM,DBLRVI          SET RVI SWITCH                  20720020
         OI    SCBERR1,SCBRVITX         SET RVI RECEIVED       @OY13632 20730091
         B     GOACK                    SEND NEXT BLOCK                 20740020
         SPACE                                                          20760020
ACKSET   EQU   *                                                        20780020
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 20782022
         BNO   NOTCONCB .               BRANCH IF NO             S22026 20783022
         L     RCCW,SCBXTRA-1 .         SET REG                  S22026 20784022
         BAL   RA,FINDBUFF .            FREE UP BUFFERS          S22026 20786022
         L     RCCW,LCBCSW-1 .          RESTORE PREVIOUS         S22026 20787022
         SH    RCCW,H8 .                CCW                      S22026 20788022
NOTCONCB EQU   * .                                               S22026 20789022
         NI    LCBMSGFM,AVTEFF-DBLRVI   RESET RVI SWITCH                20800020
GOACK    EQU   *                                                        20820020
         MVI   LCBINCAM,0               RESET RETRY COUNT               20880020
         L     RF,BSCRSPAD              BSC RESPONSE ROUTINE            20900020
         BALR  RD,RF                    LINK TO IT                      20920020
.L40     ANOP                                                           20940020
RESTCOM  EQU   *                                                        20960020
         ST    RWKA,LCBSTART-1          RESTART ON WRITE CCW            20980020
         B     RESTART                  RESTART                         21000020
         EJECT                                                          21020020
*                                                                       21040020
*        READ ENQ FOR BSC TERMINAL LINE BID                             21060020
*                                                                       21080020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').L41               21100020
         AIF   ('&GEN' EQ 'QTAM').L41                                   21120020
RTRDENQ  EQU   *                                                        21140020
         L     RF,CHACKAD               RESPONSE ROUTINE                21160020
         BALR  RD,RF                    LINK TO IT                      21180020
         SPACE                                                          21200020
         TM    LCBSTAT2,LCBDIAL         DIAL LINE                       21220020
         BNZ   ITSDIAL                  YES                             21240020
         SPACE                                                          21260020
         TS    LCBTSTSW                 TS ISSUED BY SEND SCHED         21280020
         BNZ   CLEANUP                  BRANCH YES                      21300020
         SPACE                                                          21320020
ITSDIAL  EQU   *                                                        21340020
         TM    LCBERCCW,RDLEEOT         DLE EOT RECEIVED                21360020
         BZ    TESTEOT                  NO, TRY EOT                     21380020
         SPACE                                                          21400020
DISCON   EQU   *                                                        21420020
         MVI   LCBTSTSW,AVTEFF          ENSURE A DIAL UP                21440020
         B     RTPOLL1                  FREE UP ELEMENTS       @SA74852 21460000
         SPACE                                                          21480020
TESTEOT  EQU   *                                                        21500020
         TM    LCBERCCW,RENQ            ENQ RECEVIED                    21520020
         BO    EXIT2                    YES,RESTART                     21540000
         SPACE                                                          21560020
         TM    LCBERCCW,REOT            EOT RECEIVED                    21580020
         BZ    EOTNOTRC                 BRANCH NO              @OY19793 21600086
         TM    LCBSTAT2,LCBDIAL         IS THIS DIAL?          @OY19793 21602086
         BZ    RTPOLL                   BRIF NO                @OY19793 21604086
         OI    SCBBSCFM,SCBNOEOT        TURN ON NOEOT          @OY19793 21606086
         B     RTPOLL                   AND BRANCH             @OY19793 21608086
EOTNOTRC EQU   *                                               @OY19793 21610086
         SPACE                                                          21620020
         TM    LCBSTAT2,LCBDIAL .      DIAL LINE                SA51068 21640022
         BO    RESTART .               NO, RESTART              SA51068 21645022
         MVI   LCBTSTSW,AVTEZERO .     YES, CLEAR FOR PREPARE   SA51068 21650022
         B     RESTART .               AND RESTART              SA51068 21655022
         SPACE 3                                                        21660020
NOTENQRC EQU   *                                                        21680020
         TM    LCBERCCW,REOT            EOT RECEIVED                    21700020
         BO    ERRSPAD                  YES                             21720020
         SPACE                                                          21740020
         TM    LCBERCCW,RNAK            NAK                             21760020
         BO    RESETTM                  YES                             21780020
         SPACE                                                          21800020
         TM    LCBERCCW,RWACK           WACK RECEIVED                   21820020
         BZ    TSTRTRY                  NO, INVALID RESPONSE            21840020
AGAINTRY EQU   *                                                        21860020
         MVI   LCBTPCD+10,TPENQAD .     SET TP OP CODE           S21101 21880020
         B     SNDENQ                   WRITE ENQ UNTIL READY           21900020
         SPACE 10                                                       21920020
*                                                                       21940020
*        READ RESPONSE TO ENQ.  SELECTION OF TERMINAL ON A PT-PT OR     21960020
* DIAL LINE (BSC).                                                      21980020
*                                                                       22000020
RTRSPENQ EQU   *                                                        22020020
         L     RF,CHACKAD               CHECK RESPONSE ROUTINE          22040020
         BALR  RD,RF                    LINK TO ROUTINE                 22060020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER         S21101 22080020
         TM    LCBERCCW,RACK0           ACK-0                           22100020
         BO    EXIT2                    BRANCH YES                      22120020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER         S21101 22140020
         CLI   LCBERCCW,RENQ            ENQ RECEIVED                    22160020
         BNE   NOTENQRC                 BRANCH NO                       22180020
         TM    LCBSTAT2,LCBDIAL         DIAL LINE                       22200020
         BO    TSTRTRY                  YES,BRANCH             @OS76283 22220091
         BAL   RD,DCTBASE               GET DCT                @OS76283 22226091
         B     OWERESP                  HANDLE CONTENTION      @OS76283 22232091
         SPACE                                                          22240020
TSTRTRY  EQU   *                                                        22260020
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             22280020
         BL    CHKRTRY                  NO, RERY                        22300020
.L41     ANOP                                                           22320020
RESETTM  EQU   *                                                        22340020
         MVI   LCBTPCD+2,TPRSPAD        TP OP CODE FORE RESET IN        22360020
*                                         CONTROL MODE SELECTION        22380020
         B     RESETEOT                 WRITE EOT                       22400020
 SPACE 10                                                               22420020
*                                                                       22440020
*        ENTRY FROM CLOSE MODULE TO RECORD ERROR COUNTERS IN TERMINAL   22460020
* ENTRY BY  EXITING TO ERP.  ERP POST S PERMANENT ERROR  ON RETURN      22480020
* WHICH WILL POST WAIT COMPLETE.                                        22500020
*                                                                       22520020
RTCLOSE  EQU   *                                                        22540020
         OI    LCBFLAG1,X20+IOBEXEP     ERP IN CNTRL FOR CLSE  @OX19180 22560000
         B     NAPCHAP                  EXIT                   @OX19180 22566000
ERPEXIT  EQU   *                                                        22580020
         OI    LCBFLAG1,IOBEXEP         SET FLAG TO ROUTE CONTROL TO    22600020
*                                         ERP                           22620020
         B     ERP                      EXIT                            22640020
         SPACE 3                                                        22660020
         AIF   ('&GEN' EQ 'BISC' OR '&GEN' EQ 'MINI').L42               22680020
         AIF   ('&GEN' EQ 'QTAM').L42                                   22700020
RTPREP   EQU   *                                                    TSO 22720020
         LA    RPREFIX,LCBERB           ELEMENT TO POST                 22740020
         MVI   PRFPRI,PRIDSPLB          LOW PRIORITY                    22760020
         L     RF,AVTTSOPT              ADDRESS OF TSO AREA             22780020
         L     RF,TSIHALT-IEDQTSI(,RF)  ADDRESS OF AYF                  22800020
         MVI   LCBSTAT1,LCBSENDN        CHANGE LINE STATUS      SA58997 22804022
         B     POSTEXIT                 BRANCH TO POST                  22820020
         SPACE 3                                                        22840020
RTWRBRK  EQU   *                                                    TSO 22860020
         L     RCCW,LCBLSPCI-1          GET ADDRESS OF BUFFER       TSO 22900020
         TM    PRFSTAT1-IEDQPRF(RCCW),PRFNHDRN IS IT FIRST BUFFER   TSO 22920020
         BO    RESCSW                   BRANCH ON NO                TSO 22940020
         L     RCCW,PRFIOADR-1-IEDQPRF(,RCCW) GET ADDRESS OF DATA   TSO 22960020
         CLI   1(RCCW),0                ANY DATA ENTERED            TSO 22980020
         BNE   RESCSW                   BRANCH IF YES          @OS79864 23000000
         MVI   LCBTSTSW,XF0             PREVENT TRY TO RECEIVE @OS79864 23005000
         B     CLEANUP                  AND GO TO CLEANUP      @OS79864 23010000
RESCSW   EQU   *                                                    TSO 23020020
         MVC   LCBCSW,LCBCSWSV .        RESTORE ENDING STATUS       TSO 23040020
         XC    LCBCSWSV,LCBCSWSV .      CLEAR IT                    TSO 23060020
         L     RCCW,LCBCSW-1            GET CSW CCW ADDR            TSO 23080020
         SH    RCCW,H8                  BACK UP TO INTERRUPTED CCW  TSO 23100020
         CLI   CCW,CCWBREAK             IS IT A WRITE BRK           TSO 23120020
         BE    CLEANUP                 BRANCH IF YES, GO CLEANUP    TSO 23140020
         TM    LCBTSOB,LCB2741N         IS IT A 2741?               TSO 23160020
         BZ    ITS1050                  BRANCH ON NO                TSO 23180020
         MVI   LCBCSW+3,CEDE            MOVE IN GOOD ENDING STATUS  TSO 23200020
         OI    SCBERR2,SCBABRTN         SET BREAK INT'D DATA   @OS77835 23210091
         B     TSO2 V                                               TSO 23220020
ITS1050  EQU   *                                                        23240020
         L     RCCW,LCBCSW-1 .          SEE IF A TIC                TSO 23260020
         CLI   CCW,CCWTIC .             WAS READ INTERRUPTED        TSO 23280020
         BNE   CLEANUP .                NO                          TSO 23300020
         MVI   LCBCSW+3,CEDE+UNEX       MOVE IN ENDING STATUS       TSO 23320020
         B     TSO2                                                 TSO 23340020
         SPACE                                                          23360020
.L42     ANOP                                                           23380020
         AIF   ('&GEN' EQ 'MINI').L42A                                  23400020
         AIF   ('&GEN' EQ 'STSP').L42A                                  23420020
         AIF   ('&GEN' EQ 'QTAM').L42A                                  23440020
RDLCOUT  EQU   *                                                        23460020
         L     RF,SCANAD                SCAN ADDRESS                    23480020
         BALR  RD,RF                    LINK TO ROUTINE                 23500020
         TM    SCBBSCFM,SCBTRNSP        TRANSPARENT            @OX16686 23505091
         BNO   RDLCENT                  BRANCH NO              @OX16686 23510091
         NI    LCBERCCW+1,AVTEFF-IN     FORCE LC OUT           @OX16686 23515091
RDLCENT  EQU   *                                                        23520020
         TM    LCBMSGFM,LCBEOT+LCBENQ . DLEEOT=SUM OF EOT AND ENQS21101 23540020
         BNO   NOTDLEOT                 BRANCH NO                       23560020
         MVI   LCBTSTSW,AVTEFF          FORCE NEW CONNECTION            23580020
         B     BSEOT                    USE EOT CODE                    23600020
NOTDLEOT EQU   *                                                        23620020
         TM    LCBMSGFM,LCBEOT .        EOT RECEIVED             S21101 23640020
         BZ    NOEOT                    BRANCH N                        23660020
         SPACE 1                                                SA68035 23666005
         BAL   RD,CHKNEG                SET NEG RESP IF NEEDED  SA68035 23672005
         SPACE                                                          23680020
BSEOT    EQU   *                                                        23700020
         L     RCCW,LCBCPA+12           CURRENT UNIT                    23720020
         L     RWKA,CCWADDR-1           DATA ADDRESS                    23740020
         MVC   0(1,RWKA),LCBERCCW+12    GET EOT INTO BUFFER             23760020
         MVI   LCBERCCW,NOPCI           SET ROUTINE PARAMETER           23780020
         BAL   RA,FINDBUFF              GET BUFFER BASE                 23800020
         LH    RC,PRFSIZE .             GET PREFIX SIZE          S21101 23820020
         LTR   RC,RC                    TEST ZERO LENGTH-POSSIBLES22025 23820822
*                                         IF ETB (ETX) WAS FIRST S22025 23821622
*                                         CHAR OF BUFFER AND WAS S22025 23822422
*                                         PROCESSED THROUGH MH   S22025 23823222
         BNZ   BUMPSIZE                                                 23824022
         L     RB,LCBDCBPT              GET DCB BASE             S22025 23824822
         IC    RC,DCBRESER+1-IHADCB(RB) ASSUME TEXT BUFFER       S22025 23825222
         LA    RA,AVTTXTSZ              FOR PRFSIZE              S22025 23825622
         TM    PRFSTAT1,PRFNHDRN        HEADER                   S22025 23826022
         BO    SETSIZE                  BRANCH IF TEXT BUFFER    S22025 23826422
         IC    RC,LCBISZE               GET HEADER RESERVES      S22025 23826822
         LA    RA,AVTHDRSZ              SET HEADER SIZE          S22025 23827222
SETSIZE  EQU   *                                                 S22025 23827622
         AR    RC,RA                    PREFIX SIZE + IDLES      S22025 23828022
BUMPSIZE EQU   *                                                 S22025 23828822
         LA    RC,ONE(,RC) .            BUMP FOR EOT             S21101 23830020
         BAL   RB,CKBFMM .              DONT WANT EOT IN BUFER IFS21101 23840020
*                                         NOT REAL EOM           S21101 23850020
         B     MHPOST .                 NOT REAL EOM             S21101 23860020
         B     LCINS                    DONT REMOVE THIS BRANCH  S99228 23870022
*                                       CKBFMM RETURNS HERE      S99228 23880022
.L42A    ANOP                                                           23900020
         SPACE 10                                                       23920020
*                                                                       23940020
*        WRITE RESPONSE (UNCHAINED) FOR RECEIPT OF MESSAGE FROM         23960020
* TERMINAL WHICH HAS NO CONTINUE CAPABILITY (1030/1060).                23980020
*                                                                       24000020
RTWRRSP  EQU   *                                                        24020020
         L     RCCW,LCBCPA+12          LAST SERVICED BUFFERR UNIT       24040020
         OI    LCBCSW+3,UNEX            INDICATE END OF MESSAGE         24060020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   24080020
         BAL RA,FINDBUFF                POST PREVIOUS BUFFERS AND       24100020
*                                         GET BUFFER BASE  FOR UNIT     24120020
         B     POSTMSG                  POST MESSAGE TO MH              24140020
         AIF   ('&GEN' EQ 'STSP').L42B                                  24160020
         AIF   ('&GEN' EQ 'MINI').L42B                                  24180020
         AIF   ('&GEN' EQ 'QTAM').L42B                                  24200020
 SPACE 5                                                                24220020
NOEOT    EQU   *                                                        24240020
         TM    LCBMSGFM,LCBENQ .        EQN RECEIVED             S21101 24260020
         BO    NOTTD                    BRANCH YES             @OZ31566 24280086
         SPACE                                                          24320022
         TM    LCBMSGFM,LCBTTD .        TTD                      S22025 24360022
         BO    ITSTTD .                 BRANCH IF YES            S22025 24400022
         SPACE                                                          24440022
         LA    RCCW,LCBCPA+24 .         ASSUME BAD DATA CHARACTERS22025 24480022
         NI    LCBMSGFM,LCBNAK+LCBACKI+LCBOLT REXET FLAGS        S22025 24520022
         B     EXIT3 .                  RESTART                  S22025 24560022
         SPACE                                                          24620020
ERLCOUT  EQU   *                        ERROR ENTRY                     24640020
.L42B    ANOP                                                           24660020
ERWRRSP  EQU   *                                                        24680020
         TM    LCBSTAT2,LCBMSGNN        MSGEN?                 @OY12676 24686091
         BO    RESETTM                  YES - RESET            @OY12676 24692091
         L     RCCW,LCBCPA+12           CURRENT CCW                     24700020
         OI    LCBCSW+3,UNEX            INDICATE END OF MESSAGE         24720020
POSTALL  EQU   *                                                        24740020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   24760020
         BAL   RA,FINDBUFF              LINK TO FREE UP RPEVIOUS        24780020
         B     ERRPOST                                                  24800020
         SPACE                                                          24820020
         AIF   ('&GEN' EQ 'BISC').L43                                   24840020
         AIF   ('&GEN' EQ 'MINI').L43                                   24860020
OPCHK    EQU   *                                                        24900020
         L     RF,OPCHKAD               GET ROUTINE ADDRESS             24920020
         BR    RF                             TSO                       24940020
 EJECT                                                                  24960020
.L43     ANOP                                                           24980020
*                                                                       25000020
* EXIT TO BUILD A WRITE EOT.  THIS EXIT EXPECTS TP OP CODE TO BE SET.   25020020
*                                                                       25040020
RESETEOT EQU   *                                                        25060020
          NI    SCBBSCFM,AVTEFF-SCBNOEOT RESET FLAG FOR SCHEULER S21101 25070020
*                                          ACTIVATE FOR BSC DIAL S21101 25072020
*                                          THAT RECEIVE OP IS NEXS21101 25074020
*                                          AND EOT WAS SENT      S21101 25076020
         MVI   LCBINCAM,0               CLEAR RETRY COUNT FOR RESET     25080020
         SR    RA,RA                   EOT INDEX                        25100020
         LA    RWKA,LCBCPA+16           CCW BUILD AREA                  25120020
         BAL   RD,CCWBLD               BUILD SEQUENCE                   25140020
         B     RESTCOM                 RESTART                          25160020
         SPACE 5                                               @OY10984 25180091
         AIF   ('&GEN' EQ 'MINI').L45                          @OY10984 25181091
         SPACE 5                                               @OY10984 25212091
*                                                                       25215091
* READ ID ENQ FOR BSC DIAL LINE.                                        25220020
*                                                                       25240020
         AIF   ('&GEN' EQ 'MINI').L45                                   25260020
         AIF   ('&GEN' EQ 'STSP').L44                                   25280020
         AIF   ('&GEN' EQ 'QTAM').L44                                   25300020
RTIDENQ  EQU   *                                                        25320020
         CLI   LCBINCAM,0               FIRST TIME                      25340020
         BNE   NOTSTEST                 BRANCH NOT FIRST TIME           25360020
         TS    LCBTSTSW                 HIO TO BE DONE                  25380020
         BNZ   CLEANUP                  YES                             25400020
NOTSTEST EQU   *                                                        25420020
         L     RF,CHACKAD               RESPONSE ROUTINE                25440020
         BALR  RD,RF                    LINK TO IT                      25460020
         CLI   LCBERCCW,RENQ            ENQ RECEIVED                    25480020
         BE    CHKID                    YES                             25500020
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             25520020
         BNL   DISCON                   BRANCH IF YES                   25540020
         SPACE                                                          25560020
TRYRDID  EQU   *                                                        25580020
         CLI   LCBINCAM,0               FIRST TIME                      25600020
         BNE   BUMP                     NO                              25620020
         MVC   LCBCSWSV,LCBCSW          SAVE CSW                        25640020
BUMP     EQU   *                                                        25660020
         IC    RA,LCBINCAM              GET RETRY COUNT                 25680020
         LA    RA,1(,RA)                BUMP                            25700020
         STC   RA,LCBINCAM              RESTORE                         25720020
         B     EXIT3                    RESTART ON READ ID ENQ          25740020
         SPACE                                                          25760020
CHKID    EQU   *                                                        25780020
         L     RF,IDCHKAD               CHECK ID RWOUINTE               25800020
         BALR  RD,RF                    LINK TO IT                      25820020
         B     EXIT2                    NORMAL REURN                    25840020
         B     TRYRDID                  RETRY READ ID                   25860020
         SPACE 10                                                       25880020
*                                                                       25900020
*        READ ID ACK-0 FOR BSC DIAL LINE.                               25920020
*                                                                       25940020
RTIDACK  EQU   *                                                        25960020
         L     RF,CHACKAD               RESPONSE ROUTINE                25980020
         BALR  RD,RF                    LINK TO IT                      26000020
         L     RF,IDCHKAD               CHECK ID RWOUINTE               26020020
         BALR  RD,RF                    LINK TO IT                      26040020
         B     CHKCPU                   DETERMINE WHERE TO RESTART      26060020
STWRENQ  EQU   *                                                        26080020
         MVI   LCBECBCC,PERMERR .       ASSUME RETRY EXHAUSTED   S21101 26090020
         CLI   LCBINCAM,RETRY .         IS RETRY EXHAUSTED       S21101 26092020
         BNL   ERIDACK .                BRANCH YES               S21101 26094020
         LA    RCCW,LCBCPA+40           WRITE ID(ENQ) CCW               26100005
         B     TRYRDID                  ATTEMPT RTETRY                  26120020
         SPACE                                                          26140020
CHKCPU   EQU   *                                                        26160020
         TM    LCBSTAT1,LCBRECVN        RECEIVE STE (DIAL UP OPTION)    26180020
         BO    EXIT2                    BRANCH YES                      26200005
         TM    CCWFLAGS,CCWSLI          THIS CPU OR END-END CTL         26220020
         BNZ   BSCADD                   BRANCH IF CPU                   26240005
         SPACE                                                          26260020
         TM    LCBERCCW,RACK0           ACK0 RECEIVED                   26280020
         BNO   STWRENQ                  NO RETRY ID ENQ                 26300020
         XI    LCBMSGFM,LCBACKI .       FLIP ACK COUNTER BACK    S21101 26320020
         B     EXIT2                    RESTART ON NEXT CCW             26340005
         SPACE 10                                                       26360020
.L44     ANOP                                                           26380020
*                                                                       26400020
*        READ ID FROM TWX                                               26420020
*                                                                       26440020
RTTWXID  EQU   *                                                        26460020
         TM    LCBSTAT1,LCBRECVN        DIAL UP OPTION                  26480020
         BO    EXIT2                    BRANCH YES                      26500020
         L     RF,IDCHKAD               ID SCAN ROUTINE                 26520020
         BALR  RD,RF                    LINK TO IT                      26540020
         B     ADDROK                   NORMAL RETURN                   26560020
         B     ERERROR                  INVALID ID                      26580020
         EJECT                                                          26600020
.L45     ANOP                                                           26620020
ERCLOSE  EQU   *                                                        26640020
*                                                                       26660020
*        RETURN FROM ERP AFTER IGE0904G HAS INTERFACED WITH OBR         26680020
* TO RECORD TEMPORARY ERROR COUNTERS IN TERMINAL ENTRIES.               26700020
*                                                                       26720020
         LA    RC,FREERQE               SET EXIT                        26740020
         B     POSTECB                  POST ECB FOR CLOSE              26760020
         SPACE 10                                                       26780020
*                                                                       26800020
*        ABORT RETURN FOR BOTH SEND AND RECEIVE OPERATIONS.  SEQUENCE   26820020
* INITIATED BY LINE END OR IEDQBT.                                      26840020
*                                                                       26860020
RTTXTRST EQU   *                                                        26880020
ERTXTRST EQU   *                                                        26900020
         TM    LCBSTAT1,LCBRECVN        RECEIVE STATE                   26920020
         BZ    ERRSPEB                  NO, IT'S SEND                   26940020
         SPACE                                                          26960020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   26980020
         L     RCCW,LCBCPA+12           LAST BUFFER                     27000020
         BAL   RA,FINDBUFF              LINK TO FREE UP RPEVIOUS        27020020
         B     ERRPOST                  POST BUFFER WITH ERROR          27040020
         SPACE 5                                               @OY14057 27060091
         AIF   ('&GEN' EQ 'STSP').L45A                         @OY14057 27061091
         AIF   ('&GEN' EQ 'MINI').L45A                         @OY14057 27062091
         AIF   ('&GEN' EQ 'QTAM').L45A                         @OY14057 27063091
RTRS3270 EQU   *                                               @OY14057 27064091
ERRS3270 EQU   *                                               @OY14057 27065091
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY           @OX16703 27065591
         MVI   LCBECBCC,PERMERR         MARK PERM ERROR        @OY14057 27066091
         MVI   LCBINCAM,RETRY           INSURE NO RETRIES      @OY14057 27067091
         ICM   RCCW,AD,LCBCPA+THIRTN    RESTORE TEXT CCW ADDR  @OY14057 27068091
         MVC   LCBCSW,LCBCSWSV          RESTORE CSW            @OY14057 27069091
         MVC   LCBSENS0(1),LCBSNSV      RESTORE SENSE          @OY14057 27070091
         MVI   LCBERCCW,NOPCI           FREE BUFFERS NOW       @OY14057 27071091
         BAL   RA,FINDBUFF              FREE PREVIOUS BUFFERS  @OY14057 27072091
         BAL   RB,SETCOUNT              GET EOB OFFSET         @OY14057 27073091
         STH   RC,PRFSIZE               SET SIZE IN BUFFER     @OY14057 27074091
         STCM  RPREFIX,AD,LCBRECAD      SAVE RECORD ADDRESS    @OY14057 27075091
         CLI   LCBCSW+6,0               RESIDUAL COUNT ZERO    @OY14057 27076091
         BE    RTRS3271                 YES, EOB AT END OF UNIT@OY14057 27077091
         LH    RD,CCWCOUNT              ORIGINAL COUNT         @OY14057 27078091
         SH    RD,LCBCSW+5              SUBTRACT RESIDUAL COUNT@OY14057 27079091
         L     RE,CCWADDR-1             DATA ADDRESS           @OY14057 27080091
         AR    RE,RD                    NEW DATA ADDRESS       @OY14057 27081091
         ST    RE,CCWADDR-1             SET NEW ADDRESS        @OY14057 27082091
         MVC   CCWCOUNT,LCBCSW+5        SET NEW COUNT          @OY14057 27083091
RTRS3271 EQU   *                                               @OY14057 27084091
         MVC   LCBCPA+16(8),CCW         SAVE UPDATED CCW       @OY14057 27085091
         B     ERRPOST1                 POST ERROR BUFFER      @OY14057 27086091
         SPACE 5                                               @OY14057 27087091
*                                                              @OY14057 27088091
.L45A    ANOP                                                  @OY14057 27089091
*        ERROR IN RESPONSE TO TEXT                                      27100020
*                                                                       27120020
ERRSPEB  EQU   *                                                        27140020
         TM    LCBSTAT2,LCBMSGNN        MSGGEN                          27160020
         BNZ   RESETTM                  BRANCH IF YES                   27180020
         L     RCCW,LCBCPA+12           UNIT ADDRESS                    27200020
HIOERR   EQU   *                                                        27220020
         AIF   ('&GEN' EQ 'MINI').M3                                    27240020
         AIF   ('&GEN' EQ 'STSP').M3                                    27260020
         AIF   ('&GEN' EQ 'QTAM').M3                                    27280020
         TM    SCBSTATE,SCBTRANP        TRANSPARENT                     27300020
         BZ    NOTTRNP                  BRANCH NO                       27320020
         SPACE                                                          27340020
         L     RCCW,LCBCPA+52           CURRENT CUNIT ADDRESS           27360020
         MVC   CCW+9(3),LCBCPA+57       LINK NEXT TO CURRENT            27380020
NOTTRNP  EQU   *                                                        27400020
.M3      ANOP                                                           27420020
         MVC   LCBNTXT(1),SCBDEOB       SAVE DISK OFFSET                27440020
         MVC   LCBRECAD(3),SCBDEOB+1    SAVE DISK RECORD ADDRESS        27460020
         MVC   LCBRECOF,SCBEOB          SAVE OFFSET INTO BUFFER         27480020
         MVC   LCBCPA+16(8),CCW         SAVE FOR POSSIBLE MH START      27500020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   27520020
         AIF   ('&GEN' EQ 'MINI').CONC2A                         S22026 27524022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 27528022
         BZ    FREEBUF                  BRANCH IF NO            SA57672 27532022
         TM    SCBERR4,SCBSLCTN         SELECTION ERROR         SA57672 27532522
         BZ    SENDERR                  BRANCH IF NO            SA57672 27533022
         NI    SCBERR4,AVTEFF-SCBSLCTN  RESET ERROR BIT         SA57672 27533522
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY            SA57672 27534022
         B     SENDERR                  GO POST WITH ERROR      SA57672 27534522
FREEBUF  EQU   *                                                SA57672 27535022
.CONC2A  ANOP                                                    S22026 27536022
         BAL   RA,FINDBUFF              LINK TO FREE UP RPEVIOUS        27540020
         NI    PRFSTAT1,X'FF'-PRFITCPN .RESET NOT REAL EOM       X01004 27550005
         B     SENDERR                  SEDN ERROR                      27580020
         SPACE 10                                                       27600020
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'QTAM' ).NTSO1    SA48276 27600722
         AIF   ('&GEN' EQ 'BISC' ).NTSO1                        SA48276 27601422
RTRSPMG  EQU   *                                                SA48276 27602122
ERRSPMG  EQU   *                                                SA48276 27602822
         CLI   LCBERCCW+12,X'06'        ACK RECEIVED            SA48276 27603522
         BE    ERBPOST                  MSGGEN RECEIVED OK IF SOSA48276 27604222
         MVI   LCBCSW+3,CEDE            SET GOOD ENDING STATUS  SA48276 27604922
         L     RWORK,LCBSTART-1         GET CCW                 SA48276 27605622
         L     RWORK,0(,RWORK)          ADDRESS OF DATA         SA48276 27606322
         CLC   0(3,RWORK),STARS         WAS IT ***              SA48276 27607022
         BNE   ERBPOST                  IF NOT, IGNORE IT       SA48276 27607722
         LH    RC,LCBTTCIN              GET CONNECTED INDEX     SA48276 27608422
         L     RA,AVTRNMPT              TERM NAME ROUTINE       SA48276 27609122
         USING IEDQTNTD,RA              ADDRESSABILITY          SA48276 27609822
         BAL   RPREFIX,TNTDCODE         GET TERM ENTRY ADDRESS  SA48276 27610522
         USING IEDQTRM,RB               ADDRESSABILITY          SA48276 27611222
         L     RB,TRMDESTQ-1            DESTINATION QCB ADDRESS SA48276 27611922
         DROP  RA,RB                    DROP UNUSED REGS        SA48276 27612622
         USING IEDQQCB,RB               ADDRESSABILITY FOR QCB  SA48276 27613322
         OI    QCBTSOF1,QCBSATRD        TO TRY AGAIN LATER      SA48276 27614022
         MVC   LCBTTBIN,LCBTTCIN        FOR RETRY               SA48276 27614722
         NI    QCBTSOF2,X'FF'-QCBSIMRD  FOR RETRY               SA48276 27615422
         DROP  RB                       THROUGH WITH QCB        SA48276 27616122
         B     ERBPOST                  OPERATION COMPLETE      SA48276 27616822
STARS    DC    X'4A4A4A'                THREE ASTERISKS SATRD   SA48276 27617522
         DS    0H                                               SA48276 27618222
.NTSO1   ANOP                                                   SA48276 27618922
*                                                                       27620020
*        SELECTION ERRORS.                                              27640020
*                                                                       27660020
NOGEN    EQU   *                                                        27680020
ERTWXID  EQU   *                                                        27700020
ERRSPENQ EQU   *                                                        27720020
ERRSPAD  EQU   *                                                        27740020
RTRESET  EQU   *                                                        27760020
ERIDENQ  EQU   *                                                        27780020
ERIDACK  EQU   *                                                        27800020
ERRESET  EQU   *                                                        27820020
ERERROR  EQU   *                                                        27840020
RTRSPAD  EQU   *                                                        27860020
         TM    LCBSTAT2,LCBMSGNN        MESSAGE GEN                     27880020
         BO    ERBPOST                  BRANCH YES                      27900020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE?          @SA71490 27904061
         BNE   REMO                     BRANCH NO              @SA71490 27908061
         MVI   LCBTSTSW,X'F0'           SET FOR NO NEW RECEIVE @SA71490 27912061
REMO     EQU   *                                               @SA71490 27916061
         OI    SCBERR4,SCBSLCTN        INDICATE SELECTION ERROR         27920020
         TM    LCBSTAT1,LCBRECVN         RECEIVE STATE                  27940020
         BZ    ADDERR                   ADDRESSING ERROR                27960020
         MVI   LCBTPCD+11,AVTEZERO      RESET SMI INDICATOR    @YA06316 27970061
         OI    LCBSTAT2,LCBNEGRP        INDICATE NEGATIVE RESPONSE      27980020
LOADBUF  EQU   *                                               @YA06889 27990061
         L     RPREFIX,LCBLSPCI-1       POST FIRST BUFFER TO BD         28000020
         AIF   ('&GEN' NE '' AND '&GEN' NE 'BISC').M3A           S21101 28010020
         TM    SCBQTYPE,SCBBFMM .       ARE WE ATTEMPTING TO READS21101 28012020
*                                         SUBSEQUNET PART OF MSG S21101 28014020
*                                         E.G. LMD OR ENQ MODE   S21101 28016020
         BO    POSTPERM .               BRANCH YES, ERP HAS SET  S21101 28018020
*                                         HEADER TO TEXT AND SET S21101 28018420
*                                         PRFSIZE TO REFLECT EOT S21101 28018820
*                                         MOVED INTO BUFFER      S21101 28019220
.M3A     ANOP .                                                  S21101 28019620
MHERR    EQU   *                                                        28020020
         SR    RC,RC                    CLEARF OR 0 LENGTH BUFFER       28040020
         STH   RC,PRFSIZE               CLEAR PREFIX SIZE               28060020
POSTPERM EQU   * .                                               S21101 28070020
         NI    PRFSTAT1,PRFNLSTF        MARK IT LAST                    28080020
         MVI   PRFPRI,PRIMHBFR-1        SET POST PRIORITY               28100020
         B     POSTERR                  POST IT TO MH                   28120020
*                                       MHAND EXIT                      28140020
         SPACE 3                                                        28160020
ADDERR   EQU   *                                                        28180020
         ICM   RCCW,AD,LCBLSPCI         IS BUFFER ASSIGNED       Y01948 28200005
         BNZ   HIOERR                   BRANCH IF YES                   28240020
         SPACE                                                          28260020
         ICM   RA,AD,LCBERBCH           BUFFERS POSTED TO MH     Y01948 28280005
         BZ    GOIDLES                  YES, WAIT FOR BUFFERS           28300020
         OI    SCBERR4,SCBSLCTN .      SET SELECTION ERROR      SA44893 28310022
         AIF   ('&GEN' EQ 'MINI').M4                                    28320020
         CLI   LCBECBCC,PERMERR         HARD ERROR                      28340020
         BNE   NOREDIAL                 BRANCH NO                       28360020
         MVI   LCBTSTSW,AVTEFF          ENSURE A RE-DIAL                28380020
         OI    LCBSTAT2,LCBNEGRP        SET NEGATIVE RESPONSE-          28400020
*                                       OF DIAL OUT CALL Q              28420020
NOREDIAL EQU   *                                                        28440020
.M4      ANOP                                                           28460020
         L     RD,PRFLINK-1-IEDQPRF(,RA) GET NEXT BUFFER -RETURN        28500020
ERRLOOP  EQU   *                                                        28520020
         LA    RD,0(,RD)                CLEAR HI ORDER BYTE             28540020
         LTR   RPREFIX,RD               ANOTHER BYFFER                  28560020
         BZ    NONE                     BRANCH NO                       28580020
         SPACE                                                          28600020
         L     RD,PRFLINK-1-IEDQPRF(,RD) SAVE LINK FIELF                28620020
         MVI   PRFPRI,PRILNEND          SET POST PRIORITY               28640020
         LA    RF,AVTBFRTB              QXB FOR POST                    28660020
         BAL   RC,ENQUEUE               PUT ON READY Q                  28680020
         B     ERRLOOP                  GET NEXT BUFFER                 28700020
         SPACE  2                                                       28720020
NONE     EQU   *                                                        28740020
         XC    LCBERBCH(3),LCBERBCH     CLEAR FIELD                     28760020
         LR    RPREFIX,RA               GET 1ST BUFFER SAVED            28780020
         NC    LCBTTCIN,LCBTTCIN        IS DESTINATION DETERMND@OX17153 28800000
         BZ    NOLMT                    NO, NOT BUFFER BUSY    @OX17153 28800100
         STM   RPREFIX,RC,CNTSAVE       SAVE REGS              @OX17153 28800200
         LH    RC,LCBTTCIN              TERMINAL OFFSET        @OX17153 28800300
         L     RA,AVTRNMPT              TNT CODE BASE          @OX17153 28800400
         USING IEDQTNTD,RA                                     @OX17153 28800500
         BAL   RPREFIX,TNTDCODE         FIND TERMINAL TYPE     @OX17153 28800600
         USING IEDQTRM,RB                                      @OX17153 28800700
         L     RB,TRMDESTQ-1            GET QCB ASSRESS        @OX17153 28800800
         USING IEDQQCB,RB                                      @OX17153 28800900
         TM    QCBELCHN+2,QCBCNTEN      UNUSUAL ADDRESSING RESP@OX17153 28801000
         LM    RPREFIX,RC,CNTSAVE       RESTORE REGS           @OX17153 28801100
         DROP  RA,RB                                           @OX17153 28801200
         BZ    NOLMT                    NO, THIS IS NOT BUFF BUSY       28820020
         SPACE                                                          28840020
         AIF   ('&GEN' EQ 'MINI').M5                                    28860020
         AIF   ('&GEN' EQ 'STSP').M5                                    28880020
         AIF   ('&GEN' EQ 'QTAM').M5                                    28900020
         TM    SCBERR1,SCBRVISL         RVI TO SELECTION                28920020
         BZ    NORVISL                  NO                              28940020
         OI    LCBCHAIN,LCBNORTY        TEXT ERROR AND NO RETRY         28960020
         B     SENDERR                  POST TO MH                      28980020
         SPACE                                                          29000020
NORVISL  EQU   *                                                        29020020
.M5      ANOP                                                           29040020
         MVC   SCBDEOB+1(3),PRFCRCD     FOR BUFFER BUSY -BUFF TERM      29060020
         MVC   SCBDEOB(1),PRFNTXT       SXBDEOB UPDATED BY FA           29080020
         STCM  RA,AD,LCBLSPCI .         SET BUFFER ADDRESS       X01004 29120005
         OI    PRFSTAT1-IEDQPRF(RA),PRFITCPN NOT REAL END OF MSG X01004 29140005
         AIF   ('&GEN' EQ 'MINI').CONC2B .                       S22026 29183022
         TM    SCBQTYPE,SCBCONC .      CONCENTRATOR              S22026 29186022
         BO    MHERR .                 BRANCH IF YES             S22026 29189022
.CONC2B  ANOP .                                                  S22026 29192022
         NI    SCBERR4,SCBSLCTF .      TURN OFF SELECTION ERROR  S22026 29195022
         LA    RA,AVTBFRTB              SET SCBDESTQ TO BUFFER          29200020
*                                         RETURN IN EVENT ERROR         29220020
*                                         OCCURS ON NEXT OPERATION      29240020
*                                         ZERO LENGTH BUFFER WILL       29260020
*                                         NOT BE QUEUED.                29280020
         STCM  RA,AD,SCBDESTQ .         SET UP DEST. Q ADDRESS   Y01948 29300005
         B     CLEANUP                  POST TO DISPOSTIION             29360020
NOLMT    EQU   *                                                        29380020
         NI    SCBQTYPE,AVTEFF-SCBBFMM  RESET MIDDLE OF MSG BIT         29400020
         B     MHERR                    YES, ERROR EXIT                 29420020
         EJECT                                                          29480020
RTEAU    DS    0H                                                S99228 29481022
         L     RPREFIX,LCBLSPCI-ONE     1ST BUFFER ADDR          S99228 29482022
         LA    RPREFIX,ZERO(RPREFIX)    CLEAR HO BYTE            S99228 29483022
         NI    PRFSTAT1,PRFNLSTF        MARK BUFFER AS LAST      S99228 29484022
         OI    LCBERBST,LCBERROR        INDICATE ERROR CONDITION S99228 29485022
*                                       SO BD WILL FREE ALL      S99228 29486022
*                                       BUFFERS                  S99228 29487022
*                                                                S99228 29488022
*        USE POST EXIT FROM LINE END                             S99228 29489022
*                                                                S99228 29490022
         MVI   PRFPRI,PRILNEND          SET POST PRIORITY        S99228 29491022
         L     RF,AVTBSCAN              ADDRESS OF BFR DISP      X02004 29492005
         B     POSTEXIT                 EXIT                     S99228 29494022
         EJECT                                                   S99228 29495022
TEXT     EQU   *                                                        29500020
         MVI   LCBTSTSW,XF0             FOR 2260L AND DIAL              29520020
         LA    RWKA,LCBERCCW+8          THIS OWED RESPONSE              29540020
*                                         WRITE ACK (NAK)               29560020
         CLR   RWKA,RCCW                THIS THE ERRROR                 29580020
         BNE   NOTCONV                  BRANCH IF NO                    29600020
         SPACE                                                          29620020
         LA    RCCW,LCBCPA+16           SET NEW START ADDRES            29640020
         MVI   LCBINCAM,0               RESET RETRY COUNT               29660020
         B     EXIT3                    EXIT FOR RESTART                29680020
NOTCONV  EQU   *                                                        29700020
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'STSP' OR '&GEN' EQ 'QTAMC29704005
               ').M66                                           SA68035 29708005
         BAL   RD,CHKNEG                SET NEG RESP IF NEEDED  SA68035 29712005
.M66     ANOP                                                   SA68035 29716005
         CLI   CCWOPCDE,CCWTIC          CCW A TC - PROG CHECK           29720020
         BNE   NOTIC                    BRANCH IF NO                    29740020
         AIF   ('&GEN' EQ 'MINI').LR40                                  29740522
         TM    LCBSTAT1,LCBRECVN        RECEIVE STATE?           S99228 29741022
         BZ    NODEV                    NO PCI RECVY ON SEND     S99228 29742022
         L     RF,LOOKAD .              LOAD ADDR DVCCSTCS       S99228 29742222
         BALR  RD,RF .                  LINK TO ROUTINE          S99228 29742422
         ST    RE,AVTDOUBX+FOUR .       SAVE INVLIST CWORD ADDR  S99228 29742622
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 29743022
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 29743822
         BZ    NODEV                    BRANCH NO                S99228 29744622
         TM    LCBDCT2,CLOCAL           LOCAL DEVICE?            S99228 29745422
         BZ    NODEV                    BRANCH NO                S99228 29746522
         L     RDCB,LCBDCBPT            SET DCB ADDR             S99228 29747022
         USING IHADCB,RDCB                                       S99228 29748022
         TM    DCBPCI,RCVPCI            TEST FOR REC PCI         S99228 29749022
         DROP  RDCB                                              S99228 29750022
         BZ    NODEV                    NO LOCAL PCI SPEC        S99228 29751022
         SR    RB,RB                    CLEAR RETRY COUNT REG    S99228 29752022
         IC    RB,LCBPCIRC              INSERT PCI RETRY COUNT   S99228 29753022
         LA    RB,ONE(R0,RB)            INCREMENT RETRY COUNT    S99228 29754022
         STC   RB,LCBPCIRC              STORE INCREASED COUNT    S99228 29755022
         CLI   LCBPCIRC,THREE           COUNT AT MAXIMUM?        S99228 29756022
         BNH   RESTART                  RETRY AGAIN              S99228 29757022
NODEV    EQU   *                                                 S99228 29758022
.LR40    ANOP                                                           29759022
         SH    RCCW,H8                  BACK UP TO CCW                  29760020
         MVI   LCBCSW+6,0               INDICATE END OF BUFFER          29780020
         SPACE                                                          29800020
NOTIC    EQU   *                                                        29820020
         L     RD,AVTSAVEX+TWLVE .      DEB ADDRESS              X01004 30000005
         L     RD,DEBAPPAD-DEBNMSUB(,RD) .  APPENDAGE TABLE.     X01004 30010005
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'QTAM').ME2        X02004 30020005
         TM    TWO(RD),X80              IS ALTMH SPECIFIED       X02004 30030005
         BZ    OWNMHLC                  BRANCH NO                S22029 30064022
         NC    LCBTTCIN,LCBTTCIN        IS CONNECTED INDEX ZERO  S22029 30065022
         BZ    OWNMHLC                  YES - USE OWNING MH LC   S22029 30066022
         L     RWKA,FNDQCBAD .          GET ADDR OF ROUTINE USED S22029 30067022
*                                       TO FIND THE DEST QCB     S22029 30068022
         BALR  RE,RWKA .                GET DEST QCB ADDRESS     S22029 30069022
         LR    RE,R0 .                  FOR CONNECTED MH TEST    S22029 30070022
         TM    QCBDSFLG-IEDQQCB(RE),QCBALTMH IS TERMINAL         S22029 30071022
*                                       CONNECTED TO ALTMH       S22029 30072022
         BZ    OWNMHLC .                NO - USE OWNING MH LC    S22029 30073022
         LA    RD,ONE(,RD)              USE ALTMH OPTIONS        X02004 30074005
OWNMHLC  EQU   * .                                               S22029 30075022
.ME2     ANOP                                                           30076022
         MVC   LCBERCCW+ONE(ONE),0(RD) .STARTMH OPTION BITS      X01004 30080005
         LA    RCCW,AVTEZERO(,RCCW)     CLEAR HI ORDER BYTE             30120051
         AIF   ('&GEN' EQ 'MINI').Z7                                    30123051
         CLI   LCBCPA+24,CCWPOLL        HEADER ON AUTOPOLL              30126051
         BE    AUTOSRC                  YES-DETERMINE SOURCE    SA59028 30129051
         L     RF,LCBDCBPT              LOAD DCB OFFSET         SA64386 30129705
         CLI   DCBEIOBX-IHADCB(RF),X'C8'  LCB LESS THAN C8 LONG SA64386 30130405
         BL    RESUME                   YES, SKIP AUTOPOLL TEST SA64386 30131105
         CLI   LCBCPA+53,AVTEFF         ERP FOR AUTOPOLL DONE   SA59028 30132051
         BNE   RESUME                   NO - NOT AUTOPOLL       SA66604 30135005
AUTOSRC  EQU   *                        AUTO SECTION                    30195022
         SPACE                                                          30200020
         L     RF,POLLAD                ATUOPOLL SOURCE ROUINE          30220020
         BALR  RD,RF                    LINK TO IT                      30240022
RESUME   EQU   *                                                        30241022
         L     RF,LOOKAD .              LOAD ADDR DVCCSTCS       S99228 30242022
         BALR  RD,RF .                  LINK TO ROUTINE          S99228 30243022
         ST    RE,AVTDOUBX+FOUR .       SAVE INVLIST CWORD ADDR  S99228 30244022
         L     RE,AVTDOUBX .            LOAD LCB EXTENSION ADDR  S99228 30245022
         TM    LCBDCT1,C3270 .          3270 DEVICE              S99228 30246022
         BZ    NOCOUNT .                BRANCH IF NO             S99228 30247022
         TM    LCBDCT2,CLOCAL           LOCAL DEVICE             S99228 30248022
         BZ    NOCOUNT .                BRANCH IF NO             S99228 30249022
         MVI   LCBPCIRC,ZERO .          RESET PCI RETRY COUNT    S99228 30250022
NOCOUNT  EQU   *                                                 S99228 30251022
.Z7      AIF   ('&GEN' NE '').L49                                       30280020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        30300020
         BZ    NOTBSC                   NOT BSC                         30320020
.L49     AIF   ('&GEN' EQ 'STSP').L50                                   30340020
         AIF   ('&GEN' EQ 'MINI').L50                                   30360020
         AIF   ('&GEN' EQ 'QTAM').L50                                   30380020
         TM    LCBSTAT1,LCBRECVN        RECEIVE OPERATION               30400020
         BZ    NOTREAD                  NO                              30420020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 30440020
         BE    NOTBSC                   YES, SKIP SCAN                  30460020
         TM    LCBMSGFM,LCBVSTRT+LCBRSTRT >TART BITS ALREADY CHECS21101 30480020
         BNZ   NORM                     YES                             30500020
         L     RF,SCANAD                SCAN ADDRESS                    30520020
         BALR  RD,RF                    LINK TO ROUTINE                 30540020
         SPACE                                                          30560020
NORM     EQU   *                                                        30580020
         TM    LCBMSGFM,LCBEOT+LCBENQ . DLEEOT=SUM OF EOT AND ENQS21101 30600020
         BNO   NOHANGUP                 BRANCH NO                       30620020
         MVI   LCBTSTSW,AVTEFF          FORCE NEW CONNECTION NEXT       30640020
         B     NOTBSC                   CONTINUE PROCESSING             30660020
NOHANGUP EQU   *                                                        30680020
         TM    LCBMSGFM,LCBOLT .        OLT REQUEST              S21101 30700020
         BZ    NOOLT                    BRANCH IF NO                    30720020
         MVI   LCBERCCW+1,IN            FORCE LCIN AND READ TILL EOT    30740020
NOOLT    EQU   *                                                        30820020
         TM    SCBBSCFM,SCBTRNSP        RECEIVE TRANSPARENT             30840020
         BZ    DONTSET                  NO                              30860020
         SPACE                                                          30880020
         NI    LCBERCCW+1,AVTEFF-IN     FORCE LCOUT FOR TRANSPARENT     30900020
DONTSET  EQU   *                                                        30920020
         SPACE                                                          30940020
         TM    LCBMSGFM,LCBTTD .        TTD RECEIVED             S21101 30960020
         BZ    NOTTD                    NO                              30980020
         SPACE                                                          31000020
GOTTTD   EQU   * .                                              SA44892 31005022
ITSTTD   EQU   * .                                               S22025 31010022
         OI    LCBMSGFM,LCBNAK .        RESPONE FOR TTD          S21101 31020020
         LA    RWKA,GOEXIT              SET EXIT ADDRESS       @OZ09279 31021091
SRCPCI   EQU   *                                               @OZ09279 31022091
         SR    RC,RC                    CLEAR FOR INSERT       @OZ09279 31023091
         ICM   RC,AD,LCBLSPCI           GET LAST PCI BUFFER    @OZ09279 31024091
SRCPCI1  EQU   *                                               @OZ09279 31025091
         CLM   RC,AD,LCBCPA+13          IS IT LAST INTERR UNIT @OZ09279 31026091
         BCR   8,RWKA                   BRANCH YES             @OZ09279 31027091
         CLI   TICEND(RC),TWO           END OF CHANNEL PROGRAM?@OZ09279 31028091
         BE    SETPERM                  YES-PERMANENT ERROR    @OZ09279 31029091
         ICM   RC,AD,PRFTIC+1-IEDQPRF(RC) NEXT LSPCI CHAIN UNIT@OZ09279 31030091
         B     SRCPCI1                  SEARCH LCBLSPCI CHAIN  @OZ09279 31031091
SETPERM  EQU   *                                               @OZ09279 31032091
         MVI   LCBECBCC,PERMERR         SET PERMANENT ERROR    @OZ09279 31033091
         OI    SCBERR3,SCBFORMN         SET FORMAT ERROR       @OZ09279 31034091
         OI    SCBERR4,SCBTXTTN         SET TEXT ERROR         @OZ09279 31035091
         OI    LCBMSGFM,LCBRSTRT        SET INVALID START      @OZ09279 31036091
         NI    LCBMSGFM,AVTEFF-LCBVSTRT-LCBENQ-LCBTTD-LCBNAK   @OZ09279 31037091
         B     NOCKEND                  EXIT                   @OZ09279 31038091
         SPACE                                                          31120020
NOTTD    EQU   *                                                        31140020
         TM    LCBMSGFM,LCBENQ .        EQN RECEIVED             S21101 31160020
         BZ    NOTBSC                   NO                              31180020
         CLI   LCBINCAM,RETRY           RETRY EXHAUSTED         SA61094 31181005
         BL    BUMPIT                   BR, NO SEND ACK AGAIN   SA61094 31182005
         MVI   LCBINCAM,AVTEZERO        RESET ENQ COUNTER       SA61094 31183005
         OI    LCBCHAIN,LCBABRTN        SEND AN EOT             SA61094 31184005
         B     ITSENQ                   BR                      SA61094 31185005
BUMPIT   EQU   *                                                SA61094 31186005
         SR    RWKA,RWKA                CLEAR FOR INSERT       @OZ09279 31187091
         IC    RWKA,LCBINCAM            GET RETRY COUNT        @OZ09279 31187791
         LA    RWKA,ONE(RWKA)           BUMP BY ONE            @OZ09279 31188491
         STC   RWKA,LCBINCAM            UPDATE COUNT           @OZ09279 31189191
ITSENQ   EQU   * .                                               S22025 31190022
         BAL   RWKA,SRCPCI              CHECK PCI CHAIN        @OZ09279 31195091
         OI    LCBMSGFM,LCBNAK          REQUEST TO SEND NAK    @SA75453 31200000
         L     RWKA,LCBCPA+16           DATA ADDRESS           @SA75453 31202000
         L     RA,LCBDCBPT              GET DCB ADDRESS        @SA75453 31204000
         USING IHADCB,RA                                       @SA75453 31206000
         L     RC,DCBSCTAD-1            SPECIAL CHARACTERS     @SA75453 31208000
         DROP  RA                                              @SA75453 31210000
         SR    RA,RA                    CLEAR WORK REGISTER    @SA75453 31212000
         IC    RA,NAKCH(RC)             NAK INDEX              @SA75453 31214000
         LA    RC,1(RA,RC)              NAK SEQUENCE           @SA75453 31216000
         CLC   0(1,RWKA),0(RC)          TEST FOR NAK SENT      @SA75453 31218000
         BE    GOEXIT                   YES, REBUILD NAK       @XA11162 31220000
         XI    LCBMSGFM,LCBNAK+LCBACKI  TURN OFF NAK AND FLIP  @SA75453 31225000
*                                        ACK COUNTER           @SA75453 31230000
GOEXIT   EQU   *                                                        31235091
         L     RCCW,LCBCPA+12                                           31236091
         MVC   LCBCPA+16(8),CCW         SAVE CCW                        31237091
         B     GOIOGEN                  EXIT TO RESTART                 31238091
         SPACE                                                          31240020
NOTREAD  EQU   *                                                        31260020
         L     RF,BSC27AD                                        S22027 31265022
         BR    RF                                                S22027 31285022
.L50     ANOP                                                           31320020
         EJECT                                                          31340020
NOTBSC   EQU   *                                                        31360020
*                                                                       31380020
*    THE FOLLOWING CODE ESTABLISHES THE TRUE ENTERRUPTED CCW IN         31400020
* RCCW.  (THIS ACCOUNTS FOR THE CASE OF AN EOB OCCURRING IN THE         31420020
* LAST POSITION OF A UNIT.)  RPREFIX IS ALSO ESTABLISHED TAKING         31440020
* INTO CONSIDERATION THAT A PCI MIGHT HAVE BEEN MISSED OR THAT PCI      31460020
*        IF PCI IS NOT USED ON RECEIVE OPERATIONS, ALL BUFFERS UP TO    31480020
* THE ONE WHICH PRESENTED AN EOB OR ETB INTERRUPT ARE POSTED TO MH.     31500020
* SIMILARLY, BUFFERS ARE POSTED TO THE AVAILABLE BUFFER QUEUE  FOR      31520020
* OUTPUT OPERATIONS.                                                    31540020
*                                                                       31560020
* IS NOT USED.                                                          31580020
         AIF   ('&GEN' EQ 'MINI').CONC3                          S22026 31581022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 31582022
         BNO   NOTCONCC .               BRANCH IF NO             S22026 31583022
         STCM  RCCW,AD,SCBXTRA          INTERRUPTED UNIT         Y01948 31587005
SAVECCW  EQU   * .                                               S22026 31592022
         MVC   SCBXTRA+3(8),0(RCCW) .   SAVE CCW                 S22026 31593022
         CLI   LCBINCAM,ZERO .          ERROR RECOVERY           S22026 31594022
         BNE   NOTCONCC .               BRANCH IF YES            S22026 31595022
         MVC   SCBXTRA+11(4),LCBCPA+12 .SAVE TEXT START          S22026 31596022
NOTCONCC EQU   * .                                               S22026 31597022
.CONC3   ANOP                                                    S22026 31598022
         L     RE,LCBLSPCI-1            LAST SERVICEC  BUFFER           31600020
         LA    RE,0(,RE)                CLEAR HI ORDER BYTE             31620020
         LR    RPREFIX,RE               COPY BUFFER ADDRESS             31640020
         CLC   CCWCOUNT+1(1),LCBCSW+6   RESIDUAL COUNT EQ ORIGINAL      31660020
         BNE   NOTEQ                    NO                              31680020
         CLI   CCWCOUNT+1,AVTEZERO      WAS ORIG COUNT ZERO    @OS76271 31683091
         BNE   ORIZERO                  BRANCH-NO CONTINUE     @OS76271 31686091
         MVI   LCBECBCC,PERMERR         SET PERM ERROR         @OS76271 31689091
         B     NOTEQ                    GO HANDLE CPC          @OS76271 31692091
ORIZERO  EQU   *                                               @OS76271 31695091
         LA    R0,ONE                   LOAD A POSITIVE VALUE           31700020
         CLR   RE,RCCW                  BUFFER SAME AS CURRENT CCW      31720020
         BNE   CKBUF                    BRANCH IF NO                    31740020
         TM    LCBSTAT1,LCBSENDN        SEND SIDE                       31760020
         BO    LASTBUF                  BRANCH IF YES                   31780020
         LNR   R0,R0 .                  REMEMBER CONDITON               31800020
CKBUF    EQU   *                                                        31820020
         L     RF,LCBCPA+12             LAST TEXT CCW                   31840020
         LA    RF,0(,RF)                CLEAR HI ORDER BYTE             31860020
         CR    RF,RCCW                  SAME AS ENDING CCWIN CSW        31880020
         BNE   LOOPCT                   BRANC NO                        31900020
         TM    LCBSTAT1,LCBSENDN        SEND SIDE                       31920020
         BO    LOOPCT                   YES                             31940020
         AIF   ('&GEN' EQ 'STSP').M6                                    31960020
         AIF   ('&GEN' EQ 'MINI').M6                                    31980020
         AIF   ('&GEN' EQ 'QTAM').M6                                    32000020
         CLI   LCBTPCD+3,TPRDLC         READ LC OUT                     32020020
         BNE   NORDLC                   BRANCH IF NO                    32040020
         TM    CCWFLAGS,CCWSLI          SAME CCW AS LAST RESTART OR     32060020
*                                         HAVE WE WRAPPED AND UNIT      32080020
*                                         BEEN RE-USED                  32100020
         BZ    RDLCENT                  BRANCH IF NOT WRAPPED           32120020
         B     LOOPCT                   WRAPPED CONDITION               32140020
NORDLC   EQU   *                                                        32160020
.M6      ANOP                                                           32180020
         TM    PRFSTAT1-IEDQPRF(RE),PRFNHDRN HEADER BUFFER-POSSIBLE     32200020
*                                         NO IF HEADER BUFFER IS RE-    32220020
*                                         USED VIA PCI                  32240020
         BO    TSTSLI                   YES                             32260020
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'BISC').M61               32280020
         AIF   ('&GEN' EQ 'QTAM').M61                                   32300020
         TM    LCBTSOB,LCBTSBUF         IS THIS TIME SHARING BUFFER TSO 32320020
         BO    NOTEQ                    BRANCH ON YES               TSO 32340020
.M61     ANOP                                                           32360020
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION                  32380020
         BZ    NOTEQ                    NO, TRUE CCW SET                32400020
         SPACE                                                          32420020
         B     RTPOLL                   BUMP POLLING POINTER            32440020
TSTSLI   EQU   *                                                        32460020
         TM    CCWFLAGS,CCWSLI          HAVE E WRAPPED                  32480020
         BZ    NOTEQ                    NO                              32500020
         SPACE                                                          32520020
LOOPCT   EQU   *                                                        32540020
         LTR   R0,R0 .                  LSCPI SAMEAS ENDING CCW         32560020
         BM    NOTEQ                    BRANCH IF YES                   32580020
LOOPCT1  EQU   *                                                        32600020
         LR    RD,RE                    SAVE PRECIOUS CCW               32620020
         L     RE,8(,RE)                NEXT CCW IN CHAIN               32640020
         LA    RE,0(,RE)                CLEAR FOR CMPARE                32660020
         CR    RE,RCCW                  THIS INTERRUPTED CCW            32680020
         BNE   LOOPCT1 .                NO, LOOK AT NEXT                32700020
         MVC   LCBCPA+16(8),0(RE)       SAVE CONTINUE CCW      @SA71963 32710061
         SPACE                                                          32720020
         LA    RCCW,0(,RD)              TRUE ENDING CCW                 32740020
         MVI   LCBCSW+6,0               CLEAR RESIDUAL COUNT            32760020
         AIF   ('&GEN' EQ 'MINI').CONC3A                         S22026 32762022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 32764022
         BNO   NOTCONCE .               BRANCH IF NO             S22026 32766022
         MVC   SCBXTRA+3(8),0(RCCW) .   SAVE CCW                 S22026 32768022
         STCM  RCCW,AD,SCBXTRA          SET INTERRUPTED UNIT     Y01948 32768505
NOTCONCE EQU   * .                                               S22026 32770022
.CONC3A  ANOP                                                    S22026 32772022
         SPACE                                                          32780020
NOTEQ    EQU   *                                                        32800020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 32820020
         AIF   ('&GEN' NE '').Z81                                       32840020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        32860020
         BZ    NOCKEND                  NO                              32880020
.Z81     AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').Z8                32900020
         AIF   ('&GEN' EQ 'QTAM').Z8                                    32920020
         SPACE                                                          32940020
         BAL   RC,FINDEOB  .            GET ADDRESS OF LAST CHAR S99228 32960022
         BAL   RC,CKEND  .              CHECK START AND END CHAR S99228 32961022
NOCKEND  EQU   *                                                 S99228 32962022
.Z8      ANOP                                                    S99228 32963022
         AIF   ('&GEN' EQ 'QTAM' OR '&GEN' EQ 'MINI').LL45       S99228 32963522
         TM    LCBSTAT1,LCBRECVN        RECEIVE STATE?           S99228 32964022
         BZ    NOGPOLL                  NO SKIP GENPOLL TEST     S99228 32965022
         TM    LCBFLAG3,LCBOBRRD        SOH%R MESSAGE FOR OBR?   S99228 32965322
         BO    NOGPOLL                  BRANCH YES               S99228 32965622
         NC    LCBTTCIN(2),LCBTTCIN     POLLRT DETERMINE INVALID S99228 32966022
*                                       SOURCE?                  S99228 32967022
         BZ    NOGPOLL                  SOURCE ZERO TREAT AS SPECS99228 32968022
*                                       POLL                     S99228 32969022
SLOWPOLL EQU   *                                                 S99228 32971322
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 32971622
         TM    LCBDCT1,CUMASK           GENERAL POLL IN PROGRESS?S99228 32972022
         BZ    NOGPOLL                  NO BYPASS SOURCE DETERM  S99228 32973022
         TM    LCBMSGFM,LCBOLT          TRM PRESENT?             S99228 32973322
         BO    SRCSET                   BRANCH YES               S99228 32973622
         TM    LCBXFLAG,LCBSRCPF        SRC DETERM PERFORMED?    S99228 32974022
         BO    SRCCOMP                  YES, SKIP SRC DET        S99228 32975022
         LA    RA,LCBCPA+40 .           LOAD ADDR TCBUF CCW      S99228 32976022
         CLI   LCBCPA+24,CCWNOP         AUTOPOLL IN PROGRESS?   SA66598 32977005
         BL    MANUAL                   NO, PROGRAM POLL        SA66598 32977105
         SR    RC,RC                    CLEAR FOR IC            SA66598 32977205
         L     RF,LCBDCBPT              GET DCB ADDRESS         SA66598 32977305
         IC    RC,LCBUCBX               GET RLN                 SA66598 32977405
         SLL   RC,TWO                   MULTIPLY BY FOUR        SA66598 32977505
         L     RC,DCBINVLI-IHADCB(RC,RF) GET ILIST ADDRESS      SA66598 32977605
         TM    THREE(RC),AUTOPL         AUTOPOLL IN PROGRESS    SA66598 32977705
         BZ    MANUAL                   NO, PROGRAM POLL        SA66598 32977805
         CLI   LCBCPA+48,CCWPOLL        IS THIS FIRST HEADER    SA66598 32977905
         BNE   MANUAL                   NO, MANUAL POLL         SA66598 32978005
         MVI   LCBCPA+48,CCWNOP         NOP FOR NEXT HEADER     SA66598 32978105
         LA    RA,LCBCPA+72 .           LOAD ADDR TCBUF CCW      S99228 32979022
MANUAL   EQU   *                                                 S99228 32981022
         L     RWKA,ZERO(R0,RA)         LOAD BUFFER ADDRESS      S99228 32984022
         L     RF,SORCEAD               LOAD SOURCE ROUTINE ADDR S99228 32985022
         BALR  RD,RF                    BRANCH TO SRC DET RTN    S99228 32986022
SRCSET   EQU   *                                                 S99228 32986322
         OI    LCBXFLAG,LCBSRCPF        INDICATE SRC DETERMINED  S99228 32986622
SRCCOMP  EQU   *                                                 S99228 32987022
         AIF   ('&GEN' EQ 'STSP').LL4B                           S99228 32987522
         TM    LCBSTAT2,LCBSYNC         BSYNC LINE               S99228 32988022
         BZ    NOCHECK                  NO, BYPASS LINE CON CHECKS99228 32989022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 32990022
         TM    LCBXFLAG,LCBERPND        END CHAR ENQ?            S99228 32990522
         BO    NOLOOK                   SKIP EOT INSERT          S99228 32991022
         TM    SCBBSCFM,SCBRCVTX        ETX RECD BSYNC LINE      S99228 32992022
         BNO   NOGPOLL                  NO BYPASS GENPOLL SET    S99228 32993022
NOCHECK  EQU   *                                                 S99228 32994022
.LL4B    ANOP                                                    S99228 32994522
         L     RA,LCBDCBPT              LOAD DCB ADDR            S99228 32995022
         USING IHADCB,RA                                         S99228 32996022
         L     RF,DCBSCTAD-ONE          LOAD ADDR SPEC CHARS     S99228 32997022
         DROP  RA                                                S99228 32998022
         SR    RC,RC                    CLEAR WORK REGISTER      S99228 32999022
         IC    RC,ZERO(R0,RF)           INSERT EOT OFFSET        S99228 33000022
         LA    RC,ONE(RC,RF)            LOAD ADDR EOT CHAR       S99228 33001022
         LR    RF,RCCW                  LOAD ADDR TRUE INTRPT CCWS99228 33002022
         CLI   CCWOPCDE,CCWTIC          INTERRUPTED CCW A TIC   SA66632 33002205
         BE    NOLOOK                   YES, SKIP EOT MOVE      SA66632 33002405
         LH    RD,SIX(R0,RF)            LOAD CCW COUNT           S99228 33002722
         LH    RA,LCBCSW+FIVE           LOAD RESIDUAL COUNT      S99228 33003422
         SR    RD,RA                    DERIVE COUNT DATA READ   S99228 33004122
         L     RF,ZERO(R0,RF)           LOAD DATA ADDR           S99228 33004822
         AR    RF,RD                    SET EOT BUFFER POSITION  S99228 33005522
         TM    LCBERCCW+ONE,IN          LINE CONTROL IN?         S99228 33006222
         BO    LCINSIDE                 YES, CHECK RESIDUAL CNT  S99228 33006922
         BCTR  RF,R0                    SET BUFFER EOT POSITION  S99228 33007622
*                                       TO OVERWRITE ETX         S99228 33008322
         B     EOTMOVE                  INSERT EOT               S99228 33009022
LCINSIDE EQU   *                                                 S99228 33009722
         LTR   RA,RA                    RESIDUAL COUNT ZERO?     S99228 33010422
         BNZ   EOTFILL .                BRANCH IF NO             S99228 33011122
ZERORES  EQU   *                                                 S99228 33012522
         L     RF,LCBCSW-ONE            LOAD INTERRUPT ADDR      S99228 33013222
         LA    RF,ZERO(R0,RF)           CLEAR HI ORDER BYTE      S99228 33013922
         SH    RF,H8                    SET ADDR NEXT CCW        S99228 33014622
         CLI   CCWOPCDE-IEDQCCW(RF),CCWTIC  INTERRUPT ON A TIC @YA06327 33014861
         BE    NOLOOK                   YES, SKIP EOT MOVE      SA66632 33015005
         LR    RCCW,RF                  SET NEW TRUE INTERRUPT   S99228 33015322
*                                       CCW                      S99228 33016022
         L     RF,ZERO(R0,RF)           LOAD DATA ADDR           S99228 33016722
         LH    RA,CCWCOUNT              LOAD CCW COUNT           S99228 33017422
EOTFILL  EQU   *                                                 S99228 33018122
         BCTR  RA,R0                    REDUCE RESIDUAL COUNT    S99228 33018822
         STH   RA,LCBCSW+FIVE           RESTORE RESIDUAL COUNT   S99228 33019522
EOTMOVE  EQU   *                                                 S99228 33020222
         TM    LCBSTAT2,LCBSYNC         BISYNC LINE?             S99228 33020522
         BO    SYNCON                   BRANCH YES               S99228 33020822
         LA    RC,ONE(R0,RC)            POINT TO FIRST EOT       S99228 33021122
SYNCON   EQU   *                                                 S99228 33021422
         MVC   ZERO(ONE,RF),ZERO(RC)    MOVE EOT INTO BUFFER     S99228 33022022
NOLOOK   EQU   *                                                 S99228 33023022
         CLI   LCBECBCC,PERMERR         PERM ERROR PRESENT?      S99228 33027022
         BE    NOGPOLL1                 YES,LEAVE ETX FLAG UNSE@OX12505 33028091
         TM    SCBERR4,SCBTXTTN         TEXT ERROR?              S99228 33028322
         BO    NOGPOLL1                 BRANCH YES             @OX12505 33028691
         OI    LCBXFLAG,LCBGPCTV        SET GENPOLL IN PROGRESS  S99228 33029022
         B     NOGPOLL                  EXIT GENERAL POLL CODE@OX12505  33029291
NOGPOLL1 EQU   *                                               @OX12505 33029491
         OI    LCBCSW+THREE,UNEX        SET EOT RECEIVED       @OX12505 33029691
         B     NOGPOLL                                         @OX12505 33029891
NOGPOLL  EQU   *                                                 S99228 33030022
         L     RA,LCBDCBPT              LOAD DCB POINTER         S99228 33031022
.LL45    ANOP                                                    S99228 33035022
         USING IHADCB,RA                                                33040020
         AIF   ('&GEN' EQ 'STSP').CONC3B                         S22026 33042022
         AIF   ('&GEN' EQ 'MINI').CONC3B                         S22026 33044022
         AIF   ('&GEN' EQ 'QTAM').CONC3B                         S22026 33046022
         TM    LCBFLAG3,LCBOBRRD .      TPER RECORD              S22026 33048005
         BZ    CONTINUE .               NO, CONTINUE             S99238 33048305
         NC    LCBRECOF,LCBRECOF        READ CONTINUE           SA68026 33048605
         BZ    ERPCHK                   BR NO, CONTINUE         SA68026 33048905
         NI    LCBFLAG3,AVTEFF-LCBOBRRD RESET OBR REQUEST       SA68026 33049205
         B     TEXT                     TREAT AS TEXT           SA68026 33049505
ERPCHK   EQU   *                                                SA68026 33049805
         SPACE                                                          33050322
         CLI   LCBECBCC,PERMERR .       PERMANENT ERROR          S99238 33050622
         BNE   ERPEXIT .                NO, SCHEDULE ERP         S99238 33050922
         SPACE                                                          33051222
CONTINUE EQU   * .                                               S99238 33051522
.CONC3B  ANOP                                                    S22026 33052022
         MVI   LCBERCCW,NOPCI           ASSUME NO PCI USED              33060020
         TM    LCBCSW+4,PCIFLAG         PCI FLAG ON                     33080020
         BO    PROCBUFF                 BRANCH IF YES                   33100020
         SPACE                                                          33120020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 33140020
         BE    PROCBUFF                 YES, FRREE UP BUFFERS           33160020
         SPACE                                                          33180020
         TM    LCBSTAT1,LCBSENDN        SEND SIDE                       33200020
         BZ    RCVOP                    NO                              33220020
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 33221022
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 33222022
         BZ    CHAINBY                  BRANCH NO                S99228 33223022
         TM    LCBDCT2,CLOCAL           LOCAL DEVICE?            S99228 33224022
         BZ    CHAINBY                  BRANCH NO                S99228 33225022
         MVI   LCBERCCW,PCIOPT          SET TO FREE BUFFERS AT   S99228 33226022
*                                       COMPLETION OF CHNL PGM   S99228 33227022
         TM    CCWFLAGS,CCWCC+CCWCD     CHAINING FLAGS ON?       S99228 33228022
         BNZ   CHAINBY                  BRANCH YES               S99228 33229022
         MVI   LCBERCCW,NOPCI           SET TO FREE BUFFERS NOW  S99228 33230022
CHAINBY  EQU   *                                                 S99228 33231022
         SPACE                                                          33240020
         TM    DCBPCI,SNDPCI            PCI ON SEND SIDE                33260020
         BZ    PROCBUFF                 NO, FREE UP BUFFERS             33280020
         SPACE                                                          33300020
         TM    CCWFLAGS,CCWCC+CCWCD     ANY FLAGS                       33320020
         BZ    PROCBUFF                 FREE BUFFERS END OF MSG         33340020
         SPACE                                                          33360020
         B     SETPARM                  SET PARAMETER FOR LATER USE     33380020
         SPACE 2                                                        33400020
RCVOP    EQU   *                                                        33420020
         TM    DCBPCI,RCVPCI            PCI ON RECEIVE                  33440020
         BZ    PROCBUFF                 NO, FREE UP BUFFERS             33460020
         SPACE                                                          33480020
         AIF   ('&GEN' EQ 'QTAM' OR '&GEN' EQ 'MINI').LL46       S99228 33482022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 33484022
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 33485022
         BZ    RECHECK                  BRANCH NO                S99228 33486022
         TM    LCBDCT2,CLOCAL           LOCAL DEVICE?            S99228 33487022
         BO    PROCBUFF                 BRANCH YES               S99228 33488022
RECHECK  EQU   *                                                 S99228 33489022
         TM    LCBXFLAG,LCBGPCTV        GENERAL POLL IN PROGRESS?S99228 33490022
         BO    PROCBUFF                 YES, SKIP PCIOPT SET     S99228 33496022
.LL46    ANOP                                                    S99228 33498022
         TM    LCBERCCW+1,LOGICAL+CONV+LMD   IS THERE AN MH EXIT S22025 33500022
         AIF   ('&GEN' EQ 'MIMI').LL46C                         SA59028 33520022
         AIF   ('&GEN' EQ 'QTAM').LL46C                         SA59028 33521022
         BZ    SETPARM1                 NO-CHECK FOR EOT        SA59028 33522022
         TM    LCBTSOB,LCBTSBUF         TSO IN SESSION          SA59028 33523022
         BZ    PROCBUFF                 NO-FREE UP DEVICE       SA59028 33524022
         TM    LCBDCT1,C3270            3270 DEVICE             SA59028 33525022
         BZ    PROCBUFF                 NO-FREE UP BUFFERS      SA59028 33526022
         TM    LCBDCT2,CREMOTE          BSC DEVICE              SA59028 33527022
         BZ    PROCBUFF                 NO-FREE UP BUFFERS      SA59028 33528022
         TM    SCBBSCFM,SCBRCVTX        ETX RECD BSYNC LINE     SA59028 33529022
         BO    PROCBUFF                 YES- FREE UP BUFFERS    SA59028 33530022
SETPARM1 EQU   *                                                SA59028 33531022
         AGO   .LL46B                                           SA59028 33532022
.LL46C   ANOP                                                   SA59028 33533022
         BNZ   PROCBUFF                 YES- FREE UP BUFFERS    SA59028 33534022
.LL46B   ANOP                                                   SA59028 33535022
         TM    LCBCSW+3,UNEX            EOT RECEIVED                    33540020
         BO    PROCBUFF                 YES, FREE UP BUFFERS            33560020
SETPARM  EQU   *                                                        33580020
         MVI   LCBERCCW,PCIOPT          SET FLAG ,POST BUFFERS LATER    33600020
*                                         PCI WILL DO IT TO REQUEST     33620020
*                                         MORE NEEDED BUFFERS           33640020
PROCBUFF EQU   *                                                        33660020
         AIF   ('&GEN' EQ 'MINI').CONC4                          S22026 33662022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 33664022
         BZ    NOTCONCF .               BRANCH IF NO             S22026 33666022
         CLI   LCBECBCC,PERMERR .       PERMANET ERROR           S22026 33668022
         BE    NOTCONCF .               BRANCH IF YES            S22026 33670022
         MVI   LCBERCCW,PCIOPT .        SET PCI FLAG             S22026 33672022
         OI    SCBSTAT1,SCBNOPST .      INDICATE NO POST         S22026 33674022
NOTCONCF EQU   * .                                               S22026 33676022
.CONC4   ANOP                                                    S22026 33678022
         DROP  RA                                                       33680020
         LA    RA,FOUND                 SEST EXIT FROM SUBROUTINE       33700020
         EJECT                                                          33720020
FINDBUFF EQU   *                                                        33740020
*        THE FOLLOWING SUBROUTIE WILL DETERMINE THE FIRST UNIT          33760020
* UNIT OF A BUFFER FOR THE UNIT WHICH PRESENTED THE INTERRUPT.          33780020
* RCCW CONTAINS THE ADDRESS OF THE ENDING UNIT.  RPREFIX WILL POINT     33800020
* TO THE BUFFER. IN ADDITION, RB WILL CONTIN THE COUNT OF BUFFERS       33820020
* UP TO,BUT NOT INCLUDING THE INTEDRRUPTED BUFFER.  IF LCBERCCW IS      33840020
* EQUAL TO 00 (NOPCI) ALL PREVIOUS BUFFERS WILL BE POSTED TO THE        33860020
* AVAILABLE BUFFER QUEUE (SEND) OR TO MH (RECEIVE).                     33880020
         LA    RCCW,0(,RCCW)            CLEAR HI ORDER BYTE -COMPARE    33900020
         SR    RB,RB                    CLEAR FOR BUFFER COUNT          33920020
         LR    R0,RB                    CLEAR WORK REGISTER             33940020
         L     RE,LCBLSPCI-1            LAST SERVICED BUFFER            33960020
LOOP2    EQU   *                                               @OZ07786 33970091
         LR    RPREFIX,RE               SAVE BUFFER ADDRESS             33980020
         IC   R0,PRFNBUNT              NUMBER OF NNIT SON BUFFER        34000020
ENTER    EQU   *                                                        34100020
         LA    RE,0(,RE)                CLEAR FOR COMPARE               34120020
         CR    RE,RCCW                  THIS INTERRUPTED CCW            34140020
         BNE   BCTIT .                  BRANCH NO -GET NEXT UNIT S21101 34160020
         SPACE 1                                                 S21101 34170020
         CLI   LCBERCCW,PCIOPT .        PCI TO FREE BUFFERS      S21101 34172020
         BCR   8,RA .                   BRANCH YES               S21101 34174020
         SPACE 1                                                 S21101 34176020
         STCM  RPREFIX,AD,LCBLSPCI      SET LAST SERVICED BUFFER Y01948 34178005
         BR    RA .                     RETURN TO CALLER         S21101 34179220
         SPACE 1                                                 S21101 34179620
BCTIT    EQU   *                                                 S21101 34179720
         SPACE                                                          34180020
         L     RE,PRFTIC-IEDQPRF(,RE)   NEXT CCW ADDRESS       @OZ07786 34200091
         BCT   R0,ENTER                 CHECK NEXT UNIT        @OZ07786 34210091
         SPACE                                                          34220020
         TM    LCBSTAT1,LCBSENDN        SEND STATE                      34260020
         BO    SEND                     YES                             34280020
         USING IHADCB,RD                                                34300020
         L     RD,LCBDCBPT              GET DCB ADDRESS                 34320020
         MVC   PRFSIZE,DCBBUFSI         SET PREFIX SIZE                 34340020
         MVI   PRFPRI,PRIMHBFR          POST PRIORITY                   34360020
         L     RF,DCBMH-1               QCB POST ADDRESS                34380020
         DROP  RD                                                       34400020
BUFFPOST EQU   *                                                        34420020
         CLI   LCBERCCW,PCIOPT          CPI TO FREE BUFFERS             34440020
         BE    LOOP2                    YES,DON'T FREE BFRS    @OZ07786 34460091
         BAL   RC,ENQUEUE               PUT ON READYBQUEUE              34480020
         B     LOOP2                    LOOP ON NEXT BUFFER             34560020
         SPACE                                                          34580020
SEND     EQU   *                                                        34600020
         AIF   ('&GEN' EQ 'MINI').CONC4A                         S22026 34602022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 34604022
         BZ    NOTCONCG .               BRANCH IF NO             S22026 34606022
         TM    SCBSTAT1,SCBNOPST .      POST BUFFERS             S22026 34608022
         BO    LOOP2                    BRANCH IF NO           @OZ07786 34610091
NOTCONCG EQU   * .                                               S22026 34612022
.CONC4A  ANOP                                                    S22026 34614022
         LA    RF,AVTBFRTB              BUFFER RETURN                   34620020
         MVI   PRFPRI,PRIBFRTB          SET POST PRIORITY               34640020
         B     BUFFPOST                                                 34660020
         EJECT                                                          34680020
FOUND    EQU   *                                                        34700020
         AIF   ('&GEN' EQ 'MINI').CONC4B                         S22026 34702022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 34704022
         BZ    NOTCONCH .               BRANCH IF NO             S22026 34706022
         NI    SCBSTAT1,255-SCBNOPST .  RESET POST FLAG          S22026 34708022
NOTCONCH EQU   * .                                               S22026 34710022
.CONC4B  ANOP                                                    S22026 34712022
         STC   R0,LCBERCCW+3            SVAE FORLATER                   34720020
         LR    RD,RPREFIX               SAVE FOR UPDATING COUNTS        34760020
         CLI   LCBCSW+6,0               RESIDUAL COITN 0                34780020
         BNE   CURRCCW                  NO                              34800020
         TM    CCWFLAGS,CCWCD+CCWCC     ANY CHAINING FLAGS ON           34820020
         BNZ   NOEOTSNT                 BRANCH EOT NOT SENT             34840020
         CLI   LCBECBCC,PERMERR         TEXT ERROR                      34860020
         BNE   TESTRSP                  BRANH NO                        34880020
SENDERR  EQU   *                                                        34900020
         OI    SCBERR4,SCBTXTTN         SET TEXT ERROR                  34920020
         OI    LCBERBST,LCBERROR        ASSOGN NO MORE BUFFERS          34940020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 34960020
         USING IHADCB,RA                                                34980020
         L     RF,DCBMH-1               MH QCB ADDRESS                  35000020
         SPACE                                                          35020020
*        IF NO RECAL IS GOING TO BE PERFORMED AND WE ARE STILL          35040020
*        READING FROM DISK RECALL ADDRESS MUST BE BUFF DISPOSITION      35060020
         TM    LCBCSW+3,UNEX .          ABORT OR UNIT EXCEPTION  S21101 35070020
         BO    SETBD .                  BRANCH IF YES            S21101 35072020
         SPACE                                                          35074020
         TM    LCBCHAIN,LCBNORTY .      NO RETRY POSSIBLE               35080020
         BO    SETBD                    BRANCH IF YES                   35100020
        CLI   LCBINCAM,RETRY .         RETRY LIMIT REACHED              35120020
         BNL   SETBD .                  BRANCH IF RETRY EXHAUSTED       35140020
         AIF   ('&GEN' EQ 'MINI').CONC5                          S22026 35141022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 35142022
         BNO   NOTCONCD .               BRANCH IF NO             S22026 35143022
         IC    RA,LCBINCAM .            GET RETRY COUNT          S22026 35144022
         LA    RA,1(RA) .               ADD ONE                  S22026 35145022
         STC   RA,LCBINCAM .            STORE BACK               S22026 35146022
         L     RA,SCBXTRA-1 .           GET SAVED UNIT ADDR      S22026 35147022
         MVC   0(8,RA),SCBXTRA+3 .      RESTORE CCW              S22026 35149022
         L     RCCW,SCBXTRA+11 .        RESTORE TEXT START       S22026 35150022
         NI    LCBERBST,255-LCBERROR .  RESET ERROR              S22026 35151022
         NI    SCBERR4,255-SCBTXTTN .   RESET TEXT ERROR         S22026 35152022
         B     EXIT3 .                  RESTART                  S22026 35153022
NOTCONCD EQU   * .                                               S22026 35154022
.CONC5   ANOP                                                    S22026 35155022
         SPACE                                                          35160020
         AIF   ('&GEN' EQ 'MINI').MIX0350                        S22029 35162022
         AIF   ('&GEN' EQ 'BISC').MIX0350                        S22029 35164022
         AIF   ('&GEN' EQ 'QTAM').MIX0350                        S22029 35166022
         TM    LCBTSOB,LCBTSBUF         IS A TIME-SHARING        S22029 35168022
*                                       TERMINAL ON THIS LINE    S22029 35170022
         BO    SETBD                    YES,SETUP ERB FOR BD     S22029 35172022
.MIX0350 ANOP                                                    S22029 35174022
         MVC   LCBRCQCB+1(3),DCBMH      ASSUME BT                       35180020
         L     RF,AVTSAVEX+TWLVE .      DEB ADDRESS              X01004 35200005
         DROP  RA .                     DROP DCB BASE.           X01004 35210005
         L     RF,DEBAPPAD-DEBNMSUB(,RF) .  APPENDAGE TABLE.     X01004 35220005
         TM    ZERO(RF),MHBT            IS IEDQBT IN THIS MH     X01004 35230005
         BO    MHERR .                  BRANCH NO                X01004 35240005
SETBD    EQU   *                                                        35260020
         AIF   ('&GEN' EQ 'MINI').CONC5A                         S22026 35262022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 35264022
         BZ    ALLFREED .               NO, DON'T FREE BUFFERS   S22026 35266022
         BAL   RA,FINDBUFF .            FREE UP PREVIOUS BUFFERS S22026 35268022
         OI    PRFSTAT1,PRFNHDRN .      SET TEXT BUFFER TO AVOID S22026 35270022
*                                       FEFO UPDATE              S22026 35272022
ALLFREED EQU   * .                                               S22026 35274022
.CONC5A  ANOP .                                                  S22026 35276022
         MVC   LCBRCQCB+ONE(THREE),AVTBSCAN+ONE SET IEDQBD ADDR  X01004 35280005
         B     MHERR                    POST BUFFER TO MH               35320020
TESTRSP  EQU   *                                                        35340020
         BAL   RC,FINDEOB               EOB AT END OF BUFFER            35360020
         LA    RA,ONE(RWKA)             BSC EOB CHAR           @OY13656 35380091
         TM    LCBSTAT2,LCBSYNC         BSC LINE?              @OY13656 35383091
         BO    CKEOB                    BR YES                 @OY13656 35386091
         BCTR  RA,0                     POINT TO START/STOP EOB@OY13656 35389091
CKEOB    EQU   *                                               @OY13656 35392091
         CLC   0(ONE,RA),0(RB)          IS EOB LAST CHARACTER? @OY13656 35395091
         BNE   EOTSNT1                  NO,EOT WAS SENT                 35400020
         STCM  RPREFIX,AD,LCBLSPCI      SET LSPCI                Y01948 35410005
RDRSP    EQU   *                                                        35420020
         ST    RCCW,LCBCPA+12           SAVE TO POST LAST BUFFER        35440020
         LA    RA,LCBERCCW+12           RESPOSE AREA                    35460020
         ST    RA,LCBCPA+16             SET IN CCW                      35480020
         MVI   LCBCPA+16,CCWREAD        SET COMMAND                     35500020
         MVI   LCBCPA+20,CCWSLI         SET FLAG                        35520020
         MVI   LCBCPA+23,9 .            SET COUNT                S21101 35540020
         MVI   LCBTPCD+2,TPRDRPEB       SET TP OP CODE                  35560020
         LA    RCCW,LCBCPA+8            SET TO USE COMMON CODE          35640020
         B     EXIT2                    EXIT TO RESART                  35660020
EOTSNT1  EQU   *                                                        35680020
         AIF   ('&GEN' EQ 'MINI').CONC6                          S22026 35685022
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026 35690022
         BNO   NOTCONCI .               BRANCH IF NO             S22026 35695022
         L     RCCW,SCBXTRA-1 .         TEXT CCW ADDR            S22026 35700022
         MVI   LCBERCCW,NOPCI .         SET TO POST              S22026 35710022
         BAL   RA,FINDBUFF .            FREE BUFFERS             S22026 35715022
         L     RCCW,LCBCSW-1 .          RESET CCW ADDR           S22026 35720022
         SH    RCCW,H8 .                SUB EIGHT                S22026 35725022
NOTCONCI EQU   * .                                               S22026 35730022
.CONC6   ANOP                                                    S22026 35735022
EOTSNT   EQU   *                                                        35740020
         MVI   PRFPRI,PRILNEND          ST POST PRIORITY                35760020
DISP     EQU   *                                                        35780020
         L     RF,AVTBSCAN .            ADDRESS OF IEDQBD        X01004 35800005
         B     POSTEXIT                 USE COMMON CODE                 35840020
         EJECT                                                          35860020
NOEOTSNT EQU   *                                                        35880020
*        EOB/ETB AT END OF UNIT OR BUFFER.                              35900020
         TM    LCBSTAT1,LCBSENDN        EOB SENT                        35920020
         BZ    RECEIVE                  NO, EOB RECEIVE OR EOT          35940020
         BAL   RE,SETSCB                SET PREVIOUS OFFSET IN SCB      35960020
         SPACE                                                          35980020
         CLI   LCBERCCW+3,1             EOB AT END OF BUFFER            36000020
         BE    ENDBUF                   BRANCH END OF BUFFER            36020020
         SPACE                                                          36040020
         BAL   RB,SETCOUNT              GET OFFSET INTO BUFFER          36060020
         L     RCCW,8(,RCCW)            NEXT CCW IN CHAIN               36080020
         B     ETBUPDT                  USE COMMON CODE                 36100020
         SPACE                                                          36120020
ENDBUF   EQU   *                                                        36140020
         TM    LCBCSW+4,X'20'           CHAN PROG CHECK                 36160020
         BZ    ITSCLEAN                 BRANH IF NO                     36180020
         TM    LCBSTAT1,LCBINITN        INITIATE MODE                   36200020
         BZ    NOBFRS                   DO NOT SET INSUFF. BUFFERS      36220020
         SPACE                                                          36240020
         NI    SCBERR1,AVTEFF-SCBNOBFN  TURN OFF INSUFFICIENT BUFF      36260020
NOBFRS   EQU   *                                                        36280020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE?            S99228 36286022
         BE    POSITIVE                 BRANCH YES               S99228 36292022
         MVI   CCWCOUNT+1,0             INDICATE CHAN PROGRAM CHECK     36300020
POSITIVE EQU   *                                                 S99228 36310022
         AIF   ('&GEN' NE '').Z9                                        36320020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        36340020
         BO    IOGEN                    BRANCH IF YES                   36360020
.Z9      AIF   ('&GEN' NE 'BISC').Z10                                   36380020
         B     IOGEN                    BUILD CONTINUE                  36400020
         AGO   .Z11                                                     36420020
.Z10     ANOP                                                           36440020
         ST    RCCW,LCBCPA+12           SAVE CURRENT CCW POINTER        36460020
         MVI   LCBCPA+12,X'20'          PROGRAM CHECK FLAG              36480020
         TM    LCBCHAIN,LCBEXCP         IDLES LOOP DEFINED              36500020
         BZ    PCSTART                  BRANCH IF YES                   36520020
         B     FREERQE                  EXIT                            36540020
.Z11     ANOP                                                           36560020
ITSCLEAN EQU   *                                                        36580020
         CLI   LCBERCCW,PCIOPT          POST NOW                        36600020
         BE    SKIPPOST                 BRANCH IF NO                    36620020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR        @OY20569 36623086
         BNE   GOODBACK                 BRANCH NO              @OY20569 36626086
         CLI   LCBCSW+6,AVTEZERO        ZERO RESIDUAL COUNT    @OY20569 36629086
         BE    LASTBUF                  BRANCH YES             @OY20569 36632086
GOODBACK EQU   *                                               @OY20569 36635086
         LA    RF,AVTBFRTB              BUFFER RETURN                   36640020
         MVI   PRFPRI,PRIBFRTB          POST PRIORITY                   36660020
         BAL   RC,ENQUEUE               PUT ON READY Q                  36680020
         MVC   LCBLSPCI,9(RCCW)         SET NEW LAST SERVICED   SA52517 36686022
*                                         BUFFER                SA52517 36692022
SKIPPOST EQU   *                                                        36700020
         L     RPREFIX,8(,RCCW)         NEXT  BUFFER ADDRESS            36720020
         LR    RCCW,RPREFIX             RESETART S CCW                  36740020
LASTBUF  EQU   *                                                        36760020
         LA    R0,PRFSTXT-PRFSUNIT      SAVE FOR LATER                  36780020
         STH   R0,LCBRECOF         SAVE FOR LATER                       36800020
         B     ETBUPDT .                USE COMMON CODE          S21101 36820020
TTYTEST  EQU   *                                                SA48278 36825022
         L     RC,AVTSAVEX+UCBOFFST     UCB ADDRESS              X02004 36830005
         CLI   TTY1(RC),TTY2 .         POSSIBLY TELETYPE        SA48278 36835022
         BCR   7,RB .                  BRANCH IF NO             SA48278 36840022
         TM    TTY4(RC),TTY3 .         POSSIBLY TELETYPE        SA48278 36845022
         BCR   14,RB .                 BRANCH IF NO             SA48278 36850022
         TM    TTY4(RC),TTY5 .         POSSIBLY TELETYPE        SA48278 36855022
         BCR   5,RB .                  BRANCH IF NO             SA48278 36860022
SIMEOT   OI    LCBCSW+3,UNEX .     SIMULATE EOT                 SA51061 36865022
         B     ITSEOT .                GO HANDLE EOM            SA48278 36870022
         SPACE                                                          36880020
RECEIVE  EQU   *                                                        36900020
         TM    LCBCSW+3,UNEX            EOT RECEIVED                    36920020
         BO    ITSEOT                   YES                             36940020
         BAL   RB,TTYTEST .            TEST FOR TELETYPE        SA48278 36945022
         CLI   L22601(RC),L2260 .  TEST FOR GRAFICS             SA51061 36950022
         BE    SIMEOT .            GO SIMULATE EOT              SA51061 36955022
         SPACE                                                          36960020
         TM    LCBERCCW+1,IN            LCIN SPECIFIED                  36980020
         BZ    CURRCCW                  NO, IT'S LCOUT                  37000020
         SPACE                                                          37020020
         BAL   RB,SETCOUNT              GET COUNT INTO BUFFER           37040020
         STH   RC,PRFSIZE               SET R PREFIX SIZE               37060020
.Z12     ANOP                                                           37320020
         LR    RWKA,RCCW                SAVE CCW POINTER                37340020
         L     RCCW,8(,RCCW)            NEXT CCW IN CHAIN               37360020
         STCM  RCCW,AD,LCBRECAD         SET NEXT CCW ADDR      @XA09327 37370000
         CLI   LCBERCCW+3,1             EOB AT END OF BUFFER            37380020
         BNE   NOTEND                                                   37400020
         ST    RWKA,LCBCPA+12           SAVE CURRENT CCW POINTER        37420020
         MVC   LCBCPA+16(8),CCW         SAVE CCW               @OX11954 37430091
         CLI   LCBECBCC,PERMERR         ERROR                           37440020
         BE    ERRPOST                  BRANCH IF YES                   37460020
         TM    LCBCSW+4,X'20'           CHAN PROG CHECK                 37480020
         BZ    NOTAPC                   BRANCH IF NO                    37500020
         LR    RCCW,RWKA                SAVE                            37520020
         MVC   LCBCPA+16(8),CCW         SAVE CCW                        37540020
         OI    LCBCHAIN,LCBABRTN        SET ABORT BIT                   37560020
         B     IOGEN                    GO TO IO GENERATOR              37580020
NOTAPC   EQU   *                                                        37600020
         TM    PRFSTAT1,PRFTSMSG        IS THIS TSO MESSAGE    @OS77376 37604091
         BO    ITSTSO                   YES, DONT SET EXTRA    @OS77376 37608091
         MVC   PRFXTRA+1(2),PRFSIZE     SET EOB OFFSET         @OS77376 37612091
ITSTSO   EQU   *                                               @OS77376 37616091
         MVI   LCBERCCW,PCIOPT          DELATY POSTING BUFFERS NOW      37620020
         L     RC,PRFIOADR-1-IEDQPRF(,RCCW) DATA ADDRESS NEXT BUFF      37640020
         LA    R0,PRFSUNIT-IEDQPRF(RCCW) FIRST BYTE FOR PRFSIZE@YA04894 37670061
         SR    RC,R0                    AMOUNT OF PREFIX+IDLES          37700020
         STH   RC,PRFSIZE-IEDQPRF(,RCCW) SET IN PREFIX                  37720020
         LR    RC,RCCW                  FOR SUBROUTINE                  37740020
         BAL   RB,EXITSUB               CHECK STATUS                    37760020
         LR    RPREFIX,RCCW             NEXT BUFFER                     37780020
NOTEND   EQU   *                                                        37800020
         STCM  RPREFIX,AD,LCBRECAD .    SAVE RECORD ADDRESS      Y01948 37820005
         B     IOGEN                    GO BUILD CONTINUE               37880020
         EJECT                                                          37900020
CURRCCW  EQU   *                                                        37920020
         LA    RPREFIX,AVTEZERO(R0,RPREFIX) CLEAR HI ORDER BYTE         37940020
         TM    LCBSTATE,LCBSENDN        EOB SENT                        37960020
         BO    EOBSENT                  YES                             37980020
         SR    RC,RC                    CLEAR WORK REGISTER             38000020
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION MEANS EOT        38020020
         BO    ITSEOT                   BRANCH YES, FALL THRU - EOB     38040020
         BAL   RB,TTYTEST .            TEST FOR TELETYPE        SA48278 38140022
.Z13     ANOP                                                           38300020
         BAL   RB,SETCOUNT              GET COUNT FOR EOB OFFSET        38320020
         TM    LCBERCCW+1,IN            LCIN SPECIFIED                  38340020
         BO    COMMON                   BRANCH YES                      38360020
         CLI   LCBECBCC,PERMERR         ERRORS                          38380020
         BE    COMMON                   YES                             38400020
         CLI   LCBRSKEY,LCLRSCH         LOCAL DEVICE?           SA57329 38420022
         BNE   REDUCE                   BRANCH NO               SA57329 38422022
         TM    LCBERCCW+ONE,CONV+LMD+LOGICAL  CONTINUE?         SA57329 38424022
         BNZ   GOODCONV                 BRANCH NO               SA57329 38426022
REDUCE   EQU   *                                                SA57329 38428022
         BCTR  RC,R0                    REDUCE COUNT FOR LCOUT  SA57329 38430022
GOODCONV EQU   *                                                SA57329 38432022
         STH   RC,LCBRECOF              SAVE RECORD AOFFSET             38440020
         LH    RE,LCBCSW+5              RESIDUAL COUNT                  38460020
         LA    RE,1(,RE)                BUMP FOR COMMON CODE            38480020
         STH   RE,LCBCSW+5              SAVE BACK                       38500020
COMMON   EQU   *                                                        38520020
         STH   RC,PRFSIZE               ASSUME THIS IS END OF MSG       38540020
         STCM  RPREFIX,AD,LCBRECAD .    SAVE CURRENT RECORD ADDR Y01948 38560005
EOBCOM   EQU   *                                                        38620020
         CLI   LCBCSW+6,0         RESIDUAL COUNT C 0                    38640020
         BE    IOGEN              YES, EOB AT END OF UNIT(BUFFER)       38660020
         LH    RD,CCWCOUNT              ORIGINAL COUNT                  38680020
         SH    RD,LCBCSW+5              SUBTRACT RESID COUNT            38700020
         L     RE,CCWADDR-1       DATA ADDRESS                          38720020
         AR    RE,RD              NEW DATA ADDRESS                      38740020
         ST    RE,CCWADDR-1       SET NEW ADDRESS                       38760020
         MVC   CCWCOUNT,LCBCSW+5  SET NEW COUNT                         38780020
         B     IOGEN                    RESTART                         38800020
         EJECT                                                          38820020
*                                                                       38840020
*        SUBROUTINE TO COMPUTE AMOUNT OF DATA TRANSMITTED OR            38860020
* RECEIVED IN A BUFFER.                                                 38880020
*                                                                       38900020
SETCOUNT EQU   *                                                        38920020
         LR    RD,RPREFIX              CCW ADDR OF 1ST UNIT             38940020
         SR    RC,RC                    CLEAR WORK REGISTER             38960020
         B     ENTER1                   ENTER LOOP                      38980020
LOOP1    EQU   *                                                        39000020
         L     RD,EIGHT(,RD)            ADDRESS OF NEXT UNIT            39020020
         AH    RC,AVTKEYLE              ADD UNIT SIZE                   39040020
ENTER1   EQU   *                                                        39060020
         LA    RD,AVTEZERO(,RD)         CLEAR HI ORDER BYTE             39080020
         CR    RD,RCCW                  THIS INTERRUPTED CCW            39100020
         BNE   LOOP1                    TRY NEXT UNIT                   39120020
         LA    RWKA,PRFSUNIT-PRFRCB(,RCCW) TEXT START                   39140020
         L     RD,CCWADDR-1            DATA ADDR  ( MAY HAVE BEEN       39160020
*                                         UPDATED BY PREV EOB           39180020
         SR    RD,RWKA                  DATA TRANSF PREV EOB            39200020
         LH    RE,CCWCOUNT             CCW COUNT                        39220020
         SH    RE,LCBCSW+5             SUB RES CONT FOR AMT TRANSF      39240020
         AR    RC,RD                    ADD TO ACCUM TOTAL              39260020
         AR    RC,RE                    ADD TO ACCUM TOTAL              39280020
         STH   RC,LCBRECOF              SAVE RECORD AOFFSET             39300020
         BR    RB                       RETURN                          39320020
         SPACE 3                                                        39340020
ITSEOT   EQU   *                                                        39360020
         BAL   RB,SETCOUNT                                              39380020
         AIF   ('&GEN' NE 'BISC' AND '&GEN' NE '').M6E           S21101 39390020
         BAL   RB,CKBFMM .              DONT WANT EOT IN BUFER IFS21101 39392020
*                                         NOT REAL EOM           S21101 39394020
         B     MHPOST .                 NOT REAL EOM             S21101 39396020
.M6E     ANOP                                                    S21101 39398020
LCINS    EQU   *                                                        39400020
         STH   RC,PRFSIZE               SAVE IN PREFIX                  39420020
POSTMSG  EQU   *                                                        39440020
POSTMH   EQU   *                                                        39460020
         NI    PRFSTAT1,PRFNLSTF        TURN OFF'NOT LAST BUFFER'       39480020
MHPOST   EQU   *                                                        39500020
         MVI   PRFPRI,PRIMHBFR          POST PRIORITY                   39520020
POSTERR  EQU   *                                                        39540020
         STCM  RPREFIX,AD,LCBLSPCI .    SET LAST SERVICED PCI    Y01948 39560005
POSTBUF  EQU   *                                                        39620020
         L     RWKA,LCBDCBPT            GET DCB ADDRESS                 39640020
        USING IHADCB,RWKA                                               39660020
         L     RF,DCBMH-1               ADDRESS OF QUEUE                39680020
         DROP  RWKA                                                     39700020
         B     POSTEXIT                 USE COMMON CODE                 39720020
         SPACE 10                                                       39740020
*                                                                       39760020
*        SET UP SCB PARAMETERS FOR START/STOP IN EVENT A SUBSEQUENT     39780020
* RECALL IS REQUIRED .  FOR BSC, THE PARAMETERS ARE SAVED IN THE LCB    39800020
* THE SCB IS UPDATED AFTER READ RESPOSNE INTERRUPT IS RECEIVED.         39820020
EOBSENT  EQU   *                                                 S21101 39840020
         BAL   RE,SETSCB .              SET SCB PARAMETERS       S21101 39841020
         SPACE 2                                                 S21101 39842020
         BAL   RB,SETCOUNT .            GET OFFSET INTO BUFFER   S21101 39843020
         SPACE 2                                                 S21101 39844020
ETBUPDT  EQU   *                                                 S21101 39845020
         MVC   LCBRECAD,PRFCRCD .       SAVE DISK ADDRESS        S21101 39846020
         MVC   LCBNTXT,PRFNTXT .        SAVE DISK PARAMETER      S21101 39847020
*        FOR BSC PARAMETERS ARE SET IN SCB FROM LCB AFTER READ   S21101 39848020
* RESPONSE.  FOR START STOP SCB IS UPDATED AFTER NEXT EOB.  FOR  S21101 39849020
* 2740/2 SCB IS UPDATED AFTER READ RESPONSE                      S21101 39850020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'QTAM' OR '&GEN' EQ '').MX39851054
               6A                                               SA66594 39851554
         B     EOBCOM .                 UPDATE CCW AND GO TO IOGES21101 39852020
         AGO   .M6C                                              S21101 39853020
.M6A     ANOP                                                    S21101 39854020
         AIF   ('&GEN' NE'').M6B                                 S21101 39855020
         TM    LCBSTAT2,LCBSYNC .       BSC LINE                 S21101 39856020
         BO    EOBCOM .                 BRANCH IF YES. BUFFERED  S21101 39857020
*                                         SUPPROT IS DONE AT READS21101 39858020
*                                         RESPONSE               S21101 39859020
         SPACE 1                                                 S21101 39860051
.M6B     ANOP                                                    S21101 39860151
         SPACE 1                                                SA62991 39860251
         CLI   LCBTPCD+2,TPRDRPEB       READ RESP FIRST CCW     SA62991 39860351
         BNE   SKIPRTRY                 BR NO, FORGET IT        SA62991 39860451
         L     RD,LCBSTART-1            CHAN PROG START ADDRESS SA62991 39860551
         LA    RD,0(RD)                                         SA62991 39860651
         LA    RE,LCBCPA+16             SLOT FOR READ RESP CCW  SA62991 39860751
         CR    RD,RE                    START ON READ RESPONSE  SA62991 39860851
         BNE   SKIPRTRY                 BR NO, FORGET IT        SA62991 39860951
         L     RD,0(RE)                 GET RESPONSE ADDRESS    SA62991 39861051
         CLI   0(RD),EBCDACK            IS IT EBCDIC ACK        SA62991 39861151
         BE    ZERORTRY                 BR YES, CLEAR RETRY CNT SA62991 39861251
         CLI   0(RD),ASCIACK            ASCII ACK               SA62991 39861351
         BNE   SKIPRTRY                 BR NO, FORGET IT        SA62991 39861451
ZERORTRY EQU   *                                                SA62991 39861551
         MVI   LCBINCAM,AVTEZERO        CLEAR RETRY COUNT       SA62991 39861651
SKIPRTRY EQU   *                                                SA62991 39861751
         SPACE 1                                                SA62991 39861851
         CLI   LCBRSKEY,BUFF .          BUFFERED LINE            S21101 39862020
         BNE   EOBCOM .                 BRANCH IF NO             S21101 39863020
         SPACE 1                                                 S21101 39864020
         TM    CCWFLAGS,CCWCD           NO CHAINING            @OX12579 39865091
         BNZ   LATER                    BRANCH NOT EOM         @OX12579 39865891
         CLI   LCBCSW+6,ONE             ONLY ONE CHARACTER LEFT@OX12579 39866691
         BE    EOBCOM                   YES,BRANCH             @OX12579 39867491
         BH    LATER                    NOT EOB AT END OF UNIT @OX12579 39868291
         CLI   CCWCOUNT+ONE,ONE         ONLY EOT LEFT          @OX12579 39869091
         BE    EOBCOM                   YES,BRANCH             @OX12579 39869891
LATER    EQU   *                                                 S21101 39871020
         OI    SCBQTYPE,SCBBFMM .       INDICATE MIDDLE OF MSG   S21101 39872020
         OI    PRFSTAT1,PRFITCPN .      SET NOT REAL END OF MSG  X01004 39873005
*                                          AT READ RESPONSE INTERS21101 39874020
         B     RDRSP                    PUT UP READ RESPONSE     S21101 39875020
.M6C     ANOP                                                    S21101 39876020
         SPACE 10                                                S21101 39877020
         AIF   ('&GEN' NE 'BISC' AND '&GEN' NE '').M6D           S21101 39878020
*                                                                S21101 39879020
*         SUBROUTINE TO DETERMINE IF EOT IS ALL THAT REMAINS IN  S21101 39880020
* MESSAGE.                                                       S21101 39881020
*                                                                S21101 39882020
ONLYEOT  EQU    *                                                S21101 39883020
         CLI   CCWCOUNT+1,ONE .         ONE CHARACTER TO WRITE   S21101 39884020
         BNE   4(RC) .                  BRANCH IF NO             S21101 39885020
         SPACE 1                                                 S21101 39886020
         TM    CCWFLAGS,CCWCD           NO CHAINING FLAG ON      S21101 39887020
         BCR   8,RC .                   BRANCH IF OFF, TRUE EOM  S21101 39888020
          SPACE 1                                                S21101 39889020
         B     4(RC) .                  RETURN, MORE TO MESSAGE  S21101 39890020
         SPACE 10                                                S21101 39891020
.M6D     ANOP                                                    S21101 39892020
SETSCB   EQU   *                                                        39900020
         AIF   ('&GEN' NE '').L53                                       39920020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        39940020
         BCR   1,RE .                   BRANCH IF YES            S21101 39960020
.L53     AIF   ('&GEN' EQ 'BISC').L54                                   39980020
         SPACE                                                          40000020
         OC    LCBRECAD,LCBRECAD        FIRST OUPUT BLOCK               40020020
         BCR   8,RE .                   BRANCH IF YES            S21101 40040020
         SPACE                                                          40060020
         MVC   SCBDEOB+1(3),LCBRECAD    SET Q ADDRESS                   40080020
         MVC   SCBDEOB(1),LCBNTXT       SET DISK RECORD                 40100020
         MVC   SCBEOB(2),LCBRECOF       SET OFFSET INTO RECORD          40120020
.L54     ANOP                                                           40140020
         BR    RE                       RETURN TO CALLER                40180020
         EJECT                                                          40320020
IOGEN    EQU   *                                                        40340020
         LA    RB,SUBEXIT               SET ROUTINE EXIT                40360020
         LR    RC,RPREFIX               SAVE PARAMTER                   40380020
EXITSUB  EQU   *                                                        40400020
         CLI   LCBERCCW,PCIOPT          PCI TO FREE BUFFERS             40420020
         BE    NOSET                    YES                             40440020
         STCM  RPREFIX,AD,LCBLSPCI .    UPDATE LAST SERVICED BFR Y01948 40460005
NOSET    EQU   *                                                        40520020
         STCM  RCCW,AD,LCBCPA+THIRTN .  'NEW' LAST TEXT CCW      Y01948 40540005
         MVC   LCBCPA+16(8),CCW         SAVE UPDATED CCW                40600020
         MVC   LCBTTBIN,LCBTTCIN        SET FOR CONT                    40620020
         TM    CCWOPCDE,CCWWRITE        WRITE COMMAND                   40640020
         BZ    NOTWRITE                 BRANCH IF NO                    40660020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 40680020
         BNE   GOIOGEN                  NO                              40700020
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY                    40720020
         B     SENDERR                  POST BUFFER TO MH               40740020
NOTWRITE EQU   *                                                        40760020
         TM    LCBCHAIN,LCBABRTN .      ABORT REQUEST FOR PGM CHK       40766020
         BCR   1,RB .                   BRANCH IF YES                   40772020
         SPACE                                                          40780020
         CLI   LCBECBCC,PERMERR         TEXT ERROR                      40800020
         BNE   NOERR                                                    40820020
ERRPOST  EQU   *                                                        40840020
         OI    LCBMSGFM,LCBNAK          RESPONSE FOR TTD       @OY14057 40846091
ERRPOST1 EQU   *                                               @OY14057 40852091
         OI    LCBERBST,LCBERROR        DONT ASSIGN MORE BUFFERS        40860020
         MVI   PRFPRI,PRIMHBFR-1        SET POST PRIORITY               40880020
         NI    PRFSTAT1,PRFNLSTF        MARK IT LAST                    40900020
         OI    SCBERR4,SCBTXTTN         TEXT ERROR                      40920020
         B     POSTERR                  EXIT                            40960020
NOERR    EQU   *                                                        40980020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').Z14               41000020
         AIF   ('&GEN' EQ 'QTAM').Z14                                   41020020
         NI    SCBERR2,AVTEFF-SCBABRTN  RESET ABORT BIT                 41040020
         NI    SCBERR3,AVTEFF-SCBFORMN  RESET FORMAT ERROR BIT          41060020
.Z14     ANOP                                                           41080020
*****************************************************************S22025 41081022
*        THE FOLLOWING CODE ADJUSTS FOR THE CASE OF RECEIVING    S22025 41082022
*        CHANNEL END/DEVICE END WITHOUT DTA TRANSFERRED ON A     S22025 41083022
*        START/STOP LINE.                                        S22025 41084022
         ST    RC,LCBERCCW+4            BUFFER ADDRESS           S22025 41085022
         CLC   LCBERCCW+5(3),SCBDEOB+1  THIS THE DEOB BUFFER     S22025 41086022
         BNE   GOODSIZE                 NO                       S22025 41087022
         CLC   SCBEOB,PRFSIZE-IEDQPRF(RC) IS PREVIOUS SIZE LESS  S22025 41088022
*                                         THAN NEW SIZE          S22025 41089022
         BNH   GOODSIZE                 BRANCH IF YES            S22025 41090022
         MVC   PRFSIZE-IEDQPRF(2,RC),SCBEOB ADJUST SIZE          S22025 41091022
GOODSIZE EQU   *                                                 S22025 41092022
*****************************************************************S22025 41093022
         NI    SCBERR4,AVTEFF-SCBTXTTN  RESET TEXT ERROR BIT            41100020
         MVI   LCBINCAM,0               RESET RETRY COUNT               41120020
         TM    PRFSTAT1,PRFTSMSG .      IS THIS A TSO BUFFER     S22029 41130022
         BO    TSOBUF .                 BRANCH IF YES            S22025 41140022
         MVC   PRFXTRA+1-IEDQPRF(TWO,RC),PRFSIZE-IEDQPRF(RC)     S22025 41160022
*                                       RESET THE EOB OFFSET IN  S22025 41166022
*                                         THE BUFFER             S22025 41172022
TSOBUF   EQU   *                                                SA63595 41172554
         OI    LCBSTAT2,LCBRESP        SET RESPONSE OWED        SA63595 41173054
         AIF   ('&GEN' NE 'MINI' AND '&GEN' NE 'QTAM').LL46A   @OS76490 41173591
         TM    LCBERCCW+1,LOGICAL+CONV+LMD  IS THERE AN MH EXIT SA63595 41174054
         BNZ    POSTMH                 BRANCH EITHER            SA63595 41174554
         BR    RB                      RETURN                   SA63595 41175054
.LL46A   ANOP                                                           41176822
         AIF   ('&GEN' EQ 'QTAM' OR '&GEN' EQ 'MINI').LL47              41177022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR SA59028 41177522
         TM    LCBERCCW+ONE,LOGICAL+CONV+LMD  LOGICAL, CONVERSE  S99228 41180222
*                                             OR LMD?            S99228 41180422
         BZ    CONVTEST                 NO-CHECK GEN POLL       SA59028 41180622
         TM    LCBDCT1,C3270            3270 DEVICE             SA59028 41181522
         BZ    POSTMH                   NO-POST BUFFERS TO MH   SA59028 41181822
         TM    LCBDCT2,CREMOTE          BSC DEVICE              SA59028 41182122
         BZ    POSTMH                   NO-POST BUFFERS TO MH   SA59028 41182422
         TM    SCBERR2,SCBSOHE          SOH%R MSG RECIEVED      SA59028 41182722
         BO    CONVTEST                 BRANCH IF YES          @SA71658 41183061
         TM    LCBTSOB,LCBTSBUF         TSO IN SESSION          SA63959 41183105
         BZ    POSTMH                   NO - POST BFRS TO MH    SA63959 41183205
         TM    SCBBSCFM,SCBRCVTX        ETX RECD BSYNC LINE     SA59028 41183322
         BCR   EIGHT,RB                 BRANCH IF NO            SA59028 41183622
         B     POSTMH                   POST BUFFERS TO MH              41183922
CONVTEST EQU   *                                                SA59028 41184222
         TM    LCBXFLAG,LCBGPCTV        GENERAL POLL IN PROGRESS?S99228 41185022
         BCR   EIGHT,RB                 BRANCH IF NO             S99228 41190022
         TM    LCBERCCW+ONE,IN          LINE CONTROL IN?         S99228 41191022
         BO    POSTMH                   BRANCH IF YES            S99228 41192022
         LH    RC,PRFSIZE               LOAD PRFSIZE             S99228 41193022
         LA    RC,ONE(R0,RC)            INCREASE PRFSIZE FOR EOT S99228 41194022
         STH   RC,PRFSIZE               RESTORE PRFSIZE          S99228 41195022
LINEIN   EQU   *                                                 S99228 41196022
         B     POSTMH                   POST BUFFERS TO MH       S99228 41197022
.LL47    ANOP                                                    S99228 41218022
SUBEXIT  EQU   *                                                        41260020
         SPACE                                                          41280020
GOIOGEN  EQU   *                                                        41300020
         MVC   LCBTTBIN,LCBTTCIN        RESET TO BE CONNECTED           41320006
         ST    R15,LCBERCCW+4           SAVE REGISTER           SA54923 41330006
         OI    LCBSTAT1,LCBCONT         SET CONTINUE BIT                41340006
         L     RCCW,AVTKA02             ADDRESS OF IEDQKA               41350006
         LA    RAVT,AVTSAVE2            AVT BASE FOR KA                 41360006
         BALR  RF,RCCW                  LINK TO KA                      41370006
         L     R15,LCBERCCW+4           RESTORE REGISTER        SA54923 41380006
         L     R14,LCBSCBA-1            RESTORE SCB ADDRESS     SA54923 41390006
         LA    RBASE,FOUR095(,R15)      SET SECOND BASE                 41400006
         LA    RBASE,ONE(,RBASE)                                        41410006
         SH    RAVT,AVTBACK             RESET AVT BASE                  41420006
         AIF   ('&GEN' NE 'BISC').Z15                                   41520020
         B     RESTART                  RESTART CHAN PROGRAM            41540020
         AGO   .Z16                                                     41560020
.Z15     ANOP                                                           41580020
         TM    LCBCSW+3,UNEX            NO CONTINUE POSSIBLE            41600020
         BZ    RESTART                  BRANCH RESTART POSSIBLE         41620020
         L     RCCW,LCBCPA+12           INTERRUPTED CCW                 41640020
         MVI   LCBERCCW,NOPCI           SET PARAMETER TO POST BUFFS     41660020
         BAL   RA,FINDBUFF              LIN TO SUBROUTINE               41680020
         TM    LCBCHAIN,LCBABRTN .      NO ABORT FOR THIS LINE          41685020
         BO    POSTMH .                 BRANCH IF YES                   41690020
         SPACE                                                          41695020
         TM    LCBERCCW+1,IN            LCIN                            41700020
         BO    POSTMH                   BRANCH IFYES                    41720020
         LH    RWKA,PRFSIZE             GET PREFIX SIZE                 41740020
         LA    RWKA,1(,RWKA)            BUMP                            41760020
         STH   RWKA,PRFSIZE             SET BACK                        41780020
         B     POSTMH                   POST AS LAST TO MH              41800020
.Z16     ANOP                                                           41820020
         EJECT                                                          41840020
FINDEOB  EQU   *                                                        41860020
*                                                                       41880020
*        SUBROUTINE WILL COMPUTE ADDRESS OF LAST CHARACGER TRANSMITTED  41900020
* OR RECEIVED IN A UNIT AND THE EOB SEQUENCE IN THE SPECIAL             41920020
* CHARACTERS TABLE.                                                     41940020
         L     RWKA,LCBDCBPT            DCB  BASE                       41960020
         USING IHADCB,RWKA                                              41980020
         L     RB,DCBSCTAD-1            SCT ADDRESS                     42000020
         DROP  RWKA                                                     42020020
         SR    RWKA,RWKA                CLEAR FOR INDEX                 42040020
         ICM   RWKA,ONE,ETBCH(RB)       ETB SEQUENCE DEFINED     Y01948 42060005
         BZ    EOTSNT1 .                BRANCH, IF NOT            M5949 42072020
.NOSTSP  ANOP                                                     M5949 42076020
         LA    RWKA,1(RWKA,RB)          POINT TO SEQUENCE               42080020
         L     RB,CCWADDR-1             DATA ADDRESS                    42100020
         AH    RB,CCWCOUNT              ORIGINAL COUNT                  42120020
         SH    RB,LCBCSW+5              SUBTRAC T RESIDUAL COUNT        42140020
         BCTR  RB,0                     DECREMENT ONE                   42160020
         BR    RC                       RETURN                          42180020
         SPACE 10                                                       42200020
         AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').Z17               42220020
         AIF   ('&GEN' EQ 'QTAM').Z17                                   42240020
CKEND    EQU   *                                                        42260020
*                                                                       42280020
*        THIS SUBROUTINE WILL CHECK IF LAST CHARACTER IS A VALID        42300020
* LINE CONTROL CHARACTER.  IF NOT, EXIT IS TO IOS TO SCHEDULE ERP       42320020
*                                                                       42340020
         TM    LCBSTAT1,LCBSENDN        SEND SIDE                       42360020
         BCR   1,RC                     YES, EXIT                       42380020
         SPACE                                                          42400020
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR                 42420020
         BCR   8,RC                     YES, EXIT                       42440020
         SPACE                                                          42460020
         TM    LCBMSGFM,LCBRSTRT .      INVALID START CHARACTER  S21101 42480020
         BO    CKCNT                    YES, CHECK RETRY COUNT          42500020
         TM    LCBMSGFM,LCBEOT .        EOT RECEIVED             S21101 42520020
         BCR   1,RC                     YES, RETURN                     42540020
         SPACE                                                          42560020
         USING IHADCB,RA                                                42580020
         L     RF,DCBSCTAD-1            SCT ADDRESS                     42600020
         DROP  RA                                                       42620020
         SR    RE,RE                    CLEAR INDEX REGISTER            42640020
         IC    RE,ETBCH(,RF)            GET DLE ETB INDEX               42660020
         LA    RWKA,2(RE,RF)            POINT TO ETB                    42680020
         NI    SCBBSCFM,AVTEFF-SCBRCVTX ASSUME ETB RECEIVED      S21101 42700020
         CLC   0(1,RB),0(RWKA)          ETB RECEIVED                    42720020
         BCR   8,RC                     BRANCH IF YES                   42740020
         CLC   0(1,RB),3(RWKA)          ETX                             42760020
         BNE   CKSENQ                   NO, SEE IF ABORT                42780020
         SPACE                                                          42800020
         OI    SCBBSCFM,SCBRCVTX .      SET ETX RECEIVED         S21101 42820020
         BR    RC                       RETURN                          42840020
         SPACE                                                          42860020
CHKNEG   EQU   *                                                SA68035 42861005
         TM    LCBSTAT1,LCBRECVN        RECEIVE OPERATION       SA68035 42862005
         BCR   14,RD                    BR NO, RETURN           SA68035 42863005
         TM    LCBCSW+THREE,UNEX        EOT RECEIVED            SA68035 42864005
         BCR   14,RD                    BR NO, RETURN           SA68035 42865005
         TM    LCBSTAT2,LCBSYNC+LCBDIAL BISC DIAL LINE          SA68035 42866005
         BCR   14,RD                    BR NO, RETURN           SA68035 42867005
         OI    SCBBSCFM,SCBNOEOT        SET FLAG FOR SEND SCHED@OY11499 42868091
*                                       AND ACTIVATE           @OY11499 42868591
         OI    LCBSTAT2,LCBNEGRP        SHOW NEG RESP TO POLL  @OZ18753 42868791
*                                         TO FORCE SEND NEXT    SA68035 42869005
         BR    RD                       RETURN                  SA68035 42870005
         SPACE 5                                                SA68035 42871005
CKSENQ   EQU   *                                                        42880020
         IC    RE,ENQCH(,RF)            GET ENQ INDEX                   42900020
         LA    RWKA,1(RE,RF)            POINT TO ENQ                    42920020
         OI    SCBERR3,SCBFORMN         SET FORMAT ERROR                42940020
         CLC   0(1,RB),0(RWKA)          THIS AN ABORT                   42960020
         BNE   CKCNT .                  NO, INVALID END CHAR     S99228 42980022
         OI    SCBERR2,SCBABRTN .       SET ABORT                S99228 42981022
         NC    LCBTTCIN(TWO),LCBTTCIN   POLLRT DETERMINE INVALID S99228 42982022
*                                       SOURCE?                  S99228 42982522
         BZ    NOENQERP                 BRANCH YES               S99228 42983022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 42987322
         TM    LCBDCT1,C3270            3270 DEVICE?             S99228 42987622
         BZ    NOENQERP                 NO 3270 SKIP DVC DEP ERP S99228 42988022
         MVI   LCBINCAM,RETRY           SET FOR NO RETRY         S99228 42989022
         LA    RC,SLOWPOLL              LOAD RETURN ADDRESS      S99228 42996322
         B     ENQERP                   SKIP REGULAR RETURN RESETS99228 42996622
NOENQERP EQU   *                                                 S99228 42997022
         LA    RC,NOCKEND               RELOAD RETURN ADDR       S99228 42998022
ENQERP   EQU   *                                                 S99228 42999022
*        AN ENQ WAS READ IN NON-TRANSPARENT MODE.  IF THIS IS   SA44892 43000922
*        A VALID TTD, IT WAS HANDLED IN THE SCAN ROUTINE.       SA44892 43001822
*        IF THIS IS TRANSPARENT MODE, AN ENQ IS A VALID DATA    SA44892 43002722
*        CHARACTER.  IT MUST BE DETERMINED WHETHER THE ENQ      SA44892 43003622
*        CAUSED THE ENDING STATUS OR NOT.  TO BE A VALID TTD, THSA44892 43004522
*        ENQ MUST BE THE ONLY CHARACTER AFTER THE DLE STX.      SA44892 43005422
*                                                                       43006322
         LH    RE,CCWCOUNT .           ORIGINAL CCW COUNT       SA44892 43007222
         BCTR  RE,0 .                  MINUS ONE                SA44892 43008122
         LH    RWKA,LCBCSW+5 .         RESIDUAL COUNT           SA44892 43009022
         CR    RE,RWKA .               WZS ONLY 1 CHARACTER     SA44892 43009922
         BNE   SETABORT .              READ - BR IF NO          SA44892 43010822
         LA    RCCW,0(RCCW) .          ENDING/CURRENT CCW CLEAR SA44892 43011722
         L     RWKA,LCBCPA+12 .        STARTING CCW             SA44892 43012622
         LA    RWKA,0(RWKA) .          CLEAR FOR COMPARE        SA44892 43013522
         CR    RCCW,RWKA .             ARE THEY THE SAME UNIT   SA44892 43014422
         BNE   SETABORT .              BR IF NO                 SA44892 43015322
         TM    CCWFLAGS,CCWSLI .       IS THIS THE RESTART CCW  SA44892 43016222
         BNO   GOTTTD .                BR IF YES - A REAL TTD   SA44892 43017122
SETABORT EQU   * .                                              SA44892 43018022
CKCNT    EQU   *                                                        43020020
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             43040020
         BL    DCKK                     NO TREAT AS DATA CHECK          43060020
         SPACE                                                          43080020
         OI    SCBERR4,SCBTXTTN         SET TEXT ERRRO                  43100020
         MVI   LCBECBCC,PERMERR         SET ERROR INDICATION            43120020
         TM    LCBSTAT2,LCBMSGNN        MSGGEN                 @OY14057 43140091
         BOR   RC                       YES,RETURN             @OY14057 43140691
         L     RE,AVTDOUBX              LOAD LCB EXTENSION     @OY14057 43141291
         TM    LCBDCT1,C3270            3270 DEVICE            @OY14057 43141891
         BNOR  RC                       NO,RETURN              @OY14057 43142491
         STCM  RCCW,AD,LCBCPA+THIRTN    SAVE CCW ADDRESS       @OY14057 43143091
         MVC   LCBCSWSV,LCBCSW          SAVE CSW               @OY14057 43143691
         MVC   LCBSNSV,LCBSENS0         SAVE SENSE BYTE        @OY14057 43144291
         MVI   LCBTPCD+2,TPNULL         NON-READ WIRTE CCW     @OY14057 43144891
         LA    RA,RVICH                 INDEX IN SCT           @OY14057 43145491
         LA    RWKA,LCBCPA+16           CHANNEL PROGRAM AREA   @OY14057 43146091
         BAL   RD,CCWBLD                BUILD CCW              @OY14057 43146691
         MVI   LCBCPA+20,CCWCC+CCWSLI   CMD CHAIN/SUPR INC LNGT@OY14057 43147291
         MVI   LCBTPCD+3,TPRS3270       OP CODE FOR READ EOT   @OY14057 43147891
         LA    RA,1                     ONE                    @OY14057 43148491
         ST    RA,LCBCPA+28             COUNT FOR READ         @OY14057 43149091
         LA    RA,LCBERCCW+4            RESPONSE ADDRESS       @OY14057 43149691
         ST    RA,LCBCPA+24             STORE IN CHANNEL PGM   @OY14057 43150291
         MVI   LCBCPA+24,CCWREAD        READ CCW               @OY14057 43150891
         LH    RC,LCBTTCIN              TERMINAL OFFSET        @OY14057 43151491
         N     RC,AVTCLRHI              IS IT ZERO             @OY14057 43152091
         BZ    RESTCOM                  YES,RESTART            @OY14057 43152691
         L     RA,AVTRNMPT              TNT CODE BASE          @OY14057 43153291
         BAL   RPREFIX,TNTDCODE-IEDQTNTD(RA) FIND TERM ENTRY   @OY14057 43153891
         L     RB,TRMDESTQ-1-IEDQTRM(RB) GET DEST QCB          @OY14057 43154491
         TM    QCBFLAG-IEDQQCB(RB),QCBTSSES TSO                @OY14057 43155091
         BZ    RESTCOM                  NO,BRANCH              @OY14057 43155691
         NI    QCBTSOF2-IEDQQCB(RB),AVTEFF-QCBDSSMI STARTMI OFF@OY14057 43156291
         B     RESTCOM                  WRITE RVI, READ EOT    @OY14057 43156891
         SPACE                                                          43160020
DCKK     EQU   *                                                        43180020
         MVI   LCBCSW+3,UNITCHK         SET ENDING STATUS               43200020
         MVI   LCBSENS0,DATCK           SET DATA CHECK                  43220020
         B     ERPEXIT                  EXIT TO ERP                     43240020
         SPACE 7                                                 S21101 43260020
CKBFMM   EQU   *                                                 S21101 43270020
*        SUBROUTINE WILL DETERMINE IF WE ARE AT TRUE EOM OR TEMP S21101 43272020
* EOM FOR INPUT BUFFERED TERMINAL CUPPORT                        S21101 43274020
*        RPREFIX=ADDRESS OF CURRENT BUFFER                       S21101 43276020
*        RC=PRFSIZE WITH EOT                                     S21101 43278020
         AIF   ('&GEN' EQ 'BISC').Z17A                           S21101 43278420
         TM    LCBSTAT2,LCBSYNC .      BSC LINE                  S21101 43278820
         BNO   4(RB) .                 BRANCH NO -REAL EOM       S21101 43279220
.Z17A    ANOP                                                    S21101 43279620
         CLI   LCBRSKEY,BUFF .          BUFFERED TERMINAL        S21101 43279720
         BNE   4(RB) .                  BRANCH NO, REAL EOM      S21101 43279820
         SPACE 1                                                 S21101 43279920
         CLI   LCBECBCC,PERMERR         PERMANENT ERROR         SA65874 43280905
         BE    4(RB)                    YES, TREAT AS EOM       SA65874 43281905
         SPACE 1                                                        43282905
         TM    SCBBSCFM,SCBRCVTX .      WAS ETX BEFORE EOT       S21101 43286620
         BO    4(RB) .                  BRANCH YES ,REAL EOM     S21101 43288620
         TM    SCBERR2,SCBABRTN         IS IT ABORT            @OS77965 43289291
         BO    4(RB)                    BRANCH YES             @OS77965 43289891
         SPACE 1                                                 S21101 43290620
         OI    PRFSTAT1,PRFITCPN .      SET LOGICAL EOM          X01004 43293005
         BCTR  RC,R0 .                  DECREMENT EOT OUTOF BUFF S21101 43293120
         STH   RC,PRFSIZE .             SET PREFIX SIZE          S21101 43293220
         BR    RB .                     RETURN                   S21101 43299920
.Z17     ANOP                                                    S21101 43300020
         EJECT                                                          43680020
CCWBLD   EQU   *                                                        43700020
*                                                                       43720020
*        THIS SUBROUTINE WILL BUILD A CCW AT THE LOCATION POINTED TO    43740020
* BY RWKA.  RA CONTAINS INDEX INTO SPECIAL CHARACTERS TABLE FOR         43760020
* SEQUENCE DESIRED.                                                     43780020
*                                                                       43800020
         L     RC,LCBDCBPT              GET DCB ADDRESS                 43820020
         USING IHADCB,RC                                                43840020
         L     RB,DCBSCTAD-1            SCT ADDRESS                     43860020
         DROP  RC                                                       43880020
         IC    RA,0(RA,RB)              INDEX INTO SEQUENCE             43900020
         LA    RC,0(RA,RB)              POINT TO COUNT FO SEQUENCE      43920020
         IC    RA,0(,RC)                GET SEQUENCE COUNT              43940020
         ST    RA,4(,RWKA)             SET COUNT                        43960020
         LA    RC,1(,RC)                BUMP TO SEQUENCE                43980020
         ST    RC,0(,RWKA)             SET CCW ADDRESS                  44000020
         MVI   0(RWKA),CCWWRITE        SET COMMAND CODE                 44020020
         BR    RD                       RETURN                          44040020
   SPACE 10                                                             44060020
ENQUEUE  EQU   *                                                        44080020
*                                                                       44100020
*        INPUT:                                                         44120020
*        RPREFIX POINTS TO ELEMENT                                      44140020
*        RF POINTS TO QCB WHICH THE ELEMENT IS TO BE POSTED             44160020
*        RWKA IS USED AS A WORK REGISTER                                44180020
*        RC CONTAINS THE RETURN ADDRESS                                 44200020
*                                                                       44220020
         ST    RF,RECBQCBA-1-IEDQRECB(,RPREFIX) QCB ADDRESS             44240020
         DROP  RAVT                                              Y02027 44260006
         L     RAVT,CVTPTR              PICKUP CVT ADDRESS       Y02027 44270006
         USING CVT,RAVT                                          Y02027 44280006
         L     RAVT,CVTAQAVT           PICKUP ADDR OF TCAM'S     Y02027 44290006
*                                       CVT EXTENSION            Y02027 44300006
         DROP  RAVT                                              Y02027 44310006
         USING IEDQTCX,RAVT                                      Y02027 44320006
         L     CURR,TCXREADY            PICKUP ADDR OF CURRENT   Y02027 44330006
*                                       ELEMENT ON AYNCHRONOUS   Y02027 44340006
*                                       READY QUEUE              Y02027 44350006
NEWCURR  STCM  CURR,SEVEN,PRFLINK .     LINK NEW ELEMENT TO THE  Y02027 44360006
*                                       CURRENT ELEMENT          Y02027 44370006
         CS    CURR,RPREFIX,TCXREADY   .WAS CURRENT ELEMENT      Y02027 44380006
*                                       UPDATED ASYNCHRONOUSLY   Y02027 44390006
         BNE   NEWCURR                  YES, LINK NEW ELEMENT    Y02027 44400006
*                                       TO NEW CURRENT ELEMENT   Y02027 44410006
*                                       NO, ASYNCHRONOUS RDY Q   Y02027 44420006
*                                       IS UPDATED WITH NEW ELEM Y02027 44430006
*                                       BY COMPARE-AND-SWAP INST Y02027 44440006
         L     RAVT,TCXAVT              RESTORE AVT ADDRESS      Y02027 44450006
         DROP  RAVT                                              Y02027 44460006
         USING IEDQAVTD,RAVT                                     Y02027 44470006
         SPACE                                                          44600020
         TM    AVTOSECB,COMPLETE        ARE WE IN WAIT STATE            44620020
         BCR   1,RC                     BRANCH NO                       44640020
         SPACE                                                          44660020
POSTECB  EQU   *                                                        44680020
         STM   9,10,ECBSAVE             SAVE REGISTERS           S99228 44700022
         STM   R11,R15,LCBERCCW+4       SAVE REGISTERS                  44720020
         LA    R11,AVTOSECB             ECB TO BE POSTED                44740020
         L     RCCW,AVTTCB .            TCB ADDRESS                     44800020
         SR    RD,RD                    CLEAR REG 10             A42413 44818021
         L     R15,CVTPTR .             PICKUP CVT ADDRESS       Y02027 44818606
         L     R15,CVT0PT01-CVT(,R15) . ADDR OF POST ROUTINE     Y02027 44819206
         BALR  R14,R15                  LINK TO POST                    44820020
         LM    R11,R15,LCBERCCW+4       RESTORE REGISTERS               44840020
         LM    9,10,ECBSAVE             RESTORE REGISTERS        S99228 44860022
         BR    RC                       RETURN                          44880020
         SPACE 2                                                        44886022
ECBSAVE  DS    D                        POSTECB REG SAVE AREA    S99228 44892022
CNTSAVE  DS    2D                                              @OX17153 44892100
         EJECT                                                          44900020
RESTART  EQU   *                        THIS EXIT TO RESTART            44920020
         MVI   LCBTTBIN,AVTEZERO        CLEAR ERP ERROR COUNTER         44940020
         NI    LCBFLAG1,FF-X24          TURN OFF ERROR FLAGS            44960020
         L     R1,AVTSAVEX+THIRTY2      IOSB ADDRESS           @ZA02095 44963061
         USING IOSB,R1                                           Y02027 44966006
         XC    IOSSNS,IOSSNS            CLEAR SENSE BYTES        Y02027 44969006
         DROP  R1                                                       44975006
         L     14,AVTDPARM              RETURN REGISTER                 44980020
         LA    14,8(,14)                BUMP FOR RESTART                45000020
         B     IOSEXIT                  LEAVE                           45020020
POSTELE  EQU   *                        POST BUFFERS AND LCB            45040020
FREERQE  EQU   *                                                        45060020
         L     14,AVTDPARM              RETURN REGISTER                 45080020
         LA    14,4(,14)                BUMP TO SKIP POST               45100020
         B     IOSEXIT                  LEAVE                           45120020
ERP      EQU   *                                               @OX21187 45140086
         CLI   LCBCPA+24,CCWPOLL        AUTOPOLL               @OX21187 45140186
         BNE   NAPCHAP                  BRANCH NO              @OX21187 45140286
         LA    RCCW,0(,RCCW)            DETERMINE              @OX21187 45140386
         LA    RA,LCBCPA                IF                     @OX21187 45140486
         SR    RA,RCCW                  CONTROL                @OX21187 45140586
         BP    YEXTEXT                  MODE                   @OX21187 45140686
         SR    RB,RB                    INTERRUPT              @OX21187 45140786
         L     RC,LCBDCBPT              BECAUSE                @OX21187 45140886
         USING IHADCB,RC                IF                     @OX21187 45140986
         IC    RB,DCBEIOBX              INTERRUPT              @OX21187 45141086
         DROP  RC                       IS                     @OX21187 45141186
         LA    RB,0(RLCB,RB)            CONTROL                @OX21187 45141286
         SR    RB,RCCW                  MODE                   @OX21187 45141386
         BNP   YEXTEXT                  AND                    @OX21187 45141486
         LPR   RA,RA                    HAS                    @OX21187 45141586
         SRL   RA,3                     OPEN                   @OX21187 45141686
         LA    RA,LCBTPCD(RA)           TPOPCODE               @OX21187 45141786
         CLI   0(RA),TPOPEN             THEN                   @OX21187 45141886
         BE    NAPCHAP                  NO SCB DETERMINATION   @OX21187 45141986
YEXTEXT  EQU   *                                               @OX21187 45144086
         AIF   ('&GEN' EQ 'MINI').NO1                          @OZ25960 45145200
         CLI   0(RCCW),CCWWRITE         INTERRUPT ON WRITE     @OZ25960 45145800
         BE    NAPCHAP                  BRANCH YES             @OZ25960 45146400
         L     RF,POLLADR               ADDR OF AUTOPOLL RTN   @OZ16540 45148291
         BALR  R14,RF                   BRANCH TO IT           @OZ16540 45148391
.NO1     ANOP                                                  @OZ16540 45148491
         L     RA,LCBDCBPT              GET DCB ADDRESS         SA62984 45148605
         USING IHADCB,RA                                        SA62984 45149205
         TM    DCBPCI,RCVPCI            PCI=A ON RECEIVE        SA62984 45149805
         BO    NAPCHAP                  BR YES                  SA62984 45150405
         DROP  RA                                               SA62984 45151005
         MVI   LCBCPA+53,AVTEFF         SET ERP FOR AUTOPOLL    SA59028 45152022
NAPCHAP  EQU   *                                                SA59028 45156022
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'BISC').NO2               45160020
         AIF   ('&GEN' EQ 'QTAM').NO2                                   45180020
         TM    LCBTSOB,LCBPREP .        MONITOR STATE               TSO 45200020
         BO    RTPREP .                 BRANCH YES                  TSO 45220020
*                                                                   TSO 45240020
.NO2     ANOP                                                           45260020
ERPEXT   EQU   *                                                 Y02027 45270006
         L     14,AVTDPARM              RETURN RGISTER                  45280020
IOSEXIT  EQU   *                                                        45300020
         LM    0,9,AVTSAVEX             RESTORE REGISTERS               45400020
         BR    R14                      RETURN                          45420020
         AIF   ('&GEN' EQ 'MINI').NO2B .                         S22025 45421022
         SPACE 3                                                 S22025 45422022
DCTBASE  EQU   * .                                               S22025 45423022
*    THIS ROUTINE GETS THE ADDRESS OF THE DEVICE CHARACTERISTICS S22025 45424022
*    TABLE.                                                      S22025 45425022
         LH    RC,LCBTTCIN .            TERMINAL OFFSET          S22025 45426022
         L     RA,AVTRNMPT .            TNT CODE BASE            S22025 45427022
         USING IEDQTNTD,RA .                                     S22025 45428022
         BAL   RPREFIX,TNTDCODE .       FIND TERMINAL TYPE       S22025 45429022
         USING IEDQTRM,RB .                                      S22025 45430022
         SR    RA,RA .                  CLEAR FOR INDEX          S22025 45431022
         IC    RA,TRMCHCIN .            CHARACTERISTICS INDEX    S22025 45432022
         BCTR  RA,0 .                   DECREMENT                S22025 45433022
         MH    RA,AVTDCTLN              LENGTH OF DCT ENTRY    @G36XRIV 45434000
         A     RA,AVTCSTCS .            DCT BASE                 S22025 45435022
         DROP  RA .                                              S22025 45436022
         DROP  RB .                                              S22025 45437022
         BR    RD .                     RETURN TO CALLER         S22025 45438022
.NO2B    ANOP                                                    S22025 45439022
         SPACE 3                                                        45440020
H3       DC    H'3'                                                     45460020
H8       DC    H'8'                                                     45480020
AVTBACK  DC    AL2(AVTSAVE2-IEDQAVTD)                                   45500020
D41STICS DC    X'F80400' .              2741 CHARACTERISTICS     X01004 45506005
D50STICS DC    X'301014' .              1050 CHARACTERISTICS     X01004 45512005
         AIF   ('&GEN' EQ 'MINI').ME1                            S22029 45540022
.L58     AIF   ('&GEN' EQ 'STSP').ME1                            S22029 45560022
         AIF   ('&GEN' EQ 'QTAM').ME1                            S22029 45580022
         EJECT                                                          45600020
         USING *,RF                                                     45620020
BSC270X  EQU   *                                                        45640020
*     THE FOLLOWING CODE SETS UP RCCW AND THE RESIFUAL COUNT FOR        45660020
* BSC WRITE OPERATIONS.  RESIDUAL COUNT CAN BE UP TO 7 LESS THAN        45680020
*  ACTUAL STATUS                                                        45700020
         USING IEDQSCB,RSCB                                             45720020
         TM    SCBSTATE,SCBTRANP        TRANSPARENT                     45740020
         BZ    ITSNTR                   NO                              45760020
         LA    RA,LCBCPA+24             EXIT INDICATOR FROM UNIT        45780020
         LR    RE,RCCW                  GET INTERRUPTED CCW COPIED      45800020
         SPACE                                                          45820020
ERTRLP   EQU   *                                                        45840020
         LR    RB,RE                    SAVE CCW POINTER                45860020
         L     RE,PRFTIC-IEDQPRF(,RE)   NEXT CCW                        45880020
         LA    RE,0(,RE)                CLEAR HI ORDER BYTE             45900020
         CLR   RE,RA                    THIS THE EXIT UNIT              45920020
         BNE   ERTRLP                   NO                              45940020
         MVC   PRFTIC+1-IEDQPRF(3,RB),LCBCPA+57 SET UP TIC TO NEXT      45960020
*                                         UNIT (FOR CLEANUP             45980020
         B     NOTBSC                                                   46000020
         SPACE 3                                                        46020020
ITSNTR   EQU   *                                                        46040020
         CLI   LCBCSW+6,0               RESIDUAL COUNT ZERO             46060020
         BNE   ITSETB                   NO                              46080020
         SPACE                                                          46100020
         CLI   CCWCOUNT+1,1             ORIGINAL COUNT 1-ONLY OET       46120020
         BNE   ITSETB                   NO SCAN FOR ENDING CHARACTER    46140020
         TM    CCWFLAGS,CCWCD+CCWSLI+CCWCC  ANY FLAGS SET        A42376 46160020
         BC    8,NOTBSC                                                 46180020
         SPACE                                                          46200020
ITSETB   EQU   *                                                        46220020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 46240020
         USING IHADCB,RA                                                46260020
         L     RE,DCBSCTAD-1            SCT ADDRESS                     46280020
         DROP  RA                                                       46300020
         LA    RDCB,9                   ASSUME WORST CASE               46320020
         L     RA,CCWADDR-1             DATA ADDRESS                    46340020
         LR    RC,RA                    SAVE FRO FUTUTE TEST            46360020
         AH    RA,CCWCOUNT              ADD ORIGINAL COUNT              46380020
         LH    RB,LCBCSW+5              RESIDUAL COUNT FROM CSS         46400020
         LA    RB,9(,RB)                ADJUST CSW FOR WORST CASE       46420020
         SR    RA,RB                    NEW DATA ADDRESS FOR SEARCH     46440020
         CR    RA,RC                    NEW LESS THAN ORIGINAL          46460020
         BL    CHKCCW                   BRANCH YES- 2 CASES:            46480020
*                                       VERY SHORT BLOCK IN THIS        46500020
*                                       CCW OR CHANNEL HAS FETCHED      46520020
*                                       THE NEXT CCW IN CHAINE          46540020
        SPACE                                                           46560020
ETBEXIT  EQU   *                                                        46580020
         LA    RWKA,SKIPCLR             SET EXIT FROM LOOP      SA59538 46600022
FINDETB  EQU   *                                                        46620020
         SR    RB,RB                    CLAR WORK REGISTER              46640020
         IC    RB,ENQCH(,RE)            ENQ OFFSET                      46660020
         LA    RB,1(RB,RE)              POINT TO SEQUENCE       SA54276 46680022
         BCTR  RA,0                     ADJUST FOR LOOP                 46700020
SRCHLOOP EQU   *                                                        46720020
         LA    RA,1(,RA)                BUMP TO NEX T POSITION IN       46740020
*                                         BUFFER                        46760020
         CLC   0(1,RB),0(RA)            ENQ                     SA54276 46780022
         BE    ENDFOUND                 YES                             46800020
         CLC   3(1,RB),0(RA)            ETB                     SA54276 46820022
         BE    ENDFOUND                 YES                             46840020
         CLC   6(1,RB),0(RA)            ETX                     SA54276 46860022
         BE    ENDFOUND                 YES                             46880020
         SPACE                                                          46900020
         BCT   RDCB,SRCHLOOP            BUMP TO NEXT POSITION           46920020
         BR    RWKA                     RETURN                          46940020
         SPACE                                                          46960020
ENDFOUND EQU   *                                                        46980020
         TM    SCBQTYPE,SCBCONC         CONCENTRATOR?          @YA08108 46981000
         BO    UNITERM                  BRANCH IF YES          @YA08108 46982000
         MVI   0(RA),AVTEZERO           ZERO END CHAR TO        SA55941 46985022
*                                         PREVENT LOOP ON NEXT  SA55941 46990022
*                                         INTERRUPT             SA55941 46995022
UNITERM  EQU   *                                               @YA08108 46995500
SKIPCLR  EQU   *                                                SA59538 46996022
         NI    LCBCSW+4,X'FD'           RESET SCAN SWITCH       SA57685 46997022
         BCTR  RDCB,0                   ADJUST                          47000020
         LTR   R0,RDCB                  TEST FOR NEGATIVE COUNT         47020020
         L     RDCB,LCBDCBPT            RESTORE DCB BASE                47040020
         BC    4,NOTBSC                                                 47060020
         AH    R0,LCBCSW+5              ADD RESIDUAL COUNT              47080020
         STH   R0,LCBCSW+5              CORRECT THE COUNT               47100020
         B     NOTBSC                                                   47120020
         SPACE                                                          47140020
CHKCCW   EQU   *                                                        47160020
         TM    LCBCSW+4,CSWPC           CHAN PROGRAM CHECK      SA65357 47161052
         BNO   GETTEXT                  BR NO, TREAT NORMALLY   SA65357 47162052
         L     RWKA,LCBCPA+12           GET LAST TEXT CCW       SA65357 47163052
         LA    RWKA,0(,RWKA)            CLEAR HI BYTE           SA65357 47164052
         L     RPREFIX,LCBLSPCI-1       GET FIRST BUFFER CCW    SA65357 47165052
SEARCH   EQU   *                                                SA65357 47166052
         LA    RPREFIX,0(,RPREFIX)      CLEAR HI BYTE           SA65357 47167052
         CR    RPREFIX,RWKA             LAST TEXT CCW IN CHAIN  SA65357 47168052
         BE    GETTEXT                  BR YES, TREAT NORMALLY  SA65357 47169052
         TM    PRFTIC+3,TWO             IS THERE ANOTHER CCW    SA65357 47170052
         BO    GETLSPCI                 BR NO, START WITH PCI   SA65357 47171052
         L     RPREFIX,PRFTIC           GET NEXT CCW            SA65357 47172052
         B     SEARCH                   AND CONTINUE SEARCH     SA65357 47173052
GETLSPCI EQU   *                                                SA65357 47174052
         L     RWKA,LCBLSPCI-1          GET FIRST TEXT BUFFER   SA65357 47175052
         B     GETTEXT1                 AND CONTINUE            SA65357 47176052
GETTEXT  EQU   *                                                SA65357 47177052
         L     RWKA,LCBCPA+12           LAST TEXT CCW                   47180020
*                                         RESTART                       47200020
GETTEXT1 EQU   *                                                SA65357 47210052
         LA    RWKA,0(,RWKA)            CLEAR HI ORDER BYTE             47220020
         CR    RWKA,RCCW                WAS A SHORT BLOCK XENT          47240020
         BNE   PREVCCW                  BRANCH NO RCCW IS POINTING      47260020
*                                         TO NEXT CCW IN CHAIN          47280020
         L     RPREFIX,LCBLSPCI-1 .     LAST SERVICED BUFFER - IT       47300020
*                                         MIGHT BE A VERY SMALL MSG     47320020
*                                         OR LAST PART OF MSG TO        47340020
*                                         BUFFERED TERMINAL. IN         47360020
*                                         EITHER CASE THERE IS NO       47380020
*                                         PREVIOUS UNIT.                47400020
         LA    RPREFIX,AVTEZERO(,RPREFIX) CLEAR HI ORDER BYTE           47420020
         CR    RPREFIX,RWKA .           IS THE ABOVE CASE TRUE?         47440020
         BE    THISISIT .               BRANCH IF YES                   47460020
         SPACE                                                          47480020
         TM    CCWFLAGS,CCWSLI          HAS THIS CCW BEEN RE-USED       47500020
*                                         VIA PCI                       47520020
         BO    PREVCCW                  BRANCH IF YES                   47540020
         SPACE                                                          47560020
THISISIT EQU   *                                                        47580020
         SR    RA,RC                    DIFFERENCE BETWEEEN NEW         47600020
*                                         DATA ADDRESS AND ORIGINAL     47620020
         LCR   RB,RA                    MAKE DIFFERENCE POSITINVE       47640020
         SR    RDCB,RB                  NUMBER FO POSITIONS FOR SCAN    47660020
         LR    RA,RC                    SET FOR COMMON LOOP             47680020
         TM    LCBCSW+4,X'02'           MORE THAN ONE CCW       SA57685 47700022
         BNO   ETBEXIT                  BR NO, LAST CCW         SA57685 47703022
         LA    RC,9                     ASSUME WORST CASE       SA57685 47706022
         SR    RC,R0                    AMOUNT FOR NEXT CCW     SA57685 47709022
         SR    R0,RB                    ADJUST COUNT THIS CCW   SA57685 47712022
         B     CCWOK                    BR, SET UP FOR SCAN     SA57685 47715022
         SPACE                                                          47720020
PREVCCW  EQU   *                                                        47740020
         L     RPREFIX,LCBLSPCI-1       LST SER ICED BUFFER             47760020
         TM    LCBCSW+4,X'02'           MORE THAN ONE CCW?     @SA73826 47760700
         BNO   PREVCCWX                 BR NO, LAST CCW        @SA73826 47761400
         LA    RPREFIX,ZERO(,RPREFIX)   CLEAR FOR COMPARE      @SA73826 47762100
         CR    RPREFIX,RCCW             IS THIS THE CCW?       @SA73826 47762800
         BE    THISISIT                 BRANCH YES             @SA73826 47763500
PREVCCWX EQU   *                                               @SA73826 47764200
         OI    LCBCSW+4,X'02'           SET MULTIPLE CCW SWITCH SA57685 47765022
*                                         USE INTERFACE CONTROL SA57685 47770022
*                                         BIT RESET LATER       SA57685 47775022
LOOPCCW  EQU   *                                                        47780020
         LR    RDCB,RPREFIX             SAVE FOR LOOP CONTROL           47800020
         L     RPREFIX,PRFTIC           NEXT BUFFER(UNIT) FROM TIC      47820020
         LA    RPREFIX,0(,RPREFIX)      CLEAR FOR COMPARE               47840020
         CR    RPREFIX,RCCW             THIS CCW CSW POINTS TO          47860020
         BNE   LOOPCCW                  NO, CONINUE SEARCH              47880020
         SPACE                                                          47900020
         LA    RCCW,0(,RDCB)            PREVIOUS CCW IN CHAIN           47920020
         SR    RC,RA                    GET DIFFERNCE VOR SCAN          47940020
         LR    R0,RC                    AMOUNT FOR PREVIOUS             47960020
         LA    RC,9                     ASSUME WORST                    47980020
         SR    RC,R0                    AMOUNT FOR CURRENT CCW          48000020
         L     RA,CCWADDR-1             DATA ADDRESS PREVIOUS CCW       48020020
         LR    RB,RA                    SAVE -FUTURE UXE                48040020
         AH    RA,CCWCOUNT              ADD ORIGINAL COUNT              48060020
         SR    RA,R0                    SUBTRACT AMOUNT FOR SCAN        48080020
         MVC   LCBRCB(1),LCBCSW+6            CSW RESIDUAL COUNT         48100020
         LR    RC,RB                    RESET REGISTER FOR LOOP  A42376 48110020
         LR    RDCB,R0                 GET COUNT RIGHT           A42376 48112020
         CR    RA,RB                    LESS THAN ORIGINAL ADDRESS      48120020
*                                         POSSIBLE FOR SHORT RECORD     48140020
         BL    CHKCCW                  CK OF IN ONE OF 2 PREVIOUSA42376 48160020
         LA    RC,9 .                  TOTAL BYTES OFF            42376 48170020
         SR    RC,R0 .                 SAVE AMOUNT IN NEXT BUFFER 42376 48180020
CCWOK    EQU   *                                                        48280020
         MVI   LCBCSW+6,0               CLEAR RESIDUAL COUNT            48300020
         LR    RDCB,R0                  SET SCAN COUNT FOR LOOP         48320020
         BAL   RWKA,FINDETB             LOOP FOR ETB OR ETX             48340020
         MVC   LCBCSW+6(1),LCBRCB       RESTORE ORIGINAL CSW COUNT      48360020
         LTR   RC,RC                    COUNT EXHAUSTED?       @SA71694 48366061
         BZ    SKIPCLR                  BR YES, CHAN PROG CHECK@SA71694 48372061
         L     RCCW,8(,RCCW)            NO ETB OR ETX IN PREVIOUS       48380020
         LA    RCCW,0(,RCCW)            MUST BE NEXT CCW                48400020
         L     RA,CCWADDR-1             DATA ADDRESS -NEXT CCW          48420020
         LR    RDCB,RC                  SET SCAN COUNT                  48440020
         LH    R0,CCWCOUNT             IS WHATS LEFT             A42376 48460020
         SR    RC,R0                           IN TNE NEXT CCW   A42376 48470020
         BM    ETBEXIT                  YES, USE COMMON CODE   @SA70874 48472061
         B     CCWOK                   NO, LOOP BACK AND CK NEXT A42376 48474020
         EJECT                                                          48480020
         USING *,RF                                                     48500020
SCAN     EQU   *                                                        48520020
*    SCBTRNSP OR SCBNONTR IS SET UPON RECEIPT OF FIRST BLOCK OF DATA    48540020
* AND RESET IN BUFFER DISPOSITION.  IT'S PURPOSE IS TO DETERMINE        48560020
* LCBISZE AND TYPE OF MSG RECEIVED FOR SUBSEQUNET CONTINUE SEQUENCES    48580020
* I/O GENERATOR MIGHT BUILD A READ OF COUNT 1 OR 2 AFTER WRITE ACK/NAK  48600020
* IF LCOUT IS IN USE.  ON SUBSEQUENT BLOCKS OF DATA THE SCAN ROUTINE    48620020
* LOOKS FOR LINE CONTROL CHARACTERS IN LCBERCCW+12 IF LCOUT IS IN USE.  48640020
*     LCBVSTRT OR LCBRSTRT IS SET BY SCAN TO INFORM PCI APPENDAGE       48660020
* ON SUBSEQUENT PCI'S AND LINE END THAT SCAN HAS COMPLETED.             48680020
*    WHEN LCBVSTRT IS SET, ONE OF THE FOLLOWING SILL ALSO BE SET:       48700020
* LCBTTD,LCBENQ,LCBEOT,LCBOLT.  LCBRSTRT IS SET WHEN AN INVALID         48720020
* START CHARACTER IS DETECTED OR IF USER IS NOT MAINTAINING             48740020
* TRANSPARENCY OR NON-TRANSPARENCY FOR THIS MESSAGE.  THESE BITS ARE    48760020
* RESET IN ACTIVATE.                                                    48780020
         DROP  RSCB                                                     48800020
         SR    RB,RB                    CLEAR WORK REGISTER             48820020
         L     RC,LCBSCBA-1             SCB ADDRESS                     48840020
         USING IEDQSCB,RC                                               48860020
         L     RWKA,AVTSAVEX+TWLVE      DEB ADDRESS              X02004 48880005
         L     RA,DEBAPPAD-DEBNMSUB(,RWKA) APPENDAGE TABLE       X02004 48886005
         TM    TWO(RA),X80              IS ALTMH SPECIFIED       X02004 48892005
         BZ    DCBMHLC                  BRANCH NO                S22029 48903022
         TM    LCBSTAT2,LCBDIAL         DIAL LINE?               S22029 48904022
         BO    DCBMHLC                  BRANCH YES               S22029 48905022
         NC    LCBTTCIN,LCBTTCIN        IS CONNECTED INDEX ZERO  S22029 48906022
         BZ    DCBMHLC                  YES - USE OWNING MH LC   S22029 48908022
         LA    RWKA,FINDQCB .           GET ADDR OF ROUTINE USED S22029 48909022
*                                       TO FIND DESTINATION QCB  S22029 48910022
         BALR  RE,RWKA .                GET DEST QCB ADDRESS     S22029 48911022
         LR    RE,R0 .                  FOR CONNECTED MH TEST    S22029 48912022
         TM    QCBDSFLG-IEDQQCB(RE),QCBALTMH IS TERMINAL         S22029 48940022
*                                       CONNECTED TO ALTMH       S22029 48943022
         BZ    DCBMHLC .                NO - USE OWNING MH LC    S22029 48946022
         LA    RA,ONE(,RA)              USE ALTMH OPTIONS        X02004 48949005
DCBMHLC  EQU   * .                                               S22029 48952022
         MVC   LCBERCCW+1(ONE),0(RA)    SAVE STARTMH OPTIONS     X02004 48955005
         L     RPREFIX,LCBLSPCI-1 .     GET HEADER BUFFER        S21101 48980020
         TM    SCBBSCFM,SCBTRNSP+SCBNONTR TYPE MESSAGE DETERMINEDS21101 49040020
         IC    RB,LCBISZE .             GET IDLES RESERVED       S21101 49041020
         LA    RWKA,PRFSHDR(RB) .       SET INITIAL SCAN IF FIRSTS21101 49042020
         ST    RWKA,LCBERCCW+4 .        SAVE IT FOR LATER        S21101 49043020
         BZ    NOTSET .                 BRANCH VERY FIRST BLOCK  S21101 49044020
         SPACE 1                                                 S21101 49045020
         TM    PRFSTAT1,PRFNHDRN .      HEADER BUFFER            S21101 49046020
         BO    SET .                    BRANCH IF NO             S21101 49047020
         SPACE 1                                                 S21101 49048020
         TM    SCBQTYPE,SCBBFMM .       MIDDLE OF MESSAGE        S21101 49049020
         BZ    SET .                    BRANCH IF NO             S21101 49050020
*                                                                S21101 49051020
*        THE FOLLOWING CODE IS EXECUTED FOR INPUT BUFFERED       S21101 49052020
* TERMINAL SUPPORT SUCH AS ENQUIRY MODE ON 2770.  WE ARE READING S21101 49053020
* A SUBSEQUNET BLOCK OF A MESSAGE AND THE HEADER BUFFER MUST BE  S21101 49054020
* CONVERTED TO A TEXT BUFFER.  THE CCW IS REBUILT OR POSSIBLE    S21101 49055020
* ERROR RETRIES BY ERP AND FOR RECEPTION OF TTD, ENQ, ETC.  A    S21101 49056020
* FLAG IS SET IN THE TIC FIELD (PRFBFMM) TO INDICATE TO MH THAT  S21101 49057020
* IDLES FOR THIS BUFFER ARE SET IN LCBISZE.                      S21101 49058020
*                                                                S21101 49059020
         TM    PRFTIC,PRFBFMM .         MID MSG SITUATION        S22025 49060022
         BO    SET .                    BRANCH IF YES            S22025 49060422
*                                                                S22025 49060822
         OI    PRFTIC,PRFBFMM .         SET HEADER CONVERTED     S22025 49061222
*                                         TO TEXT                S22025 49061622
         NI    PRFFLAGS,AVTEFF-CCWSLI . RESET WRAP SWITCH        S21101 49063020
         TM    SCBBSCFM,SCBTRNSP .      RECEIVEING TRANSPARENT   S21101 49064020
         BZ    ITSNONTR .               BRANCH IF NO-TEST LCIN   S21101 49065020
         SPACE 1                                                 S21101 49066020
         BAL   RB,SETISZE .             BUMP IDLES  COUNT        S21101 49067020
ITSOUT   EQU   *                                                 S21101 49068020
         BAL   RB,SETISZE .             TWO FOR TRANSPARENT      S21101 49069020
         B     ADJBUF .                 NOW RESET BUFFER CCW FOR S21101 49070020
*                                         ERP AND OTHER -TTD,ENQ S21101 49071020
         SPACE 1                                                 S21101 49072020
ITSNONTR EQU   *                                                 S21101 49073020
         TM    LCBERCCW+ONE,IN          LINE CONTROL IN?         S99228 49074022
         BZ    ITSOUT .                 BRANCH IF LCOUT -BUMP IDLS21101 49075020
*                                         PAST STX               S21101 49076020
ADJBUF   EQU   *                                                 S21101 49077020
         BAL   RE,BLDBUFF1 .            REBUILD BUFFER USING NEW S21101 49078020
*                                         IDLES COUNT            S21101 49079020
         L     RC,LCBSCBA-1 .           RESET SCB BASE           S21101 49080020
NOTSET   EQU   *                                                 S21101 49088020
         L     RPREFIX,LCBERCCW+4 .     DATA ADDRESS IN BUFFER   S21101 49089020
*                                         TO SCAN FOR LINE CNTROLS21101 49090020
         B     SCANTEST .               START THE SCAN           S21101 49091020
         SPACE 5                                                 S21101 49092020
.ME1     ANOP                                                           49096022
FINDQCB  EQU   * .                                               S22029 49100022
* THIS ROUTINE GETS THE ADDRESS OF THE DESTINATION QCB           S22029 49104022
         STM   RPREFIX,RC,SUBSAVE-FINDQCB(RWKA) .SAVE REGISTERS  S22029 49108022
*                                       USED BY TNT CODE         S22029 49112022
         LH    RC,LCBTTCIN .            GET CONNECTED INDEX      S22029 49116022
         L     RA,AVTRNMPT .            GET TNT CODE BASE        S22029 49120022
         BAL   RPREFIX,TNTDCODE-IEDQTNTD(RA) .GO GET TERM TABLE  S22029 49124022
*                                       ENTRY                    S22029 49128022
         L     R0,AVTEZERO(RB) .        GET ADDR OF DEST QCB     S22029 49132022
SUBREGS  LM    RPREFIX,RC,SUBSAVE-FINDQCB(RWKA) .RESTORE REGS    S22029 49136022
         BR    RE .                     RETURN TO CALLER         S22029 49140022
SUBSAVE  DS    4F .                     REGISTER SAVE AREA       S22029 49144022
         AIF   ('&GEN' EQ 'MINI').L70                            S22029 49148022
         AIF   ('&GEN' EQ 'STSP').L59                            S22029 49152022
         AIF   ('&GEN' EQ 'QTAM').L59                            S22029 49156022
SET      EQU   *                                                        49160020
         SPACE                                                          49180020
         L     RWKA,LCBCPA+12 .         GET CURRENT CCW          S21101 49200020
         LA    RPREFIX,LCBERCCW+12 .    SCAN AREA                S21101 49201020
         LA    RA,ONE(,RPREFIX) .       ASSUME TRANSPARENT       S21101 49202020
         TM    SCBBSCFM,SCBTRNSP .      TRANSPARENT MODE         S21101 49220020
         BO    TRCOM                    BRANCH IF YES                   49240020
         BCTR  RA,R0                    ADJUST-LCIN,LCOUT-NONTRANSP     49260020
         TM    LCBERCCW+ONE,IN          LINE CONTROL IN?         S99228 49280022
         BO    NOTR                     BRANCH IF LCIN                  49300020
         SPACE                                                          49320020
TRCOM   EQU   *                                                         49340020
         LR    RE,RWKA                  COPY CCW ADDRESS                49360020
         CLI   CCWCOUNT+1-CCW(RWKA),3   AT LEAST 3 CHARACTERS           49380020
        L     RWKA,CCWADDR-1-CCW(,RWKA) DATA ADDRESS                    49400020
         BH    MOVEIT                   YES                             49420020
         LH    RB,CCWCOUNT-CCW(RE)  GET COUNT                           49440020
         BCTR  RB,0                     FOR EXECUTE                     49460020
         EX    RB,MOVELC                MOVE                            49480020
         LA    RA,1(RA,RB)              ADJUST SCAN AREA                49500020
         TM    11(RE),X'03'             IS THERE NEXT UN IT             49520020
         BNZ   SCANTEST                 NO                              49540020
         L     RE,8(,RE)                GET NEXT UNIT                   49560020
         L     RE,CCWADDR-1-CCW(,RE)    GET DATA ADDRESS                49580020
         MVC   0(3,RA),0(RE)            MOVE DATA                       49600020
         B     SCANTEST                 SCAN DATA                       49620020
MOVEIT   EQU   *                                                        49640020
        MVC   1(2,RA),0(RWKA)          MOVE DATA FOR SCAN               49660020
         B     SCANTEST                 START SCAN                      49680020
         SPACE                                                          49700020
NOTR    EQU   *                                                         49720020
         LR    RPREFIX,RWKA             GET CURRENT CCW ADDRESS         49740020
         CLI   PRFCOUNT+1,3             AT LEAST 3 CHARCTERS            49760020
         BH    NOMOVE                   YES                             49780020
         LH    RWKA,PRFCOUNT            GET COUNT                       49800020
         L     RB,PRFIOADR-1            GET DATA ADDRSS                 49820020
         BCTR  RWKA,0                   FOR EXECUTE                     49840020
         EX    RWKA,MOVESCAN            MOVE REMANING COUNT             49860020
         LA    RA,1(RA,RWKA)            ADJUST SCAN AREA                49880020
         TM    PRFTIC+3,X'03'           IS THERE NEXT UNIT              49900020
         BNZ   STARTSCN                 NO                              49920020
         L     RPREFIX,PRFTIC           NEXT C W                        49940020
         L     RB,PRFIOADR-1            DATA DADDRESS                   49960020
         LA    RWKA,2                   MOVE AT LEAST 3                 49980020
         EX    RWKA,MOVESCAN            MOVE DATA                       50000020
STARTSCN EQU   *                                                        50020020
         LA    RPREFIX,LCBERCCW+12      SCAN AREA                       50040020
         B     SCANTEST                 SCAN THE DATA                   50060020
         SPACE                                                          50080020
NOMOVE   EQU   *                                                        50100020
         L     RPREFIX,PRFIOADR-1       FOR SCAN                        50120020
SCANTEST EQU  *                                                         50140020
         L     RA,LCBDCBPT              GET DCB ADDRESS                 50160020
         USING IHADCB,RA                                                50180020
         L     RE,DCBSCTAD-1            SCT ADDRESS                     50200020
         DROP  RA                                                       50220020
         SR    RA,RA                    CLEAR EORK REGISTER             50240020
         IC    RA,STXENQCH(,RE)         TTD OOFFSET                     50260020
         LA    RWKA,1(RA,RE)            POINT TO SEQUENC                50280020
         CLC   1(2,RWKA),0(RPREFIX)     STX ENQ                         50300020
        BNE   NOTTTD                   NO                               50320020
         OI    SCBERR2,SCBABRTN         POSSIBLE ABORT                  50340020
         OI    SCBERR4,SCBTXTTN         SET TEXT ERROR                  50360020
         OI    LCBMSGFM,LCBTTD+LCBVSTRT . SAET STATUS            S21101 50380020
         TM    SCBBSCFM,SCBTRNSP+SCBNONTR TYPE MSG DETERMINED  @OS76474 50390000
         BCR   7,RD                     Y- NO NEED TO UPDTE CCW@OS76474 50460000
         SPACE 5                                                 S21101 50540020
BLDBUFF  EQU   *                                                        50560020
         LR    RE,RD .                  SET FINAL EXIT ADDRESS   S21101 50570020
BLDBUFF1 EQU   *                                                 S21101 50572020
*        REBUILD BUFFER IF FIRST BLOCK FROM POLLING                     50580020
         L     RPREFIX,LCBLSPCI-1       LAST SERVICED BUFFER            50600020
         SR    RWKA,RWKA                CLEAR WORK REGISTER             50620020
         IC    RWKA,LCBISZE             NO OF IDLES FOR HEADER          50640020
         LA    RWKA,PRFSHDR(RWKA)          PREIX PLUS IDLES             50660020
         L     RB,PRFIOADR-1            DATA ADDRESS                    50680020
         LR    RC,RB                    SAVE FOR UPDATE                 50700020
         LA    RB,0(,RB)                CLEAR HI ORDER BYTE             50720020
         SR    RB,RWKA                  FIND DIFFERNCE IN ADDRESS       50740020
         SR    RC,RB                    NEW LOWER DATA DADRESS          50800020
         AH    RB,PRFCOUNT              ADJUST COUNT                    50820020
         ST    RC,PRFIOADR-1            NEW DATA ADDRESS                50840020
         STH   RB,PRFCOUNT              SET NEW COUNT                   50860020
         BR    RE .                     REUTRN TO CALLER         S21101 50880020
NOTTTD   EQU   *                                                        50900020
         CLC   1(1,RWKA),0(RPREFIX)     STX RECEIVED                    50920020
         BNE   TRTTD                    NO TRY TRANSPARENT TTD          50940020
STXREC   EQU   *                                                        50960020
         TM    SCBBSCFM,SCBTRNSP .      TRANSPARENT              S21101 50980020
         BNZ   ERRSET                   YES, WRONAG FORMAT              51000020
         TM    SCBBSCFM,SCBNONTR .      NON-TRANSPARENT MODE     S21101 51020020
         BNZ   ITSET                    YES                             51040020
         TM    LCBERCCW+1,IN            LCIN                            51060020
         BO    ITSET                    YES                             51080020
         SPACE                                                          51100020
         BAL   RB,SETISZE               BUMP IDLES                      51120020
ITSET    EQU   *                                                        51140020
         OI    SCBBSCFM,SCBNONTR .      SET NONTRANSPARENT BIT   S21101 51160020
ALLSET   EQU   *                                                        51180020
         OI    LCBMSGFM,LCBVSTRT .      VALID START CHARACTER    S21101 51200020
         BR    RD                       RETURN                          51220020
TRTTD    EQU   *                                                        51240020
         CLC   0(2,RWKA),0(RPREFIX) .  STX                      SA44892 51260022
         BNE   NOTRAN                                           SA44892 51290022
         TM    SCBBSCFM,SCBNONTR .    RECEIVING NONTRANSP       SA44892 51320022
         BNZ   SETERR                                           SA44892 51350022
         OI    LCBMSGFM,LCBVSTRT .     VALID START SEQUENCE.    SA44892 51380022
         TM    SCBBSCFM,SCBTRNSP .     ALREADY RECEIVE AT LEAST SA44892 51410022
*                                      ONE DATA SEQUENCE ?      SA44892 51440022
         BCR   7,RD .                  YES, RETURN              SA44892 51470022
         BAL   RB,SETISZE .            BUMP IDLES               SA44892 51500022
         BAL   RB,SETISZE .            BUMP IDLES               SA44892 51530022
         OI    SCBBSCFM,SCBTRNSP .     SET TRANSP . RECEIVE     SA44892 51560022
         B     BLDBUFF .               REBUILD BUFFER FOR CASE  SA44892 51590022
*                                      OF MULTIPOINT LINE .     SA44892 51620022
NOTRAN   EQU   *                                                        51760020
         CLC   2(1,RWKA),0(RPREFIX)     INQ RECEIVED                    51780020
         BNE   NOTENQ                   NO                              51800020
         SPACE                                                          51820020
         OI    LCBMSGFM,LCBVSTRT+LCBENQ SET ENQ START            S21101 51840020
         TM    SCBBSCFM,SCBTRNSP+SCBNONTR TYPE MSG DETERMINED    S21101 51860020
         BCR   7,RD                     BRANSH YES                      51880020
         B     BLDBUFF                  REBUILD CHANNEL PROGRAM@OY11983 51900091
         SPACE                                                          52000020
NOTENQ   EQU   *                                                        52020020
         IC    RA,EOTCH(,RE)            EOT SEQUENCE                    52040020
         LA    RWKA,1(RA,RE)            POINT TO EOT SEQUENCE           52060020
         CLC   0(1,RWKA),0(RPREFIX)     EOT RECEIVED                    52080020
         BNE   TRYSOH                   NOT EOT, TRY SOH                52100020
         OI    LCBMSGFM,LCBEOT+LCBVSTRT SET STATUS BITS          S21101 52120020
         BR    RD                       ERETURN                         52140020
TRYSOH   EQU   *                                                        52160020
         IC    RA,ESOHCH(,RE) .         SOH % E                  S22026 52247022
         LA    RWKA,1(RA,RE) .          POINT TO SEQUENCE        S22026 52254022
         CLC   0(3,RWKA),0(RPREFIX) .   SOH % E SEQUENCE         S22026 52261022
         BE    TPER .                   YES, SET TPER BIT        S99238 52262022
         SPACE                                                          52263022
         IC    RA,CSOHCH(,RE) .         SOH % C                  S99238 52264022
         LA    RWKA,1(RA,RE) .          POINT TO SEQUENCE        S99238 52265022
         CLC   0(3,RWKA),0(RPREFIX) .   SOH % C SEQUENCE         S99238 52266022
         BNE   TRYOLT .                 NO, TRY NEXT SEQUENCE    S22026 52268022
         OI    LCBFLAG3,LCBSOHC         SOH % C MESSAGE          S99238 52270022
TPER     EQU   * .                                               S99238 52272022
         OI    LCBFLAG3,LCBOBRRD .      SET TPER RECORD          S22026 52275022
         B     STXREC .                 GO TO COMMON CODE        S22026 52282022
TRYOLT   EQU   *                                               @OY20488 52289086
         AIF   ('&GEN' EQ 'QTAM' OR '&GEN' EQ 'MINI').LL49              52289186
         AIF   ('&GEN' EQ 'STSP').LL49                         @OY20488 52289286
         IC    RA,RSOHCH(,RE)           INSERT SOHR OFFSET     @OY20488 52289386
         LA    RWKA,1(RA,RE)            POINT TO SOHR CHARS    @OY20488 52289486
         CLC   0(3,RWKA),0(RPREFIX)     SOHR                   @OY20488 52289586
         BNE   PROBOLT                  BRANCH NO              @OY20488 52289686
         OI    SCBERR2,SCBSOHE          SET SOHR MESSAGE FLAG  @OY20488 52289786
         IC    RA,EOTCH(,RE)            EOT OFFSET             @OY20488 52289886
         LA    RWKA,1(RA,RE)            POINT TO EOT CHAR      @OY20488 52289986
         CLI   0(RWKA),ASCIEOT          ASCII TERMINAL         @OY20488 52290086
         BNE   SOHEBCD                  BRANCH NO              @OY20488 52290186
         CLI   SS1(RPREFIX),ASTAT3      IR                     @OY20488 52290286
         BE    STXREC                   BRANCH YES             @OY20488 52290386
         TM    SS1(RPREFIX),ASTAT2      CR,IR,EC,DC,CC         @OZ29663 52290986
         BNZ   YESLOG                   BRANCH YES             @OZ29663 52291286
         TM    SS0(RPREFIX),ASTAT1      DB,DE                  @OZ29663 52291986
         BNZ   STXREC                   BRANCH YES             @OZ29663 52292086
         CLI   SS0(RPREFIX),ASCIDE      DEVICE END ONLY        @OZ29663 52292186
         BE    STXREC                   BRANCH YES             @OZ29663 52292286
         B     YESLOG                   LOG STATUS MESSAGE     @OZ29663 52292386
SOHEBCD  EQU   *                                               @OZ29663 52292486
         OI    LCBFLAG3,LCBSOHR         SET SOH%R MSG INDICATOR  S99228 52293122
         TM    SS1(RPREFIX),STAT2       CR, IR, EC, DC, CC?      S99228 52293322
         BNZ   YESLOG                   YES, LOG SOH%R MESSAGE   S99228 52293522
         TM    SS0(RPREFIX),STAT1       DB, DE?                  S99228 52293722
         BNZ   STXREC                   BRANCH EITHER            S99228 52293922
YESLOG   EQU   *                                                 S99228 52294122
         TM    LCBTSOB,LCBTSBUF         IS THIS TIME SHARING BUF S99228 52294422
         BZ    YESLOG1                  BRANCH ON NO             S99228 52294822
         OI    SCBERR4,SCBTRMLN         SET TERMINAL ERROR FLAG  S99228 52295222
YESLOG1  EQU   *                                                 S99228 52295622
         OI    LCBFLAG3,LCBOBRRD        SET RECORDING FLAG       S99228 52296022
         B     STXREC                   RETURN TO COMMON CODE    S99228 52296422
PROBOLT  EQU   *                                                 S99228 52298922
.LL49    ANOP                                                    S99228 52299422
         IC    RA,TOTESOH(,RE)          SOH % / FOR TOTE         S21903 52300022
         LA    RWKA,1(RA,RE)            POINT TO SEQUENCE        S21903 52306022
         CLC   0(3,RWKA),0(RPREFIX)     ON LINE TEST?            S21903 52312022
         BNE   SOHTRY                   TRY SOH                         52320020
         TM    SCBBSCFM,SCBTRNSP+SCBNONTR 1ST TIME               S21101 52340020
         BNZ   STXREC                   NO                              52360020
         OI    LCBMSGFM,LCBVSTRT+LCBOLT INDICATE OLT REQUEST     S21101 52380020
         OI    SCBBSCFM,SCBNONTR .      SET NONTRANSPARENT BIT   S21101 52400020
         BR    RD                       RETURN                          52520020
SOHTRY   EQU   *                                                        52540020
         CLC   0(1,RWKA),0(RPREFIX)     SOH RECEIVED                    52560020
         BE    STXREC                   YES, USE COMMON CODE            52580020
         IC    RA,DLEEOTCH(,RE)         INDEX TO SEQUENCE               52600020
         LA    RWKA,1(RA,RE)            BUMP TO SEQUENCE                52620020
         CLC   0(2,RWKA),0(RPREFIX)     DLE EOT RECEVIED                52640020
         BNE   ERRSET                   NO                              52660020
         NI    LCBTPCD+11,AVTEFF-DISDLEOT DONT WRITE DLE EOT NEXT       52680020
         OI    LCBMSGFM,LCBEOT+LCBENQ+LCBVSTRT VALID START       S21101 52700020
*                                         SET DLE EOT RECEIVED   S21101 52710020
         OI    LCBSTAT2,LCBNEGRP        SET NEGATIVE RESPONSE           52720020
         MVC   LCBERCCW+12(1),1(RWKA)   MOVE EOT               @OY19728 52740000
         BR    RD                       RETURN                          52750000
ERRSET   EQU   *                                                        52760000
         TM    LCBSTAT2,LCBDIAL         DIAL                            52770000
         BZ    SETERR                   NO                              52780000
         SPACE                                                          52790000
*        THIS MIGHT BE ID ENQ IF CPU ID WAS HIT ON LINE                 52800000
         TM    SCBBSCFM,SCBTRNSP+SCBNONTR 1ST TIME               S21101 52810000
         BNZ   SETERR                   NO, NOT FIRST BLOCK             52820000
         SPACE                                                          52830000
TESTENT  EQU   * .                                               S21101 52840000
         CLI   LCBCPA+24,CCWDISAB .     CONNECTION JUXT MADE     S21101 52850000
         BNE   SETERR .                 BRANCH IF NO             S21101 52860000
         SPACE                                                          52870000
         TM    LCBCSW+3,CEDE            PCI OR LINE END                 52880000
         BCR   8,RD                     BRANCH IF ENTERED FROM PCI      52890000
         TM    LCBCSW+4,PCIFLAG         PCI IN STATUS                   52900000
         BZ    STRTID                   BRANCH NO                       52910000
         XI    LCBCSW+4,PCIFLAG         TURN OFF PCI FOR LINE END       52920000
*                                         ENTRY BEFORE RESTART          52930000
         BR    RD                       RETURN TO PCI                   52940000
STRTID   EQU   *                                                        52950000
         LA    RCCW,LCBCPA+48           ASSUME NO WRITE TONE            52960000
         CLI   LCBTPCD+5,TPWRTONE                                       52970000
         BNE   EXIT3                    NO, RESTART                     52980000
         LA    RCCW,LCBCPA+56           ADDRESS OF WRITE ID ADK         52990000
         B     EXIT3                    TO RESTART                      53000000
SETERR   EQU   *                                                        53010000
         OI    SCBERR3,SCBFORMN         SET FORMAT ERROR                53020000
         OI    SCBERR4,SCBTXTTN         TEXT ERROR                      53030000
         OI    LCBMSGFM,LCBRSTRT .      SET INVALID START        S21101 53040000
         BR    RD                       RETURN                          53050000
MOVELC   MVC   1(1,RA),0(RWKA)          'EXECUTED'                      53060000
MOVESCAN MVC   0(1,RA),0(RB)            'EXECUTED'                      53070000
SETISZE  EQU   *                                                        53080000
         ICM   RPREFIX,AD,LCBLSPCI .    FIRST BUFFER             X01004 53090000
         LH    RA,PRFSIZE .             PICK UP SIZE             X01004 53100000
         LA    RA,ONE(,RA) .            ADD ONE                  X01004 53110000
         STH   RA,PRFSIZE .             RESTORE NEW SIZE         X01004 53120000
         IC    RA,LCBISZE .             PICK UP IDLES COUNT      X01004 53130000
         LA    RA,ONE(,RA) .            ADD ONE                  X01004 53140000
         STC   RA,LCBISZE .             STORE NEW COUNT          X01004 53150000
         BR    RB                       RETURN                          53160000
         DROP  RC                                                       53170000
         USING IEDQSCB,RSCB                                             53180000
         EJECT                                                          53190000
         USING *,RF                                                     53200000
CHACK    EQU   *                                                        53210000
*                                                                       53220000
*        THIS SUBROUTINE INSPECTS ARESPONSE RECEIVED FOR BSC LINES      53230000
* AND SETS FLAGS ACCORDINGLY IN LCBERCCW FOR CALLER TO INTERROGATE.     53240000
*                                                                       53250000
         LH    RA,CCWCOUNT              ORIGINAL COUNT                  53260000
         SH    RA,LCBCSW+5              SUBTRACT RESIDUAL COUNT         53270000
         BCTR  RA,0                     DECREMENT ONE                   53280000
         BCTR  RA,0                     NOW TWO TO RESPONSE             53290000
         L     RB,CCWADDR-1             DATA ADDRESS                    53300000
         AR    RB,RA                    BACK UP TO RESPOSNE AREA        53310000
         L     RA,LCBDCBPT              GET DCB ADDRESS                 53320000
         USING IHADCB,RA                                                53330000
         L     RE,DCBSCTAD-1            SPECIAL CHARACTERS              53340000
         DROP  RA                                                       53350000
         SR    RA,RA                   CLEAR WORK REGIER                53360000
         IC    RA,ACK0CH(,RE)           ACK0 SEQUNCE                    53370000
         LA    RWKA,1(RA,RE)            POIN  TO SEQUENCE               53380000
         CLC   0(2,RWKA),0(RB)          TEST ACK0                       53390000
         BNE   TRACK1      I            TRY ACK1                        53400000
         SPACE                                                          53410000
         MVI   LCBERCCW,RACK0           SET ACK0 INDICATOR              53420000
         BR    RD                       RETURN                          53430000
         SPACE                                                          53440000
TRACK1   EQU   *                                                        53450000
         LA    RWKA,3(,RWKA)            BUMP TO ACK1                    53460000
         CLC   0(2,RWKA),0(RB)          TEST FOR ACK-I                  53470000
         BNE   TRYNAK                                                   53480000
         SPACE                                                          53490000
         MVI   LCBERCCW,RACK1           SET ACK-1 INDICATOR             53500000
         BR    RD                       RETURN                          53510000
         SPACE                                                          53520000
TRYNAK   EQU   *                                                        53530000
         IC    RA,NAKCH(,RE)            POINT TO NAK                    53540000
         LA    RWKA,1(RA,RE)            NAK SEQUENCE                    53550000
         CLC   0(1,RWKA),1(RB)          TEST FOR NAK                    53560000
         BNE   TRYWACK                  NOT A NAK                       53570000
         MVI   LCBERCCW,RNAK            SET NAK I DICATOR               53580000
         BR    RD                       RETURN                          53590000
         SPACE                                                          53600000
TRYWACK  EQU   *                                                        53610000
         IC    RA,WACKCH(,RE)           INDEX TO WACK                   53620000
         LA    RWKA,1(RA,RE)            POINT TO WACK SEQUENCE          53630000
         CLC   0(2,RWKA),0(RB)          TEST FOR WACK                   53640000
         BNE   TRYDLEOT                 TRY DLE-EOT             SA57695 53650000
         SPACE                                                          53660000
         MVI   LCBERCCW,RWACK           SET WACK INDICATOR              53670000
         BR    RD                       RETURN                          53680000
         SPACE                                                          53690000
TRYDLEOT EQU   *                                                        53700000
         IC    RA,DLEEOTCH(,RE)         INDEX TO SEQUENCE               53710000
         LA    RWKA,1(RA,RE)            POINT TO SEQUENCE               53720000
         CLC   0(2,RWKA),0(RB)          DLE EOT                         53730000
         BNE   TRYTTD                   TRY TTD                 SA57695 53740000
         NI    LCBTPCD+11,X'FF'-DISDLEOT DONT SEND DLE EOT              53750000
*                                         SEQUENCE                      53760000
         MVI   LCBTSTSW,AVTEFF          VORCE NEW CONNECTION            53770000
         OI    LCBSTAT2,LCBNEGRP        INDICATE NEGATIVE RESPONSE      53780000
         NI    LCBMSGFM,AVTEFF-LCBACKI  RESET ACK COUNTER      @SA74852 53790000
         MVI   LCBERCCW,RDLEEOT+REOT    SET DLE EOT AND EOT    @SA74852 53800000
*                                       INDICATOR              @SA74852 53810000
         BR    RD                       RETURN                 @SA74852 53820000
         SPACE                                                          53830000
TRYTTD   EQU   *                                                        53840000
         IC    RA,EOTCH(,RE)            INDEX TO EOT                    53850000
         LA    RWKA,1(RA,RE)            POINT TO EOT SEQUENCE           53860000
         CLC   0(1,RWKA),1(RB)          TEST FOR EOT                    53870000
         BNE   TRYRVI                   NO,                             53880000
EOTREC   EQU   *                                                        53890000
         SPACE                                                          53900000
         NI    LCBMSGFM,AVTEFF-LCBACKI  RESET ACK COUNTER FOR CASS21101 53910000
*                                          OF BSC DIAL WHERE     S21101 53920000
*                                          SCBNOEOT IS ON . I/O GS21101 53930000
*                                          WILL NOT RESET IT     S21101 53940000
         MVI   LCBERCCW,REOT            SET EOT INDICATOR               53950000
         BR    RD                       RETURN                          53960000
         SPACE                                                          53970000
TRYRVI   EQU   *                                                        53980000
         IC    RA,RVICH(,RE)            INDEX TO SEQUENCE               53990000
         LA    RWKA,1(RA,RE)            POINT TO SEQUENCE               54000000
         CLC   0(2,RWKA),0(RB)          RVI RECEIVED                    54010000
         BNE   TRYENQ                   NO                              54020000
         MVI   LCBERCCW,RRVI            SET RVI INDICATOR               54030000
         BR    RD                       RETURN                          54040000
TRYENQ   EQU   *                                                        54050000
         IC    RA,ENQCH(,RE)            INDEX                           54060000
         LA    RWKA,1(RA,RE)            POINT TO SEQUNECE               54070000
         CLC   0(1,RWKA),1(RB)          THIS ENQ                        54080000
         MVI   LCBERCCW,0               ASSUME ERROR                    54090000
         BCR   7,RD                     RETURN IF ERROR                 54100000
         CLI   AVTDOUBX,TPRDRPEB        ENQ IN RESP TO TEXT    @SA69964 54110000
         BCR   8,RD                     BR YES, LEAVE AS INVAL @SA69964 54120000
         MVI   LCBERCCW,RENQ                                            54130000
         BR    RD                       RETURN                          54140000
         EJECT                                                          54150000
.L59     ANOP                                                           54160000
IDCHK    EQU   *                                                        54170000
         USING *,RF                                                     54180000
*                                                                       54190000
*        THIS SUBROUTINE WILL VERIFY AN IDENTIFICATION SEQUENCE FOR     54200000
* DIAL LINES.                                                           54210000
*                                                                       54220000
         USING  IEDQSCB,RSCB                                            54230000
         DROP  RPREFIX                                                  54240000
         L     RPREFIX,LCBDCBPT         DCB  BASE                       54250000
         USING IHADCB,RPREFIX                                           54260000
         L     RB,CCWADDR-1             ID RESD AREA                    54270000
         LA    RB,0(,RB)                CLEAR HI ORDER BYTE             54280000
         AH    RB,CCWCOUNT              ADD ORIGIANL COUNT              54290000
         LH    RA,LCBCSW+5              RESIDUAL COUNT                  54300000
         AIF   ('&GEN' NE '').L61                                       54310000
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        54320000
         BZ    TRYTWX                   NO                              54330000
.L61     AIF   ('&GEN' EQ 'STSP').L62                                   54340000
         AIF   ('&GEN' EQ 'QTAM').L62                                   54350000
         SPACE                                                          54360000
         LA    RA,2(,RA)                ASSUME ACK SEQUENCE RCVD        54370000
         CLI   LCBERCCW,RENQ            ENQ RECEIVED                    54380000
         BE    ADJUST                   YES,BRANCH             @XA11338 54390000
         CLI   LCBERCCW,RNAK            NAK RECEIVED           @XA11338 54400000
         BE    ADJUST                   YES,BRANCH             @XA11338 54410000
         CLI   LCBERCCW,REOT            EOT RECEIVED           @XA11338 54420000
         BNE   TRYTWX                   NO,BRANCH              @XA11338 54430000
ADJUST   EQU   *                                                        54440000
         BCTR  RA,0                     ADJUST FOR ENQ                  54450000
.L62     ANOP                                                           54460000
TRYTWX   EQU   *                                                        54470000
         STC   RA,AVTDOUBX .            SAVE TRUE RESIDUAL CNT          54480000
         SR    RB,RA                    SUBTRACT TRUE RESIDUAL CNT      54490000
         LA    RA,LCBERCCW+24           END OF ID AREA                  54500000
         SR    RA,RB                    PAD AREA                        54510000
         BNP   NOPAD                    NO PADDDING REQUIERD            54520000
         MVI   0(RB),C' '               SET FIR BLANK                   54530000
         BCTR  RA,0                     FOR EXECUTE INTR                54540000
         LTR   RA,RA                    ONLY 1 PAD REQUIRED             54550000
         BNP   NOPAD                    BRANCH NO NORE PADS             54560000
         BCTR  RA,0                     FOR EXECUTE                     54570000
         EX    RA,MOVER                 BLANK AREA                      54580000
NOPAD    EQU   *                                                        54590000
         L     RB,CCWADDR-1             DATA ADDRESS                    54600000
         SR    RA,RA                    CLEAR WORK REGISTER             54610000
         LR    R0,RA                    CLEAR WORK REGISTER             54620000
         IC    R0,DCBILCT               NUMBER OF ILISTS                54630000
         LR    RE,RA                    CLEAR WORK REGISTER             54640000
         TM    LCBSTAT1,LCBSENDN .      SEND SIDE START WITH FIRST      54650000
         BO    START1ST .               INVITATION LIST                 54660000
         SPACE                                                          54670000
         IC    RE,LCBUCBX               RLN-1                           54680000
         SR    R0,RE                    NUMBER OF ILISTS TO SCAN        54690000
START1ST EQU   *                                                        54700000
         MVI   LCBPRI,0                 SET FIRST TIME SWITCH           54710000
NEXTLIST EQU   *                                                        54720000
         SLL   RE,2                     MULTIPLY FOR INDEX              54730000
         L     RC,DCBINVLI(RE)          NEXT INVITATION LIST            54740000
         DROP  RPREFIX                                                  54750000
         USING IEDQPRF,RPREFIX                                          54760000
         LA    RWKA,LISTSIZE(,RC)       BUMP TO FIRST ENTRY             54770000
         CLI   LCBPRI,0                 FIRST TIME                      54780000
         BNE   NOTFIRST                 NOT FIRST                       54790000
         MVI   LCBPRI,PRILNFRE          RESET FIRST TIME                54800000
         SPACE                                                          54810000
         CLI   TWO(RC),2                SIZE OF EACH ENTRY 1(+INDEX)    54820000
         BH    IDSRCH                   BRANCH IF ID'S USED             54830000
         BCR   4,RD                     BRANCH IF 0-OUTPUT ONLY         54840000
         CLI   1(RC),1                  ONLY ONE ACTIVE ENTRY           54850000
         BNE   IDSRCH                   NO                              54860000
         CLI   LISTSIZE(RC),DUMMY       DUMMY ENTRY                     54870000
         BNE   IDSRCH .                 BRANCH FOR 1 CHAR ID            54880000
         SPACE                                                          54890000
         CLC   AVTDOUBX(1),CCWCOUNT+1 . ORIGINAL COUNT=ORIGINAL, UE     54900000
*                                         DID WE RECEIVED NO ID         54910000
         BNE   TRYNXTIL                 CHECK FURTHER           SA65389 54920000
         BR    RD .                     RETURN ID'S ARE NOT USED        54930000
         SPACE                                                          54940000
NOTFIRST EQU   *                                                        54950000
IDSRCH   EQU   *                                                        54960000
         IC    RA,TWO(,RC)              SIZE OF EACH ENTRY              54970000
         BCTR  RA,0                     DECREMENT FOR INDEX BYTE        54980000
         CLI   0(RWKA),FE               END OF LIST                     54990000
         BE    TRYNXTIL                 YES, GET NEXT ILIST             55000000
         SPACE                                                          55010000
         BCTR  RA,0                     DECREMENT FOR EXECUTE           55020000
         EX    RA,IDCLC                 COMPARE ID                      55030000
         BE    IDFND                    BRANCH FOUND                    55040000
         SPACE                                                          57240020
         LA    RWKA,2(RA,RWKA)          BUMP TO NEXT ENTRY              57260020
         B     IDSRCH                   LOOK AT NEXT                    57280020
         SPACE                                                          57300020
TRYNXTIL EQU   *                                                        57320020
         SRL   RE,2                     GET TRUE RLN -1                 57340020
         LA    RE,1(,RE)                NEXT LINE NUMBER                57360020
         BCT   R0,NEXTLIST              GET NEXT ILIST ADDRESS          57380020
         AIF   ('&GEN' NE '').Z19                                       57400020
         TM    LCBSTAT2,LCBSYNC         BSC LINE                        57420020
         BZ    ITSATWX                  NOT BSC                         57440020
.Z19     AIF   ('&GEN' EQ 'STSP' OR '&GEN' EQ 'MINI').Z20               57460020
         AIF   ('&GEN' EQ 'QTAM').Z20                                   57480020
         CLI   LCBINCAM,IDRETRY         RETRY LIMIT REACHED             57500020
         BL    4(RD)                    BRANCH IF NO                    57520020
ITSATWX  EQU   *                                                        57540020
.Z20     ANOP                                                           57560020
BADID    EQU   *                                                        57580020
         L     RPREFIX,LCBDCBPT         RESTORE DCB ADDRESS    @YA05167 57590000
         OI    SCBERR3,SCBTMIDN         SET ID ERROR                    57600020
         MVI   LCBTSTSW,AVTEFF          TO FORCE SUBSEQUENCE HANGUP     57620020
         OI    LCBSTAT2,LCBNEGRP        SET NEGATIVE RESPONSE           57640020
         B     ERERROR                  POST ERROR                      57660020
IDFND    EQU   *                                                        57680020
         IC    RA,1(RWKA,RA)            INDEX BYTE OF ID ENTRY          57740020
         AR    RA,RA                    DOUBLE FOR NEGATIVE INDEX       57760020
         SR    RC,RA                    BACK UP TO TNT OFFSETS          57780020
         TM    LCBSTAT1,LCBSENDN        SENDING                 SA65865 57783054
         BNO   SETTTCIN                 BR NO, SET LCBTTCIN     SA65865 57786054
         CLC   LCBTTCIN,AVTEZERO(RC)    CORRECT TERMINAL        SA65865 57789054
         BE    SETTTCIN                 YES, SET TTCIN         @YA05167 57792000
         AR    RC,RA                    NEXT ENTRY ADDRESS     @YA05167 57792500
         SR    RA,RA                    CLEAR                  @YA05167 57793000
         IC    RA,TWO(RC)               SIZE OF EACH ENTRY     @YA05167 57793500
         LA    RWKA,0(RA,RWKA)          BUMP TO NEXT ENTRY     @YA05167 57794000
         B     IDSRCH                   CONTINUE SEARCH        @YA05167 57794500
SETTTCIN EQU   *                                                SA65865 57795054
         L     RB,DCBDEBAD-IHADCB(RPREFIX)  DEB ADDRESS        @YA05167 57800000
         SR    RE,RE                    CLEAR FOR IC           @XA06335 57802000
         IC    RE,DEBNMEXT-DEBTCBAD(RB) NUMBER OF EXTENTS      @YA05167 57804000
         SR    RB,RB                    CLEAR FOR IC           @YA05167 57806000
         IC    RB,DCBEIOBX-IHADCB(RPREFIX) LCB SIZE            @YA05167 57808000
         L     RPREFIX,DCBIOBAD-IHADCB(RPREFIX)  IOB ADDRESS   @YA05167 57810000
         LA    RPREFIX,0(RPREFIX)       CLEAR                  @YA05167 57812000
         SH    RPREFIX,LCBSIZE          POINT TO LCB BOUNDARY  @YA05167 57814000
         LA    RLCB,0(RLCB)             SET FOR COMPARE        @XA06335 57816000
LOOPLCB  EQU   *                                               @XA06335 57818000
         AR    RPREFIX,RB               FIRST/NEXT LCB         @YA05167 57820000
         CR    RPREFIX,RLCB             IS THIS THE LINE?      @YA05167 57822000
         BE    DECR                     BR YES,CONTINUE        @XA06335 57824000
         CLC   LCBTTCIN-LCBRCB(TWO,RPREFIX),0(RC) TNT MATCH?   @YA05167 57826000
         BE    BADID                    BR YES,TREAT AS BAD ID @XA06335 57828000
DECR     EQU   *                                               @XA06335 57830000
         BCT   RE,LOOPLCB               CONTINUE SEARCH        @XA06335 57832000
         MVC   LCBTTCIN(2),0(RC)        SET IN LCB                      57834000
         BR    RD                       RETURN                          57836000
IDCLC    CLC   0(1,RWKA),0(RB)          EXECUTED INSTRUCTION            57840020
MOVER    MVC   1(1,RB),0(RB)            EXECUTED INSTRUCTION            57860020
         EJECT                                                          57880020
POLLRT   EQU   *                                                        57900020
         USING *,RF                                                     57920020
*                                                                       57940020
*        THIS SUBROUTINE COMPUTES SOURCE INFORMATION ON AN AUTOPOLL     57960020
* LINE.                                                                 57980020
*                                                                       58000020
         MVI   LCBCPA+24,CCWNOP         INDDICATE SEARCH WAS DONE       58020020
         MVI   LCBCPA+53,AVTEZERO       TURN OFF ERP FOR        SA66604 58026005
*                                        AUTOPOLL INDICATOR     SA66604 58032005
         L     RA,LCBDCBPT              GET DCB ADDRESS        @SA62375 58033000
         USING IHADCB,RA                                       @SA62375 58034000
         SR    RE,RE                    CLEAR FOR IC           @SA62375 58035000
         IC    RE,DCBEIOBX              GET LCB SIZE           @SA62375 58036000
         SH    RE,H8S                   EXTENSION OFFSET       @SA62375 58037000
         ALR   RE,RLCB                  GET EXTENSION ADDRESS  @SA62375 58038000
         DROP  RA                                              @SA62375 58039000
         L     RPREFIX,LCBLSPCI-1       HEADER BUFFER                   58040020
         L     RWKA,LCBCPA+64 .         ADDRESS OF INDEX BYTE    S22025 58060022
         L     RA,LCBCPA+48             2N D POLL COMMCAND              58120020
         LR    RC,RA                    SAVE START OF LIST              58140020
         SH    RA,H8                    BACK UP TO CONTROL WORDS        58160020
         SR    RB,RB                    CLEAR WORK REGISTER             58180020
         STH   RB,LCBTTCIN .            ASSUME NO SOURCE         S22025 58190022
         IC    RB,TWO(,RA)              SIZE OF EACH ENTRY              58200020
         BCTR  RC,0                     DECREMENT FOR INDEX SCAN        58220020
POLLLOOP EQU   *                                                        58240020
         AR    RC,RB                    BUMP TO NEXT ENTRY              58260020
         CLC   0(1,RC),0(RWKA)          THIS THE INDEX BYTE             58280020
         BE    SRCEFND                  YES SET UP SOURCE               58300020
         SPACE                                                          58320020
         AIF   ('&GEN' EQ 'BISC').Z21                                   58340020
         CLI   1(RC),FE                 END OF LIST                     58360020
         AIF   ('&GEN' NE '').Z22                                       58380020
         BCR   8,RD .                   BRANCH IF YES            S22025 58400022
         AGO   .Z21                                                     58420020
.Z22     ANOP                                                           58440020
         BNE   POLLLOOP                 NO,GET NEXT ENTRY               58460020
         AGO   .Z23                                                     58480020
.Z21     ANOP                                                           58500020
         CLI   2(RC),FE                 END OF BSC LIST                 58520020
         BNE   POLLLOOP                 NO, GET NEXT ENTRY              58540020
.Z23     ANOP                                                           58560020
         BR    RD                       RETURN                          58660020
         SPACE 2                                                        58680020
SRCEFND  EQU   *                                                        58700020
         BCTR  RB,R0 .                  DECREMENT FOR INDEX      S22025 58720022
         SR    RC,RB .                  BACK UP TO TNT OFFSET    S22025 58750022
         STCM  RC,AD,LCBINVPT .         POINTER FOR NEXT POLL    Y01948 58780005
         MVC   LCBERADR(THREE),LCBINVPT SET POLL ADDRESS       @SA62375 58810000
         IC    RB,0(,RWKA)              GET INDEX BYTE                  58840020
         AR    RB,RB                    DOUBLE FOR NEGAIVE INDEX        58860020
         SR    RA,RB                    BACK UP TO TNT OFFSET           58880020
         LH    RC,0(RA)                 GET TNT OFFSET                  58900020
         STH   RC,LCBTTCIN .            PUT TNT OFFSET IN LCB    S22029 58905022
         L     RB,AVTSAVEX+TWLVE        DEB ADDRESS              X02004 58916305
         L     RB,DEBAPPAD-DEBNMSUB(,RB) APPENDAGE TABLE         X02004 58916405
         TM    TWO(RB),X80              IS ALTMH SPECIFIED       X02004 58916505
         BZ    CORECTLC                 BRANCH NO                S22029 58916622
         LR    RA,RWKA .                SAVE ADDR OF INDEX BYTE  S22029 58916722
         LR    RWKA,RF .                SAVE BASE REGISTER       S22029 58916822
         NC    LCBTTCIN,LCBTTCIN        IS CONNECTED INDEX ZERO  S22029 58916922
         BZ    CORECTLC                 YES - USE OWNING MH LC   S22029 58917022
         S     RWKA,FQCB .              GET ADDR OF FINDQCB RTN  S22029 58917122
         BALR  RE,RWKA .                GET DEST QCB ADDRESS     S22029 58917222
         LR    RWKA,RA                  RESTORE INDEX BYTE ADDR  S22029 58917322
         LR    RE,R0 .                  QCB ADDR FOR CHECKING    S22029 58917422
*                                       FOR CONNECTED MH         S22029 58917522
         TM    QCBDSFLG-IEDQQCB(RE),QCBALTMH IS TERMINAL         S22029 58917622
*                                       CONNECTED TO ALTMH       S22029 58917722
         BZ    CORECTLC .               USE OWNING MH LC         S22029 58917822
         LA    RB,ONE(,RB)              USE ALTMH OPTIONS        X02004 58917905
CORECTLC EQU   * .                                               S22029 58918022
         TM    0(RB),LCIN               LC=IN SPECIFIED          X02004 58918105
         BNO   FINDSCBQ                 BRANCH IF NO             S99228 58919722
         TM    LCBSTAT2,LCBSYNC         BISC LINE?               S22028 58919822
         BO    TSOPRES                  BRANCH YES               S22028 58920122
         MVI   AVTEZERO(RWKA),X'16'     REPLACE INDEX WITH EOA   S22028 58920422
         B     FINDSCBQ                 FIND SCB                 S22028 58920722
TSOPRES  EQU   *                                                 S22028 58921022
         TM    LCBTSOB,LCBTSBUF         TSO BUFFER?              S22028 58921322
         BNO   FINDSCBQ                 BRANCH NO                S22028 58921622
         MVI   AVTEZERO(RWKA),ZERO      ZERO INDEX BYTE          S22028 58921922
.Z23A    ANOP                                                     M6293 58922522
FINDSCBQ EQU   * .                      ENTRY TO SET SCBAND QCB  S22025 58928822
         STH   RC,LCBTTCIN              SET IN LCB                      58933320
         L     RA,AVTRNMPT              GET TNT CODE ADDRESS            59000020
         USING IEDQTNTD,RA                                              59020020
         BAL   RPREFIX,TNTDCODE         LINK TO IT                      59040020
         USING IEDQTRM,RB                                               59060020
         L     RB,TRMDESTQ-1            GET QCB ADDRESS                 59080020
         DROP  RB                                                       59100020
         USING IEDQQCB,RB                                               59120020
         AIF   ('&GEN' EQ 'MINI').MIX0590                        S22029 59121022
         AIF   ('&GEN' EQ 'BISC').MIX0590                        S22029 59122022
         OI    LCBTSOB,LCBTSBUF .       INDICATE TSO TERM ON     S22029 59123022
*                                       THIS LINE                S22029 59123222
         TM    QCBFLAG,QCBTSSES         ARE WE CONNECTED TO A    S22029 59126022
*                                       TIME-SHARING TERMINAL    S22029 59127022
         BO    MIX5910 .                BRANCH IF YES            S22029 59128022
         NI    LCBTSOB,AVTEFF-LCBTSBUF  NO, INDICATE A TCAM      S22029 59129022
*                                       TERMINAL ON THIS LINE    S22029 59130022
MIX5910  EQU   *                                                 S22029 59131022
.MIX0590 ANOP                                                    S22029 59132022
         SR    RA,RA                    CLER WORK REGISTER              59140020
         LR    R0,RA                    CLAR WORK REGISTER              59160020
         IC    RA,QCBSCBOF              QCB OFSET TO SCB                59180020
         IC    R0,AVTSCBSZ              GET SIZE FO SCB                 59200020
         MR    RA-1,R0                  GET OFFFSET TO RIGHT SCB        59220020
         AL    RA,LCBSCBDA-1            SET SCB BASE                    59240020
         LR    RSCB,RA .               SET SCB ADDR             SA49233 59250022
         STCM  RA,AD,LCBSCBA .          SET SCB ADDRESS IN LCB   Y01948 59260005
         DROP  RA                                                       59320020
         DROP  RB                                                       59340020
         BR    RD                       RETURN                          59360020
*********************************************************************** 59362022
*        THE FOLLOWING ADCON IS USED TO ESTABLISH ADDRESSABILITY      * 59364022
*        TO THE FINDQCB SUBROUTINE                                    * 59366022
*                                                                     * 59368022
FQCB     DC    A(POLLRT-FINDQCB) .      FINDQCB OFFSET           S22029 59370022
*                                                                     * 59372022
*********************************************************************** 59374022
         EJECT                                                          59380020
         AIF   ('&GEN' EQ 'STSP').L71                                   59400020
         AIF   ('&GEN' EQ 'QTAM').C                              S22025 59420022
BSCRSP   EQU   *                                                        59440020
*                                                                       59460020
*        THE FOLLOWING CODE HANDLES TRANSPARENT OUTPUT TO A BSC         59480020
* TERMINAL AND WACK IN RESPONSE TO TEXT FOR A TERMIBAL DEFINED AS       59500020
* BUFFERED ON THE TERMINAL MACRO.                                       59520020
*                                                                       59540020
         USING *,RF                                                     59560020
         USING IEDQSCB,RSCB                                             59580020
         MVC   LCBLINK(1),LCBERCCW      SAVE RESPONSE INDDICATOR        59600020
         TM    SCBSTATE,SCBTRANP        TRANSPARENT                     59620020
         BZ    NOTRP                    BRANCH NO                       59640020
         L     RCCW,LCBCPA+52           CURRENT UNIT                    59660020
         ST    RF,LCBRCB                SAVE BASE                       59680020
         L     RWKA,LCBDCBPT            DCB B ASE                       59700020
         USING IHADCB,RWKA                                              59720020
         MVI   LCBERCCW,NOPCI           ASSUJE PCI NOT USED             59740020
         TM    DCBPCI,SNDPCI            PCI ON SEND                     59760020
         BZ    NOTUSED                  BRANCH IF NO PCI                59780020
         SPACE                                                          59800020
         DROP  RWKA                                                     59820020
         MVI   LCBERCCW,PCIOPT          SET PARAMETER FOR ROUTINE       59840020
NOTUSED  EQU   * .                                              SA44893 59850022
         BAL   RA,FINDBUFF              GET BUFFER BASE                 59860020
         L     RF,LCBRCB                S RESETORE BASE                 59880020
TESTLAST EQU   *                                                        60180020
         TM    LCBCPA+28,CCWSKIP       LAST BLOCK SENT                  60200020
         BZ    MOREDATA                 NO                              60220020
         SPACE                                                          60240020
         L     RCCW,LCBCPA+52           CURRETN CCW                     60260020
         NI    SCBQTYPE,AVTEFF-SCBBFMM  RESET MIDDLE OF MESSGE          60280020
         MVC   CCW+9(3),LCBCPA+57 SET CURR TIC TO NEXT UNIT             60300020
         MVC   LCBCPA+13(3),LCBCPA+53   SAVE CURRENT NIT POINTER        60320020
         MVI   LCBTPCD+2,TPBUFEOT       SET TP OP CODE                  60340020
         BAL   RE,DIALTEST              CHECK BSC QFLUSH       @XA08073 60360091
         B     RESETEOT .               NOT BSC DIAL SNED PRI    S21101 60370020
*                                         OR NOT BSC CONTT,    @XA08073 60370691
*                                         SEND PRI W MASTER=YES@XA08073 60371291
         SPACE 1                                                 S21101 60372020
         B     RTBUFEOT .               TREAT AS TRUE EOM        S21101 60374020
MOREDATA EQU   *                                                        60380020
         SPACE                                                          60400020
         LA    RA,LCBCPA+24             UNIT EXIT INDICATOR             60420020
         LR    RE,RPREFIX               GET CURRENT BUFFER ADDRESS      60440020
         SR    R0,R0                    CLEAR WORK REGISTER             60460020
         LR    RCCW,R0                  CLEAR REGISTER                  60480020
         IC    R0,PRFNBUNT              NUMBER UNIT S IN BUFFER         60500020
         B     STLOOP                   ENTER LOOP                      60520020
TRPLOOP  EQU   *                                                        60540020
         L     RE,PRFTIC-IEDQPRF(,RE)   NEXT UNIT (BUFFER)              60560020
         AH    RCCW,AVTKEYLE            BUMP BY KEY LENGTH              60580020
STLOOP   EQU   *                                                        60600020
         L     RB,PRFTIC-IEDQPRF(,RE)   NEX CCW                         60620020
         LA    RB,0(,RB)                CLEAR HI ORDER BYTE             60640020
         CLR   RB,RA                    THIS THE CCW                    60660020
         BE    NOMORE                   BRANCH YES                      60680020
         BCT   R0,TRPLOOP               GET NEXT UNIT IN BUFFER         60700020
NOMORE   EQU   *                                                        60720020
         STC   R0,LCBERCCW              SAVE UNIT COUNT FOR LATER       60740020
         LA    R0,PRFSUNIT-IEDQPRF(,RE) START OF UNIT                   60760020
         L     RWKA,CCWADDR-1-CCW(,RE)  DATA ADDRESS                    60780020
         LA    RWKA,0(,RWKA)            FOR COMPARE HALF                60800020
         SR    RWKA,R0                  PREVIOUS SENT (OR PREFIX)       60820020
         AH    RWKA,CCWCOUNT-CCW(RE)    ADD AMOUNT SENT                 60840020
         LR    RC,RPREFIX               COPY HEADER BUFFER ADDR SA62329 60850005
         AR    RCCW,RWKA                TOTAL AMOUNT                    60860020
         CH    RCCW,PRFSIZE             END OF BUFFER                   60880020
         BL    SETOFF                   NO                              60900020
         L     RC,LCBCPA+56             NEXT BUFFER ADDRESS     SA62329 60920005
         LA    RCCW,PRFSTXT-PRFSUNIT    SET OFFSET INTO NEXT RECORD     60940020
SETOFF   EQU   *                                                        60960020
         MVC   SCBDEOB+1(3),PRFCRCD-IEDQPRF(RC) SET DISK ADDR   SA62329 60980005
         MVC   SCBDEOB(1),PRFNTXT-IEDQPRF(RC) SET DISK RECORD   SA62329 61000005
         STH   RCCW,SCBEOB              SAVE OFFSET IN TO BUFFER        61020020
         SPACE                                                          61040020
         CLI   LCBLINK,RWACK            WACK ON A BUFFERED LINE         61060020
         BNE   GOMORE                   NO                              61080020
         SPACE                                                          61100020
         L     RCCW,LCBCPA+52           CURRENT UNIT IN BUFFER          61120020
         MVC   LCBCPA+13(3),LCBCPA+53   SAVE CURRENTC W POINTER         61140020
         MVC   CCW+9(3),LCBCPA+57       SET NEXT CCW POINTER            61160020
         B     NOTNOW                   RESET THE LINE                  61180020
         SPACE 5                                                        61200020
GOMORE   EQU   *                                                        61220020
*        THE FOLLOWING VODE DETERMINES IF THE NEXT BLOCK TO BE          61240020
*        WRITTEN IS THE LAST MESSAGE BLOCK.  IF SO, DLE ETX IS TO       61260020
*        BE WRITTEN.  THE MAJOR DECISION IS A COMPARISON BETWEEN        61280020
*        OUPUT BOCK SIZE AND KEY LENGTH.                                61300020
         LR    RE,RPREFIX               COPY BUFFER ADDRESS             61306051
         LR    RPREFIX,RC               COPY PREFIX UNIT ADDR   OX02181 61312051
         LA    RC,LCBCPA+24             SET EXIT ADDRESS                61320020
         LA    RB,1                     INITIALZIE FOR LOOP             61340020
         LH    RWKA,SCBBKFCT+1          OUTPUT BLOCK SIZE               61360020
         CH    RWKA,AVTKEYLE            COMPARE WITH KEY LENGTH         61400020
         BH    GREAT                    BRANCH IF GREATER               61420020
         SPACE                                                          61440020
         TM    PRFSTAT1,PRFNLSTN        LAST BUFFER                     61460020
         BZ    TRLOOP1                  BRANCH YES, LAST BLOCK          61480020
         SPACE                                                          61500020
         CLI   LCBERCCW,2               TWO UNIT BUFFER         SA56617 61520022
         BH    NOTLAST                  BRANCH IF ANOTHER BLOCK SA56617 61530022
         BE    CKNXTLST                 CHK NEXT TO LAST        SA56617 61540022
         EX    RWKA,NEXTBLK             SEE IF ANOTHER BLOCK FROM       61560020
*                                         THIS UNIT                     61580020
         BNL   NOTLAST                  BRANCH IF ANOTHER BLOCK         61600020
         SPACE                                                          61620020
         TM    LCBCPA+59,2              NEXT BUFFER ABAILABLE           61640020
         BNZ   NOTLAST                  NO                              61660020
         L     RA,LCBCPA+56             NEXT UNIT ADDRESS               61680020
COMTEST  EQU   *                                                SA56617 61690022
         TM    PRFSTAT1-IEDQPRF(RA),PRFNLSTN LAST UNIT                  61700020
         BO    NOTLAST                  BRANCH NO                       61720020
         SPACE                                                          61740020
         SPACE                                                          61760020
         MVI   LCBERCCW,0               INDCATE NOT END OF BUFFER       61780020
         CLI   PRFOPCDE-IEDQPRF(RA),0   ANOTHER BLOCK AFTER THIS        61800020
         BE    SETETX                   BRANCH IF LAST BLOCK            61820020
         B     NOTLAST                  SNED NEXT BLOCK                 61840020
* FOLLOWINT CODE TAKES CARE OF CASE OF TWO UNIT BUFFER, PRFSIZE SA56617 61841022
* LESS THAN MULTIPLE OF KEYLENGTH, AND NEXT BUFFER IS LAST      SA56617 61842022
* CONTIANING LAST BLOCK OF MESSAGE.                             SA56617 61843022
CKNXTLST EQU   *                                                SA56617 61844022
         SR    R0,R0                    CLEAR REGISTER          SA56617 61845022
         IC    R0,LCBCPA+52             REMAINING IN UNIT       SA56617 61846022
         L     RCCW,LCBCPA+56           ADDR OF NEXT UNIT       SA65359 61847051
         AH    R0,CCWCOUNT              REMAINING DATA          SA56617 61849022
         CH    R0,SCBEOBSZ              MORE THAN 1 BLOCK LEFT  SA56617 61850022
*                                       IN THE MESSAGE          SA56617 61851022
         BNL   NOTLAST                  BRANCH IF ANOTHER BLK   SA56617 61852022
         TM    CCW+11,2                 NEXT BUFFER AVIALABLE   SA56617 61853022
         BNZ   NOTLAST                  BRANCH NO               SA56617 61854022
         L     RA,CCW+8                 NEXT BUFFER ADDRESS     SA56617 61855022
         B     COMTEST                  COMMON CODE             SA56617 61856022
         SPACE                                                          61860020
TRLOOP1  EQU   *                                                        61880020
         L     RE,PRFTIC-IEDQPRF(,RE)   NEXT UNIT                       61900020
         LA    RE,0(,RE)                CLEAR HI ORDER BYTE             61920020
         CLR   RE,RC                    THIS THE CCW                    61940020
         BE    FOUNDIT                  YES                             61960020
         LA    RB,1(,RB)                BUMP UNIT COUNT                 61980020
         B     TRLOOP1                  GET NEXT  UNIT                  62000020
         SPACE                                                          62020020
FOUNDIT  EQU   *                                                        62040020
         STC   RB,LCBERCCW              SAVE FOR LATER TEST             62060020
         SR    RE,RE                    CLEAR WORK REGISTER             62080020
         IC    RE,LCBCPA+52             REMANING COUNT                  62100020
         CLR   RE,RWKA                  GREATER                         62120020
         BH    NOTLAST                  BRANCH HIGH            @OZ08362 62140091
         EX    RB,CLIUNT                THIS LAST UNIT                  62160020
         BE    SETETX                   SEND LAST BLOCK                 62180020
TRYNEXT  EQU   *                                                        62200020
         LA    RB,1(,RB)                BUMP UNIT COUNT                 62220020
         EX    RB,CLIUNT                LAST UN IT                      62240020
         BNE   NOTLAST                  NO                              62260020
         L     RA,LCBCPA+56             NEXT UNIT                       62280020
         CLI   PRFOPCDE-IEDQPRF(RA),0   MORE DATA IN NEXT UNIT          62300020
         BE    SETETX                   YES, NEXT BLOCK IS LAST         62320020
         B     NOTLAST                  NEXT BLOCK IS NOT LAST          62340020
         SPACE 3                                                        62360020
*        TO HERE WHEN BLOCK SIZE GREATER THAN KEYLENGH                  62380020
GREAT    EQU   *                                                        62400020
         IC    RB,LCBERCCW              UNIT COUNT IF BUFFER            62420020
         TM    LCBCPA+59,X'02'          NEXT  UNIT AVAILABLE            62440020
         BZ    ITSOK                    YES                             62460020
         TM    PRFSTAT1,PRFNLSTN        LAST BUFFER                     62480020
         BO    NOTLAST                  NO                              62500020
         B     SETETX                   BRANCH FOR LAST BLOCK           62520020
         SPACE                                                          62540020
ITSOK    EQU   *                                                        62560020
         LA    RE,LCBCPA+56-(PRFTIC-IEDQPRF) ADJUST FOR COMMON CODE     62580020
         BCT   RB,NEXTUNT               BRANCH NOT END OF UNIT          62600020
         L     RPREFIX,LCBCPA+56        NEXT UNIT ADDRESSS              62620020
         IC    RB,PRFNBUNT              GET NUMBER OF UNITS             62640020
NEXTUNT  EQU   *                                                        62660020
         L     RE,PRFTIC-IEDQPRF(,RE)   NEXT UNIT                       62680020
GREATER  EQU   *                                                        62700020
         TM    PRFTIC-IEDQPRF(RE),X'20' THIS UNIT SHOULD TIC TO         62720020
*                                         CH ANNEL PROGRAN AREA         62740020
         BO    THISUNIT                 BRANCH YES                      62760020
         SPACE                                                          62780020
         BCT   RB,NEXTUNT               GET NEXT UNIT                   62800020
         TM    PRFTIC+3-IEDQPRF(RE),X'02'   NEXT BUFFER ABAILBLE        62820020
         BNZ   NOTLAST                  BRANCH NO                       62840020
         L     RPREFIX,PRFTIC-IEDQPRF(,RE)     NEXT BUFFER              62860020
         IC    RB,PRFNBUNT              NUMBER UNIT S IN NEX BUFFER     62880020
         B     NEXTUNT                  LOOK AT NEXT BUFFER             62900020
         SPACE                                                          62920020
THISUNIT EQU   *                                                        62940020
         TM    PRFSTAT1,PRFNLSTN        LAST BUFFER                     62960020
         BO    NOTLAST                  BRANCH NO                       62980020
         BCT   RB,NOTLAST               BRANCH NOT END OF BUFFER        63000020
         CLI   PRFOPCDE-IEDQPRF(RE),0   WILL THERE  BE ANOTHER          63020020
*                                         BLOCK AFTER THIS ONE          63040020
         BNE   NOTLAST                  BRANCH IF ANOTHER BLOCK         63060020
SETETX   EQU   *                                                        63080020
         L     RA,LCBCPA+24             DLEETB CCW                      63100020
         AH    RA,H3                    BUMP ADDRESS TO DLEETX          63120020
         ST    RA,LCBCPA+24             NEW CCW SET                     63140020
         OI    LCBCPA+28,CCWSKIP        INDICATE LAST BLOCK SENT        63160020
NOTLAST  EQU   *                                                        63180020
*        THE FOLLOWING CODE SETS UP THE CCW'S IN BUFFERS TO WRITE       63200020
*        THE NEXT BLOCK                                                 63220020
         SR    RB,RB                    CLEAR WORK REGISTER             63240020
         LR    R0,RB                    LCEAR WORK REGISTER             63260020
         L     RCCW,LCBCPA+52           CURRENT UNIT                    63280020
         IC    R0,CCWCOUNT+1            ORIGIANL COUNT                  63300020
         AL    R0,CCWADDR-1             UPDATE DATA ADDRESS             63320020
         ST    R0,CCWADDR-1             NEW CCW SET                     63340020
         IC    RB,LCBCPA+52             REMAINING COUNT IN CURRENT      63360020
         LTR   RB,RB                    IS REMAINING CNT ZERO  @XA07517 63366000
         BZ    SETCCWCD                 BRANCH-YES GET NEXT    @XA07517 63372000
         CH    RWKA,AVTKEYLE            COMPARE BLOCK WITH KEY SIZE     63380020
         BNH   SAME                     LOW OR EQUAL                    63400020
         SPACE                                                          63420020
*        INSERT CODE IF NEXT BLOCK NOT AVAILABLE                        63440020
NEXTUNIT EQU   *                                                        63460020
         STC   RB,CCWCOUNT+1            NEW DATA COUNT                  63480020
         LR    RA,RCCW                  CURRENT UNIT ADDRESS    SA65359 63482051
         TM    LCBCPA+28,CCWSKIP        LAST BLOCK              SA65359 63484051
         BNO   SETCCWCD                 BR NO, CHAIN DATA       SA65359 63486051
         TM    LCBCPA+59,X'02'          NEXT UNIT AVAILABLE     SA65359 63488051
         BO    SENDIT                   BR NO, LAST BLOCK       SA65359 63490051
SETCCWCD EQU   *                                                SA65359 63492051
         OI    CCWFLAGS,CCWCD           SET CHAIN DATA FLAG             63500020
         L     RA,LCBCPA+56             NEXT UNIT IN CHAIN              63520020
         ST    RA,CCWOPCDE+8            SET TIC ADDRESS FROM CURRENT    63540020
*                                         TO NEXT                       63560020
         MVI   CCWOPCDE+8,CCWTIC        TIC OP CODE                     63580020
         LTR   RB,RB                    WE AT END OF UNIT               63600020
         BNZ   MORED                    BRANCH NO                       63620020
         MVC   LCBCPA+53(3),LCBCPA+57   NEXT IS NOW CURRENT             63640020
MORED    EQU   *                                                        63660020
         MVC   LCBCPA+49(3),LCBCPA+53   SET TIC ADDRESS FROM DLESTX     63680020
         TM    CCWOPCDE+11,X'02'        IS THERE NEXT BUFFER            63700020
         BZ    TRENTER                  YES                             63720020
*        NEXT BLOCK NOT AVAILABLE, TREAT AS CHAN PROG CHECK             63740020
         LA    RWKA,2                   CHANNEL PROGRAM CHECK           63760020
         ST    RWKA,LCBCPA+56           SET AS NEXT UNIT ADDRESS        63780020
         B     PCSTART                  START ON WRITE SYN'S            63800020
         SPACE                                                          63820020
*        IF NEXT BLOCK NOT AVAILABLE,RESTART IS MADE ON WRITE SYNS      63840020
* LOOP.  PCI WILL UPDTE NEXT CCW POINTER (LCBCPA+56) AND SET 1 BYTE     63860020
* REMAING COUNT IN LCBCPA+52.  IF THERE IS A REMAINING COUNT OF 0       63880020
* IN CURRENT CCW BUT THE NEXT CCW IS AVAILABLE, PCI WILL SET UP         63900020
* LCBCPA+52 (WHICH BECOMES NEW CURRENT UNIT) AND LCBCPA+56 WHICH        63920020
* WILL BE THE SUBSEQUENT 1ST CCW OF FUTURE BLOCK.  IF REMAINING         63940020
* COUNT IN CURRENTCCW IS 0 AND THE NEXT UNIT IS NOT AVAILABLE, PCI      63960020
* WILL SET UP LCBCPA+48 (TIC FROM DLE STX) IN ADDITION TO LCBCPA+56     63980020
* AND LCBCPA+52.                                                        64000020
NOTHIS   EQU   *                                                        64020020
         L     RA,PRFTIC-IEDQPRF(,RA)   NEXT UNIT                       64040020
TRENTER  EQU   *                                                        64060020
         TM    PRFTIC-IEDQPRF(RA),X'20' NEXT ENDING UIT                 64080020
         BO    THISONE                  THS IS IT                       64100020
         TM    PRFTIC+3-IEDQPRF(RA),X'02' NEXT BUFFER AVAILABLE         64120020
         BNZ   PCSTART                  BRANCH NO                       64140020
         B     NOTHIS                   GET NEXT UNIT                   64160020
THISONE  EQU   *                                                        64180020
         ST    RA,LCBCPA+52             NEW CURRENT                     64200020
         IC    RB,PRFOPCDE-IEDQPRF(,RA) REMAINING COUNT IN NEXT         64220020
         STC   RB,LCBCPA+52             SAVE FOR NEXT TIME ARAOUND      64240020
RESTR    EQU   *                                                        64260020
         MVC   LCBCPA+57(3),PRFTIC+1-IEDQPRF(RA)  ADDRESS OF NEXT UNIT  64280020
SENDLAST EQU   *                                                        64300020
         TM    LCBCPA+28,CCWSKIP        LAST BLOCK              SA65359 64302051
         BO    NOCHANGE                 ETX SETUP ALREADY DONE @OZ08362 64304091
         TM    LCBCPA+59,X'02'          NEXT UNIT AVAILABLE?   @OZ08362 64304191
         BZ    NOCHANGE                 YES- THIS IS NOT LAST  @OZ08362 64304291
         LR    RCCW,RA                  SET UNIT ADDR          @OZ08362 64304391
         MVI   LCBERCCW,PCIOPT          DON'T POST BUFFERS     @OZ08362 64304491
         BAL   RA,FINDBUFF              GET BUFFER PREFIX BASE @OZ08362 64304591
         L     RF,LCBRCB                RESTORE REGISTER       @OZ08362 64304691
         LR    RA,RCCW                  RESET CURRENT UNIT ADDR@OZ08362 64304791
         TM    PRFSTAT1,PRFNLSTN        MARKED LAST?           @OZ08362 64304891
         BO    NOCHANGE                 NO-THIS IS NOT LAST    @OZ08362 64304991
         SR    RB,RB                    CLEAR FOR INSERT       @OZ08362 64305091
         IC    RB,LCBCPA+52             GET REMAINING COUNT    @OZ08362 64305191
         LTR   RB,RB                    IS IT ZERO             @OZ08362 64305291
         BNZ   NOCHANGE                 BRANCH NO- NOT LAST    @OZ08362 64305391
         L     RB,LCBCPA+24             GET ADDRESS FOR ETB    @OZ08362 64305491
         AH    RB,H3                    ADD OFFSET TO ETX      @OZ08362 64305591
         ST    RB,LCBCPA+24             AND REPLACE IT         @OZ08362 64305691
         OI    LCBCPA+28,CCWSKIP        SHOW ETX IS SET UP     @OZ08362 64305791
NOCHANGE EQU   *                                               @OY13667 64306091
         NI    CCWFLAGS-CCW(RA),AVTEFF-CCWCD RESET CHAIN DATA   SA65359 64308051
         OI    CCWFLAGS-CCW(RA),CCWCC   SET COMMAND CHAINING    SA65359 64310051
         LA    RB,LCBCPA+24             SET TIC TO CPA                  64320020
         ST    RB,PRFTIC-IEDQPRF(,RA)   SET IN CCW                      64340020
         MVI   PRFOPCDE-IEDQPRF(RA),CCWWRITE    >ET COMMAND CODE        64360020
         MVI   PRFTIC-IEDQPRF(RA),CCWTIC    SET TIC COMMAND             64380020
         LA    RWKA,LCBCPA+40           RESTART ADDRESS                 64400020
         B     RESTCOM                  USE COMMON EXIT                 64420020
         SPACE                                                          64440020
SAME     EQU   *                                                        64460020
         LR    RA,RCCW                  CURRENT UNIT ADDRESS            64480020
         CLR   RB,RWKA                  REMAINING GREATER THAN BLOCK    64500020
         BNL   GOSAME .              YES, UNIT CONTAINS NEXT BLKSA44894 64520022
         SPACE                                                          64540020
         TM    LCBCPA+28,CCWSKIP        LAST BLOCK                      64560020
         BZ    NEXTUNIT                 NO                              64580020
         SPACE                                                          64600020
         CLC   LCBERCCW(1),PRFNBUNT     LAST UNIT OF LAST BUFFER        64620020
         BNE   NEXTUNIT                 NO, IT'S NEXT TO LST            64640020
         STC   RB,CCWCOUNT+1            SET COUNT FOR LAST UNIT         64660020
         TM    SCBBSCFM,SCBNPDTR        IS PADDING REQUESTED   @YA09751 64664000
         BO    SENDIT                   NO USE REAL DATA COUNT @YA09751 64668000
         STC   RWKA,CCWCOUNT+1          USE DATA COUNT + PADS  @YA09751 64672000
         MVI   LCBCPA+52,AVTEZERO       CLEAR REMAINING COUNT  @YA09751 64676000
         B     SENDIT                   BRANCH IF YES                   64680020
GOSAME   EQU   *                                                        64700020
         SR    RB,RWKA                  GET DIFFERENCE                  64720020
         STC   RB,LCBCPA+52             SAVE REMAINING COUNT            64740020
         STC   RWKA,CCWCOUNT+1-CCW(,RA) SET NEW COUNT                   64760020
         LA    RC,LCBCPA+24             CCW EXIT ADDRESS                64780020
         L     RB,PRFTIC-IEDQPRF(,RA)   NEXT CCW                        64800020
         LA    RB,0(,RB)                CLEAR HI BYTE FOR COMPARE       64820020
         CLR   RB,RC                    ALREADY WRITE FROM THIS CCW     64840020
         BNE   RESTR                    NO, SAVE ADDRESSS OF NEXT       64860020
SENDIT   EQU   *                                                        64880020
         ST    RA,LCBCPA+48             SET UP TIC ADDRESS              64900020
         MVI   LCBCPA+48,CCWTIC         SET COMMAND CODE                64920020
         B     SENDLAST                 GO EXIT                         64940020
         SPACE                                                          64960020
         SPACE                                                          64980020
NOTRP    EQU   *                                                        65000020
         L     RCCW,LCBCPA+12           CURRENT CCW                     65020020
         CLI   CCWCOUNT+1,0             DID CHAN PROG CHECK OCCUR       65040020
         BNE   UPDTFLD                  BRANCH IF NO                    65060020
         TM    CCW+11,X'02'             NEXT BUFFER AVAILABLE           65080020
         BNZ   PCSTART                  BRANCH IF NEXT NOT AVAIL        65100020
         MVC   LCBCPA+13(3),CCW+9 .     SET UP NEW START CCW     S21101 65120020
         L     RCCW,8(,RCCW)            BUMMP TO NEXT BUFFER            65140020
         MVC   LCBRECAD,PRFCRCD-IEDQPRF(RCCW) SET QUEUE ADDRESS         65160020
         MVC   LCBNTXT,PRFNTXT-IEDQPRF(RCCW) SET DIAK RECORD            65180020
         LA    R0,PRFSTXT-PRFSUNIT      SAVE FOR LATER                  65200020
         STH   R0,LCBRECOF              SET IN LCB                      65220020
UPDTFLD  EQU   *                                                        65240020
         MVC   SCBDEOB+1(3),LCBRECAD    MOVE QUEUE ADDRESS              65260020
         MVC   SCBEOB(2),LCBRECOF       SET OFFSET INTO RECORD          65280020
         MVC   SCBDEOB(1),LCBNTXT       SET DISK RECORD                 65300020
         BAL   RE,DIALTEST              CHECK BSC QFLUSH       @XA08073 65310091
         B     NODIAL .                  BRANCH IF NOT DIAL SEND S21101 65312020
*                                         OR NOT BSC CONTT,    @XA08073 65312691
*                                         SEND PRI W MASTER=YES@XA08073 65313291
          SPACE 1                                                S21101 65314020
         BAL   RC,ONLYEOT .             IF ONLY EOT IS LEFT TREATS21101 65316020
*                                          TRUE END OF MESSAGE INS21101 65318020
*                                          ORDER TO FLUSH QUEUE  S21101 65318420
         B     RTBUFEOT .               BRANCH ONLY EOT IS LEFT  S21101 65318820
          SPACE 1                                                S21101 65319220
NODIAL   EQU    *                                                S21101 65319620
         CLI   LCBLINK,RWACK            WACK ON BUFFERED LINE           65320020
         BNE   EXIT3                    BRAVNCH NO TO RESTART           65340020
         SPACE                                                          65360020
         BAL   RC,ONLYEOT .             CHECK IF WE ARE AT END   S21101 65380020
*                                          OF MESSAGE            S21101 65390020
         B     EXIT3 .                  BEANCH IF ONLY EOT REMINSS21101 65400020
          SPACE 1                                                S21101 65410020
NOTNOW   EQU   *                                                        65480020
         MVI   LCBERCCW,NOPCI           SET PARAMETER                   65500020
         ST    RF,LCBRCB                SAVE BASE                       65520020
         BAL   RA,FINDBUFF              POST PREVIOUS BUFFERS           65540020
         L     RF,LCBRCB                RESTORE BASE                    65560020
         OI    PRFSTAT1,PRFITCPN .      NOT REAL END OF MSG      X01004 65566005
FSELECT  EQU   *                                                 S22025 65572022
         STCM  RPREFIX,AD,LCBLSPCI .    SET LAST RECEIVED BUFFER Y01948 65580005
         MVI   LCBTPCD+2,TPBUFEOT       SET TP OP CODE                  65640020
         B     RESETEOT                 WRITE EOT                       65680020
NEXTBLK  CLI   LCBCPA+52,0              EXECUTED INSTRUCTION            65700020
CLIUNT   EQU   *                                                        65720020
         CLI   PRFNBUNT,0                                               65740020
         SPACE 10                                                S21101 65750020
DIALTEST EQU   *                                                 S21101 65752020
*                                                                S21101 65754020
*        SUBROUTINE TO DETERMINE IS LINE IS BSC DIAL WITH SEND   S21101 65756020
*        PRIORITY, OR BSC CONTENTION, SEND PRIORITY, AND MASTER@XA08073 65758091
*        =YES SPECIFIED.                                       @XA08073 65758291
*                                                              @XA08073 65758491
         CLI   LCBRSPRI,SENDPRI         SEND PRIORITY          @XA08073 65758891
         BNER  RE                       RETURN IF NO           @XA08073 65759291
         SPACE 1                                               @XA08073 65759491
         OI    SCBBSCFM,SCBNOEOT        SET FLAG FOR SCHEDULER @XA08073 65759891
*                                         AND I/O GEN TO NOT   @XA08073 65759991
*                                         RESET ACK COUNTER    @XA08073 65760291
*                                         AND TO PROCEED WITH  @XA08073 65760591
*                                         SENDING (TENATIVELY) @XA08073 65760891
         SPACE 1                                               @XA08073 65761191
         TM    SCBBSCFM,SCBMLMTN        WAS MSG LIMIT REACHED  @OY13632 65761491
         BO    NOTMSTR                  BRANCH-YES SEND EOT    @OY13632 65763491
         SPACE 1                                               @XA08073 65767091
         BAL   RD,DCTBASE               COMPUTE DCT            @XA08073 65767291
         SPACE 1                                               @XA08073 65767491
         TM    TWO(RA),CCONTENT         CONTENTION             @XA08073 65767691
         BO    4(RE)                    YES, RETURN AT + 4     @XA08073 65767891
         SPACE 1                                               @XA08073 65768691
NOTMSTR  EQU   *                                               @XA08073 65769091
         NI    SCBBSCFM,AVTEFF-SCBNOEOT RESET EOT FLAG         @XA08073 65769491
         SPACE 1                                               @XA08073 65769891
         BR    RE                       RETURN                 @XA08073 65770291
         EJECT                                                          65773320
.L71     ANOP                                                           65780020
         AIF   ('&GEN' EQ 'BISC').L70                                   65800020
         USING *,RF                                                 TSO 65820020
DYNC     EQU   *                                                    TSO 65840020
         CLI   CCWOPCDE,CCWENAB         THIS ENABEL INTERRUPT       TSO 65860020
         BE    CHGPREP                  YES. CHANGE PREP TO READ    TSO 65880020
         SPACE                                                          65900020
DYN1     EQU   *                                                    TSO 65920020
         TM    LCBSENS0,TIMEOUT+IR      TIME OUT OR INTERV REQ.     TSO 65940020
         BM    S1050                      2703        2702          TSO 65960020
S2741    EQU   *                                                  TSO   65980020
         SPACE                                                          66140020
TSO98    EQU   * .                                                  TSO 66160020
         MVI   LCBTPCD+10,0 .           ZERO SPECIAL FLAG           TSO 66180020
         B     TSO2 .                   PROCESS MESSAGE             TSO 66200020
         SPACE                                                          66220020
S1050    EQU   *                                                    TSO 66240020
         CLI   LCBTPCD+11,X'16'         CIRCLE D RCVD?            TSO   66260020
         BE    S2741                    YES. MUST BE 2741         TSO   66280020
         NI    LCBTSOB,X'FF'-LCB2741N . IS NOT A 2741                   66290020
         NI    LCBSTAT1,X'FF'-LCBCONT   CLR CONTINUE REQ.           TSO 66300020
         ST    R15,LCBERCCW+4    .     SAVE BASE                SA51097 66320022
         L     12,AVTKA02               ADR OF ACTIVATE (IOGEN)     TSO 66340020
         LA    RAVT,AVTSAVE2            AVT BASE FOR KA             TSO 66360020
         BALR  5,12                                                 TSO 66380020
         L     R15,LCBERCCW+4  .       RESTORE BASE             SA51097 66400022
         LA    RBASE,4095(,R15)                                   TSO   66420020
         LA    RBASE,1(,RBASE)                                    TSO   66440020
         SH    RAVT,AVTBACK             RESET AVT BASE              TSO 66460020
         MVC   LCBCPA+48(4),LCBCPA+56   OVERLAY W/WRT PADS          TSO 66480020
         LA    RC,LCBCPA+16             ADR FOR 1050 START I/O      TSO 66500020
         ST    RC,LCBCPA+56             BUILD TIC TO IT             TSO 66520020
         MVI   LCBCPA+56,CCWTIC         SET TIC                     TSO 66540020
         LA    RC,LCBCPA+48             NEW SIO ADR                 TSO 66560020
NEWSTART EQU   *                                                    TSO 66580020
         MVI   LCBTPCD+10,0             CLEAR CHECK INDICATOR       TSO 66600020
         ST    RC,LCBSTART-1                                        TSO 66620020
         B     RESTART                                              TSO 66640020
         SPACE                                                          66660020
CHGPREP  EQU   *                                                    TSO 66680020
         OI    LCBTSTSW,X'80'           SET 'CONNECTED' BIT         TSO 66700020
         OI    LCBTSOB,LCB2741N .       ASSUME 2741                 TSO 66710020
         LA    RC,LCBTPCD+11            ADDR FOR READ               TSO 66720020
         ST    RC,LCBCPA+40             CHANGE IT                   TSO 66740020
         MVI   LCBCPA+40,CCWREAD        SET CCW = READ              TSO 66760020
         MVI   LCBCPA+44,X'80' .        DATA CHAIN READ             TSO 66780020
         L     RC,LCBCPA+48             SAVE WRT PADS CMD           TSO 66800020
         MVC   LCBCPA+48(4),LCBCPA+56   MOVE IN 'TIC BFR'           TSO 66820020
         ST    RC,LCBCPA+56             SAVE WRT PADS                   66840020
         LA    RCCW,LCBCPA+40           NEW SIO ADDR                TSO 66860020
         ST    RCCW,LCBSTART-1                                      TSO 66880020
         B     RESTART                                              TSO 66900020
         EJECT                                                          66920020
.C       ANOP                                                    S22025 66930022
TSOCHK   EQU   *                                                        66940020
RWORK    EQU   RB                                                   TSO 66960020
         SPACE                                                          66980020
         USING *,RA                                                     67000020
         TM    LCBSENS0,X'40'           INTERVENTION REQUIRED?      TSO 67080020
         BZ    ERP                      NO..ERP CAN HANDLE          TSO 67100020
         AIF   ('&GEN' EQ 'QTAM').C1                             S22025 67110022
         LA    RF,OPCHK1                                                67120020
         LA    RPREFIX,LCBERB .         SET TO POST ERB TO AYF     TSO  67140020
.C1      ANOP                                                    S22025 67150022
         TM    LCBSTAT2,LCBMSGNN                                    TSO 67160020
         BNO   CKTXT .                  BRANCH IF NOT A MSGGEN   S22025 67180022
         AIF   ('&GEN' NE 'QTAM').C2 .                           S22025 67180422
         B     ERP .                    GO TO ERP                S22025 67180822
         AIF   ('&GEN' EQ 'QTAM').CC .                           S22025 67181222
.C2      ANOP .                                                  S22025 67181622
         TM    LCBTSOB,LCBTSBUF .       IS THIS A TSO LINE ?     S22025 67182022
         BNO   ERP .                    NOT TSO-TCAM TREATS AS   S22025 67184022
*                                            ERROR               S22025 67186022
         B     CKATN .                  TSO-CHECK ATTN STATUS    S22025 67190022
.CC      ANOP                                                           67192022
CKTXT    LA    RCCW,0(,RCCW) .          GET ADDRESS OF END CCW   S22025 67200022
         LA    RWORK,LCBCPA             START OF CH PGM AREA            67220020
         SR    RWORK,RCCW                                               67240020
         BP    ITEXT                                                    67260020
         SR    RB,RB .                  CLEAR                       TSO 67280020
         L     RC,LCBDCBPT .            DCB ADDRESS                 TSO 67300020
         USING IHADCB,RC  .                                         TSO 67320020
         IC    RB,DCBEIOBX .            LCB SIZE                    TSO 67340020
         DROP  RC  .                                                TSO 67360020
         LA    RB,0(RLCB,RB) .          LCB ADDRESS                 TSO 67380020
         SR    RB,RCCW .                IN CHANNEL PROGRAM AREA     TSO 67400020
         BNP   ITEXT .                  NOT IN CHANNEL PROGRAM   S22025 67420022
         AIF   ('&GEN' NE 'QTAM').C9 .                           S22025 67420422
         B     ERP .                    SCHEDULE ERP             S22025 67420822
         AIF   ('&GEN' EQ 'QTAM').C4 .                           S22025 67421222
.C9      ANOP .                                                  S22025 67421622
         TM    LCBTSOB,LCBTSBUF .       IS THIS A TSO LINE ?     S22025 67422022
         BNO   ERP .                    NOT TSO - TCAM TREATS AS S22025 67424022
*                                            ERROR               S22025 67426022
         BO    TWXCHK1 .                CHECK FOR POSSIBLE TWX   S22025 67430022
*                                       ATTENTION ON READ TSO    S22025 67432022
.C3      ANOP                                                    S22025 67434022
ITEXT    EQU   *                                                        67440020
         TM    LCBTSOB,LCBTSBUF .       IS THIS A TSO LINE ?     S22025 67445022
         BNO   TCAMATN .                BRANCH = NO              S22025 67450022
         AIF   ('&GEN' EQ 'QTAM').C4                             S22025 67455022
         TM    LCBSTAT1,LCBRECVN .      ARE WE IN RECEIVE MODE      TSO 67460020
         BO    TWXCHK2 .          BR ON YES TO CHECK FOR TWX        TSO 67480020
ITEXT1   EQU   *                                                        67500020
         L     RPREFIX,LCBLSPCI-1 .     POST BUFFER TO AYF         TSO  67520020
         MVC   PRFSHDR-IEDQPRF(8,RPREFIX),0(RPREFIX) SAVE COMMANDS22029 67540022
CKATN    EQU   *                                                        67560020
         L     RB,AVTTSOPT .            ADDRESS OF TSO WORK AREA   TSO  67580020
         L     RF,TSIHALT-IEDQTSI(RB) . ADDRESS OF AYF             TSO  67600020
         B     TSOCOM .                 USE COMMON CODE             TSO 67620020
.C4      ANOP                                                    S22025 67621022
         AIF   ('&GEN' NE 'QTAM').C5 .                           S22025 67621222
ITEXT    EQU   * .                                               S22025 67621422
.C5      ANOP .                                                  S22025 67621622
TCAMATN  EQU   * .                                               S22025 67622022
         SPACE 1                                                        67622222
         TM    LCBSTAT1,LCBRECVN .      LINE RECEIVING ?         S22025 67622422
         BO    ERP .                    BRANCH IF YES            S22025 67622622
         BAL   RD,DCTBASE .             GO FIND DCT              S22025 67623022
         USING *,RD .                     ADDRESSABILITY         S22025 67624022
         TM    1(RA),ATTN .             IS ATTENTION ALLOWED?    S22025 67625022
         BZ    ERP .                    BRACNH = NO              S22025 67627022
         LR    RPREFIX,RLCB .           SET TO POST LCB TO       S22025 67628022
*                                            STOPLINE            S22025 67629022
         MVI   PRFPRI,PRILCBAT .        SET PRIORITY             S22025 67630022
         L     RF,AVTHK .               GET ROUTINE'S ADDRESS    S22025 67631022
         AIF   ('&GEN' EQ 'QTAM').C6                             S22025 67632022
         B     TSOCOM1                                           S22025 67633022
         DROP  RD                                                S22025 67633522
         USING TSOCHK,RA                                                67634022
*                                                                       67640020
TWXCHK1  EQU   *                                                        67660020
*                                                                       67680020
         CLI   0(RCCW),X'0A' .  IS THE INT. CCW AN INH. READ        TSO 67700020
         BNE   ERP .              BR IF NO, TREAT AS ERROR          TSO 67720020
         LA    RC,LCBCPA+24 .   GET ADDR OF READ RESP. CCW          TSO 67740020
         CR    RC,RCCW .        WAS INT ON READ RESP.               TSO 67760020
         BE    ITEXT .                  BR YES FOR TWX ATTN ON READ TSO 67780020
         B     CHK10501 NO, CHECK FOR 1050                         TSO  67800020
*                                                                       67820020
TWXCHK2  EQU   *                                                        67840020
         L     RC,AVTSAVEX+UCBOFFST     UCB ADDRESS            @ZO2X6I0 67860061
         CLI   16(RC),X'51' .           CHK UCB MODEL CODE FOR TWX  TSO 67880020
         BNE   CHK10502 BR IF NOT, CHECK 1050                      TSO  67900020
         TM    19(RC),X'50' .CHECK UCB UNIT TYPE FOR TEL. ADPT./2   TSO 67920020
         BNO   CHK10502 BR IF NO, CHECK 1050                       TSO  67940020
         TM    19(RC),X'A0' IS IT ANYTHING BUT TEL.ADPT.-2          TSO 67960020
         BC    5,CHK10502 BR IF YES  CHECK 1050                    TSO  67980020
         B     ITEXT1 .     WE HAVE TWX ATTN ON READ TEXT           TSO 68000020
*                                                                       68020020
CHK10501 EQU   *                                                        68040020
         LA    RC,LCBCPA+32 GET ADDR OF POSSIBLE 1050 RD. RESP. CCW TSO 68060020
         CR    RCCW,RC WAS INT. ON RD. RESP.                        TSO 68080020
         BE    ITEXT YES,ATTN ON NULL LINE,TREAT AS TEXT            TSO 68100020
         B     ERP NO, ATTN ON READ RESP, TREAT AS ERROR            TSO 68120020
CHK10502 EQU   *                                                        68140020
         TM    19(RC),X'10' IS IT TERMINAL ADPTER-TYPE 1            TSO 68160020
         BZ    ERP  BR IF NO                                        TSO 68180020
         TM    19(RC),X'E0' IS IT ANYTHING BUT TERM. ADPT.-TYPE 1   TSO 68200020
         BC    5,ERP BR IF YES                                      TSO 68220020
         TM    LCBTSOB,LCB2741N IS IT 2741                          TSO 68240020
         BZ    ITEXT1 BR IF NO, MUST BE 1050,TREAT AS ATTN ON RD TEXT   68260020
         B     ERP GO TO ERP FOR 2741                               TSO 68280020
LCBTOATN EQU   *                                                    TSO 68300020
         OI    SCBERR3,SCBATTN                                      TSO 68320020
         MVI   LCBPRI,PRILNCL                                       TSO 68340020
         LR    RPREFIX,RLCB                                         TSO 68360020
         L     RF,AVTTSOPT .           GET ADDRESS OF TSINPUT QCBS22029 68380022
         LA    RF,0(RF)                 CLEAR HIGH ORDER BYTE  @OX14796 68383091
         LTR   RF,RF                    CHECK FOR NO TSO       @OX14796 68386091
         BZ    REMO                     BRANCH IF NO TSO       @OX14796 68389091
         TM    LCBTSOB,LCBTSBUF         TSO CHECK              @OX14796 68392091
         BZ    REMO                     BRANCH NO TSO          @OX14796 68395091
         L     RF,TSIATTEN-IEDQTSI(,RF) GET ADDRESS OF ATTENTION S22029 68400022
TSOCOM   EQU   * .                                                  TSO 68480020
         MVI   PRFPRI,PRIRCQCB .        SET PRIORITY                    68500020
.C6      ANOP                                                    S22025 68510022
TSOCOM1  LA    RC,FREERQE .                                      S22025 68520022
         B     ENQUEUE .                PLACE ELEMENT ON READY Q    TSO 68540020
OPCHK1   EQU   *                                                        68560020
         USING *,RF                                                     68580020
         MVI   LCBTPCD+11,0 .           CLEAR OPEN CHECK FLAG       TSO 68600020
         AIF   ('&GEN' EQ 'QTAM').C7   .                         S22025 68605022
         SPACE 1                                                SA62379 68610054
        TM    LCBSTAT2,LCBMSGNN .      MESSAGE GEN                 TSO  68620020
         BZ    NOATN .                  BRANCH NO                  TSO  68640020
         TM    LCBCSW+4,X2F   .         ERROR STATUS               TSO  68660020
         BNZ   ERBPOST .                BRANCH YES                 TSO  68680020
         TM    LCBSENS0,IR+TIMEOUT .    HAS USER HUNG UP           TSO  68700020
        BNZ   HANG .                   BRANCH YES                       68720020
         L     RA,TSOCHKAD .            SET BASE                        68740020
         USING TSOCHK,RA                                                68760020
         B     LCBTOATN .               POST LCB TO ATTENTION       TSO 68780020
         DROP  RA                                                       68800020
NOATN    EQU   *                                                        68820020
         TM    LCBCSW+4,X2F             SERIOUS ERRORS              TSO 68840020
         BNZ   HANG                     GO TO HANG-UP                   68860020
         TM    LCBSENS0,IR+TIMEOUT      HUNG UP                         68880020
         BNZ   HANG                     GO                              68900020
         SPACE                                                          68920020
         TM    LCBTSOB,LCBPREP                                          68940020
         BO    RTPREP                                                   68960020
         OI    SCBERR3,SCBATTN          SET ATTENTION BIT           TSO 68980020
         OI    LCBCHAIN,LCBNORTY        DO NOT RETRY           @OX12511 68981091
         B     RESETSO .                                         S22025 68982022
.C7      ANOP                                                    S22025 68984022
TCAMATN1 TM    LCBSENS0,IR+TIMEOUT .    HAS STATION HUNG UP ?    S22025 68986022
         BZ    BITON                    BRANCH IF NO             S22025 68988022
         MVI   LCBECBCC,X7F             RESET ECB COMPLETION CD  S22025 68988222
         MVC   LCBCSW(7),LCBCSWSV       RESTORE CSW SAVED IN     S22025 68988422
*                                       STOPLINE                 S22025 68988622
         XC    LCBCSWSV(7),LCBCSWSV     CLEAR FIELD              S22025 68988822
         B     ERP                      HANDLE INTERVENTION REQ  S22025 68989022
BITON    EQU   *                                                 S22025 68989222
         OI    SCBERR3,SCBATTN .        NO, SET ATTENTION BIT    S22025 68990022
         MVI   LCBCHAIN,LCBNORTY                                 S22025 68992022
         SPACE                                                          69000020
RESETSO  EQU   *                                                        69020020
         MVI   LCBTPCD+11,0             CLR OPEN LINE CHK INDIC     TSO 69040020
         MVC   LCBCSW(7),LCBCSWSV                                       69060020
         AIF   ('&GEN' EQ 'QTAM').C8 .                           S22025 69070022
         XC    LCBCSWSV(7),LCBCSWSV     CLEAR                           69080020
         NC    LCBLSPCI(2),LCBLSPCI .   MAKE SURE                   TSO 69100020
         BZ    CTLNOBUF                                                 69120020
.C8      ANOP .                                                  S22025 69130022
         MVI   LCBECBCC,PERMERR .       SET PERMANENT ERROR             69140020
         B     TSO2 .                   POST BUFFER TO MH               69160020
         AIF   ('&GEN' EQ 'QTAM').L70                            S22025 69170022
CTLNOBUF EQU   *                                                        69180020
         TM    LCBSTAT2,LCBMSGNN        WAS IT MSGGE?"                  69200020
         BO    ERBPOST                                                  69220020
         L     RA,TSOCHKAD .            ESTABLISH ADDRESSABILITY S22026 69226022
         USING TSOCHK,RA .                                       S22026 69232022
         B     LCBTOATN .               POST LCB TO ATTN            TSO 69240020
         DROP  RA .                                              S22026 69250022
*  ASSUME USER HAS HUNG UP (DISCONNTCTED)                               69260020
HANG     EQU   *                                                        69280020
         L     RSCB,LCBSCBA-1                                           69300020
         OI    SCBERR3,SCBTMINN         SET PERMANENT ERROR    @OZ30260 69310086
         TM    LCBSTAT2,LCBMSGNN .      MESSAGE GEN                 TSO 69320020
         BO    NOBUF .                   BRANCH YES                 TSO 69340020
         SPACE                                                          69360020
         NC    LCBLSPCI(2),LCBLSPCI .   ANY BUFFERS ASSIGNED            69380020
         BNZ   TSTXTER                                                  69400020
         SPACE                                                          69420020
NOBUF    EQU   *                                                        69440020
*  NO BUFFERS TO PASS SO POST LCB TO HANGUP                             69460020
         L     RWORK,AVTTSOPT                                           69480020
         LA    RWORK,0(RWORK)           CLEAR HIGH ORDER BYTE  @OX14796 69483091
         LTR   RWORK,RWORK              CHECK FOR NO TSO       @OX14796 69486091
         BZ    REMO                     BRANCH IF NO TSO       @OX14796 69489091
         TM    LCBTSOB,LCBTSBUF         TSO CHECK              @OX14796 69492091
         BZ    REMO                     BRANCH NO TSO          @OX14796 69495091
         USING IEDQTSI,RWORK                                            69500020
         L     RF,TSIHANG .             ADDRESS OF HANGUP ROUTINE   TSO 69520020
         DROP  RWORK                                                    69540020
         LR    RPREFIX,RLCB             ELEMENT TO PASS                 69560020
         BAL   RC,ENQUEUE                                               69580020
         B     FREERQE                                                  69600020
         SPACE                                                          69620020
TSTXTER  EQU   *                                                        69640020
         TM    LCBSTAT1,LCBSENDN        SENDING                         69660020
         BO    RESETSO .                                            TSO 69680020
*  RECEIVING. MAKE PERM ERROR ON FIRST BUFFER                           69700020
TSTXTRCV EQU   *                                                        69720020
         L     RCCW,LCBLSPCI-1                                          69740020
         LH    RPREFIX,6(,RCCW)         ORIG COUNT                      69760020
         STH   RPREFIX,LCBCSW+5                                         69780020
         MVI   LCBECBCC,X'41'                                           69800020
         LA    RCCW,8(,RCCW)                                            69840020
         STCM  RCCW,AD,LCBCSW .         SET CSW = ADDRESS OF 1ST Y01948 69860005
*                                       BUFFER + 8.              Y01948 69880005
         XC    LCBCSWSV(7),LCBCSWSV                                     69900020
         MVI   LCBTPCD+11,0                                             69920020
         B     TSO2                                                     69940020
*  SEND MODE. TREAT AS FOR OUTPUT ATTN EXCEPT ATTN BIT NOT SET          69960020
         EJECT                                                          69980020
.L70     ANOP                                                           70000022
         AIF   ('&GEN' EQ 'MINI').LL4A                                  70000522
SOURCER  EQU   *                                                 S99228 70001022
         AIF   ('&GEN' EQ 'QTAM').LL4F                          SA65397 70001552
* THIS SUBROUTINE CALCULATES TRANSMISSION SOURCES OF MESSAGES    S99228 70002022
* RECEIVED UNDER GENERAL POLL                                    S99228 70003022
         USING *,RF                                              S99228 70004022
         SR    RB,RB                    CLEAR WORK REGISTER      S99228 70005022
         USING IHADCB,RA                                         S99228 70006022
         L     RA,LCBDCBPT              LOAD INVLIST POINTER     S99228 70007022
         IC    RB,LCBUCBX               LOAD INVLIST INDEX       S99228 70008022
         SLL   RB,TWO                   MULTIPLY POINTER BY 4    S99228 70009022
         L     RC,DCBINVLI(RB)          LOAD ADDR INVLIST C WORD S99228 70010022
         LR    RPREFIX,RWKA             LOAD BUFFER ADDRESS      S99228 70012022
         SR    RB,RB                    CLEAR IDLES REGISTER     S99228 70013022
         IC    RB,LCBISZE               INSERT IDLES COUNT       S99228 70013722
         TM    LCBERCCW+ONE,IN          LINE CONTROL IN?         S99228 70013822
         BO    LCPRES                   BRANCH YES               S99228 70013922
         BCTR  RB,R0                    SET TO POINT AT LC CHAR  S99228 70014022
LCPRES   EQU   *                                                 S99228 70014122
         LA    RE,PRFSHDR(RB)           LOAD DATA ADDRESS        S99228 70014422
         AIF   ('&GEN' EQ 'STSP').LL4C                           S99228 70015122
         TM    LCBSTAT2,LCBSYNC         BISYNC LINE?             S99228 70016022
         BZ    REGMSG                   NO, SKIP SOH%R SEARCH    S99228 70017022
         L     RB,DCBSCTAD-ONE          LOAD ADDR SPEC CHARS TBL S99228 70018022
         DROP  RA                                                S99228 70019022
         SR    RA,RA                    CLEAR OFFSET REGISTER    S99228 70020022
         IC    RA,RSOHCH(R0,RB)         INSERT SOH%R OFFSET      S99228 70021022
         LA    RB,ONE(RA,RB)            LOAD ADDR SOH%R CHARS    S99228 70022022
         CLC   ZERO(ONE,RB),ZERO(RE)    SOH%R MESSAGE?           S99228 70023022
         BNE   USUMSG                   BRANCH NO                S99228 70024022
         LA    RE,THREE(R0,RE)          BYPASS SOH%R STX CHARS   S99228 70025022
USUMSG   EQU   *                                                 S99228 70026022
         LA    RE,ONE(R0,RE)            POINT TO CU ENTRY        S99228 70027022
REGMSG   EQU   *                                                 S99228 70028022
.LL4C    ANOP                                                    S99228 70028522
         LR    R0,RC                    SAVE INVLIST C WORD ADDR S99228 70029022
         SR    RA,RA                    CLEAR ENTRY COUNT REG    S99228 70029522
         SR    RB,RB                    CLEAR WORK REGISTER      S99228 70030022
         IC    RB,TWO(R0,RC)            LOAD INVLIST ENTRY LENGT S99228 70031022
         IC    RA,ONE(R0,RC)            SET ACTIVE INVLIST E CNT S99228 70032022
         LA    RC,EIGHT(R0,RC)          SET INVLIST START ADDR   S99228 70033022
         LA    RPREFIX,TWO              SET ACTIVE-INACTIVE CON  S99228 70034022
SYNCTEST EQU   *                                                SA65428 70034505
         LTR   RA,RA                    TEST NUMBER ACTIVE ENT   S99228 70035022
         BZ    NOORG                    NO ACTIVE ENTRIES NO SRC S99228 70036022
         AIF   ('&GEN' EQ 'STSP').LL4D                           S99228 70037522
         TM    LCBSTAT2,LCBSYNC         TEST FOR BSYNC LINE      S99228 70038022
         BZ    SLOLINE                  NO, NO SKIP OF 1ST CU    S99228 70039022
         LA    RC,ONE(R0,RC)            ADJ PTR TO COMPARE 2ND C S99228 70040022
SLOLINE  EQU   *                                                 S99228 70041022
.LL4D    ANOP                                                    S99228 70041522
         L     RWKA,LCBINVPT-ONE        LOAD INVLIST POINTER     S99228 70042022
CONCHECK EQU   *                                                 S99228 70043022
         CLC   ZERO(ONE,RWKA),ZERO(RC)  COMPARE CONTROL UNIT ADD S99228 70044022
         BE    DVCCHECK                 CU ADDRS EQUAL CHECK DVC S99228 70045022
CONTEST  EQU   *                                                 S99228 70046022
         AR    RC,RB                    SKIP TO NEXT INVLIST ENT S99228 70047022
         BCT   RA,CONCHECK              CONTINUE SEARCHING       S99228 70048022
         BCT   RPREFIX,FEINCRE          PROCESS INACTIVE ENTRIES S99228 70049022
         B     NOORG                    NO SRC FOUND SET NO SRC  S99228 70050022
DVCCHECK EQU   *                                                 S99228 70051022
         CLC   ONE(ONE,RC),ONE(RE)      COMPARE DEVICE ADDR      S99228 70052022
         BNE   CONTEST                  BRANCH DEVICE NOT FOUND  S99228 70053022
         STM   RPREFIX,RC,SRCREGS       SAVE REGISTERS           S99228 70053122
         LR    RA,R0                    LOAD INVLIST CWORD ADDR  S99228 70053222
         TM    LCBSTAT2,LCBSYNC         BYSNC INVLIST?           S99228 70053322
         BZ    RUNLOW                   BRANCH NO                S99228 70053422
         BCTR  RB,R0                    REDUCE ENTRY LENGTH      S99228 70053522
RUNLOW   EQU   *                                                 S99228 70053622
         BCTR  RB,R0                    REDUCE ENTRY SIZE        S99228 70053722
         IC    RB,ZERO(RB,RC)           INSERT ENTRY INDEX       S99228 70053822
         SLL   RB,ONE                   DOUBLE INDEX VALUE       S99228 70053922
         SR    RA,RB                    POINT TO TNT INDEX       S99228 70054022
         LH    RC,ZERO(R0,RA)           LOAD TNT INDEX           S99228 70054122
         BAL   RWKA,BOLOC               BRANCH TO DCT ENTRY LOC  S99228 70054222
         TM    ONE(RA),C3270            3270 DEVICE?             S99228 70054322
         BO    RELOAD                   BRANCH YES               S99228 70054422
         TM    THREE(RA),CNOIDLES       2260 DEVICE?             S99228 70054522
RELOAD   EQU   *                                                 S99228 70054622
         LM    RPREFIX,RC,SRCREGS       RESTORE REGISTERS        S99228 70054722
         BO    SETORG                   BRANCH IF GENPOLL DEVICE S99228 70054822
         B     CONTEST                  NOT GENPOLL DEVICE       S99228 70054922
FEINCRE  EQU   *                                                 S99228 70055022
         LA    RC,ONE(R0,RC)            ADJ PTR ADDR TO PASS FE  S99228 70056022
         LR    RWKA,R0                  RESTORE CONTROL WORD ADD S99228 70057022
         IC    RA,ZERO(R0,RWKA)         LOAD TOTAL ENTRIES       S99228 70058022
         SR    RB,RB                    CLEAR ACTIVE ENTRIES REG S99228 70059022
         IC    RB,ONE(R0,RWKA)          LOAD ACTIVE ENTIRES      S99228 70060022
         SR    RA,RB                    DERIVE INACTIVE ENTRIES  S99228 70061022
         IC    RB,TWO(R0,RWKA)          RESTORE LENGTH           S99228 70062022
         B     SYNCTEST                 CONT SRCH INACT ENTRIES  S99228 70063022
SETORG   EQU   *                                                 S99228 70064022
         AIF   ('&GEN' EQ 'STSP').LL4E                           S99228 70064522
         TM    LCBSTAT2,LCBSYNC         BYSNC INVLIST?           S99228 70065022
         BZ    UNSYNC                   NO, NO RETARD INV PTR    S99228 70066022
         BCTR  RC,R0                    RETARD INV PTR TO CU ADD S99228 70067022
UNSYNC   EQU   *                                                 S99228 70068022
.LL4E    ANOP                                                    S99228 70068522
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 70069022
         ST    RC,LCBXRADR              SAVE ERP POLL ADDR       S99228 70071022
*                                       FOR ERP POLL             S99228 70073022
         BCTR  RC,R0                    RETARD INVLIST ENTRY PTR S99228 70074022
         AR    RC,RB                    PT TO INVLIST ENT INDEX  S99228 70075022
         SR    RWKA,RWKA                CLEAR WORK REGISTER      S99228 70076022
         IC    RWKA,ZERO(R0,RC)         LOAD INDEX VALUE         S99228 70077022
         SLL   RWKA,ONE                 DOUBLE INDEX VALUE       S99228 70078022
         LR    RC,R0                    RSTR INVLIST C WORD ADDR S99228 70079022
         SR    RC,RWKA                  POINT TO TNT INDEX       S99228 70080022
         LH    RWKA,ZERO(R0,RC)         LOAD TNT INDEX VALUE     S99228 70081022
         STH   RWKA,LCBTTCIN            SET SOURCE OF TRANS      S99228 70086022
         BR    RD                       RETURN TO CALLER         S99228 70087022
NOORG    EQU   *                                                 S99228 70088022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR SA66946 70088505
         NI    LCBXFLAG,LCBERSTP        PREVENT ERP POLL         S99228 70089022
         XC    LCBTTCIN(TWO),LCBTTCIN   INVALID SOURCE CLEAR SRC S99228 70090022
.LL4F    ANOP                                                   SA65397 70090552
         BR    RD                       RETURN TO CALLER         S99228 70091022
         SPACE 2                                                        70091222
SRCREGS  DS    4F                       SAVE AREA FOR SOURCE     S99228 70091422
*                                       DETERMINATION REGISTERS  S99228 70091622
         EJECT                                                   S99228 70095022
LOOKER   EQU   *                                                 S99228 70096022
* THIS SUBROUTINE LOCATES THE INVITATION LIST AND DEVICE         S99228 70097022
* CHARACTERISTICS TABLE ENTRY FOR 2260  AND 3270 DEVICES         S99228 70098022
         USING *,RF                                              S99228 70099022
         SR    RB,RB                    CLEAR WORK REGISTER      S99228 70100022
         USING IHADCB,RA                                         S99228 70101022
         L     RA,LCBDCBPT              LOAD DCB POINTER         S99228 70102022
         IC    RB,LCBUCBX               LOAD INVLIST INDEX       S99228 70103022
         SLL   RB,TWO                   MULTIPLY INDEX BY 4      S99228 70104022
         L     RC,DCBINVLI(RB)          LOAD ADDR INVLIST CWORD  S99228 70105022
         LR    R0,RC                    SAVE ADDR INVLIST CWORD  S99228 70105122
         SR    RB,RB                    CLEAR LENGTH REGISTER    S99228 70105222
         IC    RB,DCBEIOBX              INSERT LCB LENGTH        S99228 70105322
         SH    RB,H8S                   BACK UP LCB BY 8         Y01948 70105405
         LA    RE,ZERO(RB,RLCB)         LOAD LCB EXTENSION ADDR  S99228 70105622
         STCM  RE,AD,AVTDOUBX+ONE      SAVE LCB EXTN ADDR        Y01948 70105705
         ST    R0,AVTDOUBX+FOUR         SAVE CWORD ADDR         OX03941 70105854
         DROP  RA                                                S99228 70106022
         LH    RC,LCBTTCIN .            LOAD TERM INDEX          S99228 70106622
         N     RC,AVTCLRHI .            CLEAR HI-ORDER HALF      S99228 70107222
         TM    LCBSTAT1,LCBSENDN        SEND STATE?              S99228 70108022
         BO    OUTBY                    YES, USE LCBTTCIN        S99228 70109022
         TM    LCBXFLAG,LCBSRCPF        SRC DETERM PERFORMED?    S99228 70110022
         BO    USEPTR                   YES, USE INVLIST PTR     S99228 70111022
         LTR   RC,RC .                  TTCIN ZERO               S99228 70112022
         BNZ   OUTBY                    NO, LCBTTCIN VALID       S99228 70114022
USEPTR   EQU   *                                                 S99228 70115022
         LR    RC,R0                    RESTORE REG              S99228 70115522
         L     RA,LCBINVPT-ONE          LOAD INVLIST ENTRY PTR   S99228 70116022
         SR    RB,RB                    CLEAR WORK REGISTER      S99228 70117022
         IC    RB,TWO(R0,RC)            LOAD INVLIST ENTRY LENGTHS99228 70118022
         AR    RA,RB                    SKIP TO END INVLIST ENT  S99228 70119022
         BCTR  RA,R0                    POINT TO ENTRY INDEX     S99228 70120022
         IC    RB,ZERO(R0,RA)           LOAD ENTRY INDEX VALUE   S99228 70121022
         SLL   RB,ONE                   DOUBLE INDEX VALUE       S99228 70122022
         SR    RC,RB                    POINT TO TNT INDEX       S99228 70124022
         LH    RC,ZERO(R0,RC)           LOAD TNT INDEX           S99228 70125022
OUTBY    EQU   *                                                 S99228 70126022
         BAL   RWKA,BOLOC               BRANCH TO DCT ENTRY LOC  S99228 70127022
         MVC   LCBXDCT(THREE),ONE(RA)   SAVE DCT BYTES 1, 2, 3   S99228 70138022
         LR    RE,R0                    LOAD INVLIST CWORD ADDR  S99228 70138522
         BR    RD                       RETURN                   S99228 70139022
         EJECT                                                          70139122
BOLOC    EQU   *                                                 S99228 70139222
* THIS SUBROUTINE LOCATES DEVICE CHARACTERISTICS TABLE ENTRIES   S99228 70139322
         N     RC,AVTCLRHI              CLEAR HI ORDER BYTES     S99228 70139422
         L     RA,AVTRNMPT              LOAD ADDR TERMNAME TABLE S99228 70139522
         USING IEDQTNTD,RA                                       S99228 70139622
         BAL   RPREFIX,TNTDCODE         BRANCH TO TRM ENT LOC RT S99228 70139722
         USING IEDQTRM,RB                                        S99228 70139822
         DROP  RA                                                S99228 70140022
         SR    RA,RA                    CLEAR INDEX REGISTER     S99228 70140122
         IC    RA,TRMCHCIN              LOAD DCT INDEX           S99228 70140222
         BCTR  RA,R0                    DECREMENT FOR ENTRY      S99228 70140322
         MH    RA,AVTDCTLN              LENGTH OF DCT ENTRY    @G36XRIV 70140400
         DROP  RB                                                S99228 70140522
         A     RA,AVTCSTCS              SET ADDR DCT ENTRY       S99228 70140622
         BR    RWKA                     RETURN TO CALLER         S99228 70140722
         AIF   ('&GEN' EQ 'STSP').LL4A                           S99228 70140822
         EJECT                                                          70140922
FINDER   EQU   *                                                 S99228 70141022
* THIS ROUTINE CALCULATES INVITATION LIST ENTRY ADDRESSES        S99228 70142022
* ON 3270 DEVICE DEPENDENT OUTPUT ERRORS                         S99228 70143022
         USING *,RF                                              S99228 70144022
         SR    RB,RB                    CLEAR WORK REGISTER      S99228 70145022
         L     RE,AVTDOUBX+FOUR         LOAD INVLIST CWORD ADDR  S99228 70146022
         SR    RC,RC                    CLEAR WORK REGISTER      S99228 70152022
         IC    RC,ZERO(R0,RE)           INSERT INVLIST TOTAL ENT S99228 70153022
         LA    RC,ONE(R0,RC)            INCRE TOTAL BY 1 FOR LOO S99228 70154022
         SLL   RC,ONE                   MULT BY 2 FOR ADDR RETAR S99228 70155022
         LR    RB,RE                    SAVE INVLIST CWORD ADDR  S99228 70156022
         SR    RB,RC                    RETARD ADDR TO 1ST INDEX S99228 70157022
         SRL   RC,ONE                   RETURN TO TOTAL ENTRIES  S99228 70158022
LOOPER   EQU   *                                                 S99228 70159022
         BCT   RC,LOCENTRY              NO INDEX FOUND EXIT      S99228 70160022
         BR    RD                       RETURN                   S99228 70161022
LOCENTRY EQU   *                                                 S99228 70162022
         LA    RB,TWO(R0,RB)            ADJUST TO 1ST INDEX      S99228 70163022
         CLC   ZERO(TWO,RB),LCBTTCIN    INDEX =CUR CON INDEX?    S99228 70164022
         BNE   LOOPER                   NO, CHECK NEXT INDEX     S99228 70165022
         LR    RB,RC                    SAVE TNT INDEX INDEX     S99228 70166022
         SR    RC,RC                    CLEAR WORK REGISTER      S99228 70167022
         IC    RC,ONE(R0,RE)            INSERT ACTIVE ENTRIES    S99228 70168022
         SR    RA,RA                    CLEAR WORK REGISTER      S99228 70169022
         IC    RA,TWO(R0,RE)            INSERT INVLIST ENTRY LEN S99228 70170022
         BCTR  RA,R0                    SET LENGTH -INDEX        S99228 70171022
         LR    R0,RE                    SAVE INVLIST CWORD ADDR  S99228 70172022
         LA    RE,EIGHT(R0,RE)          SKIP TO 1ST ENTRY        S99228 70173022
         SR    RWKA,RWKA                CLEAR WORD REGISTER      S99228 70174022
         LTR   RC,RC .                  ANY ACTIVE ENTRIES      SA65374 70174352
         BZ    ROUNDER1 .               BRANCH IF YES           SA65374 70174652
ROUNDER  EQU   *                                                 S99228 70175022
         IC    RWKA,ZERO(RA,RE)         INSERT ENTRY INDEX       S99228 70176022
         CR    RWKA,RB                  INDEX = DEVELOPED INDEX? S99228 70177022
         BE    SETENTRY                 YES, INV CHARS LOCATED   S99228 70178022
         LA    RE,ONE(RA,RE)            SKIP TO NEXT ENTRY       S99228 70179022
         BCT   RC,ROUNDER               CHECK ENTRY INDEX        S99228 70180022
ROUNDER1 EQU   * .                                              SA65374 70180552
         LA    RE,TWO(R0,RE)            SKIP EOT AND FE          S99228 70181022
         LR    RWKA,RE                  SAVE CURRENT ENTRY ADDR  S99228 70182022
         LR    RE,R0                    RELOAD INVLIST CWORD ADD S99228 70183022
         IC    RC,ZERO(R0,RE)           INSERT TOTAL ENTRIES     S99228 70184022
         IC    RA,ONE(R0,RE)            INSERT ACTIVE ENTRIES    S99228 70185022
         SR    RC,RA                    CALC INACTIVE ENTRIES    S99228 70186022
         IC    RA,TWO(R0,RE)            RESTORE ENTRY LENGTH     S99228 70187022
         BCTR  RA,R0                    SET LENGTH - INDEX       S99228 70188022
         LR    RE,RWKA                  RESTORE ENTRY ADDR       S99228 70189022
         SR    RWKA,RWKA                CLEAR WORK REGISTER      S99228 70190022
         B     ROUNDER                  CHECK INACTIVE ENTRIES   S99228 70191022
SETENTRY EQU   *                                                 S99228 70192022
         LR    RC,RE                    SAVE INVLIST CWORD ADDR  S99228 70194022
         L     RE,AVTDOUBX              LOAD LCB EXTENSION ADDR  S99228 70194722
         ST    RC,LCBXRADR              SET ERP POLL ADDR        S99228 70195491
         OI    LCBXFLAG,LCBERPND        SET SOR PENDING          S99228 70195591
         BR    RD                       RETURN                   S99228 70195691
         EJECT                                                          70195791
.LL4A    ANOP                                                           70195891
         AIF   ('&GEN' EQ 'MINI').LL4A1                        @OZ16540 70195991
POLLCK   EQU   *                                                        70196091
         USING *,RF                                            @OZ16540 70196191
         SR    RE,RE                    CLEAR WORK REGISTER    @OZ16540 70196291
         L     RD,LCBCPA+48             LOAD SECOND POLL CCW   @OZ16540 70196391
         LR    RA,RD                    SAVE FIRST ENTRY       @OZ16540 70196491
         SH    RD,H8                    BACK UP TO CWORD       @OZ16540 70196591
         IC    RE,2(,RD)                INSERT ENTRY WIDTH     @OZ16540 70196691
         CLI   0(RCCW),CCWPOLL          INTERRUPT ON POLL      @OZ16540 70196791
         BNE   TMODE                    BRANCH TEXT MODE       @OZ16540 70196891
         LR    RB,RE                    SAVE ENTRY WIDTH       @OZ16540 70196991
         LH    RC,CCWCOUNT              LOAD ORIGINAL COUNT    @OZ16540 70197091
         SH    RC,LCBCSW+5              SUBTRACT RESIDUAL      @OZ16540 70197191
         BNP   ENTRY                    BRANCH FIRST ENTRY     @OZ16540 70197291
         SR    RB,RB                    CLEAR DIVIDE REGISTER  @OZ16540 70197391
         DR    RB,RE                    CALCULATE              @OZ16540 70197491
         MR    RB,RE                    ENTRY INDEX            @OZ16540 70197591
         LTR   RB,RC                    MOVE COUNT             @OZ16540 70197691
         BNZ   ENTRY                    BRANCH VALUE           @OZ16540 70197791
         LR    RB,RE                    USE ENTRY LENGTH       @OZ16540 70197891
ENTRY    EQU   *                                               @OZ16540 70197991
         L     RA,CCWADDR-1             LOAD POLL ADDRESS      @OZ16540 70198091
         LA    RA,0(RB,RA)              POINT TO               @OZ16540 70198191
         BCTR  RA,0                     INDEX BYTE             @OZ16540 70198291
         B     SRCEFIND                 LOCATE TERMINAL        @OZ16540 70198391
TMODE    EQU   *                                               @OZ16540 70198491
         L     RC,LCBCPA+64             LOAD READ RESPONSE     @OZ16540 70198591
         SR    RB,RB                    CLEAR INDEX REGISTER   @OZ16540 70198691
         STH   RB,LCBTTCIN              ZERO CONNECTED INDEX   @OZ16540 70198791
         BCTR  RA,0                     REDUCE FOR LOOP        @OZ16540 70198891
POLLOOP  EQU   *                                               @OZ16540 70198991
         AR    RA,RE                    MOVE TO FIRST INDEX    @OZ16540 70199091
         CLC   0(1,RA),0(RC)            INDEX FOUND            @OZ16540 70199191
         BE    SRCEFIND                 BRANCH YES             @OZ16540 70199291
         CLI   1(RA),FE                 END                    @OZ16540 70199391
         BER   R14                      OF                     @OZ16540 70199491
         CLI   2(RA),FE                 LIST                   @OZ16540 70199591
         BNE   POLLOOP                  BRANCH NO              @OZ16540 70199691
         BR    R14                      YES, EXIT              @OZ16540 70199791
SRCEFIND EQU  *                                                @OZ16540 70199891
         IC    RB,0(,RA)                INSERT INDEX           @OZ16540 70199991
         AR    RB,RB                    LOCATE                 @OZ16540 70200091
         SR    RD,RB                    OFFSET                 @OZ16540 70200191
         LH    RC,0(,RD)                LOAD TNT OFFSET        @OZ16540 70200291
         STH   RC,LCBTTCIN              SET CONNECTED INDEX    @OZ16540 70200391
         L     RA,AVTRNMPT              LOAD ADDRESS TNT CODE  @OZ16540 70200491
         USING IEDQTNTD,RA                                     @OZ16540 70200591
         BAL   RPREFIX,TNTDCODE         LOCATE TERMINAL ENTRY  @OZ16540 70200691
         USING IEDQTRM,RB                                      @OZ16540 70200791
         L     RB,TRMDESTQ-1            LOAD TTE ADDRESS       @OZ16540 70200891
         DROP  RB                                              @OZ16540 70200991
         USING IEDQQCB,RB                                      @OZ16540 70201091
         SR    RA,RA                    CLEAR WORK REGISTER    @OZ16540 70201191
         IC    RA,QCBSCBOF              INSERT SCB INDEX       @OZ16540 70201291
         IC    RE,AVTSCBSZ              AND SCB SIZE           @OZ16540 70201391
         MR    RA-1,RE                  GET SCB OFFSET         @OZ16540 70201491
         AL    RA,LCBSCBDA-1            AND SCB ADDRESS        @OZ16540 70201591
         STCM  RA,7,LCBSCBA             STORE SCB ADDRESS      @OZ16540 70201691
         BR    R14                                             @0Z16540 70201791
         DROP  RA                                              @OZ16540 70201891
         DROP  RB                                              @OZ16540 70201991
.LL4A1   ANOP                                                  @OZ16540 70202091
         EJECT                                                          70202191
*        CONSTANTS                                                      70202291
H8S      DC    H'8'                     CONSTANT OF X'08'        X02004 70202505
ESOHCH   EQU   26 .                                              S22026 70203022
CEPTR    EQU   12                       ADDRESS OF CHANNEL       X02004 70203105
*                                       END APPENDAGE IN DEB     X02004 70203205
*                                       VECTOR TABLE             X02004 70203305
SIOPTR   EQU   4                        ADDRESS OF SIO IN ABOVE  X02004 70203405
INTENTRY EQU   4                        SECOND ENTRY TO IGG019QE X02004 70203505
*                                       FOR ADDRESS TRANSLATION  X02004 70203605
CBRDCAST EQU   X'40' .                                           S22026 70204022
CC1      EQU   X'10'                    SIO COND CODE MASK       Y02027 70204506
CC3      EQU   X'30'                    SIO COND CODE MASK              70205022
PERMERR  EQU   X'41'                    MASK FOR PERM ERROR(BY ERP)     70206022
ZERO     EQU   0                                                        70207022
ONE      EQU   1                                                        70208022
TWO      EQU   2                                                        70209022
THREE    EQU   3                                                        70210022
FE       EQU   X'FE'                    END OF INV LIST                 70211022
FOUR     EQU   4                                                        70212022
FIVE     EQU   5                                                 S99228 70213022
SIX      EQU   6                                                 S99228 70214022
ONESIX   EQU   16                                                S99228 70215022
RSOHCH   EQU   29                       OFFSET SOH%R SEQUENCE    S99228 70215522
EIGHT    EQU   8                                                        70216022
CEDE     EQU   X'0C'                    STATUS=CHAN END, DEVICE END TSO 70220020
UNEX     EQU   X'01'                    UNIT EXCEPTION                  70240020
CSWPC    EQU   X'20'                    CHANNEL PROGRAM CHECK   SA65374 70250005
CVTLOC   EQU   X'10'                    CVT PTR LOCATION                70260020
NAK      EQU   X'80'                    REQUEST FOR NAK.         X01004 70280005
ACKI     EQU   X'40'                    REQUEST FOR ACK-I.       X01004 70300005
EOMSG    EQU   X'80'                    TEMPORARY END OF MSG            70340020
DLEEOTCH EQU   16                       OFFSET TO SEQUENCE              70360020
EOTCH    EQU   0                        OFFSET TO SEQUENCE IN SCT       70460020
STXCH    EQU   1                         OFSET TO SEQUENCE IN SCT       70480020
ACK0CH   EQU   4                        INDEX N TO SCT                  70500020
NAKCH    EQU   6                        INDEX TO SEQUENCE               70520020
TOTESOH  EQU   27                       SOH % / FOR TOTE         S21903 70540022
CSOHCH   EQU   28                       INDEX TO SOH % C         S99238 70550022
ENQCH    EQU   7                        OFFSET TO SEQUENCE IN SCT       70560020
ETBCH    EQU   8                         OFSET TO SEQUENCE IN SCT       70580020
ETXCH    EQU   9                        OFFSET TO DEQUENCE IN SCT       70600020
DLESTXCH EQU   10                       OFFSET TO SEQUENCE IN SCT       70620020
BUFF     EQU   X'1A'                    LCBRSKEY FOR BUFFERED LCB       70660020
STXENQCH EQU   11                       OFFSET TO SEQUENCE IN SCT       70700020
SOHCH    EQU   13                       OFFSET TO SEQUENCE              70740020
WACKCH   EQU   14                       INDEX TO SEQUENCE IN SCT        70760020
RVICH    EQU   15                       INDEX TO SEQUENCE IN SCT        70780020
IN       EQU   X'80'                    MASK FOR LCIN                   70840020
X2F      EQU   X'2F'                   MASK ERRORS PGM CHK+CAT ERRS     70860020
IDRETRY  EQU   6                        RETRY COUNT BSC READ ID         70880020
X20      EQU   X'20'                   BIT-LCBFLAG1-ERP IN CONTROL      70900020
CMDREJ   EQU   X'80'                    COMMAND REJECT IN SENSE         70920020
X24      EQU   X'24'                    MASK FOR ERROR FLAGS            70940020
XF2      EQU   X'F2'                    MASK FOR ERRORS-AATN,STMOD,     70960020
*                                        CTL UNT END,BUSY,UNTCHCK       70980020
CVTOPT01 EQU   X'98'                    OFFSET ADDRESS IN CVT -POST     71000020
COMPLETE EQU   X'40'                    MASK FOR ECB COMPLETE           71020020
ACTIVE   EQU   1                        ILIST OFFSET-#ACTIVE ENTRIES    71040020
LOGICAL  EQU   X'04'                    LOGICAL EXIT AT MH              71060020
CONV     EQU   X'10'                    CONVERSE REQUEST AT MH          71080020
MHBT     EQU   X'08'                    BT PRESENT IN MH QCB     X01004 71081005
LCIN     EQU   X'80' .                  LINE CONTROL IN FLAG     X01004 71082005
CCONTIN  EQU   4 .                      CONTINUE CAPABILITY FLAG X01004 71083005
CBISYNC  EQU   X'80' .                  BISYNC DEVICE FLAG       X01004 71084005
CCHECK   EQU   X'10' .                  CHECKING CAPABILITY FLAG X01004 71085005
CCONTENT EQU   X'04'                    CONTENTION DEVICE      @XA08073 71085391
MASTER   EQU   X'20'                    MASTER/SLAVE STATUS    @XA08073 71085691
SEVEN    EQU   7 .                                               X01004 71086005
NINE     EQU   9 .                                               X01004 71087005
EOL      EQU   X'FE' .                  END OF LIST INDICATOR    X01004 71088005
THIRTN   EQU   13 .                                              X01004 71089005
AD       EQU   7 .                      MASK FOR ICM OF ADDRESS  X01004 71090005
FOUR095  EQU   4095 .                   OFFSET FOR SECOND BASE   X01004 71091005
TWLVE    EQU   12 .                                              X01004 71092005
SIXTN    EQU   16 .                                              X01004 71093005
ALL      EQU   15 .                     MASK TO ICM FOUR BYTES   X01004 71094005
CCZRO    EQU   8                        ZERO CONDITION CODE      X02004 71095005
LISTSIZE EQU   8                        SIZE OF ILIST CONTROL FIELDS    71100020
FF       EQU   X'FF'                    MASK FOR TEST AND SET           71120020
CEDEUC   EQU   X'0E'                    CH END, DEV END, UNIT CHECK     71140020
IOBEXEP  EQU   X'04'                    FLAG TO GET TO ERP              71160020
TIMEOUT  EQU   X'01'                    TIME OUT VALUE IN SENSE         71180020
IR       EQU   X'40'                    INTERVENTION REQ.           TSO 71200020
CIRCC    EQU   X'1F'                                                TSO 71220020
CIRCD    EQU   X'16'                                                TSO 71240020
X80      EQU   X'80'                    MASK FOR TS SWITCH              71280020
X48      EQU   X'48'                   COMP CODE IN ECB FOR HIO         71300020
X01      EQU   X'01'                    TP OP CODE MASK                 71320020
X12      EQU   X'12'                    TP CODE FOR BREAK           TSO 71340020
RACK0    EQU   X'81'                    INDICATOES RESPONSE RCVD        71360020
RACK1    EQU   X'41'                    INDICATOES RESPONSE RCVD        71380020
LMD      EQU   X'03' .                  LMD FLAGS ON STARTMH     S22025 71390022
RWACK    EQU   X'20'                    INDICATOES RESPONSE RCVD        71400020
RTTD     EQU   X'10'                    INDICATOES RESPONSE RCVD        71420020
REOT     EQU   X'08'                    INDICATOES RESPONSE RCVD        71440020
RRVI     EQU   X'04'                    INDICATOES RESPONSE RCVD        71460020
RNAK     EQU   X'02'                    INDIACTES RESPONSE RCVD         71480020
RENQ     EQU   X'0C'                    MASK FOR RESPOSNE RECEIVED      71500020
XF0      EQU   X'F0'                    SWITCH FOR 2260L AND LOCAL      71520020
*                                         SCHEDULER                     71540020
UNITCHK  EQU   X'0E'                    SET ENDING STATUS               71560020
DATCK    EQU   X'08'                    DATACHECK MASK                  71580020
RDLEEOT  EQU   X'10'                    MASK FOR RESPONSE RECEIVED      71600020
DATCHK   EQU   X'08'                    DATA CHECK MASK                 71620020
SENDPRI  EQU   X'20' .                  SEND PRIORITY MASK FOR LCS21101 71660020
MPT      EQU   X'10'                    MULTIPT CHARCTERISTIC           71680020
DUMMY    EQU   X'DF'                    DUMMY ILIST ENTRY               71700020
RETRY    EQU   6                        BSC RETRY COUNT                 71720020
ENDCTL   EQU   X'20'                    DEVICE CHARACTERISTIC           71740020
PCIOPT   EQU   X'FF'                    PARAMETER NOT TO POST BUFFERS   71780020
RCVPCI   EQU   X'20'                    MASK FOR PCI ON RECEIVE         71800020
SNDPCI   EQU   X'10'                    MASK FOR PCI ONSNDING           71820020
PCIFLAG  EQU   X'80'                    PCI STATUS IN CSW               71840020
DISDLEOT EQU   X'01'                    FLAG TO WRITE DLE EOT           71860020
NOPCI    EQU   X'00'                    PARAMETER                       71880020
LOCKED   EQU   X'80'                    LOCK OUT MASK FOR BUFFER COUNT  71900020
DBLRVI   EQU   X'01'                    SWITCH FOR DOUBLE RVI I5        71920020
*                                       RESPONSE TO TEXT                71940022
*                                         MODE                          71942022
STAT1    EQU   X'0A'                    DB, US, DE MASK          S99228 71942422
STAT2    EQU   X'2E'                    CR,EC,DC,CC MASK       @OY20488 71942886
ASTAT3   EQU   X'26'                    IR                     @OY20488 71942986
SS0      EQU   6                        SENSE 0 OFFSET           S99228 71943222
SS1      EQU   7                        SENSE 1 OFFSET           S99228 71943622
PCIRCV   EQU   X'22'                    RECEIVE PCI MASK         S99228 71944022
ASCIEOT  EQU   X'04'                    ASCII EOT              @OZ29663 71946086
ASTAT1   EQU   X'18'                    ASCII DB, DE MASK      @OZ29663 71948086
ASTAT2   EQU   X'1E'                    ASCII CR,IR,ER,DC,CC   @OZ29663 71950086
ASCIDE   EQU   X'42'                    ASCII DEVICE END ONLY  @OZ29663 71952086
AUTOPL   EQU   X'01'                    INVLIST CWORD AUTOPL IND S99228 71954022
CLOCAL   EQU   X'02'                                             S99228 71956022
CREMOTE  EQU   X'80'                    BSC DEVICE              SA59028 71957022
C3270    EQU   X'04'                    3270 DEVICE              S99228 71958022
CNOIDLES EQU   X'02'                    NO IDLES DEFINED         S99228 71959022
CUMASK   EQU   X'01'                    GENERAL POLL CONTROL UNITS99228 71960022
LCL3277  EQU   X'09'                    LOCAL 3277 MODEL CODE    S99228 71960222
REG7     EQU   28                       OFFSET TO REGISTER 7     S99228 71960622
TTY1     EQU   X'10' .                 UCBTYPE+0                SA48278 71961022
TTY2     EQU   X'51' .                 UCBTYPE+0 FLAGS          SA48278 71962022
TTY3     EQU   X'50' .                 UCBTYPE+3 FLAGS          SA48278 71963022
TTY4     EQU   X'13' .                 UCBTYPE+3                SA48278 71964022
TTY5     EQU   X'A0' .                 UCBTYPE+3 FLAGS          SA48278 71965022
L22601   EQU   X'12' .                 UCBTYPE+2                SA51061 71966022
L2260    EQU   X'10'                   UCBTYPE+2 FLAG           SA51061 71967022
ATTN     EQU   X'20' .                  ATTENTION  ALLOWED FLAG  S22025 71970022
TICEND   EQU   11                       LOW ORDER BYTE TIC ADDR  S99228 71973022
X7F      EQU   X'7F'                    OK CHANNEL PROG COMP CD  S22025 71975022
UCBOFFST EQU   28                       OFFSET TO UCB REG IN SAVEX02004 72000005
UNITYPE  EQU   19                       UNIT TYPE OF UCB        SA51090 72000122
LCLRSCH  EQU   X'1E'                    LOCAL RECIEVE SCHD KEY  SA57329 72009122
EBCDACK  EQU   X'76'                    EBCDIC ACK FOR S/S      SA62991 72012151
         CNOP  0,8                      ALIGN TO DOUBLE WORD     X02004 72013105
ASCIACK  EQU   X'06'                    ASCII  ACK FOR S/S      SA62991 72015151
THIRTY2  EQU   32                       OFFSET 32              @ZA02095 72016161
ELINEND  EQU   *                                                 X02004 72017105
         TPRIOR                                                         72020020
         TLCBD                                                          72040020
         TQCBD                                                      TSO 72060020
         TTRMD                                                          72080020
         TTSID                                                          72100020
         TCCWD                                                          72120020
         TSCBD                                                          72140020
         TAVTD                                                          72160020
         TPRFD                                                          72180020
         DCBD  DSORG=TX                                                 72200020
         TRECBD                                                         72220020
         TTNTD                                                          72240020
         TTPD                                                           72260020
         TTCBD                                                          72280020
         TDEBD                                                          72300020
         CVT   DSECT=YES                                                72320006
         EJECT                                                          75320006
         TTCXD                                                          78320006
         EJECT                                                          81320006
         IECDIOSB                                                       82320006
         MEND                                                           84320006
