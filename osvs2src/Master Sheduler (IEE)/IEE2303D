         TITLE 'IEE2303D - SMF VARY RECORD HANDLER'                     00100003
* TITLE        SMF VARY RECORD HANDLER                                * 00200002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 00300002
* MODULE NAME      = IEE2303D                                           00400002
*    CSECT NAME    = IEE2303D                                           00500002
*                                                                       00600002
* LOAD MODULE NAME = IEE3603D                                           00700002
*                                                                       00800002
* DESCRIPTIVE NAME = SMF-VARY ONLINE AND CONSOLE RECORD HANDLER         00900002
*                                                                       01000002
* COPYRIGHT        = MISSING                                            01100002
*                                                                       01200002
* STATUS           = OS/VS/2 RELEASE 3                         @Z30LPTJ 01300003
*                                                                       01400002
* FUNCTION         = WRITE AN SMF RECORD FOR DEVICES VARIED TO THE      01500002
*                    ONLINE OR CONSOLE STATUS.                          01600002
*                                                                       01700002
* OPERATION        = ALL DEVICES SPECIFIED IN THE VARY COMMAND          01800002
*                    ARE CHECKED FOR VALIDITY.  THEN, IF AT LEAST       01900002
*                    ONE DEVICE IS VALID, A VARY RECORD, TYPE 9         02000002
*                    IS WRITTEN TO SYS1.MAN DATA SET.                   02100002
*                    AN SMF VARY IS FORMATTED THUSLY,                   02200002
*                       LL0009TTTTDDDDCCCCXXKYUU......KYHU              02300002
*                                           *            *              02400002
*                                           ** VARIABLE  *              02500002
*                       LL   -TWO BYTE LENGTH OF RECORD                 02600002
*                       9    -ONE BYTE RECORD TYPE                      02700002
*                       TTTT -FOUR BYTE TIME OF DAY (BINARY)            02800002
*                       DDDD -FOUR BYTE DAY OF YEAR (BINARY)            02900002
*                       CCC  -FOUR BYTE CPU ID                          03000002
*                       XX   -TWO BYTE LENGTH OF VARIABLE DATA FIELD    03100002
*                       KYHU -VARIABLE DATA FIELDS. THERE ARE AS        03200002
*                             MANY OF THESE FIELDS AS THERE ARE         03300002
*                             VALID DEVICES IN THE VARY COMMAND.        03400002
*                             K   -ONE BYTE DEVICE CHARACTERISTICS      03500002
*                             Y   -ONE BYTE UNIT TYPE                   03600002
*                             H   -ONE BYTE                             03700002
*                                      BITS 0-3, UNUSED                 03800002
*                                      BITS 4-7, CHANNEL ADDRESS        03900002
*                             U   -ONE BYTE UNIT ADDRESS                04000002
*                    THE LOGIC FLOW IS AS FOLLOWS:                      04100002
*                    ON ENTRY FROM IEE3303D, A 168 BYTE AREA   @ZA03202 04200003
*                    IS GOTTEN FOR THE SMF RECORD.  (THIS      @ZA03202 04250003
*                    NUMBER WAS CHOSEN ARBITRARILY.  THE LOGIC @ZA03202 04300003
*                    RECOGNIZES THIS AS SOON AS THIS AREA IS   @ZA03202 04350003
*                    FULL AND FIRST WRITES OUT THE SMF RECORD  @ZA03202 04400003
*                    AND REINITIALIZES THE AREA).              @ZA03202 04450003
*                                                                       04700002
*                    FIRST 20 BYTES ARE INITIALIZED AS FOLLOWS:         04800002
*                       'LL' FIELD IS INITIALIZED TO '20'               04900002
*                       'XX' FIELD IS INITIALIZED TO '00'               05000002
*                                                                       05100002
*                    THE PTR TO THE COMMAND IMAGE IS OBTAINED           05200002
*                    IN REG9                                            05300002
*                                                                       05400002
*                    IN CASE OF AN I-UNIT SPECIFICATION, FOLLOWING      05500002
*                    CHECKS ARE MADE:                                   05600002
*                       . CHARACTERS ',O-' SHOULD BE THERE WITH  THE    05700002
*                            I-UNIT SPECIFICATION.                      05800002
*                       . RIGHT PARENS IMMEDIATLY AFTER 'O-UNIT'        05900002
*                            SPECIFICATION SHOULD BE FOUND.             06000002
*                       . UCME SHOULD BE AVAILABLE FOR THE I-UNIT.      06100002
*                       . THIS UCME SHOULD HAVE INPUT CAPABILITY        06200002
*                            (UCMIF SHOULD BE 'ON')                     06300002
*                       . DEVICE AS POINTED TO BY THIS UCME SHOULD      06400002
*                            NOT BE ONLINE                              06500002
*                       . DEVICE AS POINTED TO BY THIS UCME SHOULE      06600002
*                            NOT BE UNDER TEST BY OLTEP.                06700002
*                       . THIS UCME SHOULD POINT TO A COMPOSITE         06800002
*                            CONSOLE UCME.                              06900002
*                       . THE 'UCBNAME' IN THE UCB AS POINTED TO BY     07000002
*                            THIS COMPOSITE CONSOLE UCME SHOULD BE      07100002
*                            SAME AS IN THE 'O-UNIT' SPECIFICATION.     07200002
*                    NOTE: IF ANY OF THE ABOVE CONDITIONS IS NOT MET,   07300002
*                            THIS UNIT SPECIFICATION IS IGNORED         07400002
*                       . A CHECK IS MADE IF SPACE TO PUT TWO ENTRIES   07500002
*                            IN THE SMF RECORD EXIST.  IT NOT, THE      07600002
*                            CURRENT SMF RECORD IS WRITTEN BY ISSUING   07700002
*                            AN SVC 83 .                                07800002
*                       . ENTRIES ARE MADE IN THE RECORD                07900002
*                       . REG9 IS UPDATED TO POINT TO THE NEXT UNIT     08000002
*                            SPECIFICATION.                             08100002
*                       . BRANCH IS TAKEN TO PROCESS                    08200002
*                            EITHER THE NEXT UNIT SPECIFICATION OR TO   08300002
*                            DETERMINE IF IT IS THE END OF THE PROCESS. 08400002
*                                                                       08500002
*                    IN CASE OF O-UNIT SPECIFICATION, THE FOLLOWING     08600002
*                    CHECKS ARE MADE:                                   08700002
*                       . THERE SHOULD BE A UCME PERTAINING TO THE      08800002
*                            O-UNIT                                     08900002
*                       . THIS UCME SHOULD HAVE 'OUTPUT ONLY'           09000002
*                            CAPABILITIES  (SPECIFIED  BY               09100002
*                            UCMDISPD SHOULD BE 'ON')                   09200002
*                       . THE UNIT SHOULD NOT BE 'ONLINE'               09300002
*                       . THE UNIT SHOULD NO BE UNDER TEST              09400002
*                            BY OLTEP                                   09500002
*                       . SEE IF SPACE FOR ONE ENTRY EXISTS IN THE      09600002
*                            168 BYTE BUFFER, IF NOT WRITE THE @ZA03202 09700003
*                            RECORD FIRST (ISSUE SVC 83).      @ZA03202 09750003
*                       . PUT AN ENTRY IN THE RECORD                    09900002
*                       . UPDATE REG9 TO POINT TO THE NEXT UNIT         10000002
*                       . BRANCH IS TAKEN TO PROCESS                    10100002
*                            EITHER NEXT  UNIT SPECIFICATION OR         10200002
*                            TO DETERMINE IF IT IS THE END OF THE       10300002
*                            PROCESSING.                                10400002
*                                                                       10500002
*                    IF IT IS NEITHER (I-UNIT,O-UNIT) COMBINATION NOR   10600002
*                    THE O-UNIT SPECIFICATION, THEN CONTROL PASSES TO   10700002
*                    THIS POINT, WHERE WE DETERMINE IF THE UNIT         10800002
*                    SPECIFICATION IF CAPABLE OF BOTH INPUT AND OUTPUT  10900002
*                    THE FOLLOWING CHECKS ARE MADE:                     11000002
*                       . THERE SHOULD BE A UCME FOR THE UNIT SPECIFIED 11100002
*                    NOTE: IF THE ABOVE IS NOT TRUE, THE UNIT IS        11200002
*                       PROCESSED AS IF IT WAS AN I/O UNIT AND NOT AS   11300002
*                       A SYSGENED CONSOLE UNIT.                        11400002
*                       . THE UCME SHOULD INDICATE BOTH INPUT AND       11500002
*                            OUTPUT CAPABILITY OF THE UNIT (UCMIF AND   11600002
*                            UCMOF SHOULD BE 'ON')                      11700002
*                       . THE UNIT SPECIFIED SHOULD NOT BE 'ONLINE'     11800002
*                       . THE UNIT SPECIFIED SHOULD NOT BE UNDER        11900002
*                            TEST BY OLTEP                              12000002
*                    NOTE: IF EITHER OF THE ABOVE IS NOT TRUE, THE      12100002
*                       UNIT SPECIFIED IS IGNORED.                      12200002
*                       . SPACE IS CHECKED IN THE SMF RECORD BUFFER     12300002
*                            FOR PUTTING ONE ENTRY. IF NOT AVAILABLE    12400002
*                            THE RECORD IS WRITTEN FIRST                12500002
*                       . BRANCH TO PROCESS EITHER NEXT                 12600002
*                            UNIT OR TO DETERMINE IF IT IS THE END OF   12700002
*                            THE PROCESSING.                            12800002
*                                                                       12900002
*                    CONTROL IS RECEIVED AT THIS POINT WHEN THE UNIT    13000002
*                    SPECIFIED IS TO BE VARIED ONLINE ONLY AND ANY      13100002
*                    UNIT WITH THE 'VARY CONSOLE' KEYWORD AT THIS       13200002
*                    POINT OF CONTROL IS TO BE IGNORED.                 13300002
*                    FOLLOWING CHECKS ARE MADE:                         13400002
*                       . IF THE COMMAND IS 'VARY CONSOLE' THE UNIT     13500002
*                            IS IGNORED.                                13600002
*                       . IF IT IS A 'VARY ONLINE' THE UNIT WILL BE     13700002
*                            PROCESSED                                  13800002
*                       . THE PTR TO THE UCBLIST IS OBTAINED FROM THE   13900002
*                            CVT.                                       14000002
*                       . THE PTR TO THE MAIN UCB PERTAINING TO THE     14100002
*                            UNIT SPECIFICATION IS OBTAINED.            14200002
*                       . THE UCB IS CHECKED TO SEE IF THE UNIT IS      14300002
*                            ALREADY ONLINE                             14400002
*                       . IN CASE IT IS MARKED ALREADY ONLINE, THE      14500002
*                            UNIT IS IGNORED.                           14600002
*                       . IN CASE IT IS UNDER TEST BY OLTEP, THE        14700002
*                            UNIT IS IGNORED.                           14800002
*                       . OTHERWISE SPACE IS CHECKED IN THE SMF         14900002
*                            RECORD TO PUT AN ENTRY .                   15000002
*                       . IF SPACE IS NOT AVAILABLE, FIRST THE RECORD   15100002
*                            IS WRITTEN AND THEN ANY ENTRY IS MADE.     15200002
*                       . WHEN THE COMMAND IS COMPLETE, AN EXIT IS      15300002
*                            MADE TO  IEE4203D                          15400002
*                            OR       IEE4403D                          15500002
*                            DEPENDING ON THE SWITCHES SET BY           15600002
*                            IEE3303D IN THE XSWITCH BYTE OF THE XSA.   15700002
*                                                                       15800002
* NOTES                                                                 15900002
*    DEPENDENCIES  = NONE                                               16000002
*    CHARACTER/CODE DEPENDENCIES                                        16100002
*                  = THIS MODULE CAN BE ASSEMBLED WITH ANY NEW          16200002
*                    CHARACTER/CODE SET.                                16300002
*                                                                       16400002
* RESTRICTIONS     = REG2 PTR TO THE DUMMY XSA ON INPUT AND OUTPUT      16500002
*     REGISTER CONVENTIONS                                              16600002
*                  = REGISTERS ARE DEFINED AT LABEL: DEFREG             16700002
*    PATCH LABEL   = PATCH                                              16800002
*                                                                       16900002
* MODULE TYPE      = CSECT                                              17000002
*    PROCESSOR     = ASSEMBLER                                          17100002
*    MODULE SIZE   = VS/2 = '43A'                              @ZA03202 17200003
*    ATTRIBUTES    = REENTRANT, REUSABLE, REFRESHABLE,PAGED LPA,        17300002
*                    ZERO PSW PROTECT KEY                               17400002
*                                                                       17500002
* ENTRY POINTS     = IEE2303D FROM IEE3303D                             17600002
*    PURPOSE       = TO WRITE AN SMF RECORD FOR VALID DEVICES VARIED    17700002
*                    TO THE ONLINE OR CONSOLE STATES.                   17800002
*    LINKAGE       = BRANCH                                             17900002
*    INPUT         = REG2 PTS TO THE DUMMY XSA                          18000002
*                       XSWITCH BYTE OF XSA CONTAINS SWITCHES TELLING   18100002
*                       WHICH MODULE TO GO NEXT (4403D OR 4203D)        18200002
*                     REG13 PTS TO THE SAVE AREA GOTTEN IN 3603D        18300002
*                     WORD 17 OF THE SAVE AREA HAVE THE PTR TO THE CSCB 18400002
*    REGISTERS SAVED= ALL                                               18500002
*    REGISTER USAGE = R1  RECORD PTR                                    18600002
*                     R2 = DUMMY XSA PTR                                18700002
*                     R3  SMCA REG / OR CVT PTR, LATER = UCME PTR OF    18800002
*                        COMPOSITE OF 0 IF NONE THERE                   18900002
*                     R4  EOB PTR                                       19000002
*                     R5  UCME REG                                      19100002
*                     R8  UNIT REG                                      19200002
*                     R9  UNIT PTR                                      19300002
*                     R10 UCB PTR                                       19400002
*                     R11 UCB PTR OF COMPOSITE OR 0 IF NOT COMP.        19500002
*                     R13 SAVE AREA PTR STORED IN THIS MODULE IN THE    19600002
*                        IN THE XAA+2 OF THE DUMMY XSA. REG13 IS THEN   19700002
*                        USED AS THE PAREN SWITCH.                      19800002
*    REGISTERS RESTORED                                                 19900002
*                  = ALL                                                20000002
*                                                                       20100002
* EXITS - NORMAL   = TO IEE4203D OR IEE4403D DEPENDING ON THE           20200002
*                    SWITCHES SET BY IEE3303D IN XSWITCH BYTE           20300002
*                    OF THE XSA. (VIA BRANCH)                           20400002
*                    EXIT TO 4203D FOR VARY ONLINE/CONSOLE.             20500002
*                    EXIT TO 4403D FOR VARY CONSOLE WHEN THE CMD IS     20600002
*                    FOLLOWED BY THE CONSOLE CMD SUBPARAMETERS          20700002
*    CONDITIONS    = EXIT IS TAKEN WHEN THE FULL COMMAND HAS            20800002
*                    BEEN CHECKED AND SMF RECORDS HAVE BEEN             20900002
*                    WRITTEN FOR ALL ELIGIBLE DEVICES.                  21000002
*    OUTPUT        = REG2 PTS TO THE DUMMY XSA                          21100002
*                  = REG1 HAS XAD SWITCHES AS PRESET BY 3303D FOR       21200002
*                    4203D (SEE PROLOGUE OF IEE3303D AND 4203D)         21300002
*                    REG13 PTS TO THE SAVE AREA GOTTEN IN 3303D         21400002
*    RETURN CODES  = NONE                                               21500002
*                                                                       21600002
* EXITS - ERROR    = NONE                                               21700002
*                                                                       21800002
* EXTERNAL REFERENCES                                                   21900002
*    ROUTINES      = IEE4203D                                           22000002
*                    IEE4403D                                           22100002
*    DATA AREAS    = SEE EXITS - OUTPUT DATA                            22200002
*                                                                       22300002
* CONTROL BLOCKS   = . DUMMY EXTENDED SAVE AREA (XSA)                   22400002
*                    . SYSTEM MANAGMENT FACILITIES CONTROL BLOCK (SMCA) 22500002
*                       FIELDS TESTED  - SMCAID                         22600002
*                       FIELDS UPDATED - NONE                           22700002
*                    . CVT                                              22800002
*                       FIELDS TESTED  - CVTCUCB                        22900002
*                                        CVTILK2                        23000002
*                                        CVTSMCA                        23100002
*                       FIELDS UPDATED - NONE                           23200002
*                    . UNIT CONTROL MODULE (UCM)                        23300002
*                       FIELDS TESTED  -                                23400002
*                       FIELDS UPDATED = NONE                           23500002
*                    . UNIT CONTROL BLOCK (UCB)                         23600002
*                       FIELDS TESTED  = UCBCHA                         23700002
*                                        UCBFL5-BIT= UCBNALOC           23800002
*                                        UCBNAME                        23900002
*                                        SRTESTAT-BIT= SRTEONLI         24000002
*                                        UCBTBYT3                       24100002
*                       FIELDS UPDATED = NONE                           24200002
*                                                                       24300002
* TABLES           = 168 BYTES GOTTEN FOR SMF RECORD           @ZA03202 24400003
*                                                                       24500002
* MACROS           = GETMAIN, FREEMAIN, SVC 83(SMFRECORD WTR),SVC 11    24600002
*                                                                       24700002
* MAPPING MACROS   = IEEXSA                                             24800002
*                    CVT                                                24900002
*                    IEECUCM                                            25000002
*                    IEFUCBOB                                           25100002
*                    IEESMCA                                            25200002
*    SERIALIZATION = THE MODULE EXECUTES UNDER ENQ FOR PROTECTION       25300002
*                    AGAINST ANOTHER VARY/UNLOAD,ALLOCATION AND         25400002
*                    OLTEP.                                             25500002
*                    THIS ENQ WAS ISSUED EARLIER IN IEE3603D AND A      25600002
*                    DEQ WILL NOT BE ISSUED HERE SINCE THERE ARE        25700002
*                    NO TERMINAL CONDITION EXITS FROM THIS MODULE.      25800002
*                    NO PROTECTION IS REQUIRED AGAINST COMM TASK        25900002
*                    AND THEREFORE NO LOCKS WILL BE GOTTEN IN THIS      26000002
*                    ROUTINE                                            26100002
*                                                                       26200002
* CHANGE LEVEL     = Y02669, Z30LPTJ, ZA03202                  @ZA03202 26300003
*                                                                       26400002
* CHANGE ACTIVITY  = N/A                                                26500002
*                                                                       26600002
* MESSAGES         = NONE                                               26700002
*                                                                       26800002
* ABEND CODES      = NONE                                               26900002
*                                                                       27000002
* PACKAGING        = IEE2303D WILL BE PART OF LOAD MODULE               27100002
*                       = IEE3603D                                      27200002
*                    THIS LOAD MODULE ALIASES ARE                       27300002
*                       = NONE                                          27400002
*                    THIS LOAD MODULE ENTRY POINTS ARE                  27500002
*                       = IEE3603D                                      27600002
*                    MODULE WILL RESIDE IN: LPALIB                      27700002
*                                                                       27800002
* SYSGEN           = SUPPLIED BY SECTIONS                               27900002
*                       LOAD MODULE NAME                                28000002
*                       PACKAGING                                       28100002
*                    THIS CSECT WILL BE INCLUDED AT SYSGEN FROM         28200002
*                    DLIB -AOSB3- BY MACRO -SGIEF441-                   28300002
*                                                                       28400002
* SYSTEM LIBRARIES = NONE                                               28500002
*                                                                       28600002
*********************************************************************** 28700002
         EJECT                                                          28800002
IEE2303D CSECT                                                          28850002
* C 343000,768000                                              @YM07237 28855002
* ENTRY (A)                                                    @ZA03202 28857003
 SPACE 3                                                                28860002
TWENTY   EQU   20                                                       28900002
ONESIXTY EQU   160                                                      29000002
ONESXTY5 EQU   165                     CONSTANT OF 165         @ZA03202 29030003
ONESXTY8 EQU   168                     CONSTANT OF 168         @ZA03202 29060003
ONEFORTY EQU   140                                               Y02669 29100002
RECTYP   EQU   5                       OFFSET FOR REC. TYPE             29200002
SMFON    EQU   9                       SMF RECORD TYPE                  29300002
VARLNTH  EQU   18                      OFFSET FOR VARIABLE LNTH SLOT    29500002
*                                                                       29600002
* R E G I S T E R   U S A G E                                           29700002
*                                                                       29800002
DEFREG   EQU   *                                                 Y02669 29900002
R0       EQU   0                                                        30000002
R1       EQU   1                       PTR TO START OF SMF RECORD       30100002
R2       EQU   2                       XSA PTR                          30200002
R3       EQU   3                       UCME OF COMPOSITE OF 0 IF NONE   30300002
R4       EQU   4                       EOB PTR                          30400002
R5       EQU   5             WORKING REG(INITIALISING HEADER RECORD),   30500002
*                            UCME PTR(DURING UCME SEARCH)               30600002
R6       EQU   6                                                        30700002
R7       EQU   7                                                        30800002
R8       EQU   8                       TEMP UNIT PTR                    30900002
R9       EQU   9                       UNIT PTR                         31000002
R10      EQU   10                      UCB PTR                          31100002
R11      EQU   11                      UCB PTR OF COMP. OR 0 IF NONE    31200002
R12      EQU   12                      MODULE BASE REG                  31300002
R13      EQU   13                      SAVE AREA PTR ON INPUT           31400002
*                        SAVE AREA PTR IS STORED IN XAD AND REG  Y02669 31500002
*                        USED AS NUMBER OF PARENS SWITCH         Y02669 31600002
R14      EQU   14                      VARIABLE DATA FIELD REG          31700002
R15      EQU   15                                                       31800002
DEC0     EQU   0                                                        31900002
DEC1     EQU   1                                                        32000002
DEC2     EQU   2                                                        32100002
DEC3     EQU   3                                                        32200002
DEC4     EQU   4                                                        32300002
DEC5     EQU   5                                                        32400002
DEC6     EQU   6                                                        32500002
DEC8     EQU   8                                                        32600002
DEC9     EQU   9                                                        32700002
DEC12    EQU   12                                                 M2935 32800002
DEC13    EQU   13                                                       32900002
DEC20    EQU   20                                                       33000002
*                                                                       33200002
LPAREN   EQU   C'('                                                     33300002
COMMA    EQU   C','                                                     33400002
RPAREN   EQU   C')'                                                     33500002
COMP     EQU   X'80'                                                    33600002
OUNITBT  EQU   X'40'                                                    33700002
XZERO    EQU   X'00'                                                    33800002
REGUNT   EQU   X'20'                                                    33900002
NRECI    EQU   X'08'                                                    34000002
NRECO    EQU   X'04'                                                    34100002
HEX0F    EQU   X'0F'                                           @YM07237 34300002
VUNIT    EQU   X'80'                   HIGH ORDER BIT MASK     @Z30LPTJ 34350003
XC1      EQU   X'C1'                   COMPRAND FOR 'A'        @ZA03202 34360003
XC6      EQU   X'C6'                   COMPRAND FOR 'F'        @ZA03202 34370003
*                                                                       34400002
         EJECT                                                          34500002
         BALR  R12,0                   ESTABLISH ADDRESSABILITY         34700002
         USING *,R12                                                    34800002
         MODID BR=YES                                            Y01886 34900002
         USING XSA,R2                                                   35000002
         STM   R0,R15,DEC0(R13)                                  Y02669 35100002
         ST    R13,XAK                 STORE SAVE AREA ADDRESS @Z30LPTJ 35200003
         L     R3,CVTPTR               OBTAIN CVTPTR TO SEE IF          35300002
         USING SETCVT,R3                                                35400002
         L     R3,CVTSMCA              CVTSMCA FIELD WILL BE ZEROS IF   35500002
         USING SMCABASE,R3                                              35600002
*                                                                       35700002
*                                                                       35800002
*                                                                       35900002
         LA    R0,ONESXTY8             OBTAIN 168 BYTE CORE    @ZA03202 36000003
*                                 FROM SUBPOOL 0 OF VARY'S REGIONY02669 36200002
         GETMAIN R,LV=(0)                                               36300002
         XC    DEC0(ONESXTY8,R1),DEC0(R1) CLEAR HEADER AREA    @ZA03202 36400003
         MVI   RECTYP(R1),SMFON        MOVE IN THE RECORD TYPE          36500002
         MVI   DEC1(R1),TWENTY         MOVE IN TOTAL LENTH '20'         36600002
*                                      THIS LENGTH WILL BE              36700002
*                                      UPDATED AS AND WHEN VAR.         36800002
*                                      DATA RECORDS ARE ADDED   )       36900002
         MVC   VARLNTH(DEC2,R1),TWOCON    MOVE IN '2' AS VAR LNTH       37800002
         USING UCBOB,R10                                                37900002
         L     R9,XAL                  OBTAIN PTR TO PARAMETER LIST     38000002
         DROP  R3                                                       38100002
         LA    R9,DEC0(R9)             OBTAIN PTR TO COMMAND            38200002
         L     R4,XAR                                                   38300002
         AR    R4,R9              COMPUTE END OF BUFFER INTO REG4Y02669 38400002
         LA    R14,DEC20(R1)           REG 14 POINTS TO THE BEGINNING   38500002
*                                      OF THE VARIABLE DATA FIELD)      38600002
         SR    R13,R13                 IT WILL CONTAIN THE NUMBR        38700002
*                                      OF LEFT PARENS                   38800002
         XC    XAP(DEC4),XAP       ZERO OUT SWITCH AREA                 38900002
*                                                                       39000002
         EJECT                                                          39100002
START    EQU   *                                                 Y02669 39200002
         CLC   DEC0(DEC3,R9),CON  IS IT THE CONSOLE KEYWORD      Y02669 39300002
         BE    SEXIT              YES, FINISHED                  Y02669 39400002
         CLC   DEC0(DEC3,R9),ONL  IS IT THE ONLINE KEYWORD       Y02669 39500002
         BE    SEXIT              YES, FINISHED                  Y02669 39600002
SPRNCK   EQU   *                                                 Y02669 39700002
         CLI   DEC0(R9),LPAREN    IS THERE AN EXTERIOR PAREN     Y02669 39800002
         BNE   SINGLE             NO SINGLE UNIT SPECIFIED       Y02669 39900002
         CLC   DEC0(DEC3,R9),PARENI    IS IT A COP  SPECIFICATIONY02669 40000002
         BE    SCOMP              YES, GO PROCESS A COMPOSITE UNIY02669 40100002
         AH    R13,HONE           SET EXTERIOR PAREN SWITCH      Y02669 40200002
         LA    R9,DEC1(R9)        UPDATE PAST THE PAREN          Y02669 40300002
         CR    R9,R4              IS IT END OF BUFFER            Y02669 40400002
         BE    SEXIT              YES, FINISHED                  Y02669 40500002
         B     SPRNCK             NO, CHECK MORE FOR A UNIT      Y02669 40600002
*                                                                Y02669 40700002
SINGLE   EQU   *                                                 Y02669 40800002
         CLC   DEC0(DEC2,R9),OUNIT     IS A SINGLE OUTPUT-ONLY UNY02669 40900002
         BE    SOUNIT             YES, GO PROCESS OUTPUT-ONLY UNIY02669 41000002
         CLI   DEC3(R9),COMMA     NO, IS IT A XXX, REGULAR UNIT  Y02669 41100002
         BE    REGUNIT            YES, GO PROCESS REGULAR UNIT   Y02669 41200002
         CLI   DEC3(R9),RPAREN    MAYBE IT IS A XXX)             Y02669 41300002
         BE    REGUNIT            YES, GO PROCESS REGULAR UNIT   Y02669 41400002
*                                                                Y02669 41500002
* NOTHING RECOGNIZABLE, SCAN TO MEAREST COMMA OF EOB             Y02669 41600002
*                                                                Y02669 41700002
ENDSCAN  EQU   *                                                 Y02669 41800002
         CLI   DEC0(R9),COMMA                                    Y02669 41900002
         BE    SOMEMORE           YES,MAYBE MORE UNITS PRESENT   Y02669 42000002
ENDSCAN2 EQU   *                                                 Y02669 42100002
         CR    R9,R4              IS IT END OF BUFFER            Y02669 42200002
         BE    SEXIT              YES, FINISHED                  Y02669 42300002
         LA    R9,DEC1(R9)        NO, UPDATE PTR BY ONE          Y02669 42400002
         CLI   DEC0(R9),COMMA     SCAN TO NEARES COMMA           Y02669 42500002
         BNE   ENDSCAN2           NO COMMA YET, KEEP CHECKING    Y02669 42600002
SOMEMORE EQU   *                                                 Y02669 42700002
         LA    R9,DEC1(R9)        UP BY ONE TO PT TO NEXT UNT    Y02669 42800002
         LTR   R13,R13            FOUND ',' MULTIPL UNTS?        Y02669 42900002
*                                 IF NO MULT UNITS WERE PRESENT  Y02669 43000002
*                                 THEN REACHING A COMMA WITHOUT  Y02669 43100002
*                                 UNIT IS AN ERROR               Y02669 43200002
         BZ    SEXIT              AND WERE ARE FINISHED          Y02669 43300002
*                                 WE DID HAVE MULT UNITS, THERE- Y02669 43400002
*                                 FORE THERE ARE MORE THAN ONE UNY02669 43500002
*                                 AND JUST THIS ONE IS IN ERROR. Y02669 43600002
         B     START              GO FIND A NEW UNIT TO PROCESS  Y02669 43700002
*                                                                Y02669 43800002
         EJECT                                                          43900002
SCOMP    EQU   *                                                 Y02669 44000002
*                                                                Y02669 44100002
*  PROCESSING A COMPOSITE UNIT    (I-XXX,O-XXX)                  Y02669 44200002
*                                                                Y02669 44300002
         CLC   DEC6(DEC3,R9),CMAO      IS IT (I-XXX,O-           Y02669 44400002
         BNE   ENDSCAN            NO ERROR IN COMPOSITE SPECIF   Y02669 44500002
         CLI   DEC12(R9),RPAREN   IS IT (I-XXX,O-XXX)            Y02669 44600002
         BNE   ENDSCAN            NO,ERROR IN COMPOSITE SPECIFI  Y02669 44700002
         OI    XAP+DEC0,COMP      SET 'COMPOSITE SWITCH'         Y02669 44800002
         LA    R8,DEC3(R9)        INDEX TO POINT TO INPUT UNTNME Y02669 44900002
         BAL   R15,SEARCH         GO GET UCME                    Y02669 45000002
         LTR   R5,R5              IF R5 (UCME PTR)IS 0 = NO UCME Y02669 45100002
         BNZ   GOTUCME            OK, WE HAVE AN INPUT UNIT UCME Y02669 45200002
BADCOMP  EQU   *                                                 Y02669 45300002
         LA    R9,DEC13(R9)       INDEX PAST UNIT                Y02669 45400002
         MVI   XAP+DEC0,XZERO     CLEAR 'COMPOSITE SWITHC'       Y02669 45500002
         B     ENDSCAN            GO FIND NEXT UNIT IS ANY       Y02669 45600002
         USING UCMLIST,R5                                        Y02669 45700002
GOTUCME  EQU   *                                                 Y02669 45800002
         TM    UCMATR,UCMIF       IS IT REALLY AN INPUT DEV.     Y02669 45900002
         BZ    BADCOMP            NO ERROR IN COMP. SPECIFIED    Y02669 46000002
         L     R3,UCMCOMPC        GET PTR TO UCME OF COMPOSITE   Y02669 46100002
         LTR   R3,R3              ANY COMPOSITE, SHOULD BE       Y02669 46200002
         BZ    BADCOMP            NO, ERROR IN COMP. SPECIFIED   Y02669 46300002
         DROP  R10                                               Y02669 46400002
         USING UCBOB,R11                                         Y02669 46500002
         DROP  R5                                                Y02669 46600002
         USING UCMLIST,R3                                        Y02669 46700002
         L     R11,UCMUCB         GET UCB PTR TO THE COMPOSITE   Y02669 46800002
         CLC   DEC9(DEC3,R9),UCBNAME   DO THE UNITNAMES MATCH    Y02669 46900002
         BNE   BADCOMP            NO, ERROR IN COMP SPECIFIED    Y02669 47000002
         DROP  R11                                               Y02669 47100002
         USING UCBOB,R10                                         Y02669 47200002
         DROP  R3                                                Y02669 47300002
         USING UCMLIST,R5                                        Y02669 47400002
*                                                                Y02669 47500002
*        R9 PTS TO THE BEGINNING OF UNIT OPERAND (I-XXX,O-XXX)   Y02669 47600002
*        R8 PTS TO THE INPUT UNITNAME                            Y02669 47700002
*        R10 HAS PTR TO INPUT UNIT UCB                           Y02669 47800002
*        R11 HAS PTR TO OUTPUT UNIT UCB                          Y02669 47900002
*        R5 HAS PTR TO INPUT UNIT UCME                           Y02669 48000002
*        R3 HAS PTR TO OUTPUT UNIT UCME                          Y02669 48100002
*                                                                Y02669 48200002
*  MUST CHECK VIA BOTH UCBS IF ANY OR BOTH DEVICES ARE ONLINE OR Y02669 48300002
*  UNDER TEST BY OLTEP.                                          Y02669 48400002
*  IF ANY OR BOTH ARE SO, ITS AN ERR AND NO RECD WILL BE PUT OUT Y02669 48500002
*                                                                Y02669 48600002
         BAL   R6,CHECKUCB        GO CHECK UCB'S                 Y02669 48700002
         LTR   R15,R15          IS INPT OFFL AND NOT UNDER OLTP  Y02669 48800002
         BNZ   CHECKERI           SOMETHING IS WRONG             Y02669 48900002
CHECKONT EQU   *                                                 Y02669 49000002
         BAL   R6,COMPUCB         I- IS OK, GO CHECK OUTPUT UNIT Y02669 49100002
         LTR   R15,R15          IS OUTPT OFFL AND NOT UNDER OLTP Y02669 49200002
         BNZ   CHECKERO           SOMETHING IS WRONG             Y02669 49300002
RECCOMP  EQU   *                                                 Y02669 49400002
         LA    R9,DEC13(R9)       UPDATE PAST COMP.              Y02669 49500002
         B     COMPSPAC          GO PUT RECORDS SINCE ALL IS OK  Y02669 49600002
*                                                                Y02669 49700002
CHECKERI EQU   *                                                 Y02669 49800002
         C     R15,EIGHT          IS I-UNIT ONLINE               Y02669 49900002
         BNE   BADCOMP            NO, IT IS UNDER TEST BY OLTEP  Y02669 50000002
*                                 MUST OMIT PUTTING RECORD FOR   Y02669 50100002
*                                 THE WHOLE COMPOSITE UNIT       Y02669 50200002
         OI    XAP+DEC0,NRECI     INPUT IS ONLINE, SET FLAG      Y02669 50300002
*                             NOT TO PRINT RECORD FOR INPUT BUT  Y02669 50400002
*                              CHECK OUTPUT SINCE IT MAY BE OFFL Y02669 50500002
         B     CHECKONT           GO CHECK OUTPUT                Y02669 50600002
*                                                                Y02669 50700002
CHECKERO EQU   *                                                 Y02669 50800002
         C     R15,EIGHT          IS O-UNIT ONLINE               Y02669 50900002
         BNE   BADCOMP            NO, IT IS UNDER TEST BY OLTEP  Y02669 51000002
*                                 MUST OMIT PUTTING RECORD FOR   Y02669 51100002
*                                 WHOLE COMPOSITE UNIT           Y02669 51200002
         OI    XAP+DEC0,NRECO     SET 'NOREC FOR OUPUT UNT SWTCH'Y02669 51300002
         B     RECCOMP            GO ISSUE RECORD FOR INPUT MAYBEY02669 51400002
*                                                                Y02669 51500002
         EJECT                                                          51600002
SOUNIT   EQU   *                                                 Y02669 51700002
*                                                                Y02669 51800002
*  PROCESSING OUTPUT ONLY UNIT  O-XXX                            Y02669 51900002
*                                                                Y02669 52000002
         OI    XAP+DEC0,OUNITBT   SET OUTPUT-ONLY SWITCH         Y02669 52100002
         LA    R8,DEC2(R9)        UPDATE TO UNIT NAME            Y02669 52200002
         BAL   R15,SEARCH         GO GET UCME                    Y02669 52300002
         LTR   R5,R5              IS THERE A UCME                Y02669 52400002
         BNZ   GOTUCME2           YEP                            Y02669 52500002
BADOUNT  EQU   *                                                 Y02669 52600002
         LA    R9,DEC5(R9)        NO UCME, ERROR UPDATE PAST UNITY02669 52700002
         MVI   XAP+DEC0,XZERO     CLEAR OUTPUT-ONLY SWITCH       Y02669 52800002
         B     ENDSCAN            GO GET NEW UNIT, IF ANY        Y02669 52900002
*                                                                Y02669 53000002
GOTUCME2 EQU   *                                                 Y02669 53100002
         TM    UCMDISP,UCMDISPD   IS IT REALLY AN OUTPUT-ONLY UNTY02669 53200002
         BZ    BADOUNT            NO, BAD OUTPUT-ONLY SPECIFIED  Y02669 53300002
         SR    R11,R11            NO UCB FOR COMPORITE           Y02669 53400002
         SR    R3,R3              NO UCME FOR COMPOSITE          Y02669 53500002
*                                                                Y02669 53600002
*        R9 PTS TO THE UNIT SPECIFICATION   O-XXX                Y02669 53700002
*        R8 PTS TO THE UNIT NAME                                 Y02669 53800002
*        R10 HAS UCB PTR FOR UNIT                                Y02669 53900002
*        R11 = 0 NO COMPOSITE UCB PTR                            Y02669 54000002
*        R5 HAS PTR TO UNIT'S UCME                               Y02669 54100002
*        R3 = 0 NO COMPOSITE UCME PTR                            Y02669 54200002
*                                                                Y02669 54300002
*  MUST CHECK VIA UCB IF DEVICE IS ONLINE OR UNDER TEST BY OLTEP Y02669 54400002
*  EITHER OF BOTH ARE ERRORS, AND NO RECORD CAN BE WRITTEN       Y02669 54500002
*                                                                Y02669 54600002
         BAL   R6,CHECKUCB        GO CHECK UCB                   Y02669 54700002
         LTR   R15,R15         WAS UNT OFFL AND NOT UNDER OLTEP  Y02669 54800002
         BNZ   BADOUNT            NO, NO RECORD ISSUED           Y02669 54900002
         LA    R9,DEC5(R9)        INDEX PAST UNIT                Y02669 55000002
         B     SEESPACE           GO PUT RECORD                  Y02669 55100002
*                                                                Y02669 55200002
         EJECT                                                          55300002
REGUNIT  EQU   *                                                 Y02669 55400002
*                                                                Y02669 55500002
*  PROCESSING REGULAR 3 CHARACTER UNIT  XXX                      Y02669 55600002
*                                                                Y02669 55700002
         OI    XAP+DEC0,REGUNT    SET 'REG-UNIT SWITCH'          Y02669 55800002
         LR    R8,R9              SET REG8 TO THE UNITNAME       Y02669 55900002
         BAL   R15,SEARCH         GET UCME, IF ANY               Y02669 56000002
         LTR   R5,R5              ANY UCME                       Y02669 56100002
         BZ    IOUNIT             NO, THIS IS A REGULAR I/O UNT  Y02669 56200002
         TM    UCMATR,UCMOF+UCMIF HAS UCME, DOES IT HAVE INPUT   Y02669 56300002
*                                 OUTPUT CAPABILITIES            Y02669 56400002
         BC    DEC12,BADREG       NO, ERROR IN REG. UNIT         Y02669 56500002
         SR    R11,R11            NO COMPOSITE UCB PTR           Y02669 56600002
         SR    R3,R3              NO COMPOSITE UCME PTR          Y02669 56700002
*                                                                Y02669 56800002
*        R8 = R9 PTR TO UNIT NAME                                Y02669 56900002
*        R10 HAS PTR TO UNIT'S UCB                               Y02669 57000002
*        R11 = 0 NO COMPOSITE PTR                                Y02669 57100002
*        R5 HAS PTR TO UNIT'S UCME                               Y02669 57200002
*        R3 = 0 NO COMPOSITE UCME                                Y02669 57300002
*                                                                Y02669 57400002
*  MUST CHECK VIA UCB IF DEVICE IS ONLINE OF UNDER TEST BY OLTEP Y02669 57500002
*  EITHER OR BOTH ARE ERRORS, AND NO RECORD CAN BE PRINTED       Y02669 57600002
*                                                                Y02669 57700002
         BAL   R6,CHECKUCB        GO CHECK UCB                   Y02669 57800002
CODECHK  EQU   *                                                 Y02669 57900002
         LTR   R15,R15            UNIT OFFL AND NOT UNDER OLTEP  Y02669 58000002
         BNZ   BADREG             NO, NO RECORD PRINTED          Y02669 58100002
         LA    R9,DEC3(R9)        INDEX PAST UNIT                Y02669 58200002
         B     SEESPACE           GO PUT RECORD FOR UNIT         Y02669 58300002
*                                                                Y02669 58400002
BADREG   EQU   *                                                 Y02669 58500002
         LA    R9,DEC3(R9)        INDEX PAST UNIT                Y02669 58600002
         MVI   XAP+DEC0,XZERO     CLEAR 'REG-UNIT SWITCH'        Y02669 58700002
         B     ENDSCAN            GO FIND ANOTHER UNIT           Y02669 58800002
*                                                                Y02669 58900002
         EJECT                                                          59000002
IOUNIT   EQU   *                                                 Y02669 59100002
*                                                                Y02669 59200002
* PROCESSING REG UNIT WHICH IS I/O ONLY (NO CONSOLE CAPABILITIES)Y02669 59300002
*                                                                Y02669 59400002
         TM    XASOPCOD,XAON      IS IT AN ONLINE KEYWORD?     @Z30LPTJ 59500003
         BZ    BADREG             NO, NO CONSL KEY ALLOWED HERE  Y02669 59600002
         DROP  R5                                                Y02669 59700002
         USING SETCVT,R5                                         Y02669 59800002
         L     R5,CVTPTR          CVT PTR                        Y02669 59900002
         L     R5,CVTILK2         UCB LOOK-UP TABLE              Y02669 60000002
         DROP  R5                                                Y02669 60100002
VULOOK   EQU   *                                                 Y02669 60200002
         LH    R10,DEC0(R5)       OBTAIN UCB PTR                 Y02669 60300002
         LTR   R10,R10            ANY                            Y02669 60400002
         BZ    VBUMP              TAKE BRANCH TO TEST THE NEXT   Y02669 60500002
         LH    R6,VFFFF           CHECK END OF UCBLIST           Y02669 60600002
         CLR   R6,R10             COMPARING THE FFFF'S           Y02669 60700002
         BE    BADREG             NO UCB FOUND, ERROR            Y02669 60800002
         N     R10,VFFFF-DEC2     ZERO OUT HIGH ORDER BITS       Y02669 60900002
         CLC   UCBNAME(DEC3),DEC0(R9)  DOES THE UNITNAMES MATCH  Y02669 61000002
         BE    GOTUCB            YES, FOUND THE UCB              Y02669 61100002
VBUMP    EQU   *                                                 Y02669 61200002
         LA    R5,DEC2(R5)        UPDATE UCBLIST PTR             Y02669 61300002
         B     VULOOK             CHECK NEXT UCB                 Y02669 61400002
*                                                                Y02669 61500002
*                                                                Y02669 61600002
GOTUCB   EQU   *                                                 Y02669 61700002
         SR    R11,R11            NO COMPOSITE UCB PTR           Y02669 61800002
*                                                                Y02669 61900002
*        R8 = R9 PTR TO THE UNITNAME                             Y02669 62000002
*        R11 = 0 NO COMPOSITE UCB PTR                            Y02669 62100002
*        R10 UCB PTR OF UNIT                                     Y02669 62200002
*        R5 = R3 = 0 NO UNITS OR NO COMPOSITES UCME              Y02669 62300002
*                                                                Y02669 62400002
         SR    R5,R5                                             Y02669 62500002
         SR    R3,R3                                             Y02669 62600002
*                                                                Y02669 62700002
*  MUST CHECK VIA UCB IF DEVICE IS ONLINE OF UNDER TEST BY OLTEP Y02669 62800002
*  EITHER OR BOTH ARE ERRORS AND NO RECORD CAN BE WRITTEN        Y02669 62900002
*                                                                Y02669 63000002
         BAL   R6,CHECKUCB        GO CHECK UCB                   Y02669 63100002
         B     CODECHK            AND CHECK RESULTS              Y02669 63200002
*                                                                Y02669 63300002
         EJECT                                                          63400002
CHECKUCB EQU   *                                                 Y02669 63500002
*                                                                Y02669 63600002
*  THIS SUBROUTINE WILL CHECK VIA THE UCB POINTED BY REG10,      Y02669 63700002
*  IF THE DEVICE IS ONLINE/OFFLINE AND IF THE DEVICE IS          Y02669 63800002
*  UNDER TEST UNDER OLTEP.                                       Y02669 63900002
*  IF THE DEVICE IS ONLINE, NO RECORD SHOULD BE WRITTEN AND THIS Y02669 64000002
*  SUBROUTINE RETURNS A RETURN CODE OF : 8                       Y02669 64100002
*  IF THE DEVICE IS UNDER TEST BY OLTEP, THEN AGAIN NO RECORD    Y02669 64200002
*  SHOULD BE WRITTEN AND THIS SUBROUTINE RETURNS A RETCODE OF :4 Y02669 64300002
*                                                                Y02669 64400002
*  ON ENTRY THE FOLLOWING INPUTS ARE EXPECTED                    Y02669 64500002
*        R8 PTS TO THE UNITNAME                                  Y02669 64600002
*        R10 PTS TO THE UCB OF THE UNIT                          Y02669 64700002
*                                                                Y02669 64800002
         LA    R15,DEC4           PRESET FOR AN OLTEP ERROR      Y02669 64900002
         TM    UCBFL5,UCBNALOC    DEVICE IS UNDER OLTEP          Y02669 65000002
         BO    RET                YES, ERROR, NO RECORD          Y02669 65100002
         LA    R15,DEC8           PRESET FOR ONLINE ERROR        Y02669 65200002
         TM    SRTESTAT,SRTEONLI  IS DEVICE ONLINE               Y02669 65300002
         BO    RET                YES, ERROR, NO RECORD          Y02669 65400002
         SR    R15,R15            ALL OK, CODE IS 0 ON RETURN    Y02669 65500002
RET      EQU   *                                                 Y02669 65600002
         BR    R6                 RETURN TO CALLER               Y02669 65700002
*                                                                Y02669 65800002
COMPUCB  EQU   *                                                 Y02669 65900002
*                                                                Y02669 66000002
*  THIS SUBROUTINE WILL CHECK SAME AS THE 'CHECKUCB' BUT IT WILL Y02669 66100002
*  PERFORM THIS FUNCTION FOR THE OUTPUT UNIT OF A COMPOSITE UNIT Y02669 66200002
*                                                                Y02669 66300002
*        R8 PTS TO THE UNITNAME                                  Y02669 66400002
*        R11 PTS TO THE UCB OF THE OUTPUT UNIT OF THE COMPOSITE  Y02669 66500002
*                                                                Y02669 66600002
         DROP  R10                                               Y02669 66700002
         USING UCBOB,R11                                         Y02669 66800002
         LA    R15,DEC8           PRESET FOR THE ONLINE ERROR    Y02669 66900002
         TM    SRTESTAT,SRTEONLI  IS UNIT ONLINE                 Y02669 67000002
         BO    RET                RETURN, ERROR                  Y02669 67100002
         LA    R15,DEC4           PRESET FOR OLTEP ERROR         Y02669 67200002
         TM    UCBFL5,UCBNALOC    IS COMP UNDER TEST BY OLTEP    Y02669 67300002
         BO    RET                YES, ERROR NO RECORD           Y02669 67400002
         SR    R15,R15            ALL IS OK, RETURN CODE = 0     Y02669 67500002
         BR    R6                 RETURN TO CALLER               Y02669 67600002
         DROP  R11                                               Y02669 67700002
         USING UCBOB,R10                                         Y02669 67800002
*                                                                Y02669 67900002
         EJECT                                                          68000002
SEESPACE EQU   *                                                 Y02669 68100002
*                                                                Y02669 68200002
*  THIS SUBROUTINE WILL CHECK IF ENOUGH SPACE IS AVAILABLE IN THEY02669 68300002
*  SMF RECORD BUFFER TO INSERT ONE MORE RECD (FOR A SINGLE DEV)  Y02669 68400002
*  (HANDLED UNDER SEESPACE), OR FOR TWO DEVICES IF THE UNIT IS A Y02669 68500002
*  COMPOSITE DEVICE (HANDLED UNDER COMPSPACE).                   Y02669 68600002
*  IF THERE IS ENOUGH SPACE, THEN THE RECORD IS INSERTED, PTRS   Y02669 68700002
*  ARE UPDATED AND WE RETURN TO SEE IF MORE UNITS ARE TO BE      Y02669 68800002
*  PROCESSED.                                                    Y02669 68900002
*  IF NO SPACE IS AVAILABLE, THEN WE WRITE THIS RECORD FIRST, ANDY02669 69000002
*  THEN WE UPDATED A BRANK-NEW RECORD WITH THIS DEVICE'S INFO    Y02669 69100002
*                                                                Y02669 69200002
         LH    R3,DEC0(R1)    OBTAIN TOTAL LENGTH TO DETERMINE   Y02669 69300002
*                                 IF SPACE FOR PUTTING AN ENTRY  Y02669 69400002
*                                 EXISTS OR NOT                  Y02669 69500002
         CH    R3,CONS156         TEST FOR ONE ENTRY ONLY        Y02669 69600002
         BL    ITISOK             YES, ENOUGH ROOM               Y02669 69700002
         BAL   R6,WRITEIT         NO, MUST WRITE THIS REC FIRST  Y02669 69800002
*                                                                Y02669 69900002
ITISOK   EQU   *                                                 Y02669 70000002
         BAL   R6,ENTRY           UPDATE REC WITH THIS DEV'S INFOY02669 70100002
SMORE    EQU   *                                                 Y02669 70200002
         MVI   XAP+DEC0,XZERO     CLEAR UNTYPE SWITCHS SINCE REC Y02669 70300002
*                            HAS BEEN PUT DOWN IN THE BUFFER AND Y02669 70400002
*                                 FINISHED WITH THIS DEVICE      Y02669 70500002
PARENCHK EQU   *                                                 Y02669 70600002
         LTR   R13,R13            WAS THIS A MULTIPLE UNIT COMD  Y02669 70700002
         BZ    SEXIT              NO, NOMORE UNITS, WERE FINISHEDY02669 70800002
         CLI   DEC0(R9),RPAREN    IS THERE AN EXT PAREN HERE     Y02669 70900002
         BNE   NOPAREN            NO, NO CLOSING PARENS HERE     Y02669 71000002
         BCTR  R13,DEC0           YES, DECREMNT PARNS SWITH BY 1 Y02669 71100002
         LA    R9,DEC1(R9)        UPDATE PTR PAST THE PARENS     Y02669 71200002
         B     PARENCHK           SEE IF WE ARE FINISHED         Y02669 71300002
NOPAREN  EQU   *                                                 Y02669 71400002
         CLI   DEC0(R9),COMMA     IS THERE A COMMA HERE          Y02669 71500002
         BNE   ENDSCAN            NO, SOMETHING IS WRONG         Y02669 71600002
         LA    R9,DEC1(R9)        YES, UPDATE PAST THE COMMA     Y02669 71700002
         B     START              GO CHECK FOR A NEW UNIT        Y02669 71800002
*                                                                Y02669 71900002
*                                                                Y02669 72000002
COMPSPAC EQU   *                                                 Y02669 72100002
         LH    R3,DEC0(R1)        OBTAIN TOTAL LNG TO DETERMINE  Y02669 72200002
*                                 IF SPACE FOR PUTTING ENTRIES   Y02669 72300002
*                                 EXISTS OR NOT                  Y02669 72400002
         CH    R3,CONS152         TST FOR 2 ENTRIES (I AND O)    Y02669 72500002
         BL    SIZEOK             YES, ENOUGH ROOM               Y02669 72600002
         BAL   R6,WRITEIT         NO, WRITE CURRENT RECORD FIRST Y02669 72700002
*                                                                Y02669 72800002
SIZEOK   EQU   *                                                 Y02669 72900002
         TM    XAP+DEC0,NRECI     IS INPUT UNT TO HAVE A REC     Y02669 73000002
         BO    RECORDO            NO CHECK IF THE OUTPUT IS      Y02669 73100002
         BAL   R6,ENTRY           GO FILL ENTRY FOR INPUT UNIT   Y02669 73200002
*                                                                Y02669 73300002
RECORDO  EQU   *                                                 Y02669 73400002
         TM    XAP+DEC0,NRECO     IS THE O UNIT TO HAVE A RECORD Y02669 73500002
         BO    SMORE              NO, FINISHED                   Y02669 73600002
         LR    R10,R11        GET R10 TO PT TO OUTPUT UNIT'S UCB Y02669 73700002
         BAL   R6,ENTRY           FILL ENTRY FOR OUTPUT UNIT     Y02669 73800002
         B     SMORE              FINISHED                       Y02669 73900002
*                                                                Y02669 74000002
         EJECT                                                          74100002
WRITEIT  EQU   *                                                 Y02669 74200002
*                                                                Y02669 74300002
*  THIS ROUTINE ISSUES AN SVC83 TO WRITE AN SMF RECORD           Y02669 74400002
*                                                                Y02669 74500002
         LR    R7,R1              SAVE POINTER ACROSS SVC CALL @YM3500P 74550002
         SVC   83                                                Y02669 74700002
         LR    R1,R7            RESTORE POINTER AFTER SVC CALL @YM3500P 74750002
         MVI   DEC1(R1),TWENTY    REINIT TOTAL LENGTH TO 20      Y02669 74800002
         MVC   VARLNTH(DEC2,R1),TWOCON REINIT VARY LENGTH TO 2   Y02669 74900002
         LA    R14,DEC20(R1)      REINIT R14 TO PT TO NEXT AREA  Y02669 75000002
         XC    DEC0(ONEFORTY,R14),DEC0(R14)  ZERO OUT PREV. DATA Y02669 75100002
         BR    R6                 RETURN TO CALLER               Y02669 75200002
*                                                                Y02669 75300002
         EJECT                                                          75400002
ENTRY    EQU   *                                                 Y02669 75500002
*                                                                Y02669 75600002
*  THIS SUBROUTINE WILL ENTER THE APPROPRIATE INFO INTO THE SMF  Y02669 75700002
*  RECORD BUFFER FOR THE DEVICE WHOSE UCB PTR IS IN REG10        Y02669 75800002
*                                                                Y02669 75900002
         LH    R3,DEC0(R1)        OBTAIN TOTAL LENGTH AND        Y02669 76000002
         LA    R3,DEC4(R3)        ADD FOUR TO IT                 Y02669 76100002
         STH   R3,DEC0(R1)        PUT IN THE UPDATED FIGURE      Y02669 76200002
         LH    R3,VARLNTH(R1)     UPDATE THE VARIABLE LENGTH ALSOY02669 76300002
         LA    R3,DEC4(R3)        BY ADDING FOUR IN IT           Y02669 76400002
         STH   R3,VARLNTH(R1)     AND PUT IT BACK                Y02669 76500002
         MVC   DEC0(DEC2,R14),UCBTBYT3 COPY DEVICE'S INFO        Y02669 76600002
         LR    R7,R1              WORKING ADDRESS REGISTER     @ZA03202 76606003
         LA    R3,DEC3            LIMIT OF 3 LOOPS             @ZA03202 76612003
         MVC   ONESXTY5(DEC3,R7),UCBNAME OBTAIN UNIT NAME      @ZA03202 76618003
LOOP3X   EQU   *                                               @ZA03202 76624003
         CLI   ONESXTY5(R7),XC1   IS CHAR. BELOW X'C1' (A)?    @ZA03202 76630003
         BL    TESTLOOP           YES, CHECK NEXT BYTE IN LOOP @ZA03202 76636003
         CLI   ONESXTY5(R7),XC6   IS CHAR. ABOVE X'C6' (F)?    @ZA03202 76642003
         BH    TESTLOOP           YES, CHECK NEXT BYTE IN LOOP @ZA03202 76645003
         TR    ONESXTY5(DEC1,R7),TABLE ALTER BYTE FOR PACK     @ZA03202 76648003
TESTLOOP EQU   *                                               @ZA03202 76654003
         LA    R7,DEC1(R7)        BUMP TO NEXT BYTE            @ZA03202 76660003
         BCT   R3,LOOP3X          LOOP UNTIL DONE              @ZA03202 76666003
         PACK  ONESIXTY(DEC4,R1),ONESXTY5(DEC3,R1) DELETE ZONES@ZA03202 76672003
         L     R3,ONESIXTY(R1)    SAVE PACKED ADDRESS          @ZA03202 76678003
         SRL   R3,DEC4            SHIFT OUT THE SIGN BIT       @ZA03202 76684003
         STH   R3,DEC2(R14)       INSERT IN THE SMF FILE       @ZA03202 76690003
         NI    DEC2(R14),HEX0F    CLEAR UNUSED BITS            @YM07237 76800002
         TM    UCBTBYT2,UCBRVDEV  IS IT A VIRTUAL DEVICE?      @Z30LPTJ 76810003
         BNO   NOHIGHBT           NO, DO NOT SET HIGH ORDER BIT@Z30LPTJ 76820003
         CLC   UCBTBYT3(DEC2),THRTY330 IS IT A 3330 DEVICE?    @Z30LPTJ 76830003
         BNE   NOHIGHBT           NO, DO NOT SET HIGH ORDER BIT@Z30LPTJ 76840003
         OI    DEC2(R14),VUNIT    SET HIGH ORDER BIT           @Z30LPTJ 76850003
NOHIGHBT EQU   *                                               @Z30LPTJ 76860003
         LA    R14,DEC4(R14)      UPDATE THE VAR. DATA PTR       Y02669 76900002
         BR    R6                 RETURN TO CALLER               Y02669 77000002
*                                                                Y02669 77100002
         EJECT                                                          77200002
SEARCH   EQU   *                                                 Y02669 77300002
*                                                                Y02669 77400002
*  THIS SUBROUTINE WILL SEARCH AND FIND IF THERE IS ANY THE      Y02669 77500002
*  UCME FOR THE DEVICE WHOSE UNITNAME IS POINTED BY REG8         Y02669 77600002
*  ON RETURN THE UCB PTR WILL BE IN REG 10 AND THE UCME WILL     Y02669 77700002
*  BE POINTED BY REG5                                            Y02669 77800002
*  OTHERWISE THESE REGS WILL BE 0                                Y02669 77900002
*                                                                Y02669 78000002
         L     R5,CVTPTR                                         Y02669 78100002
         USING SETCVT,R5                                         Y02669 78200002
         L     R5,CVTCUCB                                        Y02669 78300002
         DROP  R5                                                Y02669 78400002
         USING UCM,R5                                            Y02669 78500002
         LM    R5,R7,UCMVEA                                      Y02669 78600002
         USING UCMLIST,R5                                        Y02669 78700002
UCMESRCH EQU   *                                                 Y02669 78800002
         L     R10,UCMUCB                                        Y02669 78900002
         CLC   DEC0(DEC3,R8),UCBNAME   UNITNAMES MATCH           Y02669 79000002
         BCR   DEC8,R15           NAMES MATCH, FINISHED          Y02669 79100002
         CLR   R5,R7              IS IT END OF UCME LIST         Y02669 79200002
         BE    NOUCME             YES, ERROR, NO UCME FOUND      Y02669 79300002
         AR    R5,R6              NO, GO TO CHECK NEXT UCME      Y02669 79400002
         B     UCMESRCH           LOOP TO SEE IF THIS THE UCME   Y02669 79500002
*                                                                Y02669 79600002
NOUCME   EQU   *                                                 Y02669 79700002
         SR    R5,R5              NO UCME FOUND                  Y02669 79800002
         SR    R10,R10            AND, THEREFORE NO UCB          Y02669 79900002
         BR    R15                RETURN TO CALLER               Y02669 80000002
         DROP  R5                                                Y02669 80100002
*                                                                Y02669 80200002
         EJECT                                                          80300002
SEXIT    EQU   *                                                 Y02669 80400002
*                                                                Y02669 80500002
*  THIS SUBROUTINE CLEANS UP AND EXITS TO 4403D OR TO 4303D      Y02669 80600002
*  DEPENDING ON WHAT WAS PRESET BY 3303D                         Y02669 80700002
*                                                                Y02669 80800002
OVER     EQU   *                                                 Y02669 80900002
         CLC   VARLNTH(DEC2,R1),TWOCON HAS ANY ENTRY BEEN MADEIN Y02669 81000002
*                                 THE SMF RECORD                 Y02669 81100002
         BE    NORECORD           DO NOT WRITE THE RECORD        Y02669 81200002
*                                 IN THAT CASE                   Y02669 81300002
         BAL   R6,WRITEIT         GO AND WRITE THE RECORD, FIRST Y02669 81400002
NORECORD EQU   *                                                 Y02669 81500002
         LA    R0,ONESXTY8        SIZE OF SMF RECORD BUFFER    @ZA03202 81600003
         FREEMAIN  R,LV=(0),A=(1)                                Y02669 81700002
VEXIT    EQU   *                                                 Y02669 81800002
         L     R13,XAK            RESTORE SAVE AREA PTR        @Z30LPTJ 81900003
         XC    XAP(DEC4),XAP                                     Y02669 82000002
         MVC   XAX+DEC3(DEC2),X4203    ASSUME GOING TO 4203D     Y02669 82100002
         L     R15,VCON42         GET ADDRESS OF 4203D           Y02669 82200002
         TM    XASWITCH,XASMF42   IS IT A 4203D EXIT           @Z30LPTJ 82300003
         BO    VEXIT2             YES, GO TO BRANCH              Y02669 82400002
         MVC   XAX+DEC3(DEC2),X4403      NO, EXIT IS TO 4403D    Y02669 82500002
         L     R15,VCON44                                        Y02669 82600002
VEXIT2   EQU   *                                                 Y02669 82700002
         LM    R0,R14,DEC0(R13)                                  Y02669 82800002
         BR    R15                EXIT                           Y02669 82900002
*                                                                Y02669 83000002
         EJECT                                                          83600002
X4203    DC    C'42'               4203D VARY MODULE             Y02669 83700002
X4403    DC    C'44'               4403D VARY MODULE             Y02669 83800002
         DS    0F                                                       83900002
VCON42   DC    V(IEE4203D)                                       Y02669 84000002
VCON44   DC    V(IEE4403D)                                       Y02669 84100002
         DS    0F                                                Y02669 84200002
TWOCON   DC    H'2'                                                     84300002
CONS152  DC    H'152'                                                   84400002
CONS156  DC    H'156'                                                   84500002
CON      DC    C'CON'                                            Y02669 84600002
ONL      DC    C'ONL'                                            Y02669 84700002
PARENI   DC    C'(I-'                                            Y02669 84800002
HONE     DC    H'1'                                              Y02669 84900002
CMAO     DC    C',O-'                                            Y02669 85000002
OUNIT    DC    C'O-'                                             Y02669 85100002
         DS    0F                                                Y02669 85200002
EIGHT    DC    X'00000008'                                       Y02669 85300002
         DS    0F                                                       85400002
         DC    X'0000'        THESE TWO CONSTANTS MUST BE LEFT   Y02669 85500002
VFFFF    DC    X'FFFF'        TOGETHER                           Y02669 85600002
THRTY330 DC    X'2009'        3330 UCB DEFINITION              @Z30LPTJ 85650003
TABLE    EQU   *-C'A'                                          @ZA03202 85660003
         DC    X'FAFBFCFDFEFF'                                 @ZA03202 85670003
         SPACE 5                                                        85700002
PATCH    DC    CL50'***IEE2303D***'                                     85800002
         EJECT                                                          85900002
EXSAVEC  DSECT                                                          86000002
         IEEXSA                                                         86100002
         EJECT                                                          87100002
         IEESMCA                                                        87200002
         EJECT                                                          87300002
SETCVT   DSECT                                                          87400002
         CVT                                                            87500002
         EJECT                                                          87600002
UUCM     DSECT                                                          87700002
         IEECUCM  FORMAT=NEW                                            87800002
         EJECT                                                          87900002
UCB      DSECT                                                          88000002
         IEFUCBOB                                                       88100002
         EJECT                                                          88200002
         END                                                            88300002
