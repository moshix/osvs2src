         TITLE 'IEECVETW -ALIAS IGC5W07B- 3284/6 I/O '                  00050000
IEECVETW CSECT                                                          00100000
* A 077500-077700,366100                                       MB M2523 00120000
* C 155000,310400,421000                                       MB M2523 00160000
* A 164500,164520,165900,166000                               JE YM8416 00220000
* STATUS                                                                00280000
*                                                                       00340000
*    VS2 RELEASE 2                                                      00400000
*                                                                       00430000
*    APARS FIXED ZA00539,ZA08139                                        00500000
*                                                                       00530000
* FUNCTION                                                              00600000
*    THIS IS A DEVICE DEPENDENT ROUTINE TO PERMORM THE REQUESTED I/O IN 00650000
*    PROPER SCREEN FORMAT.                                              00700000
*                                                                       00750000
* ENTRY POINTS                                                          00800000
*         IEECVETW FOR ALL FUNCTIONS                                    00850000
*                                                                       00900000
* OPERATION                                                             00950000
*                                                                       01000000
* INPUT                                                                 01050000
*                                                                       01100000
* OUTPUT                                                                01150000
*    WRITING OF TEXT IN OUTPUT WQES.                                    01200000
*                                                                       01250000
* EXTERNAL REFERENCES                                                   01300000
*         NONE.                                                         01350000
*                                                                       01400000
* EXITS, NORMAL                                                         01450000
*                                                                       01500000
* EXITS, ERROR                                                          01550000
*         NONE.                                                         01600000
*                                                                       01650000
* TABLES/WORK AREAS                                                     01700000
*                                                                       01750000
* ATTRIBUTES                                                            01800000
*    REFRESHABLE, PRIVILEGED, TYPE 4 SVC.                               01850000
*                                                                       01900000
* CHARACTER CODE DEPENDENCY                                             01950000
*    NONE.                                                              02000000
*                                                                       02050000
* NOTES                                                                 02100000
*    THE FOLLOWING FLAG BITS ARE USED:                                  02150000
*       THE ACTION COLUMN INDICATES WHETHER THE BIT IS TURNED ON, OFF   02200000
*       OR JUST TESTED BY THIS MODULE.                                  02250000
*                                                                       02300000
*         NAME         ACTION                 FUNCTION                  02350000
         EJECT                                                          02400000
**************REGISTER EQUATES*******************                       02450000
*                                                                       02500000
R0PARM   EQU   0                   GETMAIN-FREEMAIN PARAMETER MB        02550000
R1PARM   EQU   1                   PARAMETER REGISTER                   02600000
R2CXSA   EQU   2                   CXSA BASE REGISTER                   02650000
R3WORK   EQU   3                   WORK REGISTER                        02700000
R3WQE    EQU   3                   WQE POINTER                          02750000
R4CCW    EQU   4                   CCW POINTER                          02800000
R5WQETXT EQU   5                   WQE TEXT POINTER                     02850000
R6WORK   EQU   6                   WORK REGISTER                        02900000
R6LENGTH EQU   6                   LENGTH OF TEXT                       02950000
R7WORK   EQU   7                   WORK REGISTER                        03000000
R7TCB    EQU   7                   TCB POINTER                          03050000
R8RTRN   EQU   8                   RETURN REG FOR SUBROUTINES           03100000
R8WORK   EQU   8                   WORK REGISTER                        03150000
R9DCB    EQU   9                   DCB BASE REGISTER                    03200000
RAUCM    EQU   10                  UCM BASE REGISTER                    03250000
RBUCME   EQU   11                  UCM ENTRY BASE REGISTER              03300000
RCBASE   EQU   12                  PROGRAM BASE REGISTER                03350000
RDMAJOR  EQU   13                  POINTER TO MAJOR WQE                 03400000
RDQUEUE  EQU   13                  OUTPUT QUEUE POINTER                 03450000
RERTRN   EQU   14                  MAIN LINE RETURN REGISTER            03500000
RFWORK   EQU   15                  WORK REGISTER                        03550000
         EJECT                                                          03600000
         ENTRY IGC5W07B            ALIAS NAME FOR IEECVETW              03620000
IGC5W07B EQU   *                   ONLY ENTRY POINT                     03700000
         BALR  RCBASE,0            SET UP BASE REGISTER                 03720000
         USING ETWBASE,RCBASE      AND TELL ASSEMBLER                   03800000
ETWBASE  B     BEGIN               BRANCH AROUND EYECATCHER   MB Y02958 03806000
ICATCH   DC    C'IEECVETW, ALIAS IGC5W07B'                    MB Y02958 03900000
         DC    C'&SYSDATE',CL40' '                            MB Y02958 03940000
BEGIN    LR    R2CXSA,R1PARM       SAVE CXSA POINTER          MB Y02958 03980000
         USING CXSA,R2CXSA                                              04020000
         ST    RERTRN,CSAXA        SAVE RETURN ADDRESS        MB Y02958 04060000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDRESS                 04120000
         BZ    NOESTAE             IF NONE, SKIP SETUP                  04200000
         USING PARMLIST,R6WORK     PARMLIST ADDRESSABILITY              04240000
         LA    R7WORK,ETWRTY       GET ETW'S ADDRESS                    04280000
         C     R7WORK,PARMRTAD     IS OUR RETRY ALREADY IN LIST        *04320000
                                                             JE @YM8452 04360000
         BE    NOESTAE             YES, BYPASS SETUP         JE @YM8452 04400000
         MVC   CSAXB(8),RELEASED   SET UP LOCKING SBRTN      JE @YM8452 04440000
         MVC   CSANAME(8),PARMRTAD SAVE RETRY ADDRESSES                 04480000
         ST    R7WORK,PARMRTAD     SET IT UP                            04520000
         DROP  R6WORK                                                   04560000
NOESTAE  EQU   *                                                        04600000
         L     RBUCME,CSAUCM       POINT TO UCM ENTRY                   04640000
         USING UCMLIST,RBUCME                                           04680000
         L     RAUCM,CSACTLM       SET UCM BASE                         04720000
         USING UCM,RAUCM                                                04760000
         L     R9DCB,UCMDCB        POINT TO DCB (IF PRESENT)            04800000
         USING IHADCB,R9DCB                                   MB Y02958 04840000
         LA    RFWORK,GETLOCK      ADDRESS GETLOCK SUROUTINE  MB Y02958 04880000
         LR    R1PARM,R2CXSA       PASS CXSA                            04920000
         BALR  RERTRN,RFWORK       OBTAIN LOCKS AND INITIALIZE ADCONS   05130000
         SPACE 5                                                        05200000
TESTCLOS TM    UCMSTS,UCMCF        CLOSE REQUEST?                       05240000
         BZ    TESTOPEN             NO, TEST FOR OPEN                   05280000
         TM    UCMSTS,UCMPF        IS OUTPUT PENDING                    05320000
         BNO   CLOSE                NO, GO AHEAD AND CLOSE              05360000
*                                   YES, HANDLE OUTPUT FIRST            05400000
TESTOPEN TM    UCMSTS,UCMTA        OPEN REQUEST?                        05440000
         BO    OPEN                 YES, GO DO IT                       05480000
TESTBUSY EQU   *                                                        05520000
         TM    UCMSTS,UCMBF        IS DEVICE BUSY                       05560000
         BNO   TESTOUT               NO, CHECK FOR OUTPUT               05600000
TESTIO   TM    UCMECB,GOODIO       WAS I/O SUCCESFUL                    05640000
         BZ    EXIT                NOT EVEN COMPLETE YET                05680000
         BNO   SWITCHEX            NO, SWITCH CONSOLES                  05720000
ENDIO    XC    UCMECB,UCMECB       YES, CLEAR ECB                       05760000
         NI    UCMSTS,X'FF'-UCMBF  TURN OFF BUSY FLAG                   05800000
         SPACE 5                                                        05840000
PMFWQE   EQU   *                                                        05880000
         L     RDQUEUE,UCMWLAST    GET POINTER TO LAST OUTPUT           05920000
*                                       QUEUE ENTRY SERVICED            05960000
         USING CQE,RDQUEUE         BASE FOR CONSOLE Q ENTRY   MB Y02958 06000000
         LTR   RDQUEUE,RDQUEUE     HAS K C,D,ID ALLOWED                 06040000
*                                  A PURGE TO BE DONE                   06080000
         BZ    PMFWQEND            YES, RESTORE FOR WTO                 06120000
         TM    CQEFLAG,CQEMAJOR    MLWTO                      MB Y02958 06160000
         BNO   PMFWQEN1            NO                                   06200000
         TM    UCMSTS,UCMTC        HAS THIS MLWTO BEEN CANCELLED        06240000
         BNO   PMF1                YES, REDUCE USE COUNT                06280000
         USING WQE,R3WQE                                                06320000
         L     R3WQE,CQEWQE        GET BUFFER POINTER         MB Y02958 06360000
         LA    R3WQE,0(R3WQE)      BUFFER POINTED TO BY R3WQE IS        06400000
*                        THE MAJOR WHICH MAY OR MAY NOT HAVE JUST       06440000
*                        BEEN WRITTEN.                                  06480000
*                        UCMMLAST POINTS TO THE MINOR HALF              06520000
*                        CONTAINING THE LINE JUST WRITTEN, IF           06560000
*                        ADDRESS EXISTS.                                06600000
         NC    UCMMLAST(N4),UCMMLAST   MINOR JUST WRITTEN               06640000
         BNZ   PMF1                      YES                            06680000
PMF0     EQU   *                                                        06720000
         TM    WMJMLTYP,WMJMLTYD   END INDICATOR IN MAJOR               06760000
         BO    PMFWQEND            YES, PURGE                           06800000
         TM    WMJMMLW,WMJMMLWH    ANY MINORS EXIST                     06840000
         BO    MRETURN             NO, RETURN                           06880000
         NI    CQEFLAG,X'FF'-CQEATTOP TURN OFF FLAG           MB Y02958 06920000
         MVC   UCMMLAST(N4),WMJMMIN   NEXT LINE TO BE WRITTEN           06960000
         B     PMLW3               WRITE LINE                           07000000
PMF1     EQU   *                                                        07040000
         L     R3WQE,UCMMLAST      PT TO HALF WITH WRITTEN LN           07080000
         SR    R6WORK,R6WORK       CLEAR REGISTER                       07120000
         IC    R6WORK,WMNMUC1      GET USE COUNT                        07160000
         BCTR  R6WORK,0            REDUCE BY ONE                        07200000
         STC   R6WORK,WMNMUC1      STORE COUNT                          07240000
         TM    UCMSTS,UCMTC        MLWTO CANCELLED                      07280000
         BNO   PMFWQEND            YES, PURGE                           07320000
         LTR   R6WORK,R6WORK       IS COUNT ZERO                        07360000
         BNZ   PMF2                 NO                                  07400000
         L     RFWORK,0(RDQUEUE)   POINT TO MAJOR                       07440000
         OI    N4(RFWORK),WMJMMLWG TELL DEQ TO CHECK THIS CHAIN         07480000
         OI    UCMSTS,UCMTB        TELL DEQ TO CHECK MY QUEUE           07520000
PMF2     EQU   *                                                        07560000
         TM    WMNMLT1,WMNMLT1D    END INDICATOR IN THIS LINE           07600000
         BO    PMFWQEND            YES, PURGE                           07640000
PMF3     EQU   *                                                        07680000
         L     R3WQE,WMNMNX1-1     BASE FOR NEXT MINOR        MB  M2184 07720000
         LA    R3WQE,0(R3WQE)      IGNORE USE COUNT           MB  M2523 07760000
         LTR   R3WQE,R3WQE         NEXT LINE EXIST            MB  M2184 07800000
         BZ    MRETURN             NO, RETURN                 MB  M2184 07840000
         NC    WMNMLT1,WMNMLT1     THIS MINOR BUILT YET       MB  M2184 07880000
         BZ    MRETURN             NO,RETURN                  MB  M2184 07920000
         ST    R3WQE,UCMMLAST      NEXT LINE TO WRITE         MB  M2184 08650000
         B     PMLW3               WRITE LINE                           08700000
PMF4     EQU   *                                                        08740000
         L     R3WQE,UCMMLAST      ADDRESS LAST MINOR                   08780000
         LTR   R3WQE,R3WQE         WAS LAST WRITE A MAJOR               08820000
         BNZ   PMF3                NO GET NEXT LINE POINTER             08860000
PMF5     EQU   *                                                        08900000
         L     RDQUEUE,UCMWLAST    POINT TO ENTRY                       08940000
PMF6     EQU   *                                                        08980000
         L     R3WQE,CQEWQE        GET MAJOR POINTER          MB Y02958 09020000
         LA    R3WQE,0(R3WQE)      CLEAR OUT FLAGS                      09060000
         B     PMF0                WORK WITH MAJOR                      09100000
MRETURN  EQU   *                                                        09140000
         OI    UCMSDS5,UCMSDS5A    WAITING FOR MORE LINES               09180000
         NI    UCMSTS,X'FF'-UCMPF  LOCK OUT OTHER OUTPUT                09220000
         B     EXIT                RETURN TO MCS                        09260000
COMEBACK EQU   *                                                        09300000
         NI    UCMSDS5,X'FF'-UCMSDS5A   NO LONGER WAITING               09340000
         L     RDQUEUE,UCMWLAST    POINT TO MAJOR ENTRY                 09380000
         TM    CQEFLAG,CQEATTOP    START AT TOP OF CHAIN      MB Y02958 09420000
         BNO   PMF4                NO, PROCEED NORMALLY                 09460000
         NI    CQEFLAG,X'FF'-CQEATTOP TURN OFF START-AT-TOP             09500000
         B     PMF6                START AT TOP                         09540000
HCOPY    EQU   *        TEST FOR HARDCOPYING PURGED MESSAGES  MB Y02958 09580000
         TM    CQEFLAG,CQEMLQHC    QUEUED FOR HARDCOPY        MB Y02958 09620000
         BNO   PMFWQEND            NO, TREAT AS IO COMPLETE   MB Y02958 09660000
         TM    WQEXA,WQEQFHC       ISSUES FOR HARDCOPY        MB Y02958 09700000
         BNO   PMFWQEND            NO, TREAT AS IO COMPLETE   MB Y02958 09740000
         TM    WQEAVAIL,WQEBUFC    ALREADY GONE OUT           MB Y02958 09780000
         BO    FOUNDML             YES, TEST FOR MLWTO        MB Y02958 09820000
PMFWQEND EQU   *                                                        09860000
         NI    UCMSTS,X'FF'-UCMTC  NO LONGER WORKING                    09900000
PMFWQEN1 EQU   *                                                        09940000
         OI    CQEFLAG,CQEAVAIL    FLAG AS NO LONGER NEEDED   MB Y02958 09980000
         NI    CQEFLAG,X'FF'-CQEENTR AND NOT A VALID ENTRY    MB Y02958 10020000
         OI    UCMSTS,UCMTB        INDICATE DEQUEUE NEEDED              10060000
TESTOUT  TM    UCMSTS,UCMPF        IS OUTPUT PENDING                    10420000
         BZ    EXIT                NO, RETURN TO MCS                    10500000
NXTLINE  TM    UCMSTS,UCMTC        IS MLWTO IN PROGRESS                 10520000
         BO    COMEBACK                                                 10600000
         SPACE 5                                                        10650000
PMOUTPUT EQU   *                                                        10700000
         L     RDQUEUE,UCMWLAST    GET PTR TO LAST WQE PTR              10750000
         LTR   RDQUEUE,RDQUEUE     IS THERE ANY                         10800000
         BNE   TESTLAST                 YES GO TEST IT                  10850000
         L     RDQUEUE,UCMOUTQ     TRY THE OUTPUT QUEUE PTR             10900000
TEST0    LTR   RDQUEUE,RDQUEUE     IS ANYTHING THERE                    10950000
         BZ    ENDOFQ               NO, NO MORE QUEUE                   11000000
TESTLAST TM    CQEFLAG,CQEENTR     IS THIS A VALID ENTRY      MB Y02958 11050000
         BO    FOUND                   YES                              11100000
         TM    CQEFLAG,CQEEOB      IS THIS LINK OR END OF QUEUE  Y02958 11150000
         BO    LINK                    LINK                             11200000
         BM    ENDOFQ                  END OF Q                         11250000
         LA    RDQUEUE,N4(RDQUEUE) LOOK AT NEXT ENTRY                   11300000
         B     TESTLAST            CHECK FOR LAST ENTRY                 11350000
ENDOFQ   EQU   *                                                        11400000
         NI    UCMSTS,X'FF'-UCMPF  TURN OFF OUTPUT FLAG                 11440000
         B     TESTCLOS            RETURN CHECKING FOR CLOSE            11480000
LINK     L     RDQUEUE,CQEWQE      GET PTR TO NEXT BLOCK      MB Y02958 11520000
         B     TESTLAST            TEST NEXT WQE POINTER                11560000
FOUND    EQU   *                                                        11600000
         LA    RDQUEUE,0(RDQUEUE)  ZERO HIGH ORDER BYTE                 11640000
         ST    RDQUEUE,UCMWLAST    UPDATE LAST POINTER                  11680000
         L     R3WQE,CQEWQE        GET WQE POINTER            MB Y02958 11720000
         TM    WQEXA,WQEPURGE      IS THIS WQE PURGED                   11830000
         BO    HCOPY               YES, CHECK FOR HARDCOPY    MB Y02958 11900000
         OI    WQEAVAIL,WQEBUFC    READY FOR HARDCOPY         MB Y02958 11950000
FOUNDML  EQU   *                   CHECK FOR MLWTO            MB Y02958 12000000
         TM    CQEFLAG,CQEMAJOR    MLWTO                      MB Y02958 12050000
         BNO   NOTMLW              NO, ADJUST LENGTH          MB Y02958 12100000
         OI    UCMSTS,UCMTC        NOW WORKING ON MLWTO                 12150000
         XC    UCMMLAST(N4),UCMMLAST   ZERO MINOR PTR                   12200000
NOTMLW   EQU   *                                                        12250000
         LH    R6LENGTH,WMJMTXTL   TEXT LENGTH IN WQE         MB Y02958 12300000
         LA    R6LENGTH,WQETXT(R6LENGTH) END OF TEXT TO WRITE MB Y02958 12350000
         LA    R5WQETXT,WQERR      LOCATE HARDCOPY TEXT       MB Y02958 12400000
         TM    CQEFLAG,CQEMLQHC    HARDCOPY FORMAT            MB Y02958 12440000
         BO    FOUND1              SET UP CCW                 MB Y02958 12480000
         LA    R5WQETXT,WQETXT     LOCATE NORMAL TEXT         MB Y02958 12520000
         TM    UCMDISP2,UCMDISPI+UCMDISPJ TEXT MODIFIED       MB Y02958 12560000
         BZ    FOUND1              NO, SET UP CCW             MB Y02958 12600000
         LA    R5WQETXT,WQETS      LOCATE TIME STAMP          MB Y02958 12640000
         TM    UCMDISP2,UCMDISPI   WRITE FROM TIME STAMP      MB Y02958 12740000
         BO    FOUND1              YES, SET UP CCW            MB Y02958 12780000
         LA    R5WQETXT,WQEJOBNM   LOCATE JOBNAME             MB Y02958 12820000
FOUND1   ST    R5WQETXT,DMCWRITE   POINT CCW TO TEXT          MB Y02958 12900000
         SR    R6LENGTH,R5WQETXT   GET LENGTH TO WRITE        MB Y02958 12940000
         STH   R6LENGTH,DMCWNBR    INSERT BYTE COUNT                    12980000
         SR    R7WORK,R7WORK       STORE ZEROS                          13020000
         ST    R7WORK,UCMECB       INTO THE ECB                         13100000
         OI    UCMSTS,UCMBF        INDICATE CONSOLE BUSY                13140000
         L     RFWORK,CSAXC        ADDRESS FREELOCK SUBROUTNE MB Y02958 13180000
         LR    R1PARM,R2CXSA       PASS CXSA ADDRESS          MB Y02958 13220000
         BALR  RERTRN,RFWORK       RELEASE LOCKS FOR EXCP     MB Y02958 13300000
         EXCP  DMIOB               GET THE IO STARTED         MB Y02958 13340000
         L     RERTRN,CSAXA                                   MB Y02958 13380000
         BR    RERTRN              DONE FOR NOW                         13420000
         SPACE 5                                                        13460000
PMLW3    EQU   *                                                        13530000
         L     RDQUEUE,UCMWLAST    GET LIST POINTER                     13600000
         L     R3WQE,UCMMLAST      MINOR HALF TO BE WRITTEN             13650000
         SR    R6LENGTH,R6LENGTH   CLEAR LENGTH REG                     13700000
         IC    R6LENGTH,WMNMTL1    GET TEXT LENGTH                      13750000
         LTR   R6LENGTH,R6LENGTH   ZERO LENGTH, NULL LINE               13800000
         BZ    PMFWQE              YES, HANDLE AS I/O COMPLETE          13850000
         LA    R5WQETXT,WMNMTXT1   POINT TO REGULAR TEXT                13900000
         AR    R6LENGTH,R5WQETXT   END OF TEXT TO WRITE       MB Y02958 13950000
         TM    CQEFLAG,CQEMLQHC    HARDCOPY CONSOLE MESSAGE   MB Y02958 14000000
         BNO   FOUND1              NO, WRITE LINE             MB Y02958 14050000
         LA    R5WQETXT,WMNMHCT1   POINT TO TEXT                        14100000
         B     FOUND1              WRITE LINE                           14150000
OPEN     EQU   *                                                        14200000
         L     R6WORK,UCMUCB       GET UCB ADDRESS                      14250000
         USING UCBOB,R6WORK                                             14300000
         TM    UCBSTAT,UCBALOC     IS DEVICE IN ALLOCATION              14350000
         BO    EXIT                YES RETURN                           14400000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDRESS                 14440000
         BZ    OPNO                IF NONE, SKIP SETUP                  14480000
         USING PARMLIST,R6WORK     PARMLIST ADDRESSABILITY              14520000
         OI    PARMFTPT,UCMTA      INDICATE OPENING                     14560000
         DROP  R6WORK                                                   14600000
OPNO     EQU   *                                                        14660000
         L     RFWORK,CSAXC      ADDRESS FREELOCK SUBROUTINE            14720000
         LR    R1PARM,R2CXSA     CXSA ADDRESS IN REG 1                  14800000
         BALR  RERTRN,RFWORK     RELEASE LOCKS FOR SVC'S                14820000
       GETMAIN R,SP=255,LV=DMCORE                                       14860000
         LR    R9DCB,R1PARM                                             14910000
         ST    R9DCB,UCMDCB        STORE DCB ADDRESS IN UCM             14960000
         USING IHADCB,R9DCB                                             15010000
         MVC   IHADCB(DMCORE),DMDCB                                     15060000
*                                      RELOCATE POINTERS.               15110000
         MVI   DMCREAD,0            *** GRAPHICS BYTE                   15160000
         EJECT                                                          15210000
         GETMAIN R,SP=255,LV=PNCORE                                     15260000
         LR    R8WORK,R1PARM       BASE OPEN BLOCKS.                    15310000
         USING PNOPEND,R8WORK                                           15360000
         XC    PNOPEND(PNCORE),PNOPEND                                  15410000
         SR    R1PARM,R1PARM       CLEAR FOR IC INSTRUCTION             15460000
         IC    R1PARM,UCMID        GET CONSOLE I.D. IN BINARY           15510000
         CVD   R1PARM,PNWORKD      CONVERT TO PACKED DECIMAL            15560000
         UNPK  PNWORKD(N5),PNWORKH4(N3)                                 15610000
         MVC   DCBDDNAM(L'BASENAM),BASENAM CONSTANT PART OF DDNAME      15660000
         MVC   DCBDDNAM+L'BASENAM(N3),PNWORKD REST OF NAME              15710000
         MVC   JFCBDSNM(L'PNDSN),PNDSN                                  15760000
         MVC   JFCBDSNM+8(36),JFCBDSNM+7                                15810000
         OI    JFCBTSDM,JFCTTR+JFCNWRIT+JFCNDSCB+JFCNDCB+JFCPAT         15900000
         LA    R7WORK,JFCB                                              15940000
         STCM  R7WORK,M7,PNXLST+N1                                      15980000
         OI    PNXLST,LASTNTRY+EXITJFCB                                 16020000
         LA    R7WORK,PNXLST                                            16060000
         STCM  R7WORK,M7,DCBEXLST+N1                                    16150000
         EJECT                                                          16200000
         OPEN  ((R9DCB),INOUT),TYPE=J,MF=(E,PNJEF)                      16250000
         LR    R1PARM,R8WORK       OPEN BLOCKS PTR.                     16300000
         FREEMAIN R,SP=255,LV=PNCORE,A=(1)                              16320000
         DROP  R8WORK                                                   16400000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDRESS                 16450000
         BZ    OPENRCVR            IF NONE, SKIP SETUP                  16500000
         USING PARMLIST,R6WORK     PARMLIST ADDRESSABILITY              16550000
         NI    PARMFTPT,N255-UCMTA      INDICATE OPENED                 16570000
         DROP  R6WORK                                                   16608000
OPENRCVR EQU   *                                                        16700000
         XC    DCBEXLST+N1(N3),DCBEXLST+N1                              16750000
         L     RFWORK,CSAXB      ADDRESS GETLOCK SUBROUTINE             16800000
         LR    R1PARM,R2CXSA       PASS CXSA ADDRESS IN REG 1           16850000
         BALR  RERTRN,RFWORK       OBTAIN LOCKS TO RESET UCM            16900000
         L     R6WORK,UCMUCB       POINT TO UCB                         16950000
         USING UCBOB,R6WORK                                             17000000
         L     R6WORK,UCBEXTPT     BASE UCB EXTENSION                   17050000
         USING UCBCMEXT,R6WORK                                          17100000
         MVC   DMXATI(N1),UCBATI   SAVE ATTN INDEX                      17150000
         MVI   UCBATI,0            ZERO ATTENTION INDEX FOR PRINTER     17200000
         MVI   DCBIFLGS,0          USE STD ERP                          17250000
         OI    UCMATR,UCMUF        TURN ON ACTIVE BIT                   17300000
         NI    UCMSTS,N255-UCMTA   TURN OFF OPEN PENDING                17330000
         LA    R3WORK,DMIOB        PUT IOB POINTER                      17400000
         ST    R3WORK,DCBIOBAD     IN DCB                               17450000
         LA    R3WORK,UCMECB       PUT ECB POINTER                      17500000
         ST    R3WORK,DMIECBP      IN IOB                               17550000
         LA    R3WORK,DMCTRA       PUT CCW AREA POINTER                 17600000
         ST    R3WORK,DMICPA       IN IOB                               17650000
         ST    R9DCB,DMIDCB        PUT DCB POINTER IN IOB               17700000
         MVI   DMXEM,EMCHAR        END-OF-MESSAGE CHARACTER             17750000
         MVI   DMXWCC,WCCHAR       WRITE-CONTROL CHARACTER              17800000
         MVC   DMCTRA(N8),MODELCCW INITIALIZE THE ENTIRE                17850000
         MVC   DMCWRITE(N16),DMCTRA CCW AREA                            17900000
         LA    R3WORK,DMXWCC       LOCATE WRITE CONTROL CHAR            17950000
         STCM  R3WORK,M7,DMCTRA+N1 WRITE-CTL-CHAR CCW BUILT             18000000
         LA    R3WORK,DMXEM        ADDRESS END OF MSG CHAR              18050000
         STCM  R3WORK,M7,DMCNOP+N1 IN LAST CCW                          18100000
         MVI   DMCNOP+N4,0         KILL CHAINING                        18150000
         TM    DCBOFLGS,DCBOFOPN   OPEN SUCCESSFULL                     18200000
         BNO   SWITCHEX            NO,CALL CONSOLE SWITCH               18250000
         B     TESTBUSY            SEE IF OUTPUT IS READY               18300000
         SPACE 5                                                        18350000
CLOSE    EQU   *                                                        18400000
         LTR   R9DCB,R9DCB         IS A DCB PRESENT                     18450000
         BZ    ENDCLS              NO, EXIT                             18500000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDRESS                 18550000
         BZ    CLSNO               IF NONE, SKIP SETUP                  18600000
         USING PARMLIST,R6WORK     PARMLIST ADDRESSABILITY              18650000
         OI    PARMFTPT,UCMCF      INDICATE CLOSING                     18700000
         DROP  R6WORK                                                   18750000
CLSNO    EQU   *                                                        18800000
         L     R6WORK,UCMUCB       GET UCB ADDRESS                      18850000
         USING UCBOB,R6WORK                                             18900000
         L     R6WORK,UCBEXTPT            BASE UCB EXTENSION            18940000
         USING UCBCMEXT,R6WORK                                          18980000
         MVC   UCBATI,DMXATI  RESTORE ATTENTION TABLE INDEX             19020000
         DROP  R6WORK                                                   19060000
         MVI   DMX4,DMX4C          INDICATE END OF REMOTE PARMLIST      19100000
         L     RFWORK,CSAXC        ADDRESS FREELOCK SUBROUTINE          19140000
         LR    R1PARM,R2CXSA       CXSA ADDRESS IN REG 1                19180000
         BALR  RERTRN,RFWORK       RELEASE LOCKS FOR SVC'S              19220000
         LA    R1PARM,DMX4                                              19260000
         CLOSE   ((R9DCB)),MF=(E,(1))                                   19300000
         LR    R1PARM,R9DCB                                             19340000
         FREEMAIN R,SP=255,LV=DMCORE,A=(1)                              19380000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDR          JE YM6718 19550000
         BZ    ENDCLS              NOT TEHER, BYPASS          JE YM6718 19580000
         NI    PARMFTPT-PARMLIST,XFF-UCMCF TURN OFF CLOSE PENDJE YM6718 19650000
ENDCLS   EQU   *                                                        19700000
         L     RFWORK,CSAXB      ADDRESS GETLOCK SUBROUTINE             19720000
         LR    R1PARM,R2CXSA       PASS CXSA ADDRESS IN REG 1           19800000
         BALR  RERTRN,RFWORK     OBTAIN LOCKS TO RESET UCM              19850000
         XC    UCMECB,UCMECB           CLEAR ECB.                       19900000
         XC    UCMDCB,UCMDCB           CLEAR DCB PTR.                   19920000
         NI    UCMSTS,N255-UCMBF-UCMCF  NOT BUSY, CLOSED                20000000
         L     RERTRN,CSAXA            RESTORE RETURN REG.              20030000
         L     R6WORK,UCMUCB           GET TO ASSOCIATED UCB            20100000
         USING UCBOB,R6WORK                                             20150000
         LR    R3WORK,R2CXSA       SAVE CSA PTR SINCE NIL MACRO        *20200000
                                   CLOBBERS GPR 2             JE YM8416 20250000
         TM    UCBSTAT,UCBCHGS                                          20300000
         BZ    DEVSTAT                                                  20350000
*                                                                       20400000
*  WARNING --- NIL MACRO CLOBBERS GPRS 0, 1, 2                JE YM8416 20450000
*                                                                       20500000
         NIL   UCBSTAT,N255-UCBONLI-UCBCHGS-UCBALOC-UCBSYSR-UCBDADI,REF*20550000
               =UCBOB                                                   20600000
         B     CONTINUE                                                 20650000
DEVSTAT  NIL   UCBSTAT,N255-UCBALOC-UCBSYSR-UCBDADI,REF=UCBOB           20700000
CONTINUE NI    UCMATR,N255-UCMAT04-UCMUF                                20750000
         LR    R2CXSA,R3WORK       RESTORE CSA PTR SINCE NIL MACRO     *20800000
                                   CLOBBERS GPR 2             JE YM8416 20850000
EXIT     EQU   *                                                        20900000
         L     RERTRN,CSAXA        RESTORE RETURN ADDRESS               20950000
         LR    R1PARM,R2CXSA       CXSA ADDRESS IN REG 1                21000000
         L     RFWORK,CSAXC        ADDRESS FREELOCK ROUTINE             21050000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDR          JE YM6718 21100000
         BZ    EXIT1               NOT TEHER                  JE YM6718 21150000
         USING PARMLIST,R6WORK                                          21200000
         MVC   PARMRTAD(8),CSANAME RESTORE FIELD              JE YM6718 21250000
EXIT1    MVC   CSANAME(8),UCMNAME  MODULE NAME                JE YM6718 21300000
         BR    RFWORK              RELEASE LOCKS AND EXIT               21350000
SWITCHEX EQU   *                                                        21400000
         MVI   CSACODE,0           INDICATE CONSOLE SWITCH              21450000
OPENSWCH EQU   *         CALL TO SWITCH AFTER OPEN                      21500000
         LR    R1PARM,R2CXSA       PASS CXSA IN REG 1                   21550000
         L     RFWORK,CSAXC        ADDRESS FREELOCK SUBROUTINE          21600000
         BALR  RERTRN,RFWORK       RELEASE LOCKS                        21650000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDR          JE YM6718 21700000
         BZ    SWCHNO              NOT THERE                  JE YM6718 21750000
         MVC   PARMRTAD(8),CSANAME RESTORE FILED              JE YM6718 21800000
SWCHNO   MVC   CSANAME(8),UCMNAME  MODULE NAME                JE YM6718 21850000
         MVC   CSANAME+N3(N2),PMXTRNL ADJUST NAME IN CXSA               21900000
         L     RERTRN,CSAXA        RESTORE RETURN ADDRESS               21950000
         L     RFWORK,UCMSWCH      SWITCH ENTRY POINT                   22000000
         BR    RFWORK              CALL CONSOLE SWITCH                  22050000
         EJECT                                                          22100000
*                                                                       22150000
*        IEECVETW ESTAE RECOVERY ROUTINE                                22200000
*                                                                       22250000
ETWRTY   DS    0D                                                       22300000
         BALR  RFWORK,0            SET BASE                   JE YM6718 22350000
         USING *,RFWORK                                       JE YM6718 22400000
         L     RCBASE,ETWAD        GET REAL BASE              JE YM6718 22450000
         USING ETWBASE,RCBASE      TELL ASSEMBLER             JE YM6718 22500000
         DROP  RFWORK                                                   22550000
         USING PSA,0               ADDRESS LOW CORE           JE YM6718 22600000
         L     RFWORK,PSATOLD      GET TCB ADDRESS            JE YM6718 22650000
         DROP  0                                                        22700000
         USING TCB,RFWORK                                     JE YM6718 22750000
         L     RFWORK,TCBRBP       MY SVRB ADDR               JE YM6718 22800000
         USING RBSECT,RFWORK                                            22850000
         LA    R2CXSA,RBEXSAVE     RESOTRE CXSA ADDR        JE @ZA00539 22900000
         DROP  RFWORK                                                   22950000
         L     RBUCME,CSAUCM       RESTORE UCME ADDR          JE YM6718 23000000
         L     RAUCM,CSACTLM       RESTORE UCM BASE           JE YM6718 23050000
         L     R9DCB,UCMDCB        RESTORE DCB BASE           JE YM6718 23100000
         ICM   R6WORK,MF,CSANPTR   GET PARMLIST ADDR          JE YM6718 23150000
         BZ    SWITCHEX            NOT THER GET OUT           JE YM6718 23200000
         USING PARMLIST,R6WORK                                          23250000
*                                                                       23300000
         TM    PARMFTPT,UCMTA      OPEN PENDING               JE YM6718 23350000
         BNO   TRYCLOSE            NO, TEST CLOSE             JE YM6718 23400000
         MVI   PARMFTPT,0          CLEAR FOOTPRINTS           JE YM6718 23450000
         LTR   R9DCB,R9DCB         ANY DCB THERE              JE YM6718 23500000
         BZ    SWITCHEX            NO, SWITCH CONSOLES        JE YM6718 23550000
         B     OPENRCVR            YES, CONTINUE OPEN         JE YM6718 23600000
*                                                                       23650000
TRYCLOSE TM    PARMFTPT,UCMTC      CLOSE PENDING              JE YM6718 23700000
         BNO   TRYBUSY             NO, TEST FOR EXCP          JE YM6718 23750000
         MVI   PARMFTPT,0          CLEAR FOOTPRINTS           JE YM6718 23800000
         B     ENDCLS              GO CLEANUP CLOSE           JE YM6718 23850000
*                                                                       23900000
TRYBUSY  TM    UCMSTS,UCMBF       EXCP IN PROCESS             JE YM6718 23950000
         BNO   SWITCH              NO, SWITCH CONSOLES         @ZA08139 24000000
         NI    UCMSTS,XFF-UCMBF    TURN OFF BUSY              JE YM6718 24050000
         NI    UCMDEVC,XFF-UCMDEVE TURN OFF I/O COMPLETE     JE @YM8452 24100000
SWITCH   B     SWITCHEX            SWITCH CONSOLES             @ZA08139 24150000
*                                                                       24200000
*********************************************************************** 24250000
*                                                                       24300000
*      FIVE LINES OF CODE DELETED HERE TO FORCE IEECVETW TO    @ZA08139 24350000
*      SWITCH CONSOLES AFTER ANY ERROR CONDITION THAT          @ZA08139 24400000
*      PREVIOUSLY CAUSED RETURN TO IEAVVCTR WITHOUT CLEANING   @ZA08139 24420000
*      UP THE ERROR CONDITION.                                          24500000
*********************************************************************** 24550000
         EJECT                                                          24600000
*                                                                       24650000
*        OBTAIN LOCKS SUBROUTINE                                        24700000
*                                                                       24750000
GETLOCK  EQU   *                                                        24800000
         USING *,RFWORK          SUBROUTINE ADDRESSABILITY BASED ON     24850000
*                                  ENTRY REGISTER                       24860000
         DROP  R2CXSA              DROP OLD CXSA BASE                   25360000
         USING CXSA,R1PARM         REG 1 ADDRESSES THE CXSA AS          25860000
*                                  AN INPUT PARAMETER                   26360000
         STM   11,14,CSAXB         SAVE REGS OVER SETLOCK CALL          26860000
GETLOCL  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        *27360000
               RELATED=(WQE,IEECVETW(FREELOCL))                         27860000
GETCMS   SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          *28360000
               RELATED=(UCM,IEECVETW(FREECMS))                          28860000
         L     RAUCM,CSACTLM       GET UCM                    JE YM6718 29360000
         L     11,UCMFRRAD         GET FRR ADDR               JE YM6718 29860000
         USING PSA,0                                                    30360000
GETFRR   SETFRR A,FRRAD=(11),PARMAD=(13),WRKREGS=(12,13),              *30860000
               RELATED=(CMSLOCK,IEECVETW(FREEFRR))            JE YM6718 31360000
         ST    13,CSADCBP                                     JE YM6718 31860000
         USING PARMLIST,13                                              32360000
         ICM   12,15,CSANPTR       GET ESTAE PARMLIST PTR    JE @YM8452 32860000
         BZ    FRRA                NOT THERE                 JE @YM8452 33360000
         MVC   PARMLIST(PARMSIZE),0(12) COPY ESTAE PARMLIST TO         *33860000
                                   FRR PARMLIST              JE @YM8452 34360000
FRRA     MVC   PARMID,SVC72ID                                 JE YM6718 34860000
         LM    11,14,CSAXB         RESTORE REGS AFTER SETLOCK           35360000
GETEXIT  MVC   CSAXB(N8),OBTAINED  RESET SUBROUTINE ADDRESSES           35860000
         LR    RFWORK,RERTRN     COPY EXIT ADDRESS                      36360000
         BR    RERTRN              EXIT FROM GETLOCK SUBROUTINE         36860000
         SPACE 5                                                        37360000
*                                                                       37860000
*        RELEASE LOCKS SUBROUTINE                                       38360000
*                                                                       38860000
FREELOCK EQU   *                                                        39360000
         USING *,RFWORK          SUBROUTINE ADDRESSABILITY BASED ON     39860000
*                                  ENTRY REGISTER                       40360000
         USING CXSA,R1PARM         REG 1 ADDRESSES THE CXSA AS          40860000
*                                  AN INPUT PARAMETER                   41360000
         STM   11,14,CSAXB         SAVE REGS OVER SETLOCK CALL          41860000
FREEFRR  SETFRR D,WRKREGS=(12,13),RELATED=(CMSLOCK,IEECVETW(GETFRR))    42360000
*                                                             JE YM6718 42860000
         XC    CSADCBP,CSADCBP     CLEAR                      JE YM6718 43360000
FREECMS  SETLOCK RELEASE,TYPE=CMS,                                     *43860000
               RELATED=(UCM,IEECVETW(GETCMS))                           44360000
FREELOCL SETLOCK RELEASE,TYPE=LOCAL,                                   *44860000
               RELATED=(WQE,IEECVETW(GETLOCL))                          45360000
         LM    11,14,CSAXB         RESTORE REGS AFTER SETLOCK           45860000
FREEXIT  MVC   CSAXB(N8),RELEASED  RESET SUBROUTINE ADDRESSES           46360000
NOOPLOCK LR    RFWORK,RERTRN     COPY EXIT ADDRESS                      46860000
         BR    RERTRN              EXIT FROM FREELOCK SUBROUTINE        47360000
         SPACE 5                                                        47860000
*                                                                       48360000
*   CONSTANTS                                                           48860000
*                                                                       49360000
RELEASED DC    A(GETLOCK)                                               49860000
OBTAINED DC    A(NOOPLOCK)                                              50360000
         DC    A(FREELOCK)                                              50860000
         EJECT                                                          51360000
**************** CONSTANTS *******************                          51860000
MODELCCW CCW   ERWRIT,0,CHAINDT,N1                                      52360000
BASENAM  DC    C'IEAVM'            CONSTANT PART OF CONSOLE DDNAME      52860000
PMXTRNL  DC    CL2'04'             EXTERNAL PROCESSOR NAME.             53360000
PNDSN    DC    C'CONSOLE '         DSNAME FOR JFCB                      53860000
SVC72ID  DC    CL4'VCTR'        SVC 72 ID                     JE YM6718 54360000
ETWAD    DC    A(ETWBASE)                                               54860000
         EJECT                                                          55360000
**************** EQUATES *********************                          55860000
EMCHAR   EQU   X'19'               END-OF-MESSAGE CHARACTER             56360000
WCCHAR   EQU   X'C8'               WRITE-CONTROL CHARACTER              56860000
CHAINDT  EQU   X'80'               CHAIN DATA FLAG                      57360000
COUNT    EQU   7                   DISP TO COUNT FIELD IN CCW           57860000
ERWRIT   EQU   X'05'               ERASE-WRITE CCW CODE                 58360000
FLAGS    EQU   4                   DISP TO FLAG FIELD IN CCW            58860000
FOURMULT EQU   2                   MULTIPLY BY FOUR                     59360000
GOODIO   EQU   X'7F'               POST CODE FROM IOS                   59860000
IOCOMP   EQU   X'40'               POST CODE FROM IOS                   60360000
NEXT     EQU   16                  DISP TO NEXT VARIABLE CCW            60860000
NOTHING  EQU   X'00'               NULL                                 61360000
N1       EQU   1                   NUMBER                               61860000
N2       EQU   2                   NUMBER                               62360000
N3       EQU   3                   NUMBER                               62860000
N4       EQU   4                   NUMBER                               63360000
N5       EQU   5                   NUMBER                               63860000
N8       EQU   8                   NUMBER                               64360000
N11      EQU   11                  NUMBER                               64860000
N12      EQU   12                  NUMBER                               65360000
N16      EQU   16                  NUMBER                               65860000
N20      EQU   20                  NUMBER                               66360000
N24      EQU   24                  NUMBER                               66860000
N120     EQU   120                 NUMBER                               67360000
N128     EQU   128                 NUMBER                               67860000
N255     EQU   255                                                      68360000
M7       EQU   7                   STORE CHARACTER MASK       MB Y02958 68860000
MF       EQU   15                  INSERT CHARACTER MASK                69360000
XFF      EQU   X'FF'                                                    69860000
         TITLE 'IEECVETW     DATA CONTROL BLOCKS'                       70360000
         IEEUCDX                                                        70860000
DMXATI   EQU   DMX+1               FOR SAVING UCBATI                    71360000
DMXEM    EQU   DMX+2               END OF MESSAGE CHARACTER             71860000
DMXWCC   EQU   DMX+3               WRITE CONTROL CHARACTER              72360000
         TITLE 'IEECVETW                   OPEN-JFCB'                   72860000
*                       DEFINITION OF DYNAMIC CORE FOR CONSOLE OPEN,    73360000
PNOPEND  DSECT                                                          73860000
JFCB     DS    0D                                                       74360000
         IEFJFCBN ,                                                     74860000
*                            OPENJ E-FORM SLOT.                         75360000
PNJEF    DC    X'80'              LAST ENTRY.                           75860000
         DC    AL3(0)             DCB PTR.                              76360000
         SPACE                                                          76860000
*                            OPENJ JFCB EXLST PTR.                      77360000
LASTNTRY EQU   X'80'               LAST ENTRY                           77860000
EXITJFCB EQU   X'07'               JFCB CODE                            78360000
PNXLST   DC    X'87'              LAST ENTRY AND JFCB 07 CODE.          78860000
         DC    AL3(0)                   JFCB PTR. DCBEXLST PTS HERE.    79360000
PNWORKD  DC    D'0'                DOUBLE WORD FOR CVD                  79860000
         ORG   PNWORKD+6                                                80360000
PNWORKH4 DC    H'0'                LAST HALFWORD                        80860000
PNWORKX  DC    X'0'                EXTRA BYTE FOR UNPK                  81360000
PNCORE   EQU   *-PNOPEND            DYNAMIC CORE REQIREMENT.            81860000
         TITLE 'IEECVETW                OPEN/CLOSE   UCB'               82360000
UCBD     DSECT                                                          82860000
         IEFUCBOB                                                       83360000
         TITLE 'IEECVETW               CONSOLE QUEUE ENTRY'             83860000
         IHACTM  CQE                                                    84360000
         TITLE 'IEECVETW               ESTAE RECOVERY WORKAREA'         84860000
         IHACTM  FTPT                                                   85360000
         TITLE 'IEECVETW          COMM TASK EXTENDED SAVE AREA'         85860000
         IHACTM  CXSA                                                   86360000
         TITLE 'IEECVETW                  FRR MAPPING'                  86860000
         IHAFRRS                                                        87360000
         TITLE 'IEECVETW                  WQE'                          87860000
         IHAWQE  DSECT=YES                                              88360000
         TITLE 'IEECVETW                  UCM'                          88860000
         IEECUCM  FORMAT=NEW                                            89360000
         TITLE 'IEECVETW            PREFIXED SAVE AREA'                 89860000
         IHAPSA                                                         90360000
         EJECT                                                          90860000
         IKJTCB                                                         91360000
         EJECT                                                          91860000
         IHARB   DSECT=YES                                              92360000
          END                                                           92860000
