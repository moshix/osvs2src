         TITLE 'IEECVFTG           CLEANUP MODULE'                      00050002
IEECVFTG CSECT                                                          00100002
*C138500,139000                                               MH Y01274 00102002
*C138500,153500,155000                                       MC SA52539 00110002
*C140000,144500                                              MC SA52721 00120002
*D170500                                                     MC SA52721 00130002
*/*IEECVFTG: CHART */                                                   00150002
*/*%START: E (,BEGIN) IEECVFTG */                                       00200002
         SPACE 2                                                        00250002
* THIS ROUTINE WAS CREATED FOR STATUS DISPLAY SUPPORT, LINE ITEM 21002, 00300002
*    OS RELEASE 21                                                      00350002
         SPACE 2                                                        00400002
* STATUS -- CHANGE LEVEL 0                                              00450002
*                                                                       00500002
* FUNCTION -- CLEANUP ROUTINE WHEN DEVICE CHANGES STATUS                00550002
*    1) DEVICE IS BEING CLOSED - FREES ALL MESSAGES ON QUEUE            00600002
*    2) DEVICE IS CHANGING USE TO                                       00650002
*       A) MESSAGE STREAM - FREES OUT OF LINE MESSAGES                  00700002
*       B) STATUS DISPLAY - FREES INLINE AND OUT OF LINE MSGS           00750002
*       C) FULL CAPABILITY - FREES OUT OF LINE MESSAGES                 00800002
*    3) DEVICE IS RECOVERING FROM AN ASYNCHRONOUS ERROR - FREES         00850002
*       OUT OF LINE MESSAGES, LEAVING ANY MONITOR GOING, AND            00900002
*       LEAVING AREA DEFINITION ALONE                                   00950002
*    4) WHENEVER OUT OF LINE MSGS ARE FREED, EXCEPT ON                  01000002
*       ASYNCHRONOUS ERROR, ANY DYNAMIC DISPLAY IS STOPPED,             01050002
*       ANY GETMAINED SACB IS FREED, AND THE AREA DEFINITION IS         01100002
*       RESET TO SYSGEN VALUE                                           01150002
*                                                                       01200002
* ENTRY POINT -- IEECVFTG                                               01250002
*                                                                       01300002
* INPUT                                                                 01350002
*    1) REGISTER 1 - POINTER TO CXSA                                    01400002
*                                                                       01450002
* OUTPUT                                                                01500002
*    1) REGISTER 1 - POINTER TO CXSA                                    01550002
*                                                                       01600002
* EXTERNAL REFERENCES -- FREEMAIN, SVC 34                               01650002
*                                                                       01700002
* EXITS,NORMAL                                                          01750002
*    1) IEECVET1 - PROCESSOR 1, IF HANDLING CLOSE                       01800002
*    2) IEECVETC - ASYNCHRONOUS ERROR, IF HANDLING A CHANGE IN          01850002
*       STATUS OR AN ASYNCHRONOUS ERROR                                 01900002
*                                                                       01950002
* EXITS,ERROR                                                           02000002
*    IEECVET1 - PROCESSOR 1                                             02050002
*                                                                       02100002
* TABLES/WORK AREAS                                                     02150002
*    1) UNIT CONTROL MODULE (UCM)                                       02200002
*    2) TRANSIENT PORTION OF THE DISPLAY CONTROL MODULE (DCM)           02250002
*    3) RESIDENT PORTION OF THE DISPLAY CONTROL MODULE                  02300002
*       (INCLUDING SCREEN AREA CONTROL BLOCKS - SACB'S)                 02350002
*                                                                       02400002
* ATTRIBUTES -- REFRESHABLE, PRIVILEGED, TYPE 4 SVC                     02450002
*    DISABLED WHEN DECREMENTING USE COUNTS OF MINOR WQE'S               02500002
*                                                                       02550002
* CHARACTER CODE DEPENDENCY -- THE OPERATION OF THIS MODULE DOES        02600002
*    NOT DEPEND ON A PARTICULAR INTERNAL REPRESENTATION OF THE          02650002
*    EXTERNAL CHARACTER SET                                             02700002
         EJECT                                                          02750002
* REGISTER USAGE                                                        02800002
X1PARM   EQU   1                                                        02810002
XERTRN   EQU   14                                                       02812002
XFBRANCH EQU   15                                                       02820002
R0       EQU   0                   REG 0                                02850002
R1       EQU   1                   REG 1                                02900002
WORKR    EQU   1                   WORK REG                             02950002
WORK2    EQU   2                   WORK REG                             03000002
WORK3    EQU   3                   WORK REG                             03050002
WORK4    EQU   4                   WORK REG                             03100002
WORK1    EQU   5                   WORK REG                             03150002
RDCMBASE EQU   6                   RESIDENT PORTION OF DCM BASE         03200002
SACBBASE EQU   7                   SCREEN AREA CONTROL BLOCK BASE       03250002
X7ASCB   EQU   7                   ASCB ADDRESS FOR FREEMAIN  MB YM4086 03260002
TDCMBASE EQU   8                   TRANSIENT PORTION OF DCM BASE        03300002
OUTQREG  EQU   9                   POINTER TO CONSOLE OUTPUT           X03350002
                                        QUEUE ENTRY                     03400002
UCMEBASE EQU   10                  UCM ENTRY BASE                       03450002
WQEBASE  EQU   11                  WQE BASE                             03500002
MYBASE   EQU   12                  BASE REG FOR THIS MODULE             03550002
CXSABASE EQU   13                  CXSA BASE                            03600002
RETURNR  EQU   14                  RETURN REG                           03650002
LINKR    EQU   14                  FIRST LEVEL LINK REG                 03700002
LINK1    EQU   15                  SECOND LEVEL LINK REG                03750002
R15      EQU   15                  XCTL REG                             03800002
         EJECT                                                          03850002
*/*BEGIN: P ESTABLISH ADDRESSABILITY */                                 03900002
         SPACE                                                          03950002
         BALR  MYBASE,E0           BASE                                 04000002
         USING *,MYBASE                 THIS MODULE                     04050002
         B     BEGIN               BRANCH AROUND PATCH AREA             04100002
ICATCH   DC    C'IEECVFTG'         EYECATCHER AND FIELD MAINTENANCE     04150002
         DC    CL8'&SYSDATE',CL56' '                                    04160002
BEGIN    EQU   *                                                        04200002
         LR    CXSABASE,R1         GET CXSA ADDRESS                     04250002
         USING CXSA,CXSABASE       BASE CXSA                            04300002
         L     UCMEBASE,CSAUCM     GET ADDRESS OF UCM ENTRY             04350002
         USING UCMLIST,UCMEBASE    BASE UCM ENTRY                       04400002
         L     RDCMBASE,UCMXB      GET ADDRESS OF RESIDENT DCB          04450002
         USING DCMTSRT,RDCMBASE      BASE RESIDENT DCM                  04500002
         L     TDCMBASE,DCMADTRN   GET ADDRESS OF TRANSIENT DCM         04550002
         USING DCMSTRT,TDCMBASE      BASE TRANSIENT DCM                 04600002
         USING DCMACB,SACBBASE     BASE SACB'S                          04650002
         USING WQE,WQEBASE         BASE WQE'S                           04700002
         MVC   DCMTRACE(DCMTRLEN),DCMTRAC2 SHIFT OLD TRACE ENTRIES      04710002
         MVI   DCMTREN1,ID1        PUT CSECT ID INTO                    04720002
         MVI   DCMTREN2,ID2        NEW TRACE ENTRY                      04730002
         L     XFBRANCH,CSAXB      ADDRESS GETLOCK SUBROUTINE           04740002
         LR    X1PARM,CXSABASE     PASS CXSA ADDRESS IN REG 1           04742002
         BALR  XERTRN,XFBRANCH     OBTAIN LOCKS                         04744002
         SPACE 3                                                        04750002
* INITIALIZATION                                                        04800002
         SPACE                                                          04850002
         MVI   DCMUTILT,E0         ZERO OUT UTILITY BYTE                04950002
*    THE UTILITY BYTE IS USED AS FOLLOWS IN THIS MODULE:                05000002
*    DCMUTILA -- INDICATES FREE INLINE MESSAGES                         05050002
*    DCMUTILC -- INTERRUPTS HAVE BEEN DISABLED                          05100002
         EJECT                                                          05150002
* TEST TYPE OF CLEAN-UP REQUIRED                                        05200002
* 1) OUT OF LINE MESSAGES ARE ALWAYS FREED                              05250002
* 2) INLINE MESSAGES ARE FREED WHEN DEVICE IS CLOSING OR                05300002
*    CHANGING TO STATUS DISPLAY USE                                     05350002
         SPACE 2                                                        05400002
TESTTYPE EQU   *                                                        05450002
*/*TESTTYPE: D (YES,%INDFRIN,NO,TEST2) CLOSE IN PROGRESS */             05500002
         TM    DCMR3FLG,DCMCLPR    Q. CLOSE IN PROGRESS                 05550002
         BNO   TEST2               NO, GO TO NEXT TEST                  05600002
*/*%INDFRIN: P (,STOPMN) INDICATE FREE INLINE MESSAGES */               05650002
         OI    DCMUTILT,DCMUTILA   CLOSE - INDICATE FREE INLINE        X05700002
                                        MESSAGES                        05750002
         B     SACBSRCH            GO STOP ANY MONITOR                  05800002
         SPACE                                                          05850002
TEST2    EQU   *                                                        05900002
*/*TEST2: D (YES,%TSTSD,NO,TEST3) STATUS SWITCH */                      05950002
         TM    DCMCS,DCMCSO        Q. STATUS SWITCH                     06000002
         BNO   TEST3               NO, GO TO NEXT TEST                  06050002
*/*%TSTSD: D (YES,%INDFRIN,NO,STOPMN) TO STATUS DISPLAY */              06100002
         TM    UCMDISP,UCMDISPG    Q. TO STATUS DISPLAY                 06150002
         BNO   SACBSRCH            NO, GO STOP ANY MONITOR              06200002
         OI    DCMUTILT,DCMUTILA   TO SD - INDICATE FREE INLINE        X06250002
                                        MESSAGES                        06300002
         B     SACBSRCH            GO STOP ANY MONITOR                  06350002
         SPACE                                                          06400002
TEST3    EQU   *                                                        06450002
*/*TEST3: D (YES,SACBSRCH,NO,PROC1EXT) ASYNCHRONOUS ERROR */            06500002
         TM    DCMCOM2,DCMAE       Q. ASYNCHRONOUS ERROR                06550002
         BO    SACBSRCH            YES, GO SEARCH SACB'S                06600002
         SPACE                                                          06650002
         B     PROC1EXT            NO, THIS CONDITION SHOULD            06700002
*                                       NEVER OCCUR - MODULE WAS        06750002
*                                       ENTERED WITHOUT REASON.         06800002
*                                       GO TO PROCESSOR 1               06850002
         EJECT                                                          08350002
SACBSRCH EQU   *                                                        08400002
* THE SACB'S ARE SEARCHED AND HANDLED AS FOLLOWS:                       08450002
* 1) ANY WQE'S FOR OUT OF LINE DISPLAYS NOT COMPLETELY OUTPUT           08500002
*    ARE FREED                                                          08550002
* 2) ALL SACB'S ARE CLEANED UP                                          08600002
* 3) EXCEPT ON HANDLING AN ASYNCHRONOUS ERROR                           08650002
*    A) RESIDENT SACB'S ARE SET TO SYSGEN VALUES                        08700002
*    B) ANY GETMAINED SACB'S ARE FREED                                  08750002
* 4) ON AN ASYNCHRONOUS ERROR                                           08800002
*    A) SET UP FOR ANY MONITOR TO CONTINUE                              08850002
         SPACE                                                          08900002
*    WORK REGISTERS ARE USED AS FOLLOWS DURING THE SACB SEARCH          08950002
*        WORKR TEMPORARY USE ONLY                                       09000002
*        WORK1 SAVES SACB PTR WHEN WORKING WITH GETMAINED SACB'S        09050002
*        WORK2 PREVIOUS SACB POINTER                                    09100002
*        WORK3 LINE COUNTER TO FIND TOP LINE OF AREA                    09150002
*        WORK4 TEMPORARY USE ONLY                                       09200002
         SPACE 2                                                        09250002
*/*SACBSRCH: P (,SACBLOOP) INITIALIZE FOR SACB SEARCH */                09300002
         LH    WORK3,DCMMSGAL      GET NO. OF LINES IN MSG AREA         09350002
         LA    WORK3,E1(WORK3)     INCREASE NO. OF LINES BY ONE         09400002
         SR    WORK2,WORK2         CLEAR WORK2                          09450002
         SR    WORK1,WORK1         CLEAR WORK1                          09500002
         L     SACBBASE,DCMADSDS   GET POINTER TO FIRST SACB            09550002
SACBLOOP EQU   *                                                        09600002
*/*SACBLOOP: D (YES,%TSTDEF,NO,ENDSACBS) ANY MORE SACB'S */             09650002
         LTR   SACBBASE,SACBBASE   ANY MORE SACB'S                      09700002
         BZ    ENDSACBS            NO, BRANCH OUT OF SACB SEARCH        09750002
*/*%TSTDEF: D (YES,AREADEF,NO,%TSTAE1) AREA DEFINED HERE */             09800002
         TM    DCMASACB,DCMAUSE    Q. AREA DEFINED HERE                 09850002
         BO    AREADEF             YES, CLEAN UP SACB                   09900002
*/*%TSTAE1: D (YES,ENDSACBS,NO,TSTGM) HANDLING ASYNCHRONOUS ERROR */    09950002
         TM    DCMCOM2,DCMAE       Q. ASYNCHRONOUS ERROR                10000002
         BO    ENDSACBS            YES, GET OUT OF SACB SEARCH          10050002
         B     TSTGM               NO, GO REINITIALIZE AREA TO         X10100002
                                        SYSGEN DEFINITION               10150002
AREADEF  EQU   *                                                        10200002
*/*AREADEF: P (,AFTFREE1) FREE ANY WQE'S FOR ANY DISPLAY IN THE AREA */ 10250002
         L     WQEBASE,DCMATECB    STOP TRACK ECB             MB YM4086 10255002
         LTR   WQEBASE,WQEBASE     ANY ECB TO POST            MB YM4086 10265002
         BZ    NOPOST              NO, DONT POST              MB YM4086 10270002
         TM    E0(WQEBASE),X'40'   ALREADY POSTED             MB YM4086 10271002
         BZ    POST                NO, POST IT                MB YM4086 10272002
         XC    E1(E3,WQEBASE),E1(WQEBASE) ZERO COMPLETION CODE          10273002
         B     NOPOST              DONT POST                  MB YM4086 10274002
POST     SR    UCMEBASE,UCMEBASE   ZERO COMPLETION CODE       MB YM4086 10275002
         STM   MYBASE,CXSABASE,DCMDSAV SAVE REGS 12 AND 13    MB YM4086 10280002
         L     15,CVTPTR           BASE CVT                   MB YM4086 10285002
         USING CVTMAP,15                                                10290002
         L     15,CVT0PT01         POST ENTRY POINT           MB YM4086 10295002
         DROP  15                                                       10296002
         BALR  14,15               POST TRACK ECB             MB YM4086 10297002
         LM    MYBASE,CXSABASE,DCMDSAV RESTORE REGS           MB YM4086 10298002
         L     UCMEBASE,CSAUCM     RESTORE UCME BASE          MB YM4086 10299002
NOPOST   EQU   *                                                        10299202
         TM    DCMAFLG1,DCMADISP   Q. DISPLAY IN AREA                   10300002
         BNO   AFTFREE1            NO, BRANCH AROUND FREEING            10350002
         TM    DCMAFLG2,DCMAMJFR   Q. IS MAJOR FREED                    10400002
         BO    AFTFREE1            YES, BRANCH AROUND FREEING           10450002
         L     OUTQREG,DCMAMJWQ    GET OUTPUT QUEUE POINTER             10500002
         USING CQE,OUTQREG                                              10510002
         TM    DCMAFLG1,DCMADEND   Q. END OF DISPLAY ON SCREEN          10550002
         BNO   FINDNEXT            NO, GO FREE REMAINING MINORS         10600002
         LA    LINKR,AFTFREE1      YES, GO FREE MAJOR ONLY AND          10650002
         B     FREEMAJ                  RETURN TO AFTFREE1              10700002
         SPACE 2                                                        10750002
FINDNEXT EQU   *                                                        10800002
*    FIND NEXT MINOR TO BE OUTPUT                                       10850002
         TM    CQEFLAG,CQEATTOP    SHOULD MINOR SEARCH                 X10900002
                                        BEGIN AT TOP OF CHAIN           10950002
         BNO   GETSAVD1            NO, GO GET MINOR PTR SAVED           11000002
         LA    LINKR,AFTFREE1      YES, GO FREE MAJOR AND MINORS        11050002
         B     FREEMINT                 AND RETURN TO AFTFREE1          11100002
         SPACE                                                          11150002
GETSAVD1 EQU   *                                                        11200002
         L     WQEBASE,DCMAMIN     GET MINOR POINTER SAVED              11250002
         TM    DCMAFLG2,DCMALMIN   Q. LAST MINOR OUTPUT SAVED           11300002
         BNO   TSTZERO1            NO, GO CHECK POINTER                 11350002
         BAL   LINKR,GETNEXT       GET POINTER TO NEXT MINOR           X11400002
                                        TO BE OUTPUT                    11450002
         LA    LINKR,AFTFREE1      YES, GO FIND NEXT MINOR TO BE        11500002
         B     GETNEXT                  OUTPUT, FREE MAJOR AND         X11550002
                                        MINORS, AND RETURN TO          X11600002
                                        AFTFREE1                        11650002
TSTZERO1 EQU   *                                                        11700002
         LTR   WQEBASE,WQEBASE     Q. ANY POINTER SAVED                 11750002
         BNZ   USESAVD1            YES, GO START FROM POINTER          X11800002
                                        SAVED                           11850002
         LA    LINKR,AFTFREE1      NO, GO FREE MAJOR, AND MINORS        11900002
         B     FREMLWTO                 IF ANY,  AND RETURN TO         X11950002
                                        AFTFREE1                        12000002
         SPACE                                                          12050002
USESAVD1 EQU   *                                                        12100002
         BAL   LINKR,FREEMIN       GO FREE MAJOR, AND MINORS           X12150002
                                        STARTING FROM PTR SAVED         12200002
         EJECT                                                          12250002
AFTFREE1 EQU   *                                                        12300002
*/*AFTFREE1: D (YES,AECLEAN,NO,TSTGM) HANDLING ASYNCHRONOUS ERROR */    12350002
         TM    DCMCOM2,DCMAE       Q. ASYNCHRONOUS ERROR                12400002
         BO    AECLEAN             YES, CLEAN UP SACB, BUT LEAVE       X12450002
                                        AREA DEFINITION ALONE           12500002
TSTGM    EQU   *                                                        12550002
*/*TSTGM: D (YES,GMSACB,NO,RESSACB) GETMAINED SACB */                   12600002
         TM    DCMASACB,DCMAGM     Q. GETMAINED SACB                    12650002
         BO    GMSACB              YES, GO FREE SACB                    12700002
         SPACE 2                                                        12750002
RESSACB  EQU   *                   HANDLE RESIDENT SACB'S               12800002
* 1) IF MESSAGE STREAM CONSOLE, UNDEFINE ALL AREAS                      12850002
* 2) OTHERWISE, REINITIALIZE SACB'S TO SYSGEN VALUES                    12900002
*/*RESSACB: D (YES,UNDEFINE,NO,%INSACB) MESSAGE STREAM CONSOLE */       12950002
         TM    UCMDISP,UCMDISPF    Q. MESSAGE STREAM CONSOLE            13000002
         BO    UNDEFINE            YES, GO UNDEFINE AREA                13050002
*    REINITIALIZE SACB TO SYSGEN VALUES                                 13100002
*/*%INSACB: P (,%TSTTOP) REINITIALIZE SACB TO SYSGEN VALUES */          13150002
         LR    WORKR,SACBBASE      GET SACB ADDRESS                     13200002
         SH    WORKR,DCMACB-HALFWORD  SUBTRACT LENGTH OF PREFIX        X13250002
                                        TO GET PREFIX ADDRESS           13300002
         USING DCMPACB,WORKR       BASE PREFIX                          13350002
         LH    WORK4,DCMPLN        GET SYSGEN'D AREA LENGTH             13400002
         STH   WORK4,DCMALN             STORE IN SACB                   13450002
         DROP  WORKR                                                    13500002
         OI    DCMASACB,DCMAUSE    INDICATE AREA DEFINED                13550002
         SR    WORK3,WORK4         CALCULATE TOP LINE OF AREA           13600002
         LTR   WORK3,WORK3         Q. IS TOP LINE ON SCREEN             13650002
         BNP   SHRINK              NO, GO SHRINK AREA                   13700002
*/*%TSTTOP: D (YES,SHRINK,NO,NEXTSACB) TOTAL AREAS GREATER THAN MSG     13750002
*/*AREA SIZE  */                                                        13800002
         STC   WORK3,DCMATOP       STORE TOP LINE NO IN SACB  MH Y01274 13850002
STORTOP  MVC   DCMTOPAR(E1),DCMAID SAVE AREA ID TO EVENTUALLY MH Y01274 13900002
*                                       HAVE ID OF TOP AREA             13950002
SAVESACB LR    WORK2,SACBBASE      SAVE SACB ADDRESS         MC SA52721 14000002
         XC    DCMAROW(DCMACBND-DCMAROW),DCMAROW  ZERO OUT SACB         14050002
         B     NEXTSACB            GO GET NEXT SACB                     14100002
         SPACE                                                          14150002
UNDEFINE EQU   *                                                        14200002
*/*UNDEFINE: P (,NEXTSACB) INDICATE THIS SACB NOT IN USE */             14250002
         NI    DCMASACB,XFF-DCMAUSE  INDICATE THIS SACB NOT            X14300002
                                        IN USE                          14350002
         MVI   DCMTOPAR,E0         INDICATE NO AREAS DEFINED            14400002
         B     SAVESACB            GO SAVE SACB ADDR         MC SA52721 14450002
         SPACE 2                                                        14500002
SHRINK   EQU   *                                                        14550002
*/*SHRINK: P (,ENDSACBS) SHRINK TOP AREA */                             14600002
* THE NEED FOR SHRINKING WOULD ARISE ONLY IF A CONSOLE HAS BEEN         14650002
* SYSGEN'D WITH USE=SD AND AREAS DEFINED FOR THE ENTIRE SCREEN          14700002
* AND IS NOW BEING VARY'D TO FC.  SINCE A MS MESSAGE AREA IS            14750002
* NEVER MORE THAN 4 LINES LARGER THAN A FC MESSAGE AREA, THIS           14800002
* CORRECTION CAN ALWAYS BE MADE BY EITHER SHRINKING OR                  14850002
* UNDEFINING ONLY THE TOP AREA                                          14900002
         MVI   DCMATOP,E1          PUT TOP LINE AT TOP                 X14950002
                                        OF MESSAGE AREA                 15000002
         LA    WORKR,E1            CALCULATE AMOUNT OVER                15050002
         SR    WORKR,WORK3              MESSAGE AREA SIZE               15100002
*      WORK4 STILL CONTAINS THE SYSGENED LENGTH                         15150002
         SR    WORK4,WORKR         CALCULATE NEW LENGTH                 15200002
         STH   WORK4,DCMALN        STORE NEW LENGTH                     15250002
         CLI   DCMALN+E1,E4        Q. IS LENGTH OK                      15300002
         BNL   STORTOP             YES, GO TO SAVE TOP       MC SA52539 15350002
         NI    DCMASACB,XFF-DCMAUSE   UNDEFINE AREA SINCE              X15400002
                                        LENGTH IS LESS THAN MINIMUM     15450002
         B     STORTOP             GO TO SAVE TOP            MC SA52539 15500002
         SPACE 2                                                        15550002
GMSACB   EQU   *                                                        15600002
*/*GMSACB: S (,%NXTSACB) FREEMAIN:FREE THE SACB */                      15650002
         LTR   WORK1,WORK1         Q. FIRST GETMAINED SACB              15700002
         BNZ   FREESACB            NO, GO FREE SACB                     15750002
         LTR   WORK2,WORK2         Q. ANY RESIDENT SACB'S               15800002
         BZ    NOAREAS             NO, GO INITIALIZE FOR NO AREAS       15850002
         XC    DCMACBNX-DCMACB(E4,WORK2),DCMACBNX-DCMACB(WORK2)        X15900002
                                        ZERO OUT CHAIN FIELD OF        X15950002
                                        LAST RESIDENT SACB              16000002
         B     FREESACB            GO FREE SACB                         16050002
NOAREAS  EQU   *                                                        16100002
         ST    WORK2,DCMADSDS      ZERO OUT POINTER TO FIRST           X16150002
                                        SACB                            16200002
         MVI   DCMTOPAR,E0         ZERO OUT TOP AREA DEFINED ID         16250002
FREESACB EQU   *                                                        16300002
         L     WORK1,DCMACBNX      SAVE CHAIN FIELD                     16350002
         ST    WORK3,DCMDSAV       SAVE LINE COUNTER          MB YM4086 16360002
         LR    X1PARM,SACBBASE     AREA TO FREE               MB YM4086 16370002
         L     XFBRANCH,CSACTLM    BASE UCM BASE PORTION      MB YM4086 16372002
         USING UCM,XFBRANCH        DECLARE ADDRESSABILITY     MB YM4086 16374002
         LA    R0,DCMACBSZ         SACB SIZE                  MB YM4086 16380002
         L     X7ASCB,UCMASCB      ASCB FOR FREEMAIN          MB YM4086 16430002
         L     WORK4,UCMPXA        ADDRESS TCB                MB YM4086 16440002
         DROP  XFBRANCH                                       MB YM4086 16442002
         FREEMAIN RC,SP=SP241,LV=(0),A=(1),BRANCH=YES                   16444002
         L     WORK3,DCMDSAV       RESTORE LINE COUNTER       MB YM4086 16446002
*/*%NXTSACB: P (,SACBLOOP) GET POINTER TO NEXT SACB */                  16450002
         LR    SACBBASE,WORK1      BASE NEXT SACB                       16500002
         B     SACBLOOP            GO LOOK AT NEXT SACB                 16550002
         SPACE 2                                                        16600002
AECLEAN  EQU   *                                                        16650002
*/*AECLEAN: P (,NEXTSACB) CLEAN UP THE SACB, SAVING THE MSG TYPE FLAGS  16800002
*/*FOR ANY MONITOR */                                                   16850002
         XC    DCMAROW(DCMACBND-DCMAROW),DCMAROW  ZERO OUT SACB         16950002
         SPACE 2                                                        17100002
NEXTSACB EQU   *                                                        17150002
*/*NEXTSACB: P (,SACBLOOP) GET POINTER TO NEXT SACB */                  17200002
         L     SACBBASE,DCMACBNX   GET PTR TO NEXT SACB                 17250002
         B     SACBLOOP            GO LOOK AT NEXT SACB                 17300002
         EJECT                                                          17350002
ENDSACBS EQU   *                                                        17400002
*/*ENDSACBS: P (,%TOPDS) REINITIALIZE POINTER TO END OF VIEWABLE MSG    17450002
*/*AREA */                                                              17500002
         MVC   DCMWTBUF(E4),DCMWTINT  REINITIALIZE POINTER TO          X17550002
                                             END OF VIEWABLE MSG AREA   17600002
*/*%TOPDS: P (,QSRCH) INDICATE NO DISPLAYS ON SCREEN */                 17650002
         MVI   DCMTOPDS,E0         ZERO OUT ID OF TOP DISPLAY           17700002
         B     QSRCH               GO SEARCH CONSOLE Q                  17750002
         EJECT                                                          17800002
QSRCH    EQU   *                                                        17850002
         SPACE                                                          17900002
*    THE ENTIRE CONSOLE OUTPUT QUEUE IS SEARCHED.  ALL OUT OF           17950002
* LINE MLWTO'S IN PROGRESS HAVE ALREADY BEEN FREED BY THE               18000002
* SACBSRCH ROUTINE.  ANY OUT OF LINE MESSAGES STILL ON THE QUEUE        18050002
* ARE FREED.  IF INDICATED, INLINE MESSAGES ARE ALSO FREED.             18100002
         SPACE                                                          18150002
*/*QSRCH: D (YES,ENTRYFND,NO,ENDOFQ) ANYTHING ON QUEUE */               18200002
         L     OUTQREG,UCMOUTQ     GET CONSOLE OUTPUT Q POINTER         18250002
         LTR   OUTQREG,OUTQREG     Q. ANYTHING ON QUEUE                 18300002
         BZ    ENDOFQ              NO, GO HANDLE END OF Q               18350002
TESTLAST EQU   *                                                        18400002
         TM    CQEFLAG,CQEENTR     Q. ENTRY                             18450002
         BO    ENTRYFND            YES, GO LOOK AT ENTRY                18500002
         TM    CQEFLAG,CQEEOB      Q. END OF BLOCK                      18550002
         BO    EOB                 YES, GO GET NEXT BLOCK               18600002
NXTENTRY EQU   *                                                        18650002
*/*NXTENTRY: D (YES,ENTRYFND,NO,ENDOFQ) ANYTHING ELSE ON QUEUE */       18700002
         TM    CQEFLAG,CQEEOQ      Q. END OF QUEUE                      18750002
         BO    ENDOFQ              YES, GO HANDLE END OF Q              18800002
         LA    OUTQREG,E4(OUTQREG) LOOK AT NEXT ENTRY                   18850002
         B     TESTLAST            CHECK FOR LAST ENTRY                 18900002
         SPACE                                                          18950002
EOB      L     OUTQREG,CQEWQE      GET POINTER TO NEXT BLOCK            19050002
         B     TESTLAST            TEST NEXT CONSOLE Q ENTRY            19100002
         SPACE 2                                                        19150002
ENDOFQ   EQU   *                                                        19200002
*/*ENDOFQ: P TURN OFF OUT OF LINE OUTPUT PENDING FLAG */                19250002
         NI    UCMSDS5,XFF-UCMSDS5C  TURN OFF OUT OF LINE OUTPUT       X19300002
                                        PENDING FLAG                    19350002
*/*%TSTIN: D (YES,%OFFIN,NO,LEAVE1) WERE INLINE MESSAGES FREED */       19400002
         TM    DCMUTILT,DCMUTILA   Q. INLINE MESSAGES FREED             19450002
         BNO   LEAVE1              NO, LEAVE MODULE                     19500002
*/*%OFFIN: P (,LEAVE1) TURN OFF INLINE OUTPUT PENDING FLAG */           19550002
         NI    UCMSDS5,XFF-UCMSDS5B  TURN OFF INLINE OUTPUT            X19600002
                                        PENDING FLAG                    19650002
LEAVE1   EQU   *                                                        19700002
*/*LEAVE1: D (YES,LEAVE,NO,%OFFOP) IS ANY OUTPUT PENDING */             19750002
         TM    UCMSDS5,UCMSDS5B+UCMSDS5C  Q. IS EITHER OUTPUT          X19800002
                                        PENDING FLAG ON                 19850002
         BNZ   LEAVE               YES, EXIT                            19900002
*/*%OFFOP: P (,LEAVE) TURN OFF OUTPUT PENDING FLAG */                   19950002
         NI    UCMSTS,XFF-UCMPF    NO, TURN OFF OUTPUT PENDING          20000002
LEAVE   EQU   *                                                         20050002
*/*LEAVE: D (YES,PROC1EXT,NO,AEEXT) CLOSE IN PROGRESS */                20100002
         TM    DCMR3FLG,DCMCLPR    Q. CLOSE IN PROGRESS                 20150002
         BO    PROC1EXT            YES, GO TO PROCESSOR 1               20200002
         B     AEEXT               OTHERWISE EXIT TO ASYCHRONOUS       X20250002
                                        ERROR ROUTINE                   20300002
         EJECT                                                          20350002
ENTRYFND EQU   *                                                        20400002
*/*ENTRYFND: D (YES,,NO,REGWQE)   MLWTO */                              20450002
         TM    CQEWQE,CQEMAJOR     Q. MLWTO                             20500002
         BNO   REGWQE              NO, GO HANDLE REGULAR WQE            20550002
*/*%TST3: D (YES,,NO,INMLWTO) DESCRIPTOR CODES 8 AND 9 */               20750002
         L     WQEBASE,CQEWQE      GET POINTER TO MAJOR WQE             20800002
         TM    WMJMCS1,WMJMCS1A    Q. ROUTING OR DESCRIPTOR            X20850002
                                        CODES PRESENT                   20900002
         BNO   INMLWTO             NO, GO HANDLE INLINE MLWTO           20950002
         TM    WMJMDEC1,WMJMDECH   Q. DESCRIPTOR CODE 8                 21000002
         BNO   INMLWTO             NO, GO HANDLE INLINE MLWTO           21050002
         TM    WMJMDEC2,WMJMDECI   Q. DESCRIPTOR CODE 9                 21100002
         BNO   INMLWTO             NO, GO HANDLE INLINE MLWTO           21150002
*/*%TST4: D (YES,INMLWTO,NO,OUTMLWTO) TARGET AREA = Z */                21200002
         CLI   WMJMAREA,Z          Q. AREA ID=Z FOR MSG STREAM          21250002
         BE    INMLWTO             YES, GO HANDLE INLINE MLWTO          21300002
         SPACE 2                                                        21350002
OUTMLWTO EQU   *                                                        21400002
*/*OUTMLWTO: P (,NXTENTRY) FREE THE OUT OF LINE MLWTO */                21450002
         LA    LINKR,NXTENTRY      GO FREE MLWTO AND THEN LOOK          21500002
         B     FREMLWTO                 AT NEXT CONSOLE Q ENTRY         21550002
         SPACE 2                                                        21600002
REGWQE   EQU   *                                                        21650002
*/*REGWQE: D (YES,%FREEREG,NO,NXTENTRY) INLINE MSGS TO BE FREED */      21700002
         TM    DCMUTILT,DCMUTILA   Q. INLINE MSGS TO BE FREED           21750002
         BNO   NXTENTRY            NO, GO LOOK AT NEXT CONSOLE         X21800002
                                        QUEUE ENTRY                     21850002
*/*%FREEREG: P (,NXTENTRY) INDICATE WQE TO BE FREED */                  21900002
         OI    UCMSTS,UCMTB        INDICATE DEQ WORK TO DO              21950002
         OI    CQEFLAG,CQEAVAIL    TURN ON PURGE BIT                    22000002
         NI    CQEFLAG,XFF-CQEENTR TURN OFF ENTRY FLAG                  22050002
         B     NXTENTRY            GET NEXT CONSOLE Q ENTRY             22100002
         SPACE 2                                                        22150002
INMLWTO  EQU   *                                                        22200002
*/*INMLWTO: D (YES,%TSTWRKG,NO,NXTENTRY) INLINE MSGS TO BE FREED */     22250002
         TM    DCMUTILT,DCMUTILA   Q. INLINE MSGS TO BE FREED           22300002
         BNO   NXTENTRY            NO, GO LOOK AT NEXT CONSOLE         X22350002
                                        OUTPUT QUEUE ENTRY              22400002
*/*%TSTWRKG: D (YES,WORKIN,NO,%FREEINM) WORKING ON AN INLINE MLWTO */   22450002
         TM    UCMSTS,UCMTC        Q. WORKING ON AN INLINE MLWTO        22500002
         BO    WORKIN              YES, GO FREE WHAT IS NOT YET        X22550002
                                        OUTPUT                          22600002
*/*%FREEINM: P (,NXTENTRY) FREE INLINE MLWTO */                         22650002
         LA    LINKR,NXTENTRY      GO FREE MLWTO AND THEN LOOK          22700002
         B     FREMLWTO                 AT NEXT CONSOLE Q ENTRY         22750002
         SPACE 2                                                        22800002
WORKIN   EQU   *                                                        22850002
*/*WORKIN: P (,%FREEIN1) INDICATE NOT WORKING ON AN INLINE MLWTO */     22900002
         NI    UCMSTS,XFF-UCMTC    TURN OFF WORKING ON MLWTO BIT        22950002
         NI    UCMSDS5,XFF-UCMSDS5A TURN OFF WAITING ON MLWTO           23000002
*    FIND NEXT MINOR TO BE OUTPUT                                       23050002
*/*%FREEIN1: P (,NXTENTRY) FREE REMAINDER OF INLINE MLWTO */            23100002
         LA    LINKR,NXTENTRY      SET UP TO RETURN TO LOOK AT         X23150002
                                        NEXT CONSOLE Q ENTRY           X23200002
                                        AFTER FREEING MLWTO             23250002
         TM    CQEFLAG,CQEATTOP    Q. SHOULD MINOR SEARCH              X23300002
                                        BEGIN AT TOP OF CHAIN           23350002
         BO    FREEMINT            YES, GO FREE MINORS STARTING        X23400002
                                   FROM TOP OF CHAIN                    23450002
         SPACE                                                          23500002
GETSAVD2 EQU   *                                                        23550002
         L     WQEBASE,UCMMLAST    GET POINTER TO LAST MINOR           X23600002
                                        OUTPUT                          23650002
         LTR   WQEBASE,WQEBASE     Q. ANY MINORS OUTPUT YET             23700002
         BZ    FREMLWTO            NO, GO FREE MLWTO                    23750002
         B     GETNEXT             GO FIND NEXT MINOR TO BE            X23800002
                                        OUTPUT, FREE MAJOR AND         X23850002
                                        MINORS                          23900002
         EJECT                                                          23950002
* THE FOLLOWING ROUTINE FREES MLWTO'S.  THERE ARE MANY ENTRY            24000002
* POINTS, DEPENDING ON THE TYPE OF MLWTO TO BE FREED.  ALL              24050002
* EVENTUALLY END UP AT FREEMAJ TO FREE THE MAJOR WQE AFTER ALL          24100002
* MINORS, IF ANY, ARE FREED.  RETURN IS VIA REGISTER LINKR.             24150002
         SPACE 2                                                        24200002
GETNEXT  EQU   *                                                        24250002
*    CHECK TO SEE IF LAST MINOR OUTPUT IS STILL ON QUEUE                24300002
         LR    WORKR,WQEBASE       SAVE POINTER TO LAST MINOR          X24350002
                                        OUTPUT                          24400002
         L     WQEBASE,CQEWQE      GET POINTER TO MAJOR                 24450002
         L     WQEBASE,WMJMMIN     GET POINTER TO FIRST MINOR           24500002
LOOKNEXT EQU   *                                                        24550002
         LA    WQEBASE,E0(WQEBASE) CLEAR HIGH ORDER BYTE                24600002
         LTR   WQEBASE,WQEBASE     Q. END OF MINOR QUEUE                24650002
         BNZ   CHKEQ               NO, BRANCH TO SEE IF EQUAL TO       X24700002
                                        LAST MINOR OUTPUT               24750002
         B     FREEMINT            GO FREE MINORS FROM TOP OF          X24800002
                                        QUEUE SINCE LAST MINOR         X24850002
                                        OUTPUT IS NO LONGER ON Q        24900002
CHKEQ    EQU   *                                                        24950002
         CR    WORKR,WQEBASE       Q. MINOR POINTER EQUAL TO           X25000002
                                        LAST MINOR OUTPUT               25050002
         BE    LASTONQ             YES, LAST OUTPUT IS STILL ON        X25100002
                                        QUEUE - GO GET ITS CHAIN       X25150002
                                        FIELD                           25200002
         L     WQEBASE,WMNMNX1-E1  NO, GO LOOK AT                       25250002
         B     LOOKNEXT                 NEXT MINOR ON QUEUE             25300002
LASTONQ  EQU   *                                                        25350002
*    LAST MINOR IS STILL ON QUEUE -- CONTINUE FROM THERE                25400002
         L     WQEBASE,WMNMNX1-E1  GET CHAIN FIELD OF LAST MINOR       X25450002
                                        OUTPUT                          25500002
         LA    WQEBASE,E0(WQEBASE)  CLEAR HIGH ORDER BYTE               25550002
         B     FREEMIN             GO FREE MAJOR AND MINOR WQE'S        25600002
         SPACE 3                                                        25650002
FREMLWTO EQU   *                                                        25700002
*    FREE MLWTO MAJOR AND MINOR WQE'S                                   25750002
         L     WQEBASE,E0(OUTQREG) BASE MAJOR WQE                       25800002
         TM    WMJMMLW,WMJMMLWH    Q. NULL MINOR ON QUEUE               25850002
         BO    FREEMAJ                                                  25900002
         SPACE                                                          25950002
FREEMINT EQU   *                                                        26000002
*    FREE MINORS STARTING AT TOP OF CHAIN                               26050002
         L     WQEBASE,CQEWQE      BASE MAJOR WQE                       26100002
         L     WQEBASE,WMJMMIN     GET POINTER TO FIRST MINOR           26150002
         NI    CQEFLAG,XFF-CQEATTOP TURN OFF TOP OF CHAIN              X26200002
                                        FLAG                            26250002
         SPACE                                                          26300002
FREEMIN  EQU   *                                                        26350002
*    FREE MINORS STARTING WITH MINOR POINTED TO BY WQEBASE              26400002
         LTR   WQEBASE,WQEBASE     Q. ANY MINORS TO FREE                26450002
         BZ    FREEMAJ             NO, GO FREE MAJOR                    26500002
         SPACE                                                          26750002
FREEONE  EQU   *                                                        26800002
         SR    WORKR,WORKR         CLEAR REG                            26850002
         IC    WORKR,WMNMUC1       GET USE COUNT FROM MINOR             26900002
         BCTR  WORKR,E0            DECREMENT USE COUNT BY ONE           26950002
         STC   WORKR,WMNMUC1       STORE NEW USE COUNT                  27000002
         L     WQEBASE,WMNMNX1-E1  GET ADDRESS OF NEXT MINOR            27050002
         LA    WQEBASE,E0(WQEBASE) CLEAR HIGH ORDER BYTE                27100002
         LTR   WQEBASE,WQEBASE     Q. MORE MINORS ON QUEUE              27150002
         BNZ   FREEONE             YES, GO FREE ANOTHER MINOR           27200002
         SPACE 3                                                        27250002
FREEMAJ  EQU   *                                                        27300002
         OI    CQEFLAG,CQEAVAIL    INDICATE MAJOR NO LONGER            X27350002
                                        NEEDED BY THIS CONSOLE          27400002
         NI    CQEFLAG,XFF-CQEENTR TURN OFF ENTRY FLAG                  27450002
         OI    UCMSTS,UCMTB        INDICATE DEQ WORK NEEDED             27500002
         BR    LINKR                                                    27550002
         EJECT                                                          27600002
*                             EXITS                                     27650002
         SPACE 2                                                        27700002
PROC1EXT EQU   *                                                        27750002
*/*PROC1EXT: R IEECVET1 PROCESSOR 1 */                                  27800002
         L     XFBRANCH,DCMNPROC   LOAD PROC 1 ADDRESS                  27850002
         B     XCTL                EXIT TO IEECVET1                     27900002
         SPACE 2                                                        27950002
AEEXT    EQU   *                                                        28000002
*/*AEEXT: R IEECVETC ASYNCHRONOUS ERROR */                              28050002
         L     XFBRANCH,DCMNERRO   LOAD ASYNCH ERROR ADDRESS            28100002
XCTL     EQU   *                                                        28350002
         L     X1PARM,DCMCXSVE     RESTORE CXSA ADDRESS                 28650002
         BR    XFBRANCH            EXIT  ADDRESS ALREADY SET            28700002
         EJECT                                                          29350002
*********************************************************************** 29600002
*                                                                     * 29850002
*                             EQUATES                                 * 29900002
*                                                                     * 29950002
*********************************************************************** 30000002
         SPACE 2                                                        30050002
ID1      EQU   C'F'                1ST CHARACTER OF CSECT ID            30060002
ID2      EQU   C'G'                2ND CHARACTER OF CSECT ID            30070002
E0       EQU   0                   NUMBER                               30100002
E1       EQU   1                   NUMBER                               30150002
E2       EQU   2                   NUMBER                               30200002
E3       EQU   3                   NUMBER                               30250002
E4       EQU   4                   NUMBER                               30300002
Z        EQU   C'Z'                MSG AREA ID                          31150002
XFF      EQU   X'FF'               TO TURN OFF BITS                     31250002
SP241    EQU   241                 GETMAINED SACB SUBPOOL               31300002
HALFWORD EQU   2                   BYTES IN HALFWORD                    31350002
         EJECT                                                          31360002
         CVT   DSECT=YES                                                31362002
         EJECT                                                          31364002
         IHACTM CQE                                                     31370002
         EJECT                                                          31380002
         IHACTM  CXSA                                                   31750002
         EJECT                                                          31800002
         IEECUCM FORMAT=NEW                                             31900002
         EJECT                                                          31950002
         IHAWQE  DSECT=YES                                              32050002
         EJECT                                                          32400002
         IEERDCM                                                        32450002
         EJECT                                                          32550002
         IEETDCM                                                        32600002
*/*IEECVFTG: END */                                                     32750002
         END                                                            32800002
