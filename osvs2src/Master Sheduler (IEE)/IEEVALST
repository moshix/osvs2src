         TITLE 'IEEVALST - VALIDATE PAGE OF REAL STORAGE               *00001000
                        '                                               00002000
IEEVALST CSECT ,                                                   0001 00003000
@MAINENT DS    0H                                                  0001 00004000
         USING *,@15                                               0001 00005000
         B     @PROLOG                                             0001 00006000
         DC    AL1(19)                                             0001 00007000
         DC    C'IEEVALSTR0200073323'                              0001 00008000
         DROP  @15                                                      00009000
@PROLOG  STM   @14,@12,12(@13)                                     0001 00010000
         BALR  @12,0                                               0001 00011000
@PSTART  DS    0H                                                  0001 00012000
         USING @PSTART,@12                                         0001 00013000
         MVC   @PC00001(12),0(@01)                                 0001 00014000
*                                                                  0007 00015000
*   /*****************************************************************/ 00016000
*   /*                                                               */ 00017000
*   /* START OF IEEVALST CODE                                        */ 00018000
*   /*                                                               */ 00019000
*   /*****************************************************************/ 00020000
*                                                                  0008 00021000
*   R6=R12;                         /* SAVE VIRTUAL CODE REG         */ 00022000
         LR    R6,R12                                              0008 00023000
*   VIRTDON=ADDR(DATON);            /* INIT VIRT ADDR OF DATON IN DAT   00024000
*                                      ON PSW                        */ 00025000
*                                                                  0009 00026000
         LA    @00,DATON                                           0009 00027000
         ST    @00,VIRTDON                                         0009 00028000
*   /*****************************************************************/ 00029000
*   /*                                                               */ 00030000
*   /* SAVE REAL ADDR OF DATOFF IN DAT OFF PSW                       */ 00031000
*   /*                                                               */ 00032000
*   /*****************************************************************/ 00033000
*                                                                  0010 00034000
*   R3=ADDR(DATOFF);                /* VIRTUAL ADDRESS               */ 00035000
         LA    R3,DATOFF                                           0010 00036000
*   GEN(LRA R3,0(R3));              /* CONVERT TO REAL               */ 00037000
         LRA R3,0(R3)                                                   00038000
*   REALDOFF=R3;                    /* SAVE IN PSW                   */ 00039000
*                                                                  0012 00040000
         ST    R3,REALDOFF                                         0012 00041000
*   /*****************************************************************/ 00042000
*   /*                                                               */ 00043000
*   /* SAVE CURRENT SYSTEM MASK                                      */ 00044000
*   /*                                                               */ 00045000
*   /*****************************************************************/ 00046000
*                                                                  0013 00047000
*   GEN(STOSM SMASKOFF,X'00');      /* SAVE MASK IN DAT OFF PSW      */ 00048000
         STOSM SMASKOFF,X'00'                                           00049000
*   SMASKON=SMASKOFF;               /* COPY INTO DAT ON PSW          */ 00050000
*                                                                  0014 00051000
         MVC   SMASKON(1),SMASKOFF                                 0014 00052000
*   /*****************************************************************/ 00053000
*   /*                                                               */ 00054000
*   /* CLEAR DAT BIT IN DAT OFF PSW                                  */ 00055000
*   /*                                                               */ 00056000
*   /*****************************************************************/ 00057000
*                                                                  0015 00058000
*   SMASKOFF=SMASKOFF&'11111011'B;  /* CLEAR DAT BIT                 */ 00059000
*                                                                  0015 00060000
         NI    SMASKOFF,B'11111011'                                0015 00061000
*   /*****************************************************************/ 00062000
*   /*                                                               */ 00063000
*   /* PLACE INPUT PARAMETERS IN REGISTERS                           */ 00064000
*   /*                                                               */ 00065000
*   /*****************************************************************/ 00066000
*                                                                  0016 00067000
*   R5=VALFC;                       /* FUNCTION CODE                 */ 00068000
         L     @15,@PC00001                                        0016 00069000
         L     R5,VALFC(,@15)                                      0016 00070000
*   R7=FRAMEPTR;                    /* PAGE ADDRESS                  */ 00071000
*                                                                  0017 00072000
         L     @15,@PC00001+4                                      0017 00073000
         L     R7,FRAMEPTR(,@15)                                   0017 00074000
*   /*****************************************************************/ 00075000
*   /*                                                               */ 00076000
*   /* SET REAL ADDRESS OF RETRY LABEL IN MAINLINE WORKAREA          */ 00077000
*   /*                                                               */ 00078000
*   /*****************************************************************/ 00079000
*                                                                  0018 00080000
*   R3=ADDR(RETRY);                 /* VIRTUAL ADDRESS               */ 00081000
         LA    R3,RETRY                                            0018 00082000
*   GEN(LRA R3,0(R3));              /* CONVERT TO REAL               */ 00083000
         LRA R3,0(R3)                                                   00084000
*   RETRYADR=R3;                    /* SAVE IN MAINLINE WORKAREA     */ 00085000
*                                                                  0020 00086000
         L     @15,@PC00001+8                                      0020 00087000
         ST    R3,RETRYADR(,@15)                                   0020 00088000
*   /*****************************************************************/ 00089000
*   /*                                                               */ 00090000
*   /* SET DAT OFF BY LOADING NEW PSW                                */ 00091000
*   /*                                                               */ 00092000
*   /*****************************************************************/ 00093000
*                                                                  0021 00094000
*   GEN(LPSW SDATOFF);                                             0021 00095000
         LPSW SDATOFF                                                   00096000
*DATOFF:                                                           0022 00097000
*   GEN(LRA R12,0(R12));            /* GET REAL CODE REG ADDRESS     */ 00098000
*                                                                  0022 00099000
DATOFF   LRA R12,0(R12)                                                 00100000
*   /*****************************************************************/ 00101000
*   /*                                                               */ 00102000
*   /* THE CODE FROM DATOFF TO DATON RUNS WITH DAT OFF ALL STORAGE   */ 00103000
*   /* REFERENCES MUST BE THRU CODE REG                              */ 00104000
*   /*                                                               */ 00105000
*   /*****************************************************************/ 00106000
*                                                                  0023 00107000
*/*                                                                  */ 00108000
*                                                                  0023 00109000
*   /*****************************************************************/ 00110000
*   /*                                                               */ 00111000
*   /* TEST IF STORAGE KEY SHOULD BE SET TO ZERO                     */ 00112000
*   /*                                                               */ 00113000
*   /*****************************************************************/ 00114000
*                                                                  0023 00115000
*   IF R5=1 THEN                                                   0023 00116000
         CH    R5,@CH00068                                         0023 00117000
         BNE   @RF00023                                            0023 00118000
*     DO;                                                          0024 00119000
*       R3=0;                       /* SET VALUE OF STOR KEY         */ 00120000
         SLR   R3,R3                                               0025 00121000
*       R2=R7;                      /* SET UP PTR TO PAGE    @YM03405*/ 00122000
         LR    R2,R7                                               0026 00123000
*       GEN(SSK R3,R2);             /* SET STOR KEY FOR FIRST HALF OF   00124000
*                                      PAGE                          */ 00125000
         SSK R3,R2                                                      00126000
*       GEN(ISK R3,R2);             /* READ STORAGE KEY      @YM03405*/ 00127000
         ISK R3,R2                                                      00128000
*       R4=R2+2048;                 /* INCR PTR TO LAST HALF OF PAGE */ 00129000
         LA    R4,2048                                             0029 00130000
         ALR   R4,R2                                               0029 00131000
*       R3=0;                       /* SET STOR KEY VALUE    @YM03405*/ 00132000
         SLR   R3,R3                                               0030 00133000
*       GEN(SSK R3,R4);             /* SET STOR KEY FOR LAST HALF OF    00134000
*                                      PAGE                          */ 00135000
         SSK R3,R4                                                      00136000
*       GEN(ISK R3,R4);             /* READ STORAGE KEY      @YM03405*/ 00137000
         ISK R3,R4                                                      00138000
*     END;                                                         0033 00139000
*                                                                  0033 00140000
*   /*****************************************************************/ 00141000
*   /*                                                               */ 00142000
*   /* SET 4K PAGE TO ALL ONES                                       */ 00143000
*   /*                                                               */ 00144000
*   /*****************************************************************/ 00145000
*                                                                  0034 00146000
*   R2=R7;                          /* SET START ADDR        @YM03405*/ 00147000
@RF00023 LR    R2,R7                                               0034 00148000
*   R3=4096;                        /* SET LENGTH OF PAGE    @YM03405*/ 00149000
         LH    R3,@CH00071                                         0035 00150000
*   R4=0;                           /* SET SOURCE ADDR       @YM03405*/ 00151000
         SLR   R4,R4                                               0036 00152000
*   R5='FF000000'X;                 /* SET PAD CHARACTER     @YM03405*/ 00153000
         L     R5,@CF00072                                         0037 00154000
*   GEN(MVCL R2,R4);                /* SET PAGE TO ALL ONES  @YM03405*/ 00155000
*                                                                  0038 00156000
         MVCL R2,R4                                                     00157000
*   /*****************************************************************/ 00158000
*   /*                                                               */ 00159000
*   /* READ 4K PAGE OF ALL ONES                                      */ 00160000
*   /*                                                               */ 00161000
*   /*****************************************************************/ 00162000
*                                                                  0039 00163000
*   R2=R7;                          /* SET START ADDR        @YM03405*/ 00164000
         LR    R2,R7                                               0039 00165000
*   R3=4096;                        /* SET LENGTH OF PAGE    @YM03405*/ 00166000
         LH    R3,@CH00071                                         0040 00167000
*   R4=R2;                          /* SET SOURCE ADDR       @YM03405*/ 00168000
         LR    R4,R2                                               0041 00169000
*   R5=R3;                          /* SET PAD CHARACTER     @YM03405*/ 00170000
         LR    R5,R3                                               0042 00171000
*   GEN(MVCL R2,R4);                /* READ PAGE OF ALL ONES @YM03405*/ 00172000
*                                                                  0043 00173000
         MVCL R2,R4                                                     00174000
*   /*****************************************************************/ 00175000
*   /*                                                               */ 00176000
*   /* ZERO 4K PAGE USING MVCL INSTRUCTION.                          */ 00177000
*   /*                                                               */ 00178000
*   /*****************************************************************/ 00179000
*                                                                  0044 00180000
*   R2=R7;                          /* SET START ADDR        @YM03405*/ 00181000
         LR    R2,R7                                               0044 00182000
*   R3=4096;                        /* SET LENGTH OF DEST. BLCK      */ 00183000
         LH    R3,@CH00071                                         0045 00184000
*   R4=0;                           /* SET @ SOURCE BLOCK            */ 00185000
         SLR   @15,@15                                             0046 00186000
         LR    R4,@15                                              0046 00187000
*   R5=0;                           /* SET PAD CHARACTER             */ 00188000
         LR    R5,@15                                              0047 00189000
*   GEN(MVCL R2,R4);                /* ZERO 4K PAGE                  */ 00190000
*                                                                  0048 00191000
         MVCL R2,R4                                                     00192000
*   /*****************************************************************/ 00193000
*   /*                                                               */ 00194000
*   /* READ 4K PAGE OF ALL ZEROES                                    */ 00195000
*   /*                                                               */ 00196000
*   /*****************************************************************/ 00197000
*                                                                  0049 00198000
*   R2=R7;                          /* SET START ADDR        @YM03405*/ 00199000
         LR    R2,R7                                               0049 00200000
*   R3=4096;                        /* SET LENGTH OF PAGE    @YM03405*/ 00201000
         LH    R3,@CH00071                                         0050 00202000
*   R4=R2;                          /* SET SOURCE ADDR       @YM03405*/ 00203000
         LR    R4,R2                                               0051 00204000
*   R5=R3;                          /* SET PAD CHARACTER     @YM03405*/ 00205000
         LR    R5,R3                                               0052 00206000
*   GEN(MVCL R2,R4);                /* READ PAGE OF ALL ZEROES     0053 00207000
*                                                            @YM03405*/ 00208000
*                                                                  0053 00209000
         MVCL R2,R4                                                     00210000
*   /*****************************************************************/ 00211000
*   /*                                                               */ 00212000
*   /* SET DAT BACK ON BY RELOADING NEW PSW                          */ 00213000
*   /*                                                               */ 00214000
*   /*****************************************************************/ 00215000
*                                                                  0054 00216000
*RETRY:                                                            0054 00217000
*   GEN(LPSW SDATON);               /* SET DAT BACK ON               */ 00218000
RETRY    LPSW SDATON                                                    00219000
*DATON:                                                            0055 00220000
*   R12=R6;                         /* RESTORE VIRTUAL CODE REG      */ 00221000
*                                                                  0055 00222000
DATON    LR    R12,R6                                              0055 00223000
*   /*****************************************************************/ 00224000
*   /*                                                               */ 00225000
*   /* ZERO RETRY ADDRESS                                            */ 00226000
*   /*                                                               */ 00227000
*   /*****************************************************************/ 00228000
*                                                                  0056 00229000
*   RETRYADR=0;                                                    0056 00230000
*                                                                  0056 00231000
         L     @15,@PC00001+8                                      0056 00232000
         SLR   @00,@00                                             0056 00233000
         ST    @00,RETRYADR(,@15)                                  0056 00234000
*   /*****************************************************************/ 00235000
*   /*                                                               */ 00236000
*   /* RETURN TO IEEMPVST                                            */ 00237000
*   /*                                                               */ 00238000
*   /*****************************************************************/ 00239000
*                                                                  0057 00240000
*   RETURN;                                                        0057 00241000
@EL00001 DS    0H                                                  0057 00242000
@EF00001 DS    0H                                                  0057 00243000
@ER00001 LM    @14,@12,12(@13)                                     0057 00244000
         BR    @14                                                 0057 00245000
*   END IEEVALST;                                                  0058 00246000
@DATA    DS    0H                                                       00247000
@CH00068 DC    H'1'                                                     00248000
@CH00071 DC    H'4096'                                                  00249000
         DS    0F                                                       00250000
@PC00001 DS    3F                                                       00251000
         DS    0F                                                       00252000
@CF00072 DC    XL4'FF000000'                                            00253000
         DS    0D                                                       00254000
SDATOFF  DS    BL8                                                      00255000
         ORG   SDATOFF                                                  00256000
SMASKOFF DS    BL1                                                      00257000
@NM00001 DC    X'0C0000'                                                00258000
REALDOFF DS    AL4                                                      00259000
         ORG   SDATOFF+8                                                00260000
SDATON   DS    BL8                                                      00261000
         ORG   SDATON                                                   00262000
SMASKON  DS    BL1                                                      00263000
@NM00002 DC    X'0C0000'                                                00264000
VIRTDON  DS    AL4                                                      00265000
         ORG   SDATON+8                                                 00266000
@00      EQU   00                      EQUATES FOR REGISTERS 0-15       00267000
@01      EQU   01                                                       00268000
@02      EQU   02                                                       00269000
@03      EQU   03                                                       00270000
@04      EQU   04                                                       00271000
@05      EQU   05                                                       00272000
@06      EQU   06                                                       00273000
@07      EQU   07                                                       00274000
@08      EQU   08                                                       00275000
@09      EQU   09                                                       00276000
@10      EQU   10                                                       00277000
@11      EQU   11                                                       00278000
@12      EQU   12                                                       00279000
@13      EQU   13                                                       00280000
@14      EQU   14                                                       00281000
@15      EQU   15                                                       00282000
R1       EQU   @01                                                      00283000
R2       EQU   @02                                                      00284000
R3       EQU   @03                                                      00285000
R4       EQU   @04                                                      00286000
R5       EQU   @05                                                      00287000
R6       EQU   @06                                                      00288000
R7       EQU   @07                                                      00289000
R12      EQU   @12                                                      00290000
VALFC    EQU   0                                                        00291000
FRAMEPTR EQU   0                                                        00292000
RETRYADR EQU   0                                                        00293000
@ENDDATA EQU   *                                                        00294000
         END   IEEVALST                                                 00295000
