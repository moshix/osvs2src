         TITLE 'IEEVSND2 - OPERATOR SEND COMMAND MAIL HANDLER          *00001000
                        '                                               00002000
IEEVSND2 CSECT ,                                                   0001 00003000
@PROLOG  STM   @14,@12,12(@13)                                     0001 00004000
         BALR  @11,0                                               0001 00005000
@PSTART  DS    0H                                                  0001 00006000
         USING @PSTART,@11                                         0001 00007000
         L     @00,@SIZDATD                                        0001 00008000
         GETMAIN R,LV=(0)                                               00009000
         LR    @12,@01                                             0001 00010000
         USING @DATD,@12                                           0001 00011000
         ST    @13,@SA00001+4                                      0001 00012000
         LM    @00,@01,20(@13)                                     0001 00013000
         ST    @12,8(,@13)                                         0001 00014000
         LR    @13,@12                                             0001 00015000
         XC    @ZTEMPS(@ZLEN),@ZTEMPS                                   00016000
         MVC   @PC00001(4),0(@01)                                  0001 00017000
         MODID BRANCH=YES                                               00018000
REGS     DS    0H                                                  0027 00019000
*   COMPTR=R1;                      /* SET BASE FOR COMMON DATA AREA    00020000
*                                      FROM REGISTER 1 MOVE LIST   0031 00021000
*                                      FORMS OF MACROS TO AUTOMATIC     00022000
*                                      STORAGE                       */ 00023000
         LR    COMPTR,R1                                           0031 00024000
*   GEN(MVC   AUTOLIST(LISTEND-LISTBEG),LISTBEG );                 0032 00025000
         MVC   AUTOLIST(LISTEND-LISTBEG),LISTBEG                        00026000
*   R1PTR=PARMRCD1;                 /* SET BASE FOR RECORD1    Y02676*/ 00027000
         L     @10,PARMRCD1(,COMPTR)                               0033 00028000
         ST    @10,@TF00001                                        0033 00029000
         MVC   R1PTR(3),@TF00001+1                                 0033 00030000
*   RNUSD=R1USPTR;                  /* SET RNAME FOR ENQ ON USER DIR */ 00031000
         MVC   RNUSD(3),R1USPTR(@10)                               0034 00032000
*ENQUSD:                            /* ENQUEUE ON USER DIRECTORY REC */ 00033000
*   GEN(ENQ   (QNAME,RNUSD,E,3,SYSTEM),RET=HAVE,MF=(E,ENQEL) );    0035 00034000
ENQUSD   ENQ   (QNAME,RNUSD,E,3,SYSTEM),RET=HAVE,MF=(E,ENQEL)           00035000
*   FUPUSD='0'B;                    /* TURN OFF UPDATE FLAG          */ 00036000
         NI    FUPUSD(COMPTR),B'11110111'                          0036 00037000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00038000
*/*                                                                  */ 00039000
*/*       READ USER MAIL DIRECTORY RECORD                            */ 00040000
*/*                                                                  */ 00041000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00042000
*                                                                  0037 00043000
*   SDIOPARM=SDIOPARM&&SDIOPARM;    /* CLEAR IO PARM AREA            */ 00044000
         XC    SDIOPARM(20,COMPTR),SDIOPARM(COMPTR)                0037 00045000
*   P1READ='1'B;                    /* SET PARM FLAG FOR READ        */ 00046000
         OI    P1READ(COMPTR),B'01000000'                          0038 00047000
*   PARMRBA=ADDR(RNUSD);            /* SET ADDR OF RBA OF REC TO READ*/ 00048000
         LA    @10,RNUSD                                           0039 00049000
         ST    @10,@TF00001                                        0039 00050000
         MVC   PARMRBA(4,COMPTR),@TF00001                          0039 00051000
*   PARMIOAD=ADDR(DIRAREA);         /* SET PARM AREA ADDRESS FOR READ*/ 00052000
         LA    @10,DIRAREA                                         0040 00053000
         ST    @10,@TF00001                                        0040 00054000
         MVC   PARMIOAD(4,COMPTR),@TF00001                         0040 00055000
*   R1=ADDR(SDIOPARM);              /* SET SDIOPARM PTR        Y02676*/ 00056000
         LA    R1,SDIOPARM(,COMPTR)                                0041 00057000
*   CALL IEEVSND5;                  /* CALL IO RTN TO READ USER DIR  */ 00058000
         L     @15,@CV00205                                        0042 00059000
         BALR  @14,@15                                             0042 00060000
*   RETC=R15;                       /* SAVE RETURN CODE FROM REG 15  */ 00061000
         STC   R15,RETC                                            0043 00062000
*   IF RETC>0                       /* TEST RETURN CODE FROM IO RTN  */ 00063000
*     THEN                          /* IF UNSUCCESSFUL OPERATION     */ 00064000
         CLI   RETC,0                                              0044 00065000
         BH    @RT00044                                            0044 00066000
*     GOTO BADIO;                   /* GO TO PROCESS ERROR           */ 00067000
*   USDPTR=PARMIOAD;                /* SET BASE FOR MAIL DIR RCD   0046 00068000
*                                                              Y02676*/ 00069000
         MVC   USDPTR(3),PARMIOAD+1(COMPTR)                        0046 00070000
*   USDADD=RNUSD;                   /* SAVE RBA FOR WRITE IF UPDATED */ 00071000
         MVC   USDADD(3),RNUSD                                     0047 00072000
*   DO I=1 TO DIM(USDENTRY);        /* SCAN THE USERID ENTRIES IN  0048 00073000
*                                      THIS USER DIRECTORY         0048 00074000
*                                      RECORD.Y02676                 */ 00075000
         LA    I,1                                                 0048 00076000
@DL00048 DS    0H                                                  0049 00077000
*     IF USDENTRY(I)=ZERENT         /* TEST IF THIS ENTRY = ZERO     */ 00078000
*       THEN                        /* THIS USERID ENTRY IS ZERO     */ 00079000
         LR    @10,I                                               0049 00080000
         MH    @10,@CH00164                                        0049 00081000
         L     @05,USDPTR-1                                        0049 00082000
         LA    @05,0(,@05)                                         0049 00083000
         ALR   @05,@10                                             0049 00084000
         AL    @05,@CF00233                                        0049 00085000
         CLC   USDENTRY(13,@05),ZERENT                             0049 00086000
         BE    @RT00049                                            0049 00087000
*       GOTO LPEND1;                /* LOOP TO CHECK NEXT ENTRY FOR     00088000
*                                      EACH USERID IN DIRECTORY,     */ 00089000
*     DO J=1 TO IDCNT;              /* SCAN ENTIRE LIST OF USERIDS 0051 00090000
*                                      SPECIFIED IN COMMAND          */ 00091000
         LA    @10,1                                               0051 00092000
         B     @DE00051                                            0051 00093000
@DL00051 DS    0H                                                  0052 00094000
*       IF USDID(I)=IDUSRID(J)      /* IS USERID FROM USER DIRECTORY    00095000
*                                      EQUAL TO USERID FROM LIST OF     00096000
*                                      THOSE SPEC'D IN COMMAND       */ 00097000
*         THEN                                                     0052 00098000
         LR    @05,I                                               0052 00099000
         MH    @05,@CH00164                                        0052 00100000
         L     @02,USDPTR-1                                        0052 00101000
         LA    @02,0(,@02)                                         0052 00102000
         SLA   @10,3                                               0052 00103000
         ALR   @02,@05                                             0052 00104000
         AL    @02,@CF00233                                        0052 00105000
         ALR   @10,COMPTR                                          0052 00106000
         CLC   USDID(7,@02),IDUSRID-8(@10)                         0052 00107000
         BE    @RT00052                                            0052 00108000
*         GOTO VALIDID;             /* YES, GO TO PROCESS THIS USRID    00109000
*                                      NO, CHECK NEXT USERID IN LIST */ 00110000
*SCIDLST:                           /* CHECK NEXT ENTRY IN LIST OF 0054 00111000
*                                      USERIDS                       */ 00112000
*     END;                                                         0054 00113000
SCIDLST  LA    @10,1                                               0054 00114000
         MVC   @ZT00003+3(1),J                                     0054 00115000
         AL    @10,@ZT00003                                        0054 00116000
@DE00051 STC   @10,J                                               0054 00117000
         MVC   @ZT00003+3(1),IDCNT(COMPTR)                         0054 00118000
         C     @10,@ZT00003                                        0054 00119000
         BNH   @DL00051                                            0054 00120000
*LPEND1:                            /* SCAN NEXT USERID ENTRY IN   0055 00121000
*                                      DIRECTORY REC                 */ 00122000
*   END;                                                           0055 00123000
LPEND1   AH    I,@CH00047                                          0055 00124000
         CH    I,@CH00163                                          0055 00125000
         BNH   @DL00048                                            0055 00126000
*   IF FUPUSD='0'B                  /* IF RECORD HAS NOT BEEN UPDATED*/ 00127000
*     THEN                                                         0056 00128000
         TM    FUPUSD(COMPTR),B'00001000'                          0056 00129000
         BZ    @RT00056                                            0056 00130000
*     GOTO DEQUSD;                  /* GOTO DEQ USER DIRECTRY REC IF    00131000
*                                      RECORD HAS BEEN UPDATED, -    */ 00132000
*/*   * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * **/ 00133000
*/*                                                                  */ 00134000
*/*       WRITE UPDATED USER MAIL DIRECTORY RECORD                   */ 00135000
*/*                                                                  */ 00136000
*/*   * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * **/ 00137000
*                                                                  0058 00138000
*UPUSD:                             /* WRITE UPDATED USER MAIL     0058 00139000
*                                      DIRECTORY REC                 */ 00140000
*   SDIOPARM=SDIOPARM&&SDIOPARM;    /* CLEAR IO PARM AREA            */ 00141000
UPUSD    XC    SDIOPARM(20,COMPTR),SDIOPARM(COMPTR)                0058 00142000
*   P2WRDI='1'B;                    /* SET PARM FLAG FOR WRITE BY  0059 00143000
*                                      BLOCK ID (RBA)                */ 00144000
         OI    P2WRDI(COMPTR),B'10000000'                          0059 00145000
*   PARMRBA=ADDR(USDADD);           /* SET PARM RBA ADDRESS FOR WRITE*/ 00146000
         LA    @10,USDADD                                          0060 00147000
         ST    @10,@TF00001                                        0060 00148000
         MVC   PARMRBA(4,COMPTR),@TF00001                          0060 00149000
*   PARMIOAD=ADDR(DIRAREA);         /* SET AREA ADDRESS FOR WRITE    */ 00150000
         LA    @10,DIRAREA                                         0061 00151000
         ST    @10,@TF00001                                        0061 00152000
         MVC   PARMIOAD(4,COMPTR),@TF00001                         0061 00153000
*   PARMKEY=USDKEY;                 /* SET PARM KEY FOR WRITE        */ 00154000
         MVC   PARMKEY(1,COMPTR),USDKEY                            0062 00155000
*   R1=ADDR(SDIOPARM);              /* SET SDIOPARM PTR        Y02676*/ 00156000
         LA    R1,SDIOPARM(,COMPTR)                                0063 00157000
*   CALL IEEVSND5;                  /* CALL IO RTN TO WRITE MAIL DIR */ 00158000
         L     @15,@CV00205                                        0064 00159000
         BALR  @14,@15                                             0064 00160000
*   RETC=R15;                       /* SAVE RETURN CODE        Y02676*/ 00161000
         STC   R15,RETC                                            0065 00162000
*   IF RETC^=0                      /* CHECK RETURN CODE       Y02676*/ 00163000
*     THEN                          /* UNSUCCESSFUL I/O        Y02676*/ 00164000
         CLI   RETC,0                                              0066 00165000
         BNE   @RT00066                                            0066 00166000
*     GOTO BADIO;                   /* TAKE ERROR EXIT         Y02676*/ 00167000
*   FUPUSD='0'B;                    /* TURN OFF FLAG FOR UPDATE USER    00168000
*                                      MAIL DIRECTORY RECORD         */ 00169000
         NI    FUPUSD(COMPTR),B'11110111'                          0068 00170000
*DEQUSD:                            /* DEQUEUE ON USER DIRECTORY   0069 00171000
*                                      RECORD                        */ 00172000
*   GEN(DEQ   (QNAME,RNUSD,3,SYSTEM),RET=HAVE,MF=(E,DEQL) );/* DEQ ON   00173000
*                                      DIRECTRY REC JUST SCANED      */ 00174000
DEQUSD   DEQ   (QNAME,RNUSD,3,SYSTEM),RET=HAVE,MF=(E,DEQL)              00175000
*   IF FENDUSL='1'B                 /* CHECK FLAG FOR END OF USER  0070 00176000
*                                      LIST                          */ 00177000
*     THEN                          /* YES, END OF USERID LIST       */ 00178000
         TM    FENDUSL(COMPTR),B'00000100'                         0070 00179000
         BO    @RT00070                                            0070 00180000
*     GOTO EXITCODE;                /* GOTO CLEANUP EXIT CODE        */ 00181000
*/*       CHECK IF END OF USER MAIL DIRECTORY                        */ 00182000
*                                                                  0072 00183000
*   IF USDNEXT=0                    /* LAST MAIL DIR RCD       Y02676*/ 00184000
*     THEN                          /* YES, CHAIN PTR IS 0           */ 00185000
         L     @10,USDPTR-1                                        0072 00186000
         LA    @10,0(,@10)                                         0072 00187000
         MVC   @ZT00001+1(3),USDNEXT(@10)                          0072 00188000
         L     @10,@ZT00001                                        0072 00189000
         LTR   @10,@10                                             0072 00190000
         BNZ   @RF00072                                            0072 00191000
*     DO;                                                          0073 00192000
*       FMSG1='1'B;                 /* USERID NOT FOUND IN DIR Y02676*/ 00193000
         OI    FMSG1(COMPTR),B'00001000'                           0074 00194000
*       GOTO EXITCODE;              /* EXIT FROM ROUTINE       Y02676*/ 00195000
         B     EXITCODE                                            0075 00196000
*     END;                                                         0076 00197000
*   RNUSD=USDNEXT;                  /* SET RNAME FOR ENQ ON NEXT USER   00198000
*                                      DIRECTORY RECORD        YM6027*/ 00199000
@RF00072 L     @10,USDPTR-1                                        0077 00200000
         LA    @10,0(,@10)                                         0077 00201000
         MVC   RNUSD(3),USDNEXT(@10)                               0077 00202000
*   GOTO ENQUSD;                    /* SCAN NEXT USER DIRECTRY RECORD*/ 00203000
         B     ENQUSD                                              0078 00204000
*VALIDID:                           /* USERID SPEC'D IN SEND COMMAND    00205000
*                                      HAS BEEN FOUND IN USER      0079 00206000
*                                      DIRECTORY OF BROADCAST DS     */ 00207000
*   VALCNT=VALCNT+1;                /* BUMP CNT OF VALID USERIDS     */ 00208000
VALIDID  LA    @10,1                                               0079 00209000
         MVC   @ZT00003+3(1),VALCNT(COMPTR)                        0079 00210000
         AL    @10,@ZT00003                                        0079 00211000
         STC   @10,VALCNT(,COMPTR)                                 0079 00212000
*   IF USDRBA(I)^=0                 /* IF RBA OF USER MSG IN       0080 00213000
*                                      DIRECTORY                     */ 00214000
*     THEN                                                         0080 00215000
         LR    @10,I                                               0080 00216000
         MH    @10,@CH00164                                        0080 00217000
         L     @05,USDPTR-1                                        0080 00218000
         LA    @05,0(,@05)                                         0080 00219000
         ALR   @05,@10                                             0080 00220000
         AL    @05,@CF00236                                        0080 00221000
         MVC   @ZT00001+1(3),USDRBA-7(@05)                         0080 00222000
         L     @10,@ZT00001                                        0080 00223000
         LTR   @10,@10                                             0080 00224000
         BNZ   @RT00080                                            0080 00225000
*     GOTO CHAINUM;                 /* IS NOT 0, GO TO CHAIN MSG     */ 00226000
*FORMUSM:                           /* FORMAT NEW USER MAIL MSG REC  */ 00227000
*   USMPTR=ADDR(MSGAREA2);          /* FORMAT NEW MSG RCD      Y02676*/ 00228000
FORMUSM  LA    @10,MSGAREA2                                        0082 00229000
         ST    @10,@TF00001                                        0082 00230000
         MVC   USMPTR(3),@TF00001+1                                0082 00231000
*   USMLNG=TEXTLENG+LENGTH(OPERID); /* SET LENGTH              Y02676*/ 00232000
         SLR   @05,@05                                             0083 00233000
         IC    @05,TEXTLENG(,COMPTR)                               0083 00234000
         LA    @02,7                                               0083 00235000
         ALR   @02,@05                                             0083 00236000
         STC   @02,USMLNG(,@10)                                    0083 00237000
*   USMTEXT(1:TEXTLENG)=COMBUF(TBEG:TBEG+TEXTLENG);/* COPY TEXT    0084 00238000
*                                                              Y02676   00239000
*                                                              YM6027*/ 00240000
         LR    @02,@05                                             0084 00241000
         BCTR  @02,0                                               0084 00242000
         SLR   @01,@01                                             0084 00243000
         IC    @01,TBEG(,COMPTR)                                   0084 00244000
         ALR   @01,COMPTR                                          0084 00245000
         EX    @02,@SM00237                                        0084 00246000
*   USMTEXT(1+TEXTLENG:TEXTLENG+LENGTH(OPERID))=OPERID;/* COPY     0085 00247000
*                                      OPERATOR TAG            Y02676*/ 00248000
         ALR   @05,@10                                             0085 00249000
         MVC   USMTEXT(7,@05),OPERID(COMPTR)                       0085 00250000
*   USMNEXT=0;                      /* NO NEXT RCD             Y02676*/ 00251000
         SLR   @05,@05                                             0086 00252000
         ST    @05,@TF00001                                        0086 00253000
         MVC   USMNEXT(3,@10),@TF00001+1                           0086 00254000
*/*   * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * **/ 00255000
*/*                                                                  */ 00256000
*/*   CALL TO RTN TO WRITE USER MAIL MESSAGE RECORD IN FIRST FREE SPAC  00257000
*                                                                    */ 00258000
*/*   IF NO SPACE IS AVAILABLE, A WARNING MSG IS ROUTED TO SENDER.   */ 00259000
*/*                                                                  */ 00260000
*/*   * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * **/ 00261000
*                                                                  0087 00262000
*   SDIOPARM=SDIOPARM&&SDIOPARM;    /* CLEAR IO PARM AREA            */ 00263000
         XC    SDIOPARM(20,COMPTR),SDIOPARM(COMPTR)                0087 00264000
*   P2WRDAF='1'B;                   /* SET PARM FLAG FOR WRITE IN  0088 00265000
*                                      FIRST FREE SPACE, TYPE 'DAF'  */ 00266000
         OI    P2WRDAF(COMPTR),B'01000000'                         0088 00267000
*   PARMIOAD=ADDR(MSGAREA2);        /* SET AREA ADDRESS FOR WRITE    */ 00268000
         ST    @10,@TF00001                                        0089 00269000
         MVC   PARMIOAD(4,COMPTR),@TF00001                         0089 00270000
*   PARMRBA=ADDR(R1USPTR);          /* RBA OF 1ST MAIL DIR RCD Y02676   00271000
*                                      TO START BDAM EXTENDED SEARCH */ 00272000
         L     @10,R1PTR-1                                         0090 00273000
         LA    @10,0(,@10)                                         0090 00274000
         LA    @10,R1USPTR(,@10)                                   0090 00275000
         ST    @10,@TF00001                                        0090 00276000
         MVC   PARMRBA(4,COMPTR),@TF00001                          0090 00277000
*   PARMKEY=USMKEY;                 /* SET PARM KEY FOR WRITE        */ 00278000
         MVC   PARMKEY(1,COMPTR),USMKEY                            0091 00279000
*   R1=ADDR(SDIOPARM);              /* SET SDIOPARM PTR        Y02676*/ 00280000
         LA    R1,SDIOPARM(,COMPTR)                                0092 00281000
*   CALL IEEVSND5;                  /* CALL IO RTN TO WRITE MAIL MSG */ 00282000
         L     @15,@CV00205                                        0093 00283000
         BALR  @14,@15                                             0093 00284000
*   RETC=R15;                       /* SAVE RET CODE FROM IEEVSDIO   */ 00285000
         STC   R15,RETC                                            0094 00286000
*   IF R15^=0                       /* CHECK RETURN CODE IN REG15    */ 00287000
*     THEN                          /* NOT ZERO, UNSUCCESSFUL WRITE  */ 00288000
         LTR   R15,R15                                             0095 00289000
         BNZ   @RT00095                                            0095 00290000
*     GOTO BADWRITA;                /* ANALYZE IO RTN ERROR          */ 00291000
*   FUPUSD='1'B;                    /* SET FLAG TO SAY USER DIRECTORY   00292000
*                                      MUST BE WRITTEN DUE TO UPDATE    00293000
*                                                              Y02676*/ 00294000
         OI    FUPUSD(COMPTR),B'00001000'                          0097 00295000
*   USDEND(I)=PARMRBA;              /* SET NEW MAIL CHAIN END  Y02676*/ 00296000
         L     @10,USDPTR-1                                        0098 00297000
         LA    @10,0(,@10)                                         0098 00298000
         LR    @05,I                                               0098 00299000
         MH    @05,@CH00164                                        0098 00300000
         MVC   @TF00001(4),PARMRBA(COMPTR)                         0098 00301000
         L     @02,@TF00001                                        0098 00302000
         ST    @02,@TF00001                                        0098 00303000
         ST    @05,@TF00002                                        0098 00304000
         ALR   @05,@10                                             0098 00305000
         AL    @05,@CF00239                                        0098 00306000
         MVC   USDEND-10(3,@05),@TF00001+1                         0098 00307000
*   IF FCHNMSG='1'B                 /* IF MORE THAN 1 USER MAIL MSG     00308000
*                                      GO TO WRITE PREVIOUS MAIL MSG    00309000
*                                      RECORD WITH UPDATED CHAIN PTR */ 00310000
*     THEN                                                         0099 00311000
         TM    FCHNMSG(COMPTR),B'00010000'                         0099 00312000
         BO    @RT00099                                            0099 00313000
*     GOTO CHAIN3;                                                 0100 00314000
*   USDRBA(I)=PARMRBA;              /* PUT FEEDBACK PTR TO MSG RECORD   00315000
*                                      JUST WRITTEN INTO USER MAIL 0101 00316000
*                                      DIRECTORY RECORD ENTRY FOR  0101 00317000
*                                      THIS USERID                   */ 00318000
         MVC   @TF00001(4),PARMRBA(COMPTR)                         0101 00319000
         L     @05,@TF00001                                        0101 00320000
         ST    @05,@TF00001                                        0101 00321000
         AL    @10,@TF00002                                        0101 00322000
         AL    @10,@CF00236                                        0101 00323000
         MVC   USDRBA-7(3,@10),@TF00001+1                          0101 00324000
*   IDUSRID(J)=BLNKID;              /* BLANK OUT USERID IN IDUSRID   */ 00325000
         SLR   @10,@10                                             0102 00326000
         IC    @10,J                                               0102 00327000
         SLA   @10,3                                               0102 00328000
         ALR   @10,COMPTR                                          0102 00329000
         MVC   IDUSRID-8(8,@10),BLNKID                             0102 00330000
*ANYMORU:                           /* CHECK IF ANY MORE USERIDS TO     00331000
*                                      PROCESS                       */ 00332000
*   IF VALCNT^=IDCNT                /* HAVE ALL USERIDS ON LIST BEEN    00333000
*                                      PROCESSED                     */ 00334000
*     THEN                                                         0103 00335000
ANYMORU  CLC   VALCNT(1,COMPTR),IDCNT(COMPTR)                      0103 00336000
         BNE   @RT00103                                            0103 00337000
*     GOTO SCIDLST;                 /* NO, BRANCH TO CONTINUE SEARCH    00338000
*                                      OF USER DIRECTORY RECORDS     */ 00339000
*   FENDUSL='1'B;                   /* SET FLAG FOR END OF USERID  0105 00340000
*                                      LIST                          */ 00341000
         OI    FENDUSL(COMPTR),B'00000100'                         0105 00342000
*   GOTO UPUSD;                     /* GO TO WRITE UPDATED USER MAIL    00343000
*                                      DIRECTORY RECORD              */ 00344000
         B     UPUSD                                               0106 00345000
*CHAIN3:                            /* THERE IS A CHAIN OF MSGS FOR     00346000
*                                      THIS USERID                   */ 00347000
*   USMPTR=ADDR(MSGAREA);           /* SET BASE PREVIOUS MSG RCD   0107 00348000
*                                                              Y02676*/ 00349000
CHAIN3   LA    @10,MSGAREA                                         0107 00350000
         ST    @10,@TF00001                                        0107 00351000
         MVC   USMPTR(3),@TF00001+1                                0107 00352000
*   USMNEXT=PARMRBA;                /* SET CHAIN PTR IN OLD LAST   0108 00353000
*                                      RECORD WITH FEEDBACK FROM   0108 00354000
*                                      WRITE OF LAST MSG RECORD    0108 00355000
*                                                              Y02676*/ 00356000
         MVC   USMNEXT(3,@10),PARMRBA+1(COMPTR)                    0108 00357000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00358000
*/*                                                                  */ 00359000
*/*       WRITE USER MAIL MSG RECORD WITH UPDATED CHAIN POINTER TO   */ 00360000
*/*       THE NEW MSG RECORD CONTAINING THE 'TEXT' OF THE SEND CMD   */ 00361000
*/*                                                                  */ 00362000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00363000
*                                                                  0109 00364000
*   SDIOPARM=SDIOPARM&&SDIOPARM;    /* CLEAR IO PARM AREA            */ 00365000
         XC    SDIOPARM(20,COMPTR),SDIOPARM(COMPTR)                0109 00366000
*   P2WRDI='1'B;                    /* SET PARM FLAG FOR WRITE BY  0110 00367000
*                                      BLOCK ID (RBA)                */ 00368000
         OI    P2WRDI(COMPTR),B'10000000'                          0110 00369000
*   PARMKEY=USMKEY;                 /* SET PARM KEY FOR WRITE        */ 00370000
         MVC   PARMKEY(1,COMPTR),USMKEY                            0111 00371000
*   PARMIOAD=ADDR(MSGAREA);         /* SET AREA ADDRESS FOR WRITE TO    00372000
*                                      POINT TO AREA IN WHICH USER 0112 00373000
*                                      MAIL MESSAGE RECORD WAS READ  */ 00374000
         ST    @10,@TF00001                                        0112 00375000
         MVC   PARMIOAD(4,COMPTR),@TF00001                         0112 00376000
*   PARMRBA=ADDR(USMADD);           /* SET PARM RBA ADDRESS FOR WRITE   00377000
*                                      TO PT TO RBA FOR NEXT-TO-LAST    00378000
*                                      USER MSG RECORD IN CHAIN      */ 00379000
         LA    @10,USMADD                                          0113 00380000
         ST    @10,@TF00001                                        0113 00381000
         MVC   PARMRBA(4,COMPTR),@TF00001                          0113 00382000
*   R1=ADDR(SDIOPARM);              /* SET SDIOPARM PTR              */ 00383000
         LA    R1,SDIOPARM(,COMPTR)                                0114 00384000
*   CALL IEEVSND5;                  /* CALL IO RTN TO WRITE MAIL MSG */ 00385000
         L     @15,@CV00205                                        0115 00386000
         BALR  @14,@15                                             0115 00387000
*   RETC=R15;                       /* SAVE RETURN CODE FROM REG 15  */ 00388000
         STC   R15,RETC                                            0116 00389000
*   IF RETC>0                       /* TEST RETURN CODE FROM IO RTN  */ 00390000
*     THEN                          /* IF UNSUCCESSFUL OPERATION     */ 00391000
         CLI   RETC,0                                              0117 00392000
         BH    @RT00117                                            0117 00393000
*     GOTO BADIO;                   /* GOTO PROCESS ERROR            */ 00394000
*   IDUSRID(J)=BLNKID;              /* BLANK OUT IO IN IDUSRID       */ 00395000
         SLR   @10,@10                                             0119 00396000
         IC    @10,J                                               0119 00397000
         SLA   @10,3                                               0119 00398000
         ALR   @10,COMPTR                                          0119 00399000
         MVC   IDUSRID-8(8,@10),BLNKID                             0119 00400000
*   GOTO ANYMORU;                   /* ANY MORE USERIDS TO PROCESS   */ 00401000
         B     ANYMORU                                             0120 00402000
*CHAINUM:                           /* THERE IS A MSG CHAIN FOR THIS    00403000
*                                      USERID                        */ 00404000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00405000
*/*                                                                  */ 00406000
*/*       READ LAST USER MAIL MSG RECORD                             */ 00407000
*/*                                                                  */ 00408000
*/*  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ 00409000
*                                                                  0121 00410000
*                                   /*                         YM6027*/ 00411000
*   USMADD=USDEND(I);               /* SAVE FOR LATER UPDATE   Y02676*/ 00412000
CHAINUM  LR    @10,I                                               0121 00413000
         MH    @10,@CH00164                                        0121 00414000
         L     @05,USDPTR-1                                        0121 00415000
         LA    @05,0(,@05)                                         0121 00416000
         ALR   @05,@10                                             0121 00417000
         AL    @05,@CF00239                                        0121 00418000
         MVC   USMADD(3),USDEND-10(@05)                            0121 00419000
*   SDIOPARM=SDIOPARM&&SDIOPARM;    /* CLEAR IO PARM AREA            */ 00420000
         XC    SDIOPARM(20,COMPTR),SDIOPARM(COMPTR)                0122 00421000
*   P1READ='1'B;                    /* SET PARM FLAG FOR READ        */ 00422000
         OI    P1READ(COMPTR),B'01000000'                          0123 00423000
*   PARMIOAD=ADDR(MSGAREA);         /* SET AREA ADDRESS FOR READ   0124 00424000
*                                                              YM6027*/ 00425000
         LA    @10,MSGAREA                                         0124 00426000
         ST    @10,@TF00001                                        0124 00427000
         MVC   PARMIOAD(4,COMPTR),@TF00001                         0124 00428000
*   PARMRBA=ADDR(USMADD);           /* SET RBA FOR READ        Y02676*/ 00429000
         LA    @10,USMADD                                          0125 00430000
         ST    @10,@TF00001                                        0125 00431000
         MVC   PARMRBA(4,COMPTR),@TF00001                          0125 00432000
*   R1=ADDR(SDIOPARM);              /* SET SDIOPARM PTR        Y02676*/ 00433000
         LA    R1,SDIOPARM(,COMPTR)                                0126 00434000
*   CALL IEEVSND5;                  /* CALL IO RTN TO READ MAIL MSG  */ 00435000
         L     @15,@CV00205                                        0127 00436000
         BALR  @14,@15                                             0127 00437000
*   RETC=R15;                       /* SAVE RETURN CODE FROM REG 15  */ 00438000
         STC   R15,RETC                                            0128 00439000
*   IF RETC>0                       /* TEST RETURN CODE FROM IO RTN  */ 00440000
*     THEN                          /* IF UNSUCCESSFUL OPERATION     */ 00441000
         CLI   RETC,0                                              0129 00442000
         BH    @RT00129                                            0129 00443000
*     GOTO BADIO;                   /* GO TO PROCESS ERROR           */ 00444000
*   FCHNMSG='1'B;                   /* SET FLAG TO INDICATE MORE THAN   00445000
*                                      1 USER MAIL MSG, IN A CHAIN   */ 00446000
         OI    FCHNMSG(COMPTR),B'00010000'                         0131 00447000
*   GOTO FORMUSM;                                                  0132 00448000
         B     FORMUSM                                             0132 00449000
*                                                                  0133 00450000
*/*                                                                  */ 00451000
*                                                                  0133 00452000
*BADIO:                             /* UNSUCCESSFUL RETURN FROM IO 0133 00453000
*                                      RTN, IEEVSND9                 */ 00454000
*   FBADIO='1'B;                    /* SET MESSAGE INDICATOR         */ 00455000
BADIO    OI    FBADIO(COMPTR),B'00000100'                          0133 00456000
*   SDIORC=RETC;                    /* SAVE RETURN CODE FROM IO RTN  */ 00457000
         MVC   SDIORC(1,COMPTR),RETC                               0134 00458000
*   GOTO EXITCODE;                  /* ISSUE WARNING MSG       Y02676*/ 00459000
         B     EXITCODE                                            0135 00460000
*BADWRITA:                          /* UNSUCCESSFUL RETURN FROM SDIO    00461000
*                                      AFTER WRITE                   */ 00462000
*   FBADRITA='1'B;                  /* SET MESSAGE INDICATOR         */ 00463000
BADWRITA OI    FBADRITA(COMPTR),B'00000010'                        0136 00464000
*   SDIORC=RETC;                    /* SAVE RETURN CODE FROM IO RTN  */ 00465000
         MVC   SDIORC(1,COMPTR),RETC                               0137 00466000
*EXITCODE:                          /* END OF PROCESSING, CLEANUP AND   00467000
*                                      RETURN                        */ 00468000
*   RETURN;                         /* RETURN TO CALLER        Y02676*/ 00469000
@EL00001 L     @13,4(,@13)                                         0138 00470000
@EF00001 L     @00,@SIZDATD                                        0138 00471000
         LR    @01,@12                                             0138 00472000
         FREEMAIN R,LV=(0),A=(1)                                        00473000
@ER00001 LM    @14,@12,12(@13)                                     0138 00474000
         BR    @14                                                 0138 00475000
*   GEN;                                                           0139 00476000
LISTBEG  ENQ   (QNAME,,E,3,SYSTEM),RET=HAVE,MF=L                        00477000
         DEQ   (QNAME,,3,SYSTEM),RET=HAVE,MF=L                          00478000
LISTEND  EQU   *                       END OF LIST FORMS                00479000
SPARE    DC    50X'00'              PATCH AREA                          00480000
*   END IEEVSND2                                                   0140 00481000
*                                                                  0140 00482000
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM.     */ 00483000
*/*%INCLUDE SYSLIB  (IKJZT301)                                       */ 00484000
*/*%INCLUDE SYSLIB  (IKJZT304)                                       */ 00485000
*/*%INCLUDE SYSLIB  (IKJZT305)                                       */ 00486000
*                                                                  0140 00487000
*       ;                                                          0140 00488000
         B     @EL00001                                            0140 00489000
@DATA    DS    0H                                                       00490000
@CH00047 DC    H'1'                                                     00491000
@CH00163 DC    H'9'                                                     00492000
@CH00164 DC    H'13'                                                    00493000
@SM00237 MVC   USMTEXT(0,@10),COMBUF-1(@01)                             00494000
@DATD    DSECT                                                          00495000
         DS    0F                                                       00496000
@SA00001 DS    18F                                                      00497000
@PC00001 DS    1F                                                       00498000
@SAV001  EQU   @SA00001                                                 00499000
@TF00001 DS    F                                                        00500000
@TF00002 DS    F                                                        00501000
@ZTEMPS  DS    0F                                                       00502000
@ZT00001 DC    F'0'                                                     00503000
@ZT00003 DC    F'0'                                                     00504000
@ZTEMPND EQU   *                                                        00505000
@ZLEN    EQU   @ZTEMPND-@ZTEMPS                                         00506000
@TEMPS   EQU   @ZTEMPS                                                  00507000
@L       EQU   @ZLEN                                                    00508000
IEEVSND2 CSECT                                                          00509000
         DS    0F                                                       00510000
@CF00233 DC    F'-13'                                                   00511000
@CF00236 DC    F'-6'                                                    00512000
@CF00239 DC    F'-3'                                                    00513000
@DATD    DSECT                                                          00514000
         DS    0D                                                       00515000
         DS    CL1                                                      00516000
R1PTR    DS    AL3                                                      00517000
         DS    CL1                                                      00518000
USDPTR   DS    AL3                                                      00519000
         DS    CL1                                                      00520000
USMPTR   DS    AL3                                                      00521000
         DS    CL1                                                      00522000
RNUSD    DS    AL3                                                      00523000
J        DS    AL1                                                      00524000
USMADD   DS    AL3                                                      00525000
         DS    CL1                                                      00526000
USDADD   DS    AL3                                                      00527000
RETC     DS    AL1                                                      00528000
         DS    CL3                                                      00529000
DIRAREA  DS    CL129                                                    00530000
         DS    CL3                                                      00531000
MSGAREA  DS    CL129                                                    00532000
         DS    CL3                                                      00533000
MSGAREA2 DS    CL129                                                    00534000
         DS    CL3                                                      00535000
AUTOLIST DS    CL24                                                     00536000
         ORG   AUTOLIST                                                 00537000
ENQEL    DS    CL12                                                     00538000
DEQL     DS    CL12                                                     00539000
         ORG   AUTOLIST+24                                              00540000
         ORG   *+1-(*-@DATD)/(*-@DATD) INSURE DSECT DATA                00541000
@ENDDATD EQU   *                                                        00542000
@DATEND  EQU   *                                                        00543000
IEEVSND2 CSECT                                                          00544000
         DS    0F                                                       00545000
@SIZDATD DC    AL1(0)                                                   00546000
         DC    AL3(@ENDDATD-@DATD)                                      00547000
@SIZ001  EQU   @SIZDATD                                                 00548000
@CV00205 DC    V(IEEVSND5)                                              00549000
         DS    0D                                                       00550000
USDKEY   DC    X'01'                                                    00551000
USMKEY   DC    X'03'                                                    00552000
QNAME    DC    CL8'SYSIKJBC'                                            00553000
BLNKID   DC    CL8'        '                                            00554000
ZEROES   DC    13AL1(0)                                                 00555000
@00      EQU   00                      EQUATES FOR REGISTERS 0-15       00556000
@01      EQU   01                                                       00557000
@02      EQU   02                                                       00558000
@03      EQU   03                                                       00559000
@04      EQU   04                                                       00560000
@05      EQU   05                                                       00561000
@06      EQU   06                                                       00562000
@07      EQU   07                                                       00563000
@08      EQU   08                                                       00564000
@09      EQU   09                                                       00565000
@10      EQU   10                                                       00566000
@11      EQU   11                                                       00567000
@12      EQU   12                                                       00568000
@13      EQU   13                                                       00569000
@14      EQU   14                                                       00570000
@15      EQU   15                                                       00571000
@0       EQU   00                                                       00572000
@1       EQU   01                                                       00573000
@2       EQU   02                                                       00574000
@3       EQU   03                                                       00575000
@4       EQU   04                                                       00576000
@5       EQU   05                                                       00577000
@6       EQU   06                                                       00578000
@7       EQU   07                                                       00579000
@8       EQU   08                                                       00580000
@9       EQU   09                                                       00581000
@A       EQU   10                                                       00582000
@B       EQU   11                                                       00583000
@C       EQU   12                                                       00584000
@D       EQU   13                                                       00585000
@E       EQU   14                                                       00586000
@F       EQU   15                                                       00587000
COMPTR   EQU   @03                                                      00588000
R1       EQU   @01                                                      00589000
I        EQU   @04                                                      00590000
R15      EQU   @15                                                      00591000
COMMON   EQU   0                                                        00592000
COMMONA  EQU   COMMON                                                   00593000
VALCNT   EQU   COMMONA+2                                                00594000
MSGFLAGS EQU   COMMONA+3                                                00595000
FLAGS    EQU   COMMONA+4                                                00596000
FCHNMSG  EQU   FLAGS                                                    00597000
FUPUSD   EQU   FLAGS                                                    00598000
FENDUSL  EQU   FLAGS                                                    00599000
@NM00002 EQU   FLAGS+1                                                  00600000
@NM00003 EQU   FLAGS+2                                                  00601000
@NM00004 EQU   FLAGS+3                                                  00602000
FSOURCE  EQU   @NM00004                                                 00603000
FMSG1    EQU   @NM00004                                                 00604000
FBADIO   EQU   @NM00004                                                 00605000
FBADRITA EQU   @NM00004                                                 00606000
IDCNT    EQU   COMMONA+12                                               00607000
SDIORC   EQU   COMMONA+16                                               00608000
TBEG     EQU   COMMONA+20                                               00609000
TEXTLENG EQU   COMMONA+28                                               00610000
COMMONB  EQU   COMMON+160                                               00611000
COMBUF   EQU   COMMONB                                                  00612000
COMMONC  EQU   COMMON+284                                               00613000
IDUSRID  EQU   COMMONC                                                  00614000
OPERID   EQU   COMMONC+160                                              00615000
SDIOPARM EQU   COMMONC+168                                              00616000
@NM00006 EQU   SDIOPARM                                                 00617000
P1READ   EQU   @NM00006                                                 00618000
@NM00007 EQU   SDIOPARM+1                                               00619000
P2WRDI   EQU   @NM00007                                                 00620000
P2WRDAF  EQU   @NM00007                                                 00621000
PARMKEY  EQU   SDIOPARM+2                                               00622000
PARMRBA  EQU   SDIOPARM+4                                               00623000
PARMIOAD EQU   SDIOPARM+8                                               00624000
PARMRCD1 EQU   COMMONC+196                                              00625000
R1BC     EQU   0                                                        00626000
R1BCPTRP EQU   R1BC                                                     00627000
R1USPTRP EQU   R1BC+4                                                   00628000
R1USPTR  EQU   R1USPTRP+1                                               00629000
USDIR    EQU   0                                                        00630000
USDENTRY EQU   USDIR                                                    00631000
USDID    EQU   USDENTRY                                                 00632000
USDRBA   EQU   USDENTRY+7                                               00633000
USDEND   EQU   USDENTRY+10                                              00634000
USDNEXT  EQU   USDIR+126                                                00635000
USMSG    EQU   0                                                        00636000
USMLNG   EQU   USMSG                                                    00637000
USMTEXT  EQU   USMSG+1                                                  00638000
USMNEXT  EQU   USMSG+126                                                00639000
COMMONP  EQU   0                                                        00640000
ZERENT   EQU   ZEROES                                                   00641000
*                                      START UNREFERENCED COMPONENTS    00642000
USDREND  EQU   USDIR+125                                                00643000
@NM00009 EQU   USDIR+117                                                00644000
@NM00008 EQU   R1BC+45                                                  00645000
R1LEVEL  EQU   R1BC+38                                                  00646000
R1DSN    EQU   R1BC+14                                                  00647000
R1BCMAX  EQU   R1BC+12                                                  00648000
R1RECNUM EQU   R1BC+8                                                   00649000
R1USFLGS EQU   R1USPTRP                                                 00650000
R1BCPTR  EQU   R1BCPTRP+1                                               00651000
R1BCFLGS EQU   R1BCPTRP                                                 00652000
PARMDCB  EQU   COMMONC+192                                              00653000
PARMLMCT EQU   COMMONC+188                                              00654000
PARMDDNM EQU   SDIOPARM+12                                              00655000
PARMFDBK EQU   SDIOPARM+3                                               00656000
P2DEVAD  EQU   @NM00007                                                 00657000
P2DEL    EQU   @NM00007                                                 00658000
P2CLOSE  EQU   @NM00007                                                 00659000
P1READ1  EQU   @NM00006                                                 00660000
P1CREATE EQU   @NM00006                                                 00661000
P1OPEN   EQU   @NM00006                                                 00662000
@NM00005 EQU   COMMONC+167                                              00663000
MSG1EXT  EQU   COMMONA+36                                               00664000
CBCCONID EQU   COMMONA+34                                               00665000
CBCMSGNO EQU   COMMONA+32                                               00666000
ACCESSOR EQU   COMMONA+29                                               00667000
COMBUFP  EQU   COMMONA+25                                               00668000
COMI     EQU   COMMONA+24                                               00669000
CSCBPTR  EQU   COMMONA+21                                               00670000
RETVATT1 EQU   COMMONA+17                                               00671000
IDTBL    EQU   COMMONA+13                                               00672000
MSG1EXTP EQU   COMMONA+9                                                00673000
M1IND    EQU   COMMONA+8                                                00674000
FBADTPUT EQU   @NM00004                                                 00675000
FWTO2    EQU   @NM00004                                                 00676000
FERRSYN  EQU   @NM00004                                                 00677000
FCONSOL  EQU   FSOURCE                                                  00678000
FTERM    EQU   FSOURCE                                                  00679000
FERRID   EQU   @NM00003                                                 00680000
FTEXT    EQU   @NM00003                                                 00681000
FALL     EQU   @NM00003                                                 00682000
FLOGON   EQU   @NM00003                                                 00683000
FNOW     EQU   @NM00003                                                 00684000
FLIST    EQU   @NM00003                                                 00685000
FLISTALL EQU   @NM00003                                                 00686000
FDEL     EQU   @NM00003                                                 00687000
FCNS     EQU   @NM00002                                                 00688000
FMAILFL  EQU   @NM00002                                                 00689000
FUSER    EQU   @NM00002                                                 00690000
FBRDCST  EQU   @NM00002                                                 00691000
FMN      EQU   @NM00002                                                 00692000
FADDBC   EQU   @NM00002                                                 00693000
FYESBCM  EQU   @NM00002                                                 00694000
FNOMSG   EQU   @NM00002                                                 00695000
FLISTING EQU   FLAGS                                                    00696000
FOVER20  EQU   FLAGS                                                    00697000
FBADSEND EQU   FLAGS                                                    00698000
FANYINV  EQU   FLAGS                                                    00699000
FOPEN    EQU   FLAGS                                                    00700000
FMSGA    EQU   MSGFLAGS                                                 00701000
FMSG9    EQU   MSGFLAGS                                                 00702000
FMSG8    EQU   MSGFLAGS                                                 00703000
FMSG6    EQU   MSGFLAGS                                                 00704000
FMSG5    EQU   MSGFLAGS                                                 00705000
FMSG4    EQU   MSGFLAGS                                                 00706000
FMSG3    EQU   MSGFLAGS                                                 00707000
FMSG2    EQU   MSGFLAGS                                                 00708000
TPUTRC   EQU   COMMONA+1                                                00709000
@NM00001 EQU   COMMONA                                                  00710000
*                                      END UNREFERENCED COMPONENTS      00711000
@RT00044 EQU   BADIO                                                    00712000
@RT00049 EQU   LPEND1                                                   00713000
@RT00052 EQU   VALIDID                                                  00714000
@RT00056 EQU   DEQUSD                                                   00715000
@RT00066 EQU   BADIO                                                    00716000
@RT00080 EQU   CHAINUM                                                  00717000
@RT00095 EQU   BADWRITA                                                 00718000
@RT00099 EQU   CHAIN3                                                   00719000
@RT00103 EQU   SCIDLST                                                  00720000
@RT00117 EQU   BADIO                                                    00721000
@RT00129 EQU   BADIO                                                    00722000
EXITCODE EQU   @EL00001                                                 00723000
@RT00070 EQU   EXITCODE                                                 00724000
@EL01    EQU   @EL00001                                                 00725000
@ENDDATA EQU   *                                                        00726000
         END   IEEVSND2                                                 00727000
