         TITLE 'IGC0001F - PROLOG'                                      00010002
***************************************************************         00050002
*                                                             *         00100002
* MODULE NAME = IGC0001F                                      *         00150002
*                                                             *         00200002
* DESCRIPTIVE NAME = I/O REQUEST PURGE ROUTINE                *         00250002
*                                                             *         00300002
* COPYRIGHT NAME = ''NONE''                                   *         00350002
*                                                             *         00400002
* STATUS = OS/VS2 RELEASE 2, CHANGE LEVEL 00                  *         00450002
*                                                             *         00500002
* FUNCTION =                                                  *         00550002
* THIS ROUTINE WILL REMOVE I/O REQUESTS FROM THE              *         00950002
* FOLLOWING QUEUES: THE RB QUEUE, THE IOS LOGICAL CHANNEL     *         01000002
* QUEUES, DDRCOM, GLOBAL AND LOCAL SPL, AND SIRB.             *         01050002
*                                                             *         01100002
* NOTES = 1. WHEN HIO OPTION IS GIVEN, RESTORING THE I/O      *         01160002
* REQUESTS CANNOT BE DONE.  IN HIO OPTION, REQUESTS ARE       *         01200002
* DEQUED AND NOT CHAINED TO A LINKFIELD; THUS THEY CANNOT     *         01250002
* BE RESTARTED.                                               *         01300002
* 2. IN QUIESCE OPTION, THE PURGE CHAIN FIELD OF THE          *         01350002
* PARAMETER LIST CANNOT POINT TO ITSELF.                      *         01400002
* 3. IN QUIESCE OPTION, CHAIN FIELD IN THE INPUT PARAMETER    *         01450002
* LIST WILL POINT TO THE PIRL.                                *         01500002
* 4. IN QUIESCE OPTION, REQUEST ELEMENTS WHICH HAVE REACHED   *         01550002
* THE CHANNEL SCHEDULER WILL BE ALLOWED TO COMPLETE.  THOSE   *         01600002
* WHICH ARE ON THE QUEUES OF THE DRIVERS WILL BE CHAINED TO   *         01610002
* THE LINK FIELD SPECIFIED IN THE INPUT PARAMETER LIST VIA    *         01650002
* THE PIRL, AND IF POST OPTION WAS SPECIFIED THEIR ECB WILL   *         01700002
* BE POSTED AS PURGED.                                        *         01900002
* 5. RB PURGE IS INVALID FOR: MEMORY PURGE,                   *         01950002
* TCB PURGE (QUIESCE OPTION) OF CURRENT TCB,                  *         01960002
* AND RB PURGE ONLY SPECIFIED.                                *         01970002
*                                                             *         02020002
* THIS ROUTINE ALSO BRANCHES TO IECVPURG TO DECREMENT         *@YM3154P 02030002
* THE IPIB QUIESCE COUNT.                                     *@YM3154P 02040002
*                                                             *         02042002
*    DEPENDENCIES = EBCDIC                                    *         02050002
*                                                             *         02060002
*    RESTRICTIONS = IRB ROUTINES ACTIVE WHEN PURGE            *         02100002
*    WITH THE HIO OPTION IS ISSUED WILL NOT HAVE              *         02110002
*    CONTROL RETURNED TO THEM.  THIS ROUTINE WILL             *         02120002
*    SET THEIR RESUME PSW TO A PURGE CLEAN UP                 *         02130002
*    ROUTINE AND THEN ISSUE SVC 3 WHEN IT IS FINISHED.        *         02140002
*                                                             *         02142002
*    REGISTER CONVENTIONS = SVC LINKAGE                       *         02150002
*    SEE REGISTER EQUATES                                     *         02152002
*                                                             *         02160002
*    PATCH LABEL = PURGEZAP                                   *         02200002
*                                                             *         02250002
* MODULE TYPE = SVC                                           *         02300002
*    PROCESSOR = ASSEMBLER                                    *         02310002
*    MODULE SIZE = 116C HEX BYTES                             *         02350002
*    ATTRIBUTES = REENTRANT, KEY 0, SUPERVISOR STATE          *         02360002
*                                                             *         02370002
* ENTRY POINT = IGC016                                        *         02400002
*    PURPOSE = ALL FUNCTIONS                                  *         02450002
*    LINKAGE = SVC                                            *         02500002
*                                                             *         02510002
* INPUT = REGISTER 1 CONTAINS ADDRESS OF PURGE PARAMETER LIST.*         02550002
*       = REGISTER 1 CONTAINS IPIB ADDRESS IN COMPLIMENT FORM.*@YM3154P 02552002
*                                                             *         02560002
*    OUTPUT = REGISTER 15 CONTAINS A RETURN CODE IF CALLER    *         02600002
*    REQUESTS RETURN CODE BY SETTING PPLEXR IN PURGE          *         02610002
*    PARAMTER LIST                                            *         02620002
*     RETURN CODE                COMPLETION CODE              *         02630002
*   00 - SUCCESSFUL PURGE        PPLCC = 7F                   *         02654002
*        (DEFAULT IF PPLEXR                                   *         02654402
*        IS NOT SET)                                          *         02654802
*   04 - TCB NOT PURGABLE        PPLCC = 40                   *         02656002
*   08 - DSID NOT PURGABLE       PPLCC = 40                   *         02658002
*   12 - I/O WAS HALTED          PPLCC = 40                   *         02658402
*   16 - TP I/O WAS HALTED       PPLCC = 40                   *         02658802
*   20 - ENQ WAS UNSUCCESSFUL    PPLCC = 40                   *         02659202
*                                                             *         02659602
*    EXITS-NORMAL = RETURN TO CALLER                          *         02660002
*                                                             *         02670002
*    EXITS-ERROR = FRR AND ESTAE                              *         02680002
*                                                             *         02690002
* EXTERNAL REFERENCES =                                       *         02692002
*    ROUTINES =                                               *         02694002
*       IECVSMGR                                              *         02696002
*       IFGDEBVR                                              *         02698002
*       IECIHIO                                               *         02698402
*       DRIVERS OF IOS                                        *         02698802
*    DATA AREAS =                                             *         02699602
*       PPL - PURGE PARAMETER LIST                            *         02699702
*       IPIB - IOS PURGE INTERFACE BLOCK                      *         02701702
*       PIRL - I/O RESTORE LIST                               *         02703002
*       PWA - PURGE WORK AREA                                 *         02706702
*       PFRRPARM - FRR PARAMETERS                             *         02710002
*       SDBF - 4K SDUMP BUFFER                                *         02713302
*    CONTROL BLOCKS =                                         *         02716602
*       IECDPPL      IECDIPIB     IECDPIRL                    *         02726602
*       IHADDR       IEZDEB       IECDLCH                     *         02728602
*       IHASRB       IKJTCB       IHAPSA                      *         02730602
*       IHALCCA      IECDIRT      IEFUCBOB                    *         02732602
*       IECDIOCM     IECDIOCX     IECDIOQ                     *         02733002
*       IECDVOID     IECDERWA     IECDIOSB                    *         02733102
*       IECDSIAB     CVT          IHAASCB                     *         02733202
*       IHAASXB      IHAFRRS      IHASDWA                     *         02738802
*       IHARB        IHAASVT                                  *         02740802
* TABLES =                                                    *         02744402
*    PURGE PARAMETER LIST                                     *         02746402
*                                                             *         02748402
* MACROS =                                                    *         02748802
*    GETMAIN      FREEMAIN     ESTAE                          *         02750002
*    PGFIX        PGFREE       WAIT                           *         02760002
*    ENQ          DEQ          STATUS                         *         02770002
*    SETLOCK      SETFRR       PURGEDQ                        *         02780002
*    SCHEDULE     SDUMP        IOSGEN(RESTART)                *         02790002
*                                                             *         02792002
* LOCKS = LOCAL, UCB, LCH, CMS, IOSYNCH                       *         02794002
*                                                             *         02800002
* CHANGE ACTIVITY = NONE                                      *         02810002
*                                                             *         02850002
***************************************************************         02900002
     TITLE     'IGC0001F-PURGE WORK AREA DSECT'                         02920002
PWA      DSECT                                                          02930002
         SPACE 1                                                        02940002
***************************************************************         02950002
*                                                             *         02952002
*        PURGE PARAMETER LIST                                 *         02954002
*                                                             *         02956002
***************************************************************         02958002
         IECDPPL             DSECT=NO                                   02958402
         EJECT                                                          02958502
***************************************************************         02958602
*                                                             *         02958702
*        IOS PURGE INTERFACE BLOCK                            *         02958802
*                                                             *         02959302
***************************************************************         02961302
         IECDIPIB            DSECT=NO                                   02967802
         EJECT                                                          02968402
***************************************************************         02968802
*                                                             *         02968902
*        PURGE WORK AREA                                      *         02969102
*                                                             *         02969502
***************************************************************         02969602
         SPACE                                                          02969902
PWREGSAV DC    18F'0'              REG SAVE AREA                        02970702
     ORG  PWREGSAV                                                      02971002
PWREG0   DC    F'0'                TEMPORARY REG SAVE AREA              02972002
PWREG1   DC    F'0'                *                                    02972602
PWREG2   DC    F'0'                *                                    02973202
PWREG3   DC    F'0'                *                                    02973802
PWREG4   DC    F'0'                *                                    02974402
PWREG5   DC    F'0'                *                                    02975002
PWREG6   DC    F'0'                *                                    02975602
PWREG7   DC    F'0'                *                                    02976202
PWREG8   DC    F'0'                *                                    02976802
PWREG9   DC    F'0'                *                                    02977402
PWREGA   DC    F'0'                *                                    02978002
PWREGB   DC    F'0'                *                                    02978602
PWREGC   DC    F'0'                *                                    02979202
PWREGD   DC    F'0'                *                                    02979802
PWREGE   DC    F'0'                *                                    02980402
PWREGF   DC    F'0'                *                                    02981002
PWRTEMP1 DC    2F'0'                                           @Y30IPLG 02981303
PQUEREG  DC    F'0'                TOTAL LCH COUNT                      02981602
PWAQCNT  DC    F'0'                PURGE QUIESCE COUNT                  02982202
PWPIRLNG DC    F'0'                PIRL LENGTH                          02982802
         EJECT                                                          02983402
*****************************************************************       02984002
*                                                               *       02984602
*  THESE FIVE LABELS MUST ALWAYS BE TOGETHER AS THEY FORM THE   *       02985202
*   FIX LIST PURGE USES TO FIX THE PIRL AND ITS OWN MODULE      *       02985802
*                                                               *       02986402
*****************************************************************       02987002
PWASAVP  DS    0F                  SAVE AREA POINTER                    02987602
PWAFIX   DC    F'0'                PAGE FIX - FIX LIST                  02988202
PWAFIX2  DC    F'0'                *                                    02988802
PWAFIX3  DC    F'0'                *                                    02989402
PWAFIX4  DC    F'0'                *                                    02990002
         SPACE 3                                                        02990402
*****************************************************************       02990602
*                                                               *       02992002
*        PURGEDQ PARAMETERS                                     *       02997002
*                                                               *       02997402
*****************************************************************       02998402
         SPACE                                                          02998802
         DS    0F                                              @YM01450 02999202
PWPRGPRM DS    0CL12               PURGEDQ PARM LIST           @YM01450 02999802
         ORG   PWPRGPRM                                        @YM01450 03000202
         PURGEDQ MF=L                                          @YM01450 03001202
PDQPARML DS    0D                  DWORD PARM FOR PURGEDQ      @YM01450 03003202
         ORG   PDQPARML                                        @YM01450 03003602
PDQPRSV1 DS    1H                  RESERVED                    @YM01450 03003702
PDQPASID DS    1H                  ASID                        @YM01450 03003802
PDQPRSV2 DS    XL1                 RESERVED                    @YM01450 03003902
PDQPTCBP DS    AL3                 TCB ADDRESS                 @YM01450 03004002
         EJECT                                                          03004102
PWAECB   DS    0F                  EVENT CONTROL BLOCK                  03004402
PWAUCBLK DC    F'0'                SAVE AREA FOR UCB LOCK ADDRESS       03005402
PWALCHLK DC    F'0'                SAVE AREA FOR LCH LOCK ADDRESS       03006802
PWAFRRPM DC    F'0'                PTR TO FRRPARM WA IF ONE    @Y30IPLG 03007503
PWRET1   DC    F'0'                RETURN ADDRESS FOR SUBROUTINES       03008202
PWRET2   DC    F'0'                *                                    03009602
MASK1    DC    XL1'0'              MASK FLAG BYTE                       03012402
MSKDEQ   EQU   X'80'               DEQ                                  03013802
MSKHIO   EQU   X'40'               HALT I/O                             03015202
MSKRDV   EQU   X'20'               REDRIVE IOS                          03016602
MSKUCB   EQU   X'10'               USED TO INDICATE RETRY HALT @OZ00762 03018003
MSKDDRM  EQU   X'08'               DDR                                  03019402
MSKNULL  EQU   X'04'               UNUSED                               03020802
MSKFREE  EQU   X'01'               PIRL MUST BE FREED                   03022202
MSKOFF   EQU   X'00'               ZERO THIS FLAG BYTE                  03023602
PURGRETC DC    XL1'0'              RETURN CODE FLAG BYTE                03025002
PURTT    EQU   X'01'               CALLED BY TASK TERMINATION           03026402
PURTCB   EQU   X'02'               TCB NOT PURGEABLE                    03027802
PURDSID  EQU   X'04'               DSID NOT PURGEABLE                   03029202
PURIO    EQU   X'08'               INDICATES I/O HALTED                 03030602
PURTP    EQU   X'10'               TP I/O HALTED                        03032002
PURNOENQ EQU   X'20'               ENQ UNSUCCESSFUL            @YM3104P 03032402
PURNG    EQU   X'40'               BAD PURGE COMPLETION                 03033402
PURGOOD  EQU   X'7F'               GOOD PURGE COMPLETION                03034802
PURRTCDT EQU   X'FE'               ERROR RETURN CODE TEST               03036202
PURERRCD EQU   X'E7'               ERROR CODE, NOT PURIO,PURTP @YM06011 03036902
PURRTCD0 EQU   0                   RETURN CODE OF 0                     03037602
PURRTCD4 EQU   4                   RETURN CODE OF 4                     03039002
PURRTCD8 EQU   8                   RETURN CODE OF 8                     03040402
PURRTCDC EQU   12                  RETURN CODE OF 12                    03041802
PURRTCD1 EQU   16                  RETURN CODE OF 16                    03043202
PURRTCD2 EQU   20                  RETURN CODE OF 20           @YM3104P 03043602
SUBPL0   EQU   0                   SUBPOOL 0                            03044602
PREGSAVL EQU   72                  18 WORD SAVE AREA                    03046002
PWASDUMP SDUMP MF=L                SDUMP LIST FORM                      03047402
PWADLIST DC    2A(0)               SDUMP LIST FOR PURGE CODE            03048802
         ORG   PWADLIST                                                 03050202
PWADLST1 DC    A(0)                FIRST LIST ENTRY                     03051602
PWADLST2 DC    A(0)                SECOND LIST ENTRY                    03053002
PWADLSTE EQU   X'80'               END OF DUMP LIST INDICATOR           03054402
PWAESTAE ESTAE MF=L                ESTAE LIST FORM                      03055802
PWAASCBP DC    A(0)                ACTIVE ASCB POINTER                  03057202
PWAUCBP  DC    A(0)                ACTIVE UCB POINTER                   03058602
PWALCHP  DC    A(0)                ACTIVE LCH POINTER                   03060002
PWASYNCH DC    A(0)                ACTIVE I/O SYNCH LOCK                03061402
PERRFLG0 DC    XL1'0'              FLAGS USED BY FRR AND ESTAE          03062802
PERPGCT  EQU   X'80'               IOCPGCT IS ACTIVE                    03064202
PERIOSP  EQU   X'40'               ASCBIOSP IS ACTIVE                   03065602
PERSTATS EQU   X'20'               STATUS IS START ACTIVE               03067002
PERENQ   EQU   X'10'               SRB ENQ IS ACTIVE                    03068402
PERSDBF  EQU   X'08'               4K SDWA BUFFER IS HELD               03069802
PERFIXA  EQU   X'04'               PAGE FIX IS ACTIVE          @Y30IPLG 03070503
PERRFLG1 DC    XL1'0'              FLAGS USED BY FRR AND ESTAE          03071202
PERLOCAL EQU   X'80'               LOCAL LOCK IS HELD                   03072602
PERLCH   EQU   X'40'               LCH LOCK IS HELD                     03074002
PERUCB   EQU   X'20'               UCB LOCK IS HELD                     03075402
PERCMS   EQU   X'10'               CMS LOCK IS HELD                     03076802
PERESTAE EQU   X'08'               ESTAE IS ACTIVE                      03078202
PERSYNCH EQU   X'04'               IOSYNCH LOCK IS HELD                 03079602
PURENQ   ENQ   (SYSZEC16,PURGE,E,5,STEP),RET=HAVE,MF=L         @YM05797 03080002
PURENQLN EQU   *-PURENQ            LENTH OF ENQ LIST           @YM05797 03080402
         DS    0F                  ALIGN TO FULLWORD                    03081002
PWALNG   EQU   *-PWA               LENGTH OF PURGE WORK AREA            03082402
         TITLE 'IGC0001F - FRR PARAMETER AND DUMP DSECTS'               03083802
*****************************************************************       03085202
*                                                               *       03086602
*        FRR PARAMETER DSECT                                    *       03088002
*                                                               *       03089402
*****************************************************************       03090802
         SPACE                                                          03092202
PFRRPARM DSECT                                                          03093602
PFRRPWAP DS    1F                  PURGE WORK AREA POINTER              03095002
PFRRFLG1 DS    XL1                 FLAG FOR FRR                @Y30IPLG 03095303
*PERLOCAL EQU  X'80'               LOCAL LOCK HELD DFINED PWA  @Y30IPLG 03095603
PFRRNOWA EQU  X'01'                 INDICATE TO FRR NO PWA     @Y30IPLG 03095703
         DS    XL3                 RESERVED                             03095903
         DS    4F                  RESERVED                             03096403
         SPACE 4                                                        03097802
*****************************************************************       03099202
*                                                               *       03100602
*        SVC DUMP 4K BUFFER                                     *       03102002
*                                                               *       03103402
*****************************************************************       03104802
SDBF     DSECT                                                          03106202
SDBFPTR  DS    1A                  POINTER TO DUMP START                03107602
SDBFCNT  DS    1H                  BUFFER BYTE COUNT                    03109002
SDBFSTRT DS    0H                  START OF SVC DUMP                    03110402
         DS    1H                  RESERVED HALFWORD                    03111802
SDBFPWA  DS    (PWALNG/4)F         PURGE WORK AREA                      03113202
SDBFVARY DS    F                   VARIABLE AREA FOR                    03114602
*                                  *UCB AND OR LCH AND IOQE'S           03116002
         TITLE 'IGC0001F - PIRL DSECT'                                  03117402
         IECDPIRL                                                       03118802
         TITLE 'IGC0001F - DDR COMMON DSECT'                            03120202
         IHADDR LIST=YES                                                03121602
         TITLE 'IGC0001F - DEB DSECT'                                   03123002
         IEZDEB                                                         03124402
         TITLE 'IGC0001F - LCH DSECT'                                   03125802
         IECDLCH                                                        03127202
         TITLE 'IGC0001F - SRB DSECT'                                   03128602
         IHASRB                                                         03130002
         TITLE 'IGC0001F - TCB DSECT'                                   03131402
         IKJTCB                                                         03132802
         TITLE 'IGC0001F - PSA DSECT'                                   03134202
         IHAPSA                                                         03135602
         TITLE 'IGC0001F - LCCA DSECT'                                  03137002
         IHALCCA                                                        03138402
         TITLE 'IGC0001F - IRT DSECT'                                   03139802
         IECDIRT                                                        03141202
         TITLE 'IGC0001F - UCB DSECT'                                   03142602
         IEFUCBOB PREFIX=YES,LIST=YES                                   03144002
         TITLE 'IGC0001F - IOCOM DSECT'                                 03145402
         IECDIOCM                                                       03146802
         TITLE 'IGC0001F - IOCOM EXTENSION EXTENSION DSECT'             03148202
         IECDIOCX                                                       03149602
         TITLE 'IGC0001F - IOQ DSECT'                                   03151002
         IECDIOQ                                                        03152402
         TITLE 'IGC0001F - VECTOR OF IOS DRIVERS DSECT'                 03153802
         IECDVOID                                                       03155202
         TITLE 'IGC0001F - ERP WORK AREA DSECT'                         03156602
         IECDERWA                                                       03158002
         TITLE 'IGC0001F - IOSB DSECT'                                  03159402
         IECDIOSB                                                       03160802
         TITLE 'IGC0001F - SIAB DSECT'                                  03162202
         IECDSIAB                                                       03163602
         TITLE 'IGC0001F - CVT DSECT'                                   03165002
         CVT DSECT=YES,LIST=YES                                         03166402
         TITLE 'IGC0001F - ASVT DSECT'                                  03166802
         IHAASVT                                                        03167202
         TITLE 'IGC0001F - ASCB DSECT'                                  03167802
         IHAASCB                                                        03169202
         TITLE 'IGC0001F - ASXB DSECT'                                  03170602
         IHAASXB                                                        03172002
         TITLE 'IGC0001F - FRR DSECT'                                   03173402
         IHAFRRS                                                        03174802
         TITLE 'IGC0001F - SDWA DSECT'                                  03176202
         IHASDWA                                                        03177602
         TITLE 'IGC0001F - RB DSECT'                                    03179002
         IHARB DSECT=YES                                                03180402
*                                                                       03181802
*                                                                       03183202
         ORG    RBRSV135                                                03184602
RBRETSAV DS    F                   SAVE AREA FOR RETURN FROM PURGE      03186002
RBPPLSAV DS    F                   SAVE AREA FOR PURGE PARM LIST PTR    03187402
RBPWASAV DS    F                   SAVE AREA FOR PURGE WRK AREA ADDR    03188802
         TITLE 'IGC0001F - REGISTER DEFINITIONS'                        03190202
*****************************************************************       03191602
*                                                               *       03193002
*        REGISTER DEFINITIONS                                   *       03194402
*                                                               *       03195802
*****************************************************************       03197202
         SPACE                                                          03198602
R0       EQU   0                   WORK REG 0                           03200002
RCVRY00  EQU   R0                  RECOVERY REG 0                       03210002
RPAR     EQU   1                   INPUT PARAMETER LIST POINTER         03250002
RSRB     EQU   RPAR                POINTER TO SRB                       03300002
RCVRY01  EQU   RPAR                RECOVERY REG 1                       03310002
R2       EQU   2                   WORK REG 2                           03350002
RCVRY02  EQU   R2                  RECOVERY REG 2                       03360002
RBASE    EQU   3                   BASE REG                             03400002
RCVRY03  EQU   RBASE               RECOVERY REG 3                       03410002
R4       EQU   4                   WORK REG                             03450002
RCVRY04  EQU   R4                  RECOVERY REG 4                       03460002
RSVRB    EQU   5                   POINTER TO CURRENT SVRB              03500002
RCUR     EQU   RSVRB               CURRENT IOQ                          03550002
R5       EQU   RSVRB               WORK REG                             03600002
RCVRY05  EQU   RSVRB               RECOVERY REG 5                       03610002
RCORE    EQU   6                   POINTER TO PURGE WORK AREA           03650002
RCVRY06  EQU   RCORE               RECOVERY REG 6                       03660002
RUCB     EQU   7                   POINTER TO UCB PREFIX                03700002
RCVRY07  EQU   RUCB                RECOVERY REG 7                       03710002
RPIRL    EQU   8                   POINTER TO PIRL                      03750002
RCVRY08  EQU   RPIRL               RECOVERY REG 8                       03760002
RNINE    EQU   9                   WORK REG 9                           03800002
RBACK    EQU   RNINE               BACK POINTER                         03850002
RCVRY09  EQU   RNINE               RECOVERY REG 9                       03860002
R10      EQU   10                  WORK REG 10                          03900002
RIOSB    EQU   R10                 POINTER TO IOSB                      03910002
RCVRY10  EQU   R10                 RECOVERY REG 10                      03920002
RB       EQU   11                  WORK REG 11                          03950002
RCVRY11  EQU   RB                  RECOVERY REG 11                      03960002
RC       EQU   12                  WORK REG 12                          04000002
RCVRY12  EQU   RC                  RECOVERY REG 12                      04010002
RD       EQU   13                  WORK REG 13                          04050002
RCVRY13  EQU   RD                  RECOVERY REG 13                      04060002
RET      EQU   14                  RETURN REG                           04100002
RCVRY14  EQU   RET                 RECOVERY REG 14                      04110002
RF       EQU   15                  WORK REG 15 AND ENTRY REG            04150002
RCVRY15  EQU   RF                  RECOVERY REG 15                      04152002
         TITLE 'IGC0001F - MISCELLANEOUS EQUATES'                       04160002
*****************************************************************       04160402
*                                                               *       04160802
*        MISCELLANEOUS EQUATES                                  *       04160902
*                                                               *       04161202
*****************************************************************       04161602
         SPACE                                                          04161702
FREE160  EQU  X'20'                160 BYTE BLOCK                       04162002
ZERO     EQU   0                   CONSTANT OF ZERO                     04166002
ONE      EQU   1                   CONSTANT OF ONE                      04168002
FOUR     EQU   4                   CONSTANT OF FOUR                     04168402
SEVEN    EQU   7                   CONSTANT OF SEVEN                    04168802
K00      EQU   0                   DISP/LENGTH OF 0                     04168902
K01      EQU   1                   DISP/LENGTH OF 1                     04169002
K02      EQU   2                   DISP/LENGTH OF 2                     04169102
K03      EQU   3                   DISP/LENGTH OF 3                     04170602
K04      EQU   4                   DISP/LENGTH OF 4                     04171002
K05      EQU   5                   DISP/LENGTH OF 5                     04171102
K08      EQU   8                   DISP/LENGTH OF 8                     04171402
K12      EQU   12                  DISP/LENGTH OF 12                    04171802
K16      EQU   16                  DISP/LENGTH OF 16                    04172202
K24      EQU   24                  DISP/LENGTH OF 24                    04172302
NOP      EQU   3                   NOP                                  04172402
MSASID   EQU   1                   MASTER SCHEDULAR ASID                04173902
FF       EQU   255                 CONSTANT OF 255                      04175402
SILI     EQU   X'20'               SILI INDICATOR                       04176902
XFF      EQU   X'FF'               ANDING CONSTANT                      04189902
BRINCR   EQU   4                   RECOVERY BRANCH TABLE INCREMENT      04191902
LOCKS00  EQU   0                   CLEAR SDWA LOCKS                     04192302
NIP02TST EQU   X'F0'               TEST FOR IEAVNP02 IN CONTROL         04192702
*                                  *SEE ENTRY/LABEL IECVNP02            04193102
PGFIXIND EQU   X'40'               PAGE FIX INDICATOR                   04194402
PGFIXEOL EQU   X'80'               PAGE FIX/FREE END OF LIST            04194802
PGFREIND EQU   X'20'               PAGE FREE INDICATOR                  04195202
DBLENTRY EQU   X'80'               SIRB/EWA DOUBLE ENTRY IND            04195602
EXCPTST  EQU   X'00'               TEST FOR EXCP DSID PURGE    DCR21082 04198302
EXCPID   EQU   2                   EXCP DRIVER ID              DCR21082 04200302
UCBBOFF1 EQU   X'49'               NRY,CUB,QISCE, BITS LEFT ON @YM04940 04200602
UCBBOFF2 EQU   X'9F'               IORST,RESVH, & RSRVD BITS ON@YM04940 04200902
         TITLE 'IGC0001F - MAIN ROUTINE'                                04201402
*****************************************************************       04204102
*                                                               *       04206802
*        ESTABLISH ADDRESSABILITY                               *       04209502
*                                                               *       04212202
*****************************************************************       04214902
         SPACE                                                          04217602
IGC016   CSECT                                                          04220302
         SPACE                                                          04223002
         ENTRY IECVNP02            LABEL USED BY IEAVNP02               04225702
*                                  *TO MODIFY INSTRUCTION               04228402
*                                  *USED TO DETERMINE IF                04231102
*                                  *NIP IS IN CONTROL                   04233802
         SPACE                                                          04236502
MAINTAIN EQU   *                   MAINTENANCE REFERENCE                04239202
         SPACE                                                          04241902
         BALR  RBASE,R0            ESTABLISH BASE                       04244602
         SPACE                                                          04247302
         USING *,RBASE                                                  04250002
         USING PSA,R0                                                   04300002
         USING RBBASIC,RSVRB                                            04350002
         USING CVTMAP,RF                                                04400002
         USING IOCOM,RC                                                 04450002
         USING PWA,RCORE                                                04500002
         USING PIRL,RPIRL                                               04550002
         USING IOSB,RIOSB                                               04600002
         USING SRB,RSRB                                                 04650002
         USING UCB,RUCB                                                 04700002
         SPACE                                                          04710002
         ST    RET,RBRETSAV        SAVE PURGE RETURN ADDRESS            04750002
         SPACE                                                          04760002
         ST    RPAR,RBPPLSAV       SAVE PARM LIST POINTER IN SVRB       04800002
         SPACE                                                          04810002
         L     RF,CVTPTR           GET POINTER TO CVT          @YM3154P 04820002
         L     RC,CVTIXAVL         PICK UP IOCOM ADDRESS       @YM3154P 04830002
         SPACE                                                          04832002
         LTR   RPAR,RPAR           DECREMENT QUIESCE COUNT     @YM3154P 04834002
         BNM   PRG003              NO, NORMAL PURGE REQUEST    @YM3154P 04836002
         TITLE 'IGC0001F - DECREMENT IPIB QUIESCE COUNT ROUTINE'        04840002
***************************************************************         04850002
*                                                             *         04851102
*        IPIB QUIESCE COUNT DECREMENT ENTRY                   *         04851502
*                                                             *         04853102
***************************************************************         04854002
         SPACE                                                          04855002
         L     RF,IOCQCNT          GET ADDR OF IECVPURG        @YM3154P 04855302
         LR    R0,RPAR             IND LOCAL LOCK NOT HELD     @YM3154P 04855702
         LCR   RPAR,RPAR           MAKE IPIB ADDR POSITIVE     @YM3154P 04856102
         LA    RET,0(RPAR)         CLEAR HIGH ORD BYTE IPIB ADD@YM06598 04856302
         L     R10,PSAAOLD         GET CURRENT ASCB ADDR       @YM06598 04858102
         CS    RET,RET,ASCBIOSP-ASCB(R10)  CHECK IF VALID IPIB @YM06598 04859602
         BNE   PRGINVAL            IPIB NOT VALID, RETURN      @YM06598 04860202
** NOTE THERE CAN BE A MAX OF 2 IPIBS PER MEM & 1ST MUST BE A QUIESCE   04860302
         SPACE                                                          04860402
         BALR  RET,RF              CALL IECVPURG               @YM3154P 04860502
         SPACE                                                          04863102
PRGINVAL L     RET,RBRETSAV        RESTORE RETURN ADDR         @YM3154P 04863702
         SPACE                                                          04864702
         BR    RET                 RETURN TO CALLER            @YM3154P 04865702
         TITLE 'IGC0001F - MAIN ROUTINE'                                04869502
***************************************************************         04870502
*                                                             *         04871502
*        GET CORE FOR I/O RESTORE LIST (PIRL)                 *         04872502
*                                                             *         04873502
***************************************************************         04874502
         SPACE                                                          04878502
PRG003   LR    R2,RPAR             SAVE PARM LIST ADDR         @YM3154P 04879503
***      NOTE, SPACE NO LONGER GOTTEN FOR SAVE AREA IN PIRL    @YM04935 04880502
         L     R4,PSATOLD          PICK UP TCB/ASCB POINTERS   @Y30IPLG 04881503
         L     RUCB,PSAAOLD        GET CURRENT ASCB ADDR       @Y30IPLG 04882103
         LH    RNINE,IOCVOICT      GET COUNT OF VOID ENTRIES            04882502
         SLL   RNINE,3             MULT BY 8 FOR NUM BYTES IN PIRL      04887502
*    EXTRA 12 BYTES OBTAINED FOR PIRL, USED BY RESTORE IN A    @ZA05813 04887840
*    FREEMAIN TO VALIDITY CHECK PIRL                           @ZA05813 04888140
         LA    R0,PIRRSTR-PIRL+12(,RNINE)  ADD PIRL HEADER +12 @ZA05813 04888540
*                                  LNTH OF PIRL                         04889502
         LR    RNINE,R0            SAVE LENGTH OF PIRL         @Y30IPLG 04892403
         SPACE                                                          04892503
*        NOTE REGS 10-15 LOST HERE                                      04892603
         L    R10,PGLOCALA       GET ADDR FOR SPCL LOC LOK RTN @Y30IPLG 04893603
         BALR  RF,R10              GET LOCAL LOCK AND FRR      @Y30IPLG 04896003
         SPACE                                                          04896103
         ICM   R0,K08,PIRLSUBP     INDICATE SUB POOL 254      @Y30IPLG  04897403
         SPACE                                                          04898403
*    NOTE: STORAGE ACTUALLY COMES FROM SUBPOOL 254 INSTEAD OF 0         04900903
         SPACE                                                          04901903
         GETMAIN R,LV=(0),BRANCH=YES       SPACE FOR PIRL      @Y30IPLG 04902903
         SPACE                                                          04904903
         BCTR  RNINE,R0            DECREMENT FOR EX INST                04906903
         EX    RNINE,PCLEAR        CLEAR GOTTEN AREA                    04910003
         LR    RPIRL,RPAR          SAVE PIRL ADDRESS IN RPIRL           04912003
         LA    RNINE,1(,RNINE)     ADD ONE TO GET BACK LNTH   @Y30IPLG  04913003
         SPACE                                                          04914003
***************************************************************         04916003
*                                                             *         04918003
*        GET CORE FOR PURGE WORK AREA (PWA),                  *         04920003
*        WHICH INCLUDES PURGE PARAMETER LIST (PPL),           *         04922003
*        AND IOS PURGE INTERFACE BLOCK (IPIB).                *         04924003
*                                                             *         04926003
***************************************************************         04928003
         SPACE                                                          04930002
         L     R0,COREMASK    GET SUBPOOL & LNTH              @Y30IPLG  04940003
         SPACE                                                          04960002
         GETMAIN R,LV=(0),BRANCH=YES    GET SPACE FOR PWA     @@Y30IPLG 05000003
         SPACE                                                          05050002
         ST    RPAR,RBPWASAV       SAVE ADDRESS OF WORK AREA IN SVRB    05500002
         LR    RCORE,RPAR          SET BASE FOR WORK AREA               05550002
         XC    PWA(PWASAVP-PWA),PWA     CLEAR 1ST PWASAVP-PWA  @YM05797 05600002
         XC    PWASAVP(PURENQ-PWASAVP),PWASAVP    CLEAR REST   @YM07220 05602002
*                                  DONT NEED TO ZERO ENQ LIST           05605002
         STH   RNINE,PWPIRLNG         SAVE PIRL LENGTH         @Y30IPLG 05610003
         MVC   0(K12,RCORE),0(R2) MOVE PARM LIST TO WORK AREA  @Y30IPLG 05650003
         L    RF,CVTPTR            GET CVT PTR (RELOAD IT)     @Y30IPLG 05653003
         L    RC,CVTIXAVL          GET IOCOM ADDR (RELOAD)     @Y30IPLG 05656003
         EJECT                                                          05660402
*****************************************************************       05662002
*                                                               *       05664002
*        ISSUE ESTAE TO PROTECT RESOURCES NOT COVERED BY FRR    *       05664402
*                                                               *       05666002
*****************************************************************       05668002
         SPACE                                                          05670002
         L     RUCB,PURGESTA       GET ESTAE ENTRY ADDR        @YM3104P 05672003
         SPACE                                                          05674002
         ESTAE (RUCB),PARAM=(6),RECORD=YES,PURGE=NONE,ASYNCH=YES,      *05680003
               MF=(E,PWAESTAE),BRANCH=YES,SVEAREA=PWREGSAV     @Y30IPLG 05682003
*        LIST FORM IS NOT MOVED IN                             @YM04162 05684003
*                                                    AND ALSO: @YM3104P 05687002
         SPACE                                                          05690002
         LTR   RF,RF               ANY PROBLEM WITH ESTAE               05692002
         BNZ   PRG005              YES, SKIP SETTING ESTAE ACTIVE       05694002
         SPACE                                                          05696002
         OI    PERRFLG1,PERESTAE   IND ESTAE ACTIVE                     05698002
         EJECT                                                          05698402
***************************************************************         05698802
*                                                             *         05698902
*        PAGE FIX MODULE                                      *         05701502
*                                                             *         05704402
***************************************************************         05707002
         SPACE                                                          05709602
PRG005   TM    PPLOPT1,PPLEXR      DOES FOURTH WORD OF PPL EXIST        05712202
         SPACE                                                          05714802
*        IMPORTANT NOTE ABOUT LABEL IECVNP02:                   *       05717402
*              IEAVNP02 CHANGES THE FOLLOWING BRANCH TO AN      *       05720002
*              UNCONDITIONAL BRANCH TO PRG010.  THIS IS         *       05730002
*              USED AS A TEST TO DETERMINE IF IEAVNP02 IS       *       05740002
*              IN CONTROL.                                      *       05742002
         SPACE                                                          05744002
IECVNP02 BZ    PRG010              NO LEAVE FOURTH WORD ZERO            05750002
         SPACE                                                          05760002
         MVC   K12(K04,RCORE),K12(R2) MOVE FOURTH WORD TO WORK AREA     05800003
         SPACE                                                          05850002
PRG010   ST    RPIRL,PWASAVP       SET PIRL ADDR                        05850402
         LA    R0,PWAECB           GET ECB ADDR                @Y30IPLG 05887303
         LR    RPAR,RBASE          GET PURGE BEGINNING         @Y30IPLG 05887403
         BCTR  RPAR,R0             DECREMENT BY 2 SO THAT IT   @Y30IPLG 05888003
         BCTR  RPAR,R0             POINTS TO BEGINNING         @Y30IPLG 05888603
         LA    RPAR,0(RPAR)        INDICATE R FORM             @Y30IPLG 05889203
         ST    RPAR,PWAFIX3        STORE BEGINNING ADDR        @Y30IPLG 05889803
         OI    PWAFIX3,PGFREIND    SET LIST FOR FREE           @Y30IPLG 05890103
         O     RPAR,RFIX       INDICATE FIX REQUEST            @Y30IPLG 05890403
         LA    R2,PRGEND           GET END OF PURGE            @Y30IPLG 05890703
         LA    R2,PURGEEND-PRGEND(R2)  POINT TO END OF FRR     @Y30IPLG 05891003
         ST    R2,PWAFIX4          SAVE END ADDR OF MODULE     @Y30IPLG 05891403
         OI    PWAFIX4,PGFIXEOL    INDICATE LIST END           @Y30IPLG 05891503
         XR    R4,R4               ZERO R4 FOR FAST PATH       @Y30IPLG 05891703
         L     RNINE,IOCOMEX       GET POINTER TO IOCOM EXT    @Y30IPLG 05892203
         L     RF,IOXPSIX-IOX(,RNINE) GET FAST PATH TO PAGE FIX@Y30IPLG 05892503
         L     RUCB,PSAAOLD        LOAD ASCB PTR IN R7         @Y30IPLG 05892803
         OI    PERRFLG0,PERFIXA    INDICATE FIX ACTIVE         @Y30IPLG 05892903
         BALR  RET,RF              CALL PAGE FIX               @Y30IPLG 05893203
         SPACE                                                          05893703
         LTR   RF,RF               ZERO RETURN CODE ?          @Y30IPLG 05894203
         BZ    PRG011              YES, SKIP WAIT                       05894703
         BAL   RF,PFLOCAL          FREE THE LOCAL LOCK TO WAIT @Y30IPLG 05895203
         SPACE                                                          05895703
         SPACE                                                          05896703
         WAIT  ECB=PWAECB                                      @YM01204 05898303
         EJECT                                                          05898403
***************************************************************         05901803
*                                                             *         05902203
*        PERFORM VALIDITY CHECKING AND INITIALIZE WORK AREAS  *         05904203
*                                                             *         05906203
***************************************************************         05908803
         SPACE                                                          05910803
         B     PRG0115             DONT FREE LOCK TWICE        @Y30IPLG 05912803
PRG011   BAL   RF,PFLOCAL          FREE LOCAL LOCK             @Y30IPLG 05914803
PRG0115  LH    R10,IOCVOICT        GET COUNT OF VOID ENTRIES   @Y30IPLG 05916803
         STC   R10,PIRCNT          SAVE COUNT OF PIRL ENTRIES           05919102
         ST    RPIRL,IPIBPIRL      SAVE PIRL ADDRESS                    05929402
         LH    RNINE,PPLASID       GET ASID                    @YM01211 05939402
         STH   RNINE,IPIBARG+K02   PUT ASID IN IPIB                     05939702
         SPACE                                                          05940102
         TM    PPLOPT2,PPLOTCB     TCB ASSOC RESTORE           @YM3155P 05940502
         BZ    PRG012              NO, CONTINUE                @YM3155P 05940902
         SPACE                                                          05941302
         OI    IPIBOPT,IPIBOTCB    IND TCB ASSOC RESTORE       @YM3155P 05941402
         SPACE                                                          05941702
PRG012   TM    PPLOPT2,PPLTSKM     WAS CALLER TASK TERM        @YM3155P 05949702
         BZ    PRG015              NO CONTINUE                          05949802
         SPACE                                                          05962302
         OI    PURGRETC,PURTT      INDICATE CALLED BY TASK TERM         05975002
         SPACE                                                          05985002
PRG015   TM    PPLOPT2,PPLMEM      MEMORY PURGE SPECIFIED               05987502
         BZ    PRG020              MEMORY PURGE NOT REQUESTED           06000002
         L     RET,RBLINK          GET PREVIOUS RB             @YM04938 06006002
         SPACE                                                          06012002
         TM    RBOPSW+K01-RBBASIC(RET),BIT7  CALLR IN SUP STAT @YM04938 06020002
         BO    PRG260              NO CANNOT DO MEMORY PURGE            06030002
         SPACE                                                          06040002
         OI    IPIBOPT,IPIBMEM     MEMORY PURGE SPECIFIED      @YM06596 06050002
         SPACE                                                          06060002
         B     PRG080              CONTINUE                             06100002
         SPACE                                                          06110002
PRG020   EQU   *                   CHECK FOR TASK TERM         @YM01211 06150002
         L     RF,PSATOLD          GET CURRENT TCB             @YM01204 06152002
         SPACE                                                          06154002
         OC    PPLTCB+K01(K03),PPLTCB+K01 TCB ADDRESS SUPPLIED @YM01204 06160002
         BZ    PRG030              NO USE CURRENT TCB          @YM01204 06170002
         SPACE                                                          06172002
         MVC   IPIBARG+K01(K03),PPLTCB+K01 MOVE SUPPLIED       @YM01204 06180002
*                                  *TCB ADDR TO IPIB           @YM01204 06190002
         B     PRG040              GO CHECK TCB OPT            @YM01204 06190402
         SPACE                                                          06190802
PRG030   ST    RF,IPIBARG          PLACE CURRENT TCB ADDR      @YM01204 06192002
*                                  *IN IPIB                    @YM01204 06194002
         SPACE                                                          06196002
PRG040   TM    PPLOPT1,PPLTASK     TCB PURGE SPECIFIED         @YM01204 06200002
         BZ    PRG060              NO CHECK FOR DSID PURGE     @YM01204 06250002
         L     RET,RBLINK          GET PREVIOUS RB PTR         @YM04938 06270002
         SPACE                                                          06300002
         TM    RBOPSW+K01-RBBASIC(RET),BIT7  CALLR IN SUP STAT @YM04938 06360002
         BZ    PRG050              YES DO NOT CHECK TCB        @YM01204 06370002
         SPACE                                                          06380002
         L     RET,IPIBARG         GET SUPPLIED TCB POINTER    @YM04930 06390002
         SPACE                                                          06390402
         CLC   TCBJSTCB-TCB+K01(K03,RET),TCBJSTCB-TCB+K01(RF)           06392002
*                                  *DOES SUPPLIED TCB POINT             06396002
*                                  *TO CURRENT JSTCB                    06398002
         BNE   PRG055              NO, DONT PURGE              @YM01204 06398402
         SPACE                                                          06408402
PRG050   OI    IPIBOPT,IPIBTASK    INDICATE TCB OPTION         @YM01204 06418802
*                                  ALSO PTM                    @YM07223 06423802
         B     PRG070              GO GET CORE FOR PIRL        @YM01204 06428802
         SPACE                                                          06430802
PRG055   OI    PURGRETC,PURTCB     INDICATE TCB NOT PURGABLE   @YM01204 06438802
         B     PRG260              SKIP FURTHER PROCESSING     @YM01376 06448802
         SPACE                                                          06498802
PRG060   L     RNINE,PPLDSID       GET DSID ARGUMENT           @YM01204 06850002
         LA    RNINE,0(R0,RNINE)   CLEAR HIGH BYTE                      06900002
         SPACE                                                          06910002
         LTR   RNINE,RNINE         ANY DSID ADDRESS                     06950002
         BNZ   PRG065              YES, CONTINUE               @YM01376 07000002
         SPACE                                                          07010002
         OI    PURGRETC,PURDSID    INDICATE DSID CANT          @YM01376 07020002
*                                  *BE PURGED                           07030002
         B     PRG260              GO INDICATE PIRL BE FREED   @YM01376 07040002
         SPACE                                                          07042002
PRG065   ST    RNINE,IPIBARG       PUT DISD IN IPIB ARGUMENT   @YM01376 07050002
         MVC   IPIBDVID(K01),PPLDVRID COPY DRIVER ID           DCR21082 07050402
         SPACE                                                          07052002
PRG070   TM    PPLOPT1,PPLRB       RB PURGE SPECIFIED          @YM01204 07060002
         BO    PRG080              NO  DSID IS DEFAULT         @YM01204 07070002
         SPACE                                                          07070402
         C     RF,IPIBARG          IS THIS CURRENT TCB         @YM01204 07072002
*                                  AND ALSO PTM                @YM04930 07073002
         BNE   PRG075              NO, RB PURGE OK             @YM01204 07074002
         SPACE                                                          07074402
         TM    PPLOPT1,PPLHIO      QUIESCE OPTION              @YM01204 07076002
         BZ    PRG090              YES, RB PURGE NOT OK        @YM01204 07078002
         SPACE                                                          07078402
PRG075   OI    IPIBOPT,IPIBRBP     RB PURGE REQUESTED          @YM01204 07080002
         SPACE                                                          07100002
PRG080   TM    PPLOPT1,PPLHIO      HALT OPTION SPECIFIED                07750002
         BZ    PRG090              NO CHECK FOR POST OPT                07800002
         SPACE                                                          07810002
         OI    IPIBOPT,IPIBHALT    SET HALT OPTION IN IPIB     @YM01204 07850002
         SPACE                                                          07860002
PRG090   TM    PPLOPT1,PPLPOST     POST OPTION SPECIFIED                07900002
         BZ    PRG100              NO   CHECK FOR RELATED               07950002
         SPACE                                                          07960002
         OI    IPIBOPT,IPIBPOST    SET POST OPT IN IPIB                 08000002
         SPACE                                                          08010002
PRG100   TM    PPLOPT1,PPLREL      TEST FOR RELATED REQ OPTION          08050002
         BZ    PRG110              NO GO SET RETURN CODE                08100002
         SPACE                                                          08110002
         OI    IPIBOPT,IPIBREL     SET REL REQ PURGE                    08150002
         SPACE                                                          08200002
PRG110   TM    PPLOPT1,PPLHIO      QUIESCE OPTION                       08250002
         BO    PRG130              NO HALT                              08300002
         EJECT                                                          08302002
***************************************************************         08304002
*                                                             *         08306002
*        ENQUEUE ON PURGE RESOURCE SO THAT ONLY ONE PURGE     *         08310002
*        WITH QUIESCE OPTION CAN BE GOING ON WITHIN A STEP.   *         08320002
*                                                             *         08322002
***************************************************************         08330002
         SPACE                                                          08340002
         MVC   PURENQ(PURENQLN),PURNQLST  MOVE IN PARM LIST    @YM05797 08345002
         ENQ   ,MF=(E,PURENQ)                                           08350002
         SPACE                                                          08410002
         LTR   RF,RF               RETURN CODE=0               @YM3104P 08412002
         BZ    PRG120              YES, CONTINUE               @YM3104P 08414002
         SPACE                                                          08416002
         TM    IPIBOPT,IPIBMEM     MEMORY PURGE                @YM3104P 08418002
*                                  *RCT IN CONTROL                      08418402
         BO    PRG120              YES, CONTINUE               @YM3104P 08418802
         SPACE                                                          08419202
         OI    PURGRETC,PURNOENQ   INDICATE UNABLE TO ENQ      @YM3104P 08419602
         OI    MASK1,MSKFREE       INDICATE FREE PIRL          @YM3104P 08419702
         SPACE                                                          08419802
         B     PRG310              TERMINATE PURGE             @YM3104P 08419902
         SPACE                                                          08423202
PRG120   OI    PERRFLG0,PERENQ     IND ENQ ACTIVE              @YM3104P 08426702
         SPACE                                                          08430002
***************************************************************         08440002
*                                                             *         08442002
*        STOP SRB DISPATCHING                                 *         08442102
*                                                             *         08442402
***************************************************************         08444002
         SPACE                                                          08446002
PRG130   EQU   *                   ISSUE STATUS STOP            OZ00086 08450003
         OI    PERRFLG0,PERSTATS   IND STATUS ACTIVE                    08470003
         STATUS STOP,SRB                                                08500002
         SPACE                                                          08510002
         EJECT                                                          08514002
         SPACE                                                          08810002
***************************************************************         08820002
*                                                             *         08830002
*        UPDATE PURGE COUNT IN IOCOM                          *         08840002
*                                                             *         08842002
***************************************************************         08844002
         SPACE                                                          08846002
PRG150   L     RPAR,IOCPGCT-K02    GET WORD THAT CONTAINS PURGE COUNT   08950002
         LA    R2,K01              SET  R2 TO ONE FOR INCREMENT         09000002
         ALR   R2,RPAR             R2 NOW ONE MORE THAN RPAR            09050002
         SPACE                                                          09060002
         CS    RPAR,R2,IOCPGCT-K02 STORE UPDATED COUNT                  09100002
         BNE   PRG150              BRANCH IF UPDATED BY ANYONE ELSE     09150002
         SPACE                                                          09160002
         OI    PERRFLG0,PERPGCT    IND IOCPGCT ACTIVE                   09170002
         EJECT                                                          09180002
***************************************************************         09190002
*                                                             *         09192002
*        INITIALIZE PURGE COUNTS AND DETERMINE PURGE TYPE     *         09194002
*                                                             *         09196002
***************************************************************         09198002
         SPACE                                                          09198402
         XC    PWAQCNT,PWAQCNT     CLEAR PURGE QUIESCE COUNT            09200002
         XC    IPIBCNT,IPIBCNT     CLEAR IPIB COUNT                     09250002
***************************************************************         09250802
*                                                             *         09251602
*        PUT IPIB POINTER IN ASCB                             *         09252402
*                                                             *         09253202
***************************************************************         09254002
         SPACE                                                          09254802
         STM   RB,RF,PWREGB        SAVE LOCK REGS              @YM01073 09255602
PRG152   EQU   *                                                        09256002
         SPACE                                                          09256402
         BAL   RF,PGLOCAL          GO GET LOCAL LOCK AND FRR            09257202
         SPACE                                                          09258002
*        LM    RB,RF,PWREGB        RESTORE LOCK REGS           @YM01073 09258802
         SPACE                                                          09260002
         L     RF,CVTPTR           GET POINTER TO CVT                   09262002
         L     RC,CVTIXAVL         PICK UP IOCOM ADDRESS                09264002
         LA    RB,IPIB             PUT POINTER TO IPIB IN RB            09266002
         L     R10,PSAAOLD         GET CURRENT ASCB ADDR       @YM3089P 09268002
         ST    R10,IPIBASCB        SET MEMORY PURGE IS RUNNING @ZA30265 09268540
*                                  IN SO IECVPURG CAN POST     @ZA30265 09269040
*                                  PROPERLY                    @ZA30265 09269540
         XR    RF,RF               ZERO RF TEST FOR PREV IPIB  @YM07220 09270002
         C     RF,ASCBIOSP-ASCB(,R10)   IS THERE AN IPIB ALRDY @YM07220 09272002
         BE    PRG154              NO PREVIOUS IPIB IN MEM     @YM07220 09274002
         SPACE                                                          09276002
         L     RF,ASCBIOSP-ASCB(,R10)   GET PREVIOUS IPIB      @YM07220 09278002
         CLR   RF,RB               IS IT A 2ND PASS SAME IPIB  @YM07220 09280002
         BE    PRG158              PATH FOR CHAIN OF DSID'S DEB@YM07336 09282002
         SPACE                                                          09284002
         ST    RB,IPIBLNK-IPIB(,RF)     STORE 2ND IPIB IN 1ST  @YM07220 09286002
*                                       THERE CAN BE MAX OF 2 @YM07220  09288002
         B     PRG156              BRNCH ARND ST OF 1ST IPIB   @YM07220 09290002
         SPACE                                                          09300002
PRG154   ST    RB,ASCBIOSP-ASCB(,R10) PUT POINTER TO IPIB IN ASCB       09306002
         SPACE                                                          09312002
PRG156   ST    R10,PWAASCBP        SAVE ASCB PTR                        09318002
         SPACE                                                          09324002
         OI    PERRFLG0,PERIOSP    IND ASCBIOSP ACTIVE                  09330002
         SPACE                                                          09336002
         TM    PPLOPT2,PPLMEM      MEMORY PURGE                         09342002
         BO    PRG170              YES BYPASS DSID AND TCB PURGE        09350002
         SPACE                                                          09360002
         TM    PPLOPT1,PPLTASK     TCB PURGE                            09400002
         BO    PRG170              YES BYPASS DSID PURGE                09450002
PRG158   L     RET,RBLINK          GET PREVIOUS RB PTR         @YM04938 09451002
         SPACE                                                          09452002
         TM    RBOPSW+K01-RBBASIC(RET),BIT7  CALLR IN SUP STAT @YM04938 09500002
         BO    PRG160              NO DO VAL CHECK                      09550002
         SPACE                                                          09560002
         TM    PPLOPT2,PPLVC       VAL CHK REQ                          09600002
         BZ    PRG170              NO BYPASS VAL CHECK                  09650002
         SPACE                                                          09750002
***************************************************************         09760002
*                                                             *         09770002
*        PERFORM DEB CHECK                                    *         09780002
*                                                             *         09790002
***************************************************************         09792002
         SPACE                                                          09794002
PRG160   L     RPAR,IPIBARG        GET POINTER TO DSID                  09800002
         SLR   R0,R0               INDICATE VERIFY                      09850002
         L     RF,CVTPTR           GET CVT PTR                @YM00977  09860002
         L     R10,CVTTCBP         GET TCB POINTER                      09900002
         L     R10,K04(R0,R10)     GET ADDRESS OF CURRENT TCB           09950002
         L     RF,CVTEXT2-CVTMAP(,RF) GET POINTER TO EXTENSION          10000002
         L     RF,CVTDEBVR-CVTXTNT2(,RF) GET POINTER TO DEB CHECK RTNE  10050002
         SPACE                                                          10060002
         BALR  RET,RF              GO CHECK DEB                         10100002
         B     PRG170              VALID DEB                            10150002
         B     PRG180              NO GO INDICATE ERROR                 10200002
         EJECT                                                          10210002
***************************************************************         10212002
*                                                             *         10214002
*        CALL PURGE SUBROUTINES                               *         10216002
*        IF IEAVNP02 IS IN CONTROL, ONLY LCH AND UCB PURGES.  *         10216102
*                                                             *         10218002
***************************************************************         10218402
         SPACE                                                          10218802
PRG170   CLI   IECVNP02+K01,NIP02TST IS IEAVNP02 IN CONTROL             10230002
         BE    PRG175              YES, LCH AND UCB PURGE ONLY          10240002
         SPACE                                                          10242002
         BAL   RET,SIRBPURG        GO TO SIRB PURGE SUBROUTINE          10250002
         SPACE                                                          10300002
PRG175   BAL   RET,LCHPURG         GO TO LCH PURGE SUBROUTINE           10350002
         SPACE                                                          10400002
         BAL   RET,UCBPURG         GO TO UCB PURGE SUBROUTINE           10450002
         SPACE                                                          10450402
         CLI   IECVNP02+K01,NIP02TST IS IEAVNP02 IN CONTROL             10452002
         BNE   PRG176              IEAVNP02 NOT IN CONTROL     @YM06325 10452602
         BAL   RF,PFLOCAL          RELEASE LOCAL LOCK AND FRR  @YM06325 10453202
         BAL   RET,IPIBPURG        GO TO IPIB PURGE SUBROUTINE @ZA08098 10453640
         B     PRG178              YES, SKIP REMAINDER OF PURGES        10454002
         SPACE                                                          10456002
PRG176   BAL   RET,DDRPURG         GO TO DDR PURGE SUBROUTINE           10460002
         SPACE                                                          10470002
*        STM   RB,RF,PWREGB        SAVE LOCK REGS              @YM01073 10480002
         SPACE                                                          10490002
         BAL   RF,PFLOCAL          GO RELEASE LOCAL LOCK AND FRR        10500002
         SPACE                                                          10560002
*        LM    RB,RF,PWREGB        RESTORE LOCK REGS           @YM01073 10570002
         SPACE                                                          10580002
         BAL   RET,SPLPURG         GO TO SPL PURGE SUBROUTINE           10600002
         SPACE                                                          10650002
         TM    PPLOPT1,PPLHIO      IF QUISCE,DONT DO IPIBPURG  @YM07220 10660002
         BNO   PRG177              GO ON TO DVRPURG            @YM07220 10670002
         BAL   RET,IPIBPURG        GO TO IPIB PURGE SUBROUTINE          10700002
         SPACE                                                          10750002
PRG177   BAL   RET,DVRPURG         GO TO DRIVER PURGE SUBROUTINE        10900002
         EJECT                                                          10950002
***************************************************************         10960002
*                                                             *         10970002
*        FREE UP IOS BLOCKS FOR SPECIFIED MEMORY              *         10980002
*                                                             *         10990002
***************************************************************         10992002
         SPACE                                                          10994002
PRG178   L     RF,CVTPTR           GET CVT POINTER                      11000002
         L     RC,CVTIXAVL         GET IOCOM ADDRESS                    11050002
         L     R10,CVTTCBP         GET POINTER TO TCB POINTER           11100002
         L     RSVRB,K04(,R10)     GET CURR TCB POINTER                 11150002
         L     RSVRB,0(,RSVRB)     GET CURR RB PTR                      11200002
         L     R10,PSAAOLD         PICK UP PTR TO CURR ASCB    @YM04934 11250002
         SPACE                                                          11260002
         TM    IPIBOPT,IPIBMEM     MEMORY PURGE                         11300002
         BZ    PRG190              NO BRANCH                            11350002
         SPACE                                                          11402002
         TM    PPLOPT1,PPLHIO      HALT OPTION                 @YM01211 11402402
         BZ    PRG190              NO, BRANCH                  @YM01211 11402802
         SPACE                                                          11403202
*        STM   RB,RF,PWREGB        SAVE LOCK REGS              @YM01073 11404002
         SPACE                                                          11406002
         BAL   RF,PGLOCAL          GO GET LOCAL LOCK AND FRR            11410002
         SPACE                                                          11420002
*        LM    RB,RF,PWREGB        RESTORE LOCK REGS           @YM01073 11430002
         SPACE                                                          11440002
         LH    RB,PPLASID          GET ASID                             11450002
         L     RD,PWASAVP          GET POINTER TO SAVE AREA             11500002
         ST    RD,PWREGSAV         CHAIN TO WORK AREA SAVE AREA         11550002
         SPACE                                                          11560002
         LA    RD,PWREGSAV         POINT TO WORK AREA SAVE AREA         11600002
         L     RF,IOCORMGT         GET CORE MANAGER ADDRESS             11650002
         SPACE                                                          11660002
         BAL   RET,K08(,RF)        BAL TO PURGE/FREE ENTRY              11700002
         SPACE                                                          11702002
*        STM   RB,RF,PWREGB        SAVE LOCK REGS              @YM01073 11704002
         SPACE                                                          11706002
         BAL   RF,PFLOCAL          GO RELEASE LOCAL LOCK AND FRR        11710002
         SPACE                                                          11720002
*        LM    RB,RF,PWREGB        RESTORE LOCK REGS           @YM01073 11730002
         SPACE                                                          11740002
         B     PRG200              GO UPDATE COUNT IN WORK AREA         11750002
         EJECT                                                          11760002
***************************************************************         11770002
*                                                             *         11780002
*      DETERMINE IF PURGE SHOULD PROCEED OR MAKE ANOTHER PASS *         11790002
*                                                             *         11792002
***************************************************************         11794002
         SPACE                                                          11796002
PRG180   OI    PURGRETC,PURDSID    INDICATE THAT DSID CANNOT BE PURGED  11800002
         BAL   RF,PFLOCAL          FREE LOCAL LOCK, LOSE RD-RF @YM06012 11805002
         SPACE                                                          11810102
PRG190   TM    PPLOPT2,PPLMEM      MEMORY PURGE                         11850002
         BO    PRG200              YES, GO UPDATE COUNT IN WORK AREA    11900002
         SPACE                                                          11910002
         TM    PPLOPT1,PPLTASK     TASK PURGE                           11950002
         BO    PRG200              YES, GO UPDATE COUNT IN WORK AREA    12000002
         SPACE                                                          12010002
         TM    PPLOPT1,PPLDS       SINGLE DSID PURGE                    12050002
         BO    PRG200              YES, GO UPDATE COUNT IN WORK AREA    12100002
         SPACE                                                          12110002
         L     RPAR,IPIBARG        CHAINED DSID PURGE                   12150002
         L     RPAR,K04(,RPAR)     GET POINTER TO NEXT DSID             12200002
         LA    RPAR,0(RPAR)        CLEAR HIGH ORDER BYTE                12205002
         SPACE                                                          12210002
         LTR   RPAR,RPAR           END OF LIST                          12250002
         BZ    PRG200              YES NOTHING MORE TO PURGE            12300002
         SPACE                                                          12310002
         ST    RPAR,IPIBARG        NO STORE NEW ARGUMENT IN IPIB        12350002
         SPACE                                                          12360002
         B     PRG152              MAKE ANOTHER PASS           @YM07336 12400002
         EJECT                                                          12410002
***************************************************************         12420002
*                                                             *         12430002
*        UPDATE PURGE COUNT IN WORK AREA                      *         12440002
*                                                             *         12442002
***************************************************************         12444002
         SPACE                                                          12446002
PRG200   MVC   PWAQCNT,IPIBCNT     UPDATE COUNT IN WORK AREA            12450002
         SPACE                                                          12460002
***************************************************************         12470002
*                                                             *         12480002
*        DECREMENT PURGE COUNT IN IOCOM                       *         12490002
*                                                             *         12492002
***************************************************************         12494002
         SPACE                                                          12496002
PRG210   L RPAR,IOCPGCT-K02        GET WORD THAT HOLDS THE PURGE COUNT  12550002
         LR    R2,RPAR             COPY PURGE COUNT                     12600002
         BCTR  R2,R0               SUBTRACT 1                           12650002
         SPACE                                                          12660002
         CS    RPAR,R2,IOCPGCT-K02 STORE UPDATED COUNT                  12700002
         BNE   PRG210              BRANCH IF UPDATED BY ANY ONE ELSE    12750002
         SPACE                                                          12760002
         NI    PERRFLG0,XFF-PERPGCT IND IOCPGCT NOT ACTIVE              12770002
         L     R4,PWAQCNT          GET WORK AREA QUIESCE COUNT @ZA06065 12771040
         LTR   R4,R4               I/O OUTSTANDING?            @ZA06065 12772040
         BNZ   PRG220          YES - GO TO WAIT FOR COMPLETION @ZA06065 12773040
         TM    IPIBOPT,IPIBMEM     NO - IS IT RCT?             @ZA06065 12774040
         BNO   PRG220              NOT RCT - DO STATUS START   @ZA06065 12775040
         TM    PPLOPT2,PPLBSS  DID RCT REQ STATUS START BYPASS @ZA06065 12776040
         BO    PRG230              YES - SKIP STATUS START     @ZA06065 12777040
         EJECT                                                          12780002
***************************************************************         12790002
*                                                             *         12792002
*        ALLOW SRB DISPATCHING                                *         12794002
*                                                             *         12796002
***************************************************************         12798002
         SPACE                                                          12798402
PRG220   EQU   *                   ISSUE STATUS START                   12900002
         STATUS START,SRB          RESUME SRB DISPATCHING               13050002
         SPACE                                                          13060002
         NI    PERRFLG0,XFF-PERSTATS  IND STATUS START NOT ACTIVE       13070002
         SPACE                                                          13080002
***************************************************************         13120002
*                                                             *         13130002
*        WAIT FOR I/O TO COMPLETE                             *         13140002
*                                                             *         13142002
***************************************************************         13144002
         SPACE                                                          13146002
*        L     R4,PWAQCNT          GET WORK AREA QUIESCE COUNT @ZA06065 13146540
         SPACE                                                          13148402
         LTR   R4,R4               ANY I/O OUTSTANDING                  13150002
         BZ    PRG230              NO - PURGE COMPLETED                 13200002
         SPACE                                                          13210002
         WAIT  1,ECB=IPIBECB       YES - WAIT FOR IT TO COMPLETE        13250002
         SPACE                                                          13260002
         B     PRG130              MAKE ANOTHER PASS TO SEE IF NEW WORK 13300002
         SPACE                                                          13310002
***************************************************************         13320002
*                                                             *         13330002
*        DEQUEUE PURGE RESOURCES                              *         13340002
*                                                             *         13342002
***************************************************************         13344002
         SPACE                                                          13346002
PRG230   EQU   *                                                        13350040
         L     RF,PRGCOMP          GET ADDR OF COMPRESS INTERFACE       13358040
*                                                              @Y40FPLG 13362040
         BALR  RET,RF              GO SEE IF WE SHOULD COMPRESS         13366040
         SPACE                                                          13374040
         TM    PPLOPT1,PPLHIO      QUIESCE OPTION                       13382040
         BO    PRG260              NO HALT                              13400002
         SLR   RF,RF               CLEAR REG                   @YM07220 13402002
         L     RET,PSAAOLD         GET ASCB PTR TO QSC IPIB    @YM07220 13404002
         ST    RF,ASCBIOSP-ASCB(RET)    ZERO IPIB PTR          @YM07220 13406002
         NI    PERRFLG0,XFF-PERIOSP IND ASCBIOSP NOT ACTIVE    @YM07220 13408002
         SPACE                                                          13410002
         DEQ  ,MF=(E,PURENQ)       YES DEQUE PURGE RESOURCE             13450002
         SPACE                                                          13460002
         NI    PERRFLG0,XFF-PERENQ IND ENQ NOT ACTIVE                   13470002
         EJECT                                                          13480002
***************************************************************         13490002
*                                                             *         13492002
*        SCAN PIRL ENTRIES                                    *         13494002
*                                                             *         13496002
***************************************************************         13498002
         SPACE                                                          13498402
         LA    RPAR,PIRRSTR        GET POINTER TO FIRST PIRL ENTRY      13500002
*                                  *SEE IF ANY THING ON PIRL            13510002
*                                  *IF NOT FREE IT                      13520002
         SLR   RET,RET             CLEAR REG                            13550002
         IC    RET,PIRCNT          GET NUMBER OF PIRL ENTRIES           13600002
         SPACE                                                          13610002
PRG250   L     RF,0(RPAR)          PICK UP A PIRL ENTRY                 13650002
         SPACE                                                          13660002
         LTR   RF,RF               ANYTHING ON THIS ENTRY               13700002
         BNZ   PRG270              YES DO NOT FREE PIRL                 13750002
         SPACE                                                          13760002
         LA    RPAR,PIRENTL(RPAR)  POINT TO NEXT ENTRY                  13800002
         SPACE                                                          13810002
         BCT   RET,PRG250          ANY MORE ENTRIES                     13850002
         SPACE                                                          13900002
PRG260   OI    MASK1,MSKFREE       INDICATE PIRL TO BE FREED            13950002
         SPACE                                                          14000002
         TM    PPLOPT1,PPLHIO      IS IT HALT OPTION                    14060002
         BO    PRG310              YES DO NOT MOVE PIRL TO ANCHOR       14070002
         SPACE                                                          14080002
         MVC   IPIBPIRL,FWORD      INDICATE THAT NO PIRL EXISTS         14100002
         SPACE                                                          14150002
PRG270   TM    PPLOPT1,PPLHIO      IS IT HALT OPTION                    14160002
         BO    PRG310              YES NO ANCHOR PROVIDED               14170002
         SPACE                                                          14180002
         L     RF,CVTPTR           GET CVT POINTER                      14200002
         L     RC,CVTIXAVL         GET IOCOM POINTER                    14250002
         L     R10,CVTTCBP         GET TCB POINTER                      14300002
         L     R10,K04(,R10)       GET CURR TCB POINTER                 14350002
         L     RSVRB,0(,R10)       GET POINTER TO CURR RB               14400002
         SPACE                                                          14410002
         CLC   PPLPIRL+K01(K03),FWORD  WAS ANCHOR ADDR=F'S              14450002
         BE    PRG310              YES, ANCHOR NO PROVIDED              14500002
         EJECT                                                          14510002
***************************************************************         14520002
*                                                             *         14530002
*        PERFORM DEB CHECK FOR NON-SUPERVISOR CALLERS         *         14540002
*                                                             *         14542002
***************************************************************         14544002
         L     RET,RBLINK          GET PREVIOUS RB PTR         @YM04938 14545002
         SPACE                                                          14546002
         TM    RBOPSW+K01-RBBASIC(RET),BIT7  CALLR IN SUP STAT @YM04938 14550002
         BZ    PRG300              YES BYPASS VAL CHECK        @YM01150 14600002
         SPACE                                                          14650002
         L     RPAR,PPLPIRL        GET POINTER TO ANCHOR                14700002
         LA    RPAR,K00(RPAR)      CLEAR HI ORDER BYTE         @YM01150 14710002
         SPACE                                                          14712002
         LTR   RPAR,RPAR           DOES ADDR = 0               @YM01150 14720002
         BZ    PRG310              YES, SKIP DEB CHECK         @YM01150 14730002
         SPACE                                                          14740002
         LA    R4,DEBUSRPG-DEBBASIC GET OFFSET TO DEB USER PURGE        14750002
         SLR   RPAR,R4             POINT TO BEGINNING OF DEB            14800002
         SLR   R0,R0               INDICATE VERIFY                      14850002
         L     RF,CVTPTR           GET POINTER TO CVT                   14900002
         L     R10,CVTTCBP-CVTMAP(,RF) GET TCB POINTER                  14950002
         L     R10,K04(R0,R10)     GET ADDRESS OF CURRENT TCB           15000002
         SPACE                                                          15050002
         USING TCB,R10                                                  15100002
         L     RF,CVTEXT2-CVTMAP(,RF) GET POINTER TO EXTENSION          15150002
         L     RF,CVTDEBVR-CVTXTNT2(,RF) GET POINTER TO DEB CHECK RTNE  15200002
         STM   RIOSB,RB,PWREGA                                 @YM04945 15205002
         SPACE                                                          15210002
         BALR  RET,RF              GO CHECK DEB                         15250002
PRG280   B     PRG300              GO GET ANCHOR ADDR          @YM06013 15255002
         SPACE                                                          15260002
*  LINE DELETED FOR PTM VS03495                                @YM3495P 15300002
*   COME HERE IF DEB GOOD                                               15305002
         SPACE                                                          15310002
*   COME HERE IF DEB NOT GOOD                                           15370002
*        B     PRG290              BRANCH TO NEXT INSTRUCTION           15400002
         LM    RIOSB,RB,PWREGA                                 @YM04945 15403002
*                                                              @YM06013 15406002
         EJECT                                                          15410002
***************************************************************         15420002
*                                                             *         15430002
*        MOVE PIRL ADDR TO ANCHOR                             *         15440002
*                                                             *         15442002
***************************************************************         15444002
         SPACE                                                          15446002
         L     R4,PPLPIRL          GET PIRL ADDR                        15450002
         LA    R4,0(R4)            CLEAR HI ORDER BYTE         DCR21082 15452002
         SPACE                                                          15460002
         MODESET EXTKEY=RBT234,WORKREG=2  CHANGE TO CALLER KEY @YM05497 15500002
         SPACE                                                          15510002
         MVC   K01(K03,R4),IPIBPIRL+K01  MOVE PIRL ADDRESS TO ANCHOR    15550002
         SPACE                                                          15596002
         MODESET EXTKEY=ZERO           CHANGE BACK TO KEY ZERO          15600002
         SPACE                                                          15610002
         DROP  R10                                                      15650002
         USING IOSB,RIOSB                                               15700002
         SPACE                                                          15710002
         B     PRG310              GO SET RETURN CODE                   15750002
         SPACE                                                          15760002
PRG300   LM    RIOSB,RB,PWREGA                                 @YM06013 15780002
         L     R4,PPLPIRL          GET ANCHOR ADDRESS                   15800002
         LA    R4,0(R4)            CLEAR HI ORDER BYTE         DCR21082 15810002
         MVC   K01(K03,R4),IPIBPIRL+K01  MOVE PIRL ADDRESS TO ANCHOR    15850002
         EJECT                                                          15900002
***************************************************************         15950002
*                                                             *         15952002
*        SET RETURN AND CONDITION CODES                       *         15954002
*                                                             *         15956002
***************************************************************         15958002
         SPACE                                                          15958402
PRG310   L     RPAR,RBPPLSAV       GET POINTER TO USERS PPL             15960002
         SLR   R4,R4               R4 NOW HAS RETURN CODE               16000002
         SPACE                                                          16010002
         TM    PPLOPT1,PPLEXR      RETURN CODE REQUESTED                16050002
         BZ    PRG320              NO RETURN CODE OF ZERO               16100002
         TM    PURGRETC,PURRTCDT                                        16103002
         BZ    PRG320                                                   16106002
         SPACE                                                          16110002
         TM    PURGRETC,PURERRCD   ANY ERROR CODE                       16150002
         BZ    PRG320              NO ERRORS, GIVE 7F          @YM06011 16160002
         TM    PURGRETC,PURERRCD   ANY BITS BUT HIO & PURTP    @YM06011 16170002
         BNZ   PRG330              YES GIVE COMP CODE OF 40             16200002
         SPACE                                                          16210002
PRG320   MVI   PPLCC-PPLOPT1(RPAR),PURGOOD  NO GIVE 7F                  16250002
         SPACE                                                          16260002
         B     PRG340              USE THIS RETURN CODE                 16300002
         SPACE                                                          16310002
PRG330   MVI   PPLCC-PPLOPT1(RPAR),PURNG  PURGE NOT COMPLETED GOOD      16350002
         SPACE                                                          16352002
         LA    R4,PURRTCD2         SET RETURN CODE=20          @YM3104P 16360002
         SPACE                                                          16362002
         TM    PURGRETC,PURNOENQ   UNABLE TO ENQ ON PURGE      @YM3104P 16370002
         BO    PRG340              YES, USE THIS RETURN CODE   @YM3104P 16380002
         SPACE                                                          16400002
         TM    PURGRETC,PURTT      WAS PURGE CALLED BY TASK TERM        16424002
         BZ    PRG331              NO CODE WILL BE 8 OR LESS            16430002
         SPACE                                                          16430402
         LA    R4,PURRTCD1         SET RETURN CODE TO 16                16432002
         SPACE                                                          16434002
         TM    PURGRETC,PURTP      WAS TP I/O HALTED                    16440002
         BO    PRG340              YES USE THIS CODE                    16442002
         SPACE                                                          16442402
         LA    R4,PURRTCDC         SET CODE TO 12                       16444002
         SPACE                                                          16444402
         TM    PURGRETC,PURIO      WAS ANY I/O HALTED                   16446002
         BO    PRG340              YES USE THIS CODE                    16448002
         SPACE                                                          16448102
PRG331   LA    R4,PURRTCD8         SET CODE TO EIGHT           @YM01073 16448402
         SPACE                                                          16448802
         TM    PURGRETC,PURDSID    WAS A DSID NOT PURGABLE              16449502
         BO    PRG340              YES USE THIS CODE                    16449602
         SPACE                                                          16453202
         LA    R4,PURRTCD4         SET CODE  TO FOUR                    16456802
         SPACE                                                          16458802
         TM    PURGRETC,PURTCB     WAS A TCB NOT PURGABLE               16460402
         BO    PRG340              YES USE THIS CODE                    16464002
         SPACE                                                          16466002
         IC    R4,PURGRETC         SET UP BAD CODE                      16467602
*                                  *THIS IS A CANNOT HAPPEN             16469602
*                                  *SITUATION FOR ERROR CHECKING        16470002
         EJECT                                                          16471202
***************************************************************         16473202
*                                                             *         16473602
*        RELEASE ESTAE                                        *         16474002
*                                                             *         16474402
***************************************************************         16474502
         SPACE                                                          16474602
PRG340   EQU   *                   ISSUE ESTAE                          16474802
         LR   RNINE,R4         SAVE RTN CODE                   @Y30IPLG 16475303
         BAL   RF,PGLOCAL          GET LOCAL LOCK TO BRNCH SVC @Y30IPLG 16475803
         SPACE                                                          16478402
         ESTAE 0,MF=(E,PWAESTAE),BRANCH=YES,SVEAREA=PWREGSAV   @Y30IPLG 16482003
         SPACE                                                          16485602
***************************************************************         16850002
*                                                             *         16850102
*        ISSUE PAGE FREE FOR MODULE AND PIRL                  *         16850202
*                                                             *         16850402
***************************************************************         16852302
         SPACE                                                          16854302
         LA    RPAR,PWAFIX3        GET PARMS FOR PAGE FREE     @Y30IPLG 16882003
         ICM   RPAR,K08,LISTIND       INDICATE LIST            @Y30IPLG 16882203
         SPACE                                                          16882402
         LR    RNINE,R4            SAVE RETURN CODE            @Y30IPLG 16882803
         XR    R4,R4               ZERO R4 FOR FAST PATH      @Y30IPLG  16883203
         L     RUCB,PSAAOLD        GET OLD ASCB PTR            @Y30IPLG 16883603
         L     R10,IOCOMEX                                     @Y30IPLG 16884003
         L     RF,IOXPSIF-IOX(,R10)    GET FAST PATH TO PGFREE @Y30IPLG 16884103
         SPACE                                                          16891403
         BALR  RET,RF              CALL PAGE FREE FAST PATH    @Y30IPLG 16893803
         SPACE                                                          16896503
         EJECT                                                          16897503
***************************************************************         16899203
*                                                             *         16901903
*        FREE PIRL CORE                                       *         16904903
*                                                             *         16905903
***************************************************************         16908203
         SPACE                                                          16912003
         L     R4,PSATOLD          LOAD R4 CURENT TCB FOR FREE @Y30IPLG 16914003
         TM    MASK1,MSKFREE       PIRL TO BE FREED            @YM01266 16915003
         BZ    PRG350              NO DO NOT FREE              @YM01449 16916003
         SPACE                                                          16917303
         L     RPAR,PWASAVP        GET PIRL ADDR               @YM01449 16919303
         LH    R0,PWPIRLNG         GET LENGTH                  @YM01449 16922203
         ICM   R0,K08,PIRLSUBP     INDICATE SP 254             @Y30IPLG 16928403
         SPACE                                                          16929403
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                    @Y30IPLG 16934803
         SPACE                                                          16936803
***************************************************************         16939003
*                                                             *         16941003
*        FREE PURGE WORK AREA                                 *         16943203
*                                                             *         16945203
***************************************************************         16949403
         SPACE                                                          16951603
PRG350   LR    RPAR,RCORE          GET PWA PTR                 @YM01449 16952603
         L     R0,COREMASK         INDICATE SP 245 & LNTH     @Y30IPLG  16957803
         SPACE                                                          16958803
         FREEMAIN R,LV=(0),A=(1),BRANCH=YES                    @Y30IPLG 16962003
*        ALSO NEM SUPPORT-                                     @Y30IPLG 16966003
         SPACE                                                          16968003
         XR    RCORE,RCORE         ZERO R6 TO AVOID PIC WHEN   @ZM30179 16969003
*                                  NO PWA, USING PFLOCAL2      @ZM30179 16970003
         BAL   RF,PFLOCAL2     FREE LOCAL LOCK (LOOSE R11-R15) @Y30IPLG 16972003
         SPACE                                                          16974003
***************************************************************         16976003
*                                                             *         16978003
*        RETURN TO CALLER                                     *         16980003
*                                                             *         16982003
***************************************************************         16984003
         SPACE                                                          16988003
PUR300   L     RET,RBRETSAV        GET RETURN ADDRESS                   16990003
         SPACE                                                          16992003
         LR    RF,RNINE            PUT RETURN CODE IN REG 15  @Y30IPLG  16994003
         SPACE                                                          16996003
         BR    RET                 RETURN TO CALLER                     17000002
         TITLE 'IGC0001F - BASIC PURGE SUBROUTINE'                      17050002
***************************************************************         17060002
*                                                             *         17070002
*        BASIC PURGE SUBROUTINE                               *         17080002
*                                                             *         17090002
***************************************************************         17092002
         SPACE                                                          17094002
BASICPRG ST    RET,PWRET2          SAVE RETURN REG                      17100002
         SPACE                                                          17110002
***************************************************************         17120002
*                                                             *         17130002
*        CALL APPLICABILITY ROUTINE AND VALIDATE PURGE        *         17140002
*                                                             *         17142002
***************************************************************         17144002
         SPACE                                                          17146002
         BAL   RET,PURAPLSR        GO CHECK THIS BLOCK                  17150002
         SPACE                                                          17200002
         B     PBSC020             APPLICABLE CONTINUE                  17250002
*                                  *BRANCH TO NEXT IF NOT APPLICABLE    17260002
         TM    MASK1,MSKDEQ        DEQ                                  17300002
         BZ    PBSC010             NO                                   17350002
         SPACE                                                          17360002
         LR    RBACK,RPAR                                               17400002
         SPACE                                                          17410002
PBSC010  L     RET,PWRET2          GET RETURN ADDR                      17450002
         MVI   MASK1,MSKOFF        TURN OFF MASK BITS                   17500002
         SPACE                                                          17510002
         B     K04(,RET)           RETURN OFFSET 4                      17550002
         EJECT                                                          17560002
***************************************************************         17570002
*                                                             *         17580002
*        INCREMENT QUIESCE COUNT IN IPIB AND PWA              *         17590002
*                                                             *         17592002
***************************************************************         17594002
         SPACE                                                          17596002
PBSC020  STM   RPAR,R2,IPIBIO      SAVE R1 AND R2                       17600002
         SPACE                                                          17610002
         TM    PPLOPT1,PPLHIO      HALT OPTION SPECIFIED                17650002
         BO    PBSC050             YES NOT QUIESCE                      17700002
         SPACE                                                          17710002
PBSC030  L     RPAR,IPIBCNT        PICK UP QUIESCE COUNT                17750002
         LA    R2,K01(,RPAR)       INCREMENT COUNT IN R2                17800002
         SPACE                                                          17810002
         CS    RPAR,R2,IPIBCNT     STORE UPDATED COUNT                  17850002
         BNZ   PBSC030             BRANCH IF UPDATED BY ANYONE ELSE     17900002
         SPACE                                                          17910002
         L     RPAR,PWAQCNT        GET QUIESCE COUNT                    17950002
         LA    RPAR,K01(,RPAR)     INCREMENT COUNT                      18000002
         ST    RPAR,PWAQCNT        RESET QUIESCE COUNT                  18050002
         SPACE                                                          18060002
         LM    RPAR,R2,IPIBIO                                           18100002
         LA    RB,IPIB                                                  18150002
         ST    RB,IOSIPIB          PLACE IPIB POINTER IN IOSB           18200002
         SPACE                                                          18210002
PBSC040  L     RET,PWRET2          RESTORE RETURN REG                   18250002
         MVI   MASK1,MSKOFF        TURN OFF MASK BITS                   18300002
         SPACE                                                          18310002
         BR    RET                 RETURN TO CALLER                     18350002
         EJECT                                                          18360002
***************************************************************         18370002
*                                                             *         18380002
*        ISSUE HALT I/O                                       *         18390002
*                                                             *         18392002
***************************************************************         18394002
         SPACE                                                          18396002
PBSC050  CLI   UCBTBYT3,UCB3COMM   IS IT TP DEVICE                  CTC 18400002
         BNE   PBSC055             NO CONTINUE                      CTC 18401002
         SPACE                                                          18402402
         OI    PURGRETC,PURTP      INDICATE TP I/O                      18404002
         SPACE                                                          18404402
PBSC055  OI    PURGRETC,PURIO      INDICATE I/O HALTED                  18406002
         SPACE                                                          18408002
         TM    MASK1,MSKHIO        HALT I/O INTERFACE SPECIFIED         18410002
         BZ    PBSC060             INTERFACE NOT SPECIFIED              18450002
         SPACE                                                          18460002
         TM    UCBFLA,UCBACTV      IS UCB ACTIVE                        18500002
         BZ    PBSC058             NO, CONTINUE                @YM04940 18550002
         SPACE                                                          18560002
         L     R2,SRBPARM-SRB(,RPAR) PUT IOSB POINTER IN R2             18600002
         LA    RD,PWREGSAV         GET SAVE AREA ADDR                   18650002
         L     RF,CVTPTR           GET CVT PTR                          18700002
         L     RF,CVTIXAVL-CVTMAP(,RF) GET IOCOM ADDR                   18750002
         L     RF,IOCHIO-IOCOM(,RF) GET HALT I/O ROUTINE ADDR           18800002
         NI    MASK1,XFF-MSKUCB    MAKE SURE BIT IS OFF        @OZ00762 18805003
         SPACE                                                          18810002
         BALR  RET,RF              LINK TO HALT I/O ROUTINE             18850002
         SPACE                                                          18860002
         CH    RF,HLTRTRY          DID HALT WORK,              @OZ00762 18865003
         BNE   PBSC057             YES, GO ON, NORMAL          @OZ00762 18869003
         MVI   MASK1,MSKUCB        INDICATE RETRY THE HALT     @OZ00762 18873003
         LM    RPAR,R2,IPIBIO      RELOAD REGS                 @OZ00762 18877003
         L     RET,PWRET2          RELOAD RETURN               @OZ00762 18881003
         B     K08(,RET)           RETURN TO UCBPURG,IND RETRY @OZ00762 18885003
         SPACE                                                          18890003
PBSC057  OI    MASK1,MSKRDV        INDICATE REDRIVE IOS        @OZ00762 18900003
         TM    UCBFLA,UCBPST       POST ON?                    @ZA12644 18900640
         BO    PBSC058             YES - COMPLETE PURGE        @ZA12644 18901240
         TM    UCBFLB,UCBSPST      SENSEPOST ON? YES - PURGE   @ZA12644 18901840
         BNO   PBSC095             NO - DON'T FREE BLOCKS      @ZA12644 18902440
PBSC058  NI    UCBFLA,UCBBOFF1     BSY,PST,PSNS,CUB,SAP,ACTV   @YM04940 18903002
         NI    UCBFLB,UCBBOFF2     ASNS,SPST BITS OFF          @YM04940 18906002
         EJECT                                                          18910002
***************************************************************         18920002
*                                                             *         18930002
*        REMOVE FROM LCH WITH POINTERS PROVIDED               *         18940002
*                                                             *         18942002
***************************************************************         18944002
         SPACE                                                          18946002
PBSC060  LM    RPAR,R2,IPIBIO      RESTORE R1 AND R2                    18950002
         SPACE                                                          18960002
         TM    MASK1,MSKDEQ        DEQUEUE REQUESTED                    19000002
         BZ    PBSC070             NO DO NOT DEQUEUE                    19050002
         SPACE                                                          19053003
         NI    UCBFLA,XFF-UCBCUB   TO INSURE NOT LEFT ON        OZ00088 19056003
         SPACE                                                          19060002
         L     RB,IOQLNK-IOQ(,RCUR) GET PTR TO NEXT IOQ                 19150002
         ST    RB,0(,RBACK)        SET PTR                              19200002
         SPACE                                                          19210002
         LTR   RB,RB               IS POINTER F'S                       19250002
         BP    PBSC070             NO DO NOT UPDATE LCHLST              19300002
         SPACE                                                          19310002
         ST    RBACK,LCHLST-LCH(,R2)  YES UPDATE LCHLST        @YM04944 19350002
         SPACE                                                          19400002
***************************************************************         19410002
*                                                             *         19420002
*    CALL ENQUE ROUTINE AND ENQUE SRB ON PIRL AND FREE IOQE'S *         19430002
*                                                             *         19440002
***************************************************************         19442002
         SPACE                                                          19550002
PBSC070  L     RF,PSRBENQA         GET ADDR OF PSRBENQ         @Y30IPLG 19600003
         BALR  RET,RF              GO ENQUEUE SRB ON PIRL      @Y30IPLG 19650003
         EJECT                                                          19700002
***************************************************************         19750002
*                                                             *         19800002
*        FREE 160 BYTE BLOCK                                  *         19810002
*                                                             *         19820002
***************************************************************         19830002
         SPACE                                                          19840002
PBSC080  L     RPAR,IOSERP-IOSB(,RIOSB) GET ERP WORK AREA PTR           19850002
         LA    RPAR,0(,RPAR)       CLEAR HIGH BYTE                      19900002
         SPACE                                                          19910002
         LTR   RPAR,RPAR           ANY ERP FOR THIS IOSB                19950002
         BZ    PBSC090             NO, SKIP EWA FREE CODE               20000002
         SPACE                                                          20010002
         LA    RB,FREE160          INDICATE 160 BYTE BLOCK              20050002
         L     RF,CVTPTR           GET CVT PTR                          20100002
         L     RF,CVTIXAVL-CVTMAP(,RF) GET IOCOM ADDRESS                20150002
         L     RF,IOCORMGT-IOCOM(,RF)  GET ENTRY POINT TO IOS CORE MGR  20200002
         LA    RD,PWREGSAV         POINT TO SAVE AREA                   20250002
         SPACE                                                          20260002
         BAL   RET,K04(,RF)        BAL TO 160 FREE ENTRY                20300002
         XR    RPAR,RPAR           TO ZERO OUT ERP WA PTR      @ZM30454 20310003
         ST    RPAR,IOSERP-IOSB(,RIOSB)   ZERO ERP WA PTR      @ZM30454 20320003
         SPACE                                                          20350002
***************************************************************         20360002
*                                                             *         20370002
*        FREE 12 BYTE BLOCK                                   *         20380002
*                                                             *         20390002
***************************************************************         20392002
         SPACE                                                          20394002
PBSC090  LTR   RPAR,RCUR           GET IOQE IN PARM REG                 20400002
         BZ    PBSC100             NO REDRV NECESSARY IF NO IOQ TO FREE 20450002
         SPACE                                                          20460002
         STM   RIOSB,RC,PWREGA     SAVE REGS 10,11,12                   20500002
         L     RF,CVTPTR           GET CVT PTR                          20550002
         L     RF,CVTIXAVL-CVTMAP(,RF) GET IOCOM ADDRESS                20600002
         L     RF,IOCORMGT-IOCOM(,RF)  GET ENTRY POINT TO IOS CORE MGR  20650002
         SPACE                                                          20660002
         BAL   RET,K16(,RF)        BAL TO 12 BYTE FREE ENTRY            20700002
         SPACE                                                          20710002
         LM    RIOSB,RC,PWREGA     RESTORE REGS                         20750002
         EJECT                                                          20760002
***************************************************************         20770002
*                                                             *         20780002
*        ISSUE IOSGEN CHANNEL RESTART                         *         20790002
*                                                             *         20792002
***************************************************************         20794002
         SPACE                                                          20796002
PBSC095  TM    MASK1,MSKRDV        REDRIVE IOS REQUESTED       @ZA12644 20798040
         BZ    PBSC100             NO                                   20850002
         SPACE                                                          20860002
         SLR   RPAR,RPAR           ZERO      REG                        20900002
         SLR   R2,R2               ZERO REG 2                           20950002
         IC    RPAR,UCBCHA         INDICATE CHAN TO RESTART             21000002
         IC    R2,UCBCPU           INDICATE CPU TO RESTART              21050002
         SPACE 4                                                        21100002
         IOSGEN RESTART,REG=(RPAR,R2,RIOSB,RB)                          21150002
         SPACE 4                                                        21200002
PBSC100  LM    RPAR,R2,IPIBIO      RESTORE REGS 1 AND 2                 21700002
         L     RET,PWRET2          RESTORE RETURN ADDRESS               21750002
         MVI   MASK1,MSKOFF        TURN OFF MASK BITS                   21800002
         SPACE                                                          21810002
         B     K08(,RET)           BRANCH BACK PLUS EIGHT               21850002
     TITLE     'IGC0001F - APPLICABILITY CHECK SUBROUTINE'              22000002
***************************************************************         22050002
*                                                             *         22060002
*        APPLICABILITY CHECK SUBROUTINE                       *         22070002
*                                                             *         22080002
***************************************************************         22090002
         SPACE                                                          22092002
PURAPLSR L     RIOSB,SRBPARM       GET IOSB ADDR                        22100002
         SPACE                                                          22110002
         TM    PPLOPT1,PPLHIO      HALT OPTION SPECIFIED                22150002
         BO    PAPL010             YES BRANCH                           22200002
         SPACE                                                          22210002
         LA    RB,IPIB             GET IPIB ADDR                        22250002
         SPACE                                                          22260002
         C     RB,IOSIPIB          ALREADY PURGED                       22300002
         BE    PAPL040             YES RETURN NOT APPLICABLE            22350002
         SPACE                                                          22360002
PAPL010  TM    PPLOPT2,PPLMEM      MEMORY PURGE SPECIFIED               22400002
         BZ    PAPL030             NO GO TEST FOR TCB OPT               22450002
         SPACE                                                          22460002
         CLC   IOSASID-IOSB(K02,RIOSB),IPIBARG+K02 SRB FOR     @YM01372 22550002
*                                  *THIS MEMORY                         22560002
         BNE   PAPL040             NO RETURN NOT APPLICABLE             22600002
         SPACE                                                          22610002
PAPL020  LR    RF,RET              SHIFT TO USE RF TO BRANCH BACK       22650002
         SPACE                                                          22660002
         BR    RF                  RETURN APPLICABLE                    22700002
         SPACE                                                          22710002
PAPL030  L     RB,PSAAOLD          GET CURRENT ASCB ADDR       @YM01321 22720002
         CLC   ASCBASID-ASCB(K02,RB),IOSASID-IOSB(RIOSB)       @YM01372 22730002
*                                  *DOES ASID EQUAL CURRENT ASID        22740002
         BNE   PAPL040             TAKE NOT APPLICABLE RETURN  @YM01321 22742002
         SPACE                                                          22744002
         TM    PPLOPT1,PPLTASK     TCB PURGE                            22750002
         BZ    PAPL050             NO CHECK FOR DSID PURGE              22800002
         SPACE                                                          22810002
         CLC   SRBPTCB,IPIBARG     SRB FOR THIS TCB                     22850002
         BE    PAPL020             YES APPLICABLE                       22900002
         SPACE                                                          22910002
PAPL040  LR    RF,RET              SHIFT TO USE RF TO BRANCH BACK       22950002
         SPACE                                                          22960002
         B     K04(,RF)            RETURN NOT APPLICABLE                23000002
         SPACE                                                          23050002
PAPL050  CLC   IOSDSID-IOSB+K01(K03,RIOSB),IPIBARG+K01         @YM02151 23100002
*                                  *IOSB DSID = DSID ARG                23110002
         BE    PAPL020             YES APPLICABLE                       23150002
         SPACE                                                          23160002
         B     PAPL040             NO NOT APPLICABLE                    23200002
     TITLE     'IGC0001F - GET UCB LOCK SUBROUTINE'                     23250002
***************************************************************         23300002
*                                                             *         23310002
*        OBTAIN UCB LOCK SUBROUTINE                           *         23320002
*                                                             *         23330002
***************************************************************         23340002
         SPACE                                                          23342002
PGUCBLK  STM   RB,RET,PWREGB       SAVE REGS 11,12,13,14                23500002
         SPACE                                                          23510002
         TM    UCBWGT,UCBMTPXP     MULT EXP DEVICE                      23550002
         BZ    PGLK010             NO BRANCH AROUND                     23600002
         SPACE                                                          23610002
         C     RUCB,UCBBASE        IS THIS THE BASE UCB                 23650002
         BE    PGLK010             YES ALREADY POINTS TO BASE           23700002
         SPACE                                                          23710002
         L     RB,UCBBASE          POINT TO BASE                        23750002
         LA    RB,UCBLOCK-UCB(,RB) POINT TO UCB LOCK                    23800002
         SPACE                                                          23810002
         B     PGLK020             GO SAVE LOCK ADDRESS                 23850002
         SPACE                                                          23860002
PGLK010  LA    RB,UCBLOCK          GET LOCK  ADDRESS                    23900002
         SPACE                                                          23910002
PGLK020  ST    RB,PWAUCBLK         SAVE LOCK ADDRESS                    23950002
         SPACE                                                          23960002
PGLK025  SETLOCK OBTAIN,TYPE=IOSUCB,MODE=UNCOND,ADDR=(11),             *24000002
               RELATED=(UCB,IGC016(PFLK015))                            24010002
         SPACE                                                          24020002
         LM    RB,RET,PWREGB       RESTORE REGS                         24050002
         SPACE                                                          24060002
         ST    RUCB,PWAUCBP        SAVE UCB PTR                         24062002
         OI    PERRFLG1,PERUCB     IND UCB LOCK HELD                    24070002
         SPACE                                                          24080002
         BR    RET                 RETURN TO CALLER                     24250002
     TITLE     'IGC0001F - FREE UCB LOCK SUBROUTINE'                    24300002
***************************************************************         24350002
*                                                             *         24360002
*        RELEASE UCB LOCK SUBROUTINE                          *         24370002
*                                                             *         24380002
***************************************************************         24390002
         SPACE                                                          24392002
PFUCBLK  STM   RB,RET,PWREGB       SAVE REGS                            24500002
         SPACE                                                          24510002
         L     RB,PWAUCBLK         GET ADDRESS OF UCB LOCK              24550002
         SPACE                                                          24560002
         TM    UCBWGT,UCBMTPXP     TEST FOR MULT EXP DEVICE             24600002
         BZ    PFLK010             NO, SKIP BASE UCB                    24650002
         SPACE                                                          24660002
         L     RD,UCBBASE          POINT TO BASE UCB                    24700002
         SPACE                                                          24710002
         NI    UCBFLA-UCB(RD),XFF-UCBBSY  TURN OFF BUSY                 24750002
         SPACE                                                          24800002
PFLK010  NI    PERRFLG1,XFF-PERUCB IND UCB LOCK NOT HELD                24810002
         SPACE                                                          24820002
PGLK015  SETLOCK  RELEASE,TYPE=IOSUCB,ADDR=(11),                       *24900002
               RELATED=(UCB,IGC016(PGLK025))                            24910002
         SPACE                                                          24920002
         LM    RB,RET,PWREGB       RESTORE REGS                         24950002
         SPACE                                                          24960002
         BR    RET                 RETURN TO CALLER                     25050002
         TITLE 'IGC0001F - LCH PURGE SUBROUTINE'                        25640002
***************************************************************         25650002
*                                                             *         25660002
*        LCH PURGE SUBROUTINE                                 *         25670002
*                                                             *         25680002
***************************************************************         25690002
         SPACE                                                          25692002
LCHPURG  ST    RET,PWRET1          SAVE RETURN ADDRESS                  25700002
         SPACE                                                          25710002
         L     RNINE,IOCOMEX       GET POINTER TO IOCOM EXT             25750002
         L     R2,IOCLCHTB         GET LCH POINTER                      25800002
         SLR   R4,R4               CLEAR REG                            25850002
         IC    R4,IOXHICH-IOX(,RNINE)   GET HIGHEST CHAN GENNED         25900002
         LA    R4,K01(,R4)         PLUS 1 EQUALS NO OF SENSE LCHS       25950002
         IC    RNINE,IOXLCHCT-IOX(,RNINE) GET LCH COUNT                 26000002
         SLL   RNINE,K24                                                26050002
         SRL   RNINE,K24           CLEAR ANY HIGH ORDER BITS            26100002
         ALR   RNINE,R4            TOTAL NUM OF LCHS                    26150002
         LR    R0,RNINE            PUT TOTAL LCHS IN R0                 26200002
         SPACE                                                          26250002
***************************************************************         26260002
*                                                             *         26270002
*        SCAN LCH'S FOR PURGEABLE IOQE'S                      *         26280002
*                                                             *         26290002
***************************************************************         26292002
         SPACE                                                          26294002
PLCH010  LR    RBACK,R2            PUT BACK POINTER INTO RNINE          26300002
         ST    R0,PQUEREG                                               26350002
         L     R5,LCHFST-LCH(,R2)  GET FIRST IOQ                        26400002
         SPACE                                                          26410002
         LTR   R5,R5               END OF LIST                          26450002
         BNP   PLCH150             YES BRANCH OUT                       26500002
         SPACE                                                          26510002
         STM   RB,RET,PWREGB       SAVE LOCK REGS              @YM01073 26520002
         SPACE                                                          26530002
         LA    RB,LCHLOCK-LCH(,R2) GET LOCK ADDRESS                     26550002
         ST    RB,PWALCHLK         SAVE LCH LOCK ADDR                   26552002
         SPACE                                                          26560002
PLCH015  SETLOCK OBTAIN,TYPE=IOSLCH,ADDR=(11),MODE=UNCOND,             *26600002
               RELATED=(LCH,IGC016(PLCH145))                            26602002
         SPACE                                                          26610002
         LM    RB,RET,PWREGB       RESTORE LOCK REGS           @YM01073 26620002
         SPACE                                                          26630002
         OI    PERRFLG1,PERLCH     IND LCH LOCK HELD                    26640002
         ST    R2,PWALCHP          SAVE LCH PTR                         26642002
         SPACE                                                          26644002
         L     R5,LCHFST-LCH(,R2)  GET FIRST IOQ                        26650002
         B     PLCH030             SKIP LINK ENTRY                      26700002
         EJECT                                                          26710002
***************************************************************         26720002
*                                                             *         26730002
*        CALL APPLICABILITY ROUTINE AND VALIDATE SRB          *         26740002
*                                                             *         26742002
***************************************************************         26744002
         SPACE                                                          26746002
PLCH020  L     R5,IOQLNK-IOQ(,RBACK)  GET LINK ENTRY                    26750002
         SPACE                                                          26760002
PLCH030  LTR   R5,R5               END OF LIST                          26800002
         BNP   PLCH140             YES BRANCH OUT                       26850002
         SPACE                                                          26860002
         L     RIOSB,IOQIOSB-IOQ(,R5) GET IOSB                          26900002
         L     RPAR,IOSSRB-IOSB(,RIOSB) GET SRB ADDRESS                 26950002
         SPACE                                                          26960002
         BAL   RET,PURAPLSR        GO CHECK SRB                         27000002
         SPACE                                                          27010002
         B     PLCH040             VALID GO GET UCB LOCK                27050002
         SPACE                                                          27060002
         LR    RBACK,RCUR          UPDATE BACK POINTER                  27100002
         SPACE                                                          27110002
         B     PLCH020             DOES NOT APPLY GO GET NEXT           27150002
         EJECT                                                          27160002
***************************************************************         27170002
*                                                             *         27180002
*        CHECK UCB FOR ACTIVE I/O                             *         27190002
*                                                             *         27192002
***************************************************************         27194002
         SPACE                                                          27196002
PLCH040  L     RUCB,IOSUCB-IOSB(,RIOSB)    GET UCB ADDRESS              27200002
         LA    RF,UCBPRFX          GET PREFIX OFFSET                    27250002
         SLR   RUCB,RF             BACKUP TO POINT TO PREFIX            27300002
         SPACE                                                          27302002
         TM    PPLOPT1,PPLHIO      HALT OPTION                          27304002
         BZ    PLCH100             NO BRANCH                            27306002
         SPACE                                                          27310002
         BAL   RET,PGUCBLK         GO GET UCB LOCK                      27350002
         SPACE                                                          27460002
         CL    R5,UCBIOQ           IOQ-S MATCH                          27500002
         BNE   PLCH060             NO DEQ IOSB/SRB COUNT                27550002
         SPACE                                                          27560002
         TM    UCBFLA,UCBPSNS+UCBSAP   PENDING SNS OR STAND ALONE PROC  27600002
         BZ    PLCH060             BRANCH NO,MUST BE RESIDUE IOQ        27650002
         SPACE                                                          27660002
         TM    UCBFLA,UCBPSNS      YES IS IT FOR PENDING SENSE          27700002
         BNZ   PLCH120             BRANCH YES,COULD MEAN SWAP           27750002
         SPACE                                                          27760002
***************************************************************         27800002
*                                                             *         27850002
*        DEVICE IS ENGAGED IN A STAND ALONE PROCESS  -        *         27860002
*        SETMODE, RESERVE/RELEASE,STAND ALONE SEEK, ETC.      *         27870002
*                                                             *         27872002
***************************************************************         27890402
         SPACE                                                          27890802
         TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED                   27892002
         BZ    PLCH050             BRANCH NO                            27894002
         SPACE                                                          27894402
         CLI   UCBSQC,ZERO         IS SOFTWARE RES COUNT ZERO           27896002
         BE    PLCH110             BRANCH YES  - MUST SWAP SRB/IOSB     27898002
*                                  * TO FORCE IOS TO ISSUE              27898402
*                                  * RELEASE CCW                        27898802
         SPACE                                                          27898902
***************************************************************         27899202
*                                                             *         27899302
*        NOTHING CRITICAL ON DEVICE - DETACH IOQ FROM         *         27899602
*        DEVICE BY RESETTING UCB STATUS INDICATORS            *         27904002
*                                                             *         27906002
***************************************************************         27906402
         SPACE 1                                                        27908002
PLCH050  NI    UCBFLA,XFF-UCBBSY-UCBSAP-UCBPST-UCBACTV  RESET           27916602
*                                  *BSY,SAP,PST,ACTV                    27926602
         OI    MASK1,MSKRDV        SET REDRIVE INDICATOR                27933302
         EJECT                                                          27943302
***************************************************************         27945302
*                                                             *         27947302
*        CALL BASIC PURGE AND PURGE LCH OF IOQE'S             *         27949302
*                                                             *         27949702
***************************************************************         27949802
         SPACE                                                          27949902
PLCH060  OI    MASK1,MSKDEQ        INDICATE TO BASIC PRG TO DEQUE       27950002
         SPACE                                                          27960002
         BAL   RET,BASICPRG        CALL BASIC PURGE                     28000002
         B     PLCH080             OFFSET 0                             28050002
         B     PLCH080             OFFSET 4                             28100002
*        B     PLCH070             BRANCH TO NEXT INSTRUCTION           28102002
         SPACE                                                          28110002
***************************************************************         28120002
*                                                             *         28130002
*        DECREMENT UCB REQUEST COUNT                          *         28140002
*                                                             *         28142002
***************************************************************         28144002
         SPACE                                                          28146002
PLCH070  L     RF,UPDTCNTA                                     @ZA06654 28150040
         BALR  RET,RF                                          @ZA06654 28180040
         SPACE                                                          28252002
         B     PLCH090             DO NOT UPDATE BACK POINTER           28260002
         SPACE                                                          28270002
PLCH080  LR    RBACK,RCUR          UPDATE BACK POINTER                  28310002
         SPACE                                                          28320002
PLCH090  BAL   RET,PFUCBLK         GO FREE UCB LOCK                     28350002
         SPACE                                                          28400002
         B     PLCH020             GO GET NEXT LINK PTR                 28450002
         SPACE                                                          28460002
***************************************************************         28470002
*                                                             *         28480002
*        INCREMENT IPIB AND PWA COUNTS                        *         28490002
*                                                             *         28492002
***************************************************************         28494002
         SPACE                                                          28496002
PLCH100  L     RF,IPIBCNT          GET IPIB COUNT                       28500002
         LR    RET,RF              FOR CS INSTR                @YM06014 28520002
         LA    RF,K01(R0,RF)       INCREMENT COUNT                      28550002
         CS    RET,RF,IPIBCNT      STORE UPDATED CNT IF UNCHANG@YM06014 28600002
         BNE   PLCH100             HAS BEEN CHANGED, LOOP AGAIN@YM06014 28601002
         SPACE                                                          28602002
         L     RF,PWAQCNT          INCREMENT COUNT OF SRB'S FOUND       28610002
         LA    RF,ONE(RF)          BUMP ONE                             28620002
         ST    RF,PWAQCNT          * STORE IN PURGE WORK AREA           28630002
         SPACE                                                          28632002
         LA    RF,IPIB             IPIB ADDRESS                         28640002
         ST    RF,IOSIPIB          STORE IN IOSB                        28642002
         SPACE                                                          28644002
         B     PLCH020             GET NEXT LINK ENTRY         @YM01286 28650002
         EJECT                                                          28660002
***************************************************************         28700002
*                                                             *         28710002
*        CALL BUILD IOSB/SRB ROUTINE AND                      *         28720002
*        SWAP THE SRB AND IOSB ATTACHED TO THE IOQ            *         28750002
*        WITH AN IOS SRB/IOSB                                 *         28800002
*                                                             *         28810002
***************************************************************         28850002
         SPACE                                                          28900002
PLCH110  L     RF,PRGGBLKA         GET ADDR OF PRGGBLOK                 28950003
         BALR  RET,RF              GET AND FORMAT SRB/IOSB              28955003
         SPACE                                                          28960002
         L     R0,IOSERP-IOSB(,RIOSB) ATTACH ERP WORK AREAS TO          29000002
         ST    R0,IOSERP-IOSB(,RC) * NEW IOSB                           29100002
         SPACE                                                          29110002
         SLR   R0,R0               CLEAR REG                            29150002
         ST    R0,IOSERP-IOSB(,RIOSB) IOSERP IN OLD IOSB = 0            29200002
         SPACE                                                          29250002
         ST    RC,IOQIOSB-IOQ(,RCUR) ATTACH NEW IOSB TO IOQ             29300002
         SPACE 1                                                        29400002
***************************************************************         29410002
*                                                             *         29420002
*        CALL ENQUE ROUTINE AND ENQUE OLD SRB ON PIRL         *         29450002
*        FOR APPROPRIATE DRIVER                               *         29452002
*                                                             *         29460002
***************************************************************         29470002
         SPACE                                                          29480002
         L     RF,PSRBENQA         GET ADDR OF PSRBENQ         @Y30IPLG 29490003
         BALR  RET,RF              GO ENQUEUE OLD SRB          @Y30IPLG 29500003
         SPACE                                                          29510002
         B     PLCH080             UPDATE RBACK & FREE UCB LOCK@YM04933 29550002
         EJECT                                                          29600002
***************************************************************         29602002
*                                                             *         29604002
*        PENDING SENSE FLAG ON IN UCB AND IOQ ON LCH AND      *         29620002
*        UCB AT SAME TIME - IF SENSE ACTIVE ALSO,DEQUEUE      *         29630002
*        FROM LCH AND HANDLE DURING UCB PURGE SCAN. IF        *         29640002
*        NOT ACTIVE, MUST SWAP SRB/IOSB SO IOS WILL ISSUE     *         29642002
*        SENSE WHEN RESOURCE FREE AND CLEAR A POSSIBLE        *         29644002
*        CONTINGENT CONNECTION IN HARDWARE                    *         29644402
*                                                             *         29644502
***************************************************************         29644802
         SPACE                                                          29646002
PLCH120  TM    UCBFLA,UCBACTV      IS DEVICE ACTIVE                     29648402
         BZ    PLCH110             GO SWAP SRB AND IOSB                 29648802
         SPACE 1                                                        29649202
         L     RB,IOQLNK-IOQ(,R5)  PICK UP NEXT IOQ ADDRESS             29649702
         ST    RB,ZERO(,RBACK)     STORE IN IOQLNK OF LAST IOQ          29649802
         SPACE                                                          29655402
         LTR   RB,RB               IS THIS ONE THE LAST                 29661002
         BP    PLCH130             BRANCH NO                            29666602
         SPACE                                                          29668602
         ST    RB,LCHLST-LCH(,R2)  UPDATE LCHLST IN LCH TABLE           29676602
         SPACE                                                          29686602
PLCH130  NI    IOQFLA-IOQ(R5),XFF-IOQSLCH-IOQENQ  RESET IOQE IND        29696602
         L     RF,UPDTCNTA                                     @ZA06654 29697640
         BALR  RET,RF                                          @ZA06654 29698640
         SPACE                                                          29699502
         B     PLCH090             GO FREE UCB LOCK                     29699802
         SPACE                                                          29702002
PLCH140  NI    PERRFLG1,XFF-PERLCH IND LCH LOCK NOT HELD                29710002
         SPACE                                                          29720002
         STM   RB,RET,PWREGB       SAVE LOCK REGS              @YM01073 29750002
         SPACE                                                          29760002
         LA    RB,LCHLOCK-LCH(,R2) GET LCH LOCK ADDRESS                 29800002
         SPACE                                                          29810002
PLCH145  SETLOCK RELEASE,TYPE=IOSLCH,ADDR=(11),                        *29850002
               RELATED=(LCH,IGC016(PLCH015))                            29852002
         SPACE                                                          29860002
         LM    RB,RET,PWREGB       RESTORE LOCK REGS           @YM01073 29870002
         EJECT                                                          29920002
***************************************************************         29930002
*                                                             *         29940002
*        CHECK NEXT LCH OR RETURN TO CALLER                   *         29942002
*                                                             *         29944002
***************************************************************         29946002
         SPACE                                                          29948002
PLCH150  LA    R2,LCHEL(R0,R2)     POINT TO NEXT LCH                    29950002
         L     R0,PQUEREG                                               30000002
         SPACE                                                          30010002
         BCT   R0,PLCH010          DECREMENT LCH COUNT - EXIT IF ZERO   30050002
         SPACE                                                          30060002
         L     RET,PWRET1          RESTORE RETURN ADDRESS               30100002
         SPACE                                                          30110002
         BR    RET                 RETURN TO CALLER                     30150002
         TITLE 'IGC0001F - OBTAIN LOCAL LOCK AND ADD FRR'               30152002
*****************************************************************       30158002
*                                                               *       30158402
*        OBTAIN LOCAL LOCK AND ADD FRR SUBROUTINE               *       30158802
*                                                               *       30159202
*****************************************************************       30159602
         SPACE                                                          30159702
PGLOCAL  STM   RB,RET,PWREGB       SAVE RB-R14                 @YM01073 30160702
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        *30161702
               RELATED=(LOCAL,IGC016(PFLOC010))                         30162102
         SPACE                                                          30163702
         SPACE                                                          30164502
         LA    RB,PURGEFRR         GET FRR ADDR                         30165702
         SPACE                                                          30166102
         SETFRR A,FRRAD=(11),PARMAD=(12),WRKREGS=(13,14)                30166502
         USING PFRRPARM,RC                                              30168602
         MVI  PFRRFLG1,PERLOCAL    IND LOCAL LOCK HELD         @Y30IPLG 30169203
*    NOTE FLAG IS IN FRR NOT IN PWA, MVI ZEROS OTHER BITS      @Y30IPLG 30169503
         ST    RCORE,PFRRPWAP      SAVE WORK AREA PTR                   30169902
         DROP  RC                                                       30170302
         LM    RB,RET,PWREGB                                   @YM01073 30171102
         SPACE                                                          30171902
         BR    RF                  RETURN TO MAIN ROUTINE               30172302
         USING IOCOM,RC            REUSE RC FOR IOCOM                   30172503
         TITLE 'IGC0001F - RELEASE LOCAL LOCK AND DELETE FRR'           30172702
*****************************************************************       30173102
*                                                               *       30173202
*        RELEASE LOCAL LOCK AND DELETE FRR SUBROUTINE           *       30173302
*                                                               *       30176602
*****************************************************************       30178602
         SPACE                                                          30179002
PFLOCAL  STM   RB,RET,PWREGB       SAVE RB-R14                 @YM01073 30179202
PFLOCAL2 EQU   *              USED WHEN NO PWA, LM BELOW LOADS @Y30IPLG 30179303
*                             GARBAGE, R11-R15 LOST            @Y30IPLG 30179403
*        PWA BASE ZEROED IF PFLOCAL2 ENTRY,TO AVOID PIC ON LM  @ZM30179 30184403
         SETFRR D,WRKREGS=(13,14)                                       30189403
         SPACE                                                          30199403
*        NI    PERRFLG1,XFF-PERLOCAL  IND LOCAL LOCK NOT HELD  @Y30IPLG 30209403
* THE ABOVE LINE DELETED, NO FRR AND POSIBLY NO PWA EXISTS     @Y30IPLG 30214403
         SPACE                                                          30219403
PFLOC010 SETLOCK RELEASE,TYPE=LOCAL,                                   *30229403
               RELATED=(LOCAL,IGC016(PGLOCAL))                          30239403
         SPACE                                                          30249403
         LM    RB,RET,PWREGB                                   @YM01073 30259403
         BR    RF                  RETURN TO MAIN ROUTINE               30269403
         TITLE 'IGC0001F - UCB PURGE SUBROUTINE'                        30322502
***************************************************************         30332502
*                                                             *         30334502
*        UCB PURGE SUBROUTINE                                 *         30336502
*                                                             *         30336902
***************************************************************         30337302
         SPACE                                                          30337702
UCBPURG  ST    RET,PWRET1          SAVE RETURN ADDRESS                  30338202
         SPACE                                                          30348202
         L     R4,CVTPTR           GET CVT PTR                          30350002
         L     R4,CVTILK2-CVTMAP(,R4)   GET UCB LOOKUP TABLE            30400002
         SPACE                                                          30410002
***************************************************************         30420002
*                                                             *         30430002
*        SCAN UCB LOOK-UP TABLE                               *         30440002
*                                                             *         30442002
***************************************************************         30444002
         SPACE                                                          30444402
PUCB010  LH    RUCB,ZERO(,R4)      GET UCB POINTER             @YM07689 30444802
         LA    R4,K02(,R4)         ADDR OF NXT UCB POINTER     @YM07689 30494802
         SPACE                                                          30550002
         LTR   RUCB,RUCB           IS THERE A UCB ADDR         @YM07689 30600002
         BNP   PUCB070             BRANCH NOT A UCB ADDR       @YM07689 30650002
         SPACE                                                          30700002
PUCB015  LH    RF,UCBFLA-UCBOB(,RUCB)  TO TEST POST & SENSE PST@YM07689 30750003
         N     RF,TESTPST          POST & SENSE POST FLAGS     @YM07689 30820002
         BZ    PUCB010             BRANCH IF UCB NOT ACTIVE    @YM07689 30890002
         EJECT                                                          30960002
***************************************************************         30970002
*                                                             *         30980002
*        CALL APPLICABILITY ROUTINE AND VALIDATE UCB          *         30990002
*                                                             *         30992002
***************************************************************         30994002
         SPACE                                                          30996002
PUCB020  LA    RF,UCBPRFX          GET LENGTH OF PREFIX        @YM07689 30997002
         SLR   RUCB,RF             POINT RUCB TO PREFIX        @YM07689 30998002
         SPACE                                                          30999002
PUCB022  BAL   RET,PGUCBLK         GO GET UCBLOCK              @OZ00762 31000003
         SPACE                                                          31010002
         TM    UCBFLA,UCBPST       POST STILL ON                        31050002
         BNZ   PUCB030             YES CONTINUE                         31100002
         SPACE                                                          31110002
         TM    UCBFLB,UCBSPST      SENSE POST ON                        31150002
         BZ    PUCB060             POST OR SENSE POST NOT ON            31200002
*                                  GO FREE UCB LOCK                     31210002
         SPACE                                                          31220002
PUCB030  L     RCUR,UCBIOQ         GET IOQ POINTER                      31250002
         L     RIOSB,IOQIOSB-IOQ(,RCUR) GET IOSB POINTER                31300002
         L     RPAR,IOSSRB         PUT SRB POINTER IN RPAR              31302002
         SPACE                                                          31302402
         TM    PPLOPT1,PPLHIO      HALT OPTION                          31304002
         BZ    PUCB050             BRANCH IF QUIESCE                    31306002
         SPACE                                                          31306402
         BAL   RET,PURAPLSR        SEE IF APPLICABLE                    31308002
         B     PUCB040             YES CONTINUE WITH PURGE              31308402
         B     PUCB060             NO DO NOT PURGE                      31308802
         EJECT                                                          31309202
***************************************************************         31309602
*                                                             *         31309702
*        CALL BUILD IOSB/SRB ROUTINE                          *         31309802
*        CALL ENQUE ROUTINE TO ENQUE OLD SRB TO PIRL          *         31309902
*                                                             *         31310002
***************************************************************         31313202
         SPACE                                                          31315202
PUCB040  TM    UCBFLA,UCBPSNS      PENDING SENSE                        31316702
         BZ    PUCB050             NO GO SET HIO INDICATOR              31320002
         SPACE                                                          31322002
         TM    UCBFLA,UCBACTV      IS CHANNEL PROG ACTIVE               31330002
         BO    PUCB050             YES GO SET HIO INDICATOR             31340002
         SPACE                                                          31340402
*        BAL   RET,PRGGBLOK        GO BUILD A NEW SRB/IOSB              31342003
         L     RF,PRGGBLKA         GET ADDR OF PRGGBLOK                 31342603
         BALR  RET,RF              GET AND FORMAT SRB/IOSB              31343203
         SPACE                                                          31344002
         ST    RC,IOQIOSB-IOQ(,RCUR) CHAIN NEW IOSB TO IOQ              31348402
         SPACE                                                          31348502
         L     R0,IOSERP-IOSB(,RIOSB) GET EWA PTR                       31348602
         ST    R0,IOSERP-IOSB(,RC) CHAIN ERP WA TO NEW IOSB             31348702
         SPACE                                                          31358702
         SLR   R0,R0                                                    31358902
         ST    R0,IOSERP-IOSB(,RIOSB) OLD IOSB EWA = ZEROS              31368902
         SPACE                                                          31378902
         L     RF,PSRBENQA         GET ADDR OF PSRBENQ         @Y30IPLG 31379203
         BALR  RET,RF              ENQUEUE OLD SRB ON PIRL     @Y30IPLG 31379603
         SPACE                                                          31389602
         B     PUCB060             GO FREE UCB LOCK                     31389802
         EJECT                                                          31399802
***************************************************************         31399902
*                                                             *         31403202
*        CALL BASIC PURGE AND PURGE SRB FROM UCB              *         31405202
*                                                             *         31405602
***************************************************************         31406002
         SPACE                                                          31406402
PUCB050  OI    MASK1,MSKHIO        INDICATE SRB PURGED FROM UCB         31406702
         SPACE                                                          31410002
         BAL   RET,BASICPRG        GO PURGE SRB FROM UCB                31450002
         B     PUCB060             * ALL THREE RETURNS                  31500002
         B     PUCB060             * MUST                               31550002
*        B     PUCB060             * GO TO NEXT INSTRUCTION             31552002
         SPACE                                                          31560002
PUCB060  BAL   RET,PFUCBLK         * GO FREE LOCK                       31600002
         SPACE                                                          31602003
         TM    MASK1,MSKUCB        CHECK IF RETRY NEEDED       @OZ00762 31604003
         BNO   PUCB010             LOOP FOR NEXT UCB           @OZ02555 31607003
         SPACE                                                          31610002
         SPACE                                                          31660002
         NI    MASK1,FF-MSKUCB     TURN OFF RETRY BIT          @OZ02555 31700003
         B     PUCB022             GO RETRY TO HALT REQUEST    @OZ02555 31701003
PUCB070  BZ    PUCB010             BRANCH ON A FILLER, LOOP    @YM07689 31702002
         CH    RUCB,FWORD          CHECK FOR FFFF TABLE END    @Z30ANLG 31702403
         BE    PUCB080             FOUND END OF TABLE          @Z30ANLG 31702803
         N     RUCB,HIGH2          16 BIT ADDR, N OFF 2 BYTES  @Z30ANLG 31703203
         B     PUCB015             CHECK IF UCB APPLICABLE     @Z30ANLG 31703603
*                                  ELSE END OF TABLE, RETURN   @YM07689 31704002
         SPACE                                                          31706002
         SPACE                                                          31710002
***************************************************************         31720002
*                                                             *         31730002
*        RETURN TO CALLER                                     *         31740002
*                                                             *         31742002
***************************************************************         31744002
         SPACE                                                          31746002
PUCB080  L     RET,PWRET1          GET RETURN ADDRESS                   31750002
         SPACE                                                          31760002
         BR    RET                 RETURN TO CALLER                     31800002
         TITLE 'IGC0001F - SPL PURGE SUBROUTINE'                        31850002
***************************************************************         31900002
*                                                             *         31950002
*        SPL PURGE SUBROUTINE                                 *         31960002
*                                                             *         31970002
***************************************************************         31980002
         SPACE                                                          31990002
SPLPURG  ST    RET,PWRET1          SAVE RETURN ADDRESS                  32000002
         SPACE                                                          32010002
         LA    RPAR,PWPRGPRM       GET DEQ PARM LIST ADDR               32050002
         SPACE                                                          32060002
         XC    PWPRGPRM,PWPRGPRM   CLEAR AREA                           32100002
         XC    PDQPARML,PDQPARML   CLEAR DBLWORD PARM          @YM3127P 32102002
         SPACE                                                          32104002
         LH    RF,PPLASID          GET ASID                    @YM3127P 32106002
         STH   RF,PDQPASID         PUT ASID IN PARM LIST       @YM3127P 32108002
         SPACE                                                          32110002
         TM    PPLOPT2,PPLMEM      MEMORY PURGE                @YM3127P 32112002
         BZ    PSPL005             NO, CHECK TASK              @YM3127P 32114002
         SPACE                                                          32116002
         LA    RF,PDQPASID         GET ASID PARM PTR           @YM3127P 32118002
         ST    RF,PWPRGPRM         SET ASID ADDR IN PARM LIST  @YM3127P 32118402
         SPACE                                                          32118802
         B     PSPL010             GO GET RMTR PARM            @YM3127P 32119202
         SPACE                                                          32119602
PSPL005  TM    PPLOPT1,PPLTASK     IS THIS TASK PURGE          @YM3127P 32120002
         BZ    PSPL010             NO, DONT NEED TCB ADDR      @YM01450 32130002
         SPACE                                                          32140002
         MVC   PDQPTCBP,IPIBARG+K01 GET TCB ADDR               @YM01450 32350002
         SPACE                                                          32352002
PSPL010  LA    RF,PDQPARML         GET ADDR OF ASIDTCB PARMS   @YM04943 32354002
         ST    RF,PWPRGPRM+K04     *AND PUT IN PARM LIST       @YM01450 32356002
         SPACE                                                          32360002
***************************************************************         32370002
*                                                             *         32380002
*        ISSUE PURGEDQ                                        *         32390002
*                                                             *         32392002
***************************************************************         32394002
         SPACE                                                          32396002
         L     RF,CVTPTR           GET CVT PTR                 @YM04943 32400002
         L     RC,CVTIXAVL         GET IOCOM ADDR           @YMXXX      32410002
         L     RF,IOCPRGID         GET PURGE DEQUEUE ROUTINE ADDR       32420002
         ST    RF,PWPRGPRM+K08     PUT ROUTINE ADDR IN PARM LIST        32450002
         OI    IPIBFLG1,IPIBDQ     SHOW IECVPURG THAT PURGEDQ           32450640
*                                  ISSUED                      @ZA12676 32451240
         SPACE                                                          32452002
         PURGEDQ MF=(E,(1))                                             32500002
         NI    IPIBFLG1,XFF-IPIBDQ TURN OFF PURGEDQ INDICATOR  @ZA12676 32510040
         BAL   RF,PGLOCAL          GET LOCAL LOCK AND SET FRR  @ZA12675 32520040
         EJECT                                                          32550002
***************************************************************         32600002
*                                                             *         32610002
*        CALL BASIC PURGE AND SCHEDULE SRB                    *         32620002
*                                                             *         32630002
***************************************************************         32640002
         SPACE                                                          32642002
PSPL020  L     RPAR,IPIBSRB        GET SRB ADDR                         32650002
         SPACE                                                          32660002
         LTR   RPAR,RPAR           IS THERE AN ADDR                     32700002
         BZ    PSPL040             NO, GO RETURN                        32750002
         SPACE                                                          32760002
         MVC   IPIBSRB,SRBFLNK     GET SRB FORWARD CHAIN PTR            32800002
         L     R10,SRBPARM         PICK UP IOSB ADDRESS                 32810102
         TM    PPLOPT1,PPLHIO      IS IT A HALT OPERATION      @OZ00091 32810540
         BO    PSPL027             YES, BRANCH ARND PCI CODE   @OZ00091 32810940
         SPACE                                                          32812503
         TM    IOSFLA,IOSIOSB      IF IOSIOSB, DONT COUNT      @OZ00091 32812940
         BNO   PSPL027             NOT IOSIOSB, COUNT IF APPL  @OZ00091 32813340
         CLI   IOSPROC,IOSAPCI     IS IT A PCI IOSB ?          @OZ00091 32814140
         BNE   PSPL030             NO, ATTN, RESCHEDULE        @OZ00091 32814940
         SPACE                                                          32816503
         ST    RPAR,PWREG1         SAVE SRB FOR THIS PCI IOSB  @OZ00091 32816940
         L     R10,IOSPCHN         GET ENDING STATUS IOSB      @OZ00091 32817340
         LTR   R10,R10             MAKE SURE THERE IS ONE      @OZ00091 32818140
         BZ    PSPL030             JUST RESCHEDULE PCI IOSB    @OZ00091 32818940
         L     RPAR,IOSSRB         GET SRB ADDRESS             @ZA09210 32820140
         BAL   RET,BASICPRG        COUNT E.S. IOSB IF APPL     @OZ00091 32820440
         B     PSPL024             GOOD RETURN, +0 VECTOR      @OZ00091 32821140
PSPL024  L     RPAR,PWREG1         RELOAD SRB & +4 VECTOR      @OZ00091 32822140
         B     PSPL030             RESCHEDULE PCI SRB          @OZ00091 32823140
PSPL027  L     RUCB,IOSUCB         GET UCB ADDRESS                      32825103
         LA    RF,UCBPRFX          GET PREFIX LENGTH                    32830102
         SLR   RUCB,RF             BACK UP UCB POINTER TO PREFIX        32840102
         SLR   RCUR,RCUR           TO INDICATE NO IOQ TO FREE  @YM04939 32841102
         SPACE                                                          32842102
         BAL   RET,BASICPRG        CALL BASIC PURGE SUBROUTINE          32850002
         B     PSPL030             GOOD RETURN                          32900002
         B     PSPL030             OFFSET 4                             32950002
         B     PSPL020             OFFSET 8                             33000002
         SPACE                                                          33010002
PSPL030  SCHEDULE SRB=(1),SCOPE=GLOBAL                                  33050002
         SPACE                                                          33060002
         B     PSPL020             GO CHECK FOR ANOTHER SRB ADDR        33100002
         SPACE                                                          33110002
PSPL040  BAL RF,PFLOCAL            FREE LOCAL LOCK AND DEL FRR @ZA12675 33120040
         L     RET,PWRET1          GET RETURN ADDR                      33130040
         SPACE                                                          33160002
         BR    RET                 RETURN TO CALLER                     33200002
         SPACE                                                          33250002
         TITLE 'IGC0001F - IPIB PURGE SUBROUTINE'                       33750002
***************************************************************         33800002
*                                                             *         33802002
*        IPIB PURGE SUBROUTINE                                *         33804002
*                                                             *         33806002
***************************************************************         33808002
         SPACE                                                          33808402
IPIBPURG ST    RET,PWRET1          SAVE RETURN ADDRESS                  33808802
         SPACE                                                          33809202
         STM   RB,RD,PWREGB        SAVE REGS                            33810002
         SPACE                                                          33812002
         L     RF,CVTPTR           GET CVTPTR                           33820002
         L     RC,CVTIXAVL         GET IOCOM PTR                        33830002
         LA    RB,IOCSYNCH-IOCOM(RC)  GET LOCK ADDR                     33840002
         ST    RB,PWASYNCH         SAVE IOSYNCH LOCK                    33840402
         SPACE                                                          33842002
         SETLOCK OBTAIN,TYPE=IOSYNCH,MODE=UNCOND,ADDR=(11),            *33844002
               RELATED=(IOSYNCH,IGC016(PIBIB20))                        33846002
         SPACE                                                          33848002
         LM    RB,RD,PWREGB        RESTORE REGS                         33848402
         SPACE                                                          33848802
***************************************************************         33848902
*                                                             *         33849002
*        ZERO ASCB IPIB POINTER                               *         33849102
*                                                             *         33849202
***************************************************************         33849302
         SPACE                                                          33849402
         SLR   RF,RF               CLEAR REG                            33849602
         L     RET,PSAAOLD         GET ASCB PTR                         33849702
         L     RC,ASCBIOSP-ASCB(RET)    GET 1ST IPIB ON QUEUE  @YM07220 33849802
         C     RF,IPIBLNK-IPIB(,RC)     IS LINK PTR 0, : 1 IPIB@YM07220 33849902
         BNE   PIPIB04             2 IPIBS, ZERO IPIBLNK       @YM07220 33850002
         ST    RF,ASCBIOSP-ASCB(RET)  ZERO IPIB PTR                     33854002
         B     PIPIB06             SKIP IPIBLNK LOGIC          @YM07220 33859902
PIPIB04  ST    RF,IPIBLNK-IPIB(,RC)     ZERO IPIBLNK           @YM07220 33867902
         SPACE                                                          33875902
PIPIB06  NI    PERRFLG0,XFF-PERIOSP IND ASCBIOSP NOT ACTIVE             33883902
         SPACE                                                          33891902
         L     RPAR,IPIBPSQ   TO GET ASYNCH RBS FROM IECIOSAM  @YM05500 33900002
         EJECT                                                          33910002
***************************************************************         33920002
*                                                             *         33930002
*        SCAN IPIB FOR SRB'S                                  *         33940002
*        AND CALL ENQUE ROUTINE TO ENQUE SRB'S                *         33940402
*                                                             *         33942002
***************************************************************         33944002
         SPACE                                                          33946002
PIPIB10  LTR   RPAR,RPAR           ANY MORE SRB-S ON IPIB               33950002
         BE    PIBIB20             NO EXIT                              34000002
         SPACE                                                          34010002
         L     R2,SRBFLNK-SRB(,RPAR) GET SRB PTR TO NEXT       @YM04934 34100002
         SPACE                                                          34110002
         L     RF,PSRBENQA         GET ADDR OF SRB ENQ ROUT    @Y30IPLG 34130003
         BALR  RET,RF              CALL SRB ENQ SUBROUTINE     @Y30IPLG 34150003
         LR    RPAR,R2             UPDATE RPAR TO NXT SRB      @YM04934 34155002
         SPACE                                                          34160002
         B     PIPIB10             GO TEST FOR MORE SRB'S               34200002
         SPACE                                                          34202002
***************************************************************         34204002
*                                                             *         34206002
*        RETURN TO CALLER                                     *         34208002
*                                                             *         34208402
***************************************************************         34208802
         SPACE                                                          34209202
PIBIB20  STM   RB,RD,PWREGB        SAVE REGS                            34210002
         SPACE                                                          34212002
         L     RB,PWASYNCH         GET IOSYNCH LOCK                     34214002
         SPACE                                                          34220002
         SETLOCK RELEASE,TYPE=IOSYNCH,ADDR=(11),                       *34230002
               RELATED=(IOSYNCH,IGC016(IPIBPURG))                       34240002
         SPACE                                                          34242002
         LM    RB,RD,PWREGB        RESTORE REGS                         34244002
         SPACE                                                          34246002
         L     RET,PWRET1          GET RETURN ADDR                      34250002
         SPACE                                                          34260002
         BR    RET                 RETURN TO CALLER                     34300002
         TITLE 'IGC0001F - DRIVER PURGE SUBROUTINE'                     34350002
***************************************************************         34400002
*                                                             *         34410002
*        DRIVER PURGE SUBROUTINE                              *         34420002
*                                                             *         34430002
***************************************************************         34440002
         SPACE                                                          34442002
DVRPURG  ST    RET,PWRET1          SAVE RETURN ADDR                     34450002
         SPACE                                                          34460002
         L     RF,CVTPTR           GET CVT PTR                          34500002
         L     RC,CVTIXAVL         GET POINTER TO IOCOM                 34550002
         L     RB,IOCVOID          GET POINTER TO VOID                  34600002
         SPACE                                                          34600102
         LA    RPAR,IPIB           POINT TO IPIB               DCR21082 34600402
         LA    RD,PWREGSAV         GET SAVE AREA FOR DRIVERS   DCR21082 34600802
         SLR   R2,R2               ZERO DSID PURGE INDEX CHECK DCR21082 34601202
         SPACE                                                          34602002
         TM    IPIBOPT,IPIBMEM+IPIBTASK  IS THIS DISD PURGE    DCR21082 34610002
         BNZ   PDVR030             NO, NOT DSID PURGE          DCR21082 34620002
         SPACE                                                          34622002
         CLI   IPIBDVID,EXCPTST    IS THIS EXCP DSID           DCR21082 34630002
         BNE   PDVR010             NO, SKIP SPECIAL            DCR21082 34640002
         SPACE                                                          34640402
         LA    R4,EXCPID           GET EXCP DRIVER ID          DCR21082 34642002
         SPACE                                                          34642402
         B     PDVR020             CONTINUE                    DCR21082 34644002
         SPACE                                                          34644402
PDVR010  SLR   R4,R4               CLEAR REG                   DCR21082 34646002
         IC    R4,IPIBDVID         GET DRIVER ID               DCR21082 34648002
         SPACE                                                          34648102
PDVR020  LR    R2,R4               COPY DRIVER ID              DCR21082 34648402
         SLL   R2,2                DRIVER ID*4                 DCR21082 34648802
         SLL   R4,3                PIRL INDEX=8*DRIVER ID      DCR21082 34649202
         ALR   R2,R4               VOID INDEX=12*DRIVER ID     DCR21082 34649602
         SPACE                                                          34666602
PDVR030  LH    R4,IOCVOICT         GET NUM OF VOID ENTRIES     DCR21082 34683302
         SLR   RNINE,RNINE         CLEAR INDEX FOR VOID ENT             34700002
         LR    RC,RPIRL            PUT PIRL POINTER IN RC               34750002
         SPACE                                                          34760002
*        XC    IPIBIO(K08),IPIBIO  CLEAR IPIBIO AND DRVU       DCR21082 34800002
*        THIS DONE AUTOMATICALLY BELOW, BEFORE CALL TO DRVR PURGE       34800202
         EJECT                                                          34800402
***************************************************************         34802002
*                                                             *         34804002
*        CALL DRIVER PURGE SUBROUTINES                        *         34806002
*                                                             *         34808002
***************************************************************         34808402
         SPACE                                                          34810002
PDVR040  LTR   R2,R2               DSID PURGE                  DCR21082 34860002
         BZ    PDVR050             NO, CALL ALL DRIVERS        DCR21082 34870002
         SPACE                                                          34872002
         CR    R2,RNINE            DRIVER INDEX=CALLERS INDEX  DCR21082 34880002
         BE    PDVR050             YES, MUST CALL THIS DRIVER  DCR21082 34890002
         SPACE                                                          34892002
         OC    PIRRSTR-PIRL(K04,RC),PIRRSTR-PIRL(RC)  IS THERE DCR21082 34894002
*                                  *AN I/O REQUEST LIST ON PIRL         34896002
         BZ    PDVR060             NO, SKIP CALL TO DRIVER     DCR21082 34898002
         SPACE                                                          34898402
PDVR050  MVC   IPIBSRB,PIRRSTR-PIRL(RC) MOVE CURR PIRL ENTRY   DCR21082 34900002
*                                  *TO IPIB                             34902002
         SPACE                                                          34910002
         L     RF,VOIPRG-VOID(RNINE,RB)  GET ADDR OF DRIVER             34950002
*                                  *PURGE SUBROUTINE                    34960002
         MVC   IPIBIO(K08),PIRRSTR-PIRL(RC) SAVE PIRL ENTRY    @YM04941 34980002
         SPACE                                                          35010002
         BALR  RET,RF              BRANCH TO DVR PURGE ROUTINE          35200002
         SPACE                                                          35260002
         MVC   PIRRSTR-PIRL(K08,RC),IPIBIO  COPY POINTER TO    DCR21082 35300002
*                                  *I/O REQUEST CHAIN                   35310002
         SPACE                                                          35320002
PDVR060  LA    RNINE,VOIEL(,RNINE) POINT TO NEXT DVR           @YM07243 35350002
         LA    RC,PIRENTL(,RC)     POINT TO NEXT PIRL ENTRY             35400002
         SPACE                                                          35410002
         BCT   R4,PDVR040          BRANCH IF MORE DVRS         DCR21082 35450002
         SPACE                                                          35460002
         L     RPIRL,IPIBPIRL      GET IPIB PTR                         35500002
         L     RET,PWRET1          GET RETURN ADDRESS                   35550002
         SPACE                                                          35560002
         BR    RET                 RETURN TO MAINLINE PURGE             35600002
         TITLE 'IGC0001F - DDR PURGE SUBROUTINE'                        35650002
***************************************************************         35710002
*                                                             *         35712002
*        DDR PURGE SUBROUTINE                                 *         35712402
*                                                             *         35714002
***************************************************************         35748402
         SPACE                                                          35748802
DDRPURG  ST    RET,PWRET1          SAVE RETURN ADDRESS                  35750002
         SPACE                                                          35760002
         L     RF,PSAAOLD          GET CURRENT ASCB PTR        @YM01204 35800002
         SPACE                                                          35850002
         NI    MASK1,XFF-MSKDDRM   RESET DDR MAST SCHED MASK            35950002
         SPACE                                                          35980002
         CLC   ASCBASID-ASCB(K02,RF),MSTRMEM  MASTER MEMORY    @YM3127P 35990002
         BE    PDDR070             YES, ONLY ONE PASS          @YM3127P 35992002
         SPACE                                                          36000002
***************************************************************         36010002
*                                                             *         36020002
*        SCAN DDR COM'S                                       *         36030002
*                                                             *         36040002
***************************************************************         36042002
         SPACE                                                          36044002
PDDR010  L     RB,ASCBASXB-ASCB(,RF) GET POINTER TO ASXB                36050002
         L     R4,ASXBDDR-ASXB(,RB)  GET POINTER TO DDRCOM              36100002
         SPACE                                                          36110002
         USING DDRCOM,R4                                                36150002
PDDR020  LA    R4,0(,R4)           CLEAR HIGH BYTE                      36200002
         SPACE                                                          36210002
         LTR   R4,R4               ANY DDRCOM                           36250002
         BZ    PDDR070             NO COM BRANCH OUT                    36300002
         SPACE                                                          36310002
         TM    DDRSRC,DDRSYS       SYS INITIATED SWAP                   36350002
         BO    PDDR030             GO GET PTR TO IOSB                   36400002
         SPACE                                                          36410002
         B     PDDR060             OPER INITIATED SO INCR               36450002
*                                  *QUIESCE COUNT                       36460002
         SPACE                                                          36470002
***************************************************************         36480002
*                                                             *         36490002
*        CALL APPLICABILITY ROUTINE AND VALIDATE SRB          *         36492002
*                                                             *         36494002
***************************************************************         36496002
         SPACE                                                          36498002
PDDR030  L     R2,DDRUIOSB-DDRCOM(,R4) GET POINTER TO IOSB              36500002
         LTR   R2,R2               IF NO IOSB, CHECK NEXT      @OZ00082 36510003
         BZ    PDDR060             NO IOSB                     @OZ00082 36520003
         L     RPAR,IOSSRB-IOSB(,R2)  POINT TO SRB                      36550002
         SPACE                                                          36560002
         BAL   RET,PURAPLSR        DOES THE SRB APPLY TO THIS PURGE     36600002
         B     PDDR040             YES IT DOES APPLY                    36650002
         B     PDDR060             NO IT DOES NOT                       36700002
         EJECT                                                          36710002
***************************************************************         36720002
*                                                             *         36730002
*        CALL ENQUE ROUTINE AND ENQUE SRB ON PIRL             *         36740002
*                                                             *         36742002
***************************************************************         36744002
         SPACE                                                          36746002
PDDR040  TM    PPLOPT1,PPLHIO      HALT OR QUIESCE                      36750002
         BZ    PDDR050             QUIESCE GO INCREMENT QUIESCE COUNT   36800002
         SPACE                                                          36810002
         L     RF,PSRBENQA         GET ADDR OF PSRBENQ         @Y30IPLG 36830003
         BALR  RET,RF              GO ENQ ON THE PIRL          @Y30IPLG 36850003
         SPACE                                                          36860002
         OI    DDRSTAT,DDRPRG      INDICATE SRB PURGED         @OZ00762 36900003
         SPACE                                                          36910002
         XC    DDRUIOSB,DDRUIOSB   CLEAR POINTER TO IOSB                36950002
         SPACE                                                          36952002
         L     RUCB,IOSUCB-IOSB(,R10) GET UCB ADDRESS                   36960002
         LA    RF,UCBPRFX          GET PREFIX LENGTH                    36973302
         SLR   RUCB,RF             BACK UP UCB POINTER TO PREFIX        36983302
         SPACE                                                          36983402
         OI    PURGRETC,PURIO      IND I/O HALTED                       36983702
         SPACE                                                          36984102
         CLI   UCBTBYT3,UCB3COMM   IS IT TP DEVICE                  CTC 36985302
         BNE   PDDR060                                              CTC 36985502
         SPACE                                                          36985802
         OI    PURGRETC,PURTP      INDICATE TP I/O HALTED               36986102
         SPACE                                                          36986502
         B     PDDR060             CONTINUE                             36986702
         SPACE                                                          36987102
***************************************************************         36988702
*                                                             *         36990702
*        INCREMENT IPIB QUIESCE COUNT                         *         36992702
*                                                             *         36994702
***************************************************************         36995102
         SPACE                                                          36996702
PDDR050  L     RF,IPIBCNT          PICK UP QUIESCE COUNT       @YM01376 37000002
         LR    RET,RF              FOR CS INSTR                @YM06014 37020002
         LA    RF,K01(,RF)         ADD ONE                              37050002
         CS    RET,RF,IPIBCNT                                  @YM06014 37100002
         BNE   PDDR050                                         @YM06014 37105002
         SPACE                                                          37110002
         LA    RF,IPIB             GET IPIB ADDR               @YM01286 37120002
         ST    RF,IOSIPIB-IOSB(,R10)  IPIB ADDR IN IOSB        @YM01286 37130002
         SPACE                                                          37140002
PDDR060  L     R4,DDRNXT           POINT TO NEXT DDR COM                37150002
         SPACE                                                          37160002
         B     PDDR020             GO TEST FOR DDR COM                  37200002
         EJECT                                                          37210002
***************************************************************         37220002
*                                                             *         37230002
*        CONTINUE UNTIL MASTER MEMORY IS CHECKED              *         37240002
*                                                             *         37242002
***************************************************************         37244002
         SPACE                                                          37246002
PDDR070  TM    MASK1,MSKDDRM       MASTER MEM CHECKED YET               37250002
         BO    PDDR080             YES EXIT                             37300002
         SPACE                                                          37310002
         OI    MASK1,MSKDDRM       SET MAST MEM BEING CHECKED           37350002
         SPACE                                                          37360002
         L     RF,CVTPTR           GET CVT PTR                          37400002
         L     RF,CVTASVT          GET PTR TO ASVT             @YM04180 37450002
         DROP  RF                  FOR 1 INSTR USE RF AS BASE  @YM04180 37453002
         USING ASVT,RF              TO ASVT                             37456002
         L     RF,ASVTENTY         PTR TO 1ST ASCB IE. MASTER  @YM04180 37460002
*                                   MEM ASCB                            37470002
         DROP  RF                                              @YM04180 37480002
         USING CVTMAP,RF           RESTORE RF AS BASE TO CVT   @YM04180 37490002
         STM   RB,RF,PWREGB        SAVE REGS                            37500002
         SPACE                                                          37560002
PDDR075  SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          *37600002
               RELATED=(CMS,IGC016(PDDR085))                            37610002
         LM    RB,RF,PWREGB        RESTORE REGS                         37650002
         SPACE                                                          37660002
         OI    PERRFLG1,PERCMS     IND CMS LOCK HELD                    37670002
         SPACE                                                          37680002
         B     PDDR010             GO GET ASCB EXT PTR                  37700002
         SPACE                                                          37702002
***************************************************************         37704002
*                                                             *         37706002
*        RETURN TO CALLER                                     *         37708002
*                                                             *         37708402
***************************************************************         37708802
         SPACE                                                          37709202
PDDR080  STM   RB,RET,PWREGB       SAVE LOCK REGS              @YM01073 37710002
         SPACE                                                          37710402
         NI    PERRFLG1,XFF-PERCMS  IND CMS LOCK NOT HELD               37712002
         SPACE                                                          37720002
PDDR085  SETLOCK RELEASE,TYPE=CMS,                                     *37750002
               RELATED=(CMS,IGC016(PDDR075))                            37752002
         SPACE                                                          37760002
         LM    RB,RET,PWREGB       RESTORE LOCK REGS           @YM01073 37770002
         SPACE                                                          37780002
         L     RET,PWRET1          GET RETURN ADDR                      37800002
         SPACE                                                          37810002
         BR    RET                 RETURN TO CALLER                     37850002
         TITLE 'IGC0001F - SIRB PURGE SUBROUTINE'                       37900002
***************************************************************         37950002
*                                                             *         37960002
*        SIRB PURGE SUBROUTINE                                *         37970002
*                                                             *         37980002
***************************************************************         37990002
         SPACE                                                          37992002
SIRBPURG ST    RET,PWRET1          SAVE RETURN ADDR                     38000002
         L     RF,CVTPTR           GET CVT PTR                          38050002
         L     RC,CVTIXAVL         GET IOCOM ADDRESS                    38060002
         SPACE                                                          38062002
         TM    IPIBOPT,IPIBMEM     MEMORY PURGE                @YM3090P 38070002
         BZ    PSIRB05             NO, USE CURRENT ASCB        @YM3114P 38080002
         SPACE                                                          38090002
         TM    PPLOPT1,PPLHIO      HALT OPTION                 @YM3114P 38092002
         BO    PSIRB90             YES, EXIT NOW               @YM3114P 38094002
*                                  *OUT OF CORE ABEND                   38096002
         SPACE                                                          38098002
PSIRB05  L     RF,PSAAOLD          GET CURRENT ASCB PTR        @YM3114P 38100002
         SPACE                                                          38150002
         L     R4,ASCBASXB-ASCB(,RF) GET ASXB OUT OF THE ASCB           38200002
         SLR   RCUR,RCUR           INDICATE NO IOQE TO FREE             38250002
*        NOTE RCUR MUST BE ZERO BEFORE CALL TO BASICPRG                 38270002
         LA    RBACK,ASXBFSRB-ASXB-K04(,R4) SET BACKLINK POINTER        38300002
         L     RPAR,ASXBFSRB-ASXB(,R4) LOAD THE FIRST ON THE QUEUE      38350002
         SPACE                                                          38360002
         LTR   RPAR,RPAR           ANY SRBS ON THE QUEUE                38400002
         BZ    PSIRB60             NO, GO LOOK AT SIRB                  38450002
         EJECT                                                          38452002
***************************************************************         38454002
*                                                             *         38456002
*        CALL APPICABILITY ROUTINE AND VALIDATE SRB           *         38458002
*                                                             *         38458402
***************************************************************         38458802
         SPACE                                                          38459202
PSIRB10  L     R2,SRBFLNK          LOAD THE FORWARD LINK POINTER        38460002
         SPACE                                                          38470002
         BAL   RET,PURAPLSR        APPLICABILITY CHECK THE SRB          38500002
         B     PSIRB20             APPLICABLE                           38550002
         B     PSIRB40             NOT APPLICABLE                       38600002
         SPACE                                                          38650002
PSIRB20  EQU   *                                               @YM07227 38660002
         TM    PPLOPT1,PPLHIO      IS THIS A HALT ?            @YM07227 38670002
         BNO   PSIRB30             NO, DON'T DEQUE             @YM07227 38680002
         ST    R2,SRBFLNK-SRB(,RBACK) STORE THE FORWARD LINK INTO THE   38700002
*                                  CHAIN OF THE BACK LINK POINTER       38750002
         SPACE                                                          38760002
         LTR   R2,R2               LAST IN THE QUEUE                    38800002
         BP    PSIRB30             NO,DO NOT UPDATE LAST POINTER        38850002
         SPACE                                                          38860002
         ST    RBACK,ASXBLSRB-ASXB(,R4) BACK LINK NOW IS LAST           38900002
         SPACE                                                          38910002
         C     R2,ASXBFSRB-ASXB(,R4) IS QUEUE NOW EMPTY                 38950002
         BNE   PSIRB30             NO, LAST POINTER SET                 39000002
         SPACE                                                          39010002
         ST    R2,ASXBLSRB-ASXB(,R4) SET FIRST AND LAST THE SAME        39050002
         SPACE                                                          39060002
PSIRB30  L     R10,SRBPARM         PICK UP IOSB ADDRESS        @YM04936 39060102
         L     RUCB,IOSUCB-IOSB(,R10) GET UCB ADDRESS                   39070102
         LA    RF,UCBPRFX          GET PREFIX LENGTH                    39080102
         SLR   RUCB,RF             BACK UP UCB POINTER TO PREFIX        39090102
         SPACE                                                          39092102
***************************************************************         39094102
*                                                             *         39096102
*        CALL BASIC PURGE AND PURGE SRB                       *         39098102
*                                                             *         39098502
***************************************************************         39098902
         SPACE                                                          39099302
         BAL   RET,BASICPRG        PURGE THIS SRB                       39100002
         B     PSIRB50             CONTINUE SCAN                        39150002
         B     PSIRB50             CONTINUE SCAN                        39200002
         B     PSIRB50             CONTINUE SCAN                        39250002
         SPACE                                                          39300002
PSIRB40  LR    RBACK,RPAR          SET NEW BACKLINK POINTER             39350002
         SPACE                                                          39360002
PSIRB50  LTR   RPAR,R2             ANY MORE SRBS ON THE QUEUE           39400002
         BP    PSIRB10             CONTINUE PROCESSING SRBS             39450002
         EJECT                                                          39500002
***************************************************************         39510002
*                                                             *         39520002
*        VALIDATE AND CALL BASIC PURGE AND PURGE SIRB         *         39530002
*                                                             *         39540002
***************************************************************         39542002
         SPACE                                                          39544002
PSIRB60  L     R4,ASXBSIRB-ASXB(,R4)  GET POINTER TO SIRB               39550002
         SPACE                                                          39560002
         TM    RBSTAB2-RBBASIC(R4),RBFACTV IS SIRB ACTIVE               39600002
         BZ    PSIRB90             NOTHING TO PURGE                     39650002
         SPACE                                                          39660002
         L     RPAR,RBIQEA-RBBASIC(,R4) GET POINTER TO SRB              39700002
         SPACE                                                          39710002
         LTR   RPAR,RPAR           TEST FOR ERP WA APPENDED             39750002
         BNP   PSIRB90             YES, DO NOT PURGE AGAIN     @ZA11319 39770040
         SPACE                                                          39810002
         L     R2,SRBPARM          LOAD THE IOSB ADDRESS                39850002
         L     RNINE,IOSERP-IOSB(,R2) LOAD POINTER TO ERP WORK AREA     39900002
         XC    IOSERP-IOSB(K04,R2),IOSERP-IOSB(R2) ZERO IOSERP          39950002
         L     RUCB,IOSUCB-IOSB(,R2) GET UCB ADDRESS                    39970002
         LA    RF,UCBPRFX          GET PREFIX LENGTH           @YM04937 39973002
         SLR   RUCB,RF             BACK UP UCB PTR TO PREFIX   @Y       39976002
         SPACE                                                          39980002
         BAL   RET,BASICPRG        PURGE IF APPLICABLE                  40000002
         B     PSIRB80             RESTORE IOSERP RETURN                40050002
         B     PSIRB80             RESTORE IOSERP RETURN                40100002
*        B     PSIRB70             SRB DEQUEUED FROM SIRB               40150002
         SPACE                                                          40200002
PSIRB70  L     RF,IOCQCNT          GET ADDRESS OF PURGE                 40250002
         LA    RF,K04(RF)          *CLEAN-UP ROUTINE (IECVPURG)         40260002
         SPACE                                                          40262002
         ST    RF,RBOPSW+K04-RBBASIC(,R4)  UPDATE NSI IN SIRB  @YM04931 40270002
         ST    RNINE,RBIQEA-RBBASIC(,R4) SAVE ERP WA IN SIRB            40300002
         OI    RBIQEA-RBBASIC(R4),DBLENTRY SET TO NEGATIVE FOR          40350002
*                                  DOUBLE ENTRY TEST                    40400002
         B     PSIRB90             BRANCH TO RETURN POINT               40450002
         SPACE                                                          40500002
PSIRB80  ST    RNINE,IOSERP-IOSB(,R2) STORE ADDRESS OF ERP AREA BACK    40550002
         SPACE                                                          40560002
PSIRB90  L     RET,PWRET1          RESTORE RETURN ADDRESS               40600002
         SPACE                                                          40610002
         BR    RET                 RETURN TO MAIN ROUTINE               40650002
         TITLE 'IGC0001F - DEFINED CONSTANTS'                           41600002
***************************************************************         41650002
*                                                             *         41660002
*        DEFINED CONSTANTS                                    *         41670002
*                                                             *         41680002
***************************************************************         41690002
         SPACE                                                          41692002
PURNQLST ENQ   (SYSZEC16,PURGE,E,5,STEP),RET=HAVE,MF=L         @YM3104P 41700002
*                                  AND ALSO                    @YM05797 41720002
SYSZEC16 DC    C'SYSZEC16'         RESOURCE NAME                        41750002
PURGE    DC    C'PURGE'            RESOURCE NAME                        41800002
         SPACE                                                          41810002
PIRLSUBP DC    AL1(254)            SUB POOL 254 FIXED, JOB STP @Y30IPLG 41815003
LISTIND  DC  X'80'    INDICATE LIST FORM                       @Y30IPLG 41817003
MSTRMEM  DC    H'1'                MASTER MEMORY CONSTANT      @YM3127P 41820002
         SPACE                                                          41830002
PCLEAR   XC    0(K00,RPAR),0(RPAR) CLEAR CORE FOR PIRL                  41850002
HLTRTRY  DC    X'00FF'             TO CHECK FOR                         41870003
         DS    0F                                                       41880003
HIGH2    DC    X'0000FFFF'         TO AND OFF 2 HIGH ORDER BYTES        41890003
RFIX     DC    X'42000000'         TO INDICATE R FORM OF PFIX  @Y30IPLG 41895003
*     VARY STORAGE CAN'T HANDLE SHORT PGFIX SO INDICATE LONG   @ZM34501 41897003
         SPACE                                                          41900002
         DS    0F                                                       42000002
COREMASK DC   AL1(245),AL3(PWALNG) SUBPOOL AND LENGTH FOR GETMAIN       42050002
         SPACE                                                          42052002
*                                  IN MASTER MEM, ASID 1       @YM04942 42065002
         SPACE                                                          42070002
FWORD    DC    F'-1'               NEGATIVE ONE                         42100002
         ORG   FWORD+1                                                  42150002
THREEF   DS    CL3                 3 BYTES OF F'S                       42200002
         ORG   FWORD+3                                                  42250002
ONEF     DS    CL1                 1 BYTE OF F'S                        42300002
*NOTE TESTPST SHOULD BE ON A HALF WORD BOUNDARY ***             PERFORM 42300102
TESTPST  DC    X'0000',AL1(UCBPST),AL1(UCBSPST) POST&SENSE POST PERFORM 42300202
PURGESTA DC    A(PRGESTAE)         ESTAE ENTRY ADDRESS         @YM3104P 42300402
PRGGBLKA DC    A(PRGGBLOK)         ENTRY OF GET SRB/IOSB ROUTINE        42301203
PSRBENQA DC    A(PSRBENQ)          ENTRY TO SRB ENQ ROUTINE    @Y30IPLG 42301603
PGLOCALA DC    A(PGLOCAL2)   ADDR  OF LOCAL LOCK RTN NO PWA    @Y30IPLG 42301803
PRGCOMP  DC    A(PRGCOMP0)         ADDR TO INTERFACE TO SMGR COMPRESS   42301940
UPDTCNTA DC    A(UPDTCNT)          ADDR OF UCBCNT DECREMENT RTN@ZA06654 42302640
         TITLE '    IGC0001F - MAINTENANCE AREA'                        42303340
*****************************************************************       42304002
*                                                               *       42306002
*        PATCH AREA FOR MAINTENANCE                             *       42308002
*                                                               *       42308402
*****************************************************************       42308802
         SPACE                                                          42309202
RCVRYEST EQU   400                 SPACE EST FOR RECOVERY ROUTINES      42309402
*                                  *IN BYTES                            42309502
         DS    0F                                                       42310102
ZAPID    DC    CL8'PURGEZAP'       PATCH AREA IDENTIFICATION            42310202
PURGEZAP DC    (1+(((ZAPID-MAINTAIN)+(RCVRYEST))/220))A(0)              42320040
         SPACE                                                          42341902
PRGEND   EQU   *                   END OF MAINLINE CODE                 42350002
         SPACE 3                                                        42360002
         DROP  R0,RSRB,R4,RCORE,RSVRB,RUCB,RPIRL,RC,RF                  42400002
         TITLE 'IGC0001F - FUNCTIONAL RECOVERY ROUTINE'                 42642002
*****************************************************************       54500002
*                                                               *       54550002
*        FUNCTIONAL RECOVERY ROUTINE                            *       54560002
*                                                               *       54600002
*        ESTABLISH ADDRESSABILITY                               *       54610002
*                                                               *       54620002
*        PERFORM BASIC INITIALIZATION                           *       54630002
*                                                               *       54640002
*****************************************************************       54650002
         SPACE                                                          54700002
PURGEFRR BALR  RCVRY12,R0          ESTABLISH ADDRESSABILITY             54750002
         USING *,RCVRY12                                                54800002
         USING SDWA,RCVRY01                                             54850002
         USING PWA,RCVRY10                                              54900002
         USING PFRRPARM,RCVRY11                                         54950002
         SPACE                                                          55000002
         L     RCVRY04,PSTART      GET ADDRESSABILITY TO START OF       55002002
*                                  *IGC0001F FOR FRR MAINTENANCE        55004002
         L     RCVRY11,SDWAPARM    GET PARAMETER PTR                    55010002
         L     RCVRY10,PFRRPWAP    GET WORK AREA PTR                    55050002
         SPACE                                                          55100002
         SETRP RECORD=YES                                               55150002
         SPACE                                                          55220002
         LM    RCVRY02,RCVRY05,MODCSECT  GET MODULE/CSECT NAME          55250002
         LM    RCVRY06,RCVRY07,RCVRYFRR  GET FRR NAME                   55260002
         STM   RCVRY02,RCVRY07,SDWAVRA   SHOW MODULE/CSECT/FRR NAME     55300002
         SPACE                                                          55302002
         LA    RCVRY09,K24         GET BYTE COUNT                       55304002
         STC   RCVRY09,SDWAURAL    PUT COUNT IN SDWA           @OZ02704 55306003
         SPACE                                                          55310002
         TM    SDWAERRC,SDWAPERC   HAS PERCOLATION OCCURED              55350002
         BO    PRGFRR10            YES, SKIP FURTHER RECORDING          55400002
         SPACE                                                          55450002
         STM   RCVRY02,RCVRY07,SDWAMODN  SHOW MODULE/CSECT/FRR NAME     55500002
         EJECT                                                          55510002
*****************************************************************       55520002
*                                                               *       55530002
*        RELEASE LOCKS                                          *       55540002
*                                                               *       55542002
*****************************************************************       55544002
         SPACE                                                          55546002
PRGFRR10 MVI   SDWAACF3,LOCKS00    CLEAR GLOBAL LOCKS                   55548002
         MVI   SDWAACF4,LOCKS00    CLEAR ADDITIONAL LOCKS               55548402
         SPACE                                                          55548502
         TM    PFRRFLG1,PFRRNOWA    TEST IF PWA EXISTS         @Y30IPLG 55548603
         BNO   PRGFRR15            CONTINUE NORMAL            @Y30IPLG  55548703
         TM    PFRRFLG1,PERLOCAL    TEST IF LOCAL LOCK HELD   @Y30IPLG  55550003
         BNO   PRGFRR90             NO, RETURN TO CALLER       @Y30IPLG 55550803
         OI    SDWAACF4,SDWAFLLK    INDICATE LOCAL LOCK        @Y30IPLG 55551603
         B     PRGFRR90             NO PWA RETRN TO CALLER     @Y30IPLG 55552403
         SPACE                                                          55553203
PRGFRR15 TM    PERRFLG1,PERUCB     IS UCB LOCK HELD                     55553803
         BNO   PRGFRR20            NO, CONTINUE                         55554403
         SPACE                                                          55555203
         OI    SDWAACF4,SDWAIUCB   INDICATE UCB LOCK                    55556403
         L     RCVRY02,PWAUCBLK    GET UCB LOCK ADDR                    55558703
         ST    RCVRY02,SDWAIULW    PLACE IN SDWA                        55559903
         SPACE                                                          55560903
PRGFRR20 TM    PERRFLG1,PERLCH     IS LCH LOCK HELD                     55561903
         BNO   PRGFRR30            NO, CONTINUE                         55563403
         SPACE                                                          55564403
         OI    SDWAACF4,SDWAILCH   INDICATE LCH LOCK                    55565403
         L     RCVRY02,PWALCHLK    GET LCH LOCK ADDR                    55566703
         ST    RCVRY02,SDWAILLW    PLACE IN SDWA                        55567703
         SPACE                                                          55570003
PRGFRR30 TM    PERRFLG1,PERCMS     IS CMS LOCK HELD                     55571003
         BNO   PRGFRR40            NO, CONTINUE                         55572003
         SPACE                                                          55573003
         OI    SDWAACF4,SDWACMS    INDICATE CMS LOCK                    55574003
         SPACE                                                          55575003
PRGFRR40 TM    PFRRFLG1,PERLOCAL   IS LOCAL LOCK HELD          @Y30IPLG 55576003
         BNO   PRGFRR50            NO, CONTINUE                         55577003
         SPACE                                                          55580003
         OI    SDWAACF4,SDWAFLLK   INDICATE LOCAL LOCK                  55581003
         EJECT                                                          55582003
*****************************************************************       55583003
*                                                               *       55584003
*        DETERMINE IF DUMP CAN BE TAKEN                         *       55585003
*                                                               *       55586003
*****************************************************************       55590002
         SPACE                                                          55592002
PRGFRR50 TM    PERRFLG1,PERESTAE   IS ESTAE ACTIVE                      55600002
         BNO   PRGFRR90            NO, GO RETURN TO CALLER              55650002
         SPACE                                                          55700002
         TM    SDWAMCHD,SDWAACR    IS THIS AN ACR ENTRY                 55750002
         BO    PRGFRR90            YES, GO RETURN TO CALLER             55800002
         SPACE                                                          55850002
         USING CVT,RCVRY05                                              55900002
         L     RCVRY05,CVTPTR      GET CVT PTR                          55950002
         L     RCVRY08,CVTSDBF     GET 4K BUFFER ADDR                   56000002
         LA    RCVRY08,0(RCVRY08)  CLEAR HIGH ORDER BYTE                56050002
         L     RCVRY03,LOCKSDBF    SET HIGH ORDER BIT ON                56100002
         OR    RCVRY03,RCVRY08     CREATE LOCKED BUFFER PTR             56150002
         SPACE                                                          56160002
         CS    RCVRY08,RCVRY03,CVTSDBF  ATTEMPT SWAP                    56200002
         BNZ   PRGFRR90            NO, GO RETURN TO CALLER              56250002
         SPACE                                                          56300002
         OI    PERRFLG0,PERSDBF    INDICATE BUFFER HELD                 56350002
         SPACE                                                          56400002
         DROP  RCVRY05                                                  56450002
         EJECT                                                          56500002
*****************************************************************       56550002
*                                                               *       56600002
*        COPY PURGE WORK AREA TO 4K BUFFER                      *       56610002
*                                                               *       56650002
*****************************************************************       56700002
         SPACE                                                          56750002
         USING SDBF,RCVRY08                                             56760002
         SPACE                                                          56770002
         LA    RCVRY02,SDBFSTRT    POINT TO BUFFER START                56780002
         ST    RCVRY02,SDBFPTR     INSERT DUMP START ADDR               56790002
         SPACE                                                          56792002
         MVC   SDBFPWA(PWASAVP-PWA),PWA   COPY 1ST PRT OF WRK  @YM07220 56800002
         MVC   SDBFPWA+(PWASAVP-PWA)(PURENQ-PWASAVP),PWASAVP   @YM07220 56810002
*                                  DONT NEED ENQ LIST          @YM05797 56820002
         SPACE                                                          56850002
         LA    RCVRY02,SDBFVARY    INIT MOVING BUFFER PTR               56900002
         LA    RCVRY09,SDBFVARY-SDBFSTRT  INIT BUFFER COUNT             56950002
         SPACE                                                          56960002
*****************************************************************       56970002
*                                                               *       56980002
*        COPY UCB IF UCB LOCK IS HELD                           *       56982002
*                                                               *       56990002
*****************************************************************       56992002
         SPACE                                                          56994002
         TM    PERRFLG1,PERUCB     IS UCB LOCK HELD                     57000002
         BNO   PRGFRR60            NO SKIP COPY OF UCB                  57050002
         SPACE                                                          57100002
         USING UCB,RCVRY03                                              57102002
         L     RCVRY03,PWAUCBP     GET UCB PREFIX PTR                   57110002
         MVC   0(UCBDEV-UCBPXST,RCVRY02),UCBPXST  COPY UCB              57150002
         DROP  RCVRY03                                                  57200002
         SPACE                                                          57250002
         LA    RCVRY02,UCBDEV-UCBPXST(RCVRY02)  BUMP MOVING PTR         57300002
         LA    RCVRY09,UCBDEV-UCBPXST(RCVRY09)  BUMP COUNT REG          57350002
         EJECT                                                          57400002
*****************************************************************       57400402
*                                                               *       57400802
*        COPY LCH ENTRY AND IOQE'S IF LCH LOCK HELD             *       57400902
*                                                               *       57401202
*****************************************************************       57401602
         SPACE                                                          57401702
PRGFRR60 TM    PERRFLG1,PERLCH     IS LCH LOCK HELD                     57402002
         BNO   PRGFRR80            NO, GO SET BUFFER COUNT              57404002
         SPACE                                                          57406002
         USING LCH,RCVRY03                                              57410002
         L     RCVRY03,PWALCHP     GET LCH PTR                          57450002
         MVC   0(LCHEL,RCVRY02),LCHENTRY  COPY LCH                      57500002
         SPACE                                                          57550002
         LA    RCVRY02,LCHEL(RCVRY02)  BUMP MOVING PTR                  57600002
         LA    RCVRY09,LCHEL(RCVRY09)  BUMP COUNT REG                   57650002
         SPACE                                                          57700002
         L     RCVRY03,LCHFST      GET FIRST IOQE ON LCH                57710002
         SPACE                                                          57712002
         USING IOQ,RCVRY03                                              57720002
PRGFRR70 CH    RCVRY09,SDBFMAX     IS THERE SPACE FOR IOQE              57750002
         BH    PRGFRR80            NO, GO SET BUFFER COUNT              57800002
         SPACE                                                          57850002
         LTR   RCVRY03,RCVRY03     IS THERE AN IOQE                     57860002
         BNP   PRGFRR80            NO, GO SET BUFFER COUNT              57870002
         SPACE                                                          57880002
         MVC   0(IOQL,RCVRY02),IOQLNK  COPY IOQE TO BUFFER              57900002
         SPACE                                                          57910002
         LA    RCVRY02,IOQL(RCVRY02)  BUMP MOVING PTR                   57950002
         LA    RCVRY09,IOQL(RCVRY09)  BUMP COUNT REG                    58000002
         L     RCVRY03,IOQLNK      GET NEXT IOQE PTR                    58050002
         SPACE                                                          58100002
         B     PRGFRR70            GO TEST FOR SPACE                    58150002
         SPACE                                                          58200002
         DROP  RCVRY03                                                  58250002
         EJECT                                                          58300002
*****************************************************************       58310002
*                                                               *       58320002
*        SET 4K BUFFER BYTE COUNT                               *       58322002
*                                                               *       58324002
*        RETURN TO RECOVERY MANAGER                             *       58326002
*                                                               *       58330002
*****************************************************************       58340002
         SPACE                                                          58342002
PRGFRR80 STH   RCVRY09,SDBFCNT     SET BUFFER BYTE COUNT                58350002
         SPACE                                                          58400002
PRGFRR90 BR    RCVRY14             RETURN TO RECOVERY MANAGER           58450002
         SPACE                                                          58460002
         DROP  RCVRY01,RCVRY08,RCVRY10,RCVRY11                          58470002
         EJECT                                                          58480002
*****************************************************************       58490002
*                                                               *       58492002
*        FRR CONSTANTS                                          *       58494002
*                                                               *       58496002
*****************************************************************       58498002
         SPACE                                                          58498402
         DS    0F                                                       58498802
LOCKSDBF DC    X'80000000'         SDWA 4K BUFFER LOCK IND              58499202
         DS    0H                                                       58509302
AVAILBUF EQU   X'FFA'              4090 MAX BUFFER BYTE COUNT           58519702
SDBFMAX  DC    AL2(AVAILBUF-IOQL)  4K BUFFER TEST FOR IOQE'S            58529802
         TITLE 'IGC0001F - ESTAE ROUTINE'                               58539902
*****************************************************************       58550002
*                                                               *       58600002
*        ESTAE RECOVERY ROUTINE                                 *       58610002
*                                                               *       58650002
*        ESTABLISH ADDRESSABILITY                               *       58652002
*                                                               *       58660002
*        PERFORM BASIC INITIALIZATION                           *       58670002
*                                                               *       58680002
*****************************************************************       58700002
         SPACE                                                          58750002
         USING PWA,RCVRY02                                              58752002
         SPACE                                                          58760002
PRGESTAE BALR  RCVRY12,R0          ESTABLISH ADDRESSABILITY             58800002
         USING *,RCVRY12                                                58850002
         SPACE                                                          58900002
         L     RCVRY04,PSTART      GET ADDRESSABILITY TO START OF       58900102
*                                  *IGC0001F FOR ESTAE MAINTENANCE      58900202
         SPACE                                                          58900502
         LA    RCVRY03,K12         GET NO RTCA CODE            @YM01286 58902002
         SPACE                                                          58910002
         CR    RCVRY00,RCVRY03     IS THERE AN RTCA            @YM01286 58950002
         BE    PESTAE10            NO, SKIP RECORDING ATTEMPT           59000002
         SPACE                                                          59050002
         USING SDWA,RCVRY01                                             59100002
         L     RCVRY02,SDWAPARM    GET PURGE WORK AREA PTR              59150002
         SPACE                                                          59152002
         SETRP RECORD=YES                                               59154002
         SPACE                                                          59160002
         LM    RCVRY03,RCVRY08,MODCSECT  GET MODULE/CSECT/ESTAE NAMES   59200002
         STM   RCVRY03,RCVRY08,SDWAVRA   SHOW MODULE/CSECT/ESTAE NAMES  59250002
         SPACE                                                          59260002
         LA    RCVRY09,K24         GET SIZE OF VARIABLE AREA            59270002
         STC   RCVRY09,SDWAURAL    SHOW BYTE COUNT IN SDWA     @OZ02704 59280003
         SPACE                                                          59300002
         TM    SDWAERRC,SDWAPERC   HAS PERCOLATION OCCURED              59350002
         BO    PESTAE10            YES, SKIP FURTHER RECORDING          59400002
         SPACE                                                          59450002
         STM   RCVRY03,RCVRY08,SDWAMODN  SHOW MODULE/CSECT/ESTAE NAMES  59500002
         SPACE                                                          59510002
         DROP  RCVRY01                                                  59520002
         EJECT                                                          60510002
*****************************************************************       60520002
*                                                               *       60530002
*        DECREMENT PURGE COUNT IN IOCOM                         *       60532002
*                                                               *       60540002
*****************************************************************       60542002
         SPACE                                                          60550002
         USING CVT,RCVRY05                                              60560002
         SPACE                                                          60570002
PESTAE10 TM    PERRFLG0,PERPGCT    IS IOCOM PURGE COUNT ACTIVE          60580002
         BNO   PESTAE20            NO, GO TO NEXT TEST                  60590002
         SPACE                                                          60592002
         L     RCVRY05,CVTPTR      GET CVT PTR                          60600002
         L     RCVRY05,CVTIXAVL    GET IOCOM ADDRESS                    60650002
         SPACE                                                          60700002
         USING IOCOM,RCVRY05                                            60750002
PESTAE15 L     RCVRY06,IOCVOICT    GET WORD WITH PURGE COUNT            60800002
         LR    RCVRY07,RCVRY06     COPY PURGE COUNT                     60850002
         BCTR  RCVRY07,R0          DECREMENT PURGE COUNT                60900002
         SPACE                                                          60950002
         CS    RCVRY06,RCVRY07,IOCVOICT   ATTEMPT SWAP                  61000002
         BNE   PESTAE15            LOOP UNTIL SWAP COMPLETES            61050002
         SPACE                                                          61120002
*****************************************************************       61150002
*                                                               *       61160002
*        CLEAR ASCB PURGE COUNT                                 *       61162002
*                                                               *       61170002
*****************************************************************       61180002
         SPACE                                                          61200002
         USING ASCB,RCVRY05                                             61210002
         SPACE                                                          61220002
PESTAE20 TM    PERRFLG0,PERIOSP    IS ASCB PURGE ACTIVE                 61230002
         BNO   PESTAE30            NO, GO TO NEXT TEST                  61240002
         SPACE                                                          61242002
         L     RCVRY05,PWAASCBP    GET ASCB PTR                         61250002
         SPACE                                                          61260002
         SLR   RCVRY06,RCVRY06     CLEAR REG                            61300002
         ST    RCVRY06,ASCBIOSP    ZERO ASCB PURGE ADDR                 61350002
         SPACE                                                          61500002
         DROP  RCVRY05                                                  61550002
         EJECT                                                          61600002
*****************************************************************       61602002
*                                                               *       61604002
*        RESUME SRB DISPATCHING                                 *       61604402
*                                                               *       61606002
*****************************************************************       61608002
         SPACE                                                          61608402
PESTAE30 TM    PERRFLG0,PERSTATS   IS STATUS ACTIVE                     61610002
         BNO   PESTAE40            NO, GO TO NEXT TEST                  61620002
         SPACE                                                          61630002
         STATUS START,SRB          RESUME SRB DISPATCHING               61650002
         SPACE                                                          61800002
*****************************************************************       61802002
*                                                               *       61804002
*        DEQUEUE PURGE RESOURCES                                *       61804402
*                                                               *       61806002
*****************************************************************       61808002
         SPACE                                                          61810002
PESTAE40 TM    PERRFLG0,PERENQ     IS ENQ ACTIVE                        61820002
         BNO   PESTAE50            NO, GO TO NEXT TEST                  61830002
         SPACE                                                          61840002
         MVC   PURENQ(PURENQLN),RCVRYDEQ  MOVE IN PARM LIST    @YM05797 61845002
         DEQ   ,MF=(E,PURENQ)      DEQUEUE PURGE RESOURCES     @YM05797 61850002
         EJECT                                                          62000002
*****************************************************************       62002002
*                                                               *       62004002
*        ISSUE SVC DUMP                                         *       62004102
*                                                               *       62004402
*****************************************************************       62006002
         SPACE                                                          62008002
PESTAE50 TM    PERRFLG0,PERSDBF    IS 4K BUFFER AVAIL                   62008402
         BNO   PESTAE90            NO, GO EXIT                          62008802
         SPACE                                                          62009202
         LM    RCVRY05,RCVRY06,PSTART  GET START/END OF PROGRAM         62010002
         STM   RCVRY05,RCVRY06,PWADLIST  PLACE ADDRESSES IN DUMP LIST   62030002
         OI    PWADLST2,PWADLSTE   IND END OF DUMP LIST                 62030802
         SPACE                                                          62032002
         SDUMP SDATA=(PSA,NUC,SQA,TRT),                                *62050002
               BUFFER=YES,                                             *62150002
               LIST=PWADLIST,                                          *62200002
               MF=(E,PWASDUMP)                                          62250002
         EJECT                                                          62360002
*****************************************************************       62370002
*                                                               *       62380002
*        FREE PURGE WORK AREA                                   *       62382002
*                                                               *       62390002
*        RETURN TO RECOVERY MANAGER                             *       62390102
*                                                               *       62390402
*****************************************************************       62392002
         SPACE                                                          62400002
PESTAE90 LR    RCVRY03,RCVRY02     SAVE PWA PTR                @Y30IPLG 62405003
         TM    PERRFLG0,PERFIXA    IS PAGE FIX OUTSTANDING     @Y30IPLG 62410003
         BNO   PESTAE95            GO FREE WORK AREA           @Y30IPLG 62420003
         SPACE                                                          62430003
         LM    RCVRY01,RCVRY02,PWAFIX3  LOAD FIX PTRS          @Y30IPLG 62440003
         PGFREE R,A=(1),EA=(2)     PAGE FREE PURGE             @Y30IPLG 62450003
         SPACE                                                          62460003
PESTAE95 LR    RCVRY01,RCVRY03     GET PWA PTR                 @Y30IPLG 62550003
         L     RCVRY00,RCVRY245    GET SUBPOOL AND LENGTH               62600002
         SPACE                                                          62650002
         FREEMAIN R,LV=(0),A=(1)                                        62700002
         SPACE                                                          62750002
         BR    RCVRY14             RETURN TO RECOVERY MANAGER           62800002
         SPACE                                                          62850002
         DROP  RCVRY02                                                  62852002
         EJECT                                                          62852402
*****************************************************************       62852802
*                                                               *       62853202
*        ESTAE CONSTANTS                                        *       62853602
*                                                               *       62853702
*****************************************************************       62853802
         SPACE                                                          62853902
         DS    0F                                                       62854302
RCVRY245 DC    AL1(245),AL3(PWALNG)  SUBPOOL AND LENGTH OF WORK AREA    62855602
RCVRYDEQ ENQ   (RCVRYSYS,RCVRYPRG,E,5,STEP),RET=HAVE,MF=L      @YM3104P 62857602
RCVRYSYS DC    C'SYSZEC16'         RESOURCE NAME                        62858002
RCVRYPRG DC    C'PURGE'            RESOURCE NAME                        62858102
PSTART   DC    A(IGC016)           PROGRAM STARTING ADDRESS             62858202
PEND     DC    A(PURGEEND)         PROGRAM ENDING ADDRESS               62858302
         TITLE 'IGC0001F - OBTAIN SRB/IOSB AND FORMAT'                  62858403
***************************************************************         62861503
*                                                             *         62861803
*        OBTAIN SRB/IOSB AND FORMAT SUBROUTINE                *         62862103
*                                                             *         62862403
*        OBTAIN AND FORMAT AN SRB/IOSB COMBINATION TO         *         62862703
*        REPLACE A REQUESTOR SRB/IOSB FOUND ON A UCB OR       *         62863203
*        A LCH. THE PURPOSE OF THE SWAP IS TO FORCE IOS       *         62863403
*        TO COMPLETE A SENSE OPERATION OR A RELEASE.          *         62863603
*                                                             *         62863803
*        INPUT REGISTERS  -                                   *         62864003
*              RIOSB - IOSB TO BE SWAPPED                     *         62864203
*              RPAR- SRB TO BE SWAPPED                        *         62864903
*              RET _ RETURN ADDRESS                           *         62865203
*                                                             *         62865503
*        OUTPUT REGISTERS  -                                  *         62865803
*              RB  - NEW SRB                                  *         62866103
*              RC  - NEW IOSB                                 *         62866603
*                                                             *         62866803
***************************************************************         62867003
         SPACE                                                          62867203
         USING IOCOM,RC                                                 62867403
         USING CVTMAP,RF                                                62867603
         SPACE                                                          62868303
         USING PWA,RCORE                                                62868503
PRGGBLOK STM   RD,RET,PWREGD       SAVE REGS R13-R14                    62868703
         ST    RBASE,PWREGF        SAVE MAINLINE BASE                   62868903
         BALR  RBASE,0             SET BASE FOR THIS SUBROUTINE         62869103
         USING *,RBASE                                                  62869303
         LA    RD,PWREGSAV         GET SAVEAREA ADDR           @YM01499 62869503
         SPACE                                                          62869703
         L     RF,CVTPTR           GET CVT PTR                          62870003
         L     RC,CVTIXAVL         IOS COMMUNICATIONS AREA              62870303
         L     RF,IOCORMGT         ADDRESS OF IOS STORAGE NGR           62870603
         L     RB,COREMSK          INDICATE ONE 160 BYTE BLOCK          62870903
         SPACE                                                          62871203
         BALR  RET,RF              CALL IOS STORAGE MANAGER             62871503
         SPACE                                                          62871803
         USING SIAB,RB                                                  62872103
         XC    SIAB(SIABEL),SIAB   ZERO ALL 160 BYTES                   62872403
         LA    RC,SIABIOSB         GET IOSB ADDR                        62872703
         DROP  RB                                                       62873003
         SPACE                                                          62873303
         ST    RC,SRBPARM-SRB(RB)  SET NEW IOSB PTR IN SRB              62873603
         ST    RB,IOSSRB-IOSB(,RC) SET NEW SRB PTR IN IOSB              62873903
         SPACE                                                          62874203
         LA    RF,MSASID           MASTER SCHEDULER ASID                62874503
         STH   RF,IOSASID-IOSB(,RC) STORE ASID INIOSB                   62874803
         SPACE                                                          62875103
         OI    IOSFLA-IOSB(RC),IOSIOSB SHOW IOS IOSB                    62875403
         OI    IOSOPT-IOSB(RC),IOSPSLL NO LOCAL LOCK WANTED             62875703
         EJECT                                                          62876003
         L     RF,IOSUCB-IOSB(,RIOSB) SET UCB IN NEW IOSB EQUAL         62876303
         ST    RF,IOSUCB-IOSB(,RC) * TO UCB IN OLD IOSB                 62876603
         MVI   IOSPROC-IOSB(RC),IOSAPURG  INDICATE IOSB FROM   @YM04932 62876903
*                                  PURGE                                62877203
         SPACE                                                          62877503
         MVC   IOSEEKA-IOSB(L'IOSEEKA,RC),IOSEEKA-IOSB(RIOSB)           62877803
*                                  COPY USERS SEEK ARGUMENT             62878103
         LA    RF,IOSPCI-IOSB(RC)  USE IOSPCI AS A CCW                  62880003
         ST    RF,IOSVST-IOSB(RC)  VIRTUAL ADDRESS OF CCW               62880503
         SPACE                                                          62881003
         MVI   ZERO(RF),NOP        SET NOP OP CODE                      62881503
         MVI   FOUR(RF),SILI       SUPPRESS WRONG LENGTH                62882003
         MVI   SEVEN(RF),ONE       DATA COUNT EQUAL ONE                 62882503
         LRA   RET,ZERO(RF)        REAL ADDRESS OF CCW                  62883003
         ST    RET,IOSRST-IOSB(,RC) STORE IN IOBRST                     62883503
         SPACE                                                          62884003
         LM    RD,RET,PWREGD                                            62884503
         L     RBASE,PWREGF                                             62885003
         SPACE                                                          62885503
         BR    RET                 RETURN TO CALLER                     62886003
         SPACE                                                          62886503
         DS    0F                                                       62887003
COREMSK  DC   X'10000120'          MASK TO INDICATE 1 160 BYTE BLOCK    62887503
         TITLE 'IGC0001F - SRB ENQUEUE SUBROUTINE'                      62887703
***************************************************************         62888003
*                                                             *         62894003
*        SRB ENQUEUE ROUTINE                                  *         62896003
*                                                             *         62896503
*        THIS SUBROUTINE ACCEPTS AN SRB ADDRESS               *         62897003
*        IN REGISTER ONE DETERMINES THE PROPER ENTRY IN       *         62897503
*        THE PIRL AND ENQUEUES THE SRB ON THE PIRL IN A       *         62898003
*        PUSH DOWN ORDER.                                     *         62898203
*                                                             *         62898403
***************************************************************         62898603
         SPACE                                                          62898803
         USING PSA,R0                                          @Y30IPLG 62899203
         USING CVTMAP,RF                                       @Y30IPLG 62900003
         USING IOCOM,RC                                        @Y30IPLG 62900403
         USING PWA,RCORE                                       @Y30IPLG 62900803
         USING PIRL,RPIRL                                      @Y30IPLG 62901203
         USING IOSB,RIOSB                                      @Y30IPLG 62901603
         USING SRB,RSRB                                        @Y30IPLG 62902003
         USING UCB,RUCB                                        @Y30IPLG 62902803
         DROP  RBASE                                           @Y30IPLG 62903603
         USING *,RBASE                                         @Y30IPLG 62904403
         SPACE                                                          62905203
PSRBENQ  ST    RBASE,PWRTEMP1      SAVE MAIN LINE BASE         @Y30IPLG 62906003
         LR    RBASE,RF            LOAD BASE FOR THIS SUB      @Y30IPLG 62906803
PSRBE001 L     RIOSB,SRBPARM       GET PTR TO IOSB             @YM04934 62907203
         SPACE                                                          62907603
         CLI   IOSPROC,IOSAPCI     IS THIS A PCI SRB-IOSB?     @YM04946 62908403
         BE    PSRBEN01            YES, THEN SRB-IOSBS BELONG TO        62910003
*                                  IOS                                  62910803
*                                  NO - NORMAL SRB-IOSB                 62911603
         LA    RD,PIRRSTR          POINT TO FIRST ENTRY                 62912403
         SLR   RF,RF               CLEAR WORK REG                       62913203
         IC    RF,IOSDVRID         GET DRIVER ID                        62914003
         SLL   RF,3                MULT BY 8                            62914803
         ALR   RF,RD               RF NOW POINTS TO DRIVERS PIRL ENTRY  62915603
         SPACE                                                          62916403
         MVC   SRBFLNK,0(RF)       MOVE CURRENT ENTRY TO SRB LINK       62917203
         SPACE                                                          62918003
         ST    RPAR,0(,RF)         STORE SRB ADDRESS IN CURRENT ENTRY   62918803
         SPACE                                                          62919603
         L     RBASE,PWRTEMP1      RELOAD MAIN BASE            @Y30IPLG 62920403
         BR    RET                 RETURN TO CALLER                     62921203
PSRBEN01 LR    RD,RIOSB            RD PTS TO 1ST IOSB                   62922003
PSRBEN02 L     RF,IOSIPIB-IOSB(RD)  TO CHECK FOR PCI IOSB               62922803
         LA    RF,0(RF)            CLEAR HIGH ORDER BYTE                62923603
         LTR   RF,RF               IS IT THE LAST                       62924403
         BZ    PSRBEN03            YES, GO TO CORMGT                    62925203
         C     RF,IOSPCHN-IOSB(RD)  IS IT THE LAST PCI IOSB             62926003
         BE    PSRBEN03            YES, GO TO CORMGT                    62926803
         LR    RD,RF               NO, RD POINT TO NEXT IOSB            62927603
         L     RF,IOSSRB-IOSB(RD)  RF, HAS SRB FROM NEXT IOSB           62928403
         ST    RF,0(RPAR)          LINK SRBS FOR CORMGT                 62929203
         LR    RPAR,RF             RPAR PTS TO NEXT SRB                 62930003
         B     PSRBEN02            GET NEXT SRB-IOSB                    62930803
PSRBEN03 SLR   RB,RB               CLEAR WRK REG, NORMAL PATH           62931603
         ST    RB,0(RPAR)          ZERO LAST LINK PTR FOR CORMGT        62932403
         L     RPAR,IOSSRB-IOSB(RIOSB)  1ST SRB                         62933203
         LR    RIOSB,RF            CHECK FOR AN ENDING STATUS SRB-IOSB  62934003
         LA    RB,FREE160          X'00000020' INDICATE 160 BYTE        62934803
         L     RF,CVTPTR           GET CVTPTR                           62935603
         L     RF,CVTIXAVL-CVTMAP(,RF)  GET IOCOM ADDR                  62936403
         L     RF,IOCORMGT-IOCOM(,RF)   GET ENTRY TO IOS CORE MGR       62937203
         LA    RD,PWREGSAV         GET SA                               62938003
         ST    RET,PWREGE          SAVE RETURN ADDR                     62938803
         BAL   RET,K04(,RF)        BRANCH TO CORMGT 160 BYTE FREE       62939603
         L     RET,PWREGE          RELOAD RET                           62940403
         LTR   RIOSB,RIOSB         IS THERE AN ENDING STATUS            62941203
         SPACE                                                          62942003
         L     RBASE,PWRTEMP1      RELOAD MAIN BASE            @Y30IPLG 62942803
         BZR   RET                 RETURN TO CALLER                     62943603
         L     RPAR,IOSSRB-IOSB(,RIOSB)  PUT SRB ADDR IN RPAR           62944403
         B     PSRBE001            LOOP FOR ENDING STATUS      @Y30IPLG 62945203
        TITLE 'GET LOCAL LOC AND FRR, NO PWA'                           62945303
*************************************************************           62945403
*                                                           *           62945503
*         GET LOCAL LOCK & FRR 2ND                          *           62945603
*                                                           *           62946003
*************************************************************           62951003
         SPACE                                                          62956003
         USING *,R10                                                    62956403
PGLOCAL2 EQU   *             NOTE R10-R15 LOST HERE            @Y30IPLG 62956803
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                @Y30IPLG*62957203
               RELATED=(LOCAL,IGC016(PFLOC010))                         62957603
         L     RB,PRGFRRA           GET ADDR OF FRR            @Y30IPLG 62958003
         SETFRR A,FRRAD=(11),PARMAD=(12),WRKREGS=(13,14)                62958403
         DROP  RC                                                       62958803
         USING PFRRPARM,RC                                              62959203
         MVI  PFRRFLG1,PFRRNOWA   INDICATE TO FRR MAY BE NO WA @Y30IPLG 62959603
         OI   PFRRFLG1,PERLOCAL     INDICATE LOCAL LOCK HELD   @Y30IPLG 62960003
         BR   RF        RETURN TO CALLER                       @Y30IPLG 62960403
         EJECT                                                          62960540
         TITLE 'IECVSMGR COMPRESS INTERFACE'                            62960640
******************************************************                  62960740
*        TEST  IF COMPRESS SHOULD BE DONE                               62960840
*        IF SO, SCHEDULE IECSCOMP IN IECVSMGR                           62960940
******************************************************                  62961040
         SPACE                                                          62961140
         USING PSA,R0                                                   62961240
         USING CVTMAP,RF                                                62961340
         USING IOCOM,RC                                                 62961440
         USING PWA,RCORE                                                62961540
         USING SRB,RSRB                                                 62961840
         USING *,RBASE                                                  62961940
         SPACE                                                          62962040
PRGCOMP0 ST    RET,PWRET1          SAVE RETURN ADDR                     62962140
         ST    RBASE,PWRTEMP1      SAVE MAIN LINE BASE                  62962240
         LR    RBASE,RF            LOAD BASE FOR THIS SUBROUTINE        62962340
         TM    PPLOPT1,PPLHIO      IS IT A HALT                         62962440
         BO    PRGCOMP9            ONLY CHECK ON QUISCE                 62962540
         SPACE                                                          62962740
         L     RF,CVTPTR           GET CVT PTR                          62962840
         L     RC,CVTIXAVL         GET IOCOM PTR                        62962940
         L     RB,IOCHD160         GET PTR TO 160 FREE QUE              62963040
         LH    RPAR,K02(,RB)       GET FREE COUNT                       62963140
         CH    RPAR,COMPMIN        SEE IF MIN NO. OF BLOCKS             62963240
         BL    PRGCOMP9            RETURN TO MAIN LINE                  62963340
         SLL   RPAR,31             TO CHECK FOR ODD OR EVEN             62963440
         LTR   RPAR,RPAR           IF ODD, TRY COMPRESS                 62963540
         BZ    PRGCOMP9            EVEN, NOT THIS TIME (TO CUT DOWN)    62963640
         SPACE                                                          62963740
*                                                                       62963840
         STM   RB,RF,PWREGB        SAVE LOCK REGS                       62963940
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        *62964040
               RELATED=(LOCAL,IGC016(PRGCOMP0))                         62964140
         L     RB,PRGFRRA          GET ADDR OF PURGE FRR                62964240
         SETFRR A,FRRAD=(11),PARMAD=(12),WRKREGS=(13,14)                62964340
         DROP  RC                                                       62964440
         USING PFRRPARM,RC                                              62964540
         OI    PFRRFLG1,PERLOCAL   INDICATE LOCAL LOCK HELD             62964640
         DROP  RC                                                       62964740
         USING IOCOM,RC                                                 62964840
*  CALL  IECVSMGR TO GET A 160 BYTE BLOCK TO SCHEDULE IECVSCOM          62964940
         SPACE                                                          62965040
         LM    RB,RF,PWREGB        RELOAD REGS                          62965140
         L     RF,IOCORMGT         GET ENTRY TO GET 160 (IOS SMGR)      62965240
         L     RB,COREMSK2         INDICATE ONE 160 BYTE BLOCK          62965340
         LA    RD,PWREGSAV         GET SAVEAREA ADDR                    62965440
         BALR  RET,RF              CALL IECVSMGR                        62965540
         SPACE                                                          62965940
         STM   RB,RET,PWREGB       SAVE RB-14                           62966340
         SETFRR D,WRKREGS=(13,14)                                       62966740
         SPACE                                                          62967140
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGC016(PRGCOM9))     62967540
         LM    RB,RET,PWREGB                                            62967940
         USING SIAB,RB                                                  62968340
         XC    SIAB(SIABEL),SIAB   ZERO 160 BYTES                       62968740
         LR    RSRB,RB             PUT SRB PTR IN REG1                  62969140
         LA    RB,K01              INDICATE MASTER ASID                 62969540
         STH   RB,SRBPASID         TO ASSOCIATE SRB                     62969940
         SLL   RB,K02              GET OFFSET IN ASVT                   62970340
         L     RF,CVTPTR           GET CVT PTR                          62970740
         L     RD,CVTASVT          GET ASCB VECTOR TABLE                62971140
         USING ASVT,RD                                                  62971540
         L     RB,ASVTFRST(RB)     GET ASCB FOR THIS ASID               62971940
         ST    RB,SRBASCB          PLACE IN SRB                         62972340
         L     RB,IOCSCOMP         GET ADDR IECVSCOM                    62972740
         ST    RB,SRBEP            PUT ADDR OF COMPRESS IN SRB          62973140
         SCHEDULE SRB=(1),SCOPE=GLOBAL  SCHED COMPRESS                  62973540
         SPACE                                                          62973940
PRGCOMP9 L     RET,PWRET1          RELOAD RETURN ADDR                   62974340
         L     RBASE,PWRTEMP1      RELOAD BASE                          62974740
         BR    RET                 RETURN TO MAIN LINE                  62975140
COMPMIN  DC    AL2(97)        4 PAGE+1 MIN NUM OF FREE BLKS TO SCH      62975540
*                                  STORAGEMANAGER COMPRESS              62975940
         DS    0F                                                       62976040
COREMSK2 DC    X'10000120'         INDICATE GET 1 160 BYTE BLOCK        62976140
         SPACE                                                          62976340
PRGFRRA  DC   A(PURGEFRR)           ADDR OF PURGE FRR RTN      @Y30IPLG 62978440
        EJECT                                                           62978840
         TITLE 'DECREMENT UCBCNT FIELD'                        @OZ06654 62979040
***************************************************************@OZ06654 62979240
*        DECREMENT UCBCNT FIELD SUBROUTINE                    *@OZ06654 62979440
*                                                             *@OZ06654 62979640
*        IF A MULTIPLE EXPOSURE UCB THE COUNT IN THE BASE UCB *@OZ06654 62979840
*        MUST BE DECREMENTED                                  *@OZ06654 62980040
*                                                             *@OZ06654 62980240
*        INPUT REGISTERS -                                    *@OZ06654 62980440
*              RUCB - UCB ADDRESS                             *@OZ06654 62980640
*              RET  - RETURN ADDRESS                          *@OZ06654 62980840
*                                                             *@OZ06654 62981040
*        OUTPUT REGISTERS -                                   *@OZ06654 62981240
*              NONE                                           *@OZ06654 62981440
*                                                             *@OZ06654 62981640
***************************************************************@OZ06654 62981840
         USING UCB,RUCB                                        @OZ06654 62982040
         USING *,RF                ESTABLISH BASE              @OZ06654 62982240
         USING PWA,RCORE                                       @OZ06654 62982440
UPDTCNT  ST    RD,PWREGD           SAVE REG 13                 @OZ06654 62982640
         ST    RET,PWREGE          SAVE REG 14                 @OZ06654 62982840
         LR    RD,RUCB             GET UCB ADDRESS             @OZ06654 62983040
         TM    UCBWGT,UCBMTPXP     IS IT MULT EXP              @OZ06654 62983240
         BZ    NORMUP              NO- GO DECREMENT COUNT      @OZ06654 62983440
         L     RD,UCBBASE          YES- GET ADDR OF BASE UCB   @OZ06654 62983640
NORMUP   IC    RET,UCBCNT-UCB(RD)  PICK UP COUNT               @OZ06654 62983840
         BCTR  RET,0               DECREMENT BY 1              @OZ06654 62984040
         STC   RET,UCBCNT-UCB(RD)  PUT NEW COUNT IN UCB        @OZ06654 62984240
         L     RD,PWREGD           RESTORE REG 13              @OZ06654 62984440
         L     RET,PWREGE          RESTORE REG 14              @OZ06654 62984640
         BR    RET                 RETURN                     @OZ06654  62984840
*****************************************************************       62985440
*                                                               *       62985640
*        MODULE IDENTIFICATION CONSTANTS                        *       62985840
*                                                               *       62986003
*****************************************************************       62992003
         SPACE                                                          63000003
         LCLC  &ADATE                                                   63007003
&ADATE   SETC  '&SYSDATE'          SET DATE                             63014003
         SPACE                                                          63021003
         DS    0F                                                       63028003
MODCSECT DC    CL8'IGC0001F'       MODULE NAME                          63035003
         DC    CL8'IGC016'         CSECT NAME                           63042003
RCVESTAE DC    CL8'PRGESTAE'       ESTAE NAME                           63050002
RCVRYFRR DC    CL8'PURGEFRR'       FRR NAME                             63100002
ASSMDATE DC    CL8'&ADATE'         ASSEMBLY DATE                        63150002
         SPACE                                                          63550002
PURGEEND DS    0F                  END OF PURGE PROGRAM                 63600002
         SPACE                                                          63650002
         END                                                            63700002
