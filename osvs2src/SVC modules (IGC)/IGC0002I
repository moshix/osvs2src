 TITLE 'IGC0002I - DADSM SCRATCH - ENTRY POINT'                         00020000
IGC0002I CSECT                                                   A53147 00023002
*                                                                       00026020
*          VS1 RELEASE 02 DELETIONS                                     00028402
*0000                                                           OX00362 00028802
*          RELEASE 18 DELETIONS                                         00029020
*1652026800                                                       21421 00032018
*1652                                                             MCS   00035018
*          RELEASE 19 DELETIONS                                         00038018
*          RELEASE 20 DELETIONS                                         00044018
*0953020200,055200,064200                                        S20201 00045020
*0953025400,026200,026400,060800,061700-062000                   A33080 00047020
*0953                                                            M0688  00048020
*0953000100,000260,002400-003800,004400,005400-005600,008400-    M1889  00048620
*0953008800,013400-015000,026430-026600,072800,074400            M1889  00049220
*          RELEASE 21 DELETIONS                                         00050018
*1198004400-004600,014100,015800,086000-086600                   A37199 00051021
*1198                                                            A42478 00053021
*0000023200                                                     SA49351 00055021
*          RELEASE 21.7 DELETIONS                                       00055102
*0000000230,001600,020062,020068-020086,020092,020400-020600,    A53147 00055202
*0000040000,054800-055050,055080-055190,055500,063600-064120,    A53147 00055302
*0000066900,067200-069200,071600-074320                          A53147 00055402
*0000021800-021900,026010,026210,026350,028800-029400,029420,   SA56369 00055502
*0000021800-021900,026010,026210,026350,028800-029400,029420,   SA56369 00055602
*0000029550-029700,030000-030600,031400-031905,031920,031930,   SA56369 00055702
*0000031945,031960-031975,060500,063200,074440,081800-083000,   SA56369 00055802
*0000085600-085800,087400-087800                                SA56369 00055902
*0000021000,026020-026350,056000                                SA57158 00056002
*0000061100                                                     SA57621 00056102
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00062002
*0000000280,000289,000620-000800,001000,001400-001600,004800-    Y02080 00062102
*0000005000,006200-006400,006800-007000,008400-008600,013200-    Y02080 00062202
*0000013500,014100-014400,015400,019100,020050-020051,020078-    Y02080 00062302
*0000020085,020092,020150-020216,021200,021980-022120,022160-    Y02080 00062402
*0000023200,023600-023800,025100-025200,025600-025800,026208-    Y02080 00062502
*0000026220,026227-026276,026282-026284,026290-026292,026294-    Y02080 00062602
*0000026590,026653,026716,028670-028830,029500-029550,031910-    Y02080 00062702
*0000031955,031985,032400,032800,047000-054600,055060,055200-    Y02080 00062802
*0000055600,055800,056200,057410-057510,060400,060520-060580,    Y02080 00062902
*0000062300,063900,064250-065400,066033-066066,066200-066800,    Y02080 00063002
*0000070400,071500-088200                                        Y02080 00063102
*0000000030-000150                                               Y02078 00063202
*0000001600-003400,005200-007800,008200-009800,012900-013700,    Y02082 00063302
*0000014100-015600,020053-020100,021940,026240,026370-026390,    Y02082 00063402
*0000026603-028660,028870,030000-030200,032000,032600-060200,    Y02082 00063502
*0000063400-064200                                               Y02082 00063602
*0000                                                            Y02144 00063802
*0000027170,067000-067200                                        Y02132 00064002
*0000026390                                                      YM1312 00064102
*0000                                                            YM1241 00064202
*0000033700,034300,036820-036825,036840,036850,064990-065000     YM1337 00064302
*0000026730-026770,026870-026930,028170,038900,068100-068200,    YM1063 00064402
*0000071800-072000                                               YM1063 00064502
*0000035300                                                      YM3960 00064602
*0000025300-025500                                               YM5399 00065002
*0000024120-024140                                               YM5748 00065402
*0000028900,029020,039400,040800                                 YM7036 00065502
*0000034300,035300,036770,067900                                 YM2880 00066702
*0000                                                            YM2887 00066802
*0000                                                            YM6992 00066902
*0000065280                                                      YM7831 00067002
*                                                                       00080002
*0000    EXTENDED MVS CVOL SUPPORT                             @Z40CSRC 00080537
*                                                                       00081002
*        SU60 ADDITIONS/DELETIONS                              @G60ASBJ 00081260
*A 020116,021700,023200,023280-123340                          @G60ASBJ 00081460
*C 000842,001400,004400,023240                                 @G60ASBJ 00081660
*D 004600                                                      @G60ASBJ 00082060
*                                                              @G60ASBJ 00082460
*MODULE NAME - IGC0002I                                                 00082860
*                                                                       00083260
*DESCRIPTIVE NAME - DADSM SCRATCH                              @G60ASBJ 00083660
*                                                                       00085002
*COPYRIGHT - NONE                                                       00086002
*                                                                       00087002
*CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD           00088002
*                                                                       00089002
*STATUS CHANGE LEVEL 007                                                00090021
*                                                                       00092002
*ATTRIBUTES - REENTRANT                                                 00100002
*                                                                       00120000
*FUNCTION - THIS MODULE IS THE  BEGINNING  OF  SCRATCH. IT FIRST        00140060
*          OBTAINS THE SCRATCH WORK AREA.  THEN IT ISSUES AN ENQ        00144002
*          ON THE TIOT (UNLESS THE TIOT WAS ALREADY ENQ'ED UPON BY      00148002
*          DYNAMIC DELLOCATION).  IF THIS RESOURCE IS UNAVAILABLE,      00152002
*          THE DATA SET IS IN THE PROCESS OF BEING OPENED OR CLOSED     00156002
*          AND THEREFORE CANNOT BE SCRATCHED.                           00160002
*          THIS MODULE THEN ATTEMPTS TO FIND A PRIMARY (DEMOUNTABLE)    00164002
*          UCB ADDRESS.  IF A UCB ADDRESS WAS SUPPLIED BY THE CALLER,   00168002
*          THE TIOT IS SEARCHED TO SEE IF THE UNIT IS ALLOCATED TO      00172002
*          THE JOB.  IF ALLOCATED, THE UNIT IS TESTED TO DETERMINE      00176002
*          IF ITS ASSOCIATED VOLUME CAN BE DEMOUNTED.  IF NO UCB        00180002
*          ADDRESS WAS SUPPLIED OR IF THE SUPPLIED ADDRESS IS EITHER    00184002
*          NOT ALLOCATED OR NOT DEMOUNTABLE, THE TIOT IS SEARCHED TO    00188002
*          SEE IF ANY VOLUME IN THE VOLUME LIST IS MOUNTED ON A UNIT    00192002
*          ALLOCATED TO THE JOB.  IF A VOLUME IS MOUNTED, ITS UCB IS    00196002
*          TESTED FOR DEMOUNTABILITY.  IF A UCB IS FOUND THAT IS BOTH   00200002
*          ALLOCATED AND DEMOUNTABLE, IT BECOMES THE PRIMARY UCB.       00204002
*          BEFORE BRANCHING TO THE NEXT LOAD OF SCRATCH, THIS MODULE    00208002
*          ISSUES AN ENQ ON THE DATA SET NAME.  IF THE RETURN CODE      00212002
*          INDICATES THAT THE TASK PREVIOUSLY HAD CONTROL OF THE        00216002
*          RESOURCE, THE ENQ IS REISSUED TO OBTAIN EXCLUSIVE CONTROL    00220002
*          AND A BIT IS SET TO INDICATE A DEB SEARCH MUST BE DONE       00224002
*          IN MODULE IGG0290A TO ENSURE NO ONE IS CURRENTLY OPEN TO     00228002
*          THE DATA SET.  IF THE RETURN CODE FROM EITHER ENQ INDICATES  00232002
*          THAT THE RESOURCE IS UNAVAILABLE, THE DATA SET IS OPEN AND   00236002
*          THEREFORE CANNOT BE SCRATCHED.                               00240002
*          FOR A POSSIBLE VIO DATA SET, THE MODULE SEARCHES THE DSAB    00250002
*          CHAIN FOR A TIOT ENTRY CONTAINING A VIRTUAL UCB WHOSE        00260002
*          VDSDSCB CONTAINS THE DATA SET NAME BEING SCRATCHED AND       00270002
*          WHOSE VOLUME SERIAL NUMBER IN THE VDSUCB MATCHES THE FIRST   00280002
*          VOLUME SERIAL IN THE VOLUME LIST.  IF A DSNAME/VOL SER       00290002
*          MATCH IS FOUND, IT ISSUES VSCRATCH (IF THE DATA SET HAD      00300002
*          BEEN OPENED) AND ZEROS THE DATA PORTION OF THE VDSDSCB.      00310002
*                                                                       00400000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGC0002I. ENTRY IS    00420000
*          MADE FROM IGG029DU.                                @G60ASBJ  00440060
*                                                                       00480002
*SUPERVISOR CALLS AND EXTERNAL ROUTINES USED BY THIS MODULE -           00500002
*          ENQ(56)  - ENQ'S ON SYSZTIOT AND SYSDSN                      00520002
*          TESTAUTH - DETERMINES IF THE CALLER IS AUTHORIZED,           00540002
*                     IN SUPERVISOR STATE, OR IN KEY ZERO               00560002
*          SETLOCK  - OBTAINS/RELEASES THE LOCAL MEMORY LOCK            00580002
*          MODESET  - SWITCHES TO THE CALLER'S KEY                      00600002
*          IEC0VL00 - CHECKS THE VALIDITY OF THE VOLUME LIST ADDRESS    00620002
*          VSCRATCH - DELETES VBP CONTROL BLOCKS, FREES PAGING SPACE    00630002
*          IECRES   - OBTAINS THE WORK AREA                             00640002
*                   - BRANCHES TO OTHER SCRATCH MODULES                 00660002
*                                                                       00680002
*OTHER MACROS ISSUED -                                                  00700002
*          IDDVDSCB - EXPANDS THE VDSCB                                 00710002
*          IECDSECS - EXPANDS THE CVT, DSAB, JSCB, PSA, QDB, RB,        00720002
*                     RRPL, TIOT, TCB, AND UCB DSECTS                   00740002
*          IECSCRWA - EXPANDS THE SCRATCH WORK AREA                     00760002
*          XCTLTABL - BUILDS A LIST OF MODULE NAMES AND ADDRESSES       00780002
*                                                                       00800000
*INPUT -   AT ENTRY TO THIS MODULE REGISTER 1 POINTS TO THE PARAMETER   00820002
*          LIST.  REGISTER 0 MAY POINT TO A UCB, OR IT MAY CONTAIN NO   00840002
*          ADDRESS. THE PARAMETER LIST CONSISTS OF 4 WORDS:             00860002
*          WORD 1 - CHECK PURGE DATE = X'41004000'                      00870002
*                 - OVERRIDE PURGE DATE = X'41005000'                   00874002
*                   BIT 0 OF THE 2ND OPTION BYTE IS SET BY DYNAMIC      00878002
*                   UNALLOCATION AND BY JOB AND STEP TERMINATION        00882002
*                   TO INDICATE NOT TO INVOKE DYNAMIC ALLOCATION.       00886002
*                   BIT 0 OF THE THIRD OPTION BYTE IS SET BY            00890002
*                   DYNAMIC UNALLOCATION TO INDICATE THAT THE           00894002
*                   TIOT HAS ALREADY BEEN ENQ'ED.                       00898002
*          WORD 2 - ADDRESS OF THE DATA SET NAME                        00910002
*                   IF BIT 0 IS SET, ENTRY IS FROM JOB TERMINATION      00920002
*                   OR FROM STEP TERMINATION.  IF BIT 1 IS SET, ENTRY   00930002
*                   IS FROM THE READER OR WRITER.                       00940002
*          WORD 3 - NOT USED                                            00950002
*          WORD 4 - ADDRESS OF THE VOLUME LIST                          00960002
*          THE VOLUME LIST IS VARIABLE IN LENGTH. THE FIRST TWO BYTES   01000000
*          INDICATE THE NUMBER OF 12 BYTE VOLUME ID FIELDS WHICH        01020000
*          FOLLOW. A 12 BYTE VOLUME ID FIELD CONTAINS A FOUR BYTE       01040000
*          DEVICE CODE, SIX BYTE VOLUME SERIAL NUMBER, ONE BYTE SPARE,  01060000
*          AND ONE BYTE USED FOR RETURNING THE STATUS OF THE DATA SET   01080000
*          ON THAT VOLUME AS FOLLOWS:                                   01100000
*                    BINARY 0 - SUCCESSFUL SCRATCH                      01120000
*                    BINARY 1 - DSCB NOT FOUND IN VTOC                  01140000
*                    BINARY 2 - PASSWORD DIFFICULITY                    01160000
*                    BINARY 3 - UNEXPIRED PURGE DATE                    01180000
*                    BINARY 4 - PERMANENT I/O ERROR                     01200000
*                    BINARY 5 - APPROPRIATE UCB UNAVAILABLE             01220000
*                    BINARY 6 - OPERATOR UNABLE TO MOUNT VOLUME         01240000
*                    BINARY 7 - DATA SET IS OPEN                        01250002
*                                                                       01260000
*OUTPUT -  WHEN CONTROL IS TRANSFERED TO THE NEXT MODULE, REGISTER 13   01290002
*          POINTS TO THE WORK AREA, WHICH CONTAINS THE ADDRESS OF A     01320002
*          PRIMARY UCB IN 'PRUCBPTR' (IF ONE IS AVAILABLE).  ALSO,      01330002
*          'VOLNUM' CONTAINS THE NUMBER OF VOLUMES IN THE VOLUME        01340002
*          LIST, AND 'VOLPTR' CONTAINS THE ADDRESS OF THE FIRST ENTRY   01350002
*          IN THE VOLUME LIST.  REGISTER 9 POINTS TO THE CVT, AND       01360002
*          REGISTER 10 POINTS TO THE INPUT PARAMETER LIST.              01370002
*                                                                       01380020
*ERROR CONDITIONS - UPON RETURN TO THE CALLER, REGISTER 15 CONTAINS     01390002
*          ONE OF THE FOLLOWING VALUES TO INDICATED THE COMPLETION      01400002
*          STATUS OF THE SCRATCH FUNCTION:                              01410002
*          00 - SUCCESSFUL COMPLETION                                   01420002
*          04 - NO UNIT AVAILABLE FOR MOUNTING ANY OF THE VOLUMES IN    01430002
*               THE VOLUME LIST.  THE STATUS BYTE OF EVERY ENTRY IN     01440002
*               THE VOLUME LIST IS SET TO X'05'.                        01450002
*          08 - UNABLE TO SCRATCH ON ONE OR MORE VOLUMES.  THIS CODE    01460002
*               IS ACCOMPANIED BY A SETTING OF THE STATUS BYTE OF       01470002
*               EACH VOLUME LIST ENTRY AS DESCRIBED UNDER 'INPUT'.      01480002
*          12 - THE NUMBER OF VOLUMES IN THE VOLUME LIST WAS ZERO,      01490002
*               OR THE VOLUME LIST WAS NOT IN THE USER'S REGION.        01500002
*                                                                       01510002
*STORAGE - PROGRAM CODE = LESS THAN 2048 BYTES                          01520002
*          WORK AREA = 896 BYTES                                        01530002
*                                                                       01540002
*ERROR CONDITIONS IN THIS MODULE - THE NUMBER OF VOLUMES IN THE VOLUME  01550002
*          LIST IS ZERO, THE VOLUME LIST ADDRESS IS NOT IN THE USER'S   01560002
*          REGION, THE DATA SET IS CURRENTLY OPEN, OR THE VIO DSCB      01570002
*          CANNOT BE FOUND.                                             01580002
*                                                                       01590002
*                                                                       01600000
*REGISTER USAGE:                                                        01620000
R0       EQU   0                                                        01640000
R1       EQU   1                                                        01660000
RUCBSAVE EQU   1                        CALLER'S UCB ADDRESS     Y02082 01670002
R2       EQU   2                                                        01680000
RDSAB    EQU   2                        POINTER TO THE DSAB      Y02082 01690002
R3       EQU   3                                                        01700000
RTIOT    EQU   3                        POINTER TO THE TIOT      Y02082 01710002
P1       EQU   3                                                        01720000
REND     EQU   4                        POINTER TO END OF ENTRY  Y02082 01730002
R4       EQU   4                                                        01740000
P2       EQU   4                                                        01760000
R5       EQU   5                                                        01780000
VOLCTR   EQU   5                                                        01800000
P4       EQU   6                                                        01820000
R7       EQU   7                                                        01826013
R8       EQU   8                                                        01832013
VOLISTX  EQU   8                                                        01840000
SVRBREG  EQU   8                        SVRB ADDRESS             Y02080 01850002
R9       EQU   9                                                        01860000
RCVT     EQU   9                                                        01880000
PL       EQU   10                                                       01900000
RUCB     EQU   11                                                       01920000
RBASE    EQU   12                                                       01940000
RWKAREA  EQU   13                                                       01960000
RETURN   EQU   14                                                       01980000
R15      EQU   15                       EQUATE FOR REGISTER 15   Y02080 01990002
WORKREG  EQU   15                                                       02000000
*                                                                       02001020
*OTHER EQUATES                                                          02002020
*                                                                       02003020
K0       EQU   0                        CONSTANT OF ZERO         Y02082 02004002
K1       EQU   1                        CONSTANT OF 1            Y02082 02005002
C1       EQU   1                        CONSTANT OF 1            S20201 02006002
K2       EQU   2                        CONSTANT OF 2            Y02082 02007002
K3       EQU   3                        CONSTANT OF 3            Y02082 02009002
K8       EQU   8                        CONSTANT OF 8            Y02132 02009202
K4       EQU   4                        CONSTAND OF 4            Y02082 02010002
NONZERO  EQU   4                        NON-ZERO VALUE           YM1312 02010502
K12      EQU   12                       CONSTANT OF 12           Y02082 02011002
K16      EQU   16                       CONSTANT OF 16           Y02132 02011202
K44      EQU   44                       CONSTANT OF 44         @G60ASBJ 02011660
APD      EQU   29                       DISP. TO APPG PTR IN DEB Y02082 02012002
RTNCODE8 EQU   8                        RETURN CODE OF 8         Y02082 02013002
BADLIST  EQU   12                       BAD VOL LIST ERROR CODE  Y02082 02014002
VOLSER   EQU   4                        OFFSET TO VOLUME SERIAL  Y02082 02015002
*                                       IN A VOLUME LIST ENTRY   Y02082 02016002
STATUS   EQU   11                       OFFSET TO VOLIST STATUS  Y02082 02017002
ENTRYL   EQU   12                       VOLIST ENTRY LENGTH      Y02082 02018002
VDATALN  EQU   81                       VDSDSCB DATA LENGTH      Y02132 02018802
DYNUNALL EQU   X'80'                    DYNAMIC UNALLOCATION BIT Y02082 02019002
OPENDS   EQU   X'07'                    OPEN DATA SET ERROR CODE Y02082 02020002
NOF1     EQU   X'01'                    NO F1 DSCB ERROR CODE    Y02132 02021002
IOERR    EQU   X'04'                    VSCRATCH (I/O) ERR CODE  YM6992 02021202
BLANK    EQU   C' '                     EBCDIC BLANK             YM2880 02022002
OFF      EQU   X'FF'                    MASK TO RESET SWITCHES @Z40CSRC 02023037
*                                                                       02025021
         BALR  RBASE,R0                                                 02080000
         USING *,RBASE                                          SA57158 02100002
         USING SCRTHWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 02120002
         USING UCB,RUCB                                                 02140000
         USING CVT,RCVT                                                 02160000
         USING RBBASIC,SVRBREG          SVRB ADDRESSABILITY    @G60ASBJ 02170060
*                                                                       02192021
* THIS SECTION OBTAINS THE SCRATCH WORK AREA.                           02194002
*                                                                       02196021
BEGIN    EQU   *                                                 Y01077 02214000
         LPR   PL,R1                    SAVE PARAMETER LIST PTR  Y02080 02240002
         LR    RUCB,R0                  SAVE POSSIBLE UCB ADDR   Y02080 02250002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 02260002
         L     SVRBREG,0(R4)            LOAD SVRB ADDRESS        Y02080 02300002
         ST    RETURN,RBEXSAVE+K44      SAVE REGISTER 14       @G60ASBJ 02320060
         IECRES GET,PREFIX=FIRST,LV=SWALNGTH,ID=SCWA,            Y02080X02322060
               STM=(R2,RBASE,RBEXSAVE)  OBTAIN WORK AREA       @G60ASBJ 02324060
         LR    RWKAREA,R1               LOAD BASE REG FOR WORK AREA     02326060
         L     RETURN,RBEXSAVE+K44      RESTORE REGISTER 14    @G60ASBJ 02328060
         ST    RETURN,SCRSAVE           SAVE R14 IN SCRATCH    @G60ASBJX02330060
                                        WORKAREA               @G60ASBJ 02332060
         DROP SVRBREG                                          @G60ASBJ 02334060
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO AFTER Y02082X02344002
                                        ISSUING THE IECRES GET   Y02082 02348002
*                                                                       02352002
         IECRES LOAD,MODNM=LOAD1,EXTPR=(RWKAREA),BRANCH=NO       Y02080X02356002
                                        LET OPTIONAL TRACE PRINT Y02080X02360002
                                        THIS MODULE'S NAME       Y02080 02364002
*                                                                       02368002
         L     R1,IECRRPRM              RECOVERY RTN LIST ADDR   Y02144 02372002
         USING RRPLIST,R1               PARM LIST ADDRESSABILITY Y02144 02376002
         OI    RRFUNCTN,RRFSCRTH        SET SCRATCH FUNCTION BIT Y02144 02380002
         DROP  R1                                                Y02144 02384002
*                                                                       02388002
         ST    R4,TCBADDR               SAVE INPUT TCB POINTER   Y02078 02392002
         ST    PL,OLDPLPTR              STORE PARAMETER LIST POINTER    02400000
         OI    SISW1,NOSMFRCD           SET NO SMF RECORD SWITCH YM5399X02402002
                                        UNTIL AT LEAST ONE       YM5399X02404002
                                        SCRATCH IS SUCCESSFUL    YM5399 02406002
         L     P1,K12(,PL)              LOAD ADDRESS OF VOL LIST YM5399 02407002
         LRA   P1,K0(,P1)               LOAD REAL ADDRESS OF     YM5399X02408002
                                        VOLUME LIST              YM5399 02410002
         BC    5,ERREXIT                BR IF INVALID (INVALID   YM5748 02412002
*                                       SEGMENT TABLE ENTRY OR   YM5748 02414002
*                                       INVALID SEGMENT OR PAGE  YM5399 02416002
*                                       TABLE LENGTH)            YM5399 02418002
         LM    P1,P4,0(PL)              LOAD PARAMETER LIST             02420000
*                                            P1 = SCRATCH OPTIONS       02440000
*                                            P2 = DATA SET NAME ADDR    02460000
*                                            P3 = SPARE                 02480000
*                                            P4 = VOLUME LIST ADDR      02500000
         MVC   PDSNAME,K0(P2)           SAVE DSNAME IN PROTECTED YM1337 02505002
*                                       WORK AREA                YM1337 02510002
         LA    P2,PDSNAME               GET ADDR OF PROTECTED    YM1337 02515002
*                                       DSNAME                   YM1337 02516002
         ST    P2,DSMADTW3              SAVE ADDRESS OF DSNAME   Y02144 02520002
         MVC   VOLNUM,0(P4)             MOVE NUMBER OF VOLUMES   Y02080 02560002
         LH    VOLCTR,VOLNUM            LOAD NBR OF VOLS IN LIST Y02080 02580002
         LTR   VOLCTR,VOLCTR            IS LIST EMPTY                   02600000
         BNP   ERREXIT                  BRANCH IF YES           SA56369 02601002
*                                                                       02603002
* THIS SECTION CHECKS IF THE VOLUME LIST ADDRESS IS WITHIN THE USER'S   02605002
* REGION.  IF THE CALLER IS IN SUPERVISOR STATE OR IN KEY ZERO, THEN    02607002
* THE VOLUME LIST ADDRESS DOES NOT HAVE TO BE CHECKED.                  02609002
*                                                                       02611002
VALCK    EQU   *                                                SA57158 02622602
         TESTAUTH FCTN=1,KEY=YES,STATE=YES,BRANCH=YES  TEST IF   Y02080X02624002
                                        CALLER IS IN KEY 0 OR    Y02080X02625002
                                        IN SUPERVISOR STATE      Y02080 02626002
         LTR   R15,R15                  TEST IF ANY TRUE         Y02080 02627002
         BZ    BYPASS                   BRANCH IF YES           SA57158 02627702
*                                                                       02627802
* THIS SECTION CALCULATES THE STARTING AND ENDING ADDRESSES OF          02627902
* THE AREA TO BE CHECKED                                                02628002
*                                                                       02628102
         MH    VOLCTR,TWELVE            12 TIMES NUMBER OF      SA57158 02628702
*                                       VOLUMES                 SA57158 02628802
         LA    VOLCTR,C1(VOLCTR)        ADD ONE                 SA57158 02628902
         LA    R1,0(P4)                 RELOAD VOLIST ADDRESS    Y02080 02629002
         LR    R2,R1                    GET STARTING ADDRESS     Y02080 02629102
         AR    R2,VOLCTR                GET ADDRESS OF LAST      Y02080 02629202
*                                       BYTE OF VOLIST          SA57158 02629302
         STM   RUCB,P1,IECREGSV+K12     SAVE REGISTERS 11-3      Y02080 02630002
         LR    R7,RWKAREA               SAVE WORK AREA ADDRESS   Y02080 02631002
         XR    R5,R5                    INITIALIZE REGISTER      YM1241 02631502
OBTNLOCK SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02080X02632002
               RELATED=(LOCAL,IGC0002I(RLSELOCK))  OBTAIN LOCK   Y02080 02633002
         LM    RUCB,RETURN,IECREGSV+K12-SCRTHWKA(R7)  RESTORE    Y02080 02634002
         L     R4,TCBADDR               TCB ADDRESS IN REG 4     Y02078 02635002
         L     R15,CVT0VL00             VALIDITY CHECK RTN ADDR  Y02080 02637002
         BALR  RETURN,R15               LINK TO VALIDITY CHECK   Y02080 02638002
         BZ    RLSELOCK                 BRANCH IF VALID ADDRESS  YM1312 02638502
         LA    R5,NONZERO               INDICATE INVALID ADDRESS YM1312 02639002
*                                                                       02639502
RLSELOCK SETLOCK RELEASE,TYPE=LOCAL,                             Y02080X02640002
               RELATED=(LOCAL,IGC0002I(OBTNLOCK))  RELEASE LOCK  Y02080 02641002
         LM    RUCB,P1,IECREGSV+K12-SCRTHWKA(R7)  RESTORE REGS   Y02080 02642002
         LTR   R5,R5                    TEST IF ADDRESS VALID    Y02080 02643002
         BNZ   ERREXIT                  BRANCH IF NOT VALID      Y02080 02644002
         LH    VOLCTR,VOLNUM            GET VOLUME COUNT         Y02080 02645002
*                                                                       02647002
* THIS SECTION ATTEMPTS TO ENQ ON THE TIOT, UNLESS SCRATCH HAS BEEN     02649002
* CALLED BY DYNAMIC UNALLOCATION (IF THE CALLER IS IN KEY ZERO AND BIT  02651002
* 0 OF OPTION BYTE 3 OF THE FIRST WORD OF THE PARAMETER LIST IS SET).   02653002
*                                                                       02655002
BYPASS   EQU   *                        ENQ ON THE TIOT          Y02082 02657002
         L     RDSAB,TCBADDR            LOAD TCB ADDRESS         Y02082 02659002
         USING TCB,RDSAB                TCB ADDRESSABILITY       Y02082 02661002
         L     RDSAB,TCBJSCB            GET JSCB ADDRESS         Y02082 02663002
         USING IEZJSCB,RDSAB            JSCB ADDRESSABILITY      Y02082 02665002
         L     RDSAB,JSCBACT            GET ACTIVE JSCB ADDRESS  Y02082 02667002
         L     RDSAB,JSCDSABQ           GET DSAB QDB ADDRESS     Y02082 02669002
         ST    RDSAB,DSABQDB            SAVE FOR TIOT ENQ        Y02082 02671002
         TESTAUTH FCTN=1,KEY=YES,BRANCH=YES  TEST IF CALLER IS   YM1063X02673002
                                        AUTHORIZED OR KEY ZERO   YM1063 02675002
*                                                                YM1063 02676002
         LTR   R15,R15                  TEST IF EITHER TRUE      YM1063 02677002
         BNZ   FIRSTENQ                 BRANCH IF NOT TO ENQ     Y02082 02679002
         TM    K2(PL),DYNUNALL          TEST IF ENTERED FROM     Y02082X02681002
                                        DYNAMIC UNALLOCATION     Y02082 02682002
         BO    SKIPENQ                  BRANCH IF YES            Y02082 02683002
*                                                                Y02082 02684002
FIRSTENQ EQU   *                        FIRST ENQ                Y02082 02685002
         L     R2,CVTTCBP               LOAD TCB/ASID POINTERS   YM1063 02686002
         L     R2,K12(,R2)              LOAD CURRENT ASID ADDR   YM1063 02687002
         USING ASCB,R2                  ASCB ADDRESSABILITY      YM1063 02688002
         MVC   TIOTMNR(K2),ASCBASID     MOVE ASID INTO ENQ MINOR YM1063 02689002
*                                       RESOURCE NAME            YM1063 02690002
         DROP  R2                                                YM1063 02691002
         MVC   MJNAME(L'TIOTMJR),TIOTMJR  MAJOR RESOURCE NAME    Y02082 02695002
         MVC   ENQAREA(ENQLTH1),ENQLIST1  MOVE IN PARAMETER LIST Y02082 02697002
         ENQ   (MJNAME,TIOTMNR),MF=(E,ENQAREA)  ENQ ON SYSZTIOT  Y02082 02699002
         LTR   R15,R15                  TEST IF SUCCESSFUL ENQ   Y02082 02701002
         BZ    SETENQSW                 BRANCH IF YES            Y02082 02703002
*                                                                       02704002
         LA    VOLISTX,K2(P4)           ADDRESS OF FIRST VOLUME  Y02082 02705002
OPENERR  EQU   *                        OPEN DATA SET ERROR      Y02082 02705502
         LA    R3,OPENDS                OPEN DATA SET ERROR CODE Y02132 02706002
         B     SETERRCD                 GO STORE THE STATUS BYTE Y02132 02706502
NOF1DSCB EQU   *                        NO F1 DSCB ERROR         Y02132 02707002
         LA    R3,NOF1                  NO F1 DSCB ERROR CODE    Y02132 02707502
SETERRCD EQU   *                        SET ERROR CODE           Y02132 02708002
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02078 02709002
         USING TCB,R1                   TCB ADDRESSABILITY       Y02078 02711002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02078 02713002
ERRLOOP  EQU   *                        BEGIN LOOP               Y02082 02715002
         STC   R3,STATUS(VOLISTX)       SET ERROR CODE IN VOLIST Y02132 02717002
         LA    VOLISTX,ENTRYL(VOLISTX)  NEXT VOL LIST ENTRY ADDR Y02082 02719002
         BCT   VOLCTR,ERRLOOP           BRANCH IF MORE VOLUMES   Y02082 02721002
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02082 02723002
         LA    VOLISTX,K2(P4)           RELOAD ADDR OF 1ST VOL   Y02082 02725002
         LA    WORKREG,RTNCODE8         ERROR RETURN CODE        Y02082 02727002
         B     SETCODE                  GO SAVE ERROR CODE       Y02082 02729002
*                                                                       02730002
SETENQSW EQU   *                        SET ENQ SWITCH           Y02082 02731002
         LA    R1,TIOTMNR               MINOR RESOURCE NAME ADDR Y02144 02731402
         ST    R1,DSMADTW2              SAVE MINOR ENQ NAME ADDR Y02144 02731802
         OI    DSMADTB2,DSMTIOTE        SET TIOT ENQ'ED SWITCH   Y02144 02732202
         OI    SISW1,TIOTENQ            SET TIOT ENQ'ED SWITCH   Y02082 02733002
SKIPENQ  EQU   *                        ENQ SKIPPED              Y02082 02735002
         LA    VOLISTX,K2(P4)           ADDRESS OF FIRST VOLUME  Y02082 02737002
         LTR   RUCBSAVE,RUCB            TEST FOR PASSED UCB ADDR Y02082 02739002
         BZ    FINDUNIT                 BRANCH IF ZERO           Y02082 02741002
         LA    RUCBSAVE,K0(RUCBSAVE)    CLEAR HIGH BYTE          Y02082 02743002
         TM    UCBJBNR,UCBVRDEV         TEST IF A VIRTUAL UCB    Y02132 02745002
         BZ    USERSUCB                 BRANCH IF NOT            Y02132 02747002
         ST    RUCB,PRUCBPTR            SAVE INPUT UCB ADDRESS   Y02132 02749002
         B     VIODSTST                 BRANCH TO VIO D/S TEST   Y02132 02751002
*                                                                       02765002
* IF THE USER SUPPLIED A UCB ADDRESS, THIS SECTION SEARCHES THE         02767002
* TIOT TO DETERMINE IF THE UNIT IS ALLOCATED TO THE JOB.  IF IT IS      02769002
* ALLOCATED, IT BECOMES THE PRIMARY UCB IF IT IS DEMOUNTABLE.           02771002
*                                                                       02773002
USERSUCB EQU   *                        USER SUPPLIED UCB ADDR   Y02082 02775002
         L     RDSAB,DSABQDB            LOAD DSAB QDB ADDRESS    Y02082 02777002
         USING QDB,RDSAB                QDB ADDRESSABILITY       Y02082 02779002
         L     RDSAB,QDBFELMP           GET FIRST DSAB ADDRESS   Y02082 02781002
         USING DSAB,RDSAB               DSAB ADDRESSABILITY      Y02082 02783002
UDSABTST EQU   *                        DSAB TEST                Y02082 02785002
         LTR   RDSAB,RDSAB              IS THERE ANOTHER DSAB    Y02082 02787002
         BZ    FINDUNIT                 BRANCH IF NOT            Y02082 02789002
         L     RTIOT,DSABTIOT           LOAD TIOT ADDRESS        Y02082 02791002
         USING TIOENTRY,RTIOT           TIOT ADDRESSABILITY      Y02082 02793002
         SR    REND,REND                ZERO REGISTER FOR IC     Y02082 02795002
         IC    REND,TIOELNGH            LENGTH OF TIOT ENTRY     Y02082 02797002
         AR    REND,RTIOT               ADDRESS OF FIRST BYTE    Y02082 02799002
*                                       PAST THE TIOT ENTRY      Y02082 02801002
         LA    RTIOT,TIOEFSRT-K1        ADDR OF FIRST UCB ADDR   Y02082 02803002
UNEXTUCB EQU   *                        END OF ENTRY             Y02082 02805002
         CR    RTIOT,REND               TEST IF AT END OF ENTRY  Y02082 02807002
         BNL   UNXTDSAB                 BRANCH IF YES            Y02082 02809002
         L     RUCB,K0(,RTIOT)          GET UCB ADDRESS          Y02082 02811002
         LA    RUCB,K0(RUCB)            CLEAR HIGH BYTE          Y02082 02813002
         LTR   RUCB,RUCB                IS THERE A UCB ADDRESS   Y02082 02815002
         BZ    UINCRPTR                 BRANCH IF NOT            YM1063 02817002
         CR    RUCB,RUCBSAVE            TEST IF EQUAL TO THE     Y02082 02819002
*                                       USER-SUPPLIED UCB ADDR   Y02082 02821002
         BE    LINKTEST                 BRANCH IF YES            Y02082 02823002
UINCRPTR EQU   *                                                 YM1063 02824002
         LA    RTIOT,L'TIOESTTB+L'TIOEFSRT(RTIOT)  INCREMENT TO  Y02082 02825002
*                                       NEXT UCB ADDRESS IN TIOT Y02082 02827002
         B     UNEXTUCB                 GO TRY NEXT UCB ADDRESS  Y02082 02829002
*                                                                       02830002
UNXTDSAB EQU   *                        NEXT DSAB                Y02082 02831002
         L     RDSAB,DSABFCHN           GET NEXT DSAB ADDRESS    Y02082 02833002
         B     UDSABTST                 GO TEST IT               Y02082 02835002
*                                                                       02879002
* THIS SECTION LINKS TO A ROUTINE THAT DETERMINES IF THE UNIT IS        02880002
* ELIGIBLE FOR DEMOUNTING.                                              02881002
*                                                                       02882002
LINKTEST BAL   RETURN,TESTUCB           GO TEST DEMOUNTABILITY  SA56369 02884002
         LTR   RUCB,RUCB                TEST IF DEMOUNTABLE     SA56369 02885002
         BZ    FINDUNIT                 BRANCH IF NOT           SA56369 02886002
         ST    RDSAB,PRDSABAD           SAVE PRIMARY DSAB ADDR   Y02082 02894002
         ST    RUCB,PRUCBPTR            SAVE PRIMARY UCB ADDRESS Y02082 02898002
         L     RETURN,DSABTIOT          LOAD TIOT ENTRY ADDRESS  YM7036 02898402
         LA    RETURN,TIOEJFCB-TIOENTRY(,RETURN)  POINT TO JFCB  YM7036X02899002
                                        PREFIX ADDRESS           YM7036 02900002
         IECRES LOCJFCB,(RETURN)        LOCATE THE JFCB          YM7036 02901002
         CLC   PDSNAME,JFCBDSNM-INFMJFCB(RETURN)  CHECK IF       YM7036X02902002
                                        THIS IS THE RIGHT TIOT   YM7036X02903002
                                        ENTRY FOR THIS DSNAME    YM7036 02904002
         BE    FOUNDUCB                 BRANCH IF CORRECT        YM7036 02905002
         OI    SISW2,UCBFNDSW           SET THE UCB FOUND SWITCH YM7036 02906002
         B     UINCRPTR                 GO TRY NEXT TIOT ENTRY   YM7036 02907002
*                                                                       02941021
* THIS SECTION TESTS IF THE UCB IS DEMOUNTABLE.                         02942002
*                                                                       02943021
TESTUCB  EQU   *                                                        02945013
         TM    SRTESTAB,SRTEBSVL        TEST FOR SHARED VOLUME          02980013
         BZ    WRONGUCB                 BR IF SHARED                    02990013
         TM    UCBTBYT3,UCB3DACC        TEST IF DIRECT ACCESS    Y02082 03000002
         BZ    WRONGUCB                 BRANCH IF NOT            Y02082 03010002
         TM    UCBDMCT,UCBDMC           TEST IF DATAMGT COUNT=0  Y02082 03020002
         BNZ   WRONGUCB                 BRANCH IF NOT            Y02082 03030002
         TM    SRTESTAT,SRTEONLI        TEST FOR ONLINE DEVICE  SA56369 03040002
         BZ    WRONGUCB                 BRANCH IF NOT ONLINE    SA56369 03060002
         TM    SRTESTAT,SRTERESV+SRTEPRES+SRTESYSR  TEST FOR RESERVED,  03080000
*                                       PERMANENTLY RESIDENT, OR        03100000
*                                       SYSTEM RESIDENT VOLUME          03120000
         BNZ   WRONGUCB                 BRANCH IF YES           SA56369 03140002
         BR    RETURN                   RETURN IF UCB IS OKAY   SA56369 03180002
WRONGUCB EQU   *                                                SA56369 03196002
         SR    RUCB,RUCB                DISCARD THE UCB ADDRESS SA56369 03196502
         BR    RETURN                   RETURN                  SA56369 03197002
*                                                                       03197502
* THIS SECTION INITIALIZES REGISTERS AND COUNTERS BEFORE                03198002
* BRANCHING TO IGG0290E.                                                03198502
*                                                                       03199002
NOPRIUCB EQU   *                        SET FLAG                 Y02082 03200002
         OI    STYPEFLG,NOMNTDEV        TURN ON NO DEVICE BIT    Y02082 03210002
FOUNDUCB LA    VOLISTX,2(P4)            LOAD ADDR OF FIRST VOLUME       03220000
         LH    VOLCTR,VOLNUM            LOAD NBR OF VOLS IN LIST Y02080 03240002
         ST    VOLISTX,VOLPTR           SAVE ADDR OF 1ST ENTRY   Y02082 03250002
         NI    SISW2,X'FF'-UCBFNDSW     TURN OFF UCB FOUND SWTCH YM7036 03252002
*                                                                       03260002
* THIS SECTION ISSUES AN EXCLUSIVE ENQ DIRECTED TO THE INITIATOR'S      03270002
* TCB WITH A MAJOR RESOURCE NAME OF SYSDSN AND THE DATA SET NAME AS     03280002
* THE MINOR RESOURCE NAME. IF THE RETURN CODE INDICATES THE TASK        03290002
* PREVIOUSLY HAD CONTROL OF THE RESOURCE, THE ENQ IS REISSUED AND       03300002
* A BIT IS SET TO INDICATE A DEB SEARCH MUST BE DONE TO ENSURE NO       03310002
* ONE IS CURRENTLY OPEN TO THE DATA SET.                                03320002
*                                                                       03330002
         MVC   ENQAREA(ENQLTH2),ENQLIST2  MOVE IN PARAMETER LIST Y02082 03350002
         MVC   MJNAME(L'DSNMJR),DSNMJR  MAJOR RESOURCE NAME      Y02082 03360002
         LA    P2,PDSNAME+L'PDSNAME-K1  LAST BYTE OF DSNAME      YM2880 03361002
TESTDSN  EQU   *                        SEARCH FOR NON-BLANK     YM2880 03362002
         CLI   K0(P2),BLANK             IS THIS ONE A BLANK      YM2880 03363002
         BNE   GETLNGTH                 BRANCH IF NO TO COMPUTE  YM2880X03364002
                                        LENGTH OF NAME FOR ENQ   YM2880 03365002
         BCT   P2,TESTDSN               TRY NEXT BYTE            YM2880 03366002
GETLNGTH EQU   *                        CALCULATE LENGTH         YM2880 03367002
         LA    R2,PDSNAME-K1            BYTE PRECEDING DSNAME    YM2880 03368002
         SR    P2,R2                    P2 HAS LENGTH FOR ENQ    YM2880 03369002
         L     R2,TCBADDR               LOAD TCB ADDRESS         Y02082 03380002
         USING TCB,R2                   TCB ADDRESSABILITY       Y02082 03390002
         L     R2,TCBJSCB               GET JSCB ADDRESS         Y02082 03400002
         USING IEZJSCB,R2               JSCB ADDRESSABILITY      Y02082 03410002
         L     R2,JSCBACT               GET ACTIVE JSCB ADDRESS  YM2887 03411002
         L     R2,JSCBTCBP              INITIATOR TCB ADDRESS    Y02082 03420002
         ENQ   (MJNAME,PDSNAME,,(P2)),TCB=(R2),RET=USE,MF=(E,ENQAREA)  X03430002
                                                                 YM2880 03431002
         LTR   R15,R15                  TEST RETURN CODE         Y02082 03440002
         BNZ   ERRTEST                  BRANCH IF ENQ FAILED     Y02082 03450002
*                                                                       03455002
         TM    SISW2,DSNENQCV           SUFFIXED CVOL NAME ?   @Z40CSRC 03455337
         BO    CLRCVOLN                 YES, GO CLEAR SUFFIX   @Z40CSRC 03455637
         OI    DSMADTB2,DSMDSNE         SET DSN ENQ'ED SWITCH    Y02144 03456002
         OI    SISW1,DSNENQ             SET ENQ ON SYSDSN SWITCH Y02082 03460002
         B     CHKCVOL                  GO CHK FOR A CVOL      @Z40CSRC 03470037
ERRTEST  EQU   *                        IS DSN ALREADY ENQ'ED    Y02082 03480002
         CLI   ENQAREA+K3,RTNCODE8      TEST IF TASK ALREADY     Y02082 03490002
*                                       ENQ'ED ON SYSDSN         Y02082 03500002
         BNE   CLRERRCV                 BRANCH IF NOT          @Z40CSRC 03510037
         TM    SISW2,DSNENQCV           DID CVOL ENQ FAIL      @Z40CSRC 03512037
         BO    CLRERRC2                 YES, FAIL REQUEST      @Z40CSRC 03514037
         MVC   ENQAREA(ENQLTH3),ENQLIST3  MOVE IN PARAMETER LIST Y02082 03520002
         ENQ   (MJNAME,PDSNAME,,(P2)),TCB=(R2),RET=CHNG,MF=(E,ENQAREA) X03530002
                                                                 YM2880 03531002
         LTR   R15,R15                  TEST RETURN CODE         Y02082 03540002
         BNZ   CLRERRCV                 BR IF NOT SUCCESSFUL   @Z40CSRC 03550037
         OI    SISW1,DEBSRCH            DEB SEARCH REQUIRED SW   Y02082 03560002
*                                                                       03560337
* HAVING JUST SUCCESSFULLY ENQUEUED ON SYSDSN, CHECK FOR SCRATCHING     03560637
* A CVOL (DSNAME='SYSCTLG').  IF SO, DO AN ADDITIONAL ENQ USING         03560937
* THE NAME SYSCTLG.VXXXXXX WHERE XXXXXX IS THE VOLSER.                  03561237
* THIS WILL CHECK FOR USERS OPEN TO THE CVOL VIA SVC 26 (CATALOG        03561537
* MANAGEMENT) AND SVC 22 (OPENJ).                                       03561837
* IF THE CVOL IS ALREADY ENQUEUED UPON, FAIL THE REQUEST.               03562137
* A DEB SEARCH WOULD BE INSUFFICIENT, SINCE SVC 26 USES A DUMMY         03562437
* DEB THAT IS NOT ON THE DEB CHAIN.                                     03562737
*                                                                       03563037
CHKCVOL  EQU   *                        CHECK FOR A CVOL       @Z40CSRC 03563237
         CLC   PDSNAME(L'CSYSCTNM),CSYSCTNM SCRATCHING A CVOL  @Z40CSRC 03563337
         BNE   NEXTLOAD                 NO, GO TO NEXT LOAD    @Z40CSRC 03563637
         OI    SISW2,DSNENQCV           FLAG SUFFIXED CVOL ENQ @Z40CSRC 03563937
         LA    P2,PDSNAME(P2)           POINT BEYOND DSNAME    @Z40CSRC 03564237
         MVC   K0(L'CDOTV,P2),CDOTV     MOVE IN '.V'           @Z40CSRC 03564537
         MVC   L'CDOTV(L'UCBVOLI,P2),VOLSER(VOLISTX) MV VOLSER @Z40CSRC 03564837
         LA    P2,KDOTVVL-K1(,P2)       ADDR OF LAST CHAR      @Z40CSRC 03565137
         B     GETLNGTH                 GO ENQ ON SYSCTLG.V... @Z40CSRC 03565437
NEXTLOAD EQU   *                        GO TO IGG0290E           Y02082 03570002
         LA    R2,LOAD2                 POINT TO IGG0290E        Y02080 03580002
         B     CONTINUE                 GO BRANCH TO IGG0290E    Y02082 03590002
*                                                                       03591037
* CLEAR SUFFIX QUALIFIER FROM CVOL NAME                                 03592037
*                                                                       03593037
CLRCVOLN EQU   *                        CLEAR CVOL NAME        @Z40CSRC 03594037
         LA    P2,PDSNAME-KDOTVVL(P2)   POINT AT '.VXXXXXX'    @Z40CSRC 03595037
         MVC   K0(KDOTVVL,P2),KDOTVVL(P2) BLANK OUT SUFFIX     @Z40CSRC 03596037
         B     NEXTLOAD                 GO TO NEXT LOAD        @Z40CSRC 03597037
CLRERRCV EQU   *                        CVOL CLRING FOR ERRS   @Z40CSRC 03597437
         TM    SISW2,DSNENQCV           IS DSNAME SUFFIXED     @Z40CSRC 03597837
         BNO   OPENERR                  NO, GO TO ERROR RTN    @Z40CSRC 03598237
CLRERRC2 EQU   *                        CLEAR SUFFIX           @Z40CSRC 03598637
         NI    SISW2,OFF-DSNENQCV       SHOW NOTHING TO DEQ    @Z40CSRC 03598837
         LA    P2,PDSNAME-KDOTVVL(P2)   POINT AT '.VXXXXXX'    @Z40CSRC 03599037
         MVC   K0(KDOTVVL,P2),KDOTVVL(P2) BLANK OUT SUFFIX     @Z40CSRC 03599437
         B     OPENERR                  GO TO ERROR ROUTINE    @Z40CSRC 03599837
*                                                                       03600002
* THIS SECTION SEARCHES THE TIOT TO SEE IF ANY VOLUME IN THE VOLUME     03610002
* LIST IS MOUNTED ON A UNIT ALLOCATED TO THE JOB.  IF MOUNTED, IT       03620002
* LINKS TO A ROUTINE THAT DETERMINES IF THE UNIT IS DEMOUNTABLE.        03630002
*                                                                       03640002
FINDUNIT EQU   *                        FIND A UNIT              Y02082 03650002
         TM    SISW2,UCBFNDSW           TEST IF A UCB WAS FOUND  YM7036 03652002
         BO    FOUNDUCB                 BRANCH IF YES            YM7036 03654002
         OC    VOLSER(L'SRTEVOLI,VOLISTX),VOLSER(VOLISTX)  TEST  Y02082 03660002
*                                       FOR VALID VOLUME SERIAL  Y02082 03670002
         BZ    NOUNIT                   BRANCH IF ZERO           Y02082 03680002
         CLC   VOLSER(L'SRTEVOLI,VOLISTX),BLANKS  TEST FOR VALID Y02132 03680502
*                                       VIRTUAL UCB VOL SER      Y02132 03681002
         BNE   NOVIOVOL                 BRANCH IF NOT            Y02132 03681502
         CLC   CSYS,PDSNAME             CHECK FOR CHARACTERS SYS YM1337 03682502
*                                       IN BYTES 0-2 OF THE DSN  Y02132 03683002
         BNE   NOVIOVOL                 BRANCH IF NOT            Y02132 03683502
         CLC   CDOTT,PDSNAME+K8         TEST FOR .T IN BYTES 8-9 YM1337 03684002
         BNE   NOVIOVOL                 BRANCH IF NOT            Y02132 03684502
         CLC   CDOTR,PDSNAME+K16        CHECK FOR CHARACTERS .R  YM1337 03685002
*                                       IN BYTES 16-17           Y02132 03685502
         BE    VIODSTST                 BRANCH IF YES TO TEST IF Y02132 03686002
*                                       A VIO DATA SET           Y02132 03686502
*                                                                       03687002
NOVIOVOL EQU   *                        GET FIRST DSAB ADDRESS   Y02132 03687502
         L     RDSAB,DSABQDB            LOAD DSAB QDB ADDRESS    Y02082 03690002
         USING QDB,RDSAB                QDB ADDRESSABILITY       Y02082 03700002
         L     RDSAB,QDBFELMP           GET FIRST DSAB ADDRESS   Y02082 03710002
         USING DSAB,RDSAB               DSAB ADDRESSABILITY      Y02082 03720002
DSABTEST EQU   *                        DSAB TEST                Y02082 03730002
         LTR   RDSAB,RDSAB              IS THERE ANOTHER DSAB    Y02082 03740002
         BZ    NOUNIT                   BRANCH IF NOT            Y02082 03750002
         L     RTIOT,DSABTIOT           GET TIOT POINTER         Y02082 03760002
         USING TIOENTRY,RTIOT           TIOT ADDRESSABILITY      Y02082 03770002
         SR    REND,REND                ZERO REGISTER FOR IC     Y02082 03780002
         IC    REND,TIOELNGH            LENGTH OF TIOT ENTRY     Y02082 03790002
         AR    REND,RTIOT               ADDRESS OF TIOT ENTRY    Y02082 03800002
*                                       PAST THE TIOT ENTRY      Y02082 03810002
         LA    RTIOT,TIOEFSRT-K1        ADDR OF FIRST UCB ADDR   Y02082 03820002
NEXTUCB  EQU   *                        GET NEXT UCB             Y02082 03830002
         CR    RTIOT,REND               TEST IF AT END OF ENTRY  Y02082 03840002
         BNL   NEXTDSAB                 BRANCH IF YES            Y02082 03850002
         L     RUCB,K0(,RTIOT)          GET UCB ADDRESS          Y02082 03860002
         LA    RUCB,K0(RUCB)            CLEAR HIGH BYTE          Y02082 03870002
         LTR   RUCB,RUCB                IS THERE A UCB ADDRESS   Y02082 03880002
         BZ    NXTENTRY                 BRANCH IF NOT            YM1063 03890002
         CLC   SRTEVOLI,VOLSER(VOLISTX)  COMPARE VOL SER NUMBERS Y02082 03900002
         BNE   NXTENTRY                 BRANCH IF NOT EQUAL      Y02082 03910002
*                                                                       03915002
         BAL   RETURN,TESTUCB           TEST IF UCB DEMOUNTABLE  Y02082 03920002
*                                                                       03925002
         LTR   RUCB,RUCB                TEST IF DEMOUNTABLE      Y02082 03930002
         BZ    NXTENTRY                 BRANCH IF NOT            YM7036 03932002
         ST    RDSAB,PRDSABAD           SAVE PRIMARY DSAB ADDR   YM7036 03933002
         ST    RUCB,PRUCBPTR            SAVE PRIMARY UCB ADDRESS YM7036 03934002
         L     RETURN,DSABTIOT          LOAD TIOT ENTRY ADDRESS  YM7036 03934402
         LA    RETURN,TIOEJFCB-TIOENTRY(,RETURN)  POINT TO JFCB  YM7036X03935002
                                        PREFIX ADDRESS           YM7036 03936002
         IECRES LOCJFCB,(RETURN)        LOCATE THE JFCB          YM7036 03937002
         CLC   PDSNAME,JFCBDSNM-INFMJFCB(RETURN)  CHECK IF       YM7036X03938002
                                        THIS IS THE RIGHT TIOT   YM7036X03939002
                                        ENTRY FOR THIS DSNAME    YM7036 03940002
         BE    FOUNDUCB                 BRANCH IF CORRECT        YM7036 03941002
         OI    SISW2,UCBFNDSW           SET THE UCB FOUND SWITCH YM7036 03942002
NXTENTRY EQU   *                        NEXT ENTRY               Y02082 03950002
         LA    RTIOT,L'TIOESTTB+L'TIOEFSRT(,RTIOT)  INCREMENT TO Y02082 03960002
*                                       NEXT UCB ADDRESS IN TIOT Y02082 03970002
         B     NEXTUCB                  GO TEST NEXT UCB ADDRESS Y02082 03980002
*                                                                       03985002
NEXTDSAB EQU   *                        NEXT DSAB                Y02082 03990002
         L     RDSAB,DSABFCHN           GET NEXT DSAB ADDRESS    Y02082 04000002
         B     DSABTEST                 GO TEST IT               Y02082 04010002
NOUNIT   EQU   *                        NO UNIT                  Y02082 04020002
         BCT   VOLCTR,TRYNEXT           TEST IF MORE VOLUMES     Y02082 04030002
         TM    SISW2,UCBFNDSW           TEST IF A UCB WAS FOUND  YM7036 04032002
         BO    FOUNDUCB                 BRANCH IF YES            YM7036 04034002
         B     NOPRIUCB                 BRANCH IF NOT            Y02082 04040002
TRYNEXT  EQU   *                        NEXT VOLUME LIST ENTRY   Y02082 04050002
         LA    VOLISTX,ENTRYL(VOLISTX)  POINT TO NEXT ENTRY      Y02082 04060002
*                                       IN THE VOLUME LIST       Y02082 04070002
         B     NOVIOVOL                 GO TRY NEXT VOLUME       YM7036 04080002
*                                                                       06030002
* THIS SECTION PREPARES TO BRANCH TO THE LAST LOAD OF SCRATCH.          06040002
*                                                                       06050002
ERREXIT  EQU   *                                                SA56369 06060002
         LA    WORKREG,BADLIST          ERROR CODE FOR EMPTY    SA57261 06110002
*                                       VOLUME LIST OR INVALID  SA57261 06120002
*                                       VOLUME LIST ADDRESS     SA57261 06130002
SETCODE  EQU   *                        SET CODE                 Y02082 06135002
         STH   WORKREG,ERCODE          STORE ERROR CODE IN VOL LIST     06140013
         OI    STYPEFLG,EXITBIT         SET EXIT BIT             Y02082 06145002
         LA    R2,LASTLOAD              POINT TO IGG0290D        Y02080 06390002
*                                                                       06410002
* THIS SECTION BRANCHES TO ANOTHER LOAD OF SCRATCH.                     06420002
*                                                                       06430002
CONTINUE EQU   *                        GO TO NEXT LOAD          Y02082 06440002
         MVC   WKADEB+APD(K3),CVTXAPG+K1  POINT DEB TO IOS AVT   Y02082 06450002
         L     PL,OLDPLPTR              GET PARAMETER LIST PTR   Y02082 06460002
         IECRES LOAD,EXTPR=(RWKAREA),MODNM=(R2),BRANCH=DIRECT    Y02082 06470002
*                                                                       06471002
* THIS SECTION SEARCHES THE DSAB CHAIN FOR A TIOT ENTRY CONTAINING      06472002
* A VIRTUAL UCB WHOSE VDSDSCB CONTAINS THE DATA SET NAME BEING          06473002
* SCRATCHED AND WHOSE VOLUME SERIAL NUMBER IN THE VDSUCB MATCHES        06474002
* THE FIRST VOLUME SERIAL IN THE VOLUME LIST. IF A DSNAME/VOL SER       06475002
* MATCH IS FOUND, IT ISSUES VSCRATCH AND ZEROS THE VDSDSCB.             06476002
*                                                                       06477002
VIODSTST EQU   *                        FIND VIO DSN             Y02132 06478002
         OI    STYPEFLG,VIOBIT          SET VIO BIT              Y02132 06479002
         L     RDSAB,DSABQDB            GET DSAB QDB ADDRESS     Y02132 06480002
         USING QDB,RDSAB                QDB ADDRESSABILITY       Y02132 06481002
         L     RDSAB,QDBFELMP           GET PTR TO FIRST DSAB    Y02132 06482002
         USING DSAB,RDSAB               DSAB ADDRESSABILITY      Y02132 06483002
VDSABTST EQU   *                        DSAB TEST                Y02132 06484002
         LTR   RDSAB,RDSAB              IS THERE ANOTHER DSAB    Y02132 06485002
         BZ    NOMATCH                  BRANCH IF NOT            Y02132 06486002
         L     RTIOT,DSABTIOT           GET TIOT ADDRESS         Y02132 06487002
         USING TIOENTRY,RTIOT           TIOT ADDRESSABILITY      Y02132 06488002
         L     RUCB,TIOEFSRT-K1         GET UCB ADDRESS          Y02132 06489002
         LA    RUCB,K0(RUCB)            CLEAR HIGH BYTE          Y02132 06490002
         LTR   RUCB,RUCB                IS THERE A UCB ADDRESS   Y02132 06491002
         BZ    VNXTDSAB                 IF NO, TRY NEXT DSAB     Y02132 06492002
         TM    UCBJBNR,UCBVRDEV         TEST IF A VIRTUAL UCB    Y02132 06493002
         BZ    VNXTDSAB                 BRANCH IF NOT            Y02132 06494002
         CLC   SRTEVOLI,VOLSER(VOLISTX)  COMPARE VOL SER'S       Y02132 06495002
         BNE   VNXTDSAB                 BRANCH IF NOT EQUAL      Y02132 06496002
         LR    R7,RUCB                  VDSCB ADDRESS            Y02132 06497002
         USING VDSCB,R7                 VDSCB ADDRESSABILITY     Y02132 06498002
         CLC   DS1DSNAM,PDSNAME         COMPARE DSNAME'S         YM1337 06500002
         BNE   VNXTDSAB                 BRANCH IF NOT EQUAL      Y02132 06501002
VIOSCRTH EQU   *                        TEST COUNT               Y02132 06502002
         CLI   DSABOPCT,K0              IS DSAB OPEN COUNT ZERO  Y02132 06503002
         BNE   OPENERR                  BRANCH IF NOT            Y02132 06504002
         CLI   UCBDMCT,K0               IS UCB DATAMGT COUNT 0   Y02132 06505002
         BNE   OPENERR                  BRANCH IF NOT            Y02132 06506002
         L     R1,VDSDSPCT              GET PTR TO DSPCT         Y02132 06507002
         LTR   R1,R1                    DOES IT EQUAL ZERO       Y02132 06508002
         BZ    NOVSCRTH                 BRANCH IF YES            Y02132 06509002
*                                                                       06510002
         XC    VDSDSPCT,VDSDSPCT        ZERO VDSDSPCT PTR        YM7831 06510402
*                                                                       06510802
         STM   RUCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14    Y02132 06511002
         LR    R2,RWKAREA               SAVE WORK AREA ADDRESS   Y02132 06512002
OBTNLCK2 SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02132X06513002
               RELATED=(LOCAL,IGC0002I(RLSELCK2))  OBTAIN LOCK   Y02132 06514002
         LM    RUCB,RETURN,IECREGSV+K12-SCRTHWKA(R2)  RESTORE    Y02132 06515002
         VSCRATCH DSPCT=(1)             ISSUE VSCRATCH MACRO     Y02132X06516002
                                        REGISTER 13 POINTS TO    Y02132X06517002
                                        THE 18 WORD SAVE AREA    Y02132 06518002
*                                                                YM6992 06518402
         LR    R1,R15                   SAVE VSCRATCH RETURN CDE YM6992 06518802
         STM   RUCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14    Y02132 06519002
         LR    R2,RWKAREA               SAVE WORK AREA ADDRESS   Y02132 06520002
RLSELCK2 SETLOCK RELEASE,TYPE=LOCAL,                             Y02080X06521002
               RELATED=(LOCAL,IGC0002I(OBTNLCK2))  RELEASE LOCK  Y02080 06522002
         LM    RUCB,RETURN,IECREGSV+K12-SCRTHWKA(R2)  RESTORE    Y02132 06523002
         LTR   R1,R1                    TEST VSCRATCH RETURN CDE YM6992 06523402
         BZ    NOVSCRTH                 BRANCH IF NO ERROR       YM6992 06523802
         L     R1,TCBADDR               LOAD TCB ADDRESS         YM6992 06524202
         USING TCB,R1                   TCB ADDRESSABILITY       YM6992 06524602
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY YM6992 06525002
         MVI   STATUS(VOLISTX),IOERR    I/O ERROR CODE           YM6992 06525402
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       YM6992 06525802
         DROP  R1                                                YM6992 06526202
         BCT   VOLCTR,VIOERR            ERROR IF MORE VOLUMES    YM6992 06526602
         LA    WORKREG,RTNCODE8         SCRATCH ERROR CODE       YM6992 06527002
         B     SETCODE                  GO BRANCH TO LAST LOAD   YM6992 06527402
*                                                                YM6992 06527802
NOVSCRTH EQU   *                        ZERO OUT THE VIO DSCB    Y02132 06528002
         XC    DS1FMTID(VDATALN),DS1FMTID  ZERO OUT THE VIO DSCB Y02132X06529002
                                        EXCEPT THE DSNAME FIELD  Y02132 06530002
         XR    R1,R1                    ZERO REGISTER            Y02132 06532002
         BCTR  R1,K0                    DECREMENT TO MINUS 1     Y02132 06533002
         STH   R1,VDSABSTT              INDICATE D/S SCRATCHED   Y02132 06534002
         DROP  R7                                                Y02132 06535002
         NI    SISW1,X'FF'-NOSMFRCD     RESET NO SMF RECORD BIT  Y02132 06536002
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02132 06537002
         USING TCB,R1                   TCB ADDRESSABILITY       Y02132 06538002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02132 06539002
         MVI   STATUS(VOLISTX),K0       SUCCESSFUL SCRATCH CODE  Y02132 06540002
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02132 06541002
         DROP  R1                                                Y02132 06542002
         BCT   VOLCTR,VIOERR            ERROR IF MORE VOLUMES    Y02132 06543002
         XR    WORKREG,WORKREG          SUCCESSFUL SCRATCH CODE  Y02132 06544002
         B     SETCODE                  GO BRANCH TO LAST LOAD   Y02132 06545002
VIOERR   EQU   *                        SET ERROR CODE           Y02132 06546002
         LA    VOLISTX,ENTRYL(VOLISTX)  NEXT VOL LIST ENTRY ADDR Y02132 06547002
         B     NOF1DSCB                 GO SET AN ERROR CODE OF  Y02132 06548002
*                                       X'01' FOR OTHER ENTRIES  Y02132 06549002
VNXTDSAB EQU   *                        NEXT                     Y02132 06550002
         L     RDSAB,DSABFCHN           GET NEXT DSAB ADDRESS    Y02132 06551002
         B     VDSABTST                 GO TEST IT               Y02132 06552002
NOMATCH  EQU   *                        NO VIO DSN MATCH         Y02132 06553002
         OC    PRUCBPTR,PRUCBPTR        TEST FOR INPUT UCB ADDR  Y02132 06554002
         BZ    NOF1DSCB                 BRANCH IF NONE           Y02132 06555002
         NI    STYPEFLG,X'FF'-VIOBIT    RESET VIO BIT            Y02132 06556002
         XC    PRUCBPTR,PRUCBPTR        CLEAR INVALID UCB ADDR   Y02132 06557002
         B     NOVIOVOL                 BRANCH TO NON-VIO LOGIC  Y02132 06558002
*                                                                       06560000
*** PROGRAM CONSTANTS                                                   06580000
*                                                                       06600000
TWELVE   DC    H'12'                                             A33080 06610020
CSYSCTNM DS    0CL8                     CVOL DSNAME 'SYSCTLG ' @Z40CSRC 06611037
CSYS     DC    CL3'SYS'                 CONSTANT OF 'SYS'        Y02132 06620002
         DC    C'CTLG '                 REST OF 'SYSCTLG '     @Z40CSRC 06621037
CDOTT    DC    CL2'.T'                  CONSTANT OF '.T'         Y02132 06630002
CDOTR    DC    CL2'.R'                  CONSTANT OF '.R'         Y02132 06640002
CDOTV    DC    C'.V'                    CONSTANT OF '.V'       @Z40CSRC 06641037
BLANKS   DC    CL6' '                   SIX EBCDIC BLANKS        Y02132 06650002
TIOTMJR  DC    CL8'SYSZTIOT'            TIOT MAJOR RESOURCE NAME Y02082 06730002
DSNMJR   DC    CL8'SYSDSN'              DSN MAJOR RESOURCE NAME  Y02082 06740002
ENQLIST1 ENQ   (,,E,6,SYSTEM),RET=HAVE,MF=L  TIOT ENQ PARM LIST  Y02082 06750002
ENQLTH1  EQU   *-ENQLIST1               LENGTH OF ENQ PARM LIST  Y02082 06760002
ENQLIST2 ENQ   (,,E,,SYSTEM),RET=USE,MF=L  1ST DSN ENQ LIST      YM2880 06770002
ENQLTH2  EQU   *-ENQLIST2               LENGTH OF ENQ PARM LIST  Y02082 06780002
ENQLIST3 ENQ   (,,E,,SYSTEM),RET=CHNG,MF=L  2ND DSN ENQ LIST     YM2880 06790002
ENQLTH3  EQU   *-ENQLIST3               LENGTH OF ENQ PARM LIST  Y02082 06800002
*                                                                       06980020
*** TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                     07040002
*                                                                       07100020
         XCTLTABL ID=(LOAD1,IGC0002I,LOAD2,IGG0290E,LASTLOAD,    Y02080X07150002
               IGG0290D),SVC=029,LENGTH=,BRT=YES                 Y02080 07160002
         SPACE 2                                                 Y02080 07170002
         IECDSECS ASCB,CVT,DSAB,JSCB,PSA,QDB,RB,RRPL,TIOT,TCB,   YM1063X07180002
               UCB,EXPAND=YES                                    YM1063 07200002
WORKAREA IECSCRWA EP,ADT=YES            SCRATCH WORK AREA        Y02144 07660002
         EJECT                                                   Y02132 07680002
         IDDVDSCB                       VDSCB EXPANSION          Y02132 07700002
         EJECT                                                   Y02132 07720002
         ORG   VDSDSCB                                           Y02132 07740002
         IECSDSL1 (1)                   FORMAT 1 DSCB EXPANSION  Y02132 07760002
         EJECT                                                   YM7036 07770002
         IEFJFCBN                       JFCB DSECT               YM7036 07780002
KDOTVVL  EQU   L'CDOTV+L'UCBVOLI        LENGTH OF CVOL SUFFIX  @Z40CSRC 07781037
         END                                                            08840000
