         TITLE 'IGC0003A - FEOV EXECUTOR (SAM)'                         00200037
IGC0003A CSECT                                                          00800021
*********************************************************************** 01000021
*                                                                     * 01200021
*                                                                     * 01300000
*          VS2 RELEASE 04 CHANGES/DELETIONS                           * 01305037
*0000678000,738000-748000                                      @ZA02215 01306037
*A795540-795680,A795980-795990                                 @ZA29752 01308037
*A674500-675800,714500,72600                                   @ZA30750 01309037
*          VS2 RELEASE 02 DELETIONS                                   * 01310002
*                                                                     * 01320002
*                                                                     * 01330002
*********************************************************************** 01360002
*                                                                     * 01410002
* MODULE NAME = IGC0003A (OS/VS2)                                     * 01460002
*                                                                     * 01510002
* DESCRIPTIVE NAME = FEOV EXECUTOR (SAM) FUNCTION                       01560002
*                                                                     * 01610002
* COPYRIGHT = NONE                                                    * 01660002
*                                                                     * 01710002
* STATUS = RELEASE 4, LEVEL 0                                         * 01760037
*                                                                     * 01810002
* FUNCTION =                                                          * 01860002
*        THIS EXECUTOR WILL BE THE FIRST LOAD OF THE EOV ROUTINES     * 01910002
*        WHEN THE FEOV (SVC 31) MACRO IS ISSUED.                      * 01960002
*        IT WILL CHECK THE VALIDITY OF THE DCB.                       * 02010002
*        FLUSH QSAM OUTPUT BUFFERS AND WAIT FOR QUIESENCE.            * 02060002
*        DEB VALIDITY CHECKING IS ACCOMPLISHED VIA A DEB VALIDITY     * 02110002
*        CHECK ROUTINE WHICH MAINTAINS AND UPDATES A TABLE OF VALID   * 02160002
*        DEB ADDRESSES IN PROTECTED CORE.                             * 02210002
*        THE EOV WORKAREA IS OBTAINED USING THE IECRES MACRO WHICH    * 02260002
*        WILL RESULT IN A SHARED ENQ ON THE TIOT.                     * 02310002
*                                                                     * 02360002
* NOTES = SEE BELOW                                                   * 02410002
*                                                                     * 02460002
*    DEPENDENCIES =                                                   * 02510002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 02560002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 02610002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 02660002
*                                                                     * 02710002
*    RESTRICTIONS = NONE                                              * 02760002
*                                                                     * 02810002
*    REGISTER CONVENTIONS =                                           * 02860002
*            R2 POINTS TO DCB                                         * 02910002
*            R4 POINTS TO EOV WORK AREA                               * 02960002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03010002
*            R6 POINTS TO THE WTG TABLE                               * 03060002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 03110002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 03160002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 03210002
*            R10 POINTS TO THE UCB                                    * 03260002
*                                                                     * 03310002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03360002
*                  END OF LISTING.                                    * 03410002
         EJECT                                                          03460002
* MODULE TYPE = CONTROL (EOV DATA MANAGEMENT)                         * 03510002
*                                                                     * 03560002
*    PROCESSOR = ASSEMBLER XF                                         * 03610002
*                                                                     * 03660002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 03710002
*                  ORG STATEMENT AT END OF LISTING                    * 03760002
*                                                                     * 03810002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 03860002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 03910002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 03960002
*                                                                     * 04010002
* ENTRY POINT = IGC0003A                                              * 04060002
*                                                                     * 04110002
*    PURPOSE = SEE FUNCTION                                           * 04160002
*                                                                     * 04210002
*    LINKAGE =                                                        * 04260002
*        FEOV MACRO (SVC 31) WITH DCB ADDRESS IN REGISTER 1           * 04310002
*                                                                     * 04360002
* INPUT =                                                             * 04410002
*        REGISTERS - REGISTER 1 POINTS TO USER'S DCB.                 * 04460002
*        A POINTER IN REGISTER 4 TO THE TCB SET BY THE SVC INTERRUPT  * 04510002
*        HANDLER.                                                     * 04560002
*                                                                     * 04610002
* OUTPUT =                                                            * 04660002
*        CONTROL PASSED IN PROTECT KEY 5.                             * 04670002
*        EOV WORKAREA.                                                * 04710002
*        REGISTERS -                                                  * 04760002
*        R2 POINTS TO DCB COPY                                        * 04810002
*        R4 POINTS TO EOV WORK AREA                                   * 04860002
*        R5 POINTS TO THE RESIDENT ROUTINE                            * 04910002
*        R6 POINTS TO THE WTG TABLE                                   * 04960002
*        R8 POINTS TO THE CURRENT WTG TABLE ENTRY                     * 05010002
*                                                                     * 05060002
* EXIT-NORMAL =                                                       * 05110002
*        IFG0551F VIA IECRES-BRANCH MACRO                             * 05160002
         EJECT                                                          05210002
* EXIT-ERROR =                                                        * 05260002
*        IFG0550P VIA DMABCOND AND IECRES-BRANCH MACRO TO ISSUE       * 05310002
*        1) INTERNAL ABEND CODE 182 CAUSING                           * 05360002
*        437-08 SYSTEM ABEND - INVALID DCB POINTER IN DEB.            * 05410002
*        2) INTERNAL ABEND CODE 242 CAUSING                           * 05460002
*        937-18 ABEND - DSAB INDICATES CHECKPOINT SECURITY            * 05510002
*        INTERFACE ALREADY ESTABLISHED.                               * 05560002
*                                                                     * 05570002
*        EXIT TO CALLER VIA IECRES-EXIT MACRO IF                      * 05610002
*        1) VTAM ACB, IN WHICH CASE THE ACBERFLG IS SET TO 04         * 05660002
*        2) EXCP DCB                                                  * 05710002
*        3) DCB DEVICE TYPE INDICATES TERMINAL DEVICE                 * 05760002
*        4) DUMMY DATA SET (UCB ADDRESS ZERO IN TIOT)                 * 05810002
*        5) ERROR RETURN FROM IECRES-INIT MACRO INDICATING DEB/DEB    * 05860002
*        EXTENSION/DSAB/DCBTIOT OFFSET INVALID                        * 05910002
*        6) OPEN AND LOCK BITS NOT ON IN DCBOFLGS                     * 05960002
*        7) THE DEB ACCESS METHOD TYPE INDICATES A SUBSYSTEM DEB      * 05970002
*        8) AN ACB INSTEAD OF A DCB ADDRESS IS PASSED IN REGISTER 1.  * 05980002
*        9) DEB CHAINED ON ANOTHER TCB AND IT IS BEING CLOSED BY      * 05982002
*        THE TASK CLOSE ROUTINE FOR THAT TCB                          * 05984002
*                                                                     * 05990002
*        DMABCOND PCK ISSUED IF IECRES-GET,PREFIX=EOV RETURNS    YM3185 06000002
*        A NON-ZERO RETURN CODE IN REGISTER 0, INDICATING THAT   YM3185 06002002
*        THE CALLER OF EOV WAS EXCLUSIVELY ENQUEUED ON THE TIOT. YM3185 06004002
*                                                                     * 06010002
* EXTERNAL REFERENCES = SEE BELOW                                     * 06060002
*                                                                     * 06110002
*    ROUTINES =                                                       * 06160002
*        THE FOLLOWING ROUTINES ARE GIVEN CONTROL EITHER VIA THE      * 06210002
*        SYNCH MACRO IF THE CALLER OF THIS SVC ROUTINE, AS INDICATED  * 06260002
*        BY THE RESUME PSW IN THE RB, IS IN A USER                    * 06310002
*        KEY (8-15), OR VIA A BALR IN THE CALLERS KEY IF THE CALLER   * 06360002
*        IS IN A SYSTEM KEY (0-7).                                    * 06410002
*                                                                     * 06420002
*        SEQUENTIAL ACCESS METHOD TRUNC ROUTINE POINTED TO BY         * 06460002
*        DCBPUT WITH BRANCH OFFSET OF 8.                              * 06510002
*                                                                     * 06520002
*        SEQUENTIAL ACCESS METHOD PUT ROUTINE POINTED TO BY DCBPUT.   * 06560002
*                                                                     * 06570002
*        SEQUENTIAL ACCESS METHOD PUT ERROR ROUTINE POINTED TO BY     * 06610002
*        DCBPERR.                                                     * 06660002
*                                                                     * 06670002
*        DATA MANAGEMENT SERVICE ROUTINE, IFG019RA, THROUGH           * 06680002
*        IECRES MACRO INSTRUCTION.                                    * 06690002
*                                                                     * 06710002
*    DATA AREAS =                                                     * 06760002
*        NONE.                                                        * 06770002
         EJECT                                                          06780002
*    CONTROL BLOCK =                                                  * 06860002
*        TCB                                                          * 06910002
*        SVRB                                                         * 06960002
*        DEB                                                          * 07010002
*        TIOT                                                         * 07060002
*        CVT                                                          * 07110002
*        DSAB                                                         * 07160002
*        SEQUENTIAL ACCESS METHOD IOBS                                * 07210002
*        DEB EXTENSION                                                * 07260002
*                                                                     * 07310002
* TABLES =                                                            * 07360002
*        EOV WORKAREA MAPPED BY FORCORE DSECT.                        * 07410002
*                                                                     * 07460002
* MACROS =                                                            * 07510002
*        MODESET                                                      * 07560002
*        DMABCOND                                                     * 07610002
*        IECRES EXIT                                                  * 07660002
*        IECRES GET                                                   * 07710002
*        IECRES LOAD                                                  * 07760002
*        IECRES INIT                                                  * 07810002
*        IECRES FREE                                                  * 07860002
*        DEBCHK                                                       * 07960002
*        SYNCH                                                        * 08010002
*        WAIT                                                         * 08060002
*        PURGE                                                        * 08110002
*        XCTLTABL                                                     * 08160002
*        IECDSECS                                                     * 08210002
*                                                                     * 08260002
* CHANGE ACTIVITY =                                                   * 08310002
*        SEE 'CHANGES/DELETIONS' SECTION JUST AFTER CSECT CARD        * 08360002
*                                                                     * 08410002
*********************************************************************** 08460002
         EJECT                                                          08510002
         BALR  RBASE,0                   ESTABLISH BASE                 21400021
         USING *,RBASE                   DEFINE BASE REGISTER           21600037
*                                                                       21700037
         USING IHADCB,RDCB                                              21800021
         USING SRT,RUCB                                                 22000021
         USING DEBBASIC,RDEB                                     Y02134 22050002
         USING FORCORE,RCORE                                            22200021
         USING WTG,RWTG                 BASE OF WTG TABLE        Y02080 22250002
         USING TIOENTRY,RTIOT           DEFINE BASE TO TIOT DD ENTRY    22300037
*                                                                       22400021
*  INTERNAL CODE FOR ABEND VIA PROBLEM DETERMINATION MODULE             22500021
*                                                                       22600021
EABD182  EQU   182                      CODE FOR ABEND 437-08    A48604 22700002
EABD242  EQU   242                      937-18 INTERNAL CD       Y02083 22750002
*                                                                       22800021
EIN03200 EQU   *                        BASE REGISTER POINTS HERE       23000002
         DROP  RCORE                                             Y02082 23500002
         USING TCB,R4                   SVC GETS R4 AS TCB ADDR  Y02082 23550002
         MODESET EXTKEY=RBT234,WORKREG=2 ASSUME CALLER'S KEY     Y02082 23600002
         DROP  R4                                                Y02082 23650002
         USING FORCORE,RCORE                                     Y02082 23700002
         LR    RDCB,R1                  GET DCB ADDRESS IN PROPER REG   23800021
         LA    R1,0(R1)                 CLEAR HIGH ORDER BYTE    A48604 23850021
         TM    DCBMACRF,DCBMEXCP        DCB USING EXCP MACRO     A48604 23900021
         BO    EIN03300                 YES RETURN TO USER       A48604 23950021
         TM    DCBOFLGS,DCBOPEN+DCBOLOCK IS DCB OPEN + UNLOCKED SA52379 24400002
         BNO   EIN03300                 NO RETURN TO USER       SA52379 24600002
*                                                                Y02004 24650002
* DO NOT PROCESS VTAM REQUESTS                                   Y02004 24700002
*                                                                Y02004 24750002
         TM    DCBDSRG2,ACBDORGA        IS THIS AN ACB?          Y02004 24800002
         BZ    EIN03210                 BR IF NO                 Y02004 24850002
         USING IFGACB,RACB              ADDRESS ACB              Y02004 24900002
         CLI   ACBAMETH,ACBVTAM         IS THIS ACB FOR VTAM?    YM3011 24950002
         BNE   EIN03300                 NO, EXIT                 Y02004 25000002
         MVI   ACBERFLG,VSCACBCL        SET ACB ERROR FLAG       Y02004 25050002
         B     EIN03300                 RETURN TO USER           Y02004 25100002
         USING IHADCB,RDCB              RESTORE BASE FOR DCB     Y02004 25150002
         EJECT                                                          25200002
EIN03210 EQU   *                        GET DEB TO CHECK                25202002
         CLI   DCBDEVT,DCBDEVTM         CHECK FOR TERMINAL       Y02082 25204002
         BE    EIN03300                 IF YES, RETURN TO USER   Y02082 25206002
         L     RDEB,DCBDEBAD            GET DEB FROM DCB         A48604 25211902
         LA    RDEB,0(RDEB)             CLEAR HIGH ORDER BYTE    A48604 25212002
*                                                                       25264021
*  NOW CHECK IF DEB POINTS TO DCB                                       25268002
*                                                                       25276021
EIN03230 EQU   *                        CHECK DEBAMTYP           A48604 25280002
         LR    R8,RDEB                  GET DEB IN R8            YM1196 25280402
         LA    R9,K3                    OFFSET BACK TO ACCESS    Y02120 25282002
*                                       METHOD INDICATOR         Y02120 25282402
         SR    R8,R9                    R8 POINTS TO AM TYPE     Y02120 25282802
         CLC   K0(K1,R8),SUBSYSAM       SUBSYSTEM DEB?           Y02120 25283202
         BE    EIN03300                 EXIT IF YES              Y02120 25283602
         L     R8,DEBDCBAD              GET DEB'S DCB PT         Y02134 25287302
         LA    R8,0(R8)                 CLEAR HIGH ORDER BYTE    A48604 25289902
         CR    R8,R1                    DOES DEB PT TO DCB       A48604 25292502
         BE    EIN03270                 BR YES - VALID DCB       A48604 25296021
         EJECT                                                          25306002
EIN03260 EQU   *                        ABEND ERROR EXIT         A48604 25318502
         BAL   R8,EIN03420              GET CORE FOR EOV RTNS    A48604 25321102
*                                                                       25323702
*              CONTROL RETURNED IN DATA MANAGEMENT KEY           Y02082 25326302
*                                                                       25328902
         NI    DCBOFLGS,K255-DCBOBUSY   CONTINUE WITH ABEND      Y02134 25331502
*              WHETHER OR NOT IECRES INIT WAS SUCCESSFUL         Y02134 25334102
         LA    RWTG,DXXAREA             WTG REG PTS TO DUMMY WTG A48604 25336702
         LA    RWTGC,DXXENTRY           CURRENT PTR POINTS TO    A48604 25339302
*                                       ..DUMMY ENTRY                   25341902
         ST    RCORE,DXXCORE-K1-DXXENTRY(RWTGC)  SAVE WORK AREA  A48604 25344502
*                                       ..POINTER IN WTG ENTRY          25347102
         DMABCOND  EABD182,ABEND2Z,RES=NO,REGSAVE=YES            A48604 25349702
*                                                                       25352302
*  INITIALIZE WHERE-TO-GO TABLE FOR XCTL TO PROBLEM DETERMINATION       25354902
*                                                                       25357502
         MVC   DXXMODID,ABEND2Z         SET MODULE ID TO 0P      A48604 25360102
         MVC   DXXMODEP+K1(K3),ABEND2Z+K2 AND TTR OF IFG0550P    Y02080 25362702
         B     EIN05120                 GO TO XCTL               A48604 25365302
*                                                                       25368202
EIN03270 EQU   *                        CHECK FOR DUMMY          A48604 25371102
         USING DEBBASIC,RDEB                                     Y02134 25384002
*        TCB ADDRESS PASSED TO SVC IN REGISTER 4                 Y02134 25394002
         USING TCB,RCORE                                         Y02134 25396002
         L     RTIOT,TCBTIO             GET TIOT ADDRESS         Y02134 25400002
         USING FORCORE,RCORE                                     Y02134 25450002
         AH    RTIOT,DCBTIOT            GET ADDR TIOT DD ENTRY          25600037
         L     RUCB,TIOEFSRT-K1         GET UCB ADDRESS                 25800037
         LA    RUCB,K0(RUCB)            CLEAR HIGH-ORDER BYTE           26000021
         LTR   RUCB,RUCB                IS THIS A DUMMY DATA SET        26200021
         BZ    EIN03300                 YES RETURN TO USER              26400021
*                                                                       26600021
         L     RDEB,DCBDEBAD            GET DEB ADDRESS                 26800021
         L     RUCB,DEBSUCBA            GET UCB ADDRESS          Y02134 27000002
         B     EIN03400                 BRANCH TO CONTINUE       Y02134 27600002
         EJECT                                                          27800002
EIN03300 EQU   *                        RETURN TO CALLER                28000002
*                                                                       28200021
*        RETURN TO CALLER                                        Y02080 28500002
*                                                                Y02080 28550002
         SR    RF,RF                    CLEAR ERR ROUTINE PTR   SA52379 28552002
         IECRES EXIT                    RETURN                   Y02080 28560002
         EJECT                                                          28750002
EIN03400 EQU   *                        CONTINUE NORMAL FEOV            29000002
*                                                                       29010002
*        DON'T PROCESS DEB CHAINED OFF ANOTHER TCB IF TASK CLOSE YM2869 29020002
*        IS PROCESSING THE DEB                                   YM2869 29030002
*                                                                       29040002
*        RCORE STILL POINTS TO TCB                               YM2869 29042002
*                                                                       29044002
         CLM   RCORE,B'0111',DEBTCBAD+K1 IS DEB ON CURRENT TCB   YM2869 29050002
         BE    EIN03410                 BRANCH IF YES            YM2869 29070002
         LR    R8,RDEB                  DEB ADDRESS              YM2869 29080002
         LA    RF,DEBBASIC-DEBXTNP      OFFSET TO DEBX ADDR      YM2869 29090002
         SR    R8,RF                    R8 POINTS TO DEBX ADDR   YM2869 29100002
         USING DEBXTNP,R8                                        YM2869 29110002
         L     R8,DEBXTNP               R8 POINTS TO DEBX        YM2869 29120002
         USING DEBXTN,R8                                         YM2869 29130002
         TM    DEBXFLG1,DEBXTSK         IS TASK CLOSE PROCESSING YM2869 29140002
*                                       THIS DEB                 YM2869 29150002
         BO    EIN03300                 EXIT IF YES              YM2869 29160002
         DROP  R8                                                YM2869 29170002
DEBXTSK  EQU   X'40'                    TASKCLOSE PROCESSING DEB YM2869 29172002
EIN03410 EQU   *                        CONTINUE NORMAL FEOV     YM2869 29180002
*                                                                       29220021
*  GET SPACE FOR END OF VOLUME ROUTINES                                 29240021
*                                                                       29260021
         LA    R8,EIN03450              LOAD ADDR FOR RETURN     A48604 29280021
*                                       ..FROM                          29300002
         EJECT                                                          29320002
EIN03420 EQU   *                        GET EOV WORKAREA         A48604 29340002
*                                                                Y02080 29390002
* SAVE REGISTERS 2-12 IN SVRB EXTENDED SAVE AREA                 Y02080 29440002
*                                                                Y02080 29442002
         L     RF,CVTPTR                GET POINTER TO CVT       Y02080 29444002
         L     RF,CVTTCBP-CVT(,RF)      GET TCB WORDS            Y02080 29446002
         L     RF,K4(,RF)               TCB ADDRESS              Y02080 29448002
         L     RF,K0(,RF)               POINTER TO SVRB          Y02080 29448402
*                                                                Y02080 29448802
         MODESET EXTKEY=SUPR            SUPR KEY TO STM IN SVRB  Y02082 29449202
         IECRES GET,PREFIX=EOV,LV=EOVSIZE,STM=(2,12,96(15)),     Y02080*29450002
               A=(RDCB)                                                 29500002
*                                                                       29600021
*        IF REG 0 IS NONZERO, IT IS BECAUSE THE CALLER HAS       YM3185 29650002
*        ENQUEUED EXCLUSIVELY ON THE TIOT. THIS MUST NOT BE      YM3185 29652002
*        ALLOWED TO GO UNNOTICED.                                YM3185 29654002
*                                                                       29656002
         LTR   R0,R0                    IS R0 ZERO               YM3185 29658002
         BNZ   EIN05160                 BRANCH IF NO             YM3185 29658402
*                                                                       29658802
         LR    RCORE,R1                                                 29660021
         LA    RWTG,DXXAREA             GET POINTER TO WTG TABLE Y02134 29662002
         L     RF,DXXPREFX              GET PREFIX PTR           Y02144 29662102
         L     RF,IECRRPRM-IECPREFX(,RF) GET RRPLIST PTR         Y02144 29664002
         USING RRPLIST,RF                                        Y02144 29666002
         MVI   RRFUNCTN,RRFFEOV         INDICATE FEOV FUNCTION   Y02144 29668002
         ST    RF,DXATCOM3              SAVE RRPLIST PTR IN W/A  Y02144 29668402
         DROP  RF                                                Y02144 29668802
         EJECT                                                          29668902
         IECRES LOAD,PREFIX=DXXPREFX,MODNM=FEOV,BRANCH=NO        Y02080X29669202
                                        GIVE OPT TRACE A SHOT    Y02080 29669602
         IECRES INIT,DEB=YES,PREFIX=DXXPREFX,STM=(2,12,DXXPREFX) Y02134 29670002
         BR    R8                       RETURN FROM REQUEST FOR  A48604 29704021
*                                       ..EOV WORK AREA                 29708021
*                                                                       29712021
EIN03450 EQU   *                        EXIT IF INIT FAILED      A48604 29716002
         CLI   DXWCOPYE,K0              WAS INIT SUCCESSFUL      Y02082 29716302
         BE    EIN03475                 BRANCH IF YES            Y02082 29716702
EIN03460 EQU   *                        FREE EOV WORKAREA, EXIT  Y02082 29716802
         IECRES FREE,PREFIX=EOV,A=(RCORE)                        Y02134*29720602
                                        R15 STILL IS SAVE AREA   Y02134 29722402
*                                                                Y02080 29726002
*        RETURN TO CALLER                                        Y02080 29727802
*                                                                Y02080 29729602
         IECRES EXIT                    RETURN                   Y02080 29731402
         EJECT                                                          29733202
EIN03475 EQU   *                        CHECK FOR SECURITY INTRF YM1320 29749802
         LA    RWTG,DXXAREA             GET PNTR TO WTG TABLE    YM1418 29749902
         LA    RWTGC,DXXENTRY           GET PNTR TO WTG ENTRY    YM1418 29750202
         L     RF,DXDSAB                GET DSAB ADDRESS         YM1320 29751802
         USING DSAB,RF                  ADDRESS DSAB             YM1320 29753802
         TM    DSABFLG4,DSABCKSI        DS SECURITY INTERFACE ON Y02083 29755802
         BNO   EIN03480                 NO  CONTINUE             YM1320 29757802
         DROP  RF                       DSAB ADDRESSABILITY      YM1320 29758202
*********************************************************************** 29762602
*              ISSUE ABEND 937-18 UNAUTHORIZED USER ATTEMPTING        * 29764602
*              TO FORCE END OF VOLUME ON A CHECKPOINT DATA SET.       * 29765002
*********************************************************************** 29765402
         LA    R0,EABD242               LOAD INTERNAL ABEND CD   Y02083 29765502
         DMABCOND (R0),ABCD0P,RES=NO,REGSAVE=YES SETUP TO ABEND  YM1320 29765602
         B     EIN05120                 GO TO XCTL               YM1320 29765702
         EJECT                                                          29779402
EIN03480 EQU   *                        END CHKPT D/S TEST       YM1320 29794502
         LA    RWTG,DXXAREA             GET PNTR TO WTG TABLE    YM1320 29808202
         LA    RWTGC,DXXENTRY           GET PNTR TO WTG ENTRY    YM1320 29821902
         XR    RD,RD                    CLEAR FOR IC INST        Y02134 29835602
         MODESET KEYADDR=DXUKEY,WORKREG=13 USER KEY              Y02134 29849302
         NI    DCBOFLGS,K255-DCBOBUSY   TURN OFF BUSY BIT        Y02134 29863002
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 29876702
         SRL   RD,K4                    PUT KEY IN LOW 4 BITS    Y02082 29890402
*                                                                       29904102
*        GET CALLER KEY SAVE AREA WITH WHICH TO INTERFACE WITH          29917802
*        THE SEQUENTIAL ACCESS METHOD ROUTINES                          29931502
*                                                                       29945202
         IECRES GET,LV=72,KEY=(RD),PREFIX=NO,STM=(2,14,DXXPREFX) Y02082*29958902
                                        GET USER SAVE AREA       Y02082 29972602
*                                                                       29986302
         LR    RD,R1                    SET UP FOR QSAM SAVE AREA       30000021
         EJECT                                                          30400002
         DEBCHK (RDCB)                  VALIDATE DEB             Y01021 30870002
         LR    RDEB,R1                  LOAD VERIFIED DEB ADDR   Y01021 30900000
*                                                                       30960037
         L     RC,DCBIOBA               GET CURRENT IOB ADDRESS         31000021
         LA    RC,K0(RC)                CLEAR HI BYTE                   31200021
         TM    DEBOPATB,DEBOPUPD        OPEN FOR UPDATE?         Y02134 31400002
         BNO   EIN03500                 IF NOT, BRANCH                  31600021
         TM    DEBOPATB,K15-DEBOPUPD    MAYBE--TEST FURTHUR      Y02134 31800002
         BZ    EIN03700                 YES, BRANCH                     32000021
*                                       NO, CONTINUE                    32200021
EIN03500 EQU   *                        NOT UPDATE-CHECK OUTPUT         32400002
         TM    DEBOPATB,DEBOPOUT        WAS IT USED FOR A WRITE  Y02134 32600002
         BNO   EIN04800                 NO BRANCH                       32800021
*                                                                       33000021
EIN03600 EQU   *                        OUTPUT-CHECK QSAM               33200002
         TM    DCBCIND2,DCBC2QSM        DCB USING QSAM                  33400021
         BNO   EIN04300                 NO, BRANCH.                     33600021
*                                                                       33610002
*        QSAM OUTPUT - SETUP FOR TRUNC ROUTINE                          33650002
*                                                                       33660002
         OI    DCBCIND2,DCBC2FEO        TURN ON FEOV BIT         A35349 33700021
         LR    R1,RDCB                  DCB ADDR. IN PROPER REG.-1      34400021
*                                                                       34600021
         MODESET EXTKEY=DATAMGT         GET IN DM KEY TO STORE   Y02082 34850002
         LA    R0,BRCODE                SAVE ENTRY POINT FOR     M0189  34920002
*                                       SYNCH                    M0189  34930021
         BAL   RET,EIN05150             GET PTR TO FEOV SVRB     M0189  34940021
         USING RBSECT,RF                                         M0189  34950021
         MODESET EXTKEY=SUPR            SVRB KEY                 Y02082 34952002
         STM   R2,RC,RBEXSAVE           SAVE REGS 2-12 IN SVRB   M0189  34960021
*                                       EXTENDED SAVE AREA              34970021
         CLI   DXUKEY,X80               IS CALLER IN SYSTEM KEY  Y02082 34970402
         BNL   EIN03620                 BRANCH IF NO             Y02082 34970802
         EJECT                                                          34970902
         MODESET KEYADDR=DXUKEY,WORKREG=14 ASSUME CALLER'S KEY   Y02082 34971202
         LM    R2,R8,RBGRS2             RESTORE USER REGS 2-8    Y02082 34971602
         LR    RF,R0                    INITIALIZE EXIT ADDRESS  Y02082 34972602
         BALR  RET,RF                   LINK TO TRUNC ROUTINE    Y02082 34973602
         MODESET EXTKEY=DATAMGT         ASSUME DATA MGT KEY      Y02082 34974602
         BALR  RET,0                    ESTABLISH ADDRESSABILITY Y02082 34975602
         USING *,RET                    BASE FOR NEXT BRANCH     Y02080 34976002
         B     EIN03630                 BRANCH TO RESTORE REGS   Y02082 34976602
         DROP  RET                      BASE NOT NEEDED AGAIN    Y02080 34977002
EIN03620 EQU   *                        SETUP SYNCH              Y02082 34977602
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 34982002
         LM    R2,R8,RBGRS2             RESTORE USER REGS 2-8    Y02082 34984002
*                                       THIS IS NECESSARY IN CASE       34990021
*                                       THE ACCESS METHOD ROUTINES      35000021
*                                       ISSUE EOV, SO THAT EOV          35010021
*                                       CAN FIND THE USER REGS          35020021
         DROP  RBASE                                             M0189  35030021
         LR    RF,R0                    INITIALIZE R15 FOR SYNCH M0189  35040021
         DROP  RF                                                M0189  35050021
         SYNCH (15)                     LINK TO TRUNC            M0189  35060021
         EJECT                                                          35060402
EIN03630 EQU   *                        RETURN FROM TRUNC        Y02082 35061002
         BALR  RET,0                    SET UP ADDRESSABILITY           35062000
         USING *,RET                    BASE FOR NEXT BRANCH     Y02080 35062102
         BAL   RET,EIN05150             GET SVRB PTR                    35062402
         DROP  RET                      BASE NOT NEEDED          Y02080 35112402
         USING RBSECT,RF                                         M0189  35130021
         LM    R2,RC,RBEXSAVE           RESTORE REGS 2-12        M0189  35140021
         DROP  RF                                                M0189  35150000
         DEBCHK (RDCB)                  VALIDATE DEB             Y01021 35170002
         LR    RDEB,R1                  RESTORE VALID DEB ADDR   Y01021 35192000
         LA    R1,DEBBASIC-DEBXTNP      OFFSET TO EXTENSION      Y02134 35196302
         SR    RDEB,R1                  RDEB POINTS TO EXT. ADDR Y02134 35196602
         USING DEBXTNP,RDEB                                      Y02134 35196902
         MVC   DXDEBXAD,DEBXTNP         UPDATE DEB EXT ADDR      Y02134 35197202
         LA    RDEB,DEBBASIC            RELOAD RDEB TO DEB START Y02134 35197502
         USING DEBBASIC,RDEB                                     Y02134 35197802
         MVC   DXUCBADR+K1(L'DXUCBADR-K1),DEBSUCBA+K1 UPDATE UCB        35198202
         USING EIN03200,RBASE                                    M0189  35198800
*                                                                       35200021
*  ISSUE EXTRA PUT TO WRITE LAST RECORD IF PUT LOCATE                   35210037
*                                                                       35220037
         MODESET KEYADDR=DXUKEY,WORKREG=1 CALLER'S KEY           Y02082 35250002
*                                                                       35400021
         OI    DCBCIND2,DCBC2FEO        TURN ON FEOV BIT        SA52460 35450021
         TM    DCBMACRF+K1,K20          DCB USING LOCATE MODE           35600021
         BZ    EIN03650                 YES BRANCH                      35800021
         TM    DEBOPATB,DEBOPUPD        OPEN FOR UPDATE?         Y02134 36000302
         BNO   EIN03900                 IF NOT, BRANCH                  36200021
         TM    DEBOPATB,K15-DEBOPUPD    MAYBE--TEST FURTHUR      Y02134 36200302
         BNZ   EIN03900                 NOT, BRANCH                     36600021
         EJECT                                                          36800002
EIN03650 EQU   *                        LOCATE MODE/UPDATE       M0189  37000002
         LR    R1,RDCB                  GET DCB ADDESS IN PROPER REG    37200021
*                                                                       37400021
         BAL   RET,EIN05150             GET PTR TO FEOV SVRB     M0189  37500021
         USING RBSECT,RF                                         M0189  37508021
         MODESET EXTKEY=SUPR            SVRB KEY                 Y02082 37510002
         STM   R2,RC,RBEXSAVE           SAVE REGS 2-12 IN SVRB   M0189  37516021
*                                       EXTENDED SAVE AREA              37524021
         MODESET KEYADDR=DXUKEY,WORKREG=2  ASSUME CALLERS KEY    Y02082 37524202
         CLI   DXUKEY,X80               IS CALLER IN SYSTEM KEY  Y02082 37525002
         BNL   EIN03670                 BRANCH IF NO             Y02082 37526002
         LM    R2,R8,RBGRS2             RESTORE USER REGS 2-8    Y02082 37528002
         L     RF,DCBPUT-IHADCB(,R1)    GET ADDR OF PUT ROUTINE  Y02082 37529002
         BALR  RET,RF                   LINK TO PUT ROUTINE      Y02082 37530002
         BALR  RET,0                    ESTABLISH ADDRESSABILITY Y02082 37531002
         USING *,RET                    BASE FOR NEXT BRANCH     Y02080 37531402
         B     EIN03680                 BRANCH TO RESTORE REGS   Y02082 37532002
         DROP  RET                      BASE NOT NEEDED          Y02080 37532102
EIN03670 EQU   *                        SETUP FOR SYNCH          Y02082 37532202
         LM    R2,R8,RBGRS2             RESTORE USER REGS 2-8    M0189  37534002
         DROP  RBASE                                             M0189  37540021
*                                       THIS IS NECESSARY IN CASE       37548021
*                                       THE ACCESS METHOD ROUTINES      37556021
*                                       ISSUE EOV, SO THAT EOV          37564021
*                                       CAN FIND THE USER REGS          37572021
         DROP  RF                                                M0189  37588021
         L     RF,DCBPUT-IHADCB(,R1)    GET ADDR OF PUT ROUTINE  Y02082 37589002
         SYNCH (15)                     LINK TO PUT IN PP STATE  M0189  37600021
         EJECT                                                          37600402
EIN03680 EQU   *                        RETURN FROM PUT ROUTINE  Y02082 37601002
         BALR  RET,0                    ESTABLISH ADDRESSABILITY        37660000
         USING *,RET                    BASE FOR NEXT BRANCH     Y02080 37670002
         BAL   RET,EIN05150             GET SVRB PTR             M0189  37700002
         DROP  RET                      BASE NOT NEEDED          Y02080 37702002
*                                       RET IS USED AS BASE REG         37709021
*                                       FOR THIS INSTRUCTION BECAUSE    37718021
*                                       UPON RETURN FROM SYNCH,         37727021
*                                       IT IS POINTING HERE AND RBASE   37736021
*                                       HAS NOT BEEN REINITIALIZED      37745021
         USING RBSECT,RF                                         M0189  37754021
         LM    R2,RC,RBEXSAVE           RESTORE REGS 2-12        M0189  37758000
         DROP  RF                                                M0189  37760000
         LR    RET,R1                   SAVE RECORD ADDR         Y01021 37764000
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 37774002
         DEBCHK (RDCB)                  VALIDATE DEB             Y01021 37784002
         LR    RDEB,R1                  LOAD VALID DEB ADDRESS   Y01021 37790000
         LA    R1,DEBBASIC-DEBXTNP      OFFSET TO EXTENSION      Y02134 37794702
         SR    RDEB,R1                  RDEB POINTS TO EXT. ADDR Y02134 37795002
         USING DEBXTNP,RDEB                                      Y02134 37795302
         MVC   DXDEBXAD,DEBXTNP         UPDATE DEB EXT ADDR      Y02134 37795602
         LA    RDEB,DEBBASIC            RELOAD RDEB TO DEB START Y02134 37795902
         USING DEBBASIC,RDEB                                     Y02134 37796202
         MVC   DXUCBADR+K1(L'DXUCBADR-K1),DEBSUCBA+K1 UPDATE UCB        37796602
         USING EIN03200,RBASE                                    M0189  37798000
         LR    R1,RET                   RESTORE RECORD ADDR      Y01021 37802002
         MODESET KEYADDR=DXUKEY,WORKREG=15 CALLER'S KEY          Y02082 37810002
         OI    DCBCIND2,DCBC2FEO        TURN ON FEOV BIT        SA52460 37850021
         TM    DCBRECFM,DCBRECUN        U RECORDS USED                  38000021
         BC    9,EIN03800               YES BRANCH                      38200021
         TM    DCBRECFM,DCBRECF         U OR F RECORDS USED      YM5563 38400037
         BO    EIN03800                 YES BRANCH                      38600021
         LA    R0,K4                    GET CONSTANT OF FOUR            39000021
         SR    R1,R0                    REDUCE RECORD ADDRESS BY FOUR   39200021
         XC    K0(K6,R1),K0(R1)         ZERO LARGE AND SMALL LL FIELDS  39600021
         MVI   K1(R1),K4                STORE LL OF 4 IN BUFFER         39800021
         B     EIN03900                 BR TO BACK UP IOB PTR           40000021
         EJECT                                                          40200002
EIN03700 EQU   *                        TEST FOR FEOV REPOSITIONING     40400002
*        PCI AND FEOV REPOSITIONING ARE MUTUALLY EXCLUSIVE       YM1194 40450002
         TM    DCBCIND2,DCBC2CHN        IS PCI BEING USED        YM1194 40500002
         BO    EIN03750                 BRANCH IF YES-DCBIOBAD   YM1194 40550002
*                                       TEST IS INVALID          YM1194 40560002
         CLC   DCBIOBAD,MASKFLAG        IS THIS REPOSITIONING           40600021
*                                       FEOV                            40800021
         BNE   EIN05100                 YES,REPOSITIONING MODULE        41000021
EIN03750 EQU   *                        NOT FEOV REPOSITIONING   YMRELE 41050002
         OI    DCBCIND2,DCBC2FEO        SET FEOV MODE ON                41200021
         B     EIN03600                 BR TO QSAM CHECK                41400021
*                                                                       41600021
EIN03800 EQU   *                        UPDATE RECAD                    41800002
         ST    R1,DCBRECAD              STORE IN DCB                    42000021
*                                                                       42200021
* MUST BACK UP IOB AS PUT LOCATE WILL ADVANCE IOB TO NEXT. IN THE       42400021
* CASE OF COBOL THEY ARE AHEAD OF THEMSELVES BY ONE PUT LOCATE          42600021
* AND DO NOT WISH TO OUTPUT. THEY STOP PUT LOCATE BY SETTING            42800021
* RECAD TO START OF BUFFER WHICH CAUSES PUT TO FIND A RECORD            43000021
* LENGTH OF ZERO AND RETURN WITHOUT ADVANCING THE IOB ADDRESS.          43200021
*                                                                       43400021
EIN03900 EQU   *                        GET IOBS                        43600002
         L     RC,DCBIOBA               GET ADDR OF IOB PAST THE        44000021
*                                       LAST ONE SCHEDULED FOR          44200021
*                                        SIMPLE-PUT-MOVE-VARIABLE       44400021
         LA    RC,K0(RC)                                                44600021
         LR    R7,RC                    SAVE IOBA                       44800021
         LR    RET,RC                   SAVE IOBA                       45000021
*                                                                       45200021
EIN04000 EQU   *                        TEST FOR COMPLETE               45400002
         L     R7,K0(R7)                GET NEXT IOB                    45800021
         LA    R7,K0(R7)                GET ADDR                        46000021
         TM    K4(R7),ECBCOMPL          IS IOB COMPLETED                46200021
         BO    EIN04100                 YES CHECK IF IN ERROR           46400021
         L     R1,K12(R7)               NO GET ECB ADDRESS              46600021
         WAIT  ECB=(1)                  WAIT ON IOB                     46800021
         EJECT                                                          47000002
EIN04100 EQU   *                        TEST FOR UPDATE                 47200002
         TM    DEBOPATB,DEBOPUPD        OPEN FOR UPDATE?         Y02134 47400302
         BNO   EIN04150                 BR IF NOT               SA53132 47500021
         TM    DEBOPATB,K15-DEBOPUPD    MAYBE--TEST FURTHUR      Y02134 47500302
         BNZ   EIN04150                 BR IF NOT               SA53132 47560021
         SR    R5,R5                    CLEAR REG               SA53132 47570021
         IC    R5,DCBOFFSR              OFFS TO READ CCW        SA53132 47580021
         AR    R5,R7                    ADDR OF READ CCW        SA53132 47590021
         SH    R5,CONST56               END OF WRITE CHAN PGM   SA53132 47592021
         CLI   K16(R5),CCWSTSEC         RPS CHAN PGM?           SA53132 47594037
         BE    EIN04120                 BR IF YES               SA53132 47596021
         AH    R5,CONST8                ADJUST FOR NON-RPS PGM  SA53132 47598021
* THE PUT MODULE IGG019AE TURNED OFF THE COMMAND CHAIN BIT TO   SA53132 47598421
* PREVENT READING AFTER FEOV WAS ISSUED.IT MUST BE RESTORED NOW.SA53132 47598821
EIN04120 OI    K4(R5),CCWCMDCH          TURN ON COMM CHAIN BIT  SA53132 47599237
EIN04150 EQU   *                        NOT UPDATE              SA53132 47599602
         CR    R7,RC                    IS THE NEXT IOB = IOBA          48000021
         BE    EIN04154                 YES,TEST COMPLETION      YM5563 48200002
         LR    RET,R7                   SAVE THIS IOB BEFORE NEXT       48400021
*                                        IS OBTAINED                    48600021
         B     EIN04000                 GO TRY AGAIN                    48800021
*                                                                       49000021
EIN04154 EQU   *                        TEST FOR COMPLETION     YM5563  49050002
         CLI   K4(RC),ECBCOD7F          IOBA IN ERROR?          YM5563  49100002
         BE    EIN04155                 NO, TEST PREVIOUS IOB   YM5563  49150002
         LR    RET,RC                   SET IOB TO PREVIOUS     YM5563  49160002
EIN04155 EQU   *                        TEST PREVIOUS IOB       YM5563  49170002
         CLI   K4(RET),ECBCOD7F         PREVIOUS IOB IN ERROR?  YM5563  49180002
         BE    EIN04200                 NO, ALL DONE            YM5563  49190002
         CR    RET,RC                   TEST IF IOB HAS BEEN    YM5563 C49192002
                                        BACKED UP               YM5563  49196002
         BE    EIN04156                 BRANCH IF NO            YM5563  49198002
         MODESET EXTKEY=DATAMGT         GET IN D.M. KEY         YM3150  49198102
         MVI   DXCCW1,ECBCOD7F          SET INDICATOR           YM5563  49198402
         MODESET KEYADDR=DXUKEY,WORKREG=7 RETURN TO CALLER KEY  YM3150  49198502
EIN04156 EQU   *                        IOB NOT BACKED UP       YM5563  49198802
         IC    R7,DCBIOBA               GET HIGH ORDER BYTE     YM5563  49199202
         SLL   R7,K24                   SHIFT TO HIGH BYTE      YM5563  49199602
         OR    RET,R7                   PUT INTO REG 14         YM5563  49199702
         ST    RET,DCBIOBA              SET DCBIOBA TO THE      YM5563 C49199802
                                        CORRECT IOB             YM5563  49249802
         LA    RET,K0(RET)              CLEAR  HIGH ORDER BYTE  YM5563  49299802
         LR    RC,RET                   INITIALIZE REGISTER     YM5563  49309802
         LR    R7,RC                    SAVE IOB                YM5563  49319802
EIN04157 EQU   *                        SEARCH IOB'S            YM5563  49329802
         L     R7,K0(R7)                GET NEXT IOB            YM5563  49339802
         LA    R7,K0(R7)                GET ADDRESS             YM5563  49341802
         CLI   K4(R7),ECBCOD7F          IS IOB IN ERROR         YM5563  49343802
         BNE   EIN04400                 YES GO TO ERROR ROUTINE YM5563  49345802
         LR    RET,R7                   SAVE PREVIOUS IOB       YM5563  49347802
         B     EIN04157                 LOOP TO FIND ERROR      YM5563  49348202
         EJECT                                                          49348602
EIN04200 EQU   *                        TEST FOR UPDATE                 49349802
         L     RC,DCBIOBA               BE SURE RB HAS CURRENT IOB ADDR 49400021
         L     RDEB,DCBDEBAD            LOAD DEB ADDR            Y02082 49750002
*                                                                       49800021
         TM    DEBOPATB,DEBOPUPD        OPEN FOR UPDATE?         Y02134 49800302
         BNO   EIN04300                 IF NOT, BRANCH.                 50200021
         TM    DEBOPATB,K15-DEBOPUPD    MAYBE--TEST FURTHUR      Y02134 50200302
         BZ    EIN04600                 YES, BRANCH                     50600021
*                                                                       50800021
EIN04300 EQU   *                        DSAB OUTPUT ENTERS HERE         51000002
         ST    RC,K4(K0,RC)             SET ADDRESS OF THIS IOB FOR EOV 51400021
*                                       IT WILL NOT RESCHEDULE ANY FOR  51600021
*                                       OUTPUT DATA SET AFTER FEOV.     51800021
         MVI   K4(RC),ECBCOD7F          SET THIS IOB COMPLETE, NO ERROR 52000021
         B     EIN05100                 GO LINK TO EOV.                 52400021
         EJECT                                                          52450002
EIN04400 EQU   *                        ENTER ERROR CHECKING ROUTINE    52600002
*                                                                       52800021
*              FIND THE ERROR IOB AND GO TO THE ERROR ROUTINE WITH THE  53000021
*              ADDRESS OF THE IOB PREVIOUS TO IT                        53200021
*                                                                       53400021
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 53450002
         STM   R0,RF,K8(RCORE)          SAVE ALL REGS                   53700021
         MODESET EXTKEY=SUPR            SVRB KEY                 Y02082 53750002
*                                                                       54000021
         LR    R1,RDCB                  STORE DCB IN PROPER REG 1       54600021
         LR    R0,RET                   SAVE IOB ADDR            M0189  54800021
         BAL   RET,EIN05150             GET PTR TO FEOV SVRB     M0189  54820021
         USING RBSECT,RF                                         M0189  54840021
*                                       REGS 2-8 BEFORE SYNCHING        54860021
         STM   R2,RC,RBEXSAVE           SAVE REGS 2-12 IN SVRB   M0189  54880021
*                                       EXTENDED SAVE AREA              54900021
         MODESET KEYADDR=DXUKEY,WORKREG=9 CALLER'S KEY           Y02082 54970002
         MVC   K28(K44,RD),RBGRSAVE     MOVE USER REGS 0-8 TO    M0189  54980021
*                                       SAVE AREA PASSED TO SAM         55000021
*                                       SO THAT IF SAM ISSUES           55020021
*                                       EOV, THE RIGHT REGS WILL        55040021
*                                       BE SWAPPED                      55060021
         LM    R9,RD,RBGRS9             RESTORE USERS REGS 9-13 SA57952 55070000
*                                       SO THAT IF SAM ISSUES EOV       55072000
*                                       AND A SYNAD EXIT IS TAKEN       55074000
*                                       THE USER WILL RECEIVE HIS       55076000
*                                       REGS                            55078000
         DROP  RF                                                M0189  55080021
         L     RF,DCBPERR-IHADCB(,R1)   GET PUT ERR RTN ADDR     M0189  55100021
         EJECT                                                          55102002
         CLI   DXUKEY,X80               IS CALLER IN USER KEY    Y02082 55110002
         BNL   EIN04540                 BRANCH IF YES            Y02082 55120002
         LR    RBASE,R0                 PUT IOB ADDR IN PROPER   Y02082 55130002
*                                       REGISTER                 Y02082 55140002
         DROP  RBASE                                             Y02082 55142002
         BALR  RET,RF                   BRANCH TO PUT ERROR RTN  Y02082 55150002
         BALR  RET,0                    ESTABLISH ADDRESSABILITY Y02082 55160002
         USING *,RET                    BASE FOR NEXT BAL        Y02080 55162002
         B     EIN04560                 BRANCH TO RESTORE REGS   Y02082 55170002
         DROP  RET                      BASE NOT NEEDED          Y02080 55170402
EIN04540 EQU   *                        SYNCH                    Y02082 55180002
         USING EIN03200,RBASE                                    Y02082 55190002
         MODESET EXTKEY=SUPR            SYSTEM KEY FOR SYNCH     Y02082 55310002
         LR    RBASE,R0                 PUT IOB ADDR IN PROPER   Y02082 55320002
*                                       REGISTER                 Y02082 55330002
         DROP  RBASE                                             Y02082 55340002
         SYNCH (15)                     LINK TO PERR IN PP STATE        55350000
*                                                                       55400021
*          AT THIS POINT CONTROL GOES TO THE PUT ERROR ROUTINE          55600021
*        TO DETERMINE THE CAUSE OF THE EXCEPTIONAL CONDITION.  IF MORE  55800021
*        SPACE IS REQUIRED, THE VOLUME SWITCHING ROUTINES GET CONTROL.  56000021
*        CONTROL WILL RETURN FROM THE PUT ERROR ROUTINE WHEN ALL        56200021
*        OUTSTANDING REQUESTS HAVE BEEN RESCHEDULED.  IF THE            56400021
*        USER GETS A SYNAD ENTRY, THIS ROUTINE MAY NOT                  56600021
*        REGAIN CONTROL.                                                56800021
         EJECT                                                          57000002
EIN04560 EQU   *                        RETURN FROM PERR         Y02082 57200002
         BALR  RET,0                    ESTABLISH ADDRESSABILITY        57300000
         USING *,RET                    BASE FOR NEXT BAL        Y02080 57350002
         BAL   RET,EIN05150             GET SVRB PTR             M0189  57400002
*                                       RET IS USED AS BASE REG         57420021
*                                       FOR THIS INSTRUCTION BECAUSE    57440021
*                                       UPON RETURN FROM SYNCH,         57460021
*                                       IT IS POINTING HERE AND RBASE   57480021
*                                       HAS NOT BEEN REINITIALIZED      57500021
         DROP  RET                      BASE NOT NEEDED          Y02080 57502002
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 57510002
         USING RBSECT,RF                                         M0189  57520021
         L     RCORE,RBEXSAVE+K4*(R4-R2) RESTORE REG 4          SA54463 57530002
         LM    R0,RF,K8(RCORE)          RESTORE ALL REGS        SA54463 57540000
         DROP  RF                                                M0189  57550000
         DEBCHK (RDCB)                  VERIFY DEB               Y01021 57560100
         LR    RDEB,R1                  LOAD VERIFIED DEB        Y01021 57580100
         LA    R1,DEBBASIC-DEBXTNP      OFFSET TO EXTENSION      Y02134 57592302
         SR    RDEB,R1                  RDEB POINTS TO EXT. ADDR Y02134 57592602
         USING DEBXTNP,RDEB                                      Y02134 57592902
         MVC   DXDEBXAD,DEBXTNP         UPDATE DEB EXT ADDR      Y02134 57593202
         LA    RDEB,DEBBASIC            RELOAD RDEB TO DEB START Y02134 57593502
         USING DEBBASIC,RDEB                                     Y02134 57593802
         MVC   DXUCBADR+K1(L'DXUCBADR-K1),DEBSUCBA+K1 UPDATE UCB        57595802
         USING EIN03200,RBASE                                    M0189  57596000
         LR    R7,RET                   LOAD PREVIOUS IOB       SA54463 57600000
         MODESET KEYADDR=DXUKEY,WORKREG=1 CALLER'S KEY           Y02082 57650002
         MVC   DCBIOBA+K1(K3),K50+K7(RCORE) MOVE IOB ADDR FROM  SA54463 57800002
*                                       SAVE AREA TO DCB        SA54463 57900000
         CLI   DXCCW1,ECBCOD7F          TEST IF BACK UP SW SET  YM5563  57950002
         BNE   EIN04000                 BRANCH IF NOT SET       YM5563  58000002
         L     R1,DCBIOBA               GET IOBA ADDRESS        YM5563  58100002
         MVC   DCBIOBA+K1(K3),K1(R1)    SET IOBA TO NEXT        YM5563  58150002
         MODESET EXTKEY=DATAMGT         SWITCH TO DATAMGT KEY    YM3874 58155002
         MVI   DXCCW1,K0                CLEAR INDICATOR         YM5563  58160002
         MODESET KEYADDR=DXUKEY,WORKREG=1  RTN TO CALLER'S KEY   YM3874 58165002
         B     EIN03900                 CHECK IOB'S ON QUEUE    YM5563  58170002
         EJECT                                                          58200002
EIN04600 EQU   *                        SIMULATE END OF BUFFER          58600002
         MVC   DCBRECAD+K1(K3),DCBEOBAD+K1  SIMULATE EOB CONDITION      58800021
*                                                                       59000021
*  THIS WILL CAUSE THE UPDATE GET ROUTINE TO SCHEDULE THE LAST          59200021
*    REMAINING IOB BEFORE GIVING THE USER THE FIRST RECORD ON THE NEW   59400021
*     VOLUME                                                            59600021
*                                                                       59800021
         SR    RPAR,RPAR                CLEAR REG                       60000021
         SR    RET,RET                  CLEAR REG                       60200021
         IC    RPAR,DCBWCPO             GET WRITE CHANNEL PROG. OFFSET  60400021
         IC    RET,DCBWCPL              GET WRITE CHANNEL PROG. LENGTH  60600021
         SLL   RET,K3                   CHANGE DB WDS TO BYTES          60800021
         LA    RPAR,K8(RPAR,RET)        COMBINE AND ADD 8 TO POINT      61000021
*                                         TO THE CP READ SEQUENCE       61200021
*                                                                       61400021
* RC HAS ADDRESS OF CURRENT IOB                                         61600021
*                                                                       61800021
         LA    RC,K0(RC)                CLEAR HI BYTE FOR COMPARISON.   62000021
         LR    R8,RC                    COPY ADDR FOR IOB MOD LOOP      62200021
*                                                                       62400021
EIN04700 EQU   *                        UPDATE IOB                      62600002
         AR    RPAR,R8                  ADD IOB ADDR TO RD CP OFFSET    62800021
         ST    RPAR,K24(R8)             PLACE IN CHANNEL POINTER        63000021
         OI    K0(R8),IOBREAD           TURN ON ONLY READ FLAG          63200021
*                                                                       63400021
         SR    RPAR,R8                  RETURN R5 TO RD CP OFFSET       63600021
*                                                                       63800021
         L     R8,K0(R8)                LINK TO NEXT IOB                64000021
         LA    R8,K0(R8)                CLEAR HI BYTE FOR COMPARISON.   64200021
         CR    R8,RC                    WAS THIS IOB SET TO READ        64400021
         BE    EIN04300                 YES, BRANCH.                    64600021
         B     EIN04700                 NO                              64800021
         EJECT                                                          65000002
*  PURGE ALL INPUT I/O.  (IF BASM, ALL READS AND WRITES ARE SUPPOSED    65050037
*  TO HAVE ALREADY BEEN CHECKED.)                                       65100037
*                                                                       65200037
EIN04800 EQU   *                        INPUT ENTERS HERE               65400002
*        PURGE OPTIONS ARE -                                            65600037
*          1 = PURGE REQUESTS ASSOCIATED WITH THIS DEB ONLY,            65800037
*          1 = POST THE PURGED IOB'S,                          @ZA02215 66000037
*          0 = ALLOW ACTIVE I/O TO QUIESCE,                    @ZA02215 66200037
*          0 = PURGE ALL REQUESTS,                             @ZA02215 66400037
*          0 = NORMAL PURGE (NOT TCB LIST),                             66600037
*          0 = PURGE ALL QUEUES,                                        66800037
*          0 = PURGE BY DEB.                                            67000037
*                                                                       67400021
* SINCE A RESTORE IS NEVER DONE FOR TAPE DEVICES, WE WILL               67450037
* WAIT ON THE USERS IOB INSTEAD OF DOING A PURGE QUIESCE.               67455037
* WE ENTER HERE IN USERS KEY.                                           67460037
         TM    DCBDEVT,DCBDEVTP         IS IT TAPE             @ZA30750 67465037
         BZ    EIN04808                 BRANCH NO              @ZA30750 67470037
         TM    DCBCIND2,DCBC2CHN        CHAINED SCHEDULING     @ZA30750 67475037
         BNO   EIN04801                 BRANCH NO              @ZA30750 67480037
         L     RC,DCBIOBAD              GET CH SCHED IOB       @ZA30750 67485037
         LA    RC,0(RC)                 CLEAR HI BYTE          @ZA30750 67490037
         L     R1,K20(RC)               GET CH SCHED ECB       @ZA30750 67495037
         TM    0(R1),ECBPOST            IOB POSTED             @ZA30750 67500037
         BO    EIN04807                 YES CONTINUE           @ZA30750 67505037
         WAIT  ECB=(1)                  WAIT ON LIST           @ZA30750 67510037
         B     EIN04809                 CONTINUE               @ZA30750 67515037
EIN04801 L     RC,DCBIOBA               GET NORMAL IOB         @ZA30750 67520037
         LA    RC,0(RC)                 CLEAR HI BYTE          @ZA30750 67525037
         LR    RF,RC                    SAVE FOR COMPARE       @ZA30750 67530037
EIN04802 L     R1,K12(RC)               GET NORMAL ECB         @ZA30750 67535037
         TM    0(R1),ECBPOST            ECB POSED              @ZA30750 67540037
         BO    EIN04803                 YES CONTINUE           @ZA30750 67545037
         WAIT  ECB=(1)                  WAIT                   @ZA30750 67550037
EIN04803 L     RC,0(RC)                 GET NEXT IOB ADDR      @ZA30750 67555037
         LA    RC,0(RC)                 CLEAR HI BYTE          @ZA30750 67560037
         CR    RC,RF                    LAST IOB               @ZA30750 67565037
         BE    EIN04809                 YES CONTINUE           @ZA30750 67570037
         B     EIN04802                 TEST FOR COMPLETION    @ZA30750 67575037
EIN04808 MODESET EXTKEY=DATAMGT         DM KEY                 @ZA30750 67580037
         ST    RDEB,0(RCORE)            STORE DEB ADDRESS               67600021
         MVI   0(RCORE),X'C0'           OPTIONS TO PURGE WITH  @ZA02215 67800037
         XC    K4(K4,RCORE),K4(RCORE)   ZERO TCB ADDR / ECB FIELD       68000037
         LA    R0,DEBUSRPG              GET CHAINING ADDRESS     Y02134 68200002
         ST    R0,K8(RCORE)             STORE FOR PURGE                 68400021
*                                                                       69000021
         PURGE (RCORE)                  ISSUE PURGE SVC                 69400037
*                                                                       70200021
         WAIT  ECB=K4(RCORE)            WAIT FOR PURGE POST COMPLETE    70400037
*                                                                       71400021
EIN04807 MODESET KEYADDR=DXUKEY,WORKREG=1 CALLER'S KEY           Y02082 71450037
         ST    RC,K4(,RC)               PUT ADDR OF FIRST IOB TO BE     71600037
*                                       RESCHEDULED INTO ECB OF CURRENT 71800021
*                                       IOB, WHICH WILL BE THE LAST IOB 72000021
*                                       RESCHEDULED.                    72200021
*                                                                       72220037
*  TEST IF A TAPE MARK WAS ENCOUNTERED BY AN UNCHECKED QSAM GET,        72240037
*  BECAUSE THIS AFFECTS THE DISPOSITION POSITIONING OF THE TAPE.        72260037
*  THE PRIOR PURGE MUST BE QUIESCE AND POST SO THAT THIS TEST CAN       72280037
*  BE MADE.                                                    @ZA02215 72300037
*                                                                       72400021
EIN04809 TM    DCBIFLGS,DCBIFPIO        ERRORS ASSC WITH INPUT          72600037
         BNO   EIN05100                 NO BRANCH                       72800021
         TM    DCBCIND2,DCBC2QSM        IS DCB QSAM            @ZA02215 72810037
         BZ    EIN05100                 BR IF NO               @ZA02215 72820037
         TM    DEBOPATB,DEBOPOUT        WAS OPEN FOR INPUT     @ZA02215 72830037
         BNZ   EIN05100                 BR IF NO               @ZA02215 72840037
         L     RUCB,DEBSUCBA            GET UCB ADDRESS        @ZA02215 72850037
         CLI   UCBTBYT3,UCB3TAPE        IS THIS MAGNETIC TAPE  @ZA02215 72860037
         BNE   EIN05100                 BR IF NO               @ZA02215 72870037
*                                                                       73000037
         LR    RF,RC                    SAVE IOB ADDRESS       @ZA02215 73050037
*                                                                       73100037
EIN04900 EQU   *                        SKIP THROUGH IOBS        Y02082 73200002
         TM    K20(RC),CSWUNITX         TAPE MARK INDICATION     Y02082 73250002
         BO    EIN05000                 YES BRANCH                      73400021
*                                                                       73600021
         L     RC,0(,RC)                GET NEXT IOB           @ZA02215 73650037
         LA    RC,0(,RC)                CLEAR HI BYTE          @ZA02215 73700037
*                                                                       73750037
         CR    RF,RC                    ARE IOB ADDRS THE SAME @ZA02215 73800037
         BNE   EIN04900                 BR NO TO TEST NEXT IOB @ZA02215 74000037
         B     EIN05100                 BR TO NEXT FUNCTION    @ZA02215 74200037
*                                                                       75000037
EIN05000 EQU   *                        SET TAPE MARK READ BIT          75400002
         OI    DCBOFLGS,DCBOEOF         SET CONDITION FOR END OF VOLUME 76000037
         EJECT                                                          76100037
*                                                                       76200021
*  FREEMAIN 72 BYTE USER SAVE AREA USED FOR SAM PUT ROUTINES            76250037
*                                                                       76300037
EIN05100 EQU   *                        FREE SAVE AREA                  76400002
         LR    R1,RD                                                    76660021
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 76710002
         SR    RD,RD                    SR FOR IC                Y02082 76780002
         IC    RD,DXUKEY                KEY OF CORE TO FREE      Y02082 76790002
         SRL   RD,K4                    PUT KEY IN LOW 4 BITS    Y02082 76792002
         IECRES FREE,A=(1),LV=72,KEY=(RD),PREFIX=NO,             Y02082*76794002
               STM=(0,14,DXXPREFX)      FREE USER SAVE AREA      Y02082 76796002
         EJECT                                                          76798002
*                                                                       76798402
*        SET UP COMMUNICATION BIT FOR THE END OF VOLUME ROUTINES        76800021
*                                                                       77000021
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY              YM1303 77050002
         OI    DCBCIND2,DCBC2FEO        SET INDIC FOR NEXT EXEC EOV     77600021
         L     RDEB,DCBDEBAD            LOAD DEB ADDR            YM1303 77610002
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY         Y02082 77650002
*                                                                       77800021
         L     RUCB,DEBSUCBA            GET UCB ADDRESS          YM1303 77810002
         MVC   DXXMODID,MOD0Z3A         MOVE IN NAME             A48604 77840021
         MVC   DXXMODEP+K1(K3),MOD0Z3A+K2 AND TTR TO XCTL AREA   Y02080 77880002
*                                                                       77920021
EIN05120 EQU   *                        GET READY TO XCTL        A48604 77960002
         ST    R0,DXWORK1               SAVE R0 FROM IECRES CALL YM1320 77962002
         MODESET EXTKEY=DATAMGT         RETURN TO DM KEY IF NEED Y02082 77970002
         IECRES INIT,DCBCOPY=TOWKAR,PREFIX=DXXPREFX,             Y02082*77980002
               STM=(3,14,DXXPREFX)      PASS NEXT MOD COPIED DCB Y02082 77990002
         EJECT                                                          77990102
         L     R0,DXWORK1               REFRESH R0               YM1320 77990402
         CLI   DXWCOPYE,K0              WAS COPY OK              Y02082 77992002
         BE    EIN05130                 BRANCH IF YES            Y02082 77994002
         CLC   DXXMODID,ABEND2Z         GOING TO PROBLEM DET     Y02082 77996002
         BNE   EIN03460                 EXIT IF NO               Y02082 77998002
EIN05130 EQU   *                        SET FIRST LOAD BIT       Y02082 77998402
         CLC   DXXMODID,MOD0Z3A         GOING TO IFG0551F        Y02144 77999402
         BNE   EIN05140                 BR IF NO                 Y02144 77999602
         L     RF,DXATCOM3              GET RRPLIST PTR          Y02144 77999802
         USING RRPLIST,RF                                        Y02144 77999902
         OI    RRFLAGS2,RRFFIN1         SET 1ST LOAD COMPLETED   Y02144 78000002
         DROP  RF                                                Y02144 78000202
EIN05140 EQU   *                        TRANSFER CONTROL         Y02144 78000902
         MVC   DXXATTRB(K7),XCTLCN3A    SET UP FOR XCTL                 78001902
         MVC   DXXMODNM(K6),IGG3A       BASIC EOV MODULE NAME           78200002
         XR    RET,RET                  ZERO BRANCH REG          X02989 78362002
         LA    RWTG,DXXMODNM            GET ADDR OF MOD NAME     A48604 78400021
         IECRES LOAD,PREFIX=DXXPREFX,BRANCH=DIRECT               Y02134 79050002
         EJECT                                                          79100002
EIN05150 EQU   *                        GET SVRB ADDRESS         M0189  79220002
*                                                                       79230002
*        SUBROUTINE TO LOAD CURRENT SVRB ADDRESS INTO RF.               79232002
*        RETURN IS ON RET.                                              79234002
*                                                                       79236002
         L     RF,CVTPTR                ADDRESS OF CVT           Y02134 79240002
         L     RF,CVTTCBP-CVT(,RF)      TCB VECTORS              Y02134 79290002
         L     RF,K4(,RF)               CURRENT TCB ADDRESS      Y02134 79292002
         L     RF,TCBRBP-TCB(,RF)       PTR TO FEOV RB           M0189  79300021
         BR    RET                      RETURN TO CALLER         M0189  79320021
*                                                                       79350037
BRCODE   DS    0H                       TRUNC CALL               M0189  79370002
*                                                                       79400021
*        CALLING SEQUENCE TO ENTER TRUNC ROUTINE                        79450002
*                                                                       79452002
         L     RF,DCBPUT-IHADCB(,R1)    PUT ADDR FROM DCB        M0189  79460002
         USING PUTDSECT,RF              USING TO ENTER TRUNC     Y02080 79510002
         B     TRUNCRTN                 BRANCH TO TRUNC          M0189  79530002
         DROP  RF                       RF NOT NEEDED            Y02080 79540002
         SPACE 2                                                        79542002
EIN05160 EQU   *                        CALLER ENQED ON TIOT EXC YM3185 79550002
*                                                                       79552002
*   THE CALLER OF FEOV HOLDS THE TIOT RESOURSE EXCLUSIVELY.    @ZA29752 79554037
*   THIS SHOULD NEVER VALIDLY HAPPEN AND CANNOT BE ALLOWED.    @ZA29752 79556037
*                                                                       79558037
         SR    RF,RF                    ZERO REG               @ZA29752 79560037
         SR    RC,RC                    ZERO REG               @ZA29752 79562037
         LA    RF,K20                   RETURN CODE            @ZA29752 79564037
         L     RC,ABND50D               ABEND CODE             @ZA29752 79566037
         ABEND (RC),DUMP                                       @ZA29752 79568037
         EJECT                                                          79580002
*                                                                       79585037
*********************************************************************** 79590037
*                                                                       79595037
*        CONSTANTS                                                      79596037
*                                                                       79597037
ABND50D  DS    0F                                              @ZA29752 79598037
         DC    XL4'0000050D'                                   @ZA29752 79599037
IGG3A    DC    C'IFG055'                1ST 6 CHAR OF MOD NAME          79600021
MASKFLAG DC    F'1'                     MASK FOR IOBAD                  79800021
CONST8   DC    H'8'                     CONSTANT 8              SA53132 79850021
CONST56  DC    H'56'                    CONSTANT 56             SA53132 79900021
XCTLCN3A DC    X'C378'                  XCTL ATTR.-REENT.,REUSEABLE     80400021
*                                         NOT IN OV'LAY,NOT TEST,NOT    80600021
*                                         ONLY LOADABLE,BLOCK FORMAT,   80800021
*                                         EXECUTABLE,1 TEXT,COMPAT.,    81000021
*                                         ORIGIN AT 0,ENTRY PT.0,NO RLD 81200021
*                                         NO ESD,NO SYMBOL CARDS        81400021
         DC    X'0004000400'            TOTAL LENGTH  TEXT LENGTH       81600021
         DC    X'000000'                LENGTH OF WTG TABLE             81800021
SUBSYSAM DEBCHK AM=SUBSYS,MF=L          SUBSYSTEM ACCESS METHOD  Y02120*81810002
                                        TYPE IN DEBAMTYP         Y02120 81820002
         EJECT                                                          81870002
XCTLTA3A XCTLTABL  ID=(ABEND2Z,0P,MOD0Z3A,1F,FEOV,IGC0003A,      Y02080X82050002
               ABCD0P,0P),                                       Y02083X82052002
               SVC=055,BRT=YES,LENGTH=                           Y02080 82060002
         EJECT                                                          82110002
         IECDSECS DCB,ACB,UCB,IEZDEB,MAIN,CVT,TCB,WTG,PREFX,     Y02134*82200002
               TIOT,DSAB,                                        Y02083X82210037
               RB,RRPL,EXPAND=YES                                Y02144 82250002
PUTDSECT DSECT ,                        DSECT FOR TRUNC RTN      Y02080 82260002
         DS    F                        PUT ROUTINE              Y02080 82270002
         DS    F                        PUTX ROUTINE             Y02080 82280002
TRUNCRTN DS    F                        TRUNC ROUTINE            Y02080 82290002
         EJECT                                                          82300002
         IECEQU AOS=YES,IEZDEB=YES                               Y02134 82400002
         END                                                            82600021
