         TITLE 'GLOBLOCK FOR SET/FREE OF LOCAL/UCBLOCKS'    D11 ZA07645 00050001
         MACRO                                              D11 ZA07645 00100001
&LABEL   GLOBLOCK &FUNC,&REGS=,&RELATED=                    D11 ZA07645 00150001
.* REGS= 2 SYMBOLIC OR ACTUAL REGISTERS AVAIL FOR WORKREGS  D11 ZA07645 00200001
.* GENS GETLOCK LOCAL,UCBLOC ALGO,GETLOCK GLOBAL UCBLK      D11 ZA07645 00250001
.* ASSUMES THAT UCB DSECT (PREFIX=YES) IS ADDRESSIBLE       D11 ZA07645 00300001
.* DEPENDENT ON FOLLOWING DC STATEMENTS:                    D11 ZA07645 00350001
.* UCBLEN   DC    AL2(UCBBTB+L'UCBBTB-UCBOB+UCBCURPX) 2250UCBLENZA07645 00400001
.* UCBPRFXL DC    AL2(UCBCURPX)  UCB LOCKWORD PREFIX LEN                00450001
         LCLA  &NUM                                         D11 ZA07645 00500001
         LCLC  &WORK1,&WORK2,&MODE                          D11 ZA07645 00550001
         AIF   (T'&REGS NE 'O').REGSTHR                     D11 ZA07645 00600001
         MNOTE 12,'GLOBLOCK - NO WORKREGS GIVEN'            D11 ZA07645 00650001
         MEXIT                                              D11 ZA07645 00700001
.REGSTHR ANOP                                               D11 ZA07645 00750001
&NUM     SETA  N'&REGS                                      D11 ZA07645 00800001
         AIF   (&NUM EQ 2).REGSOK                           D11 ZA07645 00850001
         MNOTE 12,'GLOBLOCK - TWO (2) WORKREGS NOT GIVEN'   D11 ZA07645 00900001
         MEXIT                                              D11 ZA07645 00950001
.REGSOK  AIF   (T'&FUNC EQ 'O').NOFUNC                      D11 ZA07645 01000001
         AIF   (('&FUNC' NE 'OBTAIN') AND                              *01050001
                ('&FUNC' NE 'RELEASE')).INVFUNC             D11 ZA07645 01100001
         AIF   ('&LABEL' EQ '').NOLAB                       D11 ZA07645 01150001
&LABEL   EQU   *                                            D11 ZA07645 01200001
.NOLAB   AIF   ('&FUNC' EQ 'RELEASE').SKIPLOC               D11 ZA07645 01250001
*  GET LOCAL LOCK ........                                  D11 ZA07645 01300001
         SETLOCK OBTAIN,TYPE=LOCAL,REGS=USE,MODE=UNCOND,    D11 ZA07645*01350001
               RELATED=&RELATED                             D11 ZA07645 01400001
.SKIPLOC ANOP                                               D11 ZA07645 01450001
&WORK1   SETC  '&REGS(1)'           FIRST WORKREG           D11 ZA07645 01500001
&WORK2   SETC  '&REGS(2)'           SECOND WORKREG          D11 ZA07645 01550001
         SR    &WORK1,&WORK1       CLEAR FOR IC OF DEVNDX   D11 ZA07645 01600001
         IC    &WORK1,UCBDI        DEV INDEX                D11 ZA07645 01650001
         BCTR  &WORK1,0            DOWN BY ONE              D11 ZA07645 01700001
         MH    &WORK1,UCBLEN *2250UCBLEN=DISPL FROM 1STUCB  D11 ZA07645 01750001
         LR    &WORK2,RUCB         DUPE UCB ADDR            D11 ZA07645 01800001
         SR    &WORK2,&WORK1       BACKUP TO 1STUCB OF CU   D11 ZA07645 01850001
         SH    &WORK2,UCBPRFXL     BACKUP TO ITS LOCKWORD   D11 ZA07645 01900001
         AIF   ('&FUNC' EQ 'RELEASE').RELUCB                D11 ZA07645 01950001
*  OBTAIN UCBLOCK .......                                   D11 ZA07645 02000001
         SETLOCK OBTAIN,MODE=UNCOND,ADDR=0(&WORK2),         D11 ZA07645*02050001
               REGS=USE,RELATED=&RELATED,TYPE=IOSUCB        D11 ZA07645 02100001
         AGO   .COMUCB                                      D11 ZA07645 02150001
.RELUCB  ANOP                                               D11 ZA07645 02200001
*  RELEASE UCBLOCK ........                                 D11 ZA07645 02250001
         SETLOCK RELEASE,ADDR=0(&WORK2),REGS=USE,           D11 ZA07645*02300001
               RELATED=&RELATED,TYPE=IOSUCB                 D11 ZA07645 02350001
.COMUCB  ANOP                                               D11 ZA07645 02400001
* OTHER UCBS ON THIS SAME CONTROL UNIT SHOULD RESOLVE       D11 ZA07645 02450001
* (VIA UCBADDR AND DEVNDX TO SAME FIRST UCB).               D11 ZA07645 02500001
         SPACE 3                                            D11 ZA07645 02550001
         AIF   ('&FUNC' NE 'RELEASE').MEXIT                 D11 ZA07645 02600001
*  RELEASE LOCAL LOCK.....                                  D11 ZA07645 02650001
         SETLOCK RELEASE,TYPE=LOCAL,                        D11 ZA07645*02700001
               RELATED=&RELATED,REGS=USE                    D11 ZA07645 02750001
         MEXIT                                              D11 ZA07645 02800001
.NOFUNC  MNOTE 12,'GLOBLOCK-NO FUNCTION SUPPLIED'           D11 ZA07645 02850001
         MEXIT                                              D11 ZA07645 02900001
.INVFUNC MNOTE 12,'GLOBLOCK-FUNCTION NOT OBTAIN/RELEASE'    D11 ZA07645 02950001
.MEXIT   MEND                                               D11 ZA07645 03000001
         TITLE ' ASSIGN BUFFER SECTION OF IGC0007A'                     03050001
*********************************************************************** 03100001
*                                                                     * 03150001
* MODULE NAME:            IGC0007A (OS/VS2)                           * 03200001
*                                                                     * 03250001
* DESCRIPTIVE NAME:       BUFFER MANAGEMENT FOR 2250S                 * 03300001
*                                                                     * 03350001
* COPYRIGHT:              NONE                                        * 03400001
*                                                                     * 03450001
* STATUS:                 RELEASE 2.0                                 * 03500001
*                                                                     * 03550001
*                                                                     * 03600001
*FUNCTION/OPERATION: CONTROLS ASSIGNMENT AND RELEASE OF BUFFER STORAGE* 03650001
*   IN THE BUFFERED 2250,MODEL 1, AND IN THE 2840 DISPLAY CONTROL USED* 03700001
*   BY THE 2250, MODEL 2.                                             * 03750001
*                                                                     * 03800001
*ENTRY POINTS: IGC0007A - VIA AN SVC IN BUFFER MANAGEMENT MACROS      * 03850001
*                                                                     * 03900001
*INPUT: ADDRESS OF PARAMETER LIST BUILT BY MACROS IN REGISTER 1       * 03950001
*                                                                     * 04000001
*OUTPUT: RETURN CODES IN REGISTER 15                                  * 04050001
*                                                                     * 04100001
*              00 = REQUEST FULFILLED                                 * 04150001
*                                                                     * 04200001
*              04 = REQUEST AMT EXCEEDS AVAILABLE AMT     (ASGNBFR)   * 04250001
*                                                                     * 04300001
*              08 = CONTIGUOUS STORAGE NOT AVAILABLE     (ASGNBFR)    * 04350001
*                                                                     * 04400001
*              0C = DCB NOT OPEN                            ALL       * 04450001
*                                                                     * 04500001
*              10 = RELEASE REQUEST GT TOTAL ASSIGNED  (RELEASE)      * 04550001
*                                                                     * 04600001
*              14 = BUFFER RESTART ADDRESS NOW INVALID  (RELEASE)     * 04650001
*                                                                     * 04700001
*              18 = INVALID ASSIGN REQ (ZERO OR NEG)     (ASSIGN)     * 04750001
*                                                                     * 04800001
*              1C = INVALID INVOCATION CODE                 ALL       * 04850001
*                                                                     * 04900001
*              20 = INVALID RELEASE REQ (ZERO OR NEG)     (RELEASE)   * 04950001
*                                                                     * 05000001
*              24 = MOD1 2250 BUFFER EXHAUSTED           (ASSIGN)     * 05050001
*                                                                     * 05100001
*              28 = IOB DOESNT POINT BACK TO DCB            ALL       * 05150001
*                                                                     * 05200001
*              2C = DCB NOT GAM                             ALL       * 05250001
*                                                                     * 05300001
*              30 = ATTEMPT TO RELEASE SECTION(S) NOT OWNED (RELEASE) * 05350001
*                                                                     * 05400001
*              34 = UNABLE TO CLEAR REQUESTED BFR TO ZERO  (ASSIGN)   * 05450001
*                                                                     * 05500001
*              38 = BUFFER CONTROL TABLE ADDR NOT IN UCB    ALL       * 05550001
*                                                                     * 05600001
*EXTERNAL ROUTINES: N/A                                               * 05650001
*                                                                     * 05700001
*EXITS-NORMAL: SVC 3 FOR RETURN CODES 0 AND X'14'                     * 05750001
*                                                                     * 05800001
*     -ERROR:  ABEND16E (VIA DEBCHK) IF INVALID DEB.                  * 05850001
*     -ERROR:  XCTL TO MSG MOD (IGC0207A) W NONZERO CODE OTHER        * 05900001
*              THAN X'14'.                                            * 05950001
*                                                                     * 06000001
*TABLES/WORKAREAS: BUFFER TABLES BUILT AT SYSGEN TIME IN PROTECTED    * 06050001
*   CORE FOR EACH BUFFERED 2250 MODEL 1 AND EACH 2840 CONTROL UNIT.   * 06100001
*                                                                     * 06150001
*ATTRIBUTES: SUPERVISOR MODE, REENTERABLE.                            * 06200001
*            SUPERVISOR AND USER KEYS.                                * 06250001
*                                                                     * 06300001
*NOTE1: A HAND-EXPANDED CALL FOR MACRO GWRITE EXISTS AT LABEL 'CLRBFR'* 06350001
*NOTE2: AN INTERNAL MACRO (AT THE BEGINNING OF THIS MOD) IS USED      * 06400001
*       TO GET AND FREE THE LOCAL AND IOSUCB LOCKS NEEDED TO PROTECT  * 06450001
*       THE BUFFER TABLE GENNED FOR EACH 2840 CONTROL UNIT AS A       * 06500001
*       GLOBAL RESOURCE FOR ALL DEVICES ON THAT CONTROL UNIT.         * 06550001
*                                                                     * 06600001
*********************************************************************** 06650001
         EJECT                                                          06700001
IGC0007A CSECT                                                          06750001
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   06800001
*C081400,084200,092804,093302,096521,099242                   LF YM4067 06850001
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  06900001
*0638,025600-026000                                                JFCA 06950001
*2515,018600-019800,020000                                         TMGA 07000001
* 021200,021800,022200,025600-025800,027200,029000,049400,063200 S21016 07050001
* 063800-064400,065000-065200,077400,085400-085800               S21016 07100001
* 034200,034800,043000-043200,063000                             S21016 07150001
*0639,018800-019200                                                JFCB 07200001
* 025610-025680,070200,085900                                 LB  AOS/1 07250001
*C022600                                                         Y01021 07300001
*A027150                                                        YM1899  07350001
*A14274,23500-23580,38900-38916                               LG YM5684 07400001
*A14399-15320,A42714-42760,A12500,A12820                     LG @ZM2360 07450001
*C65300                                                     D11 ZA06400 07500001
*A42612,D43184,C42761,42788,42797,43103,43157,43202         D11 ZA07642 07550001
*A35900                                                     D11 ZA07643 07600001
*A67372,71700-50,80850-900,91600-61,92274-80,C32700-800,    D11 ZA07645 07650001
*C42602-03,67305-14,93470,93720-30,A111300-111400           D11 ZA07645 07700001
*A42645,C43174-78,A43208                                    D11 ZA07647 07750001
*A14310,42720                                               D11 ZA11044 07800001
*A18109,D90338                                              D11 ZA11045 07850001
*A42734-58,D042761                                          D11 ZA11441 07900001
*C62800,63200,63400,63690,64600,64900,65300,66100,85900     D11 ZA11442 07950001
*A67344-68,96200-40,100518,101967                           D11 ZA11442 08000001
         EJECT                                                          08050001
*                                                                       08100001
*                  REGISTERS                                            08150001
*                                                                       08200001
RX       EQU   0                                                        08250001
RY       EQU   1                                                        08300001
RZ       EQU   2                                                        08350001
RA       EQU   3                                                        08400001
RB       EQU   4                                                        08450001
RBFADDR  EQU   4             BUFFER ADDRESS REGISTER                    08500001
RTCB     EQU   4         CURRENT TCB REGISTER                           08550001
RC       EQU   5                                                        08600001
RD       EQU   6                                                        08650001
RE       EQU   7                                                        08700001
RCODE    EQU   7                       RET CODE FOR ERROR MSG MODS21016 08750001
R8       EQU   8                       ADDR EP NAME FOR XCTL     S21016 08800001
RUCB     EQU   8                                                        08850001
RDCB     EQU   9                                                        08900001
RBFTBL   EQU   10                       BUFFER TABLE DSECT REGISTER     08950001
LINK     EQU   10            REGISTER AS WORK REG                       09000001
RDSECT   EQU   11                       PARAM LIST DSECT REGISTER       09050001
RBASE    EQU   12                       CONTROL SECTION BASE REGISTER   09100001
RSAVE    EQU   13                       SAVEAREA REGISTER               09150001
RNSI     EQU   14                       RETURN LINKAGE REGISETER        09200001
R14      EQU   14                    WORK REGISTER           LG @ZM2362 09250001
RBAL     EQU   15                       LINKAGE REGISTER                09300001
RHOLD    EQU   15                                                       09350001
R15      EQU   15                    WORK REGISTER           LG @ZM2362 09400001
         EJECT                                                          09450001
*RETURN CODE EQUATES                                                    09500001
*                                                                       09550001
         SPACE 3                                                        09600001
TOOBIGAV EQU   4                   REQ GT AVAIL BFR         D11         09650001
TOOBIGZN EQU   8                   REQ GT ZONESIZE          D11         09700001
UNOPEN   EQU   X'0C'                   DCB NOT OPEN              S21016 09750001
BADRLS   EQU   X'10'               RLSE GT TOTASGND                     09800001
BADADR   EQU   X'14'               BAD RSTRT ADDR ON RLSE               09850001
BFRPRM   EQU   X'18'               ASGN REQ NOT POS.                    09900001
BADREQ   EQU   X'1C'                   BAD REQUEST CODE          S21016 09950001
RELNEG   EQU   X'20'                   RELEASE NEGATIVE COUNT    S21016 10000001
NOSECTS  EQU   X'24'                   CONTIG BUFFER UNAVAILABLE S21016 10050001
DCBBAD   EQU   X'28'                   DCB AND IOB DCB NOT EQUAL S21016 10100001
NOTGRPHC EQU   X'2C'                   NON-GRAPHIC DCB           S21016 10150001
BADREL   EQU   X'30'                   RELEASE FOR UNASSIGNED    S21016 10200001
NOCLEAR  EQU   X'34'         UNABLE TO DO I/O TO CLEAR BUFFER           10250001
NOBFTBL  EQU   X'38'         NO BUFFER TABLE ADDRESS IN UCB   LG YM5684 10300001
         SPACE                                                          10350001
* FURTHER EQUATES                                                       10400001
D0       EQU   0                       DISPLACEMENT              S21016 10450001
D8       EQU   8                       DISPLACEMENT              S21016 10500001
COMPLETE EQU   X'7F'          ECB COMPLETED WITHOUT ERROR.              10550001
MASK1    EQU   X'FF'                                                    10600001
MOD1     EQU   X'31'               DEVTYPE = MOD1 2250      D11         10650001
DECB     EQU   76      DISPL. OF DECB INTO GOTTEN CORE      D11 ZA11044 10700001
HEADER   EQU   40                                                       10750001
SVAREA   EQU   76            SIZE OF 18-WORD SAVE AREA      LG @ZM2362  10800001
DECBLEN  EQU   32            LEN OF GWRITE DECB GOTTEN      D11 ZA07642 10850001
DEBUCBAD EQU   32            DISPL OF UCBADDR IN DEB        D11         10900001
FOUR     EQU   4             CONSTANT                                   10950001
BFR      EQU   16            DISP. OF BUFFER ADDRESS IN DCB             11000001
CVT      EQU   16                                                       11050001
CVTCB    EQU   0         DISP. OF TCB TABLE ADDR. IN CVT                11100001
CURTCB   EQU   4         DISP OF CURRENT TCB ADDR. IN TABLE             11150001
SEVEN    EQU   7                     CONSTANT SEVEN(7)       LG @ZM2362 11200001
TEB      EQU   28                    OFFSET TO TEB IN UCB    LG @ZM2362 11250001
TEBGIOCR EQU   33                OFFSET TO GIOCR ADDR IN TEB LG @ZM2362 11300001
GIOCR    EQU   49                    OFFSET TO GIOCR IN DCB  LG @ZM2362 11350001
SVGIOCR  EQU   72            DISP TO GIOCR ADR IN SVAREA     LG @ZM2362 11400001
SVCDCB   EQU   X'54'         DISP TO DCB FOR SVCLIB IN CVT   LG @ZM2362 11450001
DCBBFRST EQU   16     DCB BUFFER START-ZEROED IF ERRORS     D11         11500001
         EJECT                                                          11550001
*           INITIALIZE BASE AND DSECT REGISTERS                         11600001
         SPACE 3                                                        11650001
         BALR  RBASE,RX            ESTABLISH ADDRESSABILITY             11700001
         USING *,RBASE                                                  11750001
ORG      EQU   *                   ORIGIN FOR MSG1,2,3      D11 ZA11045 11800001
         B     START                                        D11         11850001
MODID    DC    C'IGC0007A.VS2R3.&SYSDATE'       MODULE EYECATCHER ID    11900001
START    LR    RDSECT,RY           MAP PARMLIST DSECT       D11         11950001
         USING PARLST,RDSECT            ADDRESS PASSED IN GR1           12000001
*CHECK DCB FOR VALIDITY AND OPENED                                      12050001
         L     RDCB,CODE           HIORD BYTE=CODE;LOORD3=DCBADDR       12100001
         TM    48(RDCB),X'10'           CHECK DCB FOR OPENED CONDITION  12150001
         BZ    ERRDCB1                 ISSUE RET CODE IF NOT OPENS21016 12200001
         L     RZ,28(RDCB)              RZ CONTAINS IOB ADDR,TO CHECK   12250001
         CLC   DCBADR(3),21(RZ)         IOB FOR VALIDITY OF THIS DCB    12300001
         BNE   ERRDCB2                 ISSUE RET CODE-INVALID DCBS21016 12350001
         TM    27(RDCB),X'80'           VALID GAM DCB? IF NOT GO TO ERR 12400001
         BZ    ERRDCB3                 ISSUE RET CODE-INVALID DCBS21016 12450001
*ACCESS UCB                                                             12500001
         LA    RDCB,D0(RDCB)           CLEAR HI-BYTE DCB ADDR LB Y01021 12550001
         DEBCHK (RDCB),TYPE=VERIFY,AM=GAM   VALIDATE DEB      LB Y01021 12600001
         LR    R8,RY                   DEB ADDRESS            LB Y01021 12650001
         L     RUCB,DEBUCBAD(R8)        RUCB CONTAINS UCB ADR FROM DEB  12700001
         USING UCBOB,RUCB                                   D11         12750001
*SET UP BUFFER TABLE DSECT                                              12800001
         L     RBFTBL,UCBBTB-1     LOAD BFRTBL ADR FROM UCB             12850001
         LA    RBFTBL,0(RBFTBL)        ELIMINATE DEVNDX                 12900001
         LTR   RBFTBL,RBFTBL        BUFFER TABLE EXIST?       LG YM5684 12950001
         BNZ   CKCODE             YES,CONTINUE PROCESSING     LG YM5684 13000001
         LA    RCODE,NOBFTBL      LOAD RETURN CODE            LG YM5684 13050001
         B     XCTLOAD3           XCTL TO LOAD 3             D11 YM5684 13100001
CKCODE   EQU   *                                                        13150001
         USING BFRTBL,RBFTBL                                            13200001
*CHECK POSITIVELY FOR REQUEST CODE IN PARAM LIST                        13250001
         CLI   CODE,X'04'               IF CODE '04' GO TO ASSIGN SUB-  13300001
         BE    ASSIGN                   ROUTINE                         13350001
         CLI   CODE,X'08'               IF CODE '08' GO TO RELEASE SUB- 13400001
         BE    RELEASE                  ROUTINE                         13450001
         CLI   CODE,X'0C'               IF CODE '0C' GO TO RELEASE ALL  13500001
         BE    RLSEALL                          TRANSFER TO LOAD2       13550001
         CLI   CODE,X'10'          IF CODE '10' GO TO BUFINQ SUBROUTINE 13600001
         BE    BUFINQ                          TRANSFER TO LOAD2        13650001
         LA    RCODE,BADREQ         LOAD RETURN CODE             S21016 13700001
         EJECT                                                          13750001
*********************************************************************** 13800001
*                                                                     * 13850001
*              TRANSFER CONTROL MECHANISM TO LOAD 3, MESSAGES         * 13900001
*                                                                     * 13950001
*********************************************************************** 14000001
XCTLOAD3 EQU   *                       SET UP TO XCTL TO MSG MOD S21016 14050001
         LA    R8,EPLOAD3              ADDR OF NAME FOR LOAD 3   S21016 14100001
         LR    RY,RDSECT           RESTORE REG 1                YM1899  14150001
         L     RZ,CVT                  LOAD CVT ADDR                    14200001
         L     RZ,0(RZ)            LOAD TCB PTR TO DOUBLE WORD          14250001
         L     RZ,4(RZ)            LOAD CURRENT TCB ADR                 14300001
         L     RZ,0(RZ)            LOAD CURRENT RB PTR                  14350001
         LA    RBAL,96(RZ)         LOAD ADR OF REMOTE SUPRVSR PARAM LST 14400001
         LA    RZ,104(RZ)               WHICH IS AT SVRB+96, THEN SET   14450001
         ST    RZ,0(RBAL)               UP LIST AS FOLLOWS --           14500001
         SR    RA,RA                    WORD1 - PTR TO BUFINQ ADR (*+8) 14550001
         ST    RA,4(RBAL)               WORD2 - DCB ADR SET TO 0        14600001
         MVC   D8(D8,RBAL),D0(R8)           WORD 3,4 - EP NAME   S21016 14650001
         XCTL  MF=(E,(1)),SF=(E,(15)) TRANSFER CONTROL                  14700001
EPLOAD3  DC    CL8'IGC0207A'           NAME FOR MSG MODULE       S21016 14750001
         EJECT                                                          14800001
*     *     *     *     *     *    *     *     *     *     *     *      14850001
*                                                                *      14900001
*THE FOLLOWING SUBROUTINE ASSIGNS BUFFER STORAGE AND IS ACCESSED *      14950001
*WHENEVER THE ASGNBFR MACRO-INSTRUCTION IS ISSUED.               *      15000001
*                                                                *      15050001
*     *     *     *     *     *     *     *     *     *     *    *      15100001
ASSIGN   L     RA,BUFPRM                RA EQ ADDR OF HALFWORD          15150001
         LH    RA,0(RA)                 RA EQ BYTES REQUESTED           15200001
         LA    RX,MASK1                 RX CONTAINS X'FF',ADD TO RA,TO  15250001
         AR    RA,RX                    CONVERT BYTES TO SECTIONS       15300001
         SRA   RA,8                     PUT NUMB IN LO-ORDER BYTE OF RA 15350001
         SR    RX,RX                    CLEAR RX TO ZERO AND COMPARE TO 15400001
         CR    RA,RX               CHECK RA FOR NEG OR ZERO REQUEST     15450001
         BNH   ERRPRM                   GO TO RET CODE '18' RTN         15500001
ASGNGET  GLOBLOCK OBTAIN,REGS=(RB,RC),                      D11 ZA07645*15550001
               RELATED=(ASGNREL,ENABLE)                     D11 ZA07645 15600001
*INITIALIZE SUBROUTINE                                                  15650001
BASIC    LH    RB,TOTAVAIL         SET RB EQ TO TOTAVAIL IN BFRTBL      15700001
         LH    RC,NUMDEV                RC HAS NUMBER OF DEVICES/2840   15750001
         CLR   RA,RB                    IF REQUEST GREATER THAN AMT     15800001
         BH    ERRASG4                  AVAIL,LOAD RETURN CODE          15850001
*ACCESS AND SEARCH THIS DEVICE'S ZONE                                   15900001
         BAL   RNSI,INFODISP      GO TO INFO RTN                        15950001
*                                                                       16000001
         LH    RE,4(RZ)                 RE CONTAINS THIS DEVICE'S ZONSZ 16050001
         CLR   RA,RE               COMPARE REQUEST TO ZONESZ            16100001
        BH    ERRASG8             IF REQUEST GREATER NO ASGNMENT        16150001
*BEGIN SEARCH OF THIS DEVICE'S ZONE--                                   16200001
         LH    RB,2(RZ)                 RB EQ DEVICE'S ZONE DISP        16250001
         AR    RB,RBFTBL                RB EQ DISP + ADDR OF BFR TBL    16300001
         LR    RX,RZ                    SAVE DISP OF THIS DEVICE'S INFO 16350001
         SR    RY,RY               CLEAR R1 FOR TRT         D11 ZA07643 16400001
REEX     EX    RE,SEEK1            SEARCH FOR AVAIL SECTION             16450001
* SEEK1= TRT 0(1,RB),FREESCTN - FREESCTN=X'FF00000000'                  16500001
         BC    10,CONTINU1             IF NOT FOUND GO TO NEXT ZONE     16550001
         BAL   14,COMPUTE              SET UP REG AND CTRS              16600001
*OTHERWISE SEARCH FOR CONTIGUOUS STORAGE IN DEVICE'S ZONE               16650001
         EX    RA,SEEK2                 SEARCH FOR CONTIG PER REQUEST   16700001
* SEEK2= TRT 0(1,RB),CONTIG - CONTIG=X'00FFFFFFFF'                      16750001
         BC    4,GETADR                                                 16800001
         EJECT                                                          16850001
*                                                                       16900001
*UPDATE TABLES, ASSIGN STORAGE AND SET DCB FLDS                         16950001
*                                                                       17000001
SETDCB   LR    RZ,RB                    CONVERT BFR TBL ENTRY DISP TO   17050001
         SR    RZ,RBFTBL                ACTUAL BFR STORAGE ADDRESS BY   17100001
         CLI   UCBTYP,MOD1             IS IT MOD 1          D11         17150001
         BNE   MODASG              NO - BRANCH                          17200001
         S     RZ,HEAD16           SUBTRACT MOD1 BFRTBL ADR D11         17250001
         B     MULTI               CONTINUE                 D11         17300001
MODASG   S     RZ,HEADISP          SUB MOD2 BFRTBL ADDR     D11         17350001
MULTI    SLL   RZ,8                ENTYRDISP MULT BY 256                17400001
         L     RE,CVT               LOAD CVT ADDRESS          YM5684    17450001
         L     RE,0(RE)           LOAD TCB PTR TO DOUBLE WORD LG YM5684 17500001
         L     RE,4(RE)           LOAD CURRENT TCB ADDRESS    LG YM5684 17550001
         USING TCB,RE                                         LG YM5684 17600001
         MODESET EXTKEY=TCB,WORKREG=5   GOTO USERKEY TO FILLIN          17650001
         STH   RZ,16(RDCB)              SET BFRST FLD IN DCB            17700001
         LR    RZ,RA                    CONVERT SECTIONS IN REQUEST TO  17750001
         SLL   RZ,8                     BYTES BY MULTIPLYING BY 256     17800001
         LR    RC,RZ         SAVE BYTE REQUEST                          17850001
         LR    RSAVE,RA      SAVE NUMBER OF SECTIONS                    17900001
         STH   RZ,18(RDCB)              SET BFRSZ FLD IN DCB            17950001
         MODESET EXTKEY=SUPR       BACK TO SUPERKEY                     18000001
         DROP  RE                                                       18050001
         EJECT                                                          18100001
*                                                                       18150001
*ASSIGN--FILL IN BFR TABLE                                              18200001
*                                                                       18250001
         LH    RE,TOTAVAIL              UPDATE TOTAVAIL FLD OF BFR TBL  18300001
         SR    RE,RA                    SUBTRACT REQUEST                18350001
         STH   RE,TOTAVAIL              STORE UPDATED TOTAVAIL IN TBL   18400001
         LH    RZ,0(RHOLD)         LOAD TASGND FIELD TO UPDATE          18450001
         AR    RZ,RA               ADD REQUEST                          18500001
         STH   RZ,0(RHOLD)         RESTORE UPDATED TASGND               18550001
         MVC   0(1,RB),UCBDI            PUT DEVNDX IN 1ST BYTE ENTRY    18600001
         LA    RX,RY                    SET RX EQ 1                     18650001
         CLR   RX,RA               IS REQUEST EQ 1 SECTION              18700001
         BE    CLR000       GO CLEAR ASSIGNED BUFFER                    18750001
         LA    RX,RZ                    SET RX EQ 2                     18800001
         SR    RA,RX                    SET RA EQ REQUEST-2 TO USE EX   18850001
         EX    RA,ASGSCTN               INSTRUCTION WITH LNG ADJUSTED   18900001
CLR000   EQU   *                                                        18950001
ASGNREL  GLOBLOCK RELEASE,REGS=(RA,RB),                     D11 ZA07645*19000001
               RELATED=(ASGNGET)                            D11 ZA07645 19050001
         LR    RA,RSAVE      RESTORE NUMBER SECTIONS                    19100001
         LH    RBFADDR,BFR(RDCB) START OF BUFFER ASSIGNMENT             19150001
         LA    RX,FOUR       LOAD FOUR AS A CTR FOR THE 256-BYTE        19200001
*                            SECTIONS. THE BUFFER ASSIGNED WILL BE      19250001
*                            CLEARED WITH 1K GWRITES(4 SECTIONS) IF     19300001
*                            MORE THAN 1K IS REQUESTED.                 19350001
         CLR   RA,RX         MORE THAN 1K REQUESTED?                    19400001
         BH    ASGN0001      BRANCH IF YES.                             19450001
         LA    RX,SVAREA+DECBLEN(RC) SIZE=SVAREA+DECBLEN    D11 ZA07642 19500001
         BAL   LINK,ASGN0003 SUBROUTINE TO GET AND CLEAR AREA           19550001
         EJECT                                                          19600001
*INITIALIZE REGISTERS AND SET UP PARAMETERS FOR GWRITE WHICH WILL       19650001
*WRITE A ZEROED AREA TO THE PARTICULAR BUFFER SECTIONS ASSIGNED.        19700001
         LH    RZ,18(RDCB)   NUMBER OF BYTES TO CLEAR                   19750001
         STH   RBFADDR,0(RSAVE) WORD ONE OF THE SAVE AREA WILL          19800001
*                              BE USED TO SAVE THE BUFFER ADDR...       19850001
*                              ASSIGNED.                                19900001
         LA    RE,SUCCESS    GET RETURN ADDRESS FOR FREEAREA            19950001
         LA    LINK,FREEAREA  GET RETURN ADDRESS FOR CLRBFR             20000001
         B     CLRBFR        GO TO CLEAR BUFFER SUBROUTINE              20050001
*MORE THAN 1K HAS BEEN REQUESTED,THEREFORE WE WILL CLEAR THE ASSIGNED   20100001
*BUFFER IN 1K SECTIONS TO MAKE THE MOST EFFECTIVE USE OF I/O.           20150001
ASGN0001 EQU   *                                                        20200001
         L     RX,ONEK       SIZE OF AREA TO CLEAR                      20250001
         LA    RZ,SVAREA+DECBLEN  DECB/SVAREA SIZE (USED BY GIOCR)      20300001
         AR    RX,RZ         TOTAL SIZE OF AREA TO GETMAIN              20350001
         L     RC,ONEK       SAVE SIZE FOR GWRITE           D11 ZA11046 20400001
         BAL   LINK,ASGN0003 LINK TO SUBROUTINE TO CLEAR AREA           20450001
*NOW WE WILL DIVIDE THE REQUEST INTO 1K SECTIONS                        20500001
         LH    RD,18(RDCB)   AMOUNT OF BUFFER ASSIGNED                  20550001
         SRDL  RD,32         POSITION IN ODD REGISTER                   20600001
         DR    RD,RZ         DIV BY 1K(1024) -SETS BCT COUNT IN RE      20650001
ASGN0002 EQU   *                                                        20700001
         STH   RBFADDR,0(RSAVE) SAVE BUFFER ADDR FOR GWRITE             20750001
         BAL   LINK,CLRBFR   LINK TO CLEAR-BUFFER SUBROUTINE            20800001
         LA    RBFADDR,0(RZ,RBFADDR)    POINT TO NEXT SECTION           20850001
         BCT   RE,ASGN0002   CLEAR ALL SECTIONS                         20900001
         LA    RE,SUCCESS    GET RETURN ADDRESS FOR FREEAREA            20950001
         LTR   RD,RD         ANY REMAINING TO BE CLEARED?               21000001
         BZ    FREEAREA      BRANCH IF NO                               21050001
         LR    RZ,RD         SIZE OF REMAINING BUFFER SEGMENT           21100001
         LA    LINK,FREE1K   RETADR WHEN ALL CLEARED        D11 ZA07647 21150001
         EJECT                                                          21200001
*                                                                       21250001
*THE FOLLOWING INTERNAL SUBROUTINE WILL WRITE THE CLEARED AREA OUT      21300001
*TO THE 2250 BUFFER                                                     21350001
*                                                                       21400001
CLRBFR   EQU   *                                                        21450001
         XC    DECB(DECBLEN,RC),DECB(RC) CLEAR DECB         D11 OZ11044 21500001
         SPACE 3                                            D11 ZA11441 21550001
* THERE FOLLOWS A HAND-EXPANDED VERSION OF THE GWRITE MACRO D11 ZA11441 21600001
* WHICH IS USED TO ACCESS A SAFE GIOCR ADDRESS FROM THE TEB.D11 ZA11441 21650001
* THIS IS NECESSARY WHEN GWRITE IS CALLED IN A ROUTINE THAT D11 ZA11441 21700001
* RUNS IN SYSTEM MODE SO AS NOT TO GIVE A SNEAKY RD/WR      D11 ZA11441 21750001
* ROUTINE CONTROL IN SUPSTATE,KEY0 AND UNINTEGRATE THINGS.  D11 ZA11441 21800001
*        GWRITE DECB(RC),BUF,(RDCB),(RZ),(RC),(RSAVE),MF=E  D11 ZA11441 21850001
         SR    15,15               CLEAR REGISTER           D11 ZA11441 21900001
         LA    1,DECB(RC)          POINT TO DECB            D11 ZA11441 21950001
         ST    15,4(0,1)           CLEAR TYPE AREA IN DECB  D11 ZA11441 22000001
         MVI   4(1),X'A0'          BUF TYPECODE TO DECB     D11 ZA11441 22050001
         LA    15,0(RDCB)          POINT TO DCB             D11 ZA11441 22100001
         ST    15,8(0,1)           DCB ADDR TO DECB         D11 ZA11441 22150001
         LA    15,0(RZ)            LENGTH                   D11 ZA11441 22200001
         ST    15,20(0,1)          LENGTH TO DECB           D11 ZA11441 22250001
         LA    15,0(RC)            AREA ADDRESS             D11 ZA11441 22300001
         ST    15,12(0,1)          AREA ADDR TO DECB        D11 ZA11441 22350001
         LA    15,0(RSAVE)         CLEAR HI-ORDER BYTE      D11 ZA11441 22400001
         ST    15,28(0,1)          BUFFER ADDRES TO DECB    D11 ZA11441 22450001
         XC    0(4,1),0(1)         CLEAR ECB                D11 ZA11441 22500001
         L     15,SVGIOCR(RSAVE)  GET SAFE GIOCR ADDRESS    D11 ZA11441 22550001
         DS    0H                                           D11 ZA11441 22600001
         BALR  14,15               BR TO GIOCR EP           D11 ZA11441 22650001
* END OF HAND-CODED EXPANSION OF GWRITE MACRO CALL...       D11 ZA11441 22700001
         SPACE 3                                            D11 ZA11441 22750001
         LTR    RBAL,RBAL    I/O STARTED?                               22800001
         BNZ    CLRERR       BRANCH IF NO                               22850001
         WAIT   ECB=DECB(RC)   WAIT ON I/O COMPLETION       D11 ZA07642 22900001
         CLI   DECB(RC),COMPLETE I/O DONE WITHOUT ERROR?    D11 ZA07642 22950001
         BCR   8,LINK        BRANCH IF YES                              23000001
         EJECT                                                          23050001
*                                                                       23100001
CLRERR   EQU   *                                                        23150001
*                                                                       23200001
* AN ERROR WAS DISCOVERED WHEN TRYING TO CLEAR THE REQUESTED            23250001
*BUFFER.NOW WE MUST SAVE INPUT REGISTERS,CREATE A PARAMETER             23300001
* LIST FOR RELEASE BUFFER AND GO TO RELEASE BUFFER SUBROUTINE           23350001
*TO RELEASE THE BUFFER WE JUST ASSIGNED.                                23400001
*                                                                       23450001
         ST    RDSECT,0(RSAVE) SAVE INPUT REGISTER                      23500001
*CREATE RLSEBFR PARMLIST AT SAVEAREA+0 (LEN='14')           D11         23550001
         ST    RZ,4(RSAVE)    SAVE SIZE OF GETMAINED AREA               23600001
         L     RA,CODE       GET DCB ADDRESS AND CODE                   23650001
         ST    RA,8(RSAVE)    STORE ADDRESS IN PARM LIST                23700001
         LA    RA,16(RDCB)   PUT BUFFER PARAM IN LIST...                23750001
         ST    RA,12(RSAVE)   TO BE USED BY RLSEBFR                     23800001
         LA    RY,8(RSAVE)    SET INPUT REG TO ADDR OF LIST             23850001
         LR    RDSECT,RY     INITIALIZE DSECT REGISTER                  23900001
         L     RBFTBL,UCBBTB-1  RELOAD BFR TBL ADDRESS                  23950001
         LA    RBFTBL,0(RBFTBL) CLEAR OUT DEVICE INDEX                  24000001
         B     RELEASE       RELEASE THE ASSIGNED BUFFER                24050001
ASGN0003 EQU    *                                                       24100001
         GETMAIN R,LV=(0)                                               24150001
*GENERAL REGISTERS 0,1,6 AND 7 WILL NOW BE INITIALIZED FOR THE          24200001
*MOVE LONG INSTRUCTION TO CLEAR THE AREA TO BE WRITTEN TO THE BUFFER    24250001
         LR    RSAVE,RY       SAVE AREA ADDRESS                         24300001
         LA    RY,SVAREA+DECBLEN(RY) POINT PAST SAVE+DECB   D11 ZA07642 24350001
         LR    RD,RY         ADDRESS OF AREA TO CLEAR                   24400001
         LR    RX,RY         ADDRESS OF AREA TO CLEAR                   24450001
         LR    RY,RC         NUMBER OF BYTES TO CLEAR       D11 ZA11046 24500001
         LA    RE,D0         SET PADDING CHARACTER TO 0                 24550001
         MVCL  RX,RD         CLEAR GOTTEN CORE                          24600001
         LA    RC,SVAREA+DECBLEN(RSAVE) ADR STRT OF CLRAREA D11 ZA07642 24650001
         L     R15,CVT       GET ADDRESS OF CVT              LG @ZM2362 24700001
         L     R15,SVCDCB(R15) DCB ADDR FOR SVCLIB           LG @ZM2362 24750001
         LOAD  EP=IGG019OA,DCB=(R15)                         LG @ZM2362 24800001
         STCM  RX,SEVEN,SVGIOCR+1(RSAVE)                     LG @ZM2362 24850001
         BR    LINK          RETURN                                     24900001
FREE1K   EQU   *                   EP TO FREE ONE ENTIRE K  D11 ZA07647 24950001
         L     RZ,ONEK             AMOUNT TO FREE           D11 ZA07647 25000001
         EJECT                                                          25050001
FREEAREA EQU   *                                                        25100001
         LA    RX,SVAREA+DECBLEN(RZ) SIZE TO FREE           D11 ZA07642 25150001
FREECORE EQU   *                                            D11 ZA07647 25200001
         FREEMAIN R,LV=(0),A=(13)                                       25250001
         DELETE EP=IGG019OA  DELETE GIOCR                   D11 @ZM2362 25300001
         BR    RE            RETURN IN-LINE                             25350001
SUCCESS  SR    RCODE,RCODE               SET GR15 EQ 0 (X'00'           25400001
         B     EXIT1               RESTORE R1 AND EXIT      D11         25450001
         EJECT                                                          25500001
*                                                                       25550001
*                       INTERNAL  SUBROUTINES                           25600001
*                                                                       25650001
         SPACE 3                                                        25700001
*   SUBROUTINE TO SCAN ZONES FOR AVAILABLE SPACE                        25750001
COMPUTE  AR    RE,RB                   RE EQ DISP ADR + ZONESZ          25800001
         SR    RE,RY                   RE EQ REMAINING ZONESZ           25850001
         CLR   RA,RE                   IS REQUEST HIGHER THAN ZONESZ    25900001
         BH    CONTINU1                GO TO NEXT ZONE                  25950001
         LR    RB,RY                   PUT NEW TRT ADR IN RB            26000001
         BR    RNSI                    GO BACK                          26050001
         SPACE 3                                                        26100001
*   SUBROUTINE TO LOCATE PARTICULAR DEVICE INFO IN BT                   26150001
*        1. ALGO IS (DEVINDX# - 1) * 8 + BTDVADR                        26200001
*                    FROM UCB             BT+8                          26250001
*                                                                       26300001
INFODISP SR    RD,RD                    CLEAT RD TO ZERO                26350001
         IC    RD,UCBDI                 RD CONTAINS DEVNDX              26400001
         LR    RZ,RD                    RZ CONTAINS DEVNDX TO COMPUTE   26450001
*                                       LOCATION OF THIS DEVICE'S INFO  26500001
*                                       IN THE BFR TBL                  26550001
         BCTR  RZ,0                SUBTRACT ONE FROM DEVNDX (RZ)        26600001
         SLL   RZ,3                     MULTIPLY RZ BY 8                26650001
         LA    RE,8(RBFTBL)             RE EQUALS BFR TBL ADDR + 8      26700001
         AR    RZ,RE                    RZ EQUALS DISP OF THIS DEVICE'S 26750001
*                                       INFO IN BFR TBL                 26800001
         LR    RHOLD,RZ            SAVE THIS DEVICE'S INFO DISP         26850001
         B     0(RNSI)                                                  26900001
         EJECT                                                          26950001
*                   MISCELLANEOUS OUT-OF-LINE CODE                      27000001
*                                                                       27050001
GETADR   BAL   14,COMPUTE              UPDATE REG AND CTRS              27100001
         B     REEX                                                     27150001
*                                                                       27200001
         EJECT                                                          27250001
*WHEN AN ASSIGNMENT CANNOT BE FULFILLED WITHIN THE DEVICES OWN ZONE     27300001
*THE NEXT SEQUENTIAL ZONE'S UNGUARANTEED AREA IS SEARCHED, STARTING     27350001
*AT THE BOTTOM OF THE AVAILABLE AREA                                    27400001
CONTINU1 LR    RZ,RX                    LOAD BFR INFO DISP INTO RZ      27450001
         SR    RC,RD               SET RC EQ NUMDEV-DEVNDX              27500001
         AR    RD,RC                    SET RC EQ NUMDEV TO USE AS CTR  27550001
         BCT   RD,*+4              SUBTRACT ONE FROM NUMDEV (RD)        27600001
CONTINU3 SR    RX,RX                    SET RX EQ 0                     27650001
         CLR   RX,RD               NUMDEV EQ 0?                         27700001
         BE    ERRASG                  GO TO ERR RETURN RTN      S21016 27750001
         CLR   RX,RC               RC CTR EQ 0?                         27800001
         BE    TBLTOP                   GO TO RTN TO ACCESS 1ST DEVICES 27850001
*                                            ZONE                       27900001
*                                       OTHERWISE ACCESS NEXT ZONE AND  27950001
*                                            CHECK ZONE SIZE            28000001
         LA    RZ,RUCB(RZ)         ADD 8 TO BFR INFO DISP IN RZ         28050001
CONTINU4 LH    RY,6(RZ)                 LOAD TG INTO RY                 28100001
         LH    RE,4(RZ)                 LOAD RE WITH ZONESZ             28150001
         SLR   RE,RY               SUBTRACT TG FROM ZONESIZ             28200001
*                                            AVAILABLE UNGTD SIZE       28250001
         CLR   RA,RE               IS REQUEST LARGER THAN ZONESZ        28300001
         BH    CONTINU6                 GO TO DECREMENT RC,RD           28350001
         EJECT                                                          28400001
*                                                                       28450001
*OTHERWISE BEGIN BACKWARD SEARCH IN UNGTD PORTION OF THIS ZONE BY TRT   28500001
*INSTRUCTION WITH USE OF ZONESZ COUNTER                                 28550001
*                                                                       28600001
         LH    RB,2(RZ)                 SET RB EQ DISP FOR THIS ZONE    28650001
         AR    RB,RBFTBL                ADD BFR TBL ADDR TO THIS DISP   28700001
         AR    RB,RY                    ADD TG TO THIS TOTAL DISP TO PT 28750001
*                                            TO START OF UNGTD AREA     28800001
         AR    RB,RE                    ADD ZONESZ TO TOTAL DISP TO PT  28850001
*                                            TO END OF UNGTD AREA       28900001
SEARCH1  LR    RX,RZ                    SET DISP EQ REQUEST LNG FROM RB 28950001
SEARCH2  SR    RB,RA                         AFTER SAVING RZ IN RX      29000001
         EX    RA,SEEK2                 EXECUTE THE TRT-INSTRUCTION FOR 29050001
         BC    8,SETDCB                LNG OF REQUEST, IF ENOUGH        29100001
         BC    2,SETDCB                      CONTIGUOUS STORAGE GO TO   29150001
*                                            ASSIGN AND UPDATE ROUTINE  29200001
         AR    RB,RA                    OTHERWISE BEGIN SEARCH BACKWARD 29250001
*                                            FROM ADDR IN GR2 AS RESULT 29300001
*                                            OF TRT-INSTRUCTION. RB EQ  29350001
*                                            LAST END DISP OF UNGTD     29400001
*                                            AREA                       29450001
         SR    RB,RY                    SUBTRACT TRT ADDR REG (GR2)     29500001
*                                            FROM DISP FOR ZONESZ UN-   29550001
*                                            AVAILABLE                  29600001
         SR    RE,RB                    SUBTRACT THAT AMT FROM ZONESZ   29650001
         CLR   RA,RE               COMPARE REQUEST TO ZONESZ            29700001
         BH    CONTINU5                 IF HIGH GO TO DECREMENT RD,RC   29750001
*                                       OTHERWISE, LOAD TRT-ADDR INTO   29800001
         LR    RB,RY                         RB AND GO TO SEARCH2       29850001
         B     SEARCH2                                                  29900001
*                                       DECREMENT RC,RD CTRS (NUMDEV)   29950001
CONTINU5 LR    RZ,RX                         BY LOADING BFR INFO INTO   30000001
CONTINU6 LA    RX,RY                    RZ, SET RX EQ 1                 30050001
         SR    RC,RX                    SUBTRACT 1 FROM RC CTR          30100001
         SR    RD,RX                    SUBTRACT 1 FROM FROM NUMDEV     30150001
         B     CONTINU3                 GO TO CHECK CTR ROUTINE AND     30200001
*                                            CONTINUE SEARCH IN NEXT    30250001
*                                            ZONE                       30300001
TBLTOP   LR    RC,RD                    SET RC CTR TO RD CTR            30350001
         LA    RZ,RUCB(RBFTBL)     ADD 8 TO ADDR OF BFR TBL IN RZ       30400001
*RZ CONTAINS BFR INFO DISP                                              30450001
         B     CONTINU4                                                 30500001
         EJECT                                                          30550001
*                                                                       30600001
*                        EXECUTE INSTRUCTIONS                           30650001
*                                                                       30700001
         CNOP  2,4                                                      30750001
SEEK1    TRT   0(1,RB),FREESCTN         SEARCH FOR 1ST FREE SECTION     30800001
FREESCTN DC    X'FF'                                                    30850001
         DC    4X'00'                                                   30900001
         CNOP  2,4                                                      30950001
SEEK2    TRT   0(1,RB),CONTIG           SEARCH FOR SUBSEQUENT FREE      31000001
CONTIG   DC    X'00'                    SECTIONS                        31050001
         DC    4X'FF'                                                   31100001
         CNOP  2,4                                                      31150001
ASGSCTN  MVC   1(1,RB),0(RB)            INSERT DEVNDX IN BFR TBL TO     31200001
*                                       INDICATE ASSIGNMENT OF SECTIONS 31250001
         EJECT                                                          31300001
*RETURN CODE ROUTINES                                                   31350001
ERRASG4  EQU   *         CLEAR DCB DONE AT ENABLE1          D11 ZA11442 31400001
         LA    RCODE,TOOBIGAV      REQ GT AVAIL BFR                     31450001
         B     ENABLE      FREELOCKS,ZERO DCBBFST,GIVE MSG  D11 ZA11442 31500001
ERRASG8  EQU   *    CLEAR DCBBFST DONE AT ENABLE1           D11 ZA11442 31550001
         LA    RCODE,TOOBIGZN      REQ GT ZONESIZE                      31600001
         B     ENABLE       FREELOCKS,ZERO DCBBFST,GIVE MSG D11 ZA11442 31650001
ERRDCB1  EQU   *                   DCB NOT OPEN                  S21016 31700001
         LA    RCODE,UNOPEN            LOAD RETURN CODE          S21016 31750001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 31800001
ERRDCB2  EQU   *                   DCB/IOB ADDR INVALID          S21016 31850001
         LA    RCODE,DCBBAD                                      S21016 31900001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 31950001
ERRDCB3  EQU   *                   NOT A VALID GAM DCB           S21016 32000001
         LA    RCODE,NOTGRPHC          LOAD RETURN CODE          S21016 32050001
         B     XCTLOAD3                GO INVOKE MSG MODULE D11  S21016 32100001
ERRPRM   EQU   *     CLEAR DCBBFSTRT DONE AT ENABLE1        D11 ZA11442 32150001
         LA    RCODE,BFRPRM       ='18'                     D11         32200001
         B     ENABLE1    CLEAR DCB FIELDS,XCTL TO MSGR     D11 ZA11442 32250001
ERRASG   EQU   *                                                 S21016 32300001
         LA    RCODE,NOSECTS           LOAD RETURN CODE          S21016 32350001
         B     ENABLE   FREELOCKS,ZERO DCBBFST,GIVE MSG     D11 ZA11442 32400001
WRITERR  EQU   *                   LOCKS ALREADY FREED                  32450001
         L     RZ,4(RSAVE)    GET AREA SIZE FOR FREEMAIN                32500001
         L     RDSECT,0(RSAVE)     SAVE INPUT REGS                      32550001
         BAL   RE,FREEAREA   FREE SAVE AREA                             32600001
         LR    RY,RDSECT     RESTORE INPUT REGISTER                     32650001
         LA    RCODE,NOCLEAR   LOAD RETURN CODE                         32700001
         B     ENABLE1        GO ZERO DCBBFST,GIVE MSG      D11 ZA11442 32750001
HEADISP  DC    F'40'                                                    32800001
HEAD16   DC    F'16'                   HEADER LNG OF MOD1 BFRTBL        32850001
ONEK     DC    F'1024'                                                  32900001
         DS    0F                                                       32950001
MASKON   DC    4X'FF'                                                   33000001
         EJECT                                                          33050001
ENABLE   GLOBLOCK RELEASE,REGS=(RZ,RA),                     D11 ZA07645X33100001
               RELATED=(ASGNGET,RLSEGET)                    D11 ZA07645 33150001
         LTR   RCODE,RCODE         GOOD RETCODE?            D11 ZA07645 33200001
         BZ    EXIT1               YES,IMMEDIATE EXIT       D11 ZA07645 33250001
ENABLE1  EQU   *                                            D11 ZA11442 33300001
         LA    RA,X'14'            CHECK RETCODE            D11 ZA11442 33350001
         CR    RA,RCODE            IF RESTART,EXIT W 0 ,    D11 ZA11442 33400001
         BE    EXIT1               ELSE ZERO DCB IN USERKEY D11 ZA11442 33450001
         L     RA,CVT              ALL THIS                 D11 ZA11442 33500001
         L     RA,0(RA)            SIMPLY TRIES TO          D11 ZA11442 33550001
         L     RA,4(RA)            GET PTR TO CURR TCB      D11 ZA11442 33600001
         USING TCB,RA              SO WE CAN ...            D11 ZA11442 33650001
         MODESET EXTKEY=TCB,WORKREG=1 GOTO USERKEY          D11 ZA11442 33700001
         XC    DCBBFRST(4,RDCB),DCBBFRST(RDCB) ZERO BFSTRT  D11 ZA11442 33750001
         MODESET EXTKEY=SUPR       BACK TO SUPERKEY         D11 ZA11442 33800001
         DROP  RA                                           D11 ZA11442 33850001
         B     XCTLOAD3            IF HERE,NONZERO RET-XCTL D11 ZA11442 33900001
EXIT1    LR    RY,RDSECT     RESTORE PLIST, REG 1, FOR OPEN             33950001
         LR    RBAL,RCODE   GOOD(EQ 0) OR TSTRT('14') CODE  D11 ZA07645 34000001
         SVC 3                                                          34050001
         TITLE 'RELEASE PORTION OF IGC0007A'                D11         34100001
*********************************************************************** 34150001
*THE RELEASE AND RLSEALL SUBROUTINES RELEASE BUFFER STORAGE BELONGING * 34200001
*TO THE REQUESTING DEVICE AND ARE ACCESSED WHENVER THE RLSEBFR MACRO- * 34250001
*INSTRUCTION IS ISSUED.                                               * 34300001
*********************************************************************** 34350001
         SPACE 3                                                        34400001
RELEASE  L     RX,MASKON                CHECK BUFPRM FOR FULLWORD ONES  34450001
         L     RY,BUFPRM                RY HAS ADDR OF FULLWRD          34500001
         CL    RX,0(RY)            IS FULLWORD EQ TO ONES               34550001
         BE    RLSEALL             YES,THEN GO RELEASE ALL  D11         34600001
*COMPUTE REQUEST AND STARTING ADDRESS TO MULTIPLES OF 256 AFTER MASKING 34650001
*OFF SYSTEM MASK                                                        34700001
*                                                                       34750001
         LH    RA,2(RY)                NUM BYTES TO RELEASE   LB  AOS/1 34800001
         LA    RY,MASK1                 SET RY EQ X'FF'                 34850001
         AR    RA,RY                    CONVERT BYTES TO SECTIONS       34900001
         SRA   RA,8                    PUT REQUEST IN LO ORDER BYTES    34950001
         SR    RX,RX                   ZERO RX                          35000001
         CR    RA,RX                   IS REQUEST GREATER THAN 0        35050001
         BNH   PRMERR                  NO - INVALID PARAM IN            35100001
*                                         HI-ORDER BYTE OF RA           35150001
RLSEGET  GLOBLOCK OBTAIN,REGS=(RB,RC),                      D11 ZA07645*35200001
               RELATED=(RLSEREL,ENABLE)                     D11 ZA07645 35250001
*                                                                       35300001
         BAL   RNSI,INFODISP            GO TO ACCESS INFO DISP ROUTINE  35350001
*                                       LOAD TASGND FOR DEVICE IN RY    35400001
         LH    RX,0(RZ)            SET RX EQ TASGND FOR DEVICE          35450001
         CLR   RA,RX               COMPARE REQUEST TO TASGND            35500001
         BH    ERRLSE16                 GO TO ERROR AND RETURN RTN      35550001
         L     RB,BUFPRM                RB EQ ADDR OF BUFPRM            35600001
         LH    RB,0(RB)                 RB EQ START ADDR                35650001
         SRL   RB,8                     TRUNCATE ADDRESS TO 256-MULTIPL 35700001
*                                            RX EQ DISP IN BFR TBL      35750001
         EJECT                                                          35800001
*CHECK START ADDRESS FOR VALIDITY                                       35850001
*                                                                       35900001
         CLI   UCBTYP,MOD1             MOD 1                D11         35950001
         BNE   EXPCHK                  NO  - BRANCH                     36000001
         A     RB,HEAD16           ADD MOD1 TBL HEADER LNG  D11         36050001
         B     FLOW1               RETURN TO NORMAL FLOW                36100001
EXPCHK   A     RB,HEADISP          ADD A(MOD2 BFRTBLHDR)     D11        36150001
FLOW1    AR    RB,RBFTBL               ADD BUF TBL ADR TO S DISP        36200001
         LR    RY,RB                         RB PTS TO START ADR IN BFR 36250001
*                                            TBL,SAVE RB IN RY          36300001
         LR    RC,RD               LOAD DEVNDX INTO RC                  36350001
         LR    RX,RZ                    SAVE BFR INFO DISP IN RX        36400001
*COMPARE EACH ENTRY FOR LNG OF REQUEST WITH DEVICE INDEX                36450001
         SR    RD,RD                    SET RD EQ 0                     36500001
         LA    RZ,RY                    SET RZ EQ 1                     36550001
         SR    RE,RE                    SET RE EQ 0                     36600001
BXH      BXH   RE,RZ,OUT                WHEN REQUEST HAS BEEN CHECKED   36650001
*                                            GO OUT                     36700001
         IC    RD,0(RB)                 PUT ENTRY IN RD                 36750001
         CLR   RC,RD                   COMPARE DEVNDX TO ENTRY          36800001
         BNE   ERRLSE30                IF UNEQUAL,GO TO ERR RTN  S21016 36850001
         AR    RB,RZ                    INCREMENT ENTRY ADDR BY 1       36900001
         B     BXH                      BRANCH BACK TO REPEAT           36950001
         EJECT                                                          37000001
*CLEAR ENTRIES RELEASED TO ZERO                                         37050001
OUT      SR    RA,RZ                    SUBTRACT 1 FROM REQUEST TO USE  37100001
         EX    RA,CLRENT                     EX-INSTR                   37150001
*UPDATE TABLES,CHECK RESTART ADDR                                       37200001
         AR    RA,RZ                    ADD 1 TO REQUEST TO UPDATE TBLS 37250001
         LR    RZ,RX                    RESTORE BFR INFO DISP TO RZ     37300001
         LH    RX,0(RZ)                 LOAD RX WITH TASGND FOR DEVICE  37350001
         SR    RX,RA                    SUBTRACT REQUEST FROM TASGND    37400001
         STH   RX,0(RZ)                 STORE UPDATED TASGND            37450001
*                                                                       37500001
         LH    RX,6(RBFTBL)             LOAD RX WITH TOTAVAIL FLD       37550001
         AR    RX,RA                    ADD REQUEST TO TOTAVAIL         37600001
         STH   RX,6(RBFTBL)             STORE UPDATED TOTAVAIL IN BFRTB 37650001
RLSEREL  GLOBLOCK RELEASE,REGS=(RD,RE),                     D11 ZA07645*37700001
               RELATED=(RLSEGET)                            D11 ZA07645 37750001
*CHECK RESTART ADDRESS                                                  37800001
         CLI   CODE,X'04'    ENTERED FROM ASGNBFR?                      37850001
         BE    WRITERR       YES,EXIT WITH ERROR-LOCKS ALREADY FREE     37900001
*                                                                       37950001
         LH    RD,UCBSTART          LOAD RESTART ADDR IN RD D11  YM4067 38000001
         SRL   RD,8                     SET RD EQ MULTIPLE-256-DISP     38050001
         CLI   UCBTYP,MOD1             MOD 1                D11         38100001
         BNE   EXPRES                  NO  - BRANCH                     38150001
         A     RD,HEAD16           ADD MOD1 HDRDISP         D11         38200001
         B     FLOW2               RETURN TO NORMAL FLOW                38250001
EXPRES   A     RD,HEADISP          ADD 72(MOD2)TO RD                    38300001
FLOW2    AR    RD,RBFTBL           ADD BFR TBL ADR TO RD,RD NOW         38350001
*                                            HAS ADDR OF BFR TBL ENTRY  38400001
*                                            CONTAINING THAT RESTART AD 38450001
         SR    RE,RE                    CLEAR RE TO ZERO                38500001
         IC    RE,0(RD)                 SET RE EQ TO BFR TBL ENTRY      38550001
         CLR   RC,RE               COMPARE DEVNDX TO ENTRY              38600001
         BE    SUCCESS                                                  38650001
*IF RESTART ADR IS INVALID, SET ADR TO ALL ONES                         38700001
         LH    RX,MASKON           SET RX EQ TO ALL ONES                38750001
         STH   RX,UCBSTART         CHANGE ADR IN UCB        D11  YM4067 38800001
         LA    RCODE,BADADR         LOAD RETURN CODE EQ 20 (X'14')      38850001
         B     ENABLE1             NO LOCKS HELD,NO ZERO    D11 ZA07645 38900001
         EJECT                                                          38950001
ERRLSE16 LA    RCODE,BADRLS                                             39000001
         B     ENABLE   GO FREELOCKS,ZERO DCBBFST & MSG     D11 ZA07645 39050001
ERRLSE30 EQU   *                                                        39100001
         LA    RCODE,BADREL            LOAD RETURN CODE          S21016 39150001
         B     ENABLE  GO FREELOCKS,ZERODCB,GIVE MSG        D11 ZA07645 39200001
PRMERR   EQU   *                                                 S21016 39250001
         LA    RCODE,RELNEG            LOAD RETURN CODE          S21016 39300001
         B     XCTLOAD3   NOT LOCKED,NO ZERO,JUST GIVE MSG  D11 ZA11442 39350001
         CNOP  2,4                                                      39400001
CLRENT   XC    0(1,RY),0(RY)                                            39450001
    TITLE ' SINGLE LOAD 2250 BUFFER MANAGEMENT, RLSEALL  SECTION '      39500001
RIQNDX   EQU   9                                                        39550001
CVTPTR   EQU   16                                             LE AOS/1  39600001
NINTYSIX EQU   96                                             LE AOS/1  39650001
EXIT     EQU   3                                              LE AOS/1  39700001
X08      EQU   X'08'                   REQ CODE FOR REL ALL      S21016 39750001
MISALGN  EQU   X'24'                   RET CODE-INVALID TABLE    S21016 39800001
BADSIZE  EQU   X'10'                   BUFINQ TABLE TOO SMALL    S21016 39850001
TRNCATED EQU   X'20'                   BUFINQ TRUNCATED TABLE    S21016 39900001
         TITLE 'RELEASE ALL SECTION OF IGC0007A'            D11         39950001
*********************************************************************** 40000001
*THE RLSEALL SUBROUTINE ALLOWS THE USER TO RELEASE ALL BUFFER STORAGE * 40050001
*ASSIGNED TO A PARTICULAR DEVICE WITH ONE MACRO INSTRUCTION.          * 40100001
*********************************************************************** 40150001
         SPACE 3                                            D11         40200001
RLSEALL  EQU   *                                                        40250001
RELALLGT GLOBLOCK OBTAIN,REGS=(RA,RD),                      D11 ZA07645*40300001
               RELATED=(RELALLFR,ENABLE)                    D11 ZA07645 40350001
         BAL   RNSI,INFODIS             GO TO RTN  TO LOAD RZ WITH INFO 40400001
*                                            ADDRESS                    40450001
         LR    RD,RE              SAVE DEVNDX FOR FURTHER USE           40500001
         SR    RX,RX                    CLEAR RX TO ZERO                40550001
         LH    RY,0(RZ)            SET RY EQ TASGND                     40600001
         SR    RCODE,RCODE         CLEAR RETCODE-           D11 ZA07645 40650001
         CLR   RX,RY               COMPARE TASGND TO 0                  40700001
         BE    ENABLE          YES,FREELOCKS AND EXIT       D11 ZA07645 40750001
*                                                                       40800001
         LH    RA,0(RZ)                 RA EQ TASGND FOR DEVICE         40850001
         LA    RX,RY                    SET RX EQ 1                     40900001
         LH    RB,0(RBFTBL)             SET RB EQ TO TBLNGTH            40950001
         SR    RB,RX                    SUBTRACT 1 FROM TBLNGTH TO USE  41000001
*                                            IN THE EX-INSTRUCTION      41050001
         LR    RC,RD               LOAD DEVNDX INTO RC                  41100001
         SR    RC,RX                    SUBTRACT 1 FROM DEVNDX          41150001
         SLL   RC,3                     MULTIPLY RC BY 8 TO INDEX TBL   41200001
         LA    RY,TRANALL                                               41250001
         AR    RC,RY                    ADD TRANALL ADDR TO INDEX       41300001
         CLI   UCBTYP,MOD1             MOD 1                D11         41350001
         BNE   NEXPRESS                NO   -  BRANCH                   41400001
         EX    RB,TRALLEX               EXECUTE ANOTHER TR-INSTR        41450001
         B     NSI                      GOON TO UPDATE TABLE            41500001
NEXPRESS EX    RB,TRALL                 EXECUTE TR INSTRUCTION TO TRANS 41550001
*                                            LATE ENTRIES TO ZERO       41600001
         EJECT                                                          41650001
*UPDATE  BFR TBL                                                        41700001
NSI      LH    RE,6(RBFTBL)             LOAD RE WITH TOTAVAIL FLD       41750001
         AR    RE,RA                    ADD TASGND TO TOTAVAIL          41800001
         STH   RE,6(RBFTBL)             STORE UPDATED TOTAVAIL          41850001
         SR    RE,RE                    SET RE TO ZERO                  41900001
         STH   RE,0(RZ)                 SET TASGND FLD TO ZERO          41950001
         LR    RC,RD               LOAD DEVNDX INTO RC                  42000001
RELALLFR GLOBLOCK RELEASE,REGS=(RD,RE),                     D11 ZA07645*42050001
               RELATED=(RELALLGT)                           D11 ZA07645 42100001
         B     RESTART                  GO TO RESTART CHECK             42150001
*                                                                       42200001
         EJECT                                                          42250001
*                                                                       42300001
*CHECK RESTART ADDRESS                                                  42350001
*                                                                       42400001
RESTART  LH    RD,UCBSTART              RESTART ADDR IN RD  D11  YM4067 42450001
         SRL   RD,8                     SET RD EQ MULTIPLE-256-DISP     42500001
         CLI   UCBTYP,MOD1             MOD 1                D11         42550001
         BNE   NEXPRE                  NO  - BRANCH                     42600001
         A     RD,HEAD16           ADD MOD1 HDR             D11         42650001
         B     FLOW                                         D11         42700001
NEXPRE   A     RD,HEADISP              ADD 72 TO RD                     42750001
FLOW     AR    RD,RBFTBL           ADD BFR TBL ADR TO RD,RD NOW         42800001
*                                            HAS ADDR OF BFR TBL ENTRY  42850001
*                                            CONTAINING THAT RESTART AD 42900001
         SR    RE,RE                    CLEAR RE TO ZERO                42950001
         IC    RE,0(RD)                 SET RE EQ TO BFR TBL ENTRY      43000001
         CLR   RC,RE               COMPARE DEVNDX TO ENTRY              43050001
         BE    SUCCESS                                                  43100001
*IF RESTART ADR IS INVALID, SET ADR TO ALL ONES                         43150001
INVALID  LH    RX,MASKON           SET RX EQ TO ALL ONES                43200001
         STH   RX,UCBSTART         CHANGE ADR IN UCB        D11  YM4067 43250001
         LA    RCODE,BADADR         LOAD RETURN CODE EQ 20 (X'14')      43300001
         B     ENABLE1             ZERODCB,GIVE MSG         D11 ZA07645 43350001
         EJECT                                                          43400001
*                                                                       43450001
*            EXECUTE INSTRUCTIONS AND OUT-OF-LINE CODE                  43500001
*                                                                       43550001
         CNOP  2,4                                                      43600001
TRALL    TR    HEADER(1,RBFTBL),0(RC)                                   43650001
         CNOP  2,4                                                      43700001
TRALLEX  TR    16(1,RBFTBL),0(RC)       RLSEALL FOR EXPRESS PROG        43750001
*                                                                     * 43800001
*                                                                       43850001
*                                                                       43900001
INFODIS  SR    RE,RE              CLEAR RE TO ZERO                      43950001
         IC    RE,UCBDI            INSERT DEVNDX IN RE                  44000001
         LR    RZ,RE               LOAD DEVNDX INTO RZ                  44050001
         LA    RX,RY               SET RX EQ 1                          44100001
         SR    RZ,RX               SUBTRACT 1 FROM DEVNDX               44150001
         SLL   RZ,3                MULTIPLY DEVNDX-1 BY 8               44200001
         LA    RD,8(RBFTBL)        SET RD EQ BFRTBL ADR +8              44250001
         AR    RZ,RD               RZ CONTAINS THIS DEVICES INFO DISP   44300001
         BR    RNSI                               RETURN                44350001
         TITLE 'BUFFER INQUIRY SECTION OF IGC0007A'         D11         44400001
*********************************************************************** 44450001
*                                                                     * 44500001
*THE BUFINQ SUBROUTINE ALLOWS THE USER TO OBTAIN A TABLE OF ADDRESSES * 44550001
*OF THE BUFFER STORAGE ASSIGNED TO THAT DISPLAY UNIT.                 * 44600001
*                                                                     * 44650001
*********************************************************************** 44700001
*CHECK TABLE ADDR PASSED AS PARAMETER FOR VALIDITY                      44750001
BUFINQ   TM    TABADR+3,X'03'      TEST FOR FULLWORD ALIGNMENT          44800001
         BC    5,PREPMSG1          PREPARE FOR IFF532I        LE AOS/1  44850001
         L     RC,TABSIZ           SET RC EQ SIZE OF TABLE IN BYTES     44900001
         L     RB,TABADR           SET RB EQ ADDR OF TABLE              44950001
         LA    RX,RB               SET RX EQ 4                          45000001
         CR    RX,RC               IS TABSIZ LESS THAN 4-BYTES,IF YES   45050001
         BH    PREPMSG2            PREPARE FOR IFF533I        LE AOS/1  45100001
         L     RE,CVT              GET                      D11 ZA11442 45150001
         L     RE,0(RE)            TO                       D11 ZA11442 45200001
         L     RE,4(RE)            CURRENT                  D11 ZA11442 45250001
         USING TCB,RE              TCB                      D11 ZA11442 45300001
         MODESET EXTKEY=TCB,WORKREG=2  GOTO USERKEY         D11 ZA11442 45350001
         BAL   RNSI,INFODIS                                             45400001
         LH    RA,0(RZ)            SET RA EQ TASGND                     45450001
         SR    RZ,RZ               SER RZ TO 0                          45500001
         CR    RZ,RA               IS TASGND EQ ZERO, IF SO INSERT      45550001
         BE    INSERT                   RESTART, TAB END IND AND RETURN 45600001
         LH    RZ,UCBSTART         OTHERWISE INSERT RESTART D11  YM4067 45650001
         ST    RZ,0(RB)            AND BEGIN SEARCH                     45700001
         SR    RZ,RZ               SET RZ EQ TO ZERO                    45750001
         STH   RZ,0(RB)            SET 1ST HALFWORD TO ZERO             45800001
         LA    RD,RY               SET RD EQ 1                          45850001
         SR    RE,RD               SUBTRACT 1 FROM DEVNDX IN RE         45900001
         SLL   RE,4                MULTIPLY RE BY 16                    45950001
         LA    RD,INQTAB           LOAD INQ TRT TAB ADR IN RD           46000001
         AR    RE,RD               ADD ADDR TO INDEX FORMED FROM DEVNDX 46050001
         LH    RD,TBLNGTH          SET RD EQ TABLE LENGTH               46100001
         LA    RX,RY               SET RX EQ 1                          46150001
         SR    RD,RX               SUBTRACT 1 FROM TBLNGTH TO USE IN EX 46200001
         LR    RIQNDX,RBFTBL       EXECUTE SEARCH FOR FIRST SECTION     46250001
         CLI   UCBTYP,MOD1             MOD 1                D11         46300001
         BNE   MODINQ              NO BRANCH                            46350001
         LA    RX,16               SET RX EQ 16             D11         46400001
         AR    RIQNDX,RX           ADD 16 TO RIQNDX         D11         46450001
         LA    RX,RB               RESET RX TO 4 BEFORE RET D11         46500001
         B     CHECK2              RETURN TO NORMAL FLOW    D11         46550001
MODINQ   A     RIQNDX,HEADISP      FOR BASIC MOD ADD 72                 46600001
         LA    RX,RB                SET RX EQ TO 4                      46650001
CHECK2   SR    RC,RX               SUBTRACT 4 FROM TABSIZ               46700001
         AR    RB,RX               ADD 4 TO TAB ADDR                    46750001
         CR    RX,RC               CHECK TABSIZ AND AMT ASGND CTRS      46800001
         BH    CHECK1              IF SIZE LESS THAN 4 CHECK FURTHER    46850001
         SR    RZ,RZ               SET RZ EQ 0                          46900001
         CR    RZ,RA               TASGND EQ 0 ?                        46950001
         BE    ENDIND              GO TO INSERT TAB END IND AND RETURN  47000001
         EJECT                                                          47050001
*                                                                       47100001
*SEARCH BFR TABLE FOR DEVICE'S SECTIONS                                 47150001
*                                                                       47200001
INQUIRE  EX    RD,TRTINQ           SEARCH FOR SECTION BELONGING TO DEV  47250001
*COMPUTE START NG BFR ADDRESS AND PUT IN TABLE                          47300001
         SR    RY,RIQNDX           SET RY TO LNG FROM STRT OF SEARCH    47350001
         SR    RD,RY               TO STOP BYTE TO ADJUST TBLNGTH       47400001
         AR    RY,RIQNDX           SET RY BACK TO STOP-BYTE ADR         47450001
         LR    RIQNDX,RY           SAVE STOP-BYTE ADR OF TRT            47500001
         CLI   UCBTYP,MOD1             MOD 1                D11         47550001
         BNE   NEXPSUB             NO - BRANCH                          47600001
         LA    RX,16               SET RX E Q 16            D11         47650001
         SR    RY,RX               SUBTRACT HEADISP         D11         47700001
         B     BACK                RETURN TO NORMAL FLOW    D11         47750001
NEXPSUB  S     RY,HEADISP          SUBTRACT 72 FROM STOP-BYTE ADR       47800001
BACK     SR    RY,RBFTBL           SUBTRACT BFRTBL ADR FROM STOP-BYTE   47850001
*                                       ADDR TO GET AT ACTUAL BFR CORE  47900001
*                                       ADDR                            47950001
         SLL   RY,8                MULTIPLY DISP BY 256 TO GET REAL ADR 48000001
         STH   RY,0(RB)            MOVE START ADDR IN TABLE             48050001
         LR    RY,RIQNDX           RESTORE STOP-BYTE ADR IN RY          48100001
*COMPUTE LENGTH OF CONTIGUOUS SECTIONS IN BYTES                         48150001
         LA    RX,RY               SET RX EQ 1                          48200001
*                                  CLEAR RZ TO ZERO                     48250001
GETLNG   AR    RY,RX               ADD 1 TO ADR TO CHECK NEXT ENTRY     48300001
         CLC   36(1,RUCB),0(RY)    COMPARE DEVNDX TO NEXT ENTRY         48350001
         BE    GETLNG              IF EQ GO ON TO NEXT ENTRY AND COMP   48400001
         SR    RY,RIQNDX           SUBTRACT TO GET NUM OF CONTIGUOUS    48450001
*                                       SECTIONS IN RY                  48500001
         SR    RD,RY               ADJUST TBLNGTH FOR NEXT TRT          48550001
         SR    RA,RY               SUBTRACT NUMBER FROM TASGND          48600001
         AR    RIQNDX,RY           ADJUST NEW START ADR FOR TRT         48650001
*COMPUTE LNG IN BYTES AND MOVE INTO TABLE                               48700001
*                                                                       48750001
         SLL   RY,8                MULTIPLY SECTIONS BY 256 FOR BYTES   48800001
         STH   RY,2(RB)            STORE LNG OF CONTIG BYTES IN TABLE   48850001
         LA    RX,RB               SET RX EQ 4 TO UPDATE CTRS           48900001
         B     CHECK2              BEGIN SEARCH AGAIN FOR NEXT ENTRIES  48950001
INSERT   LH    RZ,UCBSTART         RZ SET EQ RESTART ADR    D11  YM4067 49000001
         ST    RZ,0(RB)            PUT RESTART ADR IN TABLE             49050001
         SR    RZ,RZ               SET RZ EQ TO ZERO                    49100001
         STH   RZ,0(RB)            SET 1ST HALFWORD TO ZERO             49150001
         SR    RC,RX               SUBTRACT 4 FROM TABSIZ               49200001
         CR    RX,RC               IS TABSIZ LESS THAN 4, IF YES RETURN 49250001
         BH    CODE0                    WITH CODE X'00'                 49300001
*                                                                       49350001
         AR    RB,RX               OTHERWISE ADD 4 TO TABADR            49400001
ENDIND   L     RZ,MASKON           SET RZ EQ ALL ONES                   49450001
         ST    RZ,0(RB)            INSERT TABLE END INDICATOR           49500001
         B     CODE0               RETURN TO CALLER                     49550001
PREPMSG1 EQU   *                                              LE AOS/1  49600001
         L     RA,ADDR1            ADDRESS OF IFF532I         LE AOS/1  49650001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 49700001
         LA    RD,LGTH1            LENGTH OF MESSAGE          LE AOS/1  49750001
         LA    RE,MISALGN          WRONG ALIGNMENT RET CODE   LE AOS/1  49800001
         B     ISSUEMSG            GO ISSUE WTO               LE AOS/1  49850001
PREPMSG2 EQU   *                                              LE AOS/1  49900001
         L     RA,ADDR2            ADDRESS OF IFF533I         LE AOS/1  49950001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 50000001
         LA    RD,LGTH2            LENTH OF MESSAGE 2         LE AOS/1  50050001
         LA    RE,BADSIZE          LOAD BAD SIZE RET CODE     LE AOS/1  50100001
         B     ISSUEMSG            GO ISSUE WTO               LE AOS/1  50150001
PREPMSG3 EQU   *                                              LE AOS/1  50200001
         MODESET EXTKEY=SUPR ONLY MSG3 DETECTED IN USERKEY  D11 ZA11442 50250001
         L     RA,ADDR3            ADDRESS OF IFF534I         LE AOS/1  50300001
         LA    RA,D0(RA,RBASE)         INTO RA                LB  AOS/1 50350001
         LA    RD,LGTH3            LENGTH OF MESSAGE          LE AOS/1  50400001
         LA    RE,TRNCATED         TRUNCATED RET CODE         LE AOS/1  50450001
* RA (REG3) CONTAINS THE MESSAGE ADDRESS                      LE AOS/1  50500001
* RD (REG6) CONTAINS THE MESSAGE  LNGTH                       LE AOS/1  50550001
* RE (REG7) CONTAINS THE RETURN CODE                          LE AOS/1  50600001
ISSUEMSG EQU   *                                              LE AOS/1  50650001
         L     RB,CVTPTR           ADDR OF CVT                LE AOS/1  50700001
         L     RB,RX(RB)           ADDR OF TCB PTR            LE AOS/1  50750001
         L     RB,RB(RB)           CURRENT TCB ADDRESS        LE AOS/1  50800001
         L     RB,D0(RB)               CURRENT RB ADDR                  50850001
         LA    RB,NINTYSIX(RB)     ADDR OF SVRB EXTENDED      LE AOS/1  50900001
         LR    RC,RB               PRIME RC                   LE AOS/1  50950001
         LA    RB,RB(RB)               RB=RB+4                LE  AOS/1 51000001
         MVC   RX(GMLNG,RB),GMLIST GM LIST TO SVRB EXT        LE AOS/1  51050001
         GETMAIN A=(RC),MF=(E,(RB)) GET MSG BUFFER EXT        LE AOS/1  51100001
         LTR   RBAL,RBAL           GM SUCCESSFUR?             LE AOS/1  51150001
         BNZ   SKIPWTO             NO                         LE AOS/1  51200001
* RB POINTS TO GETMAINED AREA                                 LE AOS/1  51250001
         L     RZ,RX(RC)           MSG BUFFER ADDRESS         LE AOS/1  51300001
         EX    RD,MOVELIST         MESSAGE TO BUFFER          LE AOS/1  51350001
         WTO   MF=(E,(RZ))    ISSUE WTO                       LE AOS/1  51400001
         FREEMAIN A=(RC),MF=(E,(RB)) FREE MSG BUFFER          LE AOS/1  51450001
SKIPWTO  EQU   *                                              LE AOS/1  51500001
         LR    RBAL,RE             RETURN CODE IN REG 15    D11  AOS/1  51550001
         SVC   EXIT                RETURN                               51600001
CHECK1   SR    RZ,RZ               SET RZ EQ 0                          51650001
         CR    RZ,RA               IS TASGND EQ 0, IF NOT RETURN CODE   51700001
         BNE   PREPMSG3            PREPARE FOR IFF534I        LE AOS/1  51750001
*                  OTHERWISE RETURN WITH CODE X'00'                     51800001
CODE0    MODESET EXTKEY=SUPR       BACK TO SUPERKEY         D11 ZA07645 51850001
         SR    RCODE,RCODE         INDICATE RETCODE EQ 0    D11 ZA11442 51900001
         B     EXIT1               RETURN W CODE=0          D11 ZA07645 51950001
         TITLE 'IGC0007A CONSTANTS AND DSECTS'                          52000001
*                                                                     * 52050001
TRANALL  DC   X'0000020304050607'                                       52100001
         DC    X'0001000304050607'                                      52150001
         DC    X'0001020004050607'                                      52200001
         DC    X'0001020300050607'                                      52250001
INQTAB   DC    X'00010000000000000000000000000000'                      52300001
         DC    X'00000100000000000000000000000000'                      52350001
         DC    X'00000001000000000000000000000000'                      52400001
         DC    X'00000000010000000000000000000000'                      52450001
         DC    X'00000000000100000000000000000000'                      52500001
         DC    X'00000000000001000000000000000000'                      52550001
         DC    X'00000000000000010000000000000000'                      52600001
         DC    X'00000000000000000100000000000000'                      52650001
*                                                                     * 52700001
*                                                                     * 52750001
         CNOP  2,4                                                      52800001
         SPACE 5                                                        52850001
TRTINQ   TRT   0(1,RIQNDX),0(RE)   SEARCH INSTRUCTION                   52900001
         CNOP  0,4                                                      52950001
ADDR1    DC    A(MSG1-ORG)         ADDRESS OF MSG 1           LE AOS/1  53000001
ADDR2    DC    A(MSG2-ORG)         ADDRESS OF MESSAGE 2       LE AOS/1  53050001
ADDR3    DC    A(MSG3-ORG)         ADDRESS OF MESSAGE 3       LE AOS/1  53100001
         EJECT                                                          53150001
MSG1     WTO   'IFF532I BUFINQ FOUND TABLE NOT ALIGNED ON FULL-WORD',ROX53200001
               UTCDE=11,DESC=7,MF=L                           LE AOS/1  53250001
         SPACE                                                          53300001
LGTH1    EQU   *-MSG1                                         LE AOS/1  53350001
         SPACE 3                                                        53400001
MSG2     WTO   'IFF533I BUFINQ FOUND TABLE SIZE LESS THAN FOUR',ROUTCDEX53450001
               =11,DESC=7,MF=L                                LE AOS/1  53500001
         SPACE                                                          53550001
LGTH2    EQU   *-MSG2                                         LE AOS/1  53600001
         SPACE 3                                                        53650001
MSG3     WTO   'IFF534I BUFINQ TRUNCATED TABLE',ROUTCDE=11,DESC=7,MF=L  53700001
         SPACE                                                          53750001
* THE FOLLOWING INFORMATION APPLIES TO MSG 3:                 LE AOS/1  53800001
LGTH3    EQU   *-MSG3                                         LE AOS/1  53850001
GMLIST   GETMAIN EC,LV=80,MF=L     GM FOR MESSAGE AREA        LE AOS/1  53900001
GMLNG    EQU   *-GMLIST                                       LE AOS/1  53950001
MOVELIST MVC   RX(RX,RZ),RX(RA)                               LE AOS/1  54000001
UCBLEN   DC    AL2(UCBBTB+L'UCBBTB-UCBOB+UCBCURPX) FOR 2250 D11 ZA07645 54050001
UCBPRFXL DC    AL2(UCBCURPX)       UCB LOCKWORD PREFIX LEN  D11 ZA07645 54100001
PATCH    DC    C'IGC0007A 40 BYTE PATCH AREA'               D11         54150001
         DS    0H   ITS NICE WHEN PATCH IS ON INST BOUND    D11         54200001
         DC    40X'FF'            PATCH AREA                D11         54250001
         EJECT                                                          54300001
*                                                                       54350001
*                         DSECTS                                        54400001
*                                                                       54450001
         SPACE 3                                                        54500001
BFRTBL   DSECT                                                          54550001
TBLNGTH  DS    CL2                                                      54600001
NUMDEV   DS    CL2                                                      54650001
EXPBFR   DS    CL2                                                      54700001
TOTAVAIL DS    CL2                                                      54750001
TASGND   DS    CL2                                                      54800001
DISP     DS    CL2                                                      54850001
ZONESZ   DS    CL2                                                      54900001
TG       DS    CL2                                                      54950001
         DS    CL56                                                     55000001
DVCASGND DS    CL128                                                    55050001
         SPACE 3                                                        55100001
PARLST   DSECT                          DSECT FOR PARAM LIST PASSED     55150001
CODE     DS    CL1                      REQUEST CODE                    55200001
DCBADR   DS    CL3                      DCB-ADDRESS                     55250001
BUFPRM   DS    CL4                      BUFPRAM PTR                     55300001
         ORG   BUFPRM                                                   55350001
TABADR   DS    CL4                      TABLE-ADDRESS                   55400001
TABSIZ   DS    CL4                      TABLE SIZE                      55450001
         EJECT                                                          55500001
         IHAPSA                                                         55550001
         EJECT                                                          55600001
         IKJTCB                                                         55650001
         EJECT                                              D11         55700001
         IEFUCBOB LIST=YES,PREFIX=YES                       D11         55750001
         END                                                            55800001
