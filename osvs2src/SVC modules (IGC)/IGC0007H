         TITLE     'IGC0007H  -  DADSM  -  LSPACE SVC ROUTINE'          00200000
IGC0007H CSECT                                                   Y02080 00600002
*          VS2 RELEASE 03 DELETIONS/CHANGES                             00600403
*0000265900                                                     Z30AAJC 00600803
*          VS2 RELEASE 01.6 DELETIONS                           YA00295 00601002
*0000                                                                   00602002
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00603002
*0000006000,018000-024000,044000,049000,059000-061000,118000-    Y02080 00603102
*0000122000,130000,152000,156000,170000,176000-180000,186000,    Y02080 00603202
*0000206000,233000,233420-233600,233720,233840-233900,234460-    Y02080 00603302
*0000234960,235982,238000-238040,238960-246800,246810-260000,    Y02080 00603402
*0000262300-262400,263110-263130,263300-264900,274810,278500-    Y02080 00603502
*0000280500,284000,287800-288000,292000-300000,316000-346000,    Y02080 00603602
*0000370300-370700,386000-390000,392000-402000,418900-419000,    Y02080 00603702
*0000419300,468000,488000-528000,687200-696000,722200-724000,    Y02080 00603802
*0000760010-761200,766000,780200-781000,782000-842000,852000-    Y02080 00603902
*0000876000                                                      Y02080 00604002
*0000053000-056000,090000-092000,114000-116000,124000-125200,    Y02078 00604102
*0000164000-168000                                               Y02078 00604202
*0000000300-001500,233780-233960,370100,418050-418100,461500,    Y02082 00604302
*0000463500-463900                                               Y02082 00604402
*0000                                                            Y02144 00604502
*0000                                                            Y02132 00604602
*0000247400                                                      YM1312 00604802
*0000                                                            YM1241 00604902
*0000240250-240350,247900                                        YM5076 00605002
*          VS2 RELEASE 01 DELETIONS                                     00700000
*0000                                                            YM2930 00750000
*                                                                       00760000
*          RELEASE 18 DELETIONS                                         00800000
*          RELEASE 19 DELETIONS                                         01000000
*2483034000-072000,084000-092000,098000-104000,144000-146000,    S19028 01020019
*2483244000-246000,272000-276000,294000,460000-678000,680000,    S19028 01040019
*2483694000,698000-700000,710000,714000-718000,722000,742000-    S19028 01060019
*2483752000,772000-776000,862000                                 S19028 01080019
*2483                                                            A27329 01100019
*2483238400-239200                                               M3941  01150019
*          RELEASE 20 DELETIONS                                         01200000
*1242300000                                                      M5414  01250020
*1242254000                                                      A35588 01300020
*1242                                                            S20201 01350020
*          RELEASE 21 DELETIONS                                         01400000
*1195087000                                                      A38860 01402021
*1195004000,233300                                               A37199 01405021
*1195033000,048000-058000,092000,098000-104000,132000,284000     A40793 01410021
*1195143000,720600-721200,793000,794000,826000-832000,844000-    A42182 01430021
*1195850000                                                      A42182 01460021
*1195370100                                                      A42199 01500021
*0000288000,688000                                              SA49351 01550021
*          RELEASE 21.7 DELETIONS                                       01550202
*0000188000,204000,206000,220000,234000,260000,264000,266000,   SA48490 01551002
*0000268000-270000,270300,276000,276600-278000,312000,316000,   SA48490 01552002
*0000318000-342000,344000,348000,564000-573000                  SA48490 01552202
*0000240000-242000,250000,252000-258000,274800,275700           SA57953 01553002
*          RELEASE 22 DELETIONS                                         01600000
*                                                                       02400002
*                                                                       02401002
* MODULE NAME - IGC0007H                                                02402002
*                                                                       02403002
* DESCRIPTIVE NAME -  DADSM  -  LSPACE SVC ROUTINE                      02404002
*                                                                       02405002
* COPYRIGHT - NONE                                                      02406002
*                                                                       02407002
* CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD          02408002
*                                                                       02409002
*                                                                       02600000
* STATUS CHANGE LEVEL 003                                               02800021
*                                                                       03000000
* FUNCTION/OPERATION                                                    03200000
*    THIS MODULE IS THE FIRST LOAD OF SVC 78. THE SVC IS ISSUED         03300021
*    WHEN A DISPLAY SPACE COMMAND IS IN EFFECT OR SMF VOLUME            03400019
*    INFORMATION IS REQUIRED AND A DIRECT ACCESS VOLUME IS TO           03500019
*    BE DISMOUNTED. ITS FUNCTION IS TO TOTAL UP THE SPACE STILL         03600019
*    AVAILABLE ON A VOLUME AT DISMOUNT TIME AND TO RETURN THIS          03700019
*    INFORMATION TO THE CALLER AND/OR RECORD IT ON THE SMF DATA         03800019
*    SET. THIS MODULE LINKS TO THE VALIDITY CHECK ROUTINE TO            03900019
*    CHECK THE CALLER'S MESSAGE AREA POINTER AND TO THE RESIDENT        04000019
*    DIRECT ACCESS ADDRESS CONVERSION ROUTINE TO CONVERT THE            04100019
*    'TTR0' OF THE VTOC TO AN ABSOLUTE ADDRESS. IT ALSO CHECKS          04200019
*    TO INSURE THAT THE CALLER IS IN PROTECT KEY ZERO IF SMF            04300019
*    FUNCTIONS HAVE BEEN SPECIFIED. IT OBTAINS THE CORE FOR THE         04400002
*    WORK AREA REQUIRED BY THE SVC 78. THE CHANNEL PROGRAMS TO          04500019
*    READ THE DATA PORTION OF THE FORMAT 4 DSCB AND THE FIRST           04600019
*    FORMAT 5 DSCB ARE RELOCATED IN THE WORK AREA AND                   04700019
*    INITIALIZED. AFTER THIS MODULE ENQ'S ON THE VTOC, IT PASSES        04800021
*    CONTROL TO THE NEXT LOAD VIA IECRES (LOAD).  THE SECOND LOAD       04900002
*    (IGC0107H) READS IN THE FORMAT 4 DSCB AND THE FIRST FORMAT 5       05000021
*    DSCB. AS IT READS IN ANY CHAINED FORMAT 5 DSCB'S, IT TOTALS        05100021
*    THE AVAILABLE SPACE LISTED IN THEM AND SAVES THE LARGEST EXTENT.   05200021
*    IF SMF HAS BEEN SPECIFIED, THE MODULE IDENTIFICATION IS SENSED,    05300002
*    AND THE VOLUME LABEL IS READ.  IGC0107H BUILDS AN SMF RECORD       05400002
*    TYPE 19 AND RECORDS IT ON THE SMF DATA SET. IF 'DISPLAY SPACE'     05600002
*    INFORMATION IS REQUIRED, THE SPACE INFORMATION COLLECTED           05700021
*    FROM THE FORMAT 5 DSCB(S) IS CONVERTED TO EBCDIC AND PLACED IN     05800021
*    THE CALLER'S MESSAGE AREA. AFTER DEQ'ING THE VTOC AND FREEING      05900002
*    THE WORK AREA, IGC0107H RETURNS TO THE CALLER.                     06000002
*                                                                       07400000
* ENTRY POINT                                                           07600000
*    IGC0007H - ENTRY IS MADE TO THIS ROUTINE BY ISSUING AN SVC 78.     07800000
*                                                                       08000000
* INPUT ON ENTRY TO THIS MODULE                                         08200000
*    REGISTER ZERO WILL CONTAIN A POINTER TO THE UCB. BIT 0 OF          08300019
*    REGISTER ONE WILL BE ONE IF SMF VOLUME INFORMATION IS              08400019
*    DESIRED. BIT 1 OF REGISTER 1 WILL BE ONE IF THIS MODULE            08500019
*    SHOULD TEST TO DETERMINE IF SMF VOLUME INFORMATION IS              08600019
*    DESIRED. BITS 8 - 31 OF REGISTER ONE WILL CONTAIN THE              08700021
*    START ADDRESS OF A 30 BYTE AREA IN WHICH THE DISPLAY SPACE         08800019
*    DATA SHOULD BE RETURNED. A ZERO ADDRESS INDICATES THAT THE         08900019
*    DISPLAY SPACE INFORMATION IS NOT REQUIRED.  REGISTER FOUR          09000002
*    POINTS TO THE TCB.                                                 09100002
*                                                                       09400000
* OUTPUT                                                                09600000
*    WHEN CONTROL IS PASSED TO IGC0107H, THE VTOC IS ENQ'ED.            09800021
*    REGISTER 7 POINTS TO THE UCB.                                      10000021
*    REGISTER 9 POINTS TO THE 'DISPLAY SPACE' MESSAGE AREA.             10200021
*    REGISTER 13 POINTS TO THE WORKAREA.                                10400021
*                                                                       10600000
* EXTERNAL ROUTINES                                                     10800000
*    CVTPCNVT      - TTR CONVERSION ROUTINE                             11000000
*    CVT0VL00      - VALIDITY CHECK ROUTINE                             11200000
*    IECRES        - GET AND RELEASE CORE FOR WORK AREA                 11800002
*    RESERVE (56)  - ENQUEUE THE VTOC                                   12200002
*                                                                       12600000
* EXITS                                                                 12800000
*    CONTROL IS RETURNED TO THE CALLER IN BOTH NORMAL AND               13000002
*    ERROR EXITS. REGISTER 15 WILL CONTAIN A RETURN CODE. IF AN         13100021
*    ERROR OCCURS AND THE CALLER IS 'DISPLAY SPACE', AN ERROR           13200021
*    MESSAGE IS PLACED IN THE CALLER'S MESSAGE AREA.                    13300021
*                                                                       13400000
* RETURN CODES THAT CAN BE ISSUED BY LSPACE.                            13600000
*    00 - SUCCESSFUL PROCESSING                                         13800000
*    04 - PERMANENT I/O ERROR                                           14000000
*    08 - NON-STANDARD OS VOLUME                                        14200000
*    0C - INVALID UCB POINTER OR NOT A DIRECT ACCESS VOLUME OR          14260021
*         UCB NOT READY                                                 14320021
*    10 - UNSUCCESSFUL VALIDITY CHECK ON CALLER'S MESSAGE               14400019
*         POINTER OR INVALID SMF INDICATOR                              14500019
*                                                                       14800000
* TABLES/WORK AREAS                                                     15000000
*    LSPACE WORK AREA DESCRIBED BY MACRO IECLSPWA                       15200002
*                                                                       15400000
* ATTRIBUTES  REENTRANT                                                 15600002
*                                                                       15800000
* OTHER MACROS USED                                                     16000000
*    IECLSPWA - LSPACE WORK AREA EXPANSION                              16100002
*    IECSDSL1 - BUILD DSCB'S                                            16200000
*    IECDSECS - EXPANDS THE CVT, PSA, RB, RRPL, SMF, TCB, UCB DSECTS    16400002
*                                                                       17200000
*                                                                       17400000
         BALR  BASEREG,0                                                18200000
         USING BEGIN,BASEREG                                            18400000
         USING LSPACWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 18600002
         USING CVT,RCVT                                                 19000000
*                                                                       19200000
REGZERO  EQU   0                                                        19400000
REGONE   EQU   1                                                        19600000
RSMCA    EQU   1                                                 S19028 19700019
REGTWO   EQU   2                                                        19800000
REGTHREE EQU   3                                                        20000000
REGFOUR  EQU   4                                                        20200000
REGFIVE  EQU   5                        MSG PTR TO USER'S AREA          20400002
REGSIX   EQU   6                                                        20800000
REGSEVEN EQU   7                                                        21000000
RUCBPTRL EQU   7                        UCB POINTER                     21200000
REGEIGHT EQU   8                                                        21400000
REGNINE  EQU   9                                                        21600000
REGTEN   EQU   10                                                       21800000
WORKR    EQU   11                       WORK REGISTER           SA48490 22000002
BASEREG  EQU   12                       BASE REGISTER                   22200000
RWKAREA  EQU   13                       WORK AREA POINTER               22400000
REGSTORE EQU   13                                                       22600000
RBAK     EQU   14                                                       22800000
RCVT     EQU   15                                                       23000000
RERRPASS EQU   15                       ERROR PASS REGISTER             23200000
R15      EQU   15                       REGISTER 15              Y02080 23203002
R0       EQU   0                        WORK REGISTER            S20201 23306020
R2       EQU   2                        WORK REGISTER            S20201 23312020
R3       EQU   3                        WORK REGISTER            S20201 23318020
R9       EQU   9                        WORK REGISTER            A37199 23319021
*                                                                       23320021
* OTHER EQUATES                                                         23321021
*                                                                       23322021
FW       EQU   4                        BYTES IN A  FULL WORD    S20201 23324020
NONZERO  EQU   4                        NON-ZERO VALUE           YM1312 23325002
UNRELATD EQU   X'02'                    UNRELATED FLAG IN IOB    A37199 23330021
C7       EQU   7                        DISP OF SEVEN            S20201 23336020
C1       EQU   1                        ONE CHARACTER            S20201 23366020
EXTSA    EQU   96                       DISP. TO SVRB SAVE AREA  Y02080 23374002
DADEV    EQU   X'20'                    TESTS FOR DIRECT ACCESS SA48490 23546002
*                                       DEVICE                  SA48490 23596002
K2       EQU   2                        DISPLACEMENT OF TWO     SA48490 23597002
K29      EQU   29                       DISPLACEMENT OF 29      SA57953 23598002
*                                                                       23599002
* THIS SECTION SAVES REGISTERS BEFORE VALIDITY CHECKING THE             23599202
* MESSAGE AREA POINTER                                                  23599402
*                                                                       23599602
BEGIN    LR    REGSTORE,REGZERO         SAVE UCB POINTER                23600000
         LR    REGFIVE,REGONE           SAVE MSG PTR             S19028 23808019
         XR    REGZERO,REGZERO                                   S19028 23812019
         SLDL  REGZERO,8                ISOLATE AND SAVE THE     S19028 23816019
         SRL   REGONE,8                 SMF INDICATOR            S19028 23820019
         LR    REGSIX,REGZERO                                    S19028 23824019
         LA    REGZERO,X'3F'            TEST FOR A VALID SMF     S19028 23828019
         NR    REGZERO,REGSIX           INDICATOR                S19028 23832019
         BNZ   ERRVAL                   BRANCH IF INVALID        S19028 23836019
*                                                                       23837002
*** IF THE CALLER IS IN PROTECT KEY ZERO OR IN SUPERVISOR               23838002
*   STATE, THE MESSAGE POINTER DOES NOT HAVE TO BE VALIDITY CHECKED     23839002
*   SINCE HE MAY USE ANY REGION IN MAIN STORAGE                         23840002
*                                                                       23860002
         LR    REGNINE,REGONE           SAVE MESSAGE POINTER     Y02080 23880002
         L     REGEIGHT,0(,REGFOUR)     LOAD SVRB ADDRESS        Y02080 23900002
         STM   WORKR,REGFOUR,EXTSA(REGEIGHT)  SAVE REGS 11-4     Y02080 23920002
         XR    REGSEVEN,REGSEVEN        INITIALIZE REGISTER      Y02080 23940002
         TESTAUTH FCTN=1,KEY=YES,STATE=YES,BRANCH=YES            Y02080X23960002
                                        TEST IF CALLER IN KEY 0  Y02080X23980002
                                        OR SUPERVISOR STATE      Y02080 24000002
         LTR   R15,R15                  TEST IF ANY CASE IS TRUE Y02080 24010002
         BZ    RESTORE                  BRANCH IF YES            Y02080 24020002
         LTR   REGSIX,REGSIX            TEST IF SMF SPECIFIED    YM5076 24022002
         BZ    OBTNLOCK                 BRANCH IF NOT            YM5076 24024002
         LA    REGSEVEN,NONZERO         NO SMF FUNCTIONS CAN BE  YM5076X24026002
                                        SPECIFIED IF NOT IN KEY  YM5076X24028002
                                        ZERO OR SUPERVISOR STATE YM5076 24030002
         B     RESTORE                  GO RESTORE REGISTERS     YM5076 24032002
*                                                                YM5076 24034002
OBTNLOCK SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02080X24040002
               RELATED=(LOCAL,IGC0007H(RLSELOCK))  OBTAIN LOCK   Y02080 24060002
         LM    WORKR,RBAK,EXTSA(REGEIGHT) RESTORE REGS 11-14     YM1241 24065002
*                                                                       24680202
*** THIS SECTION INITIALIZES FOR THE VALIDITY CHECK ROUTINE AND         24680402
*   CHECKS IF THE MESSAGE POINTER IS IN THE CALLER'S REGION             24680602
*                                                                       24680802
         LA    REGONE,0(REGFIVE)        BEGINNING ADDRESS        Y02080 24681002
         LA    REGTWO,K29(REGONE)       ENDING ADDRESS           Y02080 24690002
*                                       REG 4 POINTS TO TCB      Y02080 24700002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 24710002
         L     RCVT,CVT0VL00            VALIDITY CHECK RTN ADDR  Y02080 24720002
         BALR  RBAK,RCVT                LINK TO VALIDITY CHECK   Y02080 24730002
         BZ    RLSELOCK                 BRANCH IF VALID ADDRESS  YM1312 24735002
         LA    REGSEVEN,NONZERO         INDICATE INVALID ADDRESS YM1312 24740002
*                                                                       24745002
RLSELOCK SETLOCK RELEASE,TYPE=LOCAL,                             Y02080X24750002
               RELATED=(LOCAL,IGC0007H(OBTNLOCK))  RELEASE LOCK  Y02080 24760002
RESTORE  EQU   *                        RESTORE REGS             Y02080 24770002
         LM    WORKR,REGFOUR,EXTSA(REGEIGHT)  RESTORE REGS 11-4  Y02080 24780002
         LTR   REGSEVEN,REGSEVEN        TEST IF ADDRESS VALID    YM5076X24790002
                                        OR IF THE SMF INDICATOR  YM5076X24793002
                                        IS VALID                 YM5076 24796002
         BNZ   ERRVAL                   BRANCH IF NOT            Y02080 24800002
         L     RCVT,CVTPTR              RELOAD CVT ADDRESS       Y02080 24810002
         LR    REGZERO,REGSIX           SAVE SMF INDICATOR      SA48490 26001002
*                                                                       26220002
* THIS SECTION INSURES THE UCB ADDRESS IS WITHIN VALID RANGE.           26230002
*                                                                       26250002
         LR    REGTEN,REGSTORE          ADDR UCB                SA48490 26260002
         LA    REGTEN,0(REGTEN)         CLEAR HIGH-ORDER BYTE   SA48490 26270002
         SRDL  REGTEN,16                IS ADDR OF UCB          SA48490 26280002
         LTR   REGTEN,REGTEN            CONTAINED IN A HALFWORD SA48490 26290002
         BNZ   ERREXIT3                 IF NO,INVALID UCB       SA48490 26300002
         SLDL  REGTEN,16                RESTORE REGISTER        SA48490 26310002
         USING UCB,REGTEN                                       SA48490 26320002
*                                                                       26340002
         TM    UCBJBNR,UCBVRDEV         TEST IF A VIRTUAL UCB    Y02132 26360002
         BO    ERREXIT4                 ERROR IF A VDSUCB        Y02132 26380002
*                                                                       26500002
* THIS SECTION CHECKS FOR VALID UCB                                     26510002
*                                                                       26520002
UCBADDR  EQU   *                                                SA48490 26530002
         L     REGSIX,CVTILK2           ADDR PORTION UCB        SA48490 26540002
*                                       LOOKUP TABLE            SA48490 26550002
UCBLOOP  EQU   *                                                SA48490 26560002
         CLC   0(K2,REGSIX),ENDTAB      IS THIS END OF TABLE    SA48490 26570002
         BE    ERREXIT3                 IF YES, INVALID UCB     SA48490 26580002
         SLR   REGTWO,REGTWO            CLEAR REGISTER          Z30AAJC 26590003
         ICM   REGTWO,3,0(REGSIX)       LOAD UCB ADDRESS        Z30AAJC 26592003
         CR    REGTEN,REGTWO                                    SA48490 26600002
         BE    OKUCB                    VALID UCB FOUND         SA48490 26610002
         LA    REGSIX,K2(REGSIX)        POINT TO NEXT ADDR IN   SA48490 26620002
*                                       TABLE                   SA48490 26630002
         B     UCBLOOP                  PICK UP NEXT ADDR       SA48490 26640002
OKUCB    EQU   *                                                SA48490 26650002
         CLI   UCBTBYT3,DADEV           IS THIS D.A. UCB        SA48490 26660002
         BNE   ERREXIT4                 ERROR IF NOT            SA48490 26670002
         DROP  REGTEN                                           SA48490 26680002
         LR    RUCBPTRL,REGSTORE        RELOAD UCB POINTER      SA48490 26690002
         USING UCB,RUCBPTRL                                     SA48490 26700002
BEGINB   LTR   REGSIX,REGZERO           ANY SMF FUNCTIONS       SA48490 27030002
         BZ    BEGINC                   BRANCH IF NOT            S19028 27060019
         LA    REGZERO,X'40'                                     S19028 27090019
         CR    REGZERO,REGSIX           IS TEST FOR SMF FUNCTION S19028 27120019
*                                       REQUIRED                        27150019
         BNE   BEGINC                   BRANCH IF NOT            S19028 27180019
         L     RSMCA,CVTSMCA                                     S19028 27210019
         LTR   RSMCA,RSMCA              TEST FOR SMF SYSTEM      S19028 27240019
         BZ    NOSMF                    BRANCH IF NOT            S19028 27270019
         USING SMCABASE,RSMCA                                    S19028 27300019
         TM    SMCAOPT,SMCAVOL          IS VOL INFO DESIRED      S19028 27330019
         BNO   NOSMF                    BRANCH IF NOT            S19028 27360019
         TM    SMCAMISC,SMCAUSER        ARE IBM RECORDS DESIRED  S19028 27390019
         BO    BEGINC                   BRANCH IF YES            S19028 27420019
NOSMF    XR    REGSIX,REGSIX            ZERO SMF INDICATOR       S19028 27450019
TESTEXIT EQU   *                                                SA57953 27480002
         LTR   REGNINE,REGNINE          IS DISPLAY SPACE         Y02080 27481002
*                                       DESIRED                 SA57953 27482002
         BNZ   BEGINC                   BRANCH IF YES            S19028 27510019
         XR    RERRPASS,RERRPASS        SET RETURN CODE          S19028 27540019
         B     RETURN                   RETURN TO CALLER        SA57953 27570002
BEGINC   EQU   *                                                SA48490 27600002
         LR    REGNINE,REGFIVE          SAVE MSG PTR             S19028 27630019
*                                                                       28200000
***  THIS SECTION OBTAINS THE LSPACE WORK AREA.                         28400002
*                                                                       28600000
         L     REGEIGHT,0(,REGFOUR)     LOAD SVRB ADDRESS        Y02080 28620002
         IECRES GET,PREFIX=FIRST,ID=LSWA,LV=LWALNGTH,            Y02080X28700002
               STM=(REGTWO,BASEREG,EXTSA(REGEIGHT))  OBTAIN W/A  Y02080 28720002
*                                       IGC0007H IS NOW RUNNING  Y02082 28740002
*                                       IN THE DATAMGT KEY AFTER Y02082 28760002
*                                       ISSUING THE IECRES GET   Y02082 28780002
*                                       FOR CORE IN KEY 5        Y02082 28800002
         LR    RWKAREA,REGONE           PICK UP WORK AREA POINTER       29000000
*                                                                       29100002
         IECRES LOAD,MODNM=LOAD1,EXTPR=(RWKAREA),BRANCH=NO       Y02080X29200002
                                        LET OPTIONAL TRACE PRINT Y02080X29300002
                                        THIS MODULE'S NAME       Y02080 29400002
*                                                                       29500002
         L     REGONE,IECRRPRM          RECOVERY RTN LIST ADDR   Y02144 29600002
         USING RRPLIST,REGONE           PARM LIST ADDRESSABILITY Y02144 29700002
         OI    RRFUNCTN,RRFLSPAC        SET LSPACE FUNCTION BIT  Y02144 29800002
         ST    RUCBPTRL,RRUCBPTR        SAVE UCB ADDRESS         Y02144 29900002
         DROP  REGONE                                            Y02144 29920002
*                                                                       29950002
         ST    REGFOUR,TCBADDR          SAVE INPUT TCB ADDRESS   Y02078 30000002
         STC   REGSIX,SMFFLAG           SAVE SMF INDICATOR       S19028 30100019
*                                                                       30200000
*** THIS SECTION BUILDS A DEB                                           30400000
*                                                                       30600000
         MVI   DEB+16,X'01'             SET NUMBER OF EXTENTS = 1       30800000
         LA    REGONE,DCB               LOAD DCB POINTER                31000000
         L     RCVT,CVTPTR              RELOAD CVT POINTER      SA48490 31200002
         USING CVT,RCVT                                         SA48490 31201002
         L     REGTWO,CVTXAPG           GET IOS APPENDAGE TABLE ADDRESS 31400000
         LR    REGTHREE,RUCBPTRL        LOAD MAIN UCB POINTER    Y02080 31600002
         XR    REGFOUR,REGFOUR          ZERO THE BIN NUMBER      Y02080 34451002
         LM    REGFIVE,REGSIX,EXTCON1   LOAD START HH,END CCHH AND TRKS 34800002
         STM   REGONE,REGSIX,DEB+24     STORE IN DEB                    35000000
         MVI   DEB+24,X'0F'             INSERT DEB ID                   35200000
         MVI   DEB+28,X'04'             INSERT EXTENT SCALE             35400000
         MVI   DEB+32,X'00'             INSERT DEVICE MODE              35600000
*                                                                       35800000
*** THIS SECTION BUILDS BLOCKS - DCB,IOB,ECB                            36000000
*                                                                       36200000
BLDBLKS  LA    REGONE,DEB               PUT IN DEB POINTER              36400000
         ST    REGONE,DEBPTR                                            36600000
         OI    IOB,UNRELATD             SET UNRELATED BIT IN IOB A37199 36700021
         LA    REGTWO,ECB               PUT IN ECB POINTER              36800000
         ST    REGTWO,IOB+4                                             37000000
         TM    UCBTBYT2,UCB2OPT3        TEST FOR RPS DEVICE      Y02082 37010002
         BZ    NORPS1                   NO, CONTINUE AS NORMAL   S20201 37020020
         LM    REGTWO,REGTHREE,RPSCCW   LOAD SET SECTOR CCW      Y02080 37030002
         ALR   REGTWO,RWKAREA                                    Y02080 37040002
         STM   REGTWO,REGTHREE,CCW0     STORE SET SECTOR CCW     Y02080 37050002
         LA    R2,CCW0                  ADDR OF RPS CHANNEL PGM. S20201 37080020
         B     IOBCONT                  CONTINUE                 S20201 37090020
NORPS1   EQU   *                                                 S20201 37100020
         LA    REGTWO,CCW1              PUT IN CHAN PROG POINTER        37200000
IOBCONT  EQU   *                                                 S20201 37300020
         LA    REGTHREE,DCB             PUT IN DCB POINTER              37400000
         STM   REGTWO,REGTHREE,IOB+16                                   37600000
*                                                                       37800000
* THIS SECTION LINKS TO THE 'ADDRESS CONVERSION' ROUTINE TO GET THE     38000000
* VTOC ADDRESS                                                          38200000
*                                                                       38400000
GOCVT    EQU   *                        GET THE VTOC ADDRESS     Y02080 38600002
         L     REGZERO,UCBVTOC          LOAD THE F4 DSCB TTR0    Y02080 39000002
         MVC   MIELNAME(6),SRTEVOLI     SAVE VOL SER FOR ENQ     A42182 39100021
ZEROCLR  IC    REGZERO,EXTCON1          CLEAR THE LOW ORDER BYTES       40400000
         STM   REGNINE,RWKAREA,REGSAVEA                                 40600000
         LA    REGTWO,SEEK              LOAD POINTER TO 8 BYTE AREA     40800000
         LR    REGTHREE,RWKAREA         SAVE WORK AREA POINTER          41000000
         L     RCVT,CVTPCNVT            LOAD CONVERSION ROUTINE BASE    41200000
         BALR  RBAK,RCVT                GO TO CONVERSION ROUTINE        41400000
         LM    REGNINE,RWKAREA,REGSAVEA-FIRST(REGTHREE)                 41600000
         MVC   VTOCADR(5),SEEK+3        SAVE VTOC ADDRESS               41800000
         TM    UCBTBYT2,UCB2OPT3        DOES DEVICE HAVE RPS     Y02082 41810002
         BZ    NORPS2                   NO, CONTINUE AS NORMAL   S20201 41820020
         LA    R2,THETA                 GET THETA ADDRESS        S20201 41830020
         XC    CCW2+FW(FW),CCW2+FW      CLEAR WORK WORD          S20201 41840020
         MVC   CCW2+FW(C1),UCBTBYT4     GET DEVICE CODE          S20201 41850020
         O     R2,CCW2+FW               PUT IN HIGH BYTE         S20201 41860020
         L     R0,PARM0                 PREPARE PARAMETERS FOR   S20201 41870020
         IC    R0,SEEK+C7               GET RECORD NUMBER        S20201 41880020
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 41890002
         L     RCVT,CVT0SCR1            GET ADDR SECTOR CNVT RTN Y02080 41900002
         STM   R9,RWKAREA,REGSAVEA      SAVE REGISTERS           S20201 41910020
         LR    R3,RWKAREA               SAVE SAVE AREA PTR       S20201 41920020
         BALR  RBAK,RCVT                GET SECTOR VALUE         Y02080 41930002
         LM    R9,RWKAREA,REGSAVEA-FIRST(R3) RESTORE REGS        S20201 41940020
NORPS2   EQU   *                                                 S20201 41950020
*                                                                       42000000
*** THIS SECTION RELOCATES THE CHANNEL PROGRAM TO THE WORK AREA. IT     42200000
*** ALSO INITIALIZES IT TO READ IN THE FORMAT 4 DSCB AND THE FIRST      42400000
*** FORMAT 5 DSCB                                                       42600000
*                                                                       42800000
         LM    REGZERO,REGSEVEN,CCWP    LOAD FIRST 4 CCW'S              43000000
         ALR   REGZERO,RWKAREA                                          43200000
         ALR   REGTWO,RWKAREA                                           43400000
         ALR   REGFOUR,RWKAREA                                          43600000
         ALR   REGSIX,RWKAREA                                           43800000
         STM   REGZERO,REGSEVEN,CCW1    STORE FIRST 4 CCW'S             44000000
*                                                                       44200000
         L     RUCBPTRL,DEB+32          RELOAD UCB POINTER              44400000
         LR    REGFIVE,REGNINE          RELOAD MESSAGE POINTER   A42182 44450021
         TM    UCBFL2,X'40'             IS UNIT NOT READY?       A42182 44500021
         BO    ERR5FREE                 BRANCH IF NOT READY      A42182 44550021
*                                                                       44600000
* LINK TO ENQ ROUTINE TO ENQ THE VTOC ON THIS VOLUME                    44800000
* SET UP TO ENQUEUE ON THE VTOC OF THIS VOLUME                          44900019
*                                                                       45000000
         MVC   MJELNAME(8),VTOCNAME     MOVE MAJOR QUE NAME TO WORKAREA 45200000
         MVI   ENQAREA,X'FF'            SET LAST ENTRY CODE             45400000
         SR    REGONE,REGONE            CLEAR CODE AND RETURN FIELDS    45600000
         STH   REGONE,ENQAREA+2                                         45800000
*                                                                       45900021
* LINK TO RESERVE ROUTINE TO ENQ THE VTOC ON THIS VOLUME.               46000021
*                                                                       46100021
         RESERVE (MJELNAME,MIELNAME,E,6,SYSTEMS),                YM3022X46200002
               MF=(E,ENQAREA),UCB=UCBPTR                         A42182 46300021
*                                                                       46320002
         OI    DSMADTB2,DSMVTOCR        SET VTOC ENQ'ED BIT      Y02144 46340002
*                                                                       46400021
*** THIS SECTION BRANCHES TO THE NEXT LOAD OF LSPACE (IGC0107H).        46800002
*                                                                       47800019
         IECRES LOAD,EXTPR=(RWKAREA),MODNM=LOAD2,BRANCH=DIRECT   Y02080 48800002
*                                                                       53800019
****************************************************************        54800019
*                                                                       55800019
ERR5FREE EQU   *                                                 A42182 56000021
         LA    REGTWO,ERRMSG5           POINT TO MESSAGE         A42182 56200021
         LA    REGTHREE,12                                       S19028 57800019
EXIT     LA    REGNINE,0(REGFIVE)       SHOULD MSG BE RETURNED   S19028 59800019
         LTR   REGNINE,REGNINE                                   S19028 61800019
         BZ    FREE                     BRANCH IF NO             S19028 63800019
         L     REGONE,TCBADDR           LOAD TCB ADDRESS         Y02078 63900002
         USING TCB,REGONE               TCB ADDRESSABILITY       Y02078 64000002
         MODESET EXTKEY=RBT234,WORKREG=4  SWITCH TO CALLER'S KEY Y02078 64100002
         DROP  REGONE                                            Y02078 64200002
         MVC   0(30,REGFIVE),0(REGTWO)  MOVE MSG TO CALLER AREA  S19028 65800019
         MODESET EXTKEY=DATAMGT         RETURN TO DATAMGT KEY    Y02078 65900002
*                                                                       68200000
* FREE THE WORK AREA                                                    68400000
*                                                                       68600000
FREE     EQU   *                                                SA49351 68660021
         LR    REGEIGHT,REGTHREE        SAVE RETURN CODE         Y02080 68680002
         LR    REGNINE,REGFIVE          SAVE MESSAGE POINTER     Y02080 68700002
         IECRES FREE,PREFIX=FIRST,A=(RWKAREA)  FREE WORK AREA    Y02080 68720002
RETURNPT EQU   *                        RETURN TO CALLER         Y02080 68740002
         MODESET EXTKEY=SUPR            RETURN TO SUPERVISOR KEY Y02082 68750002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 68760002
         USING CVT,RCVT                 CVT ADDRESSABILITY       Y02080 68780002
         L     RBAK,CVTEXPRO            LOAD EXIT PROLOG ADDRESS Y02080 68800002
         LR    RERRPASS,REGEIGHT        RESTORE RETURN CODE      Y02080 68820002
         LR    REGONE,REGNINE           RESTORE MESSAGE POINTER  Y02080 69400002
         RETURN ,                       RETURN TO CALLER         Y02080 69600002
*                                                                       69700002
ERREXIT3 LA    REGTWO,ERRMSG3                                           70200000
         BC    15,EXIT4                                                 70400000
ERREXIT4 LA    REGTWO,ERRMSG4                                           70600000
EXIT4    LA    RERRPASS,12                                              70800000
         LA    REGNINE,0(REGFIVE)       SHOULD MSG BE RETURNED   S19028 70880019
         LTR   REGNINE,REGNINE                                   S19028 70960019
         BZ    RETURN                   BRANCH IF NO             S19028 71040019
         USING TCB,REGFOUR              TCB ADDRESSABILITY       Y02078 71060002
         MODESET EXTKEY=RBT234,WORKREG=1  SWITCH TO CALLER'S KEY Y02078 71080002
         DROP  REGFOUR                                           Y02078 71100002
         MVC   0(30,REGFIVE),0(REGTWO)  MOVE MSG TO CALLER AREA  S19028 71120019
         MODESET EXTKEY=SUPR            RETURN TO SUPERVISOR KEY Y02082 71140002
         BC    15,RETURN                                                71200000
ERRVAL   LA    RERRPASS,16                                              72000000
RETURN   EQU   *                        SET FOR RETURN           Y02080 72020002
         LR    REGEIGHT,RERRPASS        SAVE RETURN CODE         Y02080 72040002
         LR    REGNINE,REGFIVE          SAVE MESSAGE POINTER     Y02080 72060002
         B     RETURNPT                 GO RETURN                Y02080 72080002
*                                                                       72600000
* CHANNEL PROGRAM FOR SEEK VTOC, READ IN FORMAT 4 AND FIRST FORMAT 5    72800000
* DSCB'S                                                                73000000
*                                                                       73200000
CCWP     CCW   X'31',VTOCADR-FIRST,X'40',5   SEARCH EQUAL ID FOR VTOC   73400000
         CCW   X'08',CCW1-FIRST,X'00',0      TIC BACK TO SEARCH         73600000
         CCW   X'06',DS4IDFMT-FIRST,X'40',96 READ DATA FOR VTOC DSCB    73800000
         CCW   X'9E',DSCBF5-8-FIRST,X'00',148 READ COUNT/KEY/DATA F5    74000000
RPSCCW   CCW   X'23',THETA-FIRST,X'40',1  SET SECTOR COMMAND     Y02080 74100002
*                                                                       75400000
* CONSTANTS AND MESSAGES                                                75600000
*                                                                       75800000
         DS    0F                                                       76000000
EXTCON1  DC    X'0000'                  CONSTANT FOR END CCHH OF DEB    76200000
         DC    X'FFFFFFFF7FFF'                                          76400000
ENDTAB   EQU   EXTCON1+K2               TEST FOR END OF UCB     SA48490 76410002
*                                       LOOKUP TABLE            SA48490 76420002
VTOCNAME DC    CL8'SYSVTOC'                                             76800000
*                                                                       77000000
ERRMSG3  DC    C'LSPACE-INVALID PARAMETER      '                        77800000
ERRMSG4  DC    C'LSPACE-NOT A DIRECT ACCESS VOL'                        78000000
ERRMSG5  DC    CL30'LSPACE-UCB NOT READY'                       SA42182 78010002
PARM0    DS    0F                       AREA TO BUILD PARAMETERS S20201 78120020
DD       DC    X'0060'                  DATA LENGTH              S20201 78140020
K        DC    X'2C'                    KEY  LENGTH              S20201 78160020
R        DC    X'0'                     RECORD NUMBER            S20201 78180020
*                                                                       78200002
* TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                       78220002
*                                                                       78240002
         XCTLTABL ID=(LOAD1,IGC0007H,LOAD2,IGC0107H),            Y02080X78260002
               SVC=078,LENGTH=,BRT=YES                           Y02080 78280002
         SPACE 2                                                 Y02080 78320002
         IECDSECS CVT,PSA,RB,RRPL,SMF,TCB,UCB,EXPAND=YES         Y02144 78400002
WORKAREA IECLSPWA EP,F4,ADT=YES         LSPACE WORK AREA         Y02144 78600002
REGSAVEA EQU   IECREGSV+12              REGISTER SAVE AREA       Y02080 80520002
UCBPTR   EQU   DEB+32                                            A42182 84700021
         END   IGC0007H                                          Y02080 87600002
