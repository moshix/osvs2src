         TITLE 'IGC0008B --- SVC 82 FOR IEHDASDR UTILITY'               00200421
         COPY  LCGASMSW                                          SM4351 00202021
IGC0008B CSECT                                                          00210000
*                                                                       00212003
*C 276100                           @SA74452=@YA09634=@XA09732=@ZA04363 00214003
*A 276020-276040,901600             @SA74452=@YA09634=@XA09732=@ZA04363 00216003
*                                                                       00218003
*                                                              @Y30LSFY 00220003
* ELIMINATE IEH813I MSG FOR SVC 82 FOR EMUL DEVICES.           @ZM40451 00230003
*098765,098432                                                VS06562   00260002
*                                                               YM04695 00270402
*                                                               VS02889 00320402
*                                                               YM03870 00430002
*                                                               YM03804 00480002
*STATUS CHANGE LEVEL 004    VS2/2 (MVM)                         YL02912 00600002
*A                                                             @Z30RSAG 00650003
*C                                                             @Z30RSAG 00700003
*D                                                             @Z30RSAG 00750003
*                                                                     * 00800016
*FUNCTION/OPERATION-  SVC 82 PERFORMS THE FOLLOWING FUNCTIONS FOR     * 01000016
*   THE -IEHDASDR- UTILITY PROGRAM//TYPE 4 SVC WITH EXTENDED SVRB.    * 01200016
*                                                                     * 01400016
*     1) IN PREPARATION FOR SURFACE ANALYSIS FOR OFF-LINE VOLUMES.    * 01600016
*        -ASK FOR OPERATORS PERMISSION TO INITIALIZE A SPECIFIC VOL.  * 01800016
*        -IF OPERATOR REPLIES WITH A 'T', RETURN TO CALLER.RC=8.      * 02000016
*        -IF OPERATOR REPLIES WITH A 'U', BUILDS A DEB, LOADS IN      * 02200016
*         THE ABNORMAL-END APPENDAGE(IGG019P9), AND RETURNS TO        * 02400016
*         CALLER.RC=0.                                                * 02600016
*                                                                     * 02800016
*     2) ALTERNATE TRACK ASSIGNMENT REQUEST FOR GETALT FUNCTION.      * 03000016
*        -GETS CORE FOR A WORKAREA, BUILDS A DEB WITHIN THIS CORE,    * 03200016
*         AND PASSES CONTROL VIA A XCTL TO -IGC0108B- FOR THE         * 03400016
*         ACTUAL ALTERNATE TRACK ASSIGNMENT.                          * 03600016
*                                                                     * 03800016
*     3) ALTERNATE TRACK REQUEST BY FORMAT/ANALYZE FUNCTION.          * 04000016
*        -SAME AS OPERATION 2 ABOVE.                                  * 04200016
*                                                                     * 04400016
*     4) POST UCB REQUEST.                                            * 04600016
*        -PASSES CONTROL VIA A XCTL TO -IGC0208B-.                    * 04800016
*                                                                     * 05000016
*                                                                     * 05200016
*     5) SPECIAL POST UCB REQUEST.                                    * 05400016
*        -DELETES THE ABNORMAL-END APPENDAGE.                         * 05600016
*        -FREES THE CORE FOR THE DEB.                                 * 05800016
*        -PASSES CONTROL TO -IGC0208B-.                               * 06000016
*                                                                     * 06200016
         AIF   ('&LIB' EQ 'LIB1').X227900                        YM3475 06220002
*     6) DELETE DEB REQUEST.                                          * 06240002
*        -DELETES THE ABNORMAL-END APPENDAGE.                         * 06260002
*        -FREES THE CORE FOR THE DEB.                                 * 06280002
*                                                                     * 06300002
*     7) ISSUE SENSE FOR WINCHESTER DEVICES.                    XL03130 06310003
*        -ISSUE SENSE AND RETURN WINCHESTER MODEL NUMBER IN     XL03130 06310102
*         USERS' PARAMETER LIST + 4 :                           XL03130 06310202
*              MODEL 1 = F'01'                                  XL03130 06310302
*              MODEL 2 = F'02'                                  XL03130 06310802
*                                                                     * 06311202
*     8) ONLINE ENQ REQUEST.                                          * 06311902
*        -ENQ'S ON VOLID OF 'TODD' VOLUME.                      YL02912 06312402
*                                                                     * 06316102
.X227900 ANOP                                                    YM3475 06320002
*ENTRY POINT-  THE ONLY ENTRY POINT IS -IGC0008B-.                    * 06400016
*                                                                     * 06600016
*INPUT-  A PARAMETER LIST POINTED TO BY REGISTER 1 FOR THE ABOVE      * 06800016
*   DESCRIBED FUNCTIONS.                                              * 07000016
*                                                                     * 07200016
*     1) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=8F.                  * 07400016
*        -2ND WORD-   PTR TO DCB,HIGH ORDER BYTE=80.                  * 07600016
*                                                                     * 07800016
*     2) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=1F.                  * 08000016
*        -2ND WORD-   CCHH OF DEFECTIVE TRACK.                        * 08200016
*        -3RD WORD-   PTR TO DATA BUFFER                       @Z30RSAG 08250003
*                                                                     * 08400016
*     3) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=00.                  * 08600016
*        -2ND WORD-   CCHH OF DEFECTIVE TRACK.                        * 08800016
*        -3RD WORD-   PTR TO 6-BYTES OF ALT. TRACK INFO.              * 09000016
*                     HIGH ORDER BYTE WILL CONTAIN A X'01'     @Y30LSFY 09050003
*                     FOR SS1 CONVERSION.                      @Y30LSFY 09100003
*                                                                     * 09200016
*     4) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=08.                  * 09400016
*        -2ND WORD-   PTR TO 6-BYTE SERIAL NO, IF OVERWRITTEN.        * 09600016
*        -3RD WORD-   PTR TO MBBCCHHR FOR NEW VTOC.                   * 09800016
*                                                                     * 10000016
*     5) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=88.                  * 10200016
*        -2ND WORD-   PTR TO 6-BYTE SERIAL NO, IF OVERWRITTEN.        * 10400016
*        -3RD WORD-   PTR TO MBBCCHHR FOR NEW VTOC.                   * 10600016
*        -4TH WORD-   PTR TO DEB.                                     * 10800016
*                                                                     * 11000016
         AIF   ('&LIB' EQ 'LIB1').X227901                        YM3475 11020002
*     6) -1ST WORD-   RESERVED, HIGH ORDER BYTE=F8.                   * 11040002
*        -2ND WORD-   RESERVED.                                       * 11060002
*        -3RD WORD-   RESERVED.                                       * 11080002
*        -4TH WORD-   PTR TO DEB.                                     * 11100002
*                                                                     * 11120002
*     7) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=F1.            XL03130 11130003
*        -2ND WORD-   HIGH ORDER BYTE=80.                       XL03130 11130502
*                                                                     * 11130902
*     8) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=04.            YL02912 11131502
*        -2ND WORD-   ADDR OF FUNCBLK, HIGH ORDER BYTE=80.     @Z30RSAG 11132003
*     9) -1ST WORD-   PTR TO UCB,HIGH ORDER BYTE=44.            YL02912 11132102
*                                                                     * 11134102
.X227901 ANOP                                                    YM3475 11140002
*EXITS-NORMAL-  RETURN TO CALLER VIA REG 14. RETURN CODE=0.           * 11200002
*                                                                     * 11400016
*EXITS-ERROR-   RETURN TO CALLER VIA REG 14. RETURN CODE=8.           * 11600002
*                                                                     * 11800016
*EXTERNAL ROUTINES- SVC IS ISSUED FOR THE FOLLOWING FUNCTIONS FROM    * 12000016
*                                                                     * 12200016
*   THE FOLLOWING MODULES.                                            * 12400016
*                                                                     * 12600016
*     1) IHEDANAL.                                                    * 12800016
*                                                                     * 13000016
*     2) IEHDGETA.                                                    * 13200016
*                                                                     * 13400016
*     3) IEHDANAL,IEHDCELL.                                           * 13600016
*                                                                     * 13800016
*     4) IEHDLABL,IEHDANAL,IEHDREST,IEHDDUMP                          * 14000016
*                                                                     * 14200016
*     5) IEHDANAL                                                     * 14400016
*                                                                     * 14600016
         AIF   ('&LIB' EQ 'LIB1').X227902                        YM3475 14640002
*     6) IEHDANAL,IEHDLABL.                                           * 14680002
*                                                                     * 14720002
*     7) IEHDASDS                                               XL03130 14730003
*                                                                     * 14732502
*     8) IEHDASDS, FOR ENQING ON THE TODD UCBS' VOLID.          YL02912 14737602
*                                                                     * 14740102
.X227902 ANOP                                                    YM3475 14760002
*SUPERVISOR MACROS-  GETMAIN,FREEMAIN,WTOR,WTO,LOAD,XCTL.             * 14800016
*                                                                     * 15000016
*TABLES/WORKAREAS-  OBTAINS A WORKAREA FOR -IGC0108B- WHICH IS        * 15200016
*   DESCRIBED BY THE DSECT -IOBLOCKS-.                                * 15400016
*                                                                     * 15600016
*OUTPUT-                                                              * 15800016
*     1) FOR FUNCTION NO. 1,BUILDS A PROPER DEB AND LOADS IN THE      * 16000016
*        ABNORMAL-END APPENDAGE.                                      * 16200016
*                                                                     * 16400016
*     -FOR ALL OTHER FUNCTIONS, SEE  -IGC0108B- OR -IBC0208B.         * 16600016
*                                                                     * 16800016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,PRIVILEGED,ENABLED.               * 17000016
*                                                                     * 17200016
*********************************************************************** 17250002
         EJECT                                                          17400002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             17600016
PARMPTR  EQU   1                       POINTER TO INPUT PARAMETERS.     17800016
R0       EQU   0                                                        18000016
R1       EQU   1                                                        18200016
R2       EQU   2                                                        18400016
R3       EQU   3                                                        18600016
R4       EQU   4                                                        18800016
R6       EQU   6                                                        19000016
R7       EQU   7                                                 Y01021 19100000
R8       EQU   8                       TCB ADDRESS.                     19200016
R9       EQU   9                                                        19400016
R11      EQU   11                      POINTER TO INPUT PARAMETERS.     19600016
R14      EQU   14                      LINK REGISTER.                   19800016
R15      EQU   15                                                       20000016
GR0      EQU   0                                                        20200016
GR1      EQU   1                                                        20400016
GR2      EQU   2                       INDEX TO UCB TABLE ENTRIES.      20600016
GR3      EQU   3                       POINTER TO TABLE UCB.            20800016
GR4      EQU   4                       POINTER TO NEW SERIAL.           21000016
GR5      EQU   5                       POINTER TO TABLE UCB  SERIAL.    21200016
GR6      EQU   6                       POINTER TO INPUT UCB.            21400016
GR7      EQU   7                                                        21600016
GR8      EQU   8                                                        21800016
GR9      EQU   9                                                        22000016
GR10     EQU   10                                                       22200016
GR11     EQU   11                                                       22400016
GR12     EQU   12                                                       22600016
GR14     EQU   14                      LINK REGISTER.                   22800016
BASEREG  EQU   12                      BASE REGISTER.                   23000016
GR15     EQU   15                                                       23200016
         SPACE                                                          23400016
DYNALT   EQU   X'1F'                   GETALT ASSIGNMENT.               23600016
SENS     EQU   X'F1'                    SENSE REQUEST FOR WINCH XL03130 23650003
*                                                                       23700003
NEWVOL   EQU   X'8F'                   NEW VOLUME INPUT.                23800016
COMMA    EQU   C','                    EBCDIC COMMA.                    24000016
SLASH    EQU   C'/'                    2321 BIN SEPARATOR.              24200016
WSIZE    EQU   52                      CONSOLE MESSAGE SIZE.            24400016
DA2321   EQU   X'05'                   UCB DEVICE TYPE CODE FOR 2321.   24600016
LASTBIN  EQU   X'09'                   LAST BIN NO. FOR SUB-UCBS.       24800016
SUBLNG   EQU   16                      LENGTH OF EACH SUB-UCB.          25200016
MAINUCB  EQU   X'FF'                   PRIMARY UCB IDENTIFIER.          25400016
NOTREADY EQU   X'40'                   UCB NOT READY BIT.               25600016
PGFIXBIT EQU   X'80'                   PAGE FIX APPENDAGE PRESENT       25650000
         SPACE                                                          25800016
INIT     EQU   X'00'                   ANALYZE/FORMAT REQUEST.          26000016
POSTSPEC EQU   X'88'                   POST REQUEST FOR NEW VOLUMES.    26200016
POST     EQU   X'08'                   POST INDICATOR.                  26400016
RETURN   EQU   3                       RETURN SVC CODE.                 26800016
X06      EQU   X'06'                    HEX CONSTANT             S20201 26860020
X07      EQU   X'07'                    HEX CONSTANT             S20201 26920020
E0       EQU   0                        CONSTANT OF 0            Y01021 26930000
E3       EQU   3                        CONSTANT OF 3            Y01021 26940000
E4       EQU   4                        CONSTANT OF 4            Y01021 26950000
E5       EQU   5                        CONSTANT OF 5            Y01021 26960000
E8       EQU   8                        CONSTANT OF 8            Y01021 26970000
E12      EQU   12                       CONSTANT OF 12           Y01021 26972000
E44      EQU   44                       CONSTANT OF 44           Y01021 26980000
E45      EQU   45                       CONSTANT OF 45           Y01021 26990000
D3340    EQU   X'0A'                   3340 DEVICE TYPE        @Z30RSAG 26997403
EMUL     EQU   X'08'                   SNS BYTE 2 EMULATE BIT  @Z30RSAG 26997803
FOXES    EQU   X'FF'                    END OF P.L. FLAG FOR ENQ SJ0054 27004002
D0       EQU   0                        ZERO DISPLACEMENT.      YL02912 27018002
D1       EQU   1                        DISPL. OF ONE.          YL02912 27020002
D3       EQU   3                        DISPL. OF THREE         YM04695 27028002
HEX0     EQU   X'00'                    WILL ZERO ENQ R.C.      YM04695 27030402
L3       EQU   3                        LENGTH OF THREE.        YL02912 27032002
K36      EQU   36                       CONSTANT OF 36.         YL02912 27046002
PTRCVT   EQU   16                      CVT PTR ADDR              Y01021 27060002
         AIF   ('&LIB' EQ 'LIB1').X227903                        YM3475 27074002
DELDEB   EQU   X'F8'                    DEB DELETE REQUEST.      YM3475 27088002
NALOCOFF EQU   X'FB'                    MASK TO RESET UCBNALOC  YL02912 27102002
EIGHT    EQU   8                        RETURN CODE FROM ENQ    YL02912 27116002
ENQ      EQU   X'04'                    ONLINE ENQ FUNC BYTE    YL02912 27130002
DEQ      EQU   X'44'                    ONLINE DEQ FUNC BYTE    YL02912 27144002
ONE      EQU   GR1                      CONSTANT                YL02912 27158002
OFFLINE  EQU   X'88'                    OFFLINE LABEL IND.      YL02912 27168002
SS1LD    EQU   X'20'                   TRANSFER TO SS/1 LOAD   @Y30LSFY 27170003
.X227903 ANOP                                                    YM3475 27172002
         EJECT                                                          27186002
         BALR  BASEREG,0               SET UP ADDRESSING.               27200016
         USING *,BASEREG                                                27400016
         SPACE                                                          27600016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04363 27602003
         DC    C'IGC0008B OZ04363'     LAST FIX THIS MOD       @ZA04363 27604003
APARNO   LR    GR10,PARMPTR            GET PARAMETER POINTER.  @ZA04363 27610003
         SPACE                                                          27650002
*********************************************************************** 27710002
*                                                                     * 27770002
*  THE CALLERS PARAMETER LIST WILL BE PLACED INTO A FIVE WORD BLOCK   * 27830002
*   OF GOTTEN CORE OF THE SVC'S KEY. THE FIRST FOUR WORDS WILL BE A   * 27890002
*   COPY OF THE CALLER'S LIST AND THE LAST WORD WILL CONTAIN THE KEY  * 27950002
*   OF THE CALLER IN THE FIRST BYTE AND THE ADDRESS OF THE CALLER'S   * 28010002
*   LIST IN THE LAST THREE BYTES.                                     * 28070002
*                                                                     * 28130002
*********************************************************************** 28190002
         LR    GR8,GR4                 LOAD TCB PTR             XL03130 28220003
         SPACE                                                          28250102
         USING PARMLIST,R11                                     YL02912 28310102
         USING RBBASIC,GR5                                      YL02912 28370002
         MODESET EXTKEY=SUPR                                    YL02912 28380002
         ST    GR14,RBEXSAVE+K36        SAVE RETURN ADDRESS.    YL02912 28420002
         MODESET EXTKEY=DATAMGT                                 YL02912 28430002
         LA    R2,ENDLIST-PARMLIST      CORE FOR PARM LIST.     YL02912 28490002
         GETMAIN R,LV=(2),SP=229        FOR CALLER'S PARAMETER. YL02912 28550002
         LR    R11,R1                   SAVE NEW PARM POINTER.  YL02912 28610002
         ST    GR10,PRMPTR              SAVE OLD PARM POINTER.  YL02912 28670002
         LR    R8,R4                    GET ADDR OF CURRENT TCB.YL02912 28910002
         USING TCB,R8                                           YL02912 28970002
         SPACE                                                          29030002
         MODESET EXTKEY=RBT234,WORKREG=3  GET CALLER'S KEY.     YL02912 29090002
         LM    R1,R4,E0(GR10)           GET CALLER'S PARM LIST. YL02912 29150002
         MODESET EXTKEY=DATAMGT,SAVEKEY=KEY,WORKREG=15          YL02912 29210002
         STM   R1,R4,PARMLIST           CALLER'S LIST TO MINE.  YL02912 29270002
*********************************************************************** 29390002
*                                                                     * 29450002
*   DETERMINE THE FUNCTION TO BE PERFORMED.                           * 29510002
*                                                                     * 29570002
*********************************************************************** 29630002
         SPACE                                                          29690002
         AIF   ('&LIB' EQ 'LIB1').NOWIN BRCH IF OS ASSEM        XL03130 29740002
.NOWIN   ANOP                                                   XL03130 29740802
         CLI   FUNCTION,SENS           IS THIS A SENSE REQUEST. XL03130 29742002
         BE    SENSIT                  YES, GO ISSUE SENSE CMD  XL03130 29742402
         SPACE                                                          29744002
         CLI   FUNCTION,NEWVOL          NEW VOLUME REQUEST?     YL02912 29750002
         BE    NEWPACK                  YES, GO BUILD DEB.      YL02912 29810002
         SPACE                                                          29870002
         CLI   FUNCTION,DYNALT          DYNAMIC ALT TRK REQUEST?YL02912 29930002
         BE    ASSGALT                  YES, ASSIGN ALTERNATE.  YL02912 29990002
         SPACE                                                          30050002
         CLI   FUNCTION,INIT            ANALYZE/FORMAT REQUEST? YL02912 30110002
         BE    ASGALT1                  YES, PROCESS TRACK.     YL02912 30170002
         SPACE                                                          30230002
         CLI   FUNCTION,POST            POST UCB REQUEST?       YL02912 30290002
         BE    CKUCBS                   YES, UPDATE UCBS.       YL02912 30350002
         SPACE                                                          30410002
         CLI   FUNCTION,POSTSPEC        OFFLINE POST REQUEST?   YL02912 30470002
         BE    SPECPOST                 YES, UPDATE UCB.        YL02912 30530002
         SPACE                                                          30590002
         CLI   FUNCTION,DELDEB          DEB DELETE REQUEST?     YL02912 30650002
         BE    SPECPOST                 YES DELETE DEB.         YL02912 30710002
         SPACE                                                          30720002
         CLI   FUNCTION,ENQ             ENQUEUE REQUEST?        YL02912 30760002
         BE    ENQUE                    YES, UPDATE UCB.        YL02912 30762002
         SPACE                                                          31010003
         CLI   FUNCTION,SS1CONV         THIS AN ANALYZE REQUEST@Y30LSFY 31012003
*                                      TO ASSIGN AN ALTERNATE  @Y30LSFY 31012803
*                                      ON AN SS1 SPOOL PACK.   @Y30LSFY 31013203
         BE    ASGALT1                 YES-GO PROCESS.         @Y30LSFY 31014003
         TM    FUNCTION,SS1LD          TRANSFER TO SS/1 LOAD   @Y30LSFY 31014503
         BZ    XIT                     NO                      @Y30LSFY 31015003
*        TRANSFER TO THE SS/1 LOAD OF SVC 82                   @Y30LSFY 31015503
         LR    GR1,GR11                PARM LIST POINTER       @ZM31081 31016003
         LR    GR2,GR5                 RBBASIC POINTER         @ZM31081 31016503
         MODESET EXTKEY=SUPR                                   @Y30LSFY 31017003
         L     GR3,RBEXSAVE+K36        RETURN ADDRESS          @ZM31081 31017503
         STM   GR1,GR3,RBEXSAVE+K16    STORE LOAD LIST         @ZM31081 31018003
         LA    GR1,RBEXSAVE+K16        LIST ADDRESS FOR LOAD   @Y30LSFY 31018503
         LA    GR4,XCTL3               XCTL FOR NEXT LOAD      @Y30LSFY 31019003
         B     NEXTLOAD                GET NEXT LOAD           @Y30LSFY 31019503
         SPACE                                                          31120002
XIT      EQU   *                                                XL03130 31170003
         B     EXIT                     UNSUPPORTED FUNCTION.   YL02912 31200002
         EJECT                                                          31400016
         AIF   ('&LIB' EQ 'LIB1').NOWIN1 BRCH IF OS ASSEM       XL03130 31402003
**********************************************************************  31410003
*        THE FOLLOWING ROUTINE WILL ISSUE A 'SENSE' CMD TO THE          31420003
*        333X AND 3340 DEVICE BEING PROCESSED BY IEHDASDS. THE          31430003
*        SENSE WILL DETERMINE WINCHESTER MODEL BEING USED,     @Z30RSAG 31440003
*        AND/OR IF EMULATION IS OCCURRING.                     @Z30RSAG 31440403
**********************************************************************  31442003
         SPACE                                                          31444003
SENSIT   EQU   *                                                XL03130 31450003
         GETMAIN R,LV=88,SP=229         CORE FOR EXCP CTL BLKS  YL02130 31500002
         USING CTLBLKS,GR2                                      XL03130 31560003
         LR    GR2,GR1                  SAVE AREA ADDR          XL03130 31570003
         L     GR1,CVTPTR               GET CVT ADDR            XL03130 31570403
         USING CVT,GR1                                                  31570803
         LA    GR4,BUMP                 DCBORG                  XL03130 31572003
         XC    DCBORG(L88),DCBORG       CLEAR CTL BLKS          XL03130 31580003
         SR    GR2,GR4                  RESET DSECT BASE        XL03130 31582003
         L     GR3,UCBPTR               GET UCB ADDR            XL03130 31590002
         USING UCB,GR3                                          XL03130 31590403
         MODESET EXTKEY=SUPR                                     YM5769 31591302
         NI    UCBFL1,MASK-UCBNOTRD    TURN OFF NOT-READY BIT   XL03130 31591603
         MODESET EXTKEY=DATAMGT                                  YM5769 31594802
         ST    GR3,DEBUCB               STORE UCB IN DEB        XL03130 31601902
         MVI   DEBUCB,INIT              ZERO FILE MASK          XL03130 31605102
         LA    GR3,ECB1                 GET ECB ADDR            XL03130 31608302
         ST    GR3,IOBECB               STORE IT IN IOB         XL03130 31611502
         MVC   CCW,SENSCCW              MOVE SKELTON CCW        XL03130 31614702
         LA    GR4,CCW                  GET CCW ADDR            XL03130 31617902
         ST    GR4,IOBCCW               STORE IN IOB            XL03130 31621102
         LA    GR4,SENSE                GET AREA ADDR           XL03130 31624302
         ST    GR4,CCW                  SETUP SENSE CCW         XL03130 31627502
         MVI   CCW,SENSEOP              RESET OP CODE           XL03130 31630702
         ST    GR2,DEBDCB               PUT DCB ADDR IN DEB     XL03130 31633902
         MVC   DEBAPP(L4),CVTXAPG       APPDGE VECTOR TABL ADDR XL03130 31637102
         ST    GR2,IOBDCB               DCB ADDR IN IOB         XL03130 31640302
         LA    GR4,DEBORG               LOAD DEB ADDR           XL03130 31643502
         ST    GR4,DCBDEB               STORE IT IN DCB         XL03130 31646702
         MVC   DEBDCB(L1),TCBPKF        MOVE TCB KEY TO DEB     XL03130 31649902
         OI    DEBDCB,DEBID             SET DEB ID              XL03130 31659903
         EXCP  IOB1                     ISSUE SENSE CMD         XL03130 31669903
         WAIT  ECB=ECB1                 WAIT FOR SENSE          XL03130 31679903
         L     GR3,UCBPTR              GET UCB ADDR            @Z30RSAG 31681903
         CLI   ECB1,GOODRT              SUCCESSFUL SENSE ?      XL03130 31689903
         BNE   FREEIT                   NO, DONT SET MODEL NO.  XL03130 31691903
         CLI   UCBTBYT4,D3340          THIS A 3340 ?           @Z30RSAG 31693903
         BNE   INTSNS                  NO, GO LOOK AT SNS      @Z30RSAG 31694303
         TM    SENSE+L2,MOD1            36MEG WINCH. ?          XL03130 31695903
         BO    STORE1                   YES, GO STORE X'01'     XL03130 31696303
         TM    SENSE+L2,MOD2            72 MEG WINCH            XL03130 31696403
         BNO   FREEIT                   NO, EXIT                XL03130 31696503
         MVI   WINMOD,MOD2              MOVE MODEL NO TO PL     XL03130 31699202
         B     FREEIT                   EXIT                    XL03130 31701203
STORE1   EQU   *                                                XL03130 31702403
         MVI   WINMOD,MOD1              MOVE MODEL NO TO PL     XL03130 31704402
FREEIT   EQU   *                                                XL03130 31705103
         LA    GR2,BUMP(GR2)            RESET CORE PTR          XL03130 31707803
         FREEMAIN R,LV=88,A=(GR2),SP=229 FREE CTL BLK CORE      YL02130 31710502
         L     GR4,PRMPTR               CALLER'S LIST ADDR.     YL02912 31712502
         IC    GR9,WINMOD              GET WINCH MODEL NO.      VS02889 31712902
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 31714502
         STC   GR9,L7(GR4)             STORE MODEL NO. IN P.L.  VS02889 31714902
         MODESET EXTKEY=DATAMGT                                 YL02912 31715002
         CLI   WINMOD,INIT              WAS SENSE GOOD ?        XL03130 31715202
         BNE   EXIT                     YES, EXIT               XL03130 31715602
         BAL   R9,FREEPARM              GO FREE PARM LIST.              31720302
         LA    GR15,GR15                NO, SET NON-ZERO R.C.   XL03130 31725002
         B     EXIT2                    RETURN TO 'DASDS        XL03130 31729702
         DROP GR1                                                       31734402
         USING FUNCBLK,GR3                                     @Z30RSAG 31736403
INTSNS   EQU   *                                               @Z30RSAG 31738603
         L     GR3,SENSFB              LOAD FUNCBLK PTR        @Z30RSAG 31739003
         TM    SENSE+L2,EMUL           THIS DEV EMULATED ?     @Z30RSAG 31745803
         BNO   STORE1                  NO EXIT THIS RTNE       @ZM40451 31747803
         MODESET KEYADDR=KEY,WORKREG=15                        @ZM40430 31748203
         OI    FLGBYT1,EMU             YES, TURN ON FLAG       @Z30RSAG 31749803
         MODESET EXTKEY=DATAMGT                                @ZM40430 31750203
         B     STORE1                  EXIT TO IEHDASDS        @ZM40451 31751803
         DROP GR3                                              @Z30RSAG 31752203
         EJECT                                                          31752603
.NOWIN1  ANOP                                                   XL03130 31759403
SPECPOST EQU   *                                                        31779703
         DELETE EP=IGG019P9            FREE UP CORE USED BY APPENDAGE.  31800016
         AIF   ('&LIB' EQ 'LIB1').WM004                                 31810000
         DELETE EP=IGG019P7            FREE UP CORE USED BY      YM3011 31850000
*                                          APPENDAGE.                   31860000
.WM004   ANOP                                                           31900000
         L     GR6,DEBPTR               ADDRESS OF DEB.         YL02912 32000002
         LA    GR0,DEB-MYDEB           OFFSET FORM WORKAREA START.      32200016
         SR    GR6,GR0                 START OF WORK AREA.      YL02912 32400002
         USING MYDEB,GR6                                        YL02912 32600002
         AIF   ('&LIB' EQ 'LIB1').WM008                                 32602000
         L     GR4,DEBUCBAD-ONE         GET UCB ADDR            YL02912 32604002
         USING UCB,GR4                                          YL02912 32606002
         MODESET EXTKEY=SUPR                                    YL02912 32606402
         NI    UCBFL5,NALOCOFF          SET BIT OFF             YL02912 32608002
         MODESET EXTKEY=DATAMGT                                 YL02912 32608402
         L     GR4,DEBDEBID             GET DCB ADDR             Y01021 32610000
         LA    GR4,E0(GR4)              CLEAR HIGH ORDER BYTE    Y01021 32620000
         DEBCHK (GR4),TYPE=DELETE,AM=EXCP                       YL02912 32622002
         EJECT                                                          32622402
*********************************************************************** 32624002
*                                                                     * 32626002
*    TAKE DEB OFF TCB DEB CHAIN.                                      * 32628002
*                                                                     * 32630002
*********************************************************************** 32630402
         SPACE                                                          32630802
         LA    GR9,DEBDEBAD             GET ADDRESS OF NEXT DEB.YL02912 32632002
         CLC   TCBDEB+D1(L3),DEBPTR+D1  TCB POINT TO MY DEB?    YL02912 32642002
         BNE   GETDEB                   NO,SEARCH DEB CHAIN.    YL02912 32644002
         MODESET EXTKEY=SUPR                                    YL02912 32644102
         MVC   TCBDEB+D1(L3),D0(GR9)    YES, UNCHAIN DEB.       YL02912 32644402
         MODESET EXTKEY=DATAMGT                                 YL02912 32644602
         B     FREEDEB                  GO FREE DEB AREA.       YL02912 32645002
         SPACE                                                          32645202
GETDEB   EQU   *                                                YL02912 32645402
         L     GR4,TCBDEB               GET DEB CHAIN POINTER.  YL02912 32645602
         USING DEB,GR4                                          YL02912 32645802
CHKDEB   EQU   *                                                YL02912 32646002
         CLC   DEBDEBAD(L3),DEBPTR+D1   DEB POINT TO MY DEB?    YL02912 32647602
         BE    OURDEB                   YES, GO UNCHAIN.        YL02912 32648002
         L     GR4,DEBDEBAD-D1          NO, GET NEXT DEB.       YL02912 32648402
         B     CHKDEB                   CHECK NEXT DEB.         YL02912 32648502
         SPACE                                                          32648602
OURDEB   EQU   *                                                YL02912 32648702
         MVC   DEBDEBAD(L3),D0(GR9)     UNCHAIN MY DEB.         YL02912 32648802
         B     FREEDEB                  GO FREE DEB AREA.       YL02912 32648902
         DROP  GR4                                              YL02912 32649002
         EJECT                                                          32649102
*********************************************************************** 32649302
*        THE FOLLOWING ROUTINE WILL CAUSE THE DASDI DEVICE TO BE ENQ'ED 32649402
*        UPON, VIA ITS' VOLID. THE INITIATORS' TCB WILL BE USED IN      32649502
*        THE EVENT IEHDASDR SHOULD ABEND BEFORE DEQ'ING.                32649602
*********************************************************************** 32649902
         SPACE                                                          32650202
ENQUE    EQU   *                                                YL02912 32650502
         L     GR6,UCBPTR               GET UCB ADDR YL02912            32651102
         USING UCB,GR6                                          YL02912 32651402
         LA    GR7,UCBVOLI              GET ADDR OF VOLID  YL02912      32651702
         L     GR9,TCBOTC               LOAD MOTHER TCB ADDR    YM03804 32652002
         MVC   ENQLIST(SYSQ-ENQLISTF),ENQLISTF MOVE LIST TO W/A YM03804 32652402
*                                                                       32652602
         ENQ   (,(GR7),E,6,SYSTEM),RET=USE,TCB=(GR9),           YM03804*32652902
               MF=(E,ENQLIST)                                   YM03804 32653202
*                                                                       32653502
         LTR   GR15,GR15                HAVE WE GOT THE RESR ?  YL02912 32653802
         BZ    EXIT                     YES, BRCH               YL02912 32654102
         LA    GR15,D3(GR15)            INCRE TO R.C.           YL02912 32654402
         CLI   0(GR15),EIGHT            RC = 8 ?                YL02912 32654702
         BE    ENQAGN                   YES, RE-ENQ             YL02912 32655002
         BAL   R9,FREEPARM              FREE PARAMETER LIST.    YL02912 32655302
         LA    GR15,NOGO                SOMEONE ELSE HAS RESRC  YL02912 32655602
         B     EXIT2                    RETURN TO 'DASDS        YL02912 32655902
ENQAGN   EQU   *                                                YL02912 32656202
*                                                                       32656802
         MVI   ENQLIST+D3,HEX0          ZERO R.C.               YM04695 32656902
         ENQ   (,(GR7),E,6,SYSTEM),RET=CHNG,TCB=(GR9),          YM03804*32657102
               MF=(E,ENQLIST)                                   YL02912 32657402
*                                                                       32657702
         LTR   GR15,GR15                HAVE WE GOT THE RESRC?  YL02912 32658002
         BZ    EXIT                     YES, RETURN TO 'DASDS   YL02912 32658302
         LA    GR15,D3(GR15)            INCRE TO R.C.           YL02912 32658602
         CLI   0(GR15),EIGHT            RC = 8 ?                YL02912 32658902
         BE    ENQUE                    ENQ WITH RET=USE        YL02912 32659202
         BAL   R9,FREEPARM              FREE PARAMETER LIST.    YL02912 32659502
         LA    GR15,NOGO                SOMEONE ELSE HAS RESRC  YL02912 32659902
         B     EXIT2                                            YL02912 32660302
FREEDEB  EQU   *                        CONTINUE                 YM2646 32686500
         LR    GR1,GR6                  GET DEB ADDRESS.        YL02912 32686602
         USING MYDEB,GR1                                        YL02912 32686902
         L     GR4,DEBDEBID             GET DCB ADDRESS.         YM3475 32687302
         L     GR6,BLANKS               GET BLANK DDNAME.        YM3475 32687702
         MODESET KEYADDR=KEY,WORKREG=2  GET CALLER'S KEY.       YL02912 32687902
         ST    GR6,E44(GR4)             SET BLANKS IN DCB DDNAME.YM3475 32688102
         MODESET EXTKEY=DATAMGT                                 YL02912 32688302
.WM008   ANOP                                                           32723400
         LA    R3,DEBEND-MYDEB          SIZE OF DEB WORKAREA.   YL02912 32725602
         FREEMAIN R,LV=(3),A=(1),SP=230                          YM4604 32737802
         LR    GR1,GR11                RESTORE PARM POINTER.            32750000
         AIF   ('&LIB' EQ 'LIB1').X227102                        YM3475 32751002
         CLI   FUNCTION,DELDEB          DEB DELETE REQUEST?     YL02912 32752002
         BNE   CKUCBS                   NO, GO POST UCBS.        YM3475 32753002
EXIT     EQU   *                                                YL02912 32753402
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 32753502
         SR    R15,R15                  SET RETURN CODE ZERO.   YL02912 32753902
EXIT2    EQU   *                                                YL02912 32757102
         L     R14,RBEXSAVE+K36         GET RETURN ADDRESS.     YL02912 32759102
         MODESET EXTKEY=SUPR                                    SJ0054  32759502
         BR    R14                      RETURN.                 YL02912 32760402
.X227102 ANOP                                                    YM3475 32763602
         SPACE                                                          32766802
CKUCBS   EQU   *                                                        32770000
         MODESET EXTKEY=SUPR                                    YL02912 32820002
         ST    GR11,RBEXSAVE+K16       SAVE PARM POINTER.       YL02912 33800002
         LR    GR1,GR5                 ADDRESS OF EXTENTED SAVE AREA.   34000016
         LA    GR4,XCTL1               ADDRESS OF XCTL LIST.            34200016
         B     NEXTLOAD                GO BRING IN NEXT LOAD.           34400016
         SPACE 2                                                        34600016
         USING IOBLOCKS,R2                                              36000016
FREEPARM EQU   *                                                YL02912 36050002
         LA    R3,ENDLIST-PARMLIST      SIZE OF PARM LIST.      YL02912 36100002
         LR    R1,R11                   ADDRESS OF PARM LIST.   YL02912 36150002
FREECORE EQU   *                       RELEASE THE CORE HERE.           36200016
         FREEMAIN R,LV=(3),A=(1),SP=229 FREE THE WORK AREA.     YL02912 36400002
         BR    R9                      RETURN.                          36600016
         EJECT                                                          36800016
*********************************************************************** 37000016
*                                                                     * 37200016
*   ASK FOR PERMISSION TO INITIALIZE THIS VOLUME HERE.                  37400016
*                                                                     * 37600016
*********************************************************************** 37800016
NEWPACK  EQU   *                       BUILD A DEB FOR A NEW VOLUME.    38000016
         LA    R2,WTORP1-MSG           SIZE OF GETMAIN AREA.            38400002
         GETMAIN R,LV=(2),SP=229       CORE FOR MESSAGE AREA.   YL02912 38600002
         LR    R2,R1                   SAVE ADDRESS OF WORKAREA.        38800016
         USING MSG,R2                                                   39000016
TRYAGAIN EQU   *                                                        39200016
         XC    MSG(WTORP1-MSG),MSG     CLEAR AREA TO ZERO.              39400016
         MVC   MSG(WTOREND-WTORP),WTORP PLACE MESSAGE IN WORKAREA.      39600016
         SPACE                                                          39800016
         USING UCB,R6                                                   40000016
         L     R6,UCBPTR                UCB ADDRESS.            YL02912 40200002
         AIF  ('&LIB' EQ 'LIB2').X301001                        XL03912 40250003
         CLI   UCBID,MAINUCB           THIS A 2321.                     40400016
         BNE   W2321                   YES-GO PROCESS.                  40600016
         SPACE                                                          40800016
FIXMSG   EQU   *                                                        41000016
.X301001 ANOP                                                   XL03912 41050003
         MODESET EXTKEY=SUPR                                    YL02912 41100002
         NI    UCBFL2,X'FF'-X'40'  *** TURN-OFF NOT READY BUT.  ******* 41200016
         MODESET EXTKEY=DATAMGT                                 YL02912 41300002
         MVC   MSG6(3),UCBNAME         EBCDIC NAME TO MESSAGE.          41400016
         LA    GR4,INITIAL                                         O122 41430019
         CLI   DCBPTR,OFFLINE          OFFLINE LABEL REQUEST?   YL02912 41460002
         BNE   FIXMSGA                 NO-ANALYZE-ALL SET.         O122 41490019
         LA    GR4,LABELL              YES-POINT TO LABEL WORD.@Z30RSAG 41520003
FIXMSGA  MVC   MSG5+34(10),0(GR4)      FINISH SETTING UP MESSAGE.  O122 41550019
         SPACE                                                          41600016
         LA    R4,REPLY                REPLY ADDRESS.                   41800016
         LA    R3,WECB                 ECB ADDRESS FOR WTOR.            42000016
         LR    R1,R2                   INSURE ADDRESS IS SET FOR LIST.  42200016
         WTOR  ,(4),1,(3),MF=(E,(1))   ASK FOR PERMISSION TO INITIALIZE 42400016
*                                                                     * 42600016
         WAIT  ECB=WECB                AWAIT FOR REPLY.                 42800016
         CLI   REPLY,C'U'              DOES REPLY INDICATE 'USE'.       43000016
         BE    USE                     YES-GO BUILD A DEB.              43200016
         CLI   REPLY,C'T'              DOES REPLY INDICATE TERMINATE.   43400016
         BE    NOUSE                   YES--EXIT NOW.                   43600016
         MVC   MSG(WTOEND-WTO),WTO     MESSAGE TO BUFFER.               43800016
         LR    R1,R2                   ISURURE LIST ADDRESS IS SET.     44000016
         WTO   ,MF=(E,(1))             TELL OPERATOR ABUOT ERROR.       44200016
         B     TRYAGAIN                REPEAT THE REQUEST.              44400016
*                                                                     * 44600016
NOUSE    EQU   *                       DEB BUILDING TERMINATED.         44800016
         LA    R3,WTORP1-MSG           LENGTH OF WORK AREA.             45000002
         LR    R1,R2                   ADDRESS OF WORKAREA.             45200016
         BAL   GR9,FREECORE            GO FREE THE WORKAREA.            45400016
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 45500002
         LA    R15,8                   SET RETURN CODE.                 45600016
         B     EXIT2                    RETURN TO CALLER.       YL02912 45800002
         EJECT                                                          46000002
OFFLENQ  EQU   *                                                YL02912 46010002
         LA    GR4,SYSQ                 ADDR OF QNAME HDR       YL02912 46020002
         LA    GR6,Q4                   ADDR OF RNAME ID        YL02912 46030002
         L     GR7,TCBOTC               GET MOTHER' TCB ADDR    YM03804 46040002
         MVC   ENQLIST(SYSQ-ENQLISTF),ENQLISTF MOVE LIST TO W/A YM03804 46040402
*                                                                       46042002
         ENQ   ((GR4),(GR6),E,2,SYSTEM),RET=USE,TCB=(GR7),             *46044002
               MF=(E,ENQLIST)                                           46046002
*                                                                       46048002
         L     GR1,UCBPTR               DEQ'ED UCB ADDR         YL02912 46048402
         USING UCB,GR1                                                  46048802
         TM    UCBSTAT,UCBONLI          THIS UCB STILL OFFLINE? YL02912 46049202
         BO    ERR                      NO, DEQ AND LEAVE.      YL02912 46049602
         MODESET EXTKEY=SUPR                                    YL02912 46049702
         OI    UCBFL5,UCBNALOC          SET FLAG FOR DEV ALLOC  YL02912 46049802
*                                       AND VARY PROCESSOR.     YL02912 46074902
         MODESET EXTKEY=DATAMGT                                 YL02912 46084902
DEQU     EQU   *                                                YL02912 46087402
         DEQ   ((GR4),(GR6),2,SYSTEM),RET=HAVE,TCB=(GR7),       YL02912*46099902
               MF=(E,ENQLIST)                                           46109902
*                                                                       46119902
         BR    GR9                      EXIT                    YL02912 46129902
ERR      EQU   *                                                YL02912 46139902
         LA    GR9,ERREXIT              SVC RETURN CODE SET     YL02912 46141902
         B     DEQU                     DEQUEUE FROM SYSQ HDR   YL02912 46143902
ERREXIT  EQU   *                                                YL02912 46145902
         BAL   R9,FREEPARM              GO FREE PARM LIST.      YL02912 46146302
         LA    GR15,NOGO                SETUP SVC RETURN CODE   YL02912 46147902
         B     EXIT2                    EXIT TO DASDS           YL02912 46148302
         EJECT                                                  YL02912 46148702
         AIF  ('&LIB' EQ 'LIB2').X301002                        XL03912 46149902
         USING DATACELL,GR6                                             46200016
W2321    MVC   MSG6+4(1),DCELBBNR+1    BIN NO. TO MESSAGE.              46400016
         OI    MSG6+4,X'F0'            SET ZONE BITS.                   46600016
         MVI   MSG6+3,SLASH            BIN SEPARATOR.                   46800016
         BAL   GR14,CONV2321           FIND MAIN UCB ADDRESS.           47000016
         B     FIXMSG                  GO COMPLETE THE MESSAGE.         47200016
.X301002 ANOP                                                   XL03912 47250003
*********************************************************************** 47600016
*                                                                     * 47800016
*   BUILD A DEB FOR A NEW VOLUME HERE.                                * 48000016
*                                                                     * 48200016
*********************************************************************** 48400016
USE      EQU   *                       OKAY TO BUILD A DEB.             48800016
         LA    R3,WTORP1-MSG           LENGTH OF WORK AREA.             49000002
         LR    R1,R2                   ADDRESS OF WORKAREA.             49200016
         BAL   GR9,FREECORE            GO FREE THE WORKAREA.            49400016
         L     R3,DCBPTR                DCB ADDRESS.            YL02912 49600002
         LA    R2,DEBEND-MYDEB         SIZE OF DEB.                     49800016
         USING MYDEB,GR1                                         YM4604 49850002
         GETMAIN R,LV=(2),SP=230                                 YM4604 50010002
         LR    R2,R1                   SAVE AREA ADDRESS.        YM4604 50020002
         XC    MYDEB(DEBEND-MYDEB),MYDEB  CLEAR DEB TO ZER.      YM4604 50030002
         BAL   GR9,OFFLENQ              ENQ FOR OFFLINE UCB     YL02912 50050002
         BAL   R9,BUILDDEB             GO BUILD A DEB.                  50200016
         AIF   ('&LIB' EQ 'LIB2').WM007                                 50250000
         ST    R4,44(R3)                DEB ADDRESS TO DCB              50300000
.WM007   ANOP                                                           50350000
         USING IOBLOCKS,GR2                                             50600016
         L     R4,DEBAPPAD-1           ADDRESS OF APPENDAGE TABL5#      50800016
         MVC   DEBEOEA(20),0(R4)       PLACE IN DEB.                    51000016
         LA    R4,DEBEOEA              ADDRESS OF NEW TABLE.            51200016
         ST    R4,DEBAPPAD-1           SAVE ADDRESS IN DEB.             51400016
         MVZ   DEBDEBID(L1),TCBPKF      PROTECT KEY TO DEB.     YL02912 51600002
         CLI   FUNCTION,POSTSPEC        OFFLINE LABEL REQUEST?  YL02912 51700002
         BE    EXIT                     YES, NOT NEED APPENDAGE.YL02912 51800002
         EJECT                                                          51900002
*********************************************************************** 52000016
*                                                                     * 52200016
*   LOAD IN THE ABNORMAL END APPENDAGE HERE.                          * 52400016
*                                                                     * 52600016
*********************************************************************** 52800016
         USING CVT,1                                                    53200016
         L     GR1,CVTPTR              CVT ADDRESS.                     53400016
         L     GR4,CVTSVDCB            DCB ADDRESS.                     53600000
         LOAD  EP=IGG019P9,DCB=(4)                                      53800000
         ST    R0,DEBXCEA              PLACE ADDRESS IN DEB.            54000016
         AIF   ('&LIB' EQ 'LIB1').WM001                                 54050000
         SRL   GR1,7(0)                SAVE SIZE OF MODULE       M4873  54060000
         LA    GR1,1(GR1)              IN 2K BYTES IN            M4873  54080000
         STC   GR1,DEBXCEA             AVT TABLE                 M4873  54090000
         LOAD  EP=IGG019P7,DCB=(4)     LOAD PAGE FIX APPENDAGE   M5431  54092000
         ST    R0,DEBSIOA              PLACE ADDRESS IN DEB       M5431 54094000
         SRL   GR1,7(0)                SAVE SIZE OF MODULE        M5431 54096000
         LA    GR1,1(GR1)              IN 2K BYTES IN             M5431 54098000
         STC   GR1,DEBSIOA             AVT TABLE                  M5431 54098400
         OI    DEBSIOA,PGFIXBIT        SHOW APPENDAGE IS PAGE FIX M5431 54098800
.WM001   ANOP                                                           54099200
         B     EXIT                     RETURN TO CALLER.       YL02912 54100002
         DROP  2                                                        54600016
         EJECT                                                          54800016
*********************************************************************** 55000016
*                                                                     * 55200016
*   ASSIGN ALTERNATE TRACKS HERE.                                     * 55400016
*        1)    GETALT REQUEST(MUST READ IN FORMAT4 DSCB)              * 55600016
*        2)    ANALYZE/FORMAT REQUEST.                                * 55800016
*                                                                     * 56000016
*********************************************************************** 56200016
         SPACE 3                                                        56400016
ASSGALT  EQU   *                       GETALT/DYNAMIC TRACK ASSIGN.     56600016
         LA    R2,IOEND-MYDEB          SIZE OF GETMAIN AREA.            56800016
         LR    R4,R2                   SIZE OF AREA.             YM6524 56850002
         BAL   R9,GETMAIN              OBTAIN A WORK AREA.       YM6524 56900002
         USING IOBLOCKS,R2                                       YM6524 56950002
         XC    IOEND1(IOEND-IOEND1),IOEND1    CLEAR EXTENSION.   YM6524 56960002
         B     CLEAR                   GO TO CLEAR REST.         YM6524 57000002
         SPACE 3                                                        57200016
         USING MYDEB,GR1                                         YM6524 57250002
GETMAIN  EQU   *                                                 YM6524 57300002
         GETMAIN R,LV=(2),SP=229                                 YM6524 57350002
         LR    R2,R1                   SAVE AREA ADDRESS.        YM6524 57360002
         XC    MYDEB(DEBEND-MYDEB),MYDEB  CLEAR DEB TO ZER.      YM6524 57370002
         BR    R9                      RETURN.                   YM6524 57380002
         SPACE 3                                                 YM6524 57390002
ASGALT1  EQU   *                                                        57400016
         LA    R2,IOEND1-MYDEB         SIZE OF GETMAIN AREA.            57600016
         LR    R4,R2                   SIZE OF AREA.                    58000016
         BAL   R9,GETMAIN              OBTAIN A WORK AREA.       YM6524 59260002
CLEAR    STH   R4,SIZE                 REMEMBER THE SIZE.        YM6524 59310002
         XC    ECB(IOEND1-ECB),ECB     CLEAR PART OF WORK AREA.  YM6524 59360002
         LA    GR3,DCB-44              DCB ADDRESS.                     59400016
         BAL   R9,BUILDDEB             GO BUILD A DEB.                  59600016
         ST    R4,DCB                  DEB ADDRESS TO DCB.              59800016
         LR    GR3,GR11                PARM LIST POINTER.               60000016
         LR    GR4,GR2                 WORKAREA POINTER.                60200016
         L     GR7,UCBPTR               ADDRESS OF UCB.         YL02912 60220002
         USING UCB,GR7                                           S20201 60240020
         MODESET EXTKEY=SUPR                                    YL02912 60250002
         CLI   UCBTBYT4,X06             IS THIS A 2305 MOD 1.    S20201 60260020
         BE    ASGALT3                  YES                      S20201 60280020
         CLI   UCBTBYT4,X07             IS THIS A 2305 MOD 2.    S20201 60300020
         BE    ASGALT3                                           S20201 60320020
         STM   GR3,GR5,RBEXSAVE+K16     STORE 2ND LOAD LIST.    YL02912 60400002
         LA    GR1,RBEXSAVE+K16         LIST ADDR FOR 2ND LOAD. YL02912 60600002
         LA    GR4,XCTL                XCTL LIST FOR NEXT LOAD.         60800016
         B     NEXTLOAD                                          S20201 60820020
ASGALT3  EQU   *                                                 S20201 60840020
         DROP  GR7                                               S20201 60860020
         STM   GR3,GR5,RBEXSAVE+K16     STORE 4TH LOAD LIST.    YL02912 60880002
         LA    GR1,RBEXSAVE+K16         LIST ADDR FOR 4TH LOAD. YL02912 60900002
         LA    GR4,XCTL2                                         S20201 60920020
         SPACE 2                                                        61000016
NEXTLOAD EQU   *                       MUST BRING IN THE NEXT LOAD.     61200016
         MVC   RBEXSAVE(XCTLEND-XCTL),E0(GR4)  GET XCTL LIST.   YL02912 61400002
         LA    GR15,RBEXSAVE            ADDR OF EXTENDED AREA.  YL02912 61600002
         LA    GR6,8(GR15)             ADDRESS OF ENTRY POINT.          61800016
         ST    GR6,0(GR15)             STORE IN LIST LIST.              62000016
         MODESET EXTKEY=DATAMGT                                  YM1315 62050002
         XCTL  ,MF=(E,(1)),SF=(E,(15))                          YM03870 62200002
         EJECT                                                          62400016
*********************************************************************** 62600016
*                                                                     * 62800016
*   BUILD A DEB HERE.                                                 * 63000016
*        R3 CONTAINS THE DCB ADDRESS UPON INPUT.                        63200016
*        R4 CONTAINS THE DEB ADDRESS UPON EXIT.                         63400016
*        R9 IS THE RETURN REGISTER.                                     63600016
*                                                                     * 63800016
*********************************************************************** 64000016
BUILDDEB EQU   *                                                        64200016
         MVI   DEBNMEXT,1              SET NO. OF EXTENTS.              64400016
         MVI   DEBENDCC,X'7F'          SET UPPER EXTENT LIMIT.          64600016
         MVI   DEBNMTRK,X'7F'          SET NO. OF TRACKS.               64800016
         ST    R3,DEBDCBAD-1           DCB ADDRESS TO DEB.              65000016
         MVI   DEBDEBID,X'0F'          PROTECT KEY//ID.                 65200016
         AIF  ('&LIB' EQ 'LIB2').X301003                        XL03912 65250003
         L     GR4,UCBPTR               ADDRESS OF UCB.         YL02912 65400002
         USING UCB,GR4                                                  65600016
         CLI   UCBTBYT4,X06             IS THIS A 2305-1.        S20201 65620020
         BE    SW2305                   SET 2305 SWITCH.         S20201 65640020
         CLI   UCBTBYT4,X07             IS THIS A 2305-2.        S20201 65660020
         BNE   CHK2321                  NO-CHECK FOR 2321        S20201 65680020
SW2305   EQU   *                                                 S20201 65700020
         OI    DEVTYP,MAINUCB           YES-SET DEVICE BYTE.     S20201 65720020
         B     BUILD                    CONTINUE PROCESS         S20201 65740020
CHK2321  EQU   *                                                 S20201 65760020
         CLI   UCBID,MAINUCB           THIS A 2321.                     65800016
         DROP  GR4                                                      66000016
         BNE   DEB2321                 YES-GO PROCESS                   66200016
BUILD    EQU   *                        *                        S20201 66300020
.X301003 ANOP                                                   XL03912 66350003
         MVC   DEBUCBAD(L3),UCBPTR+D1   UCB ADDRESS TO DEB.     YL02912 66400002
BUILD1   MVI   DEBDVMOD,X'C0'          SET THE FILE MASK.               66600016
         L     R4,CVTPTR               ADDRESS OF CVT.                  66800016
         USING CVT,R4                                                   67000016
         L     R4,CVTXAPG              APPENDAGE TABLE ADDRESS.         67200016
         DROP  R4                                                       67400016
         ST    R4,DEBAPPAD-1           STORE IN DEB.                    67600016
         LA    R4,DEB                  DEB ADDRESS.                     67800016
         AIF   ('&LIB' EQ 'LIB1').WM006                                 67810000
         CLI   FUNCTION,NEWVOL          NEW VOLUME REQUEST?     YL02912 67820002
         BNE   NOCHK4                   NO, DEB WILL NOT BE      Y01021 67860000
*                                       VALIDATED                Y01021 67880000
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLERS KEY.        YL02912 67885002
         ST    R4,E44(R3)               DEB ADDR TO DCB          Y01021 67890000
         MODESET EXTKEY=DATAMGT                                 YL02912 67891002
         EJECT                                                          67891402
**********************************************************************  67892000
*        PLACE DEB ON TCB DEB CHAIN                                  *  67894000
**********************************************************************  67896000
         SPACE                                                          67896402
         USING DEB,GR4                                          YL02912 67897602
         ST    R8,DEBTCBAD-D1           PUT TCB PTR IN DEB      YL02912 67898002
         L     R7,TCBDEB                GET DEB PTR FROM TCB    YL02912 67898402
         ST    R7,DEBDEBAD-D1           DEB CHAIN PTR TO MY DEB.YL02912 67908002
         MODESET EXTKEY=SUPR                                    YL02912 67908402
         ST    R4,TCBDEB                CHAIN MY DEB.           YL02912 67910002
         MODESET EXTKEY=DATAMGT                                 YL02912 67912002
         DEBCHK (R3),TYPE=ADD,AM=EXCP                            YM0960 67913300
         LR    GR1,GR11                 RESTORE PARM POINTER     YM2646 67915300
NOCHK4   EQU   *                                                 Y01021 67920000
.WM006   ANOP                                                           67970000
         BR    R9                      RETURN.                          68000016
         AIF  ('&LIB' EQ 'LIB2').X301004                        XL03912 68050003
         SPACE                                                          68200016
         USING DATACELL,GR6                                             68400016
DEB2321  LR    GR6,GR4                 SUB-UCB ADDRESS.                 68600016
         MVC   DEBBINNO(2),DCELBBNR    BIN NO. TO DEB.                  68800016
         BAL   GR14,CONV2321           CONVERT SUB TO MAIN UCB ADDRESS. 69000016
         ST    GR6,DEBUCBAD-1          MAIN UCB ADDRESS TO DEB.         69200016
         B     BUILD1                  GO FINISH THE DEB.               69400016
         DROP  6                                                        69600016
         SPACE 3                                                        69800016
CONV2321 LH    GR10,0(GR6)             PICK UP BIN NO.                  70000016
         SLA   GR10,4                  TIMES SIXTEEN.                   70200016
         LA    GR10,DATACELL-UCBOB(GR10)  ADD LENGTH OF MAIN.           70400016
         LCR   GR10,GR10               NEGATE.                          70600016
         AR    GR6,GR10                ADDRESS OF MAIN.                 70800016
         BR    GR14                    RETURN.                          71000016
.X301004 ANOP                                                   XL03912 71050003
         EJECT                                                          71200016
         AIF   ('&LIB' EQ 'LIB1').WM005                                 71250000
.WM005   ANOP                                                           71350000
         DROP  R2                                                       71600016
XCTL     XCTL  EP=IGC0108B,SF=L        LIST FORM .                      71800016
XCTLEND  DS    0C                      END OF XCTL LIST.                72000016
XCTL1    XCTL  EP=IGC0208B,SF=L        LIST FORM.  2ND LOAD.            72200016
XCTL2    XCTL  EP=IGC0308B,SF=L         LIST FORM. 3RD LOAD.     S20201 72250020
XCTL3    XCTL  EP=IGC0408B,SF=L         LIST FORM. SS/1 LOAD.  @Y30LSFY 72250503
DEVTYP   DC    X'00'                    DEVICE TYPE SWITCH.      S20201 72300003
K16      EQU   16                       DISPLACEMENT CONSTANT    S20201 72350020
         SPACE 1                                                        72400016
WTORP    WTOR  'IEH841D        CONFIRM REQUEST TO           ',0,1, O122X72600019
               0,ROUTCDE=(4),DESC=(2),MF=L                         MC0I 72800018
WTOREND  DS    0C                      END OF WTOR.                     73000016
         SPACE                                                          73200016
WTO      WTO   'IEH808I REPLY IN ERROR. REPLY WITH U OR T',        MC0IX73300018
               ROUTCDE=(4),DESC=(5),MF=L                           MC0I 73400018
WTOEND   DS    0C                                                       73600016
DEBLEN   DS    0F                                                A34646 73650020
         DC    X'E5'                    SUB POOL NUMBER.        YL02912 73700002
         DC    AL3(DEBEND-MYDEB)        LENGTH OF DEB FOR        Y01021 73750000
*                                       VALIDATION               Y01021 73770000
MAINT    DS    10F                      MAINTENANCE AREA        XL02912 73772002
         AIF   ('&LIB' EQ 'LIB1').X227904                        YM3475 73777002
BLANKS   DC    X'40404040'              OFFLINE DDNAME END.      YM3475 73784002
.X227904 ANOP                                                    YM3475 73791002
SS1CONV  EQU   X'01'                   INDIC SS1 CONVERSION    @Y30LSFY 73793003
LABELL   DC    C'LABEL     '           USED FRO LABEL OFFLINE.     O122 73860003
INITIAL  DC    C'INITIALIZE'           USED FOR OFFLINE DASDI.     O122 73920019
ENQLISTF ENQ   (QHDR,,E,6,SYSTEM),TCB=,RET=USE,MF=L             YM03804 73970002
SYSQ     DC    C'SYSIEFSD'              ENQ/DEQ QNAME HEADER    YL02912 73972002
QHDR     DC    C'SYSZVOLS'             ONLINE ENQ HEADER        YM03804 73972402
Q4       DC    C'Q4'                    ENQ/DEQ RNAME HEADER    YL02912 73974002
NOGO     EQU   8                        ENQ FAILED RETURN CODE. YL02912 73980002
         SPACE                                                          74000016
SENSCCW  CCW   4,SENSCCW,X'20',6        SENSE CMD               XL03130 74002003
MAINTNC  DS    50D                      MAINTENANCE AREA        XL03130 74004003
GOODRT   EQU   X'7F'                    GOOD ECB RETURN CODE    XL03130 74010003
MASK     EQU   X'FF'                    'AND' MASK              XL03130 74012003
TCBKOFST EQU   28                       OFFSET TO TCB KEY       XL03130 74020003
MOD1     EQU   X'01'                    MODEL ONE SENSE VAL     XL03130 74022003
MOD2     EQU   X'02'                    MODEL TWO SENSE VAL     XL03130 74024003
L1       EQU   1                                                XL03130 74030003
L4       EQU   4                                                XL03130 74032003
L2       EQU   2                                                XL03130 74040003
DEBID    EQU   X'0F'                    DEB ID                  XL03130 74042003
L7       EQU   7                        OFFSET TO USERS' R.C.   XL03130 74044003
SENSEOP  EQU   X'04'                    SENSE OP CODE           XL03130 74048403
L88      EQU   88                       LENGTH OF EXCP CTL BLKS XL03130 74048803
BUMP     EQU   X'28'                    ADDR ADJUSTMENT         XL03130 74049203
CTLBLKS  DSECT                                                  XL03130 74050003
DCBORG   DS    7F                       DCB                     XL03130 74100003
DEBORG   DS    3F                       DEB                     XL03130 74150003
ECB1     DS    1F                       ECB                     XL03130 74160003
DCBDEB   DS    A                        DCB+2C                  XL03130 74170003
DEBPURG  DS    F                        DEB+14                  XL03130 74180003
DEBDCB   DS    A                        DEB+18                  XL03130 74190003
DEBAPP   DS    F                        DEB+1C                  XL03130 74192003
DEBUCB   DS    A                        DEB+20                  XL03130 74194003
DEBSKA   DS    2F                       DEB                     XL03130 74196003
IOB1     DS    F                        IOB                     XL03130 74198003
IOBECB   DS    A                        IOB+4                   XL03130 74198403
         DS    2F                       FILL                    XL03130 74198803
IOBCCW   DS    A                        IOB+10                  XL03130 74199203
IOBDCB   DS    A                        IOB+14                  XL03130 74199603
SENSE    DS    2F                       INPUT BUFFER            XL03130 74199703
IOBSKA   DS    2F                       IOB+20                  XL03130 74199803
CCW      DS    D                        SENSE CMD               XL03130 74199903
MSG      DSECT                                                          74200016
         DS    0D                                                       74400016
MSG1     DS    CL1                     REPLY LENGTH.                    74600016
MSG2     DS    CL3                     REPLY ADDRESS.                   74800016
MSG3     DS    CL4                     ECD ADDRESS.                     75000016
MSG4     DS    CL2                     MESSAGE LENGTH.                  75200016
         DS    CL2                                                      75400016
MSG5     DS    CL44                    MESSAGE BODY                MC0I 75600018
MSG55    DS    CL4                     MCS FLAGS/CODES.            MC0I 75700018
MSG6     EQU   MSG5+8                  CUU OR CUU/B                MC0I 75800018
WECB     DS    CL4                     ECB FOR WTOR.                    76000016
REPLY    DS    CL1                     REPLY AREA.                      76200016
WTORP1   DS    0C                                                       76400016
         EJECT                                                          76600016
IOBLOCKS DSECT                                                          76800016
MYDEB    EQU   *                       DEB DEFINITION.                  77000016
DEBEOEA  DS    1F                      END-OF-EXTENT.                   77200016
DEBSIOA  DS    1F                      START I/O.                       77400016
DEBPCIA  DS    1F                      PCI.                             77600016
DEBCEA   DS    1F                      CHANNEL END.                     77800016
DEBXCEA  DS    1F                      ABNORMAL END.                    78000016
         DS    CL12                                                     78200016
DEBLNGTH DS    CL1                     DEB LENGTH(DOUBLE WORDS)         78400016
         DS    CL3                                                      78600016
DEB      EQU   *                       DEB PROPER                       78800016
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                79000016
DEBTCBAD DS    CL3                     TCB ADDRESS.                     79200016
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            79400016
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                79600016
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  79800016
DEBIRBAD DS    CL3                     IRB ADDRESS.                     80000016
DEBOPATB DS    CL1                     TYPE OF I/O.                     80200016
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       80400016
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  80600016
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          80800016
DEBPRIOR DS    CL1                     ZERO                             81000016
DEBECBAD DS    CL3                     PURGE ECB.                       81200016
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 81400016
DEBDCBAD DS    CL3                     DCB ADDRESS.                     81600016
DEBEXSCL DS    CL1                     EXTENT SCALE.                    81800016
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          82000016
DEBDVMOD DS    CL1                     FILE MASK.                       82200016
DEBUCBAD DS    CL3                     UCB ADDRESS.                     82400016
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                82600016
DEBSTRCC DS    CL2                     CYLINDER START.                  82800016
DEBSTRHH DS    CL2                     HEAD START.                      83000016
DEBENDCC DS    CL2                     CYLINDER END.                    83200016
DEBENDHH DS    CL2                     HEAD END.                        83400016
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                83600016
         DS    CL20                                                     83800016
DEBEND   DS    0C                      END OF DEB.                      84000016
         EJECT                                                          84200016
ECB      DS    1F                      ECB HERE.                        84400016
IOB      EQU   *                       IOB HERE.                        84600016
IOBFLAG1 DS    CL1                     FLAG1                            84800016
IOBFLAG2 DS    CL1                     FLAG2.                           85000016
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 85200016
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  85400016
IOBECBAD DS    CL4                     ADDRESS OF ECB.                  85600016
IOBCSW   DS    CL8                     STATUS WORDS.                    85800016
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         86000016
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  86200016
IOBRESTR DS    CL4                     RESTART ADDRESS.                 86400016
IOBINCAM DS    CL2                     BLOCK COUNT.                     86600016
IOBERRCT DS    CL2                     ERROR COUNT.                     86800016
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    87000016
CCHHR    EQU   IOBSEEK+3               SEARCH ADDRESS.                  87200016
DCB      DS    1F                      DEB ADDRESS.                     87400016
ALTINFO  DS    1D                      KEEP ALTERNATE TRACK INFO HERE.  87600016
         AIF  ('&LIB' EQ 'LIB1').X302300                        XL03130 87650003
SCHHA    DS    1D                      SEARCH HOME ADDR.        XL03130 87700003
TICSRCH  DS    1D                      TIC ON SEARCH.           XL03130 87710003
.X302300 ANOP                                                   XL03130 87750003
WRTHA    DS    1D                      WRITE HOME ADDRESS.              87800016
WRTR0    DS    1D                      WRITE RECORD ZERO.               88000016
R0DATA   DS    1D                                              @Z30RSAG 88050003
RDHA     DS    1D                      READ HOME ADDRESS.               88200016
READR0   DS    1D                      READ RECORD ZERO.                88400016
         AIF   ('&LIB' EQ 'LIB1').X227800                       XL03130 88450003
         DS    CL6                      RESERVED.               XL03130 88500003
MADSD    DS    CL4                  3350 ADDITIONAL SD BYTES   @X50RSPC 88510003
WINHA    DS    CL2                      3340 HOME ADDRESS.      XL03130 88550003
.X227800 ANOP                                                   XL03130 88560003
HA       DS    CL5                     HOME ADDRESS.                    88600016
SW       DS    CL1                     SWITCH.                          88800016
D2314    EQU   X'80'                   2314 DEVICE.                     89000016
D2321    EQU   X'40'                   2321 DEVICE.                     89200016
SIZE     DS    CL2                     SIZE OF GETMAIN AREA.            89600016
R0COUNT  DS    1D                      RECORD ZERO COUNT FIELD.         89800016
         DS    1D                      RECORD ZERO DATA  FIELD.@X50RSPC 90000003
         AIF   ('&LIB' EQ 'LIB1').X322203                        XM4405 90050003
SNSBYTES DS    CL24                    3340 SENSE BYTE AREA.     XM4405 90100003
.X322203 ANOP                                                    XM4405 90150003
RETSW    DS    CL1                     RETRY SW USED IN 108B   @ZA04363 90160003
IOEND1   DS    0C                      END OF BASIC I/O BLOCKS.         90200016
*   EXTENSION FOR GETALT//DYNAMIC TRACK REQUEST.                        90400016
SEARCH   DS    1D                      SEARCH CCW.                      90600016
TIC      DS    1D                      REPEAT UNTIL FOUND.              90800016
WRTRD    DS    1D                      WRITE OR READ DATA.              91000016
FORMAT4  DS    CL96                    FORMAT4 DSCB READ IN AREA.       91200016
VTOCCCHH EQU   FORMAT4+63              CCHH START OF VTOC.              91600016
IOEND    DS    0C                                                       91800016
         EJECT                                                          91809002
*********************************************************************** 91818002
*                                                                     * 91827002
*   PARAMETER LIST DSECT                                              * 91836002
*                                                                     * 91845002
         IEHDBLKS                                              @Z30RSAG 91850003
*********************************************************************** 91854002
         SPACE 2                                                        91863002
PARMLIST DSECT                                                  YL02912 91872002
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 91881002
UCBPTR   DS    F                        UCB POINTER.            YL02912 91890002
DCBPTR   DS    F                        DCB POINTER OR          YL02912 91899002
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 91908002
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 91917002
WINMOD   EQU   DCBPTR+3                 3340 MODEL NO.          YL02912 91919002
SENSFB   EQU   DCBPTR                   FUNCTION BLK ADDR      @Z30RSAG 91921003
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 91926002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 91935002
DEBPTR   DS    F                        DEB POINTER OR          YL02912 91944002
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 91953002
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 91962002
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 91971002
EDQLIST  DS    4F                       ENQ/DEQ PARAM LIST      SJ0054  91971402
ENQLIST  EQU   EDQLIST+4                                        SJ0054  91971802
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 91980002
         EJECT                                                          92000016
CVT      DSECT                                                          92200016
         CVT   SYS=MIN                                                  92400016
         IKJTCB LIST=YES                                                92450002
         EJECT                                                          92500002
         IHARB DSECT=YES                                                92550002
         EJECT                                                          92600016
UCB      DSECT                                                          92800016
         IEFUCBOB                                                       93000016
         END                                                            93200016
