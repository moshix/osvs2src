*30740007*************************************************************  42720003
         TITLE 'IGC0009G - BREAKPOINT PROCESSING PORTION'               42730003
         COPY  IKJEGSIO                                                 42760003
         EJECT                                                          42800003
IGC0009G CSECT                                                          42840003
*A390600-391000                                                @YM00583 42850003
*A392600-393777                                                @YM00583 42880003
*A712500-714000                                                @YM04131 42920003
*C742522-742523,742533,783887-783957,784611                    @YM04131 42960003
*A717204-719620                                                @YM04107 42970003
*A361416,361554-361609,361944,36198,367000,793276              @YM07115 43000003
*C784445                                                       @YM06379 43040003
*C401722                                                       @YM07131 43080003
*A334500-335500                                                @ZA00823 43090003
*D212000-212500                                                @ZA00874 43120003
*A196200,196700                                                @ZA00889 43160003
*C447500,449000                                                @ZA02713 43200003
*A15860000,16060000-16070000,28210000,56660000,56670000        @ZA02953 43210003
*C20100000                                                     @ZA03232 43240003
*C274000,276500,515500-515700,517000,557600,557700             @ZA04126 43280003
*C153000                                                       @ZA06203 43320003
*D360000,458500-464000                                         @ZA05688 43330003
*A404510-404920,                                               @ZA05687 43360003
*A77200,448100-448200,496040-496300                            @ZA05687 43400003
*A476510-476940                                               @ZA06226  43440003
*A207340,218700,396100,396200,405700,553440 @ZA07138,@ZA09259,@ZA10462  43450003
*A078100-078200,516100-516420,513600,545600-545910            @ZA10530  43480003
*C078500,516600,531500,519500                                 @ZA10530  43520003
*A181100-181700                                               @ZA11325  43560003
*A395600-395900,416100-416400                                 @ZA11342  43570003
*A476537-476566                                               @ZA11359  43620003
*A767100,773100                                               @ZA17744  43620503
*A681700-681820,682900-683100,746500-746900,750300-750500     @ZA26084  43621003
*C683100,747000,753000,755100,756000-756300,756900,765000     @ZA26084  43621503
*C765900-766200,771300,771900-772500,776700,779100,           @ZA26084  43622003
*A782200-782300                                               @ZA26084  43622503
*A682502-682504,C682524                                       @ZA29216  43623003
*A715900,717400,719200,720700,844600,C772100                  @ZA31527  43623503
*********************************************************************** 43625003
*                                                                     * 43680003
* STATUS --                                                           * 43690003
*                                                                     * 43720003
*    CHANGE LEVEL 00, OS/VS2 RELEASE 2  , 07/06/73                    * 43760003
*                                                                     * 43800003
* FUNCTION --                                                         * 43820003
*                                                                     * 43860003
*    THIS SVC ROUTINE IS A TYPE 3 SVC USED BY TSO TEST FOR TWO        * 43880003
*    PURPOSES -- (1) TO PASS CONTROL FROM THE PROGRAM BEING TESTED    * 43920003
*    TO TSO TEST AT PREDETERMINED LOCATIONS, AND (2) TO MODIFY        * 43940003
*    SYSTEM CONTROL BLOCKS (TCB, RB, ETC.) FOR TSO TEST.  THIS SVC    * 43980003
*    ROUTINE IS DIVIDED INTO TWO LOGICAL PARTS, ONE WHICH PROCESSES   * 44000003
*    A BREAKPOINT AND THE OTHER WHICH ACTS AS A SERVICE ROUTINE       * 44040003
*    FOR TSO TEST.                                                    * 44060003
*                                                                     * 44100003
* ENTRY POINTS --                                                     * 44120003
*                                                                     * 44160003
*         IGC0009G -- ENTRY POINT OF THIS SVC ROUTINE.                * 44180003
*                                                                     * 44220003
* INPUT --                                                            * 44240003
*                                                                     * 44280003
*    BREAKPOINT PROCESSING -- N/A                                     * 44300003
*                                                                     * 44340003
*    SERVICE ROUTINE PROCESSING --  REGISTER 1 POINTS TO A THREE      * 44360003
*    WORD PARAMETER LIST OF THE FOLLOWING FORMAT --                   * 44400003
*                                                                     * 44420003
*              ......................................                 * 44440003
*              .                                    .                 * 44460003
*           +0 . ADDRESS OF A TCB, PRB OR IRB       .                 * 44480003
*              ......................................                 * 44500003
*              .                                    .                 * 44520003
*           +4 . VALUE, OR ADDRESS OF VALUE         .                 * 44540003
*              ......................................                 * 44560003
*              .        .        .                  .                 * 44580003
*           +8 . FLAGS1 . FLAGS2 . REGISTER NUMBER  .                 * 44600003
*              ......................................                 * 44620003
*                                                                     * 44750003
* OUTPUT --                                                           * 44770003
*                                                                     * 44800003
*    BREAKPOINT PROCESSING -- N/A                                     * 44850003
*                                                                     * 44860003
*    SERVICE ROUTINE PROCESSING -- REGISTER 15 ALWAYS CONTAINS        * 44910003
*    A RETRUN CODE.  RETURN CODES ARE --                              * 44920003
*                                                                     * 44950003
*        0 --  SUCCESSFUL COMPLETION (FOR ADDRESS VALIDITY            * 44990003
*              CHECKING, ADDRESS IS BOTH READABLE AND WRITEABLE).     * 45030003
*        4 --  AN ERROR OCCURRED (FOR ADDRESS VALIDITY CHECKING,      * 45040003
*              ADDRESS IS ONLY READABLE).                             * 45070003
*        8 --  FOR ADDRESS VALIDITY CHECKING ONLY, ADDRESS IS         * 45110003
*              INVALID.                                               * 45150003
*        16 --  ONLY WHEN IO IS INVOKED AND AN ATTN OCCURS.           * 45160003
*        20 --  ONLY WHEN AN ABEND HAS OCCURED AND MY RETRY ROUTINE   * 45190003
*               RECOVERED                                             * 45230003
*        24 --  ONLY WHEN THE SVC WAS UNABLE TO ISSUE AN ESTAE.       * 45270003
*                                                                     * 45280003
* EXTERNAL REFERENCES --                                              * 45310003
*                                                                     * 45350003
*         IEA0VL00 - RESIDENT ADDRESS VALIDITY CHECK ROUTINE.         * 45390003
*                                                                     * 45400003
*    MACROS USED --                                                   * 45430003
*                                                                     * 45470003
*         BRKELEM  - BREAKPOINT ELEMENT.                              * 45510003
*         CVT      - COMMUNICATIONS VECTOR TABLE MAPPING MACRO.       * 45520003
*         FREEMAIN - RETURN MEMORY TO OPERATING SYSTEM.               * 45550003
*         GETMAIN  - GET MEMORY FROM OPERATING SYSTEM.                * 45590003
*         IKJEGS9G - INPUT PARAMETER LIST MAPPING MACRO.              * 45630003
*         IKJRB    - REQUEST BLOCK MAPPING MACRO.                     * 45640003
*         IKJTCB   - TASK CONTROL BLOCK MAPPING MACRO.                * 45670003
*         MODESET  - ENABLE/DISABLE INTERRUPTS.                       * 45710003
*         POST     - INDICATE EVENT COMPLETE.                         * 45750003
*         TCOMTAB  - TEST COMMUNICATION TABLE MAPPING MACRO.          * 45760003
*         WAIT     - WAIT ON EVENT TO COMPLETE.                       * 45790003
*                                                                     * 45830003
* EXITS, NORMAL  --                                                   * 45870003
*                                                                     * 45880003
*    FOR BOTH THE BREAKPOINT FUNCTION AND THE SERVICE ROUTINE         * 45910003
*    FUNCTION, RETURN IS MADE BY A BRANCH REGISTER ON REGISTER 14.    * 45950003
*                                                                     * 45990003
* EXITS, ERROR --                                                     * 46000003
*                                                                     * 46030003
*    FOR BOTH THE BREAKPOINT FUNCTION AND THE SERVICE ROUTINE         * 46070003
*    FUNCTION, RETURN IS MADE BY A BRANCH REGISTER ON REGISTER 14.    * 46110003
*                                                                     * 46120003
* TABLES/WORK AREAS --                                                * 46150003
*                                                                     * 46190003
*    THE FOLLOWING FIELDS IN THE TCB ARE UPDATED --                   * 46230003
*              TCBABF (TCBTCP)                                        * 46240003
*              TCBTRNB                                                * 46270003
*              TCBTSFLG (TCBATT)                                      * 46310003
*              TCBFRS                                                 * 46350003
*    THE FOLLOWING FIELDS IN THE USER'S PROGRAM PRB ARE UPDATED --    * 46360003
*              RBOPSW (RESUME ADDRESS PORTION ONLY)                   * 46390003
*              RBWCF                                                  * 46430003
*    THE FOLLOWING FIELDS IN SVC 97'S SVRB ARE UPDATED --             * 46470003
*              RBGRSAVE                                               * 46480003
*    THE FOLLOWING FIELDS IN TCOMTAB ARE UPDATED --                   * 46510003
*              TSTMTASK                                               * 46550003
*              TSTSVCQ                                                * 46590003
*              PPTCB                                                  * 46600003
*              ECBPP                                                  * 46630003
*    THE FOLLOWING FIELDS IN THE BRKELEM ARE UPDATED --               * 46670003
*              BRKCOUNT                                               * 46710003
*              BRKRB                                                  * 46720003
*                                                                     * 46750003
* ATTRIBUTES --                                                       * 46790003
*                                                                     * 46830003
*    PRIVILEGED, ENABLED, REENTRANT, REFRESHABLE                      * 46840003
*                                                                     * 46870003
* CHARACTER CODE DEPENDENCY --                                        * 46910003
*                                                                     * 46950003
*    THIS ROUTINE IS CHARACTER CODE INDEPENDENT.                      * 46960003
*                                                                     * 46990003
* NOTES --                                                            * 47030003
*                                                                     * 47070003
*    THIS SVC IS BROKEN INTO TWO PARTS --                             * 47080003
*    (1) THE BREAKPOINT FUNCTION STARTS AT LABEL 'IGC0009G'           * 47110003
*    (2) THE TEST SERVICE FUNCTION STARTS AT LABEL 'TSTSVC01'         * 47150003
*                                                                       47190003
* CHANGE-ACTIVITY -                                                     47200003
*                 APAR OZ07138 - CHANGES TO PROVIDE MNL A POINTER       47230003
*                 TO THE POSTING SVRB. ECBPP+1 IS THE POINTER.          47270003
*                 IT IS IN TCOMTAB AND SERIALIZED AT THE TASK LEVEL     47310003
*                 VIA ENQ. ANY PRIOR SVRB POINTER IS SAVED IN THE       47320003
*                 SVRB WORKAREA AT WRKSVRBS AND RESTORED BEFORE         47350003
*                 THE DEQ AND RETURN.                                   47390003
*                 APAR OZ09259 - SAME AS ABOVE.                         47430003
*                 APAR OZ10462 - SAME AS ABOVE.                         47440003
*                 APAR OZ10530 - REWORKED ESTAE/RETRY ROUTINES TO       47470003
*                 ADHERE TO SPECIFIED REGISTER CONVENTIONS              47510003
*                 APAR OZ11342 - ADDED VALIDITY CHECKING OF S9GREGNO    47550003
*                 TO DEFEND AGAINST THE ''MALICIOUS'' USER              47560003
*                 APAR OZ11359 - ADDED FUNCTION TO CLEANUP ROUTINE      47590003
*                 WHICH FREEMAINS SP255 STG. IT ALSO WILL ZERO          47630003
*                 TCBTRN FOR ALL TCB'S IN TMP/TEST'S FAMILY.            47670003
*                 APAR OZ17744 - CHANGES TO PREVENT FIRST LENGTH FIELD  47680003
*                 OF FREEMAIN LIST TO BE OVERLAID BY ADDRESS OF THE   * 47710003
*                 126 TH SVB OR SVQ.                                    47720003
*********************************************************************** 47750003
         EJECT                                                          47790003
*********************************************************************** 47800003
*                                                                     * 47830003
*        GENERAL PURPOSE REGISTER EQUATES.                            * 47870003
*                                                                     * 47910003
*********************************************************************** 47920003
         SPACE 2                                                        47950003
R0       EQU   0                                                        47990003
R1       EQU   1                                                        48030003
R2       EQU   2                                                        48040003
R3       EQU   3                                                        48070003
R4       EQU   4                                                        48110003
R5       EQU   5                                                        48150003
R6       EQU   6                                                        48160003
R7       EQU   7                                                        48190003
R8       EQU   8                                                        48230003
R9       EQU   9                                                        48270003
R10      EQU   10                                                       48280003
R11      EQU   11                                                       48310003
R12      EQU   12                                                       48350003
R13      EQU   13                                                       48390003
R14      EQU   14                                                       48400003
R15      EQU   15                                                       48430003
N63      EQU   63          DECIMAL CONSTANT                   @ZA05687  48470003
ONEK     EQU   1000        DECIMAL CONSTANT FOR GETMAIN      @ZA06226   48510003
SVQLEN   EQU   12          LENGTH OF IKJEGSVQ CONT BLK       @ZA06226   48520003
SVBLEN   EQU   36          LENGTH OF IKJEGSVB CONT BLK       @ZA06226   48550003
N500     EQU   500         INDEX VALUE                       @ZA06226   48590003
N4       EQU   4           OFFSET VALUE                      @ZA06226   48630003
N0       EQU   0           OFFSET VALUE                      @ZA06226   48640003
         EJECT                                                          48670003
         BALR  R12,R0         ESTABLISH ADDRESSABILITY FOR THIS         48710003
         BCTR  R12,R0         BASE AND ENTRY POINT MUST      @ZA10530   48750003
         BCTR  R12,R0         COINCIDE FOR ESTAE/RETRY RTNS  @ZA10530   48760003
         USING IGC0009G,R12   SVC ROUTINE                    @ZA10530   48790003
         SPACE 2                                                        48830003
         USING TCB,R4         ESTABLISH ADDRESSABILITY TO TCB.          48870003
         USING RBSECT,R5      ESTABLISH ADDRESSABILITY TO SVRB.         48880003
         USING PSA,R0         ESTABLISH ADDRESSABILITY TO PSA           48910003
         SPACE                                                          48950003
*********************************************************************** 48990003
*        ISSUE A GETMAIN FOR LATER USE AS A REGISTER SAVE AREA          49000003
*********************************************************************** 49030003
         SPACE                                                          49070003
         LR    R9,R14         SAVE REGISTER 14 FOR RETURN               49110003
         LA    R0,WRKLEN      R0= THE  LENGTH FOR THE GETMAIN           49120003
         L     R7,PSAAOLD     R7= ADDR OF THE ASCB                      49150003
         LR    R8,R1          PRESERVE REG 1                            49190003
         GETMAIN RU,LV=(0),BRANCH=YES  ISSUE GETMAIN REGISTER SAVEAREA  49230003
         LR    R3,R1          R3= ADDR'ABILITY TO WORKAREA              49240003
         USING S9GWORKA,R3    ESTABLISH ADDR'ABILITY TO WORKAREA        49270003
         XC    WRKSTART(WRKLEN),WRKSTART  CLEAR WORKAREA                49310003
         ST    R9,WRKREGRT    SAVE R14 ADDRESS                          49350003
         MVC   S9GSPL(S9GSPLEN),S9GSPLST INIT PARMS FOR ESTAE  @ZA10530 49360003
         SPACE                                                          49390003
*********************************************************************** 49430003
*        ISSUE AN ESTAE FOR ABEND RECOVERY                              49470003
*********************************************************************** 49480003
         SPACE                                                          49510003
         ESTAE S9GESTAE,CT,PARAM=S9GSPL,XCTL=NO,BRANCH=YES,            *49550003
               SVEAREA=WRKREGSV,MF=(E,WRKESTAE)                         49590003
         LTR   R15,R15        WAS THE ESTAE OK..                        49600003
         BNZ   ESTAFAIL       NO IT FAILED....                          49630003
         LR    R1,R8          SAVE PARM R1.                             49670003
         OI    TCBTSFLG,TCBATT  DEFER ALLN WHILE THE SVC IS IN CONTROL. 49710003
         SPACE 2                                                        49720003
*********************************************************************** 49750003
*                                                                     * 49790003
*        CHECK THE TEST FLAG TO SEE IF THIS TASK IS UNDER TEST.       * 49830003
*                                                                     * 49840003
*********************************************************************** 49870003
         SPACE                                                          49910003
         SPACE                                                          49950003
         ST    R4,WRKSVTCB    SAVE THE ADDR OF CALLERS TCB              49960003
         TM    TCBABF,TCBTCP  DETERMINE IF THIS TASK UNDER TEST.        49990003
         BZ    TSTSVC01       IF NOT, EXECUTE A TEST SERVICE.           50030003
*                             IF SO, PROCESS BREAKPOINT.                50070003
         SPACE 2                                                        50080003
*********************************************************************** 50110003
*                                                                     * 50150003
*        THIS SECTION, DOWN TO THE LABEL 'TSTSVC01', IS THE LOGIC     * 50190003
*        FOR THE SVC ACTING AS A BREAKPOINT SVC.                      * 50200003
*                                                                     * 50230003
*        TCBTRN FIELD OF TCB CONTAINS ADDRESS OF TCOMTAB.             * 50270003
*                                                                     * 50310003
*       FIRST WE CHECK THE VALIDITY OF THE CALLER.                    * 50320003
*                                                                     * 50350003
*********************************************************************** 50390003
         SPACE 2                                                        50430003
         SPACE                                                          50440003
         L     R13,HIGHBYTE   MASK TO CLEAR HIGH ORDER BYTE.            50470003
         L     R7,TCBTRN      ADDRESS OF TCOMTAB.                       50510003
         BAL   R11,KEYCK      VALIDITY CHECK STORAGE KEYS.              50550003
         L     R7,ECBTST-TCOMTAB(,R7) ADDRESS OF STORAGE BLOCK          50560003
*                             TO BE CHECKED.                            50590003
         BAL   R11,KEYCK      VALIDITY CHECK STORAGE KEYS.              50630003
         L     R9,TCBTRN      BASE FOR TCOMTAB.                         50670003
         USING TCOMTAB,R9     ESTABLISH ADDRESSABILITY TO TCOMTAB.      50680003
         SPACE                                                          50710003
         BAL   R11,CHKPPRB    CHECK THE VALIDITY OF THE CALLERS RB.     50750003
         SPACE                                                          50790003
         L     R11,RBLINK      R11=PRB ADDR,PP IN WHICH BREAK OCCURRED. 50800003
         L     R8,RBOPSW+X4-RBSECT(R11) R8=RESUME ADDR OF PP.           50830003
         NR    R8,R13         CLEAR HIGH BYTE.                          50870003
         BCTR  R8,X0          R8=RESUME ADDR-2                          50910003
         BCTR  R8,X0          *                                         50920003
         LA    R10,RETURN1    R14 ADDRESS IN R10.                       50950003
QPSEUDO  EQU   *              Q. IS IT A PSEUDO BREAKPOINT              50990003
         LA    R1,TSTSVC      NORMAL PSEUDO BREAK CHECK.                51030003
         CR    R1,R8          Q. IS IT A MATCH.                         51040003
         BE    PSEUDO         YES IT IS.                                51070003
         LA    R1,PPEXIT      BR RETURN PSEUDO BREAKPOINT.              51110003
         CR    R1,R8          Q. IS IT A MATCH.                         51150003
         BE    TSTPOST        YES IT IS.                                51160003
         TM    TSTFLGS3,TSTGOSW   Q.IS THIS A SPECIAL BREAKPT.          51190003
         BO    TSTPOST        YES.  POST 'TEST'.                        51230003
         L     R0,BREAKTAB    HEAD OF THE BREAK ELEMENT QUEUE.          51270003
         SPACE 2                                                        51280003
BRKSRCH  EQU   *              BREAK ELEMENT SEARCH.                     51310003
         LTR   R7,R0          MOVE AND TEST FOR LAST.                   51350003
         USING BRKELEM,R7     BREAK ELEMENT ADDRESSABILITY.             51390003
         BCR   Z,R10          NO MORE. GO TO RETURN1.                   51400003
         LA    R6,BRKINST+X6  IF IC MATCHES THIS REPOINT IC & RTRN.     51430003
         CLR   R6,R8          Q. IS IT A MATCH.                         51470003
         BE    BRKRTURN       YES IT IS.  BRANCH.                       51510003
         C     R8,BRKADDR     IF IC MATCHES,A BREAKPT HAS BEEN HIT.     51520003
         L     R0,BRKLINK     GET THE NEXT, MAYBE.                      51550003
         BNE   BRKSRCH        NO MATCH. CHECK NEXT.                     51590003
         SPACE 2                                                        51630003
COUNT    EQU   *              CHECK THE BREAK COUNT.                    51640003
         LH    R8,BRKCOUNT    Q. IS ACCUMULATOR ZERO.                   51670003
         LTR   R8,R8          *                                         51710003
         ST    R11,BRKRB       PRB(IRB) ADDRESS TO BREAK ELEMENT.       51750003
         BNZ   DECREM         NO.DECREMENT AND ALLOW CONTINUATION       51760003
         MVC   BRKCOUNT(X2),BRKCOUNT+X2 YES,RESET ACCUMULATOR.          51790003
         B     TSTPOST        AND POST TEST,WAIT.                       51830003
         SPACE 2                                                        51870003
DECREM   EQU   *                                                        51880003
         BCTR  R8,X0          MINUS ONE.                                51910003
         STH   R8,BRKCOUNT    CONTENTS BACK TO ACCUMULATOR.             51950003
         SPACE 2                                                        51990003
*********************************************************************** 52000003
*                                                                     * 52030003
*        THIS SECTION CAUSES THE EXECUTION OF THE PROBLEM PROGRAM     * 52070003
*        TO RESUME BY POINTING THE RESUME PSW AT THE OVERLAID IN-     * 52110003
*        STRUCTION IN THE BREAK ELEMENT.IF THE INSTRUCTION IS BAL     * 52120003
*        OR BALR THE LINK REGISTER CONTENTS ARE SET IN THE SVRB       * 52150003
*        SAVE AREA.                                                   * 52190003
*                                                                     * 52230003
*********************************************************************** 52240003
         SPACE 2                                                        52270003
         LA    R0,BRKINST     SAVED INSTRUCTION ADDRESS                 52310003
         TM    BRKFLGS,BALSW  Q.WAS ORIGINAL INSTR. BAL OR BALR.        52350003
         BZ    SETIC          SET IC IN RESUME PSW AND RETURN TO PP     52360003
         SPACE 2                                                        52390003
BALBALR  EQU   *              SPECIAL CODE FOR BAL AND BALR             52430003
         SR    R0,R0          R0=ZERO                                   52470003
         TM    BRKINST,XC0    Q.DOES INSTRUCTION LENGTH EQUAL TWO.      52480003
         BZ    BALR           A.YES. HAS TO BE BALR.                    52510003
         SPACE 2                                                        52550003
BAL      EQU   *              A.NO. HAS TO BE BAL.                      52590003
         L     R0,BRKINST     R0=THE BREAK INSTRUCTION                  52600003
         LR    R1,R0          R1=THE BREAK INSTRUCTION                  52630003
         N     R0,DISPMASK    R0=DISPLACEMENT                           52670003
         N     R1,BASEMASK    R1=BASE REGISTER                          52710003
         SRL   R1,N10         BASE REGISTER NUMBER X 4                  52720003
         BZ    BALR           REG 0 IS IGNORED AS A BASE REG.           52750003
         AL    R0,RBGRSAVE(R1)  ADD BASE REGISTER ADDR. TO DISPL.       52790003
         SPACE 2                                                        52830003
BALR     EQU   *              *                                         52840003
         L     R1,BRKINST     R1=ACTUAL BREAK INSTRUCTION               52870003
         N     R1,INDXMASK    R1=INDEX REGISTER OF BREAK INSTR.         52910003
         SRL   R1,N14         (INDEX REG X 4)                           52950003
         BZ    LINKREG        REG 0 IS IGNORED AS AN INDEX REG          52960003
         AL    R0,RBGRSAVE(R1) ADD INDEX REG TO TOTAL.                  52990003
         SPACE 2                                                        53030003
LINKREG  EQU   *              SETUP THE LINK REGISTER.                  53070003
         NR    R0,R13         CLEAR THE HIGH BYTE.                      53080003
         LA    R8,X2          BALR INSTRUCTION LENGTH.                  53110003
         TM    BRKINST,XC0    Q.IS THIS A BALR                          53150003
         BZ    LINKBALR       YES, THIS IS A BALR                       53190003
         SPACE 2                                                        53200003
LINKBAL  EQU   *              *                                         53230003
         AR    R8,R8          BAL INSTRUCTION LENGTH.                   53270003
         L     R11,RBLINK     R11= ADDR OF P. P. RB            @ZA06203 53310003
         LA    R6,RBSECT-RBPREFIX LENGTH OF RB PREFIX.                  53320003
         SR    R11,R6          POINT TO PREFIX.                         53350003
         MVI   RBINLNTH-RBPREFIX(R11),X04 SET INSTRUCTION LENGTH TO 4.  53390003
         AR    R11,R6          POINT TO STANDARD SECTION.               53430003
         SPACE 2                                                        53440003
LINKBALR EQU   *              *                                         53470003
         MVC   RBOPSW+X5-RBSECT(X3,R11),BRKADDR+X1 APPEND TO ILC/CC/    53510003
*                             PROGMASK                                  53550003
         AL    R8,RBOPSW+X4-RBSECT(R11) VALUE FOR THE LINK REGISTER.    53560003
         L     R6,BRKINST     ACTUAL BREAK INSTRUCTIONN                 53590003
         N     R6,LINKMASK    LINK REGISTER NUMBER                      53630003
         ICM   R8,HIBYTE,X80  SET FLAG FOR BAL IN LINK REG              53670003
*                                                             @ZA02953  53680003
         SRL   R6,N18         (LINK REG NUMBER X 4)                     53710003
         ST    R8,RBGRSAVE(R6) STORE LINK REG CONTENTS IN SAVEAREA.     53750003
         TM    BRKINST,XC0    IS THIS A BALR Q.Q.Q.                     53790003
         BNZ   SETIC          NO.                                       53800003
         ICM   R8,HIBYTE,X40  SET FLAG IN LINK REG FOR BALR  @ZA02953   53830003
         ST    R8,RBGRSAVE(R6) STORE LINK REG                @ZA02953   53870003
         TM    BRKINST+X1,X0F IS IT A BALR Q.Q.Q.                       53910003
         BNZ   SETIC          NO.SET THE IC                             53920003
         LR    R0,R8          SETIC WITH LINK ADDRESS.                  53950003
         SPACE 2                                                        53990003
SETIC    EQU   *              SET IC IN RESUME PSW                      54030003
         LR    R1,R0          RESUME ADDRESS.                           54040003
         LA    R1,X0(,R1)     SET HIGH ORDER BYTE TO ZERO.              54070003
         ST    R1,RBOPSW-RBSECT+X4(,R11) RESET PSW IN RB.               54110003
         BR    R10            GO TO RETURN1                             54150003
         SPACE 2                                                        54160003
BRKRTURN EQU   *                                                        54190003
         SH    R8,BACKUP2     R8=BREAK ELEMENT POINTER.                 54230003
         TM    BRKINST-BRKELEM(R8),XC0  TEST FOR BREAK INSTR LENGTH.    54270003
         LA    R6,X6          INSTRUCTION LENGTH OF SIX.                54280003
         BO    OUT            YES IT'S SIX.                             54310003
         LA    R6,X2          INSTRUCTION LENGTH OF TWO.                54350003
         BZ    OUT            YES IT'S TWO                              54390003
         AR    R6,R6          INSTRUCTION LENGTH OF FOUR.               54410003
*                             IT'S FOUR.                                54430003
         SPACE 2                                                        54470003
OUT      EQU   *                                                        54510003
         L     R0,BRKADDR-BRKELEM(R8)  ADDR OF ORIG BRKPOINT.           54520003
         AR    R0,R6          PLUS CLOBBERED INSTR.LENGTH.              54550003
         NR    R0,R13         CLEAR HIGH BYTE.                          54590003
         B     SETIC          GO BACK TO PROBLEM PROGRAM.               54630003
         SPACE 2                                                        54640003
*********************************************************************** 54670003
*                                                                     * 54710003
*        RESTORE THE WAIT COUNT FIELD FOR A PSEUDO BREAKPOINT.        * 54750003
*                                                                     * 54760003
*********************************************************************** 54790003
         SPACE 2                                                        54830003
PSEUDO   EQU   *              IT'S A PSEUDO BREAK.                      54870003
         MVC   RBWCF-RBSECT(X1,R11),TSTGOWCF  DITTO.                    54880003
         TM    TSTFLGS3,TSTSTAI  IS THIS A STAI RETRY.                  54910003
         BZ    TSTPOST        NO.                                       54950003
         OI    WRKFLGS1,WRKPSEUD  INDICATE NO ENQ WANTED    @ZA07137    54990003
         LM    R0,R1,RBGRSAVE GET R0 AND R1 PASSED.                     55000003
         LTR   R0,R0          WAS SDWA PASSED ? Q.Q.Q.                  55030003
         BNZ   PSEUDO1        NO. SKIP FREEMAIN.                        55070003
         STM   R4,R2,WRKREGSV SAVE THE REGISTERS ACROSS FREE            55110003
         L     R0,SDWAIDNT-SDWA(,R1)  GET SPID + LEN OF SDWA  @ZA11325  55120003
         TM    SDWASPID-SDWA(R1),XFF  CHECK SUBPOOL OF SDWA   @ZA11325  55150003
         BNZ   FREESDWA       NOT ZERO USE CORRECT VALUE      @ZA11325  55190003
         O     R0,FOLDZERO    SPID = 0 FOLD TO 250            @ZA11325  55230003
FREESDWA EQU   *                                                        55240003
         L     R7,PSAAOLD     R7= ADDR OF THE ASCB.                     55270003
         FREEMAIN  R,LV=(0),A=(1),BRANCH=YES FREE S.D.W.A.              55310003
         LM    R4,R2,WRKREGSV RESTORE THE REGISTERS                     55350003
         SPACE 2                                                        55360003
PSEUDO1  EQU   *                                                        55390003
         L     R1,REGSAVE2    REGSAVE2 POINTER.                         55430003
         MVC   RBGRSAVE(N64),X0(R1)    RESTORE THE ABENDED REGS.        55470003
         SPACE 2                                                        55480003
TSTPOST  EQU   *                                                        55510003
         L     R1,RBOPSW+X4-RBSECT(R11)  DECREMENT THE IC BY TWO.       55550003
         BCTR  R1,X0          *                                         55590003
         BCTR  R1,X0          *                                         55600003
         ST    R1,RBOPSW+X4-RBSECT(R11)  CHANGE THE IC.                 55630003
GO       EQU   *              POST/WAIT                                 55670003
         TM    TCBTRN,TCBTCP  HAS THE TEST BIT BEEN TURNED OFF.         55710003
         BCR   Z,R10          YES RETURN                                55720003
         NR    R4,R13         CLEAR HIGH BYTE OF CALLERS TCB.           55750003
         NR    R5,R13         CLEAR HIGH BYTE.                          55790003
         LA    R6,ECBPP       R6=PP ECB ADDR.                           55830003
         SPACE                                                          55840003
*********************************************************************** 55870003
*        DO THE FOLLOWING;                                              55910003
*        1) FREE THE LOCAL LOCK, 2) ENQUE ON THE TEST ECB 'IKJTMPNM'    55950003
*           IS QNAME,USERID IS RNAME.                                   55960003
*        3) ENABLE FOR ATTN'S, 4)WAIT ON MNL.                           55990003
*********************************************************************** 56030003
         SPACE                                                          56070003
S9GLOCKA EQU   *                                                        56080003
         ST    R11,R11SAVE    SAVE R11 AROUND BAL              @ZA00889 56110003
         BAL   R11,LOCKRELE   RELEASE THE LOCAL LOCK                    56150003
         L     R11,R11SAVE    RESTORE R11                      @ZA00889 56190003
S9GLOCKB EQU   *                                                        56200003
         NR    R5,R13         CLEAR HIGH BYTE OF MY SVRB ADDR.          56230003
         TM    TSTFLGS2,TSTQUAL  IS QUALIFICATION IN PROCESS            56270003
         BO    NOENQ          DO NOT ENQ ON THE ELEMENT                 56310003
         XC    WRKENQWK(L'WRKENQWK),WRKENQWK ZERO FLAG SECTION          56320003
         MVC   WRKENQ(L'SVCNQ),SVCNQ MOVE IN THE ENQ WORD               56350003
         LA    R2,WRKENQ      R2= ADDR OF THE ENQ ELEMENT               56390003
         L     R6,CVTPTR      GET ADDR OF CVT           @ZA07137        56430003
         L     R6,CVTTCBP-CVT(R6) GET ADDR OF TCB WORDS @ZA07137        56440003
         L     R6,X0(R6)      GET ADDR OF CURRENT TCB   @ZA07137        56470003
         L     R6,TCBJSCB-TCB(R6) GET ADDR OF JSCB      @ZA07137        56510003
         L     R6,JSCBPSCB-IEZJSCB(R6)   PSCB ADDR IN R6@ZA07137        56550003
         USING PSCB,R6        SET ADDRESSABILITY TO PSCB@ZA07137        56560003
         MVC   WRKNQRNM(7),PSCBUSER GET USID FOR RNAME  @ZA07137        56590003
         MVI   WRKNQRNM+7,C' ' CLEAR LAST RNAME BYTE    @ZA07137        56630003
         DROP  R6             DONE WITH PSCB            @ZA07137        56670003
         L     R6,TPLPTR      GET TPL ADDRESS           @ZA07137        56680003
         L     R6,TPLECT-TPL(R6) GET ECT ADDR FROM TPL  @ZA07137        56710003
         TM    ECTSWS2-ECT(R6),ECTTABND   Q - NEED ENQ  @ZA07137        56750003
         BNO   S9GDOENQ                  YES - GOTO ENQ @ZA07137        56790003
         TM    WRKFLGS1,WRKPSEUD       SEE IF PSEUDO BP @ZA07137        56800003
         BO    NOENQ                   YES, SKIP ENQ    @ZA07137        56830003
S9GDOENQ LA    R6,WRKNQRNM    POINT TO ENQ'S RNAME      @ZA07137        56870003
         MVC   WRKENQWK(LISTENQE),LISTENQF  CLEAR THE ENQ ELEMENT       56910003
         ST    R5,WRKECB      PLACE MY SVRB ADDR IN ECB        @ZA03232 56920003
         ENQ   ((2),(6),E,8),ECB=WRKECB,MF=(E,WRKENQWK)  ENQ ON ECBTST  56950003
         NI    TCBTSFLG,XFF-TCBATT  DO NOT DEFER INTERRUPTS             56990003
         LTR   R15,R15        IS THE RETURN CODE ZERO          @YM07115 57030003
         BZ    NOENQ          YES CONTINUE                     @YM07115 57040003
         SR    R1,R1          CLEAR R1                         @YM07115 57070003
         IC    R1,X3(R15)     OBTAIN THE RETURN CODE           @YM07115 57110003
         LA    R2,X4          R2= X4 FOR COMPARE               @YM07115 57150003
         CR    R1,R2          WAS THE RETURN CODE A 4          @YM07115 57160003
         BNE   NOENQ          NO THEREFORE CONTINUE            @YM07115 57190003
         LA    R1,WRKECB      R1= ADDR OF THE ECB              @YM07115 57230003
         WAIT  ECB=(1)        WAIT ON THE ECB                  @YM07115 57270003
NOENQ    DS    0H             CONTINUE BY POSTING MNL                   57280003
         TM    WRKFLGS1,WRKPSEUD  WAS ECT BIT FOR ME@ZA07137            57310003
         BZ    NORESET            NO-LEAVE IT ALONE     @ZA07137        57350003
         L     R6,TPLPTR      GET TPL ADDRESS                @ZA07137   57390003
         L     R6,TPLECT-TPL(R6)  GET ECT ADDR FROM TPL      @ZA07137   57400003
         NI    ECTSWS2-ECT(R6),XFF-ECTTABND    RESET NO ENQ @ZA07137    57430003
NORESET  EQU   *                                            @ZA07137    57470003
         NI    TCBTSFLG,XFF-TCBATT  DO NOT DEFER INTERRUPTS             57510003
         NR    R4,R13         CLEAR HIGH BYTE OF CALLERS TCB.           57520003
         ST    R4,PPTCB       PPTCB=THIS TCB.                           57550003
         NR    R5,R13         CLEAR HIGH BYTE.                          57590003
         LA    R6,ECBPP       R6=PP ECB ADDR.                           57630003
         MVC   WRKSVRBS(3),ECBPP+1 SAVE PRIOR SVRB POINTER     @ZA07138 57640003
*                                                              @ZA09259 57670003
*                                                              @ZA10462 57710003
         ST    R5,X0(R6)      PUT SVRB ADDR INTO ECBPP.                 57750003
         NI    TSTFLGS2,XFF-TSTQUAL TURN OFF QUAL IN PROCESS            57760003
         L     R1,ECBTST      TEST ECB ADDRESS.                         57790003
         LA    R1,X0(,R1)     ZERO HIGH ORDER BYTE                      57830003
*        OI    TSTFLGS2,TOFFDEF  THIS FLAG IS USED TO TELL     @YM07115 57870003
*                             DO NOT SET FLAG PER APAR         @ZM00874 57880003
         POST  (1)            POST TEST ECB COMPLETE.                   57910003
         C     R5,X0(R6)      HAVE WE BEEN POSTED                       57950003
         BNE   NOWAIT         DONT GO INTO WAIT BYTE CLEARED            57990003
         WAIT  ECB=(6)        WAIT ON PP ECB.                           58000003
         SPACE 2                                                        58030003
NOWAIT   EQU   *                                                        58070003
         NI    TSTFLGS2,XFF-TOFFDEF TURN OFF SYNCH FLAG        @YM07115 58110003
         OI    TCBTSFLG,TCBATT  DEFER ATTNS.                            58120003
         STM   R4,R2,WRKREGSV SAVE THE REGS ACCROSS THE LOCK            58150003
S9GLOCK2 SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,         *58190003
               IGC0009G(S9GLOCK2))  OBTAIN THE LOCAL LOCK               58230003
         LM    R4,R2,WRKREGSV RESTORE THE REGISTERS.                    58240003
         MVC   ECBPP+1(3),WRKSVRBS RESTORE OLD 97 RBPTR        @ZA07138 58270003
*                                                              @ZA09259 58310003
*                                                              @ZA10462 58350003
         L     R1,RBOPSW-RBSECT+X4(,R11) GET SECOND WORD OF PSW         58360003
         NR    R1,R13         CLEAR HIGH BYTE.                          58390003
         SH    R1,BACKUP1     BACKUP TO BREAK ELEMENT.                  58430003
         L     R0,BREAKTAB    GET THE FIRST ELEMENT,IF ONE.             58470003
         SPACE 2                                                        58480003
BRKSRCH1 EQU   *              CHECK IF IC POINTS TO BREAK INSTRUCTION.  58510003
*                             IF SO,CHECK AND SEE IF BRKINST IS         58550003
*                             A BAL OR BALR.                            58590003
*                             IF EITHER,TREAT IT SPECIAL.               58600003
*                             IF NOT, GO TO RETRUN1.                    58630003
         LTR   R7,R0          MOVE AND TEST FOR LAST.                   58670003
         BCR   Z,R10          IT'S THE LAST. GO TO RETURN               58710003
         CR    R1,R7          Q.DOES THE IC - 4 = A BREAK ELEMENT.      58720003
         L     R0,BRKLINK     GET THE NEXT ELEMENT ,IF ONE.             58750003
         BNE   BRKSRCH1       NO. LOOP.                                 58790003
         SPACE 2                                                        58830003
FOUND1   EQU   *              GOT A MATCH.                              58840003
         TM    BRKFLGS,BALSW  IS THIS A BAL OR BALR Q.Q.                58870003
         BO    BALBALR        YES. IT IS ONE OF THESE.                  58910003
*                             GO TO SPECIAL PROCESSING OF BAL/BALR.     58950003
         SPACE 1                                                        58960003
*********************************************************************** 58990003
*        RETURN TO THE CALLER; FREE THE LOCK AND RELEASE THE ENQUE      59030003
*********************************************************************** 59070003
         SPACE 1                                                        59080003
RETURN1  EQU   *              *                                         59110003
         BAL   R11,LOCKRELE   RELEASE THE LOCAL LOCK                    59150003
         SPACE                                                          59190003
************************************************************** @YM00583 59200003
*        THE FOLLOWING BRANCH IS TO SEE IF RUN WAS THE LAST    @YM00583 59230003
*        COMMAND ENTERED. IF SO A DIFFERNET EXIT MUST BE TAKEN @YM00583 59270003
************************************************************** @YM00583 59310003
         SPACE                                                          59320003
         TM    TSTFLGS1,RUNSW WAS RUN ENTERED                  @YM00583 59350003
         BO    RUNEXIT        YES THEREFORE USE ALTERNATE EXIT @YM00583 59390003
         SPACE                                                          59430003
         LA    R6,WRKENQ      R6= ADDR OF THE ENQ ELEMENT               59440003
         LA    R2,WRKNQRNM   R2= ADDR OF RNAME FOR DEQ   @ZA07137       59470003
         MVC   WRKENQWK(LISTDEQE),LISTDEQF  CLEAR THE DEQ ELEMENT       59510003
         DEQ   ((6),(2),8),RET=HAVE,MF=(E,WRKENQWK)  DEQ ON ECBTST WORD 59550003
         LA    R0,WRKLEN      R0=LENGTH OF AREA TO FREED                59560003
         L     R2,WRKREGRT    R2= R14 ADDRESS                           59590003
         FREEMAIN R,LV=(0),A=(3) ISSUE FREEMAIN OF WORKAREA             59630003
         ESTAE 0              CLEAR THE ESTAE                           59670003
         NI    TSTFLGS4,XFF-TSTRERTN  TURN OFF ABEND SW                 59680003
         NI    TCBTSFLG,XFF-TCBATT  DO NOT DEFER INTERRUPTS             59710003
         LR    R14,R2         R14= ADDR OF RETURN                       59750003
         L     R15,RBGRS15    RESTORE R15 TO ORIGINAL VALUE             59790003
         LM    R0,R13,RBGRSAVE    RESTORE ALL REGS.                     59800003
         BR    R14            RETURN.                                   59830003
         EJECT                                                          59870003
************************************************************** @YM00583 59910003
*        THE FOLLOWING CODE IS ONLY FOR THE CONDITION WHEN RUN @YM00583 59920003
*        WAS ENTERED AS A SUBCOMMAND. IKJEGMNL IS WAITING ON US@YM00583 59950003
*        TO COMPLETE OUR USE OF TCOMTAB, NOW THAT WE ARE DONE  @YM00583 59990003
*        WITH TCOMTAB WE POST IKJEGMNL SO IKJEGMNL WILL FREE IT@YM00583 60030003
*        AND RETURN TO TMP. THE ESTAE IS REMOVED BEFORE THE POS@YM00583 60040003
*        AND THEREFORE AN ALTERNATE EXIT IS USED.              @YM00583 60070003
************************************************************** @YM00583 60110003
         SPACE                                                          60150003
RUNEXIT  EQU   *              RUN COMMAND EXIT                 @YM00583 60160003
         ESTAE 0              CLEAR THE ESTAE                  @YM00583 60190003
         NI    TSTFLGS4,XFF-TSTRERTN  TURN OFF ABEND SW        @YM00583 60230003
         L     R1,ECBTST      TEST ECB ADDRESS.                @YM00583 60270003
         POST  (1)            POST TEST ECB COMPLETE.          @YM00583 60280003
         SPACE                                                          60310003
         LA    R6,WRKENQ      R6= ADDR OF THE ENQ ELEMENT      @YM00583 60350003
        LA    R2,WRKNQRNM    R2= ADDR OF RNAME FOR DEQ      @ZA07137    60390003
         MVC   WRKENQWK(LISTDEQE),LISTDEQF  CLEAR THE DEQ ELEME@YM00583 60400003
         DEQ   ((6),(2),8),RET=HAVE,MF=(E,WRKENQWK)  DEQ ON    @YM00583 60430003
         LA    R0,WRKLEN      R0=LENGTH OF AREA TO FREED       @YM00583 60470003
         L     R2,WRKREGRT    R2= RETURN ADDRESS               @YM00583 60510003
         FREEMAIN R,LV=(0),A=(3) ISSUE FREEMAIN OF WORKAREA    @YM00583 60520003
         NI    TCBTSFLG,XFF-TCBATT  DO NOT DEFER INTERRUPTS    @YM0058  60550003
         LR    R14,R2         R14= ADDR OF RETURN              @YM00583 60590003
         L     R15,RBGRS15    RESTORE R15 TO ORIGINAL VALUE    @YM00583 60630003
         LM    R0,R13,RBGRSAVE    RESTORE ALL REGS.            @YM00583 60640003
         BR    R14            RETURN.                          @YM00583 60670003
         EJECT                                                          60710003
KEYCK    EQU   *                                                        60750003
         LR    R1,R7          R1= ADDR TO BE CHECKED.                   60760003
         L     R8,FLCCVT      R8= ADDRESS OF THE CVT                    60790003
         USING CVT,R8         ADDR'ABILITY TO THE CVT                   60830003
         L     R15,CVT0VL00   ADDRESS OF RESIDENT VALIDITY CHECK        60870003
*                             ROUTINE.                                  60880003
         DROP  R8             RELEASE ADDR'ABILITY TO CVT               60910003
         SR    R2,R2          R2= ZERO NO RANGE INDICATOR..             60950003
         BALR  R14,R15        BRANCH TO VALIDITY CHECK ROUTINE.         60990003
         BNZ   RETURN1        ADDRESS NOT WRITEABLE, RETURN.            61000003
         BR    R11            RETURN ON LINK REGISTER.                  61030003
         EJECT                                                          61070003
*********************************************************************** 61110003
*        THE SVC MUST VARIFY THAT THE PROGRAM IT IS SERVICING IS NOT  * 61120003
*        PRIVILDGED. (P.P. KEY NOT SUPERVISOR STATE, AND NOT AN SVRB) * 61150003
*********************************************************************** 61190003
         SPACE                                                          61230003
CHKPPRB  EQU   *                                                        61240003
         LR    R7,R5          SAVE THE ADDR OF MY SVRB.                 61270003
         L     R5,RBLINK      OBTAIN THE ADDR OF CALLERS RB.            61310003
         TM    RBSTAB1,RBFTP-RBFTIRB  WHAT KIND OF RB IS IT(PRB OR IRB) 61350003
         BNZ   PPRBFAIL       IT IS NOT A PRB OR IRB.                   61360003
         TM    RBOPSW+X1,PSWPBIT  DETERMINE IF IN PP MODE               61390003
         BZ    PPRBFAIL       NOT IN PP MODE.                           61430003
         TM    RBOPSW+X1,PSWPKEYF  IS THE PROTECT KEY ZWRO.             61470003
         BZ    PPRBFAIL       NO IT IS KEY 0-7                          61480003
         LR    R5,R7          RESTORE MY RB POINTER                     61510003
         BR    R11            ALL IS OK THEREFORE EXIT.                 61550003
         SPACE                                                          61590003
PPRBFAIL EQU   *              IF TEST IS RUNNING INDICATE ERROR         61600003
*                             ELSE JUST RETURN DOING NOTHING.           61630003
         BAL   R11,LOCKRELE   RELEASE THE LOCAL LOCK                    61670003
         LR    R5,R7          RESTORE MY RB POINTER                     61710003
         L     R15,IOVCON     R15= ADDR OF IO FOR MSG          @ZA04126 61720003
         MVC   TSTIOPRM(IOPRMLN),IOPRM  PLACE IO PARM LIST IN WORKAREA  61750003
         MVI   TSTIOPRM,MSGINDC  PLACE MSG INDICATOR IN THE LIST.       61790003
         L     R13,REGSAVE6   R13= SAVEAREA FOR IO.            @YM07131 61830003
         LA    R1,TSTIOPRM    R1= ADDR OF THE IO PARM LIST              61840003
         BALR  R14,R15        GO TO IO.                        @ZA04126 61870003
         OI    TSTFLGS4,TSTSVCAB  INDICATE TO MNL THERE WAS AN ERROR.   61910003
         L     R13,HIGHBYTE   MASK TO CLEAR HIGH ORDER BYTE.            61950003
         B     S9GLOCKB       EXIT AS ERROR WAS HANDLED.                61960003
         EJECT                                                          61990003
LOCKRELE EQU   *              RELE THE LOCAL LOCK                       62030003
         STM   R4,R2,WRKREGSV SAVE THE REGS ACROSS THE LOCK.            62070003
S9GLOCK1 SETLOCK RELEASE,TYPE=LOCAL,RELATED=(LOCAL,IGC0009G(S9GLOCK1))  62080003
         LM    R4,R2,WRKREGSV RESTORE THE REGS.                         62110003
         BR    R11            RETURN TO THE CALLER                      62150003
         EJECT                                                          62190003
MSGINDC  EQU   X'02'          MESSAGE INDICATOR.                        62200003
HIBYTE   EQU   8              MASK FOR ICM INST             @ZA02953    62230003
Z        EQU   8              ZERO CC.                                  62270003
X3       EQU   3              HEXIDECIMAL 3                             62310003
X6       EQU   6              HEXIDECIMAL 6                             62320003
N10      EQU   10             DECIMAL 10                                62350003
N14      EQU   14             FOURTEEN                                  62390003
N18      EQU   18             EIGHTEEN                                  62430003
N64      EQU   64             SIXTY FOUR                                62440003
X0F      EQU   X'0F'          HEXIDECIMAL 0F                            62470003
X04      EQU   X'04'          HEXIDECIMAL 04                            62510003
XC0      EQU   X'C0'          HEXIDECIMAL C0                            62550003
XFF      EQU   X'FF'          HEXIDECIMAL FF                            62560003
         SPACE 2                                                        62590003
         DS    0F                                                       62630003
FOLDZERO DC    AL1(250),AL3(0)   MASK FOR FOLDING SUBPOOL ID   @ZA11325 62670003
QGET     DC    AL1(250),AL3(8)   TSTSVCQ ELEMENT. SP=250 LV=8.          62680003
FB000000 DC    X'FB000000'    RESET MASK FOR TCBTRN            @ZA11359 62710003
DISPMASK DC    X'00000FFF'    DISPLACEMENT MASK.                        62750003
BASEMASK DC    X'0000F000'    BASE REGISTER MASK.                       62790003
INDXMASK DC    X'000F0000'    INDEX REGISTER MASK                       62800003
LINKMASK DC    X'00F00000'    LINK REGISTER MASK                        62830003
HIGHBYTE DC    X'00FFFFFF'    ADDRESS MASK.                             62870003
SVCNQ    DC    CL8'IKJTMPNM'  THIS IS THE SVC (97, 61) ENQ LOCK         62910003
         SPACE 3                                                        62920003
*        ISSUE THE LIST FORM OF THE ENQ..............                   62950003
         SPACE                                                          62990003
LISTENQF ENQ   (LISTENQF,LISTENQF,E,8),ECB=LISTENQF,MF=L                63030003
LISTENQE EQU   *-LISTENQF     LENGTH OF LIST FORM OF ENQ                63040003
         SPACE 3                                                        63070003
*        ISSUE THE LIST FORM OF THE DEQ..............                   63110003
         SPACE                                                          63150003
LISTDEQF DEQ   (LISTDEQF,LISTDEQF,8),RET=HAVE,MF=L                      63160003
LISTDEQE EQU   *-LISTDEQF     LENGTH OF LIST FORM OF DEQ                63190003
         SPACE 2                                                        63230003
LISTFREE FREEMAIN L,SP=255,MF=L                               @ZA06226  63270003
FREELEN  EQU    *-LISTFREE                                    @ZA06226  63280003
         SPACE 2                                                        63310003
IOPRM    IKJEGSIO  MSG,FIRST=M0004,SECOND=M0204,ID=S9G02,MF=(L)         63350003
IOPRMLN  EQU   *-IOPRM        GET THE LENGTH OF PARM LIST               63390003
         TITLE 'IGC0009G - SERVICE ROUTINE PROCESSING'                  63400003
         SPACE 20                                                       63430003
*********************************************************************** 63470003
*                                                                     * 63510003
*        SERVICE ROUTINE FUNCTION.                                    * 63520003
*                                                                     * 63550003
*********************************************************************** 63590003
         EJECT                                                          63630003
TSTSVC01 EQU   *                                                        63640003
         USING IKJEGS9G,R1    ESTABLISH ADDRESSABILITY TO INPUT         63670003
*                             PARAMETER LIST.                           63710003
         USING TCB,R4         ESTABLISH ADDRESSABILITY TO TCB.          63750003
         USING RBSECT,R5      ESTABLISH ADDRESSABILITY TO SVRB.         63760003
         EJECT                                                          63790003
*********************************************************************** 63830003
*                                                                     * 63870003
*        GIVEN THE INPUT PARAMETER OF THE TCB ADDRESS, OR THE ADDRESS * 63880003
*        OF A PRB OR AN IRB, DETERMINE THAT THE PARAMETER IS IN FACT  * 63910003
*        A VALID ADDRESS FOR THE GIVEN TASK STRUCTURE.  AT THE        * 63950003
*        CONCLUSION OF THIS PROCESSING, REGISTER 6 CONTAINS THE       * 63990003
*        ADDRESS OF THE TCB TO BE ALTERED.                            * 64000003
*                                                                     * 64030003
*********************************************************************** 64070003
         SPACE 2                                                        64110003
         SR    R2,R2          CONSTANT ZERO.                            64120003
         L     R6,TCBOTC      ADDRESS OF TMP/TEST TASK MOTHER TCB.      64150003
         DROP  R4                                                       64190003
         USING TCB,R6         ESTABLISH ADDRESSABILITY TO TCB.          64230003
S9G11030 EQU   *                                                        64240003
         C     R2,TCBLTC      DETERMINE IF A DAUGHTER TASK EXISTS       64270003
         BZ    S9G11050       IF NO DAUGHTER TASK, BRANCH TO            64310003
*                             CHECK SISTER TASK.                        64350003
         L     R6,TCBLTC      ADDRESS OF DAUGHTER TASK TCB.             64360003
         B     S9G11070       IF A DAUGHTER TASK EXISTS, BRANCH         64390003
*                             TO CHECK IF ADDRESS MATCHES ADDRESS       64430003
*                             PASSED IN INPUT PARAMETER LIST.           64470003
S9G11050 EQU   *                                                        64480003
         C     R2,TCBNTC      DETERMINE IF A SISTER TASK EXISTS.        64510003
         BZ    S9G11060       IF NO SISTER TASK, BRANCH TO GET          64550003
*                             ADDRESS OF OWNING TCB.                    64590003
         L     R6,TCBNTC      ADDRESS OF SISTER TASK TCB.               64600003
         B     S9G11070       IF A SISTER TASK EXISTS, BRANCH TO        64630003
*                             CHECK IF ADDRESS MATCHES ADDRESS          64670003
*                             PASSED IN INPUT PARAMETER LIST.           64710003
S9G11060 EQU   *                                                        64720003
         L     R6,TCBOTC      ADDRESS OF OWNING TASK WITH RESPECT       64750003
*                             TO CURRENT TCB.                           64790003
         DROP  R6                                                       64830003
         USING TCB,R4         RE-ESTABLISH ADDRESSABILITY TO            64840003
*                             ORIGINAL TCB.                             64870003
         C     R6,TCBOTC      DETERMINE IF ENTIRE TCB QUEUE UNDER       64910003
*                             THE TMP/TEST TASK HAS BEEN SEARCHED       64950003
         BNE   S9G11050       IF SEARCH NOT COMPLETE, BRANCH TO         64960003
*                             CHECK FOR SISTER TASK.                    64990003
         B     S9G12030       WHEN ENTIRE QUEUE HAS BEEN SEARCHED       65030003
*                             WITHOUT A MATCH, RETURN TO CALLER.        65070003
S9G11070 EQU   *                                                        65080003
         SR    R7,R7          ZERO IN ORDER THAT SUBROUTINE MAY         65110003
*                             DETERMINE IF AN RB ADDRESS PASSED.        65150003
         C     R6,S9GTCBPT    DETERMINE IF TCB ADDRESS MATCHES          65190003
*                             THE ADDRESS PASSED IN INPUT               65200003
*                             PARAMETER LIST.                           65230003
         BE    S9G12010       WHEN MATCH FOUND, BRANCH TO HONOR         65270003
*                             REQUEST.                                  65310003
         DROP  R4,R5                                                    65320003
         USING TCB,R6         ESTABLISH ADDRESSABILITY TO TCB           65350003
*                             BEING CHECKED.                            65390003
         USING RBSECT,R7      ESTABLISH ADDRESSABILITY TO RB            65430003
*                             QUEUE FOR TCB BEING CHECKED.              65440003
         L     R7,TCBRBP      ADDRESS OF MOST RECENT REQUEST.           65470003
         LA    R7,0(R7)       ZERO HI BYTE          @ZA00823            65510003
         LTR   R7,R7          HAS TASK COMPLETED ?  @ZA00823            65550003
         BZ    S9G11030       YES, GO CHECK NEXT TCB @ZA00823           65560003
S9G11090 EQU   *                                                        65590003
         CLM   R7,X7,S9GTCBPT+X1 DETERMINE IF RB ADDRESS                65630003
*                             MATCHES THE ADDRESS PASSED IN             65670003
*                             INPUT PARAMETER LIST.                     65680003
         BE    S9G12010       WHEN MATCH FOUND, BRANCH TO HONOR         65710003
*                             REQUEST.                                  65750003
         TM    RBSTAB2,RBTCBNXT DETERMINE IF END OF RB CHAIN.           65790003
         L     R7,RBLINK      ADDRESS OF PREVIOUS REQUEST.              65800003
         BZ    S9G11090       NOT END OF RB CHAIN, BRANCH TO            65830003
*                             CHECK NEXT REQUEST ON CHAIN.              65870003
         B     S9G11030       BRANCH TO CHECK CURRENT TCB.              65910003
         EJECT                                                          65920003
*********************************************************************** 65950003
*                                                                     * 65990003
*        WHEN TCB ADDRESS HAS BEEN VALIDATED, OBTAIN THE FLAGS        * 66030003
*        PASSED TO THE SVC WHICH DETERMINE THE FUNCTION.  BASED       * 66040003
*        UPON THE OPERATION SPECIFIED, BRANCH TO THE APPROPRIATE      * 66070003
*        PROCESSING SECTION TO MAKE THE MODIFICATIONS REQUIRED.       * 66110003
*                                                                     * 66150003
*********************************************************************** 66160003
         SPACE 2                                                        66190003
S9G12010 EQU   *                                                        66230003
         L     R1,RBGRS1-RBSECT(,R5) RELOAD PARAMETER LIST PTR          66270003
         SR    R9,R9          ZERO REGISTER BEFORE INSERT.              66280003
         ICM   R9,X3,S9GFLGS1 OBTAIN BIT SETTINGS FOR                   66310003
*                             FUNCTION TO BE PERFORMED.                 66350003
         LA    R9,X1(R9,R9)   APPEND LOW ORDER ONE BIT TO FLAGS         66390003
         SLL   R9,X14(R0)     AND SHIFT INTO POSITION FOR TEST.         66400003
         BXH   R9,R9,S9G12030 BRANCH TO SET ERROR CODE IF SVC WAS       66430003
*                             NOT INVOKED BY MACRO INSTRUCTION.         66470003
         BXLE  R9,R9,S9G13010 FLAGS = X'C000' - BRANCH TO SET           66510003
*                             TCBTCP BIT TO B'1'.                       66520003
         BXLE  R9,R9,S9G14010 FLAGS = X'A000' - BRANCH TO SET           66550003
*                             TCBTCP BIT TO B'0'.                       66590003
         BXLE  R9,R9,S9G15010 FLAGS = X'9000' - BRANCH TO ALTER         66630003
*                             TCBTRN FIELD.                             66640003
         BXLE  R9,R9,S9G16010 FLAGS = X'8800' - BRANCH TO ALTER         66670003
*                             PROGRAM RESUME ADDRESS                    66710003
         BXLE  R9,R9,S9G17010 FLAGS = X'8400' - BRANCH TO ALTER         66750003
*                             A SPECIFIC GENERAL PURPOSE REIGSTER       66760003
         BXLE  R9,R9,S9G18010 FLAGS = X'8200' - BRANCH TO ALTER         66790003
*                             ALL GENERAL PURPOSE REGISTERS.            66830003
         BXLE  R9,R9,S9G19010 FLAGS = X'8100' - BRANCH TO ALTER         66870003
*                             A SPECIFIC FLOATING POINT REGISTER.       66880003
         BXLE  R9,R9,S9G20010 FLAGS = X'8080' - BRANCH TO SET RB        66910003
*                             WAIT COUNT TO ZERO.                       66950003
         BXLE  R9,R9,S9G21010 FLAGS = X'8040' - BRANCH TO               66990003
*                             VALIDATE ADDRESS SPECIFIED.               67000003
        BXLE   R9,R9,S9G22010 FLAGS = X'8020' - BRANCH TO               67030003
*                             DEQ FOR TCB ADDR SPECIFIED  @ZA07137      67070003
        BXLE   R9,R9,S9G24010 FLAGS = X'8010' - BRANCH  TO    @ZA06226  67110003
*                             FREE SP 255 CORE FOR IGC0006A   @ZA06226  67120003
S9G12030 EQU   *                                                        67150003
         LA    R15,X4(,R0)    SET ERROR RETURN CODE.                    67190003
         B     S9G23020       RETURN TO CALLER.                         67230003
         EJECT                                                          67240003
*********************************************************************** 67270003
*                                                                     * 67310003
*        TCB BELONGS TO A DAUGHTER OF THE TMP/TEST TASK.  INDICATE    * 67350003
*        SO BY SETTING THE TCBTCP BIT IN TCBABF TO '1'B.              * 67360003
*                                                                     * 67390003
*********************************************************************** 67430003
         SPACE 2                                                        67470003
S9G13010 EQU   *                                                        67480003
         OI    TCBABF,TCBTCP  SET TEST CP BIT TO B'1'.                  67510003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               67550003
         SPACE 5                                                        67590003
*********************************************************************** 67600003
*                                                                     * 67630003
*        THE SPECIFIED TCB IS NOLONGER REQUIRED FOR TESTING.          * 67670003
*        INDICATE THE TERMINATION OF THE TEST SESSION BY SETTING      * 67710003
*        THE TCBTCP BIT IN TCBABF TO '0'B.                            * 67720003
*                                                                     * 67750003
*********************************************************************** 67790003
         SPACE 2                                                        67830003
S9G14010 EQU   *                                                        67840003
         NI    TCBABF,X'FF'-TCBTCP SET TEST CP BIT TO B'0'.             67870003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               67910003
         SPACE 5                                                        67950003
*********************************************************************** 67960003
*                                                                     * 67990003
*        FOR TSO, THE TCBTRNB FIELD OF THE TCB IS RESERVED FOR        * 68030003
*        THE TEST COMMAND PROCESSOR.  THROUGHOUT THE TEST SESSION,    * 68070003
*        THIS FIELD IS USED TO POINT TO THE TEST COMMUNICATION        * 68080003
*        TABLE.  THIS FUNCTION WILL PLACE THE ADDRESS OF TCOMTAB      * 68110003
*        IN THE TMP/TEST TCB AND ANY DAUGHTER TCB.                    * 68150003
*        THIS FUMCTION IS ALSO USED TO ZERO THE TCBTRNB FIELD ZA26084 * 68156003
*        WHEN TEST IS GOING AWAY(NORMALLY OR OTHERWISE).IT IS ZA26084 * 68162003
*        CALLED BY TEST RUN OR END SUBCOMMANDS OR BY THE TMP  ZA26084 * 68168003
*        STAE RETRY ROUTINE (IKJEFT07) ON A TMP FAILURE.      ZA26084 * 68174003
*                                                                     * 68190003
*********************************************************************** 68200003
S9G15010 EQU   *                                                        68230003
         MVC   TCBTRNB(L'TCBTRNB),S9GVALUE+X1  MOVE TEST COMM- ZA29216  68234003
*                                TABLE ADDRESS TO TCB.         ZA29216  68238003
         SR    R9,R9           ZERO THE REGISTER               ZA26084  68242003
         ICM   R9,7,TCBTRNB    GET TCOMTAB PTR IF PRESENT      ZA26084  68246003
         LTR   R9,R9           IS TCOMTAB ADDR IN THIS TCB?    ZA26084  68250003
         BZ    S9G23010        BRANCH TO RETURN TO CALLER      ZA29216  68254003
         NI    TSTFLGS4,XFF-TSTRERTN  TURN OFF ABEND SWITCH    ZA26084  68258003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               68270003
*********************************************************************** 68430003
*                                                                     * 68440003
*        THIS FUNCTION IS USED TO MODIFY THE RESUME ADDRESS IN THE    * 68470003
*        PROBLEM PROGRAM PRB.  WHENEVER THE USER SPECIFIES OTHER      * 68510003
*        THAN THE NEXT SEQUENTIAL INSTRUCTION IN A GO, RUN, OR        * 68550003
*        CALL SUBCOMMAND, THIS FUNCTION WILL PLACE THE INDICATED      * 68560003
*        ADDRESS IN THE PRB.                                          * 68590003
*                                                                     * 68630003
*********************************************************************** 68670003
         SPACE 2                                                        68680003
S9G16010 EQU   *                                                        68710003
         BAL   R11,S9G30010   BRANCH TO ISOLATE RB ADDRESS.             68750003
S9G16020 EQU   *                                                        68790003
         MVC   RBOPSW+X4(L'S9GVALUE),S9GVALUE RE-SET RESUME             68800003
*                             ADDRESS.                                  68830003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               68870003
         EJECT                                                          68910003
*********************************************************************** 68920003
*                                                                     * 68950003
*        THIS FUNCTION IS USED TO MODIFY A SPECIFIC GENERAL           * 68990003
*        REGISTER.  THE MODIFICATION IS MADE IN THE SVRB              * 69030003
*        SAVE AREA SO THAT THE REGISTER CHANGE IS EFFECTIVE           * 69040003
*        UPON THIS SVC'S EXIT.                                        * 69070003
*                                                                     * 69110003
*********************************************************************** 69150003
         SPACE 2                                                        69160003
S9G17010 EQU   *                                                        69190003
         LH    R8,S9GREGNO    GET REGISTER NUMBER TO BE CHANGED.        69230003
         SRL   R8,4           REMOVE VALID PORTION OF S9GREGNO @ZA11342 69270003
         OR    R8,R8          CHECK FOR INVALID SPECIFICATION  @ZA11342 69280003
         BNZ   S9G12030       IF INVALID - ERROR,EXIT          @ZA11342 69310003
         LH    R8,S9GREGNO    IF VALID RELOAD REGISTER NUMBER  @ZA11342 69350003
         SLL   R8,X2(R0)      MULTIPLY REGISTER NUMBER BY 4.            69390003
         L     R9,TCBTRN      GET POINTER TO TCOMTAB           @ZA07138 69400003
*                                                              @ZA09259 69430003
*                                                              @ZA10462 69470003
         L     R7,ECBPP       GET POINTER TO SVRB              @ZA07138 69510003
*                                                              @ZA09259 69520003
*                                                              @ZA10462 69550003
         LA    R8,RBGRSAVE(R8) COMPUTE ADDRESS FOR REGISTER IN          69590003
*                             RB SAVE AREA.                             69630003
         MVC   X0(L'S9GVALUE,R8),S9GVALUE UPDATE REGISTER               69640003
*                             CONTENTS.                                 69670003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               69710003
         EJECT                                                          69750003
*********************************************************************** 69760003
*                                                                     * 69790003
*        THIS FUNCTION IS USED TO MODIFY ALL GENERAL REGISTERS        * 69830003
*        FOR THE PROBLEM PROGRAM.  THE MODIFICATION IS MADE TO THE    * 69870003
*        SVRB SAVE AREA SO THAT THE CHANGED REGISTERS ARE EFFECTIVE   * 69880003
*        WHEN THIS SVC EXITS.                                         * 69910003
*                                                                     * 69950003
*********************************************************************** 69990003
         SPACE 2                                                        70000003
S9G18010 EQU   *                                                        70030003
         L     R9,TCBTRN        GET ADDR OF TCOMTAB         @ZA05687    70070003
         OI    TSTFLGS1,S9GINTSW INDICATE INTERNAL REQUEST  @ZA05687    70110003
         BAL   R10,S9G21010     GO TEST FOR READABILITY     @ZA05687    70120003
         LA    R7,N63(R7)       GET ADDR OF END OF BUFFER   @ZA05687    70150003
         BAL   R10,READCHK      TEST END OF BUFF READABILITY@ZA05687    70190003
         SPACE 2                                                        70230003
*    IF WE HAVE GOTTEN THIS FAR THE 64 BYTE BUFFER IS NOT   @ZA05687    70240003
*    IN FETCH PROTECTED STORAGE AND WE CAN CONTINUE.        @ZA05687    70270003
*       FIRST WE HAVE TO GO BACK TO KEY 0 (SET TO 8 BY THE  @ZA05687    70310003
*       VALIDITY CHECKER)                                   @ZA05687    70350003
*         THEN GET THE LOCAL LOCK BACK TO UPDATE THE         @ZA05687   70360003
*         SPECIFIED SVRB                                     @ZA05687   70390003
          SPACE  1                                                      70430003
         BAL   R11,GETLOCK                                   @ZA05687   70470003
         NI    TSTFLGS1,XFF-S9GINTSW TURN OFF FLAG            @ZA05687  70480003
         L     R8,S9GVALUE    ADDRESS OF 64-BYTE SAVE AREA WHICH        70510003
*                             CONTAINS NEW REGISTER VALUES.             70550003
         L     R7,ECBPP       GET POINTER TO SVRB              @ZA07138 70590003
*                                                              @ZA09259 70600003
*                                                              @ZA10462 70630003
         MVC   RBGRSAVE(RBEXSAVE-RBGRSAVE),X0(R8) UPDATE ALL            70670003
*                             GENERAL REGISTERS.                        70710003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               70720003
         EJECT                                                          70750003
*********************************************************************** 70790003
*                                                                     * 70830003
*        THIS FUNCTION IS USED TO MODIFY FLOATING POINT REGISTERS     * 70840003
*        FOR THE PROBLEM PROGRAM.  SINGLE PRECISION REGISTERS ARE     * 70870003
*        DENOTED AS ODD REGISTER NUMBERS (1, 3, 5, 7) WHILE DOUBLE    * 70910003
*        PRECISION REGISTERS ARE DENOTED AS EVEN REGISTER NUMBERS     * 70950003
*        (0, 2, 4, 6).  AFTER IT IS DETERMINED WHICH KIND OF FLOAT-   * 70960003
*        ING POINT REGISTER IS TO BE MODIFIED, THE VALUE PASSED IS    * 70990003
*        PLACED IN THE APPROPRIATE LOCATION IN THE FLOATING POINT     * 71030003
*        REGISTER SAVE AREA, A PREFIX TO THE TCB.                     * 71070003
*                                                                     * 71080003
*********************************************************************** 71110003
         SPACE 2                                                        71150003
S9G19010 EQU   *                                                        71190003
         LH    R8,S9GREGNO    OBTAIN REGISTER NUMBER TO BE              71200003
*                             CHANGED. PREFORM VALIDITY CHECK  @ZA11342 71230003
         SRL   R8,4           REMOVE VALID PORTION OF S9GREGNO @ZA11342 71270003
         OR    R8,R8          CHECK FOR INVALID SPECIFICATION  @ZA11342 71310003
         BNZ   S9G12030       IF INVALID - ERROR,EXIT          @ZA11342 71320003
         LH    R8,S9GREGNO    IF VALID RELOAD REGISTER NUMBER  @ZA11342 71350003
         LA    R9,X1(,R0)     CONSTANT 1.                               71390003
         NR    R9,R8          TEST IF SINGLE OR DOUBLE PRECISION.       71430003
         BNZ   S9G19030       IF SINGLE PRECISION, BRANCH TO            71440003
*                             PROCESS.                                  71470003
         SLL   R8,X2(R0)      MULTIPLY REGISTER NUMBER BY 4.            71510003
         LA    R9,TCB-TCBFIX(,R0) DISPLACEMENT TO FLOATING POINT        71550003
*                             REGISTER SAVE AREA IN TCB.                71560003
         ST    R6,WRKTCBSA    SAVE TCB PTR                     @ZA31527 71570003
         SR    R6,R9          ADDRESS OF TCB PREFIX.                    71590003
         LA    R6,X0(R8,R6)   ADDRESS TO BE UPDATED FOR THIS            71630003
*                             REGISTER.                                 71670003
         L     R9,S9GVALUE    ADDRESS OF NEW VALUE FOR REGISTER.        71680003
         MVC   X0(L'TCBFRS0,R6),X0(R9) UPDATE REGISTER CONTENTS.        71710003
         L     R6,WRKTCBSA    RESTORE TCB PTR                  @ZA31527 71720003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               71750003
S9G19030 EQU   *                                                        71790003
         BCTR  R8,R0          MAKE REGISTER NUMBER EVEN.                71800003
         SLL   R8,X2(R0)      MULTIPLY REIGSTER NUMBER BY 4.            71830003
         LA    R9,TCB-TCBFIX(,R0) DISPLACEMENT TO FLOATING POINT        71870003
*                             REGISTER SAVE AREA IN TCB.                71910003
         ST    R6,WRKTCBSA    SAVE TCB PTR FOR LATER USE       @ZA31527 71920003
         SR    R6,R9          ADDRESS OF TCB PREFIX.                    71930003
         LA    R6,X0(R8,R6)   ADDRESS TO BE UPDATED FOR THIS            71950003
*                             REGISTER.                                 71990003
         L     R9,S9GVALUE    ADDRESS OF NEW VALUE FOR REGISTER.        72030003
         MVC   X0(L'TCBFRS0/X2,R6),X0(R9) UPDATE REGISTER CONTENT       72040003
         L     R6,WRKTCBSA    RESTORE TCB PTR                  @ZA31527 72050003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               72070003
         EJECT                                                          72110003
*********************************************************************** 72150003
*                                                                     * 72160003
*        THIS FUNCTION IS USED TO ZERO THE WAIT COUNT IN THE          * 72190003
*        SPECIFIED PRB.                                               * 72230003
*                                                                     * 72270003
*********************************************************************** 72280003
         SPACE 2                                                        72310003
S9G20010 EQU   *                                                        72350003
         BAL   R11,S9G30010   BRANCH TO ISOLATE RB ADDRESS.             72390003
S9G20020 EQU   *                                                        72400003
         MVI   RBWCF,X0       ZERO WAIT COUNT FIELD.                    72430003
         B     S9G23010       BRANCH TO RETURN TO CALLER.               72470003
         EJECT                                                          72510003
*********************************************************************** 72520003
*                                                                     * 72550003
*        THIS FUNCTION IS USED TO VALIDITY CHECK AN ADDRESS.          * 72590003
*        THE ADDRESS CHECKING FACILITY USED IS THE RESIDENT           * 72630003
*        ADDRESS VALIDITY CHECK ROUTINE POINTED TO BY THE CVT.        * 72640003
*                                                                     * 72670003
*********************************************************************** 72710003
         SPACE 2                                                        72750003
S9G21010 EQU   *                                                        72760003
         L     R7,S9GVALUE    ADDRESS TO BE VALIDITY CHECKED.           72790003
         L     R9,TCBTRN      R9= ADDR OF TCOMTAB                       72830003
         BAL   R11,LOCKRELE   DROP THE LOCAL LOCK.                      72870003
         MODESET EXTKEY=RBT234,SAVEKEY=WRKOLDKY,WORKREG=8   MODESET     72880003
         SPACE                                                          72910003
**********************************************************************  72950003
*        THE SUPPLIED ADDR FAILED IN THE VALIDITY CHECK ROUTINE, SEE    72990003
*        IF THE ADDR IS READ ONLY BY TRYING TO FETCH FROM IT. COVER THE 73000003
*        FETCH WITH AN ABEND INDICATOR AND ABEND TABLE ENTRY.           73030003
**********************************************************************  73070003
READCHK  EQU   *                                                        73110003
         SR    R8,R8          SETUP R8 AS INDICATOR            @YM04107 73120003
         DROP  R6             DROP TCB ADDRESSABILITY.                  73150003
         USING TCB,R4         ESTABLISH TCB ADDRESSABILITY              73190003
         OI    TSTFLGS1,TSTFIRST  TURN ON POSSIBLE ABEND SW.            73230003
         IC    R0,X0(R7)      TRY TO READ FROM THE ADDRESS IN QUESTION. 73240003
*                                                             @ZA02713  73270003
READABND EQU   *              EXPECTED ABEND TABLE ENTRY.               73310003
         TM    TSTFLGS1,S9GINTSW IS THIS AN INTERNAL REQUEST? @ZA05687  73350003
         BOR   R10            YES, RETURN READ ONLY REQUEST   @ZA05687  73360003
         LA    R8,X4          INDICATE AT LEAST READABLE       @YM04107 73390003
         OC    X0(X1,R7),X0(R7) NOW TRY TO WRITE               @ZA02713 73430003
WRITABND EQU   *              EXPECTED ABEND TABLE ENTRY.      @YM04107 73470003
         NI    TSTFLGS1,XFF-TSTFIRST  TURN OFF ABEND SWITCH.            73480003
         SR    R8,R8          SETUP R8  AS INDICATOR           @YM04107 73510003
         B     VLCKEXIT      RETURN CONTROL TO THE SYSTEM               73550003
         SPACE 2                                                        73590003
S9G21050 EQU   *                                                        73600003
         NI    TSTFLGS1,XFF-TSTFIRST  TURN OFF ABEND SWITCH.            73630003
         DROP  R4             DROP TCB ADDRESSABILITY.                  73670003
         USING TCB,R6         ESTABLISH TCB ADDRESSABILITY              73710003
         LA    R1,X4          INDICATE NOT READ OR WRITE.      @YM04107 73720003
         CR    R8,R1          WHAT CAUSED THE ERROR            @YM04107 73750003
         BE    VLCKEXIT       RETURN                           @YM04107 73790003
         LA    R8,X8          INDICATE NOT READ OR WRITE.      @YM04107 73830003
VLCKEXIT EQU   *              EXIT                             @YM04107 73840003
         LR    R2,R8          R2= RETURN CODE.                          73870003
         MODESET KEYADDR=WRKOLDKY,WORKREG=8 MODESET BACK                73910003
         B     S9G23030       EXIT .                                    73950003
         EJECT                                                          73960003
         SPACE 5                                                        73990003
S9G22010 EQU   *                                                        74030003
         EJECT                                                          74070003
*********************************************************************** 74080003
*                                                                     * 74110003
*        EXIT.                                                        * 74150003
*                                                                     * 74190003
*********************************************************************** 74200003
         SPACE 2                                                        74230003
S9G23010 EQU   *                                                        74270003
         SR    R15,R15        SET SUCCESSFUL RETURN CODE.               74310003
S9G23020 EQU   *                                                        74320003
         BAL   R11,LOCKRELE   RELEASE THE LOCAL LOCK                    74350003
S9G23025 EQU   *                                                        74390003
         LR    R2,R15         PRESERVE R15 RETURN CODE                  74430003
S9G23030 EQU   *              WHERE REG 2 CONTAINS RET CODE VAL CK ONLY 74440003
         LA    R0,WRKLEN      R0=LENGTH OF AREA TO FREED                74470003
         SPACE                                                          74510003
         L     R4,WRKREGRT    R4= RETURN ADDRESS                        74550003
         FREEMAIN R,LV=(0),A=(3) ISSUE FREEMAIN OF WORKAREA             74560003
         NI    TCBTSFLG,XFF-TCBATT  NO NEED TO DEFER ATTNS.             74590003
         ESTAE 0              CLEAR THE ESTAE                           74630003
         SR    R9,R9          ZERO REG                         @ZA26084 74670003
         ICM   R9,7,TCBTRNB   R9= ADDR OF TCOMTAB IF THERE     @ZA26084 74675003
         LTR   R9,R9          WAS THERE AN ADDR IN TCB         @ZA26084 74680003
         BZ    S9G23035       NO...DONT CLOBBER PSA ?          @ZA26084 74685003
         NI    TSTFLGS4,XFF-TSTRERTN  TURN OFF ABEND SW                 74690003
S9G23035 EQU   *                                               @ZA26084 74695003
         LR    R14,R4         R14= ADDR OF RETURN                       74710003
         LR    R15,R2         RESTORE R15 RETURN CODE TO CALLER         74750003
         BR    R14            RETURN TO CALLER                          74790003
*********************************************************************** 74830003
*    THIS FUNCTION FREES ALL THE CORE GOTTEN IN SUBPOOL 255    @ZA06226 74870003
*        BY IGC0006A FOR SVB AND SVQ CONTROL BLOCKS            @ZA06226 74910003
*                                                              @ZA06226 74920003
***************************************************************@ZA06226 74950003
         SPACE 2                                                        74990003
S9G24010 EQU   *                   SVC 97 CLEANUP FUNCTION     @ZA06226 75030003
         LR    R4,R6               GET TCB ADDR FOR BASE       @ZA26084 75036003
         DROP  R6                  DROP R6 FOR TIME BEING      @ZA26084 75042003
         USING TCB,R4              REBASE TCB                  @ZA26084 75048003
         LR    R7,R6               ZERO TCBTRN IN ALL TCBS     @ZA11359 75054003
         LA    R7,N0(R7)           SAVE TOP OF FAMILY QUEUE    @ZA11359 75070003
CLEARTRN EQU   *                                                        75110003
         NC    TCBTRN(4),FB000000  ZERO ALL TEST INFO IN TCBTRN@ZA11359 75150003
         L     R8,TCBLTC           GET DAUGHTER IF ANY         @ZA11359 75160003
         LA    R8,N0(R8)           CLEAR HI BYTE               @ZA11359 75190003
         LTR   R8,R8               IS THERE A DAUGHTER         @ZA11359 75230003
         BZ    FINDSIS             NO DO SISTER'S FAMILY       @ZA11359 75270003
         LR    R4,R8               WAS DAUGHTER DO HER FAMILY  @ZA26084 75280003
         B     CLEARTRN            PROCESS NEXT GENERATION     @ZA11359 75310003
FINDSIS  EQU   *                   PROCESS SISTER              @ZA11359 75350003
         L     R8,TCBNTC           GET SISTER'S ADDR IF ANY    @ZA11359 75390003
         LA    R8,N0(R8)           CLEAR HI BYTE               @ZA11359 75400003
         LTR   R8,R8               IS THERE A SISTER           @ZA11359 75430003
         BZ    UPTOMOM             NO-GO UP TO MOTHER'S FAMILY @ZA11359 75470003
         LR    R4,R8               YES-DO SISTER'S FAMILY      @ZA26084 75510003
         B     CLEARTRN            GO PROCESS SISTER'S FAMILY  @ZA11359 75520003
UPTOMOM  L     R8,TCBOTC           GET MOTHER'S ADDRESS        @ZA11359 75550003
         LA    R4,N0(R8)           CLEAR HI BYTE               @ZA26084 75590003
         CR    R4,R7               IS MOTHER HEAD OF FAMILY    @ZA26084 75600003
         BNE   FINDSIS             NO- DO HER SISTER'S FAMILY  @ZA11359 75630003
         SR    R4,R4               CLEAR REG FOR USE           @Z260846 75670003
         L     R8,PSAAOLD          GET PTR TO ASCB             @ZA06226 75710003
         L     R8,ASCBASXB-ASCB(R8) GET ADDR OF AXCB           @ZA06226 75750003
         L     R8,ASXBLWA-ASXB(R8) GET ADDR OF LWA             @ZA06226 75760003
         L     R7,LWATEST-LWA(R8)  GET ADDR OF TEST WORD       @ZA06226 75790003
         LA    R7,0(R7)            ZERO HIGH BYTE              @ZA06226 75830003
         LTR   R7,R7               IS THE A POINTER TO A SVB   @ZA06226 75870003
         ST    R4,LWATEST-LWA(R8)  ZERO LWATEST PTR            @ZA26084 75880003
         BZ    S9G23010            NO, GO TO EXIT PROCESSING   @ZA06226 75910003
* AT THIS POINT WE KNOW THERE IS WORK TO DO                    @ZA06226 75950003
*    FIRST FREE THE LOCAL LOCK SO THAT SVCS CAN BE ISSUED      @ZA06226 75990003
*    THEN GET 1000 BYTES FOR A LIST TYPE FREEMAIN              @ZA06226 76000003
         SPACE 1                                                        76030003
         BAL   R11,LOCKRELE        FREE LOCAL LOCK             @ZA06226 76070003
         SPACE 1                                                        76110003
         GETMAIN RU,LV=ONEK        GET FREEMAIN LIST CORE      @ZA06226 76120003
         EJECT                                                          76150003
         USING IKJEGSVQ,R7         ADDRESSABILITY TO SVQS      @ZA06226 76190003
         USING IKJEGSVB,R8         ADDRESSABILITY TO SVBS      @ZA06226 76230003
         LR    R9,R1               R9= ADDR LIST               @ZA06226 76240003
         SPACE 2                                                        76270003
S9G24020 EQU   *                   SVQ LOOP                    @ZA06226 76310003
         LA    R7,N0(R7)           ZERO HI BYTE              @ZA06226   76350003
         LTR   R7,R7               IS THERE AN ADDR?           @ZA06226 76360003
         LA    R10,S9G24090        SET ADDR FOR RETURN         @ZA06226 76390003
         BZ    S9G24090            NO ADDR GO FREE CORE &      @ZA06226 76430003
*                                  RETURN                      @ZA06226 76470003
         ST    R7,N0(R4,R9)        PUT ADDR OF SVQ IN LIST     @ZA06226 76480003
         LA    R5,SVQLEN           LENGTH OF ONE SVQ BLOCK     @ZA06226 76510003
         ST    R5,N500(R4,R9)      PUT LENGTH OF SVQ IN LIST   @ZA26084 76550003
         LA    R4,N4(R4)           INCREMENT INDEX             @ZA26084 76560003
         CH    R4,FIVEHUND         IS R4 POINTING TO LAST      @ZA26084 76590003
*                                  ENTRY                       @ZA06226 76630003
         LA    R10,S9G24030        GET RETURN ADDR             @ZA06226 76670003
         BE    S9G24090            PAST END? GO FREE           @ZA17744 76710003
S9G24030 EQU   *                                               @ZA06226 76720003
         L     R8,SVQBLKPT         GET ADDR OF SVB BLOCK       @ZA06226 76750003
         LA    R8,N0(R8)           ZERO HI BYTE                @ZA06226 76790003
         LTR   R8,R8               IS THERE AN SVB BLOCK       @ZA06226 76830003
         LA    R11,S9G24040        RETURN ADDR IN R11          @ZA06226 76840003
         BNZ   S9G24050            YES, BRANCH TO PROCESS SVB  @ZA06226 76870003
S9G24040 EQU   *                                               @ZA06226 76910003
         L     R7,SVQLNKPT         GET NEXT SVQ BLOCK          @ZA06226 76950003
         B     S9G24020            ONCE AGAIN FROM THE TOP     @ZA06226 76960003
         SPACE 3                                                        76970003
* THE FOLLOWING CODE WILL SEARCH THE SVB BLOCKS AND FREE THEM  @ZA06226 76990003
S9G24050 EQU   *                                               @ZA06226 77070003
         ST    R8,N0(R4,R9)        STORE ADDR IN LIST          @ZA26084 77110003
         LA    R5,SVBLEN           GET LENGTH OF SVB           @ZA06226 77150003
         ST    R5,N500(R4,R9)      STORE LENGTH IN LIST        @ZA26084 77190003
         LA    R4,N4(R4)           INCREMENT INDEX             @ZA31527 77200003
         CH    R4,FIVEHUND         ARE WE PAST THE END YET     @ZA26084 77230003
         LA    R10,S9G24060        ADDR FOR CORE RETURN        @ZA06226 77270003
         BE    S9G24090            YES, GO FREE THE CORE       @ZA17744 77310003
S9G24060 EQU   *                                               @ZA06226 77320003
         L     R8,SVBLNKPT         GET NEXT SVB BLOCK PTR      @ZA06226 77350003
         LA    R8,N0(R8)           ZERO HIGH BYTE              @ZA06226 77390003
         LTR   R8,R8               IS THE PTR ZERO             @ZA06226 77430003
         BNZ   S9G24050            NO, CONTINUE LOOP           @ZA06226 77440003
         BR    R11                 YES, GO BACK TO LOOK FOR    @ZA06226 77470003
*                                  NEXTSVQ                     @ZA06226 77510003
         EJECT                                                          77550003
S9G24090 LTR   R4,R4               IS THIS FINAL CALL          @ZA26084 77560003
         BZ    S9G24095            YES, GO FREE LIST CORE      @ZA06226 77590003
         S     R4,FOUR             DECREMENT REG BY FOUR       @ZA26084 77630003
         LA    R1,N500(R9)         USE R1 FOR ARITHMETIC       @ZA06226 77670003
         AR    R1,R4               FIND END OF LENGTH LIST     @ZA26084 77680003
         OI    N0(R1),X'80'        TURN ON END OF LIST         @ZA06226 77710003
*                                  INDICATOR                   @ZA06226 77750003
         LA    R2,N500(R9)         GET START OF LENGTH LIST    @ZA06226 77790003
         MVC   WRKFREE(FREELEN),LISTFREE COPY LIST FORM        @ZA06226 77800003
         FREEMAIN LC,LA=(R2),A=(R9),MF=(E,WRKFREE) FREE A BUNCH OF CORE 77830003
         SPACE 1                                                        77870003
         SR    R4,R4               RESET INDEX TO ZERO         @ZA26084 77910003
         BR    10                  RETURN TO CALLER            @ZA06226 77920003
         SPACE 2                                                        77950003
* CLEAN UP LIST CORE AND GO AWAY                               @ZA06226 77990003
         SPACE 1                                                        78030003
S9G24095 EQU   *                                               @ZA06226 78040003
         FREEMAIN RC,LV=ONEK,A=(R9)                            @ZA06226 78070003
         SR    R15,R15             ZERO RETURN CODE            @ZA06226 78110003
         B     S9G23025            GO TO CLEAN UP AND RETURN   @ZA06226 78150003
         DROP  R7                                                       78160003
         DROP  R8                                                       78190003
         DROP  R4                                              @ZA26084 78200003
         USING TCB,R6             REESTABLISH BASE FOR TCB     @ZA26084 78210003
         USING RBSECT,R7          REESTABLISH BASE FOR RB               78230003
*                                 RB'S ARE NOT REF IN PRIOR SECTION     78270003
         EJECT                                                          78280003
*********************************************************************** 78310003
*                                                                     * 78350003
*        THIS SUBROUTINE IS USED TO ISOLATE THE PRB TO BE MODIFIED.   * 78390003
*                                                                     * 78400003
*********************************************************************** 78430003
         SPACE 2                                                        78470003
S9G30010 EQU   *                                                        78510003
         LTR   R7,R7          WAS AN RB ADDRESS OR A TCB ADDRESS        78520003
*                             PASSED AS AN INPUT PARAMETER.             78550003
         BNZ   S9G30070       IF AN RB ADDRESS PASSED, BRANCH TO        78590003
*                             DETERMINE STATUS OF RB.                   78630003
         L     R7,TCBRBP      ADDRESS OF RB CHAIN FOR TCB PASSED.       78640003
S9G30030 EQU   *                                                        78670003
         TM    RBSTAB1,RBFTP   CHECK IF THIS IS A PRB.                  78710003
         BZ    S9G30070        IF A PRB, BRANCH TO DETERMINE            78750003
*                              STATUS.                                  78760003
         TM    RBSTAB1,RBFTP-RBFTIRB IS THIS RB OTHER THAN AN IRB       78790003
         BNZ   S9G30050        IF NOT AN IRB, BRANCH TO GET NEXT        78830003
*                              RB POINTER.                              78870003
         TM    RBSTAB1,RBFTIRB IS THIS RB AN IRB.                       78880003
         BO    S9G30070        IF AN IRB, BRANCH TO DETERMINE           78910003
*                              STATUS.                                  78950003
S9G30050 EQU   *                                                        78990003
         TM    RBSTAB2,RBTCBNXT HAS END OF RB CHAIN BEEN REACHED.       79000003
         L     R7,RBLINK       GET POINTER TO NEXT RB ON CHAIN.         79030003
         BO    S9G12030        IF END OF CHAIN, BRANCH TO SET           79070003
*                              ERROR RETURN CODE AND EXIT.              79110003
         B     S9G30030        BRANCH TO EXAMINE THIS RB.               79120003
S9G30070 EQU   *                                                        79150003
         TM    RBOPSW+X1,PSWPBIT DETERMINE IF PROGRAM IS RUNNING        79190003
*                              IN PROBLEM PROGRAM MODE.                 79230003
         BZ    S9G12030        IF NOT IN PROBLEM PROGRAM MODE,          79240003
*                              BRANCH TO SET ERROR CODE AND EXIT.       79270003
         TM    RBOPSW+X1,PSWPKEYF DETERMINE IF PROGRAM HAS A            79310003
*                              PROTECT KEY OF ZERO.                     79350003
         BZ    S9G12030        IF PROTECT KEY ZERO, BRANCH TO SET       79360003
*                              ERROR CODE AND EXIT.                     79390003
         BR    R11             RETURN TO CALLER.                        79430003
         EJECT                                                          79470003
*********************************************************************   79480003
*                                                           @ZA05687*   79510003
*       HERE WE WILL MODESET TO THE ORIGINAL KEY            @ZA05687*   79550003
*       AND OBTAIN THE LOCAL LOCK FOR THOSE WHO HAVE LOST   @ZA05687*   79590003
*       IT AND ARE DESIROUS OF FINDING IT AGAIN             @ZA05687*   79600003
*                                                           @ZA05687*   79630003
*********************************************************************   79670003
         SPACE  2                                                       79710003
GETLOCK  EQU   *                                            @ZA05687    79720003
         MODESET KEYADDR=WRKOLDKY,WORKREG=8 RETURN TO ORG KEY @ZA05687  79750003
         STM   R4,R2,WRKREGSV    SAVE REGS AROUND SETLOCK     @ZA05687  79790003
GOGETEM  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(LOCAL,         *79830003
               IGC0009G(GOGETEM)) REOBTAIN THE LOCK           @ZA05687  79840003
         LM    R4,R2,WRKREGSV     RESTORE THE REGS            @ZA05687  79870003
         BR    R11                RETURN TO CALLER            @ZA05687  79910003
         EJECT                                                          79950003
*********************************************************************** 79960003
*                                                                     * 79990003
*        WE HAVE TO DETERMINE WHAT TO DO WITH THE ESTAE FAILURE.      * 80030003
*              1) IF TEST IS NOT RUNNING END THE SESSION.             * 80070003
*              2) IF TEST IS RUNNING RETURN WITH 24.                  * 80080003
*                                                                     * 80110003
*********************************************************************** 80150003
         SPACE                                                          80190003
ESTAFAIL DS    0H             ESTAE FAILLED.                            80200003
         SPACE                                                          80230003
         TM    TCBABF,TCBTCP  IS TEST RUNNING                           80270003
         BZ    S9G08010       YES RETURN TO CALLER WITH 24.             80310003
         L     R9,TCBTRN      GET ADDR OF TCOMTAB                       80320003
         USING TCOMTAB,R9     ADDRESSABILITY TO TCOMTAB                 80350003
         OI    TSTFLGS4,TSTSVCAB  INDICATE TO MNL TO TERMINATE          80390003
         B     S9GLOCKA       POST MNL TO END TEST SESSION..            80430003
S9G08010 DS    0H             RETURN WITH 24.                           80440003
         STC   R15,TSTESTRC   SAVE THE  RETURN CODE.                    80470003
         LA    R15,RC24       REGISTER 15 = 24..                        80510003
         B     S9G23020       RETURN.                                   80550003
         EJECT                                                          80560003
*********************************************************************** 80590003
*                                                                     * 80630003
*        THIS ROUTINE IS USED TO SYNCH TO IKJEGSTA FOR HANDLING ABENDS  80670003
*                                                                     * 80680003
*********************************************************************** 80710003
         SPACE                                                          80750003
S9GESTAE DS    0F             START OF DUMMY STA                        80790003
         USING S9GESTAE,R15   RE-ESTABLISH ADDR'ABILITY        @YM04131 80800003
         L     R6,FLCCVT      R6= ADDR OF CVT                  @YM04131 80830003
         USING CVT,R6         ADDR'ABILITY TO CVT              @YM04131 80870003
         L     R6,CVTTCBP     R6= ADDR OF TCB                  @YM04131 80910003
         L     R6,X4(,R6)     R6= ADDR OF THE TCB              @YM04131 80920003
         USING TCB,R6         ADDRABILITY TO TCB               @YM04131 80950003
         L     R9,TCBTRN      R9= ADDR OF TCOMTAB                       80990003
         LA    R9,N0(R9)      CLEAR FLAG BYTE LEAVING ADDRESS  @ZA11359 81030003
         LTR   R9,R9          IS TEST RUNNING.                          81040003
         BZ    ESTAERR        NO TEST IS NOT IN CONTROL                 81070003
         USING TCOMTAB,R9     ADDR'ABILITY TO TCOMTAB                   81110003
         L     R15,STAEVCON   R15= ADDR OF IKJEGSTA            @ZA04126 81150003
         LR    R13,R14        SAVE RETURN ADDR AROUND BALR     @ZA04126 81160003
         BALR  R14,R15        TRANSFER CONTROL TO IKJEGSTA     @ZA04126 81190003
         LTR   R1,R1          IS A WORK AREA AVAIL??           @ZA04126 81230003
         BZR   R13            NO, RETURN SKIP SETRP            @ZA04126 81270003
         USING SDWA,R1        YES-SET ADDR'ABILITY             @ZA10530 81280003
         L     R3,SDWAPARM    GET WORK AREA FOR RETRY          @ZA10530 81310003
         ST    R3,SDWASR03    UPDTAE REG3 PTR FOR RETRY        @ZA10530 81350003
         ST    R9,SDWASR09    AND THE R9 PTR TO TCOMTAB        @ZA10530 81390003
         L     R12,X8(,R3)    RESET BASE REG 12                @ZA10530 81400003
         ST    R12,SDWASR12   AND UPDATE IN SDWA FOR RETRY     @ZA10530 81430003
         SETRP RETADDR=(R0),RECORD=NO,DUMP=NO,FRESDWA=YES,RC=4,        *81470003
               RETREGS=YES                                     @ZA10530 81510003
         BR    R13            RETURN TO CALLER                 @ZA04126 81520003
         SPACE                                                          81550003
ESTAERR  DS    0H             SOMETHING IS A MESS PERCOLATE..           81590003
         SR    R15,R15        CLEAR REG 15..                            81630003
         BR    R14            EXIT TO CALLER                            81640003
         DROP  R15,R6,R1      RELEASE ADDRABILITY              @YM04131 81670003
         EJECT                                                          81710003
*********************************************************************** 81750003
*                                                                     * 81760003
*        THIS ROUTINE IS THE RETRY ROUTINE OF IGC0009G                * 81790003
*        ON ENTRY ALL MY REGISTERS ARE VALID DUE TO SETRP.    @ZA10530* 81830003
*                                                                     * 81870003
*********************************************************************** 81880003
         SPACE                                                          81910003
S9GRETRY DS    0F             THE START OF THE RETRY ROUTINE            81950003
         SR    R15,R15        CLEAR RETURN CODE                         81990003
         L     R4,WRKSVTCB    R4= ADDR OF CALLERS TCB.                  82000003
         USING TCB,R4         ADDR'ABILITY TO THE TCB.                  82030003
         TM    TCBABF,TCBTCP  DETERMINE IF THIS WAS A SERVICE           82070003
         BZ    SERVFAIL       YES A SERVICE FAILED.                     82110003
         OI    TSTFLGS4,TSTSVCAB  INDICATE ABEND TO MNL.                82120003
         B     S9GLOCKB       POST MNL TO END TEST SESSION.             82150003
SERVFAIL DS    0H             RETURN WITH A 20.                         82190003
         TM    TSTFLGS1,TSTFIRST  WAS THE ABEND EXPECTED.               82230003
         BO    S9G21050       THE ADDR IS BAD.                          82240003
         LA    R15,RC20       R15 = 20, RETRY ROUTINE ENTERED.          82270003
         B     S9G23025       EXIT TO THE CALLER.                       82310003
         EJECT                                                          82350003
S9GSPLST IKJEGSPL RTRY=S9GRETRY,ABNTB=STAETAB,MODNM=IGC0009G,          *82360003
               TNM=BREAKPOINT-SVC                              @ZA10530 82390003
S9GSPLEN EQU   *-S9GSPLST     LENGTH OF ESTAE PARM LIST.       @ZA10530 82430003
         SPACE                                                          82470003
STAETAB  DS    0F             ABEND TABLE FOR IKJEGSTA                  82480003
         DC    X'00'          INDICATE NO MESSAGE                       82510003
         DC    AL3(READABND)  READ ONLY VALIDITY CHECK FAILED           82550003
         DC    X'00'          INDICATE NO MESSAGE                       82590003
         DC    AL3(WRITABND)  WRIT ABEND VALIDITY CHECK FAILED          82600003
         DC    X'FF'          NO ENTRIES IN TABLE                       82630003
         SPACE 2                                                        82670003
DEQLIST  DEQ   (MAJQNAM,,,STEP),MF=L                                    82710003
         DS    0F                                                       82720003
DQLSTLEN EQU   *-DEQLIST         LENGTH OF LIST FORM                    82750003
MAJQNAM  DC    CL8'IKJTMPNM'     MAJOR NAME FOR DEQ           @ZA07137  82790003
         SPACE 5                                                        82830003
EXIT     EQU   3              *                                         82840003
PSWPBIT  EQU   X'01'                                                    82870003
PSWPKEYF EQU   X'80'                                                    82910003
RC20     EQU   20             RETURN CODE 20.                           82950003
RC24     EQU   24             RETURN CODE 24.                           82960003
X0       EQU   0              OFFSET 0                                  82990003
X1       EQU   1              OFFSET 1                                  83030003
X2       EQU   2              OFFSET 2                                  83070003
X4       EQU   4              OFFSET 4                                  83080003
X14      EQU   14             OFFSET 14.                                83110003
X5       EQU   5              OFFSET 5                                  83150003
X7       EQU   7              OFFSET 7                                  83190003
X8       EQU   8              OFFSET 8                                  83200003
SAVELN   EQU   80             LENGTH OF GETMAIN SAVE AREA               83230003
         EJECT                                                          83270003
*******************************************************************     83310003
*        WORKAREA DSECT FOR IGC0009G                                    83320003
*******************************************************************     83350003
S9GWORKA DSECT                                                          83390003
WRKSTART DS    0F             START OF THE WORKAREA                     83430003
*        ***************************************************** @ZA10530 83440003
*        *  THE FOLLOWING CODE TO WRKREGSV MUST REMAIN AT    * @ZA10530 83470003
*        *  OFFSET ZERO INTO THIS WORK AREA DSECT            * @ZA10530 83510003
*        ***************************************************** @ZA10530 83550003
S9GSPL   DS    XL(S9GSPLEN)   ESTAE EXIT PARAMETER LIST        @ZA10530 83560003
WRKREGSV DS    18F            REGISTER SAVE AREA                        83590003
WRKESTAE DS    4F             ESTAE WORKAREA                            83630003
WRKREGRT DS    1F             SAVE AREA FOR R14 REGISTER                83670003
WRKSVTCB DS    1F             SAVE AREA FOR CALLERS TCB ADDR.           83680003
WRKENQ   DS    CL8            ENQ ELEMENT SAVEAREA                      83710003
WRKOLDKY DS    1X             SAVE THE PROTECT KEY                      83750003
WRKRESV  DS    3X             NOT USED.                                 83790003
WRKECB   DS    1F             ECB FOR ENQ RESOURCE WAIT        @YM07115 83800003
         ORG   WRKREGSV       BACK TO TOP OF WORKAREA                   83830003
WRKENQPR DS    1F             PREFIX FOR ECB ADDRESS           @YM07115 83870003
WRKENQWK DS    0F             ENQ PARM LIST START                       83910003
WRKENQFG DS    X              ENQ FLAGS (END OF LIST)                   83920003
WRKENQTP DS    2X             ENQ TYPE INDICATOR                        83950003
WRKENQRC DS    X              ENQ R14 CODE                              83990003
         ORG   WRKREGSV       BACK TO TOP OF WORKAREA         @ZA07137  84030003
WRKDEQPR DS    1F             PREFIX FOR TCB ADDR             @ZA07137  84040003
WRKDEQWK DS    0F             START OF DEQ PARM LIST          @ZA07137  84070003
         ORG                                                            84110003
         ORG   WRKREGSV                                       @ZA06226  84150003
WRKFREE DS    3F             FREEMAIN PARM LIST               @ZA06226  84160003
        ORG                                                             84190003
WRKNQRNM DS    CL8                           RNAME GOES HERE  @ZA07137  84230003
S9GFLGS  DS    0F -                          SVC 97 FLAGS     @ZA07137  84270003
WRKFLGS1 DS    X  -                          1ST FLAG BYTE    @ZA07137  84280003
WRKPSEUD EQU   X'80'  -                      SVC97 IS PSEUDO  @ZA07137  84310003
*                                            BREAKPOINT       @ZA07137  84350003
WRKSVRBS DS    3X -                          PRIOR SVRB ADDR   @ZA07138 84390003
*                             FROM ECBPP IN TCOMTAB            @ZA09259 84400003
*                                                              @ZA10462 84430003
WRKTCBSA DS    1F                     TCB REG SAVE             @ZA31527 84440003
WRKLEN   EQU   *-WRKSTART     LENGTH OF THE SAVE AREA                   84470003
         EJECT                                                          84510003
         IKJEGS9G MF=D                                                  84520003
         EJECT                                                          84550003
         BRKELEM                                                        84590003
IGC0009G CSECT                                                          84630003
BACKUP1  DC    Y(BRKINST-BRKELEM)   VALUE TO BACKUP THE IC.             84640003
BACKUP2  DC    Y(BRKINST-BRKELEM+6)  VALUE TO BACKUP THE IC             84670003
         EJECT                                                          84710003
IOVCON   DC    V(IKJEGIO)            ADDR OF MSG WRITER        @ZA04126 84750003
STAEVCON DC    V(IKJEGSTA)           ADDR OF ESTAE PROCESSOR   @ZA04126 84760003
         IKJTCB                                                         84790003
S        EQU   TCBNTC-TCB     LAST ATTACHED SISTER TCB                  84830003
M        EQU   TCBOTC-TCB     MOTHER TCB                                84870003
D        EQU   TCBLTC-TCB     LAST ATTACHED DAUGHTER TCB                84880003
         EJECT                                                          84910003
         TCOMTAB                                                        84950003
         IKJTPL                                                         84990003
         EJECT                                                          85000003
         IKJRB                                                          85030003
         EJECT                                                          85070003
         CVT   DSECT=YES                                                85110003
         EJECT                                                          85120003
         IHASCVT                                                        85150003
         IEZJSCB                                                        85190003
         IKJPSCB                                                        85230003
         EJECT                                                          85240003
         IKJECT                                                         85270003
         EJECT                                                          85310003
         IHAPSA                                                         85350003
         EJECT                                                          85360003
         IHASDWA                                                        85390003
         EJECT                                                          85430003
         IHAASCB                                                        85470003
         EJECT                                                          85480003
         IHAASXB                                                        85510003
         EJECT                                                          85550003
        IKJEFLWA                                                        85590003
         EJECT                                                          85600003
         SPACE 5                                                        85630003
         IKJEGSVQ                                                       85670003
         EJECT                                                          85710003
         IKJEGSVB                                                       85720003
          EJECT                                                         85750003
IGC0009G CSECT                                                          85790003
X40      DC    X'40'     FLAG FOR BALR LINK REG        @ZA02953         85830003
X80      DC    X'80'     FLAG FOR BAL  LINK REG        @ZA02953         85840003
         DS    0F                                                       85870003
FOUR     DC    F'4'                                                     85910003
FIVEHUND DC    H'500'                                                   85950003
PATCHSP  DC    100C'Z'         PATCH AREA.                              85960003
         END   IGC0009G                                                 85990003
