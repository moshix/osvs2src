         TITLE 'IGC0108B --- ASSIGNS ALTERNATE TRACKS'                  00100421
         COPY  LCGASMSW                                          SM4351 00100821
IGC0108B CSECT                                                          00102021
*C383953                                                      @VS40037  00103003
*                                                                       00112003
*A273500                                                      @VS40433  00113003
* FIX 3350 ALT TO ALT ASSIGNMENT.                             @ZM40450  00114003
*A383943,384821,822                                           @ZM43013  00118003
*C 84000,419000,423000              @SA74452=@YA09634=@XA09732=@ZA04363 00122003
*A 83500-83600,95500,505900         @SA74452=@YA09634=@XA09732=@ZA04363 00132003
*                                                                       00142003
*                                                             @Y30LSFY  00152003
*STATUS CHANGE LEVEL 004                                                00240021
*                                                                     * 00300016
*FUNCTION/OPERATION-  THIS LOAD OF SVC 82 PERFORMS ALTERNATE          * 00400016
*   TRACK ASSIGNMENT FOR EITHER OF TWO CASES.                         * 00500016
*                                                                     * 00600016
*     1) VOLUMES IN A STATE OF BEING INITIALIZED.                     * 00700016
*     2) PRE-INITIALIZED VOLUMES(THEY HAVE A FORMAT 4 DSCB).          * 00800016
*                                                                     * 00900016
*   IF THE SPECIFIED DEFECTIVE TRACK IS AN UNASSIGNED ALTERNATE, IT   * 01000016
*     IS FLAGGED TO PREVENT ITS EVER BEING ASSIGNED.                  * 01100016
*                                                                     * 01200016
*   IF THE SPECIFIED DEFECTIVE TRACK IS AN ASSIGNED ALTERNATE, THE    * 01300016
*     NEXT AVAILABLE ALTERNATE IS ASSIGNED TO THE ORIGINAL PRIMARY    * 01400016
*     TRACK.                                                          * 01500016
*                                                                     * 01600016
*   IF THE SPECIFIED DEFECTIVE TRACK IS A PRIMARY TRACK, THE NEXT     * 01700016
*     GOOD AVAILABLE ALTERNATE TRACK IS ASSIGNED TO IT.               * 01800016
*                                                                     * 01900016
*ENTRY POINT-  THE ONLY ENTRY POINT IS -IGC0108B-.                    * 02000016
*                                                                     * 02100016
*INPUT-  REGISTER 1 POINTS TO 3-FULL WORDS AS FOLLOWS.                * 02200016
*        WORD1-  INPUT PARM LIST POINTER PASSED TO IGC0008B.          * 02300016
*        WORD2-  WORKAREA ADDRESS- DESCRIBED BY -IOBLOCKS- DSECT.     * 02400016
*        WORD3-  POINTER TO SVRB EXTENDED SAVEAREA.                   * 02500016
*                                                                     * 02600016
*EXITS-NORMAL-  THE 2ND WORD OF THE INPUT PARM LIST CONTAINS THE      * 02700016
*   CCHH OF THE ASSIGNED ALTERNATE TRACK, IF ANY. THE 2ND WORD        * 02800016
*   CONTAINS ZEROS IF NO ALTERNATE NEED BE ASSIGNED.RC=0.             * 02900016
*   -THE 6-BYTES OF ALTERNATE TRACK INFORMATION IS UPDATED(EITHER IN  * 03000016
*   THE FORMAT 4 DSCB OR POINTED TO BY THE INPUT PARM LIST.           * 03100016
*                                                                     * 03200016
*EXITS-ERROR-  RETURN CODE=12//IO ERROR ENCOUNTERED.                  * 03300016
*              RETURN CODE=16//NO MORE ALTERNATES AVAILABLE.          * 03400016
*   RETURN TO CALLER VIA SVC 3.                                       * 03500016
*                                                                     * 03600016
*SUPERVISOR MACROS-  EXCP,WAIT,FREEMAIN.                              * 03700016
*                                                                     * 03800016
*TABLES/WORKAREA-  USES THE WORKAREA DESCRIBED BY DSECT -IOBLOCKS-.   * 03900016
*                                                                     * 04000016
*OUTPUT-  SEE EXIT DESCRIPTION.                                       * 04100016
*                                                                     * 04200016
*ATTRIBUTES-  REENTRANT,RELOCATABLE,PRIVILEGED,ENABLED.               * 04300016
*                                                                     * 04400016
*********************************************************************** 04450002
         EJECT                                                          04500002
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             04600016
R0       EQU   0                                                        04700016
R1       EQU   1                                                        04800016
R2       EQU   2                                                        04900016
R3       EQU   3                                                        05000016
R4       EQU   4                                                        05100016
R5       EQU   5                                                        05200016
R6       EQU   6                                                        05300016
R7       EQU   7                                                        05400016
R8       EQU   8                                                        05500016
R9       EQU   9                                                        05600016
R10      EQU   10                                                       05700016
R11      EQU   11                                                       05800016
R14      EQU   14                      LINK REGISTER.                   05900016
R15      EQU   15                                                       06000016
PARMPTR  EQU   1                       POINTS TO INPUT PARAMETERS.      06100016
BASEREG  EQU   12                      BASE REGISTER.                   06200016
         SPACE 3                                                        06300016
*   EQUATE DEFINITIONS.                                                 06400016
RBEXSAVE EQU   96                      EXTENDED SAVE AREA FOR SVRB.     06500016
LAST     EQU   X'80'                   LAST PARAMETER INDICATOR.        06600016
GOOD     EQU   X'7F'                   I/O GOOD COMPLETION BIT.         06700016
COMPLETE EQU   X'40'                   I/O COMPLETE BIT.                06800016
SKIP     EQU   X'10'                   SKIP DATA TRANSFER.              06900016
CHAIN    EQU   X'40'                   COMMAND CHAIN CCWS.              07050003
CHAINSD  EQU   X'50'                   COMMAND CHAIN +SKIP CCWS  XM4405 07100003
SILI     EQU   X'20'                   SUPPRESS INCORRECT LENGTH.       07200016
ALT      EQU   X'01'                   ALTERNATE TRACK FLAG.            07300016
DEFECT   EQU   X'02'                   DEFECTIVE TRACK FLAG.            07400016
MOVEHA   EQU   X'40'                   MOVE HA DOWN THE TRACK.          07500016
UE       EQU   X'01'                   UNIT EXCEPTION.                  07600016
MAINUCB  EQU   X'FF'                   ID FOR PRIMARY UCB.              07700016
DA2321   EQU   X'05'                   UCB TYPE CODE FOR 2321.          07800016
DA2314   EQU   X'08'                   2314 UCB TYPE CODE.              07900016
ANALYZE  EQU   X'00'                   ANALYZE FUNCTION CODE.   YL02912 07902002
D0       EQU   0                        ZERO DISPLACEMENT               07910003
D4       EQU   4                        DISPLACEMENT OF 4.      YL02912 07912002
K36      EQU   36                       CONSTANT OF 36.         YL02912 07914002
         AIF   ('&LIB' EQ 'LIB1').X226605                       XL03130 07920003
SS1CONV  EQU   X'01'                    CODE FOR SS1 CONV      @Y30LSFY 07930003
ICEBERG  EQU   X'0D'                    UCB DEVICE TYPE 3330-1 @Y30LSFY 07932003
WIN      EQU   X'0A'                    UCB DEVICE TYPE 3340.   XL03130 07940003
D3350    EQU   X'0B'                   UCB DEVICE TYPE 3350    @Z30RSAG 07950003
L16      EQU   16                      R0 CCW LENGTH           @Z30RSAG 07952003
.X226605 ANOP                                                   XL03130 07960003
         EJECT                                                          08000016
         LR    BASEREG,R15             ESTABLISH ADDRESSING.            08100016
         USING IGC0108B,BASEREG                                         08200016
         USING PARMLIST,R11                                     YL02912 08250002
         SPACE                                                          08300016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA04363 08350003
         DC    C'IGC0108B OZ04363'     LAST FIX THIS MOD       @ZA04363 08360003
APARNO   L     R11,0(R1)               PARM LIST POINTER.      @ZA04363 08400003
         L     R2,4(R1)                WORKAREA ADDRESS.                08500016
         L     R5,8(R1)                SVRB EXTENDED AREA.              08600016
         SPACE 2                                                        08700016
*********************************************************************** 08800016
*                                                                     * 08900016
*   INITIALIZE THE IOB.                                               * 09000016
*                                                                     * 09100016
*********************************************************************** 09200016
         SPACE 2                                                        09300016
         USING IOBLOCKS,R2                                              09400016
INITIOB  MVI   IOBFLAG1,X'42'          SET PROPER FLAGS.                09500016
         MVI   RETSW,X'00'             CLEAR RETRY SW          @ZA04363 09550003
         LA    R3,ECB                  ECB ADDRESS.                     09600016
         ST    R3,IOBECBAD             STORE IN IOB.                    09700016
         MVI   IOBINCAM+1,1            BLOCK COUNT.                     09800016
         LA    R3,DCB-44               DCB ADDRESS.                     09900016
         ST    R3,IOBDCBPT             STORE IN IOB.                    10000016
         L     R4,UCBPTR               UCB ADDRESS.             YL02912 10100002
         USING UCB,R4                                                   10200016
         CLI   UCBID,MAINUCB           THIS A PRIMARY UCB.              10300016
         BE    TESTF                   GO TEST THE FUNCTION.            10400016
         OI    SW,D2321                SET 2321 SWITCH.                 10500016
         MVC   IOBSEEK+1(2),0(R4)      BIN NO. TO IOB.                  10600016
         DROP  4                                                        10700016
         SPACE 2                                                        10800016
TESTF    EQU   *                                                        10900002
         CLI   FUNCTION,X'00'           ANALYZE/FORMAT REQUEST? YL02912 10950002
         BE    ASSG2                   YES--GO HANDLE.                  11000016
         CLI   FUNCTION,SS1CONV        THIS A SS1 CONV REQUEST @Y30LSFY 11050003
         BE    ASSG2                   YES--GO HANDLE.         @Y30LSFY 11060003
         EJECT                                                          11100016
*   BUILD CCWS FOR READING FORMAT 4 DSCB HERE.                          11200016
         USING IOBLOCKS,R2                                              11300016
FORM4    EQU   *                                                        11400016
         LA    R3,FORMAT4              FORMAT 4 READ-IN AREA.           11500016
         ST    R3,WRTRD                STORE IN READ-DATA CCW.          11600016
         MVI   WRTRD,X'06'             SET OP CODE.                     11700016
         MVI   WRTRD+7,96              SET COUNT.                       11800016
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              11900016
         ST    R3,TIC                  STORE IN TIC.                    12000016
         MVI   TIC,8                   SET TIC OP CODE.                 12100016
         LA    R3,CCHHR                SEARCH ADDRESS.                  12200016
         ST    R3,SEARCH               STORE IN SEARCH CCW.             12300016
         MVI   SEARCH+4,X'40'          COMMAND CHAIN ON.                12400016
         MVI   SEARCH+7,5              SET COUNT.                       12500016
         MVI   SEARCH,X'31'            SET SEARCH OP CODE.              12600016
         SPACE 2                                                        12700016
         LA    R3,SEARCH               SEARCH CCW ADDRESS.              12800016
         ST    R3,IOBSTART             SET IN IOB.                      12900016
         SPACE                                                          13000016
*   STORE CCHHR OF VTOC IN IOB HERE.                                    13100016
         L     R3,UCBPTR                UCB ADDRESS.            YL02912 13200002
         USING UCB,R3                                                   13300016
         AIF   ('&LIB' EQ 'LIB2').X229300                       XL03912 13350003
         CLI   UCBID,MAINUCB           THIS A 2321.                     13400016
         BNE   P2321                   YES-GO PROCESS.                  13500016
.X229300 ANOP                                                   XL03912 13550003
         L     R0,SRTEFSCT             TTR OF VTOC.                     13600016
         SPACE                                                          13700016
FINDCCHH LA    R3,RBEXSAVE(R5)         EXTENTED SVRB SAVE AREA.         13800016
         L     R10,K36(R3)             GET RETURN ADDRESS.      YL02912 13850002
         MODESET EXTKEY=SUPR                                     YM1315 13860002
         STM   1,12,0(R3)              SAVE THE REGISTERS.              13900016
         MODESET EXTKEY=DATAMGT                                  YM1315 13950002
         SPACE                                                          14000016
         USING CVT,R15                                                  14100016
         L     R15,CVTPTR              CVT ADDRESS.                     14200016
         L     R15,CVTPCNVT            CONVERT ROUTINE ADDRESS.         14300016
         DROP  15                                                       14400016
         LA    R1,DEB                  ADDDRESS OF DEB.                 14500016
         LA    R2,IOBSEEK              TARGET AREA FOR MBBCCHHR.        14600016
         BALR  R14,R15                 CONVERT TTR TO MBBCCHHR.         14700016
         LM    1,12,0(R3)              RESTORE THE REGISTERS.           14800016
         SPACE                                                          14900016
*   READ IN THE FORMAT 4 DSCB HERE.                                   * 15000016
         BAL   R9,WRTREAD              READ IN FORMAT4 DSCB DATA FIELD. 15100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                15200016
         MVC   ALTINFO(6),ALTDATA      CCHH NEXT ALT. AND COUNT LEFT.   15300016
         SPACE                                                          15400016
ASSG1    CLC   ALTINFO+4(2),ZERO       ANY ALTERNATES LEFT.             15500016
         BNE   TESTALT                 YES-                             15600016
         SPACE                                                          15700016
EXIT16   BAL   R9,FREECORE             FREE THE WORK AREA.              15800016
         LA    R15,16                  SET RETURN CODE.                 15900016
         B     RETURN                  RETURN TO CALLER.        YL02912 16000002
         SPACE                                                          16100016
         AIF   ('&LIB' EQ 'LIB2').X229301                       XL03912 16150003
         USING DATACELL,R3                                              16200016
P2321    L     R0,DCELVTOC             TTR OF VTOC---2321.              16300016
         B     FINDCCHH                CONVERT TO CCHH.                 16400016
         DROP  R3                                                       16500016
         SPACE 2                                                        16600016
.X229301 ANOP                                                   XL03912 16650003
ASSG2    EQU   *                       SET UP ALTERNATE INFORMATION.    16700016
         L     R4,ALTPTR                PTR TO ALT INFO.        YL02912 16800002
         BAL   R14,CALLKEY              EXEC NEXT INSTR IN      YL02912 16820002
*                                        KEY OF CALLER.         YL02912 16840002
         LM    R6,R7,D0(R4)             GET ALTERNATE INFO.     YL02912 16860002
         STM   R6,R7,ALTINFO            SAVE ALTERNATE INFO.    YL02912 16900002
         B     ASSG1                   GO PROCESS THIS TRACK.           17000016
         SPACE                                                          17100016
TESTALT  EQU   *                                                YL02912 17200002
         L     R3,CCHHPARM              SELECTED TRACK ADDRESS. YL02912 17250002
         SPACE                                                          17300016
         USING UCB,R4                                                   17400016
         L     R4,UCBPTR                UCB ADDRESS.            YL02912 17500002
         SPACE                                                          17600016
         AIF   ('&LIB' EQ 'LIB2').X229303                       XL03912 17650003
         CLI   UCBID,MAINUCB           THIS A PRIMARY UCB.              17700016
         BE    TEST1                   YES-GET DEVICE TYPE CODE.        17800016
         LA    R6,DA2321               NO--MUST BE 2321.                17900016
         B     TEST2                   GO INDEX TO DEVICE CONSTANTS.    18000016
         SPACE                                                          18100016
.X229303 ANOP                                                   XL03912 18150003
TEST1    SR    R6,R6                   CLEAR                            18200016
         IC    R6,UCBTBYT4             DEVICE TYPE CODE.                18300016
         AIF   ('&LIB' EQ 'LIB1').X226602                       XL03130 18350003
         CLI   UCBTBYT4,WIN             IS THIS 3340?           XL03130 18360003
         BNE   TEST3                    NO, GO TEST MORE        XL03130 18370003
         L     R7,DEVMODP               ADDRESS OF DEV MOD NO.  YL02912 18372002
         BAL   R14,CALLKEY              EXECUTE NEXT INST       YL02912 18374002
*                                        IN THE KEY OF CALLER.  YL02912 18376002
         IC    R6,0(R7)                 YES, GET 3340 MOD NO.   XL03130 18380003
TEST3    EQU   *                                                XL03130 18392003
         LR    R7,R4                    SAVE UCB ADDRESS.       XM3801  18392403
.X226602 ANOP                                                   XL03130 18394003
         CLI   UCBTBYT4,DA2314         THIS A 2314.                     18400016
         BNE   TEST2                   NO--                             18500016
         OI    SW,D2314                YES-REMEMBER THIS.               18600016
         DROP  R4                                                       18700016
         SPACE                                                          18800016
TEST2    LA    R4,FIRSTALT-8           TABLE-8.                         18900016
         SLA   R6,3                    UCB CODE TIME 8.                 19000016
         LA    R6,0(R6,R4)             ADDRESS OF CONSTANTS/THIS DEVICE 19100016
         SPACE                                                          19200016
         USING UCB,R7                                          @Y30LSFY 19210003
         CLI   FUNCTION,SS1CONV         SS1 CONVERSION ?       @Y30LSFY 19250003
         BNE   NOTSSC                   NO, BRCH               @Y30LSFY 19260003
         LA    R6,SS1CONM              YES, LOAD SS1 ALT INFO. @Y30LSFY 19270003
         CLI   UCBTBYT4,ICEBERG         3330-1 DEVICE          @Y30LSFY 19272003
         BNE   NOTSSC                   NO - USE 3330 CONSTANT @Y30LSFY 19274003
         LA    R6,SS1CONI               SET ICEBERG ALT INFO   @Y30LSFY 19276003
         DROP  R7                                              @Y30LSFY 19278003
NOTSSC   EQU   *                                               @Y30LSFY 19280003
         CL    R3,0(R6)                INPUT CCHH IN ALTERNATE AREA.    19300016
         BNH   NOTALT                  NO--MUST BE PRIMARY TRACK.       19400016
         SPACE 2                                                        19500016
YESALT   EQU   *                       INPUT TRACK IS IN ALTERNATE AREA 19600016
         ST    R3,R0COUNT              INPUT CCHH//TEMPORARY STORAGE.   19700016
         MVC   CCHHR(4),R0COUNT        SEEK ADDRESS IN IOB.             19800016
         LA    R4,RDHA                 READ HA CCW.                     19900016
         ST    R4,IOBSTART             STORE ADDRESS IN IOB.            20000016
         LA    R4,HA                   READ-IN HA AREA.                 20100016
         ST    R4,RDHA                 STORE IN CCW.                    20200016
         MVI   RDHA,X'1A'              RESET OP CODE.                   20300016
         MVI   RDHA+7,5                SET CORRECT COUNT.               20400016
         AIF   ('&LIB' EQ 'LIB1').X322201                        XM4405 20550003
         BAL   R9,SAVESD               SEE IF SD BYTES.          XM4405 20560003
.X322201 ANOP                                                    XM4405 20570003
         MVI   RDHA+4,CHAIN            CHAIN BIT ON.           @ZM40450 20571003
         LA    R4,R0COUNT              COUNT READ-IN AREA.              20600016
         ST    R4,READR0               STORE IN CCW.                    20700016
         MVI   READR0,X'16'            RESET OP CODE.                   20800016
         MVI   READR0+7,4              SET COUNT IN CCW.                20900016
         MVI   READR0+4,SILI           SUPPRESS INCORRECT LENGTH.       21000016
         BAL   R9,WRTREAD              READ IN HA/R0 RECORDS.           21100016
         BAL   R9,WAIT                 AWAIT COMPLETIOM.                21200016
         CLC   HA+1(4),R0COUNT         HA AND R0 SAME CCHH.             21300016
         L     R3,R0COUNT              PRIMARY TRACK ADDRESS.           21400016
         BE    A                       TRACK NOT ASSIGNED.         1057 21470018
         OI    SW,DEFALT               SET DEFECTIVE ALTERNATE SW  1057 21540018
A        EQU   *                                                   1057 21610018
         BAL   R9,DOSA                 CHK TRK VIA S.A.        @ZM40450 21611003
         MVC   WRTHA(16),RDHA          REPOSITION THE CCWS.             21700016
         MVI   WRTHA,X'19'             SET WRITE HA OP CODE.            21800016
         MVI   WRTR0,X'15'             SET WRITE R0 OP CODE.            21900016
         MVI   WRTR0+4,CHAIN           SET CHAIN FLAG ON.               22000016
         MVI   WRTR0+7,16              SET COUNT IN CCW.                22100016
         MVI   R0COUNT+7,8             SET COUNT IN COUNT FIELD.        22200016
*                                                                       22250003
         LA    R4,RDHA                  MODIFY THE UNUSED CCW  @Z30RSAG 22260003
         ST    R4,R0DATA                TO A                   @Z30RSAG 22270003
         MVI   R0DATA,TICCMD            TIC CCW.               @Z30RSAG 22280003
*                                                                       22290003
         MVI   RDHA+4,CHAIN+SKIP       SKIP DATA TRANSFER.              22300016
         MVI   READR0+4,SKIP+SILI      SKIP DATA TRANSFER.              22400016
         OI    HA,DEFECT+ALT           INDICATE DEFECTIVE ALT. IN FLAG. 22500016
         SPACE                                                          22600016
         LA    R4,WRTHA                CHANNEL PROGRAM START.           22700016
         ST    R4,IOBSTART             SET CCW ST ART IN IOB.           22800016
         AIF   ('&LIB' EQ 'LIB1').X228301                       XL03130 22820003
         BAL   R9,WRTWIN                TEST IF 3340.           XL03130 22840003
.X228301 ANOP                                                   XL03130 22860003
         SPACE                                                          22900016
         BAL   R9,WRTREAD              FLAG THIS TRACK DEFECTIVE.       23000016
         BAL   R9,WAIT                 AWAIT I/O COMPLETION.            23100016
         MVI   RDHA+4,CHAIN            COMMAND CHAIN FLAGS TO CCW  1057 23120018
         MVI   READR0+4,SILI           SUPPRESS LENGTH IND. TO CCW 1057 23140018
         TM    SW,DEFALT               DEFECTIVE ALTERNATE SW SET  1057 23160018
         BO    NOTALT                  YES-GO SEE IF GOOD ALTERNATE1057 23180018
         SPACE                                                          23200016
         L     R10,PRMPTR               GET CALLER'S PARM PTR.  YL02912 23300002
         SR    R8,R8                    SET ZERO                YL02912 23340002
         BAL   R14,CALLKEY              EXECUTE NEXT INST       YL02912 23380002
*                                        IN THE KEY OF CALLER.  YL02912 23420002
         ST    R8,D4(R10)               IND NO ALT. ASSIGNED.   YL02912 23460002
         B     EXIT0                   RETURN TO CALLER.                23500016
         EJECT                                                          23505002
*********************************************************************** 23510002
*                                                                     * 23515002
*   THIS ROUTINE WILL OBTAIN THE KEY OF THE CALLER, EXECUTE THE       * 23520002
*   INSTRUCTION AFTER THE BRANCH AND LINK INSTRUCTION TO THIS         * 23525002
*   ROUTINE, RETURN TO DATA MANAGEMENT KEY AND FINALLY RETURN TO      * 23530002
*   ONE INSTRUCTION PAST THE ONE EXECUTED BY THIS ROUTINE.            * 23535002
*                                                                     * 23540002
*********************************************************************** 23545002
         SPACE 3                                                        23550002
CALLKEY  EQU   *                                                YL02912 23555002
         MODESET KEYADDR=KEY,WORKREG=15 GET CALLER'S KEY.       YL02912 23560002
         SPACE                                                          23565002
         EX    0,D0(R14)                DO INST PAST BAL.       YL02912 23570002
         SPACE                                                          23575002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY.    YL02912 23580002
         LA    R14,D4(R14)             SET BR REG TO INST+1.    YL02912 23582002
         BR    R14                      GO TO OBJECT INST+1.    YL02912 23585002
         EJECT                                                          23600016
*********************************************************************** 23700016
*                                                                     * 23800016
*   TEST IF THIS ALTERNATE TRACK IS A GOOD ONE.                         23900016
*                                                                     * 24000016
*********************************************************************** 24100016
         SPACE 2                                                        24200016
NOTALT   MVC   CCHHR(4),ALTINFO        CCHH OF NEXT ALT TO IOB.         24300016
         LA    R4,RDHA                 CCW ADDRESS.                     24400016
         ST    R4,IOBSTART             STORE IN IOB.                    24500016
         LA    R4,HA                   READ IN AREA.                    24600016
         ST    R4,RDHA                 STORE IN CCW.                    24700016
         MVI   RDHA,X'1A'              RESET OP CODE.                   24800016
         MVI   RDHA+7,5                SET COUNT IN CCW.                24900016
         SPACE                                                          25000016
         BAL   R9,WRTREAD              READ IN HOME-ADDRESS/ALTERNATE.  25100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                25200016
         SPACE                                                          25300016
         TM    HA,DEFECT               THIS A GOOD ALTERNATE.           25400016
         BZ    WRTPRIM                 YES-GO USE IT.                   25500016
         SPACE 2                                                        25600016
*********************************************************************** 25700016
*                                                                     * 25800016
*   THE NEXT AVAILABLE TRACK WAS DEFECTIVE. MUST FIND ANOTHER ONE.    * 25900016
*                                                                     * 26000016
*********************************************************************** 26100016
         SPACE 2                                                        26200016
GETNEXT  EQU   *                       FIND NEXT ALTERNATE TRACK.       26300016
         BAL   R9,UPCCHH               GET ADDRESS OF NEXT ALTERNATE.   26400016
         LTR   R4,R4                   BETTER TEST FOR ZERO HERE.       26500016
         BZ    EXIT16                  NONE LEFT---BETTER LEAVE.        26600016
         B     NOTALT                  GO SEE IF NEXT ALTERNATE IS GOOD 26700016
         EJECT                                                          26800016
*********************************************************************** 26900016
*                                                                     * 27000016
*   WRITE HOME ADDRESS/RECORD ZERO ON THE PRIMARY TRACK HERE.         * 27100016
*                                                                     * 27200016
*********************************************************************** 27300016
WRTPRIM  ST    R3,R0COUNT              TEMPORARY STORAGE.               27400016
         MVC   CCHHR(4),R0COUNT        PRIMARY CCHH TO IOB.             27500016
         AIF   ('&LIB' EQ 'LIB1').X322200                        XM4405 27550003
         BAL   R9,SAVESD               SEE IF SD BYTES.          XM4405 27560003
.X322200 ANOP                                                    XM4405 27570003
         MVC   HA+1(4),R0COUNT         SET IN CCHH OF HA.               27600016
         BAL   R9,DOSA                 GO DO SURFACE ANALYSIS  @Z30RSAG 27661003
         MVI   HA,DEFECT               SET FLAG IN HA.                  27700016
         MVC   R0COUNT(4),ALTINFO      CCHH OF ALT TO PRIMARY R0.       27800016
         SPACE                                                          27900016
         LA    R4,HA                   WRITE-OUT AREA.                  28000016
         ST    R4,WRTHA                STORE IN CCW.                    28100016
         MVI   WRTHA,X'19'             SET OP CODE.                     28200016
         MVI   WRTHA+4,CHAIN           CHAIN BIT ON.                    28300016
         MVI   WRTHA+7,5               SET COUNT IN CCW.                28400016
         SPACE                                                          28500016
         LA    R4,R0COUNT              COUNT FIELD ADDRESS.             28600016
         ST    R4,WRTR0                STORE IN CCW.                    28700016
         MVI   WRTR0,X'15'             RESET OP CODE.                   28800016
         MVI   WRTR0+4,CHAIN           CHAIN BIT ON.                    28900016
         MVI   WRTR0+7,16               SET COUNT TO 16          M0492  28960021
         MVI   READR0+7,16                IN CCW'S               M0492  29020021
         SPACE                                                          29022003
         LA    R4,RDHA                 PREPARE TO SETUP TIC    @Z30RSAG 29024003
         ST    R4,R0DATA               CHG CCW DATA ADDR       @VS40034 29026003
         MVI   R0DATA,TICCMD           RESET OPCODE            @Z30RSAG 29028003
         SPACE                                                          29100016
         MVC   RDHA(16),WRTHA          MOVE WRITE CCWS OVER READS.      29200016
         MVI   RDHA,X'1A'              SET READ HA OP CODE.             29300016
         OI    RDHA+4,SKIP             SKIP DATA TRANSFER.              29400016
         MVI   READR0,X'16'            SET READ R0 OP CODE.             29500016
         MVI   READR0+4,SKIP+SILI      SKIP DATA TRANSFER.              29600016
         SPACE                                                          29700016
         LA    R4,WRTHA                CHANNEL PROGRAM START.           29800016
         ST    R4,IOBSTART             STORE IN IOB.                    29900016
         MVC   R0COUNT+K4(K4),ROLENGTH  SET R0 COUNT             S21041 29950021
         AIF   ('&LIB' EQ 'LIB1').X226606                       XL03130 29960003
         BAL   R9,WRTWIN               TEST IF 3340/3350       @Z30RSAG 29970003
.X226606 ANOP                                                   XL03130 29980003
         SPACE 2                                                        30000016
         BAL   R9,WRTREAD              WRITE HA/R0 ON PRIMARY.          30100016
         BAL   R9,WAIT                 AWAIT COMPLETION.                30200016
         SPACE                                                          30300016
         L     R10,PRMPTR               GET CALLER'S PARM PTR   YL02912 30400002
         L     R8,ALTINFO               GET CCHH OF ALTERNATE   YL02912 30420002
         BAL   R14,CALLKEY              EXECUTE NEXT INST.      YL02912 30440002
*                                        IN THE KEY OF CALLER.  YL02912 30460002
         ST    R8,D4(R10)               SET CCHH IN PARM LIST.  YL02912 30480002
         MVI   HA,ALT                  SET FLAG TO SHOW ALTERNATE.      30500016
         EJECT                                                          30600016
*********************************************************************** 30700016
*                                                                     * 30800016
*   WRITE RECORD ZERO ON THE ALTERNATE TRACK HERE.                    * 30900003
*                                                                     * 31000016
*********************************************************************** 31100016
         SPACE 3                                                        31200016
WRTALT   MVC   CCHHR(4),ALTINFO        SEEK ADDRESS OF ALT. TO IOB.     31300016
         MVC   HA+1(4),ALTINFO         CCHH OF ALTERNATE.               31400016
         SPACE                                                          31500016
         ST    R3,R0COUNT              PRIMARY CCHH TO RECORD ZERO.     31600016
         MVI   R0COUNT+7,8             SET DATA LENGTH FOR EIGHT.       31700016
         MVI   WRTR0+7,16              SET CCW COUNT FOR 16.            31800016
         AIF   ('&LIB' EQ 'LIB1').X227910                       XL03130 31810003
         SPACE                                                          31820003
         LA    R4,HA+1                  GET SEARCH ADDR.        XL03130 31852003
         ST    R4,SCHHA                 SEARCH ADDR TO CCW.     XL03130 31854003
         MVI   SCHHA,SRCH               SET SEARCH HA.          XL03130 31860003
         MVI   SCHHA+4,CHAIN            CHAIN BIT ON.           XL03130 31862003
         MVI   SCHHA+7,C4               SET COUNT TO 4.         XL03130 31870003
         LA    R4,SCHHA                 SEARCH CCW ADDRESS.     XL03130 31880003
         ST    R4,IOBSTART              CCW ADDRESS TO IOB.     XL03130 31882003
         ST    R4,TICSRCH               SET TIC ADDRESS.        XL03130 31884003
         MVI   TICSRCH,TICCMD           SET TIC COMMAND.        XL03130 31886003
         L     R4,D0(R11)               GET UCB                 XL03130 31886103
         USING UCB,R4                                           XL03130 31886203
         CLI   UCBTBYT4,ICEBERG         IS THIS A 3330-1       @Z30RSAG 31886303
         BE    SKIPWIN                  NO, NEED TO FLAG ALT.   XL03130 31887803
         CLI   UCBTBYT4,WIN             IS THIS A 3340/3350?    XL03130 31889503
         BL    SKIPWIN                  NO, NEED TO FLAG ALT.   XL03130 31891003
         LA    R4,WRTR0                 GET WRITE R0 CCW ADDR.  XL03130 31892503
         ST    R4,WRTHA                 SET TIC ADDRESS.        XL03130 31894003
         MVI   WRTHA,TICCMD             CHANGE WRITE TO TIC.    XL03130 31895503
SKIPWIN  EQU   *                                                XL03130 31897003
.X227910 ANOP                                                   XL03130 31898503
         BAL   R9,WRTREAD              WRITE HA/R0 ON ALTERNATE.        32000016
         BAL   R9,WAIT                 AWAIT COMPLETION.                32100016
TESTREQ  EQU   *                                               @Y30LSFY 32150003
         CLI   FUNCTION,SS1CONV        SSI CONVERSION ?        @Y30LSFY 32160003
         BE    NOUPF4                   YES, BRCH              @Y30LSFY 32170003
         CLI   FUNCTION,ANALYZE         ANALYZE/FORMAT REQUEST? YL02912 32250002
         BNE   UPF4                    NO--NEED TO UPDATE FORMAT4 DSCB. 32300016
         SPACE                                                          32400002
NOUPF4   EQU   *                                               @Y30LSFY 32450003
         BAL   R9,UPCCHH               INCREMENT TO NEXT TRACK.         32500016
         L     R4,ALTPTR                GET ADDR OF ALT INFO.   YL02912 32600002
         MODESET EXTKEY=SUPR           ALLOW FETCH OF ALT INFO   YM4604 32650002
         MVC   0(6,R4),ALTINFO         UPDATE ALTERNATE TRACK INFO.     32700016
         MODESET EXTKEY=DATAMGT                                 YL02912 32750002
         SPACE                                                          32800002
EXIT0    BAL   R9,FREECORE             FREE THE WORKAREA.       YL02912 32900002
         SR    R15,R15                 SET RETURN CODE ZERO.    YL02912 33000002
RETURN   L     R14,RBEXSAVE+K36(R5)    GET  RETURN ADDRESS.     YL02912 33100002
         MODESET EXTKEY=SUPR                                    YM1315  33110102
         BR    R14                     RETURN TO CALLER.        YL02912 33150102
         EJECT                                                          33152102
         AIF   ('&LIB' EQ 'LIB1').X226607                       XL03130 33154102
*********************************************************************** 33160003
*                                                                     * 33170003
*   THIS ROUTINE WILL READ THE SKIP DISPLACEMENT BYTES OF A           * 33180003
*   DEFECTIVE TRACK ON 3340/3350 DEVICES.                      @Z30RSAG 33182003
*                                                                     * 33190003
*********************************************************************** 33192003
         SPACE 2                                                        33194003
SAVESD   EQU   *                                                 XM4405 33196003
         USING UCB,R7                                            XM4405 33198003
         CLI   UCBTBYT4,D3350          IS THIS A 3350 ?        @Z30RSAG 33198103
         BE    MADRID                  YES                     @Z30RSAG 33198203
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM4405 33198403
         BCR   NE,R9                   NO, RETURN.               XM4405 33198803
         SPACE                                                          33199203
MADRID   EQU   *                                               @Z30RSAG 33199303
         LA    R4,SNSBYTES             GET ADDR FOR SNS INFO.    XM4405 33205603
         ST    R4,READR0               SET IN CCW.               XM4405 33206703
         MVI   READR0,SENSE            SET CCW TO SENSE CMD.     XM4405 33207803
         MVI   READR0+C7,L24           SET FOR 24 SENSE BYTES.   XM4405 33208903
         SPACE                                                          33210003
         MVI   RDHA+K4,CHAINSD         CHAIN READ HA TO SENSE.   XM4405 33211103
         SPACE                                                          33212203
         EXCP  IOB                     GET SKIP DISPLACEMENT.    XM4405 33213303
         TM    ECB,COMPLETE            OPERATION COMPLETE?       XM4405 33214403
         BO    CKRTN                   YES, CHECK CONDITION.     XM4405 33215503
         WAIT  ECB=ECB                 NO, PAUSE.                XM4405 33216603
         SPACE                                                          33217703
CKRTN    EQU   *                                                 XM4405 33218803
         CLI   ECB,GOOD                GOOD COMPLETION?          XM4405 33219903
         BCR   EQ,R9                   YES, GOT BYTES, RETURN.   XM4405 33221003
         XC    SDBYTES(L2),SDBYTES     NO, INSURE ZERO SD.       XM4405 33222103
         BR    R9                      NOW RETURN.               XM4405 33223203
         EJECT                                                          33224303
*********************************************************************** 33233803
*                                                                     * 33234003
*   WRITE HOME ADDRESS/RECORD ZERO ON A DEFECTIVE TRACK FOR A 3340.   * 33234203
*        OR FOR A 3350.                                        @X50RSAG 33235403
*                                                                     * 33237403
*********************************************************************** 33239403
         SPACE 2                                                        33239803
WRTWIN   EQU   *                                                XL03130 33240603
         USING UCB,R7                                           XL03130 33243003
         CLI   UCBTBYT4,D3350          IS IT 3350 ?            @X50RSAG 33245403
         BE    MAD                     YES                     @X50RSAG 33247803
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 33250203
         BCR   NE,R9                    NO, RETURN.             XL03130 33252603
         MVC   WINHA,SDBYTES            SET SKIP DISPLACEMENT.   XM4405 33255003
         LA    R4,WINHA                 WRITE HA OUT AREA.      XL03130 33257403
         ST    R4,WRTHA                 STORE IN CCW.           XL03130 33259803
         MVI   WRTHA+7,C7               SET COUNT IN CCW.       XL03130 33262203
         MVI   WRTHA,WRITE              RESTORE WRITE COMMAND.  XL03130 33264603
         BR    R9                       RETURN.                 XL03130 33267003
MAD      EQU   *                                               @X50RSAG 33269403
         LA    R4,MADSD                POINT TO AREA FR 3350   @X50RSAG 33271803
         ST    R4,WRTHA                STORE IN WRTHA          @X50RSAG 33274203
         MVI   WRTHA+C7,11             SET COUNT FOR 3350      @X50RSPC 33276603
         MVI   WRTHA,WRITE             SET COMMAND             @X50RSAG 33279003
         BR    R9                      RETURN                  @X50RSAG 33281403
         SPACE 2                                                        33283803
WINERR   EQU   *                        SKIP DISPLACEMENT IS    XL03130 33286203
*                                       DETERMINED HERE.        XL03130 33288603
         L     R4,IOBCSW                GET CCW ADDR FROM IOB.  XL03130 33291003
         SL    R4,CCWLEN                BACKUP TO LAST CCW.     XL03130 33293403
         SPACE 2                                                        33295803
         LR    R3,R9                    SAVE R9 CONTENTS       @ZM42054 33297803
         BAL   R9,WRTWIN                CHK FOR WRHA IN CHN    @ZM42054 33298203
*                                       RETURN HERE IF WRHA EXISTS      33300603
         LR    R9,R3                    RELOAD R9 CONTENTS     @ZM42054 33300703
         LA    R3,HASD                  HOME ADDR SKIP DISP.    XL03130 33300803
         CLI   0(R4),RDHACOM            WAS IT A HA ERROR?      XL03130 33307003
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33313203
         SPACE 2                                                        33319403
         LA    R3,RZCSD                 REC ZERO CNT SKIP DISP. XL03130 33325603
         CLI   IOBCSW+7,C8              RESIDUAL COUNT EQ 8?    XL03130 33331803
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33338003
         SPACE 2                                                        33344203
         LA    R3,RZDSD                 NO, SET R0 DATA SKIP.   XL03130 33350403
SETSD    EQU   *                                                XL03130 33356603
         STH   R3,WINHA                 SET SKIP DISPLACEMENT.  XL03130 33362803
         SPACE 2                                                        33369003
         B     REWRITE                  WRITE HA/R0 AGAIN.      XL03130 33375203
TRKRECL  EQU   *                                               @Z30RSAG 33377203
         BAL   R9,FREECORE             FREE IT                 @Z30RSAG 33379203
         LA    R15,8                   CODE=RECLAIMED          @Z30RSAG 33381203
         B     RETURN                                          @VS40037 33381303
         SPACE 2                                                        33383303
MADERR   EQU   *                        SKIP DISPLACEMENT IS    XL03130 33383703
*                                       DETERMINED HERE.        XL03130 33384103
         L     R4,IOBCSW                GET CCW ADDR FROM IOB.  XL03130 33384503
         SL    R4,CCWLEN                BACKUP TO LAST CCW.     XL03130 33384903
         SPACE 2                                                        33385003
         LR    R3,R9                    SAVE R9 CONTENTS       @ZM42054 33387003
         BAL   R9,WRTWIN                CHK FOR WRHA IN CHN    @ZM42054 33391003
*                                       RETURN HERE IF WRHA EXISTS      33393003
         LR    R9,R3                    RELOAD R9 CONTENTS     @ZM42054 33395003
         LA    R3,MHASD                 HOME ADDR SKIP DISP.    XL03130 33398003
         CLI   0(R4),RDHACOM            WAS IT A HA ERROR?      XL03130 33404003
         BE    SETIT                    YES, GO SET SKIP DISP.  XL03130 33410003
         SPACE 1                                                        33416003
         LA    R3,MRZCSD                REC ZERO CNT SKIP DISP. XL03130 33422003
         CLI   IOBCSW+7,C8              RESIDUAL COUNT EQ 8?    XL03130 33428003
         BE    SETSD                    YES, GO SET SKIP DISP.  XL03130 33434003
         SPACE 2                                                        33440003
         LA    R3,MRZDSD                NO, SET R0 DATA SKIP.   XL03130 33446003
SETIT    EQU   *                                                XL03130 33452003
         STH   R3,WINHA                 SET SKIP DISPLACEMENT.  XL03130 33458003
         SPACE 2                                                        33464003
         B     REWRITE                  WRITE HA/R0 AGAIN.      XL03130 33470003
         EJECT                                                          33476003
.X226607 ANOP                                                   XL03130 33482003
*********************************************************************** 33488003
*                                                                     * 33494003
*   UPDATE THE FORMAT 4 DSCB HERE.                                    * 33500016
*                                                                     * 33600016
*********************************************************************** 33700016
         SPACE 3                                                        33800016
UPF4     EQU   *                       UPDAYE THE FORMAT 4 DSCB HERE.   33900016
         BAL   R9,UPCCHH               UPDATE TRACK ADDRESS.            34000016
         MVC   ALTDATA(6),ALTINFO      UPDATE ALTERNATE INFORMATION.    34100016
         LA    R3,SEARCH               CHANNEL PROGRAM ADDRESS.         34200016
         ST    R3,IOBSTART             STORE IN IOB.                    34300016
         MVI   WRTRD,X'05'             SET OP CODE FOR WRITE.           34400016
         MVC   CCHHR(4),VTOCCCHH       SEEK//SEARCH ADDRESS.            34500016
         BAL   R9,WRTREAD              WRITE OUT NEW FORMAT 4 DSCB DATA 34600016
         BAL   R9,WAIT                 AWAIT COMPLETION.                34700016
         MVI   WRTRD,X'06'             SET OP CODE FOR READ.            34800016
         OI    WRTRD+4,SKIP            SKIP DATA TRANSFER.              34900016
         BAL   R9,WRTREAD              READ BACK CHECK DATA.            35000016
         BAL   R9,WAIT                 AWAIT COMPLETION.                35100016
         B     EXIT0                   GO RETURN TO CALLER.             35200016
         SPACE                                                          35300016
*********************************************************************** 35400016
*                                                                     * 35500016
*   INCREMENT TO THE NEXT SEQUENTIAL TRACK HERE.                      * 35600016
*                                                                     * 35700016
*********************************************************************** 35800016
         SPACE 3                                                        35900016
UPCCHH   L     R4,ALTINFO              ALTERNATE TRACK USED.            36000016
         CLC   ALTINFO+3(1),3(R6)      THIS LAST TRACK OF CYLINDER.     36100016
         BC    4,CEXIT                 NO--                             36200016
         SPACE                                                          36300016
         A     R4,4(R6)                YES-ADD CYLINDER CONVERSION.     36400016
         AIF   ('&LIB' EQ 'LIB2').X228300                       XL03912 36450003
         CLI   ALTINFO+2,X'04'         2321 AND LAST CYLINDER.          36500016
         BC    7,CEXIT2                NO--                             36600016
         AL    R4,STC2321              YES-INCREMENT STRIP.             36800016
         CLI   ALTINFO+1,X'09'         LAST STRIP                       37000016
         BC    7,CEXIT2                NO--                             37100016
         AL    R4,SCC2321              YES--INCREMENT SUBCELL.          37200016
.X228300 ANOP                                                   XL03912 37250003
         B     CEXIT2                  GO STORE VALUE AND RETURN.       37300016
CEXIT    AL    R4,F1                   INCREMENT TO NEXT TRACK.         37500016
CEXIT2   ST    R4,ALTINFO              SAVE THIS INFORMATION.           37600016
         LH    R4,ALTINFO+4            CURRENT ALTERNATE COUNT.         37800016
         BCTR  R4,0                    DECREMENT BY ONE.                37900016
         STH   R4,ALTINFO+4            SAVE UPDATED COUNT.              38000016
         BR    R9                      RETURN.                          38100016
         EJECT                                                          38200016
DATACHN  EQU   X'80'                                           @Z30RSAG 38201003
*************************************************************  @Z30RSAG 38250003
*                                                              @Z30RSAG 38260003
*   THIS SECTION PERFORMS SURFACE ANALYSIS ON 3350 DEVICES     @Z30RSAG 38270003
*                                                              @Z30RSAG 38280003
*************************************************************  @Z30RSAG 38290003
         SPACE 2                                               @Z30RSAG 38292003
DOSA     EQU   *                                               @Z30RSAG 38294003
         USING UCB,R7                                          @ZM40450 38295003
         CLI   UCBTBYT4,D3350           3350 DEVICE ?          @ZM40450 38296003
         BNER  R9                       NO, BYPASS S.A.        @ZM40450 38297003
         DROP  R7                                              @ZM40450 38298003
         CLI   0(R11),X'1F'             GETALT REQUEST?        @ZM42054 38301603
         BNER  R9                       NO, EXIT               @ZM42054 38303603
         MVC   MADSD(L6),MADSDB        SAVE SD BYTES           @X50RSPC 38308703
         MVI   HA,X'00'                CLEAR HA FLAG BYTE      @X50RSAG 38312203
*   SET UP SEARCH HA                                           @X50RSAG 38315703
         LA    R4,HA+1                 POINT TO HA AREA        @X50RSAG 38319203
         ST    R4,SCHHA                STORE ADR IN SRCH       @X50RSAG 38322703
         MVI   SCHHA,SRCH              SET SRCH HA CMND        @X50RSAG 38326203
         LA    R4,4                                            @X50RSAG 38329703
         ST    R4,SCHHA+L4             SET CCW DATA LENGTH     @Z30RSAG 38333203
         MVI   SCHHA+L4,CHAIN          SET CMND CHAINING       @Z30RSAG 38343203
*   SET UP TIC                                                 @Z30RSAG 38353203
         LA    R4,SCHHA                                        @Z30RSAG 38363203
         ST    R4,IOBSTART             UPDATE IOBCCW PTR       @Z30RSAG 38365203
         ST    R4,TICSRCH               AND TIC ADR            @Z30RSAG 38365603
         MVI   TICSRCH,X'08'           SET COMMAND             @Z30RSAG 38366003
*   SET UP WRITE HA                                            @Z30RSAG 38366403
         LA    R4,MADSD                GET THE ADDRESS         @Z30RSAG 38366503
         ST    R4,WRTHA                STORE IN COMMAND        @Z30RSAG 38366603
         MVI   WRTHA,X'19'             SET COMMAND             @Z30RSAG 38377703
         LA    R4,11                   COUNT FOR 3350          @VS40430 38387703
         STH   R4,WRTHA+L6             UPDATE LENGTH           @Z30RSAG 38387803
         MVI   WRTHA+L4,CHAIN          SET CMND CHAINING       @Z30RSAG 38388103
*   SET UP WRITE R0 MAX                                        @Z30RSAG 38388503
         LA    R3,R0COUNT              MOVE IN R0 COUNT FIELD  @Z30RSAG 38388603
         ST    R3,WRTR0                                        @Z30RSAG 38388803
         MVI   WRTR0,X'15'             SET COMMAND             @Z30RSAG 38392503
         LA    R4,8                                            @Z30RSAG 38392903
         ST    R4,WRTR0+L4                                     @Z30RSAG 38393303
         MVI   WRTR0+L4,DATACHN                                @Z30RSAG 38393703
         L     R3,8(R11)               GET BIT PATTERN ADDRESS @Z30RSAG 38394103
         ST    R3,R0DATA               SET UP CCW DATA ADDRESS @Z30RSAG 38394203
         L     R3,R0COUNT              RELOAD PRIMARY CCHH     @ZM43013 38394303
         MVI   R0DATA,X'15'            SET CCW OPCODE          @Z30RSAG 38394403
         LH    R4,MADCAP               3350 TRACK SIZE         @Z30RSAG 38394503
         ST    R4,R0DATA+L4            SET CCW DATA LENGTH     @Z30RSAG 38394903
         ST    R4,R0COUNT+L4           SET CCW DATA LENGTH     @Z30RSAG 38395303
         MVI   R0DATA+L4,CHAIN         SET CMND CHAINING       @Z30RSAG 38395703
*   SET UP READ HA                                             @Z30RSAG 38396103
         MVC   RDHA(L8),WRTHA          COPY CCW                @Z30RSAG 38396203
         MVI   RDHA,X'1A'              SET COMMAND             @Z30RSAG 38422103
         MVI   RDHA+C7,5                RESET DATA LEN         @Z30RSAG 38424103
         MVI   RDHA+L4,CHAINSD+SILI     RESET FLAGS            @Z30RSAG 38426103
*   SET UP READ R0 MAX                                         @Z30RSAG 38432103
         MVC   READR0(L8),WRTR0        COPY CCW                @Z30RSAG 38442103
         MVI   READR0,X'16'            SET COMMAND             @Z30RSAG 38444103
         MVI   READR0+L4,SILI+SKIP     STOP COMMAND CHAIN      @Z30RSAG 38446103
*   EXECUTE THE CHANNEL PROGRAM                                @Z30RSAG 38448103
         MODESET EXTKEY=SUPR                                            38450103
         EXCP  IOB                                             @Z30RSAG 38456703
         MODESET EXTKEY=DATAMGT                                         38457103
         WAIT  ECB=ECB                                         @Z30RSAG 38458703
         CLI   ECB,GOOD                OK ?                    @Z30RSAG 38460703
         BNER  R9                      NO                      @Z30RSAG 38462703
         LA    R4,R0COUNT                                      @Z30RSAG 38480003
         STCM  R4,R7,WRTR0+1           STORE COUNT IN CMND     @VS40037 38482003
         LA    R4,8                    SET DATA LENGTH FOR R0  @ZM43013 38482103
         ST    R4,R0COUNT+4            STORE IN COUNT FLD      @ZM43013 38482203
         MVI   WRTR0+R7,L16            RESET CCW LENGTH        @Z30RSAG 38482403
         MVI   WRTR0+L4,SILI           STOP CHAIN              @Z30RSAG 38482503
         XC    ECB,ECB                 CLEAR IT                @Z30RSAG 38482603
         MVI   IOB,X'42'                                       @Z30RSAG 38482703
         EXCP  IOB                                             @Z30RSAG 38506103
         WAIT  ECB=ECB                                         @Z30RSAG 38516103
         B     TRKRECL                 EXIT WITH 823I MSG      @Z30RSAG 38526103
         EJECT                                                 @Z30RSAG 38528103
*********************************************************************** 38529803
*                                                                     * 38553203
*   DEVICE CONSTANTS---ORDERED BY UCB TYPE CODES.                       38576603
*                                                                     * 38600016
*********************************************************************** 38700016
         SPACE 3                                                        38800016
         DS    0F                                                       38900016
         AIF   ('&LIB' EQ 'LIB1').X226603                       XL03130 38906003
FIRSTALT DC    X'015B000B'              3340 MOD 1 LAST PRIMARY XL03130 38930003
         DC    X'0000FFF5'              3340 CYLINDER CONVERT   XL03130 38936003
         SPACE                                                          38942003
         DC    X'02B7000B'              3340 MOD 2 LAST PRIMARY XL03130 38948003
         DC    X'0000FFF5'              3340 CYLINDER CONVERT   XL03130 38954003
         SPACE                                                          38960003
         DS    10F                      CODES 3 THRU 7 NOT USED.XL03130 38966003
*                                       2305 SUPPORT IS 308B.   XL03130 38972003
         AGO   .X226604                                         XL03130 38978003
.X226603 ANOP                                                   XL03130 38984003
FIRSTALT DC    X'00C70009'             2311 LAST PRIMARY.               39000016
CONVCYL  DC    X'0000FFF7'             2311 CYLINDER CONVERSION.        39100016
         SPACE 1                                                        39200016
         DS    4F                      2301/2303 NOT APPLICABLE.        39300016
         SPACE                                                          39400016
         DC    X'00F5002D'             2302 LAST PRIMARY.               39500016
         DC    X'0000FFD3'             2302 CYLINDER CONVERSION.        39600016
         SPACE 1                                                        39700016
         DC    X'13050413'             2321 LAST PRIMARY.               39800016
         DC    X'000000ED'             2321 CYLINDER CONVERSION.        39900016
         SPACE                                                          40000016
         DS    4F                      CODES 6 AND 7 NOT USED.          40100016
*                             2305 SUPPORT IS HANDLED IN 308B    X02114 40150021
.X226604 ANOP                                                           40170003
         SPACE                                                          40200016
         DC    X'00C70013'             2314 LAST PRIMARY.               40300016
         DC    X'0000FFED'             2314 CYLINDER CONVERSION.        40400016
         SPACE                                                          40420020
         DC    X'01930012'              CCHH AT LAST PRIMARY     M5448  40440020
         DC    X'0000FFEE'              CYL INCREMENT            M5448  40460020
         SPACE                                                          40500016
         AIF   ('&LIB' EQ 'LIB1').X227911                       XL03145 40510003
         DS    2F                      CODE A NOT USED         @Z30RSAG 40520003
         SPACE                                                          40530003
         DC    X'022A001D'             3350 LAST PRIMARY       @Z30RSAG 40532003
         DC    X'0000FFE3'             3350 CYL CONVERSION     @Z30RSAG 40534003
         SPACE 1                                               @Z30RSAG 40536003
         DS    2F                      CODE C NOT USED         @Z30RSAG 40538003
         DC    X'03270012'             3330-1 LAST PRIMARY.     XL03145 40540003
         DC    X'0000FFEE'             3330-1 CYL CONVERSION.   XL03145 40550003
         SPACE                                                          40560003
*        SS/1 ALTERNATE TRACK INFORMATION                      @Y30LSFY 40562003
SS1CONM  DC    X'01980012'              CCHH AT LAST PRIMARY   @Y30LSFY 40564003
         DC    X'0000FFEE'              CYL INCREMENT          @Y30LSFY 40566003
SS1CONI  DC    X'03280012'              CCHH AT LAST PRIMARY   @Y30LSFY 40568003
         DC    X'0000FFEE'              CYL INCREMENT          @Y30LSFY 40568403
         AGO   .X227912                                         XL03145 40570003
.X227911 ANOP                                                   XL03145 40580003
SCC2321  DC    X'00F60000'             INCREMENT TO NEXT SUBCELL.       40600016
STC2321  DC    X'0000FB00'             INCREMENT TO NEXT STRIP.         40700016
.X227912 ANOP                                                   XL03145 40750003
         EJECT                                                          40800016
WRTREAD  EXCP  IOB                     START THE I/O OPERATION.         40900016
         BR    R9                      RETURN.                          41000016
         SPACE                                                          41100002
WAIT     TM    ECB,COMPLETE            THIS OPERATION COMPLETE.         41200016
         BO    TEST                    YES-TEST ITS STATUS.             41300016
         WAIT  ECB=ECB                 NO--AWAIT COMPLETION.            41400016
TEST     CLI   ECB,GOOD                EVERYTHING A-OK.                 41500016
         BCR   8,R9                    YES-RETURN.                      41600016
         TM    IOBCSW+4,UE             THIS A UNIT EXCEPTION.           41700016
         BCR   1,R9                    YES-//THIS IS OKAY.              41800016
         TM    RETSW,MOVEHA            THIS THE 2ND ATTEMPT.   @ZA04363 41900003
         BO    IOERR                   YES--CANNOT TRY AGAIN.           42000016
         AIF   ('&LIB' EQ 'LIB1').X227601                               42210003
         CLI   UCBTBYT4,D3350           IS THIS A 3350?         XL03130 42212003
         BE    MADERR                   YES GO FIND SKIP DISP.  XL03130 42214003
         CLI   UCBTBYT4,WIN             IS THIS A 3340?         XL03130 42220003
         BE    WINERR                   YES GO FIND SKIP DISP.  XL03130 42230003
.X227601 ANOP                                                           42250003
REWRITE  EQU   *                                               @ZM42054 42260003
         OI    RETSW,MOVEHA            SET FLG,MOVE DOWN TRK.  @ZA04363 42300003
         EXCP  IOB                     REPEAT THE REQUEST.              42400016
         B     WAIT                    AWAIT COMPLETION.                42500016
         SPACE                                                          42600002
FREECORE EQU   *                       RELEASE THE CORE HERE.           42700016
         LH    R3,SIZE                 SIZE OF AREA TO RELEASE.         42800016
         FREEMAIN R,LV=(3),A=(2),SP=229                         YL02912 42900002
         LA    R3,ENDLIST-PARMLIST      SIZE OF PARM LIST.      YL02912 42930002
         FREEMAIN R,LV=(3),A=(11),SP=229 FREE PARM LIST.        YL02912 42960002
         BR    R9                      RETURN.                          43000016
         SPACE                                                          43100016
IOERR    EQU   *                                                        43200016
         BAL   R9,FREECORE              RELEASE GOTTEN CORE.    YL02912 43250002
         LA    R15,12                  SET RETURN CODE.                 43300016
         B     RETURN                  RETURN TO CALLER.        YL02912 43400002
         EJECT                                                          43450002
F1       DC    F'1'                    TRACK INCREMENT CONSTANT.        43600016
MADCAP   DC    1H'19069'               3350 TRACK SIZE         @X50RSPC 43710003
ROLENGTH DC    1F'8'                    R0 KEY DATA L            S21041 43730021
ZERO     DC    1H'0'                   COMPARE CONSTANT.        YL02912 43740002
MAINT    DS    60X                      ZAP FIX AREA.           YL02912 43750002
K4       EQU   4                        DISPLACEMENT CON         S21041 43760021
         AIF   ('&LIB' EQ 'LIB1').X227602                               43763003
C4       EQU   X'04'                    COUNT FOR SEARCH.       XL03130 43766003
EQ       EQU   X'08'                    EQUAL CONDITION.         XM4405 43768003
NE       EQU   X'07'                    NOT EQUAL CONDITION.    XL03130 43769003
C7       EQU   X'07'                    COUNT FOR 3340 WRT HA.  XL03130 43772003
C8       EQU   X'08'                    COUNT COMPARAND.        XL03130 43775003
L2       EQU   2                        LENGTH CONSTANT.         XM4405 43783903
L4       EQU   4                        LENGTH CONSTANT        @Z30RSAG 43785903
L6       EQU   6                        LENGTH CONSTANT        @Z30RSAG 43786303
L8       EQU   8                        LENGTH CONSTANT        @Z30RSAG 43787903
L24      EQU   24                       LENGTH CONSTANT.         XM4405 43793203
HASD     EQU   110                      HOME ADDR SKIP DISP.    XL03130 43793302
RZCSD    EQU   200                      REC ZERO CNT SKIP DISP. XL03130 43793602
RZDSD    EQU   285                      REC ZERO DATA SKIP DISP XL03130 43794002
MHASD    EQU   124                      HOME ADDR SKIP DISP.   @Z30RSAG 43794203
MRZCSD   EQU   200                      REC ZERO CNT SKIP DISP @Z30RSAG 43794303
MRZDSD   EQU   310                      REC ZERO DATA SD       @Z30RSAG 43794603
CCWLEN   EQU   ROLENGTH                 CCW LENGTH.             XL03130 43794903
SENSE    EQU   X'04'                    SENSE COMMAND.           XM4405 43795202
WRITE    EQU   X'19'                    WRITE HA COMMAND.       XL03130 43795602
SRCH     EQU   X'39'                    SEARCH HA COMMAND.      XL03130 43796002
RDHACOM  EQU   X'1A'                    READ HA COMMAND.        XL03130 43796202
TICCMD   EQU   X'08'                    TIC COMMAND.            XL03130 43798602
         SPACE 3                                                        43800602
*********************************************************************** 43800802
*                                                                     * 43801402
*   PARAMETER LIST DSECT                                              * 43802002
*                                                                     * 43802602
*********************************************************************** 43803202
         SPACE 2                                                        43803802
PARMLIST DSECT                                                  YL02912 43804402
FUNCTION DS    0F                       CALLER'S FUNCTION.      YL02912 43805002
UCBPTR   DS    F                        UCB POINTER.            YL02912 43805602
DCBPTR   DS    F                        DCB POINTER OR          YL02912 43806202
CCHHPARM EQU   DCBPTR                   ADDR OF TRACK OR        YL02912 43806802
SERPTR   EQU   DCBPTR                   ADDR OF VOL SER.        YL02912 43807402
ALTPTR   DS    F                        ADDR OF ALTINFO OR      YL02912 43808002
NEWCCHH  EQU   ALTPTR                   NEW TRACK ADDRESS.      YL02912 43808602
DEBPTR   DS    F                        DEB POINTER OR          YL02912 43809202
DEVMODP  EQU   DEBPTR                   ADDR OF 3340 MODEL NO.  YL02912 43809802
PRMPTR   DS    F                        ADDR OF CALLER'S LIST.  YL02912 43810402
KEY      EQU   PRMPTR                   KEY OF CALLER.          YL02912 43811002
IGCRESV  DS    4F                       RESERVED                 YM1129 43823402
ENDLIST  EQU   *                        PARAMETER LIST END.     YL02912 43849002
         EJECT                                                          43874502
.X227602 ANOP                                                   XL03130 43882203
         EJECT                                                          43891103
IOBLOCKS DSECT                                                          43900016
MYDEB    EQU   *                       DEB DEFINITION.                  44000016
DEBEOEA  DS    1F                      END-OF-EXTENT.                   44100016
DEBSIOA  DS    1F                      START I/O.                       44200016
DEBPCIA  DS    1F                      PCI.                             44300016
DEBCEA   DS    1F                      CHANNEL END.                     44400016
DEBXCEA  DS    1F                      ABNORMAL END.                    44500016
         DS    CL12                                                     44600016
DEBLNGTH DS    CL1                     DEB LENGTH(DOUBLE WORDS)         44700016
         DS    CL3                                                      44800016
DEB      EQU   *                       DEB PROPER                       44900016
DEBNMSUB DS    CL1                     OPEN SUBROUTINES.                45000016
DEBTCBAD DS    CL3                     TCB ADDRESS.                     45100016
DEBAMLNG DS    CL1                     LENGTH ACCESS METHOD.            45200016
DEBDEBAD DS    CL3                     NEXT DEB ADDRESS.                45300016
DEBOFLGS DS    CL1                     DATA SET FLAGS.                  45400016
DEBIRBAD DS    CL3                     IRB ADDRESS.                     45500016
DEBOPATB DS    CL1                     TYPE OF I/O.                     45600016
DEBSYSPG DS    CL3                     IOB PURGE ADDRESS.(SYSTEM)       45700016
DEBNMEXT DS    CL1                     NO. OF EXTENTS.                  45800016
DEBUSRPG DS    CL3                     IOB USER PURGE ADDRESS.          45900016
DEBPRIOR DS    CL1                     ZERO                             46000016
DEBECBAD DS    CL3                     PURGE ECB.                       46100016
DEBDEBID DS    CL1                     PROTECT KEY//ID.                 46200016
DEBDCBAD DS    CL3                     DCB ADDRESS.                     46300016
DEBEXSCL DS    CL1                     EXTENT SCALE.                    46400016
DEBAPPAD DS    CL3                     APPENDAGE VECTOR TABLE.          46500016
DEBDVMOD DS    CL1                     FILE MASK.                       46600016
DEBUCBAD DS    CL3                     UCB ADDRESS.                     46700016
DEBBINNO DS    CL2                     BIN NO. FOR 2321.                46800016
DEBSTRCC DS    CL2                     CYLINDER START.                  46900016
DEBSTRHH DS    CL2                     HEAD START.                      47000016
DEBENDCC DS    CL2                     CYLINDER END.                    47100016
DEBENDHH DS    CL2                     HEAD END.                        47200016
DEBNMTRK DS    CL2                     NUMBER OF TRACKS.                47300016
         DS    CL20                                                     47400016
DEBEND   DS    0C                      END OF DEB.                      47500016
         EJECT                                                          47600016
ECB      DS    1F                      ECB HERE.                        47700016
IOB      EQU   *                       IOB HERE.                        47800016
IOBFLAG1 DS    CL1                     FLAG1                            47900016
IOBFLAG2 DS    CL1                     FLAG2.                           48000016
IOBSENS0 DS    CL1                     SENSE BYTE ZERO.                 48100016
IOBSENS1 DS    CL1                     SENSE BYTE ONE.                  48200016
IOBECBAD DS    CL4                     ADDRESS OF ECB.                  48300016
IOBCSW   DS    CL8                     STATUS WORDS.                    48400016
IOBSTART DS    CL4                     CHANNEL PROGRAM ADDRESS.         48500016
IOBDCBPT DS    CL4                     ADDRESS OF DCB.                  48600016
IOBRESTR DS    CL4                     RESTART ADDRESS.                 48700016
IOBINCAM DS    CL2                     BLOCK COUNT.                     48800016
IOBERRCT DS    CL2                     ERROR COUNT.                     48900016
IOBSEEK  DS    CL8                     SEEK ADDRESS.                    49000016
CCHHR    EQU   IOBSEEK+3               SEARCH ADDRESS.                  49100016
DCB      DS    1F                      DEB ADDRESS.                     49200016
ALTINFO  DS    1D                      KEEP ALTERNATE TRACK INFO HERE.  49300016
         AIF   ('&LIB' EQ 'LIB1').X302301                       XL03130 49350003
SCHHA    DS    1D                      SEARCH HOME ADDRESS.     XL03130 49360003
TICSRCH  DS    1D                       TIC CCW.                XL03130 49362003
.X302301 ANOP                                                   XL03130 49370003
WRTHA    DS    1D                      WRITE HOME ADDRESS.              49400016
WRTR0    DS    1D                      WRITE RECORD ZERO.               49500016
R0DATA   DS    1D                                              @Z30RSAG 49550003
RDHA     DS    1D                      READ HOME ADDRESS.               49600016
READR0   DS    1D                      READ RECORD ZERO.                49700016
         AIF   ('&LIB' EQ 'LIB1').X227800                       XL03130 49750003
         DS    CL6                      RESERVED.               XL03130 49760003
MADSD    DS    CL4                     ADTL 3350 SD BYTES      @X50RSPC 49762003
WINHA    DS    CL2                      3340 HOME ADDRESS.      XL03130 49770003
.X227800 ANOP                                                   XL03130 49780003
HA       DS    CL5                     HOME ADDRESS.                    49800016
SW       DS    CL1                     SWITCH.                          49900016
D2314    EQU   X'80'                   2314 DEVICE.                     50000016
D2321    EQU   X'40'                   2321 DEVICE.                     50100016
DEFALT   EQU   X'02'                                               1057 50150018
RETRY    EQU   X'01'                   GIVE IT ONE MORE TRY.            50200016
SIZE     DS    CL2                     SIZE OF GETMAIN AREA.            50300016
R0COUNT  DS    1D                      RECORD ZERO COUNT FIELD.         50400016
         DS    1D                      RECORD ZERO DATA  FIELD.@Z30RSAG 50500003
         AIF   ('&LIB' EQ 'LIB1').X322202                        XM4405 50550003
SNSBYTES DS    CL24                    SNS BYTE READ IN AREA.    XM4405 50560003
MADSDB   EQU   SNSBYTES+18             ADTL 3350 SD BYTES      @X50RSPC 50562003
SDBYTES  EQU   SNSBYTES+22             SKIP DISP IN SENSE AREA.  XM4405 50570003
.X322202 ANOP                                                    XM4405 50580003
RETSW    DS    CL1                     RETRY SW                @ZA04363 50590003
IOEND1   DS    0C                      END OF BASIC I/O BLOCKS.         50600016
*   EXTENSION FOR GETALT//DYNAMIC TRACK REQUEST.                        50700016
SEARCH   DS    1D                      SEARCH CCW.                      50800016
TIC      DS    1D                      REPEAT UNTIL FOUND.              50900016
WRTRD    DS    1D                      WRITE OR READ DATA.              51000016
FORMAT4  DS    CL96                    FORMAT4 DSCB READ IN AREA.       51100016
ALTDATA  EQU   FORMAT4+8               ALTERNATE TRACK INFORMATION.     51200016
VTOCCCHH EQU   FORMAT4+63              CCHH START OF VTOC.              51300016
IOEND    DS    0C                                                       51400016
         EJECT                                                          51500016
UCB      DSECT                                                          51600016
         IEFUCBOB                                                       51700016
         EJECT                                                          51800016
CVT      DSECT                                                          51900016
         CVT   SYS=MIN                                                  52000016
         END                                                            52100016
