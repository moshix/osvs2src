         GBLC  &LIB                                                     00100020
&LIB     SETC  'LIB1'                   SET VARIABLE TO LIB1            00200020
         TITLE 'IGC0N06C  RESCHEDULE I/O PHASE                         *00500018
                       RESUME I/O  CHECKPOINT-SVC 63  OS/360'           01000018
IGC0N06C CSECT                                                          01500018
*STATUS CHANGE LEVEL 000                                                06200002
*********************************************************************** 06500018
*                                                                     * 07000018
*                                                                     * 07500018
*FUNCTION/OPERATION- IGC0N06C PERFORMS THE FOLLOWING FUNCTIONS:       * 08000002
*     1.  LOADS THE VSAM MODULE (IDA0I96C) FOR CHECKPOINTING VSAM     * 08050037
*         DATA SETS, THEN WRITES THE RESULTANT VSAM SSCR RECORDS      * 08100002
*         TO THE CHECKPOINT DATA SET.                                 * 08150002
*                                                                     * 08200002
*     2.  CALLS IEFSSREQ MACRO FOR EACH SUBSYSTEM DATA SET THEN       * 08250002
*         WRITES EACH SUBSYSTEM SSCR TO THE CHECKPOINT DATA SET.      * 08300002
*                                                                     * 08350002
*     3.  FORMATS AND WRITES THE END RECORD TO THE CHECKPOINT DATA    * 08400002
*         SET FOR THE CURRENT CHECKPOINT ENTRY BEING GENERATED.       * 08450002
*                                                                     * 08650002
*     4.  RESTORES ANY I/O REQUESTS THAT WERE PURGED IN IGC0506C.     * 08700002
*                                                                     * 09500018
*ENTRY POINTS-IGC0N06C                                                * 10000002
*                                                                     * 10050002
*INPUT- WORK AREA ADDRESS IN REGISTER 1                               * 11000018
*     TASK CONTROL BLOCK ADDRESS IN WORKAREA FIELD 'CKTCBAD'          * 11500018
*                                                                     * 12000018
*OUTPUT- WORK AREA ADDRESS IN REGISTER 1                              * 12500002
*     VSAM AND SUBSYSTEM SSCRS, AND END RECORD WRITTEN TO CHKPT D/S   * 12550002
*     TASK CONTROL BLOCK ADDRESS IN WORKAREA FIELD 'CKTCBAD'          * 13000018
*                                                                     * 13500018
*EXTERNAL ROUTINES- VSAM MODULE (IDA0I96C)                            * 14000037
*                                                                     * 14500018
*EXITS-NORMAL- TO THE EXIT ROUTINE OF CHECKPOINT                      * 14800018
*                                                                     * 15100018
*     -ERRORS- TO THE EXIT ROUTINE OF CHECKPOINT                      * 15400002
*          ERRORS DETECTED:                                           * 15450002
*            RET.CODE  MSG.CODE  MSG.TYPE                             * 15500002
*              0C        023      I/O ERROR WRITING CHKPT DATA SET    * 15550002
*              08        027      EOV ERROR WRITING CHKPT DATA SET    * 15600002
*              0C        207      UNSUCCESSFUL IEFSSREQ (SUBSYS D/S)  * 15750002
*              18        215      UNSUCCESSFUL RESTORE                * 15800002
*                                                                     * 16000018
*CHANGE ACTIVITY                                                      * 16100037
*     OS/VS2 RELEASE 037 ADDS/DELETES/CHANGES                         * 16200037
*A566978                                                      @ZA13552* 16300037
*                                                                     * 16400037
*TABLES/WORKAREAS- CHECKPOINT WORK AREA (CHKWA), TCB, DEB, TIOT,      * 16500002
*     DSAB, CVT, DCB, JESCT, SSOB, SSIB, SSCR, CHECKPOINT PARM LIST   * 16600002
*                                                                     * 17000018
*ATTRIBUTES- READ ONLY, REENTERABLE AND PRIVILEGED                    * 17500018
*                                                                     * 18000018
*********************************************************************** 18050002
         EJECT                                                          18100002
*  REGISTERS USED                                                     * 18500018
*                                                                     * 19000018
RPM0     EQU   0                        PARAMETER REGISTER            * 19500018
RTCB     EQU   4                        ADDRESS OF TCB           Y02076 20000002
RBASE    EQU   2                        BASE REGISTER                 * 20500018
RDEB     EQU   3                        ADDRESS OF DEB                * 21000018
RIOB     EQU   5                        ADDRESS OF IOB                * 22000018
RWRK     EQU   6                        ADDRESS OF WORKAREA           * 22500018
RSVI     EQU   7                                                      * 23000018
RTPG     EQU   8                                                      * 23500018
RWK9     EQU   9                                                      * 24000018
RWKA     EQU   10                                                     * 24500018
RWKB     EQU   11                       WORK REGISTER                 * 25000018
RWKC     EQU   12                                                     * 25500018
REG13    EQU   13                       SAVE AREA POINTER             * 26000018
RET14    EQU   14                       RETURN REGISTER               * 26500018
RPM15    EQU   15                       PARAMETER REGISTER            * 27000018
*                                                                     * 27500018
*        MASKS                                                        * 28000018
*                                                                     * 28500018
NTPRGD   EQU   X'FF'                    TEST DEBUSRPG FOR NOT PURGED  * 29000018
TCAMID1  EQU   X'C0'                    UNIQUE TCAM DEB CODE     M3408  29100020
TCAMID2  EQU   X'CF'                    UNIQUE TCAM DEB CODE     M3408  29200020
*                                                                     * 29500018
*********************************************************************** 30000018
         EJECT                                                          30500018
         BALR  RBASE,0                  ESTABLISH BASE                  31000018
         USING *,RBASE                                           Y01909 31500000
         B     BEGIN               BRANCH AROUND EYE CATCHER     Y01909 31550000
         CNOP  0,8                 ALIGN TO A DBL WORD BOUNDARY  Y01909 31600000
         DC    C'IGC0N06C'         CSECT NAME                    Y01909 31650000
BEGIN    EQU   *                                                 Y01909 31700000
         USING TCB,RTCB                                                 32000018
         USING DEBBASIC,RDEB                                     Y02076 32500002
         USING CHKWA,RWRK                                               33000018
         USING CHKIOWA,RWKB                                             33500018
         USING IHADCB,RWKC                                       Y02076 33510002
         LR    RWRK,R1                  SET CHKPT WA BASE REG    Y02076 33520002
         LR    RWKB,RWRK                CALC ADDR OF XCTL WA     Y02076 33530002
         A     RWKB,CKWAOFST            ADD OFFSET               Y02076 33540002
         MVC   LIST(E8),XADDR           NEXT MODULE FOR XCTL     Y02076 33542002
         ST    RWKB,CKERAS04            SAVE XCTL WA ADDRESS     Y02076 33544002
         L     RWKC,CKDCBAD             GET CHKPT DCB ADDR       Y02076 33546002
         LA    R1,RESYNAD               GET ADR OF SYNAD RTN     Y02076 33548002
         STCM  R1,ADDRBYTS,DCBSYNAD+E1  ST IN CHKPT DS DCB       Y02076 33548402
         LA    REG13,CKREGSAV           INIT REG SAVEAREA ADDR   YM6584 33548502
         DROP  RWKC                                              Y02076 33548802
         NI    CKFLAG2,VSAMOFF          TURN OFF VSAM LOAD FLAG  Y02076 33548902
         L     RTCB,CKTCBAD             GET ADR OF TCB           Y02076 33549002
*********************************************************************** 33549902
*     PREPARE TO WRITE OUT VSAM SSCR RECORDS ON CHECKPOINT DATA SET   * 33566602
*********************************************************************** 33576602
         MVC   CKLNGTH1(E2),BLOCKLNG+E1 SET WRITE RECORD TO 4K @Z30SSDT 33583337
         XC    CKSSCR(E4),CKSSCR        CLEAR SSCR ANCHOR FIELD  Y02076 33600002
         MVC   VSAMLOAD(E8),VSAMODUL    MOVE VSAM MODULE NAME IN Y02076 33650002
         LOAD  EPLOC=VSAMLOAD           LOAD VSAM MODULE         Y02076 33700002
         ST    R0,VSAMLOAD+E8           SETUP FOR VSAM MODULE    Y02076 33750002
         MVI   VSAMLOAD+E8,E0           CLEAR HIGH ORDER BYTE  @OZ03934 33800037
         OI    CKFLAG2,VSAMON           TURN ON VSAM LOAD FLAG   Y02076 33810002
         L     RPM15,VSAMLOAD+E8        GET ADDR OF VSAM ROUTINE Y02076 33900002
         LR    R1,RWRK                  SET REG 1=W. A. ADDR     Y02076 33910002
         BALR  RET14,RPM15              GO TO VSAM ROUTINE       Y02076 33950002
         LTR   RPM15,RPM15              TEST FOR ERROR RETURN  @Z30SSDT 33970037
         BNZ   RESIOB                   BR IF ERROR FROM VSAM  @Z30SSDT 33990037
         OC    CKSSCR(E4),CKSSCR        ANY VSAM SSCRS         @Z30SSDT 33994037
         BZ    RESIO500                 NO-PROCESS SS & VAM DATA Y02076 33996002
         L     RWKC,CKSSCR              GET ADR OF 1ST SSCR      Y02076 33998402
         USING SSCR,RWKC                                         Y02076 33998802
RESIOA   ST    RWKC,CMBUF               STORE ADR OF SSCR      @Z30SSDT 33999237
         BAL   R7,C13B2A                GO WRITE OUT SSCR        Y02076 33999602
         L     RWKC,SSCRFCHN            GET ADR OF NEXT SSCR     Y02076 33999702
         LTR   RWKC,RWKC                ANY MORE SSCRS           Y02076 33999802
         BNZ   RESIOA                   BRANCH IF YES          @Z30SSDT 33999937
*********************************************************************** 34049937
*   FREEMAIN SSCRS AND DELETE VSAM MODULE                        Y02076 34059902
*********************************************************************** 34069937
RESIOB   ICM   RPM0,ADDRBYTS,BLOCKLNG   SET UP 0 FOR FREEMAIN  @Z30SSDT 34079937
         ICM   RPM0,HIORDER,SP253                                Y02076 34091902
         L     RWKC,CKSSCR              GET FIRST SSCR BLOCK     Y02076 34093902
RESIOC   LTR   RWKC,RWKC                TEST IF THERE IS ONE     Y02076 34097902
         BZ    RESIOD                   BRANCH IF ALL DONE     @Z30SSDT 34098337
         L     R1,SSCRFCHN              GET ADDR OF NEXT SSCR    Y02076 34098402
         ST    R1,CKSSCR                STORE AT TOP OF CHAIN    Y02076 34098502
         FREEMAIN  R,LV=(RPM0),A=(RWKC) FREE UP THE BLOCK        Y02076 34098702
         L     RWKC,CKSSCR              GET NEXT SSCR BLOCK      Y02076 34099102
         B     RESIOC                   GO TO FREE UP NEXT BLOCK Y02076 34099502
RESIOD   CLI   CKRETCOD+E1,CKPSBERR     PROB ERROR BEEN SET    @Z30SSDT 34099637
         BE    RESIO500                 CONTINUE IF YES        @Z30SSDT 34099737
         CLI   CKRETCOD+E1,E0           ANY OTHER ERRORS       @Z30SSDT 34116437
         BE    RESIO500                 CONTINUE IF NOT        @Z30SSDT 34126437
         B     RESUMEIO                 BR TO RESTORE IF ERROR @Z30SSDT 34128437
*********************************************************************** 38970802
*    OBTAIN CHAIN OF DEBS FROM TCB FOR RESTORING I/O THAT WAS PURGED  * 38980802
*********************************************************************** 38990802
RESUMEIO EQU   *                        PREPARE TO RESTORE I/O   Y02076 38992802
         L     RWKB,CKERAS04            GET PTR TO XCTL WA       Y02076 38994802
         L     RDEB,TCBDEB              GET ADDR OF FIRST DEB FROM TCB  39000018
RESIO010 LTR   RDEB,RDEB                TEST FOR END OF DEB CHAIN       39500018
         BZ    RESIO030                 IF DONE GO TO EXIT       Y02076 40000002
         LR    RWKC,RDEB                GET ADDR OF DEB BASIC    Y02076 40050002
         LA    RWKA,DEBPRFLN            GET DEB PREFIX LENGTH    Y02076 40060002
         SR    RWKC,RWKA                CALC. DEB PREFIX ADR     Y02076 40070002
         USING DEBPREFX,RWKC                                     Y02076 40080002
         CLI   DEBAMTYP,VSAMIDCD        IS IT VSAM               Y02076 40090002
         BE    RESIO020                 Y-BYPASS RESTORE         Y02076 40092002
         L     RWKA,DEBXTNP             GET DEB EXT. ADR         Y02076 40094002
         DROP  RWKC                                              Y02076 40096002
         USING DEBXTN,RWKA                                       Y02076 40098002
         L     RWKA,DEBXDSAB-DEBXTN(,RWKA)  GET ADR OF DSAB      Y02076 40098402
         USING DSAB,RWKA                                         Y02076 40098802
         L     RWKA,DSABTIOT-DSAB(,RWKA)  GET ADR OF DD ENTRY    Y02076 40099202
         USING TIOENTRY,RWKA                                     Y02076 40099602
         TM    TIOELINK,TIOESSDS        IS IT A SS DATA SET      Y02076 40099702
         BO    RESIO020                 IF YES - BYPASS RESTORE  Y02076 40099802
         DROP  RWKA                                              Y02076 40099902
         CLI   DEBEXSCL,DUMMYDEB        IS IT A DUMMY DEB        Y02076 40133202
         BNE   RESIO015                 BRANCH IF NO             Y02076 40143202
         TM    DEBFLGS1,DEBCINDI        TEST FOR CI BIT SET      Y02076 40153202
         BO    RESIO020                 IF ON - BYPASS RESTORE   Y02076 40163202
RESIO015 EQU   *                        ANY TCAM DATA SETS OPEN  Y02076 40165202
         CLI   DEBNMSUB,TCAMID1         Q - TCAM DEB (TYPE 1)    M3408  40166702
         BE    RESIO020                 IF YES, SKIP THIS DEB    M3408  40200020
         CLI   DEBNMSUB,TCAMID2         Q - TCAM DEB (TYPE 2)    M3408  40300020
         BE    RESIO020                 IF YES, SKIP THIS DEB    M3408  40400020
*                                                                     * 42000018
         L     RIOB,DEBUSRPG            ADDR OF 1ST IOB IN PURGE CHAIN  42500018
         LA    RIOB,0(0,RIOB)           CLEAR HIGH ORDER BITS           43000018
         LTR   RIOB,RIOB                TEST IF PURGE ISSUED AT ALL     43500018
         BZ    RESIO020                 IF NO PURGE GO GET NEXT DEB     44000018
*                                                                     * 44500018
*                                                                     * 45000018
*  SET UP FOR RESTORE                                                 * 45500018
*                                                                     * 46000018
*                                                                     * 47000018
RESIO017 EQU *                          PREPARE FOR RESTORE      Y02076 47050002
         CLC   DEBUSRPG+E1(E3),NOIOPRGD WERE I/O REQUESTS PURGED Y02076 47100002
         BE    RESIO020                 GET NEXT DEB IF NO PURGE Y02076 47150002
         LA    R1,DEBUSRPG              R1 PTS TO PIRL POINTER   Y02076 47200002
         L     RWKC,E0(R1)              GET ADDR OF PIRL OPT BYT Y02076 47250002
         MVI   E0(RWKC),RESPOPTB        SET PIRL OPT BYT FOR RES Y02076 47300002
         RESTORE DEBUSRPG               RESTORE PURGED I/O       Y02076 47350002
         LA    RWKA,RESRETCD            GET BAD RESTORE CODE     Y02076 47400002
         CR    RWKA,RPM15               WAS RESTORE UNSUCCESFUL  Y02076 47450002
         BNE   RESIO020                 BR IF SUCESS FOR NXT DEB Y02076 47460002
         CLI   CKRETCOD+E1,E0           ERRORS DETECTED BEFORE   Y02076 47462002
         BNE   RESIO019                 BRANCH IF YES            Y02076 47464002
         MVI   CKMSGCOD+E1,ERR215       SET RESTORE ERROR CODE   Y02076 47470002
         MVI   CKMSGCOD,E2              SET ERROR MSG SHELL CODE Y02076 47472002
         MVI   CKRETCOD+E1,RESTERCD     SET RESTORE ERR(18) CODE Y02076 47474002
         B     RESIO030                 BRANCH TO EXIT           Y02076 47480002
RESIO019 MVI   CKRETCOD,RESTERCD        REST ERR CODE TO 1ST BYT Y02076 47490002
         B     RESIO030                 BRANCH TO EXIT           Y02076 47494002
***                                                                 *** 47500018
*                                                                     * 48000018
*  GET NEXT DEB FROM CHAIN                                            * 48500018
*                                                                     * 49000018
RESIO020 L     RDEB,DEBDEBAD            GET ADDRESS OF PREVIOUS DEB     49500018
         LA    RDEB,0(0,RDEB)           CLEAR HIGH ORDER BITS           50000018
         B     RESIO010                 GO GET NEXT DEB                 50500018
*                                                                     * 51000018
***                                                                 *** 51500018
*                                                                     * 52000018
RESIO030 EQU   *                                                        52500018
         TM    CKFLAG2,VSAMON           WAS VSAM MODULE LOADED   Y02076 52550002
         BZ    RESIO035                 BRANCH IF NO             Y02076 52600002
         DELETE  EPLOC=VSAMLOAD         DELETE VSAM MODULE       Y02076 52650002
         NI    CKFLAG2,VSAMOFF          TURN OFF VSAM LOAD FLAG  Y02076 52700002
RESIO035 EQU   *                        SET UP FOR EXIT          Y02076 52750002
         LR    R1,RWRK                  RELOAD ADDR OF PASSED WA Y02076 53000002
         L     RWKB,CKERAS04      GET PTR TO XCTL PARM LIST      YM7306 53010002
         LA    RPM15,LIST               GET ADR OF XCTL P.L.     Y02076 53050002
         ST    RPM15,LIST+8             STORE IN XCTL LIST       Y02076 53100002
         LA    RPM15,LIST+8             TELL XCTL WHERE TO GO           54500018
*                                                                     * 55000018
         XCTL  EPLOC=(RWKB),SF=(E,(15)) TO CHECKPOINT ROUTINE           55500018
*                                                                     * 56000018
*********************************************************************** 56010002
*  PREPARE TO WRITE SUBSYSTEM DATA SET SSCRS TO CHECKPOINT DATA SET   * 56020002
*********************************************************************** 56030002
RESIO500 EQU   *                        ACCESS DEB CHAIN         Y02076 56050002
         L     RDEB,TCBDEB              GET ADDR OF 1ST DEB      Y02076 56100002
RESIO502 EQU   *                        PROCESS DEB              Y02076 56110002
         LTR   RDEB,RDEB                END OF DEB CHAIN         Y02076 56120002
         BZ    ENDRECA                  BRANCH IF YES            Y02076 56130002
         LR    RWKC,RDEB                GET ADDR OF DEB BASIC    Y02076 56150002
         LA    RWKA,DEBPRFLN            GET LENGTH OF DEB PREFIX Y02076 56200002
         SR    RWKC,RWKA                CALC. ADDR OF DEB PREFIX Y02076 56250002
         USING DEBPREFX,RWKC                                     Y02076 56300002
         L     RWKA,DEBXTNP             GET DEB EXT POINTER      Y02076 56350002
         USING DEBXTN,RWKA                                       Y02076 56400002
         L     RWKA,DEBXDSAB-DEBXTN(,RWKA)  GET ADR OF DSAB      Y02076 56450002
         USING DSAB,RWKA                                         Y02076 56460002
         L     RWKA,DSABTIOT-DSAB(,RWKA)   GET ADR OF DD ENTRY   Y02076 56470002
         USING TIOENTRY,RWKA                                     Y02076 56480002
         TM    TIOELINK,TIOESSDS        IS IT A SS DATA SET      Y02076 56490002
         BO    RESIO510                 BRANCH IF A SS DATA SET  Y02076 56492002
RESIO505 EQU   *                        BEGIN DEB PROCESSING     Y02076 56492402
         L     RDEB,DEBDEBAD            GET NEXT DEB ADR         Y02076 56492802
         LA    RDEB,0(RDEB)             CLEAR HI ORDER BYTE      Y02076 56493202
         B     RESIO502                 BRANCH IF MORE DEBS      Y02076 56493602
RESIO510 EQU   *                        CHKPT SUBSYS DATA SETS   Y02076 56503902
**********************************************************************  56508502
*   INITIALIZE FOR THE IEFSSREQ MACRO TO CHECKPOINT SUBSYSTEM DATA   *  56513102
*         SETS                                                   Y02076 56517702
*********************************************************************** 56522302
         LR    RWK9,RDEB                GET ADR DEBBASIC         Y02076 56532302
         LA    RWK9,DEBBASND            END OF DEBBASIC SECT     Y02076 56542302
         LA    RWK9,E4(RWK9)            ADDR OF SSIB             Y02076 56544302
         USING SSIB,RWK9                SSIB ADDRESSABILITY      Y02076 56544702
         AH    RWK9,SSIBLEN             ADDR OF SSOB             Y02076 56545102
         ST    RWK9,SSREQPRM            SAVE IN PARM WORD        Y02076 56545202
         MVI   SSREQPRM,HIORDER2        SET HIORDER BIT-PARM WD  Y02076 56548802
         USING SSOB,RWK9                                         Y02076 56552702
         MVI   SSOBFUNC+E1,SSOBCKPT     SET CHKPT FUNCTION       Y02076 56556302
         ICM   RPM0,ADDRBYTS,BLOCKLNG   SET UP REG 0 FOR GETMAIN Y02076 56559902
         ICM   RPM0,HIORDER,SP253       SET SUBPOOL NO.          Y02076 56569902
         GETMAIN  R,LV=(RPM0)           GET 4K BUFR FOR IEFSSREQ Y02076 56579902
         ST    R1,CMBUF                 BLOCK ADR TO WRITE SSCR  Y02076 56593902
         LR    RWKB,R1                  ADR OF SSCR IN RWKB      Y02076 56595902
         USING SSCR,RWKB                                         Y02076 56597902
         LA    R0,SSCRDATA              GET DATA ADR SUB SYS SSCRVS4685 56598002
         ST    R0,SSDABUFR              STORE IT IN SS0B         VS4685 56598102
         MVI   SSCRID,SSCRIDCK          SET CHKPT ID IN SSCR     Y02076 56598302
         MVI   SSCRSSID,SSCRSS          SET SUBSYS ID IN SSCR    Y02076 56598702
         OI    SSCRFLG1,SSCRCKRS        SET CHECKPOINT BIT       Y02076 56599102
         XC    SSCRFCHN,SSCRFCHN        CLEAR CHAIN FIELD        Y02076 56599502
         XC    SSCRDATL,SSCRDATL        CLEAR DATA LENGTH FIELD  Y02076 56599602
         XC    SSCRDCBA,SSCRDCBA        CLEAR DCB ADDR FIELD     Y02076 56599702
         LA    R1,SSREQPRM              IEFSSREQ PRM WRD ADR-R1  Y02076 56599802
         IEFSSREQ                       GET SUBSYSTEM CHKPT DATA Y02076 56679802
         LTR   RPM15,RPM15              TEST RETURN CODE         Y02076 56689802
         BNZ   RESIO520                 BR TO SET ERR CODE       Y02076 56691802
         OC    SSOBRETN,SSOBRETN        TEST SSOB RETURN CODE    Y02076 56693802
         BZ    RESIO525                 BRANCH IF SUCCESSFUL     Y02076 56695802
RESIO520 MVI   CKMSGCOD+E1,ERRMSGC3     SET ERR CODE =207        Y02076 56697802
         MVI   CKRETCOD+E1,CKIOERR      SET SUBSYSTEM FAILURE  @ZA13552 56697937
         MVI   CKMSGCOD,E3              SET INVLD MSG SHELL CODE Y02076 56698037
         B     RESUMEIO                 BRANCH TO ERROR EXIT     Y02076 56698202
RESIO525 EQU   *                        CALL WRITE ROUTINE       YM5721 56698602
         MVC   SSCRDCBA,DEBDCBAD        MOVE DCBADDR IN SSCR     Y02076 56709702
         BAL   R7,C13B2A                BR TO WRITE OUT SSCR     Y02076 56749702
         L     R1,CMBUF                 GET ADR OF 4K BUFFER     VS4685 56751702
         ICM   R0,ADDRBYTS,BLOCKLNG     SET UP R0 FOR FREEMAIN   Y02076 56753702
         ICM   R0,HIORDER,SP253         SET SUBPOOL 253          Y02076 56755702
         FREEMAIN  R,LV=(R0),A=(R1)     FREEUP THE 4K BLOCK      Y02076 56757702
         B     RESIO505                 GO GET NEXT DEB          Y02076 56759702
*********************************************************************** 56769702
*       WRITE ROUTINE FOR THE CHECKPOINT DATA SET                     * 56771702
*********************************************************************** 56773702
C13B2A   EQU   *                        WRITE ROUTINE            Y02076 56779702
         L     RA,CMBUF                 INIT START OF BUFFER     Y02076 56789702
         TM    CKFLAG1,CKVEQR           IS THIS TASK V=R?        Y02076 56791702
CKVEQR   EQU   X'08'                    V=R FLAG IN W.A.         YM7393 56793702
         BNO   CKNOVEQR                 NO, GO ON                Y02076 56795702
         LRA   RA,E0(,RA)               GET REAL ADDR OF BUFFER  Y02076 56797702
CKNOVEQR EQU   *                        ISSUE WRITE              Y02076 56798102
         WRITE CKDECB1,SF,,(E10),MF=E                            Y02076 56798502
         CHECK CKDECB1                  ISSUE CHECK              Y02076 56798902
         TM    CKFLAG1,CKTAPE           CHKPT DATA SET ON TAPE   Y02076 56799302
         BZ    CMEOVDA                  BRANCH IF NO             Y02076 56799402
         L     RF,CKTSTEOV                                       Y02076 56799502
         CLC   E0(E4,RF),CKEOVCMR       DID EOV OCCUR            Y02076 56799602
         BNE   CMEOV                    BRANCH IF YES            Y02076 56849602
CMTIOTST EQU   *                        DID I/O ERROR OCCUR      Y02076 56859602
         CLI   CKRETCOD+E1,CKIOERR      I/O ERROR                Y02076 56869602
         BE    CMTIOTSA                 BRANCH TO SET CODE       Y02076 56879602
         BR    R7                       RETURN                   Y02076 56889602
CMTIOTSA LA    RF,CKERIO3               I/O ERROR MSG CODE       Y02076 56891602
         STH   RF,CKMSGCOD              STORE IN WORK AREA       Y02076 56892002
         B     RESUMEIO                 BRANCH TO EXIT           Y02076 56892402
         EJECT                                                   Y02076 56893602
*                                                                Y02076 56895602
*        END OF VOLUME TESTING                                   Y02076 56897602
*                                                                Y02076 56898002
CMEOV    EQU   *                        END OF VOLUME TESTS      Y02076 56898402
         TM    CKFLAG2,CKEOV            2ND EOV FOR THIS REQUEST Y02076 56898802
         BO    CMEOVER                  YES- GO TO EXIT RTN      Y02076 56899202
         OI    CKFLAG2,CKEOV            TURN ON EOV INDICATOR    Y02076 56899302
         L     RWKB,CKERAS04            GET PTR TO XCTL WA       Y02076 56899402
         USING CHKIOWA,RWKB                                      Y02076 56909502
         MVI   LIST+E4,F2               SET TO XCTL TO 206C      Y02076 56910602
         B     RESIO030                 XCTL INTERFACE           Y02076 56921802
CMEOVDA  EQU   *                        TEST EOV ON DA DEVICE    Y02076 56933002
         USING IHADCB,RF                DCB                      Y02076 56943002
         L     RF,CKDCBAD               GET ADR. OF CHKPT DCB    Y02076 56953002
         L     RF,DCBDEBAD              GET ADR. OF CHKPT DEB    Y02076 56963002
         DROP  RF                       DCB                      Y02076 56965002
         USING DEBBASIC,RF              DEB                      Y02076 56965402
         CLC   DEBNMEXT(E1),CKTSTEOV                             Y02076 56965802
*                                       DID EOV OCCUR ON DA DEV. Y02076 56966202
         BE    CMTIOTST                 NO- CONTINUE PROCESSING  Y02076 56966302
         DROP  RF                       DEB                      Y02076 56966402
CMEOVER  EQU   *                        SET EOV ERROR            Y02076 56977602
         LA    RF,CKERIO7               INDICATE EOV ERROR       Y02076 56987602
         STH   RF,CKMSGCOD              PUT IN W.A.              Y02076 56988002
         MVI   CKRETCOD+E1,E8           PUT IN RETURN CODE ERR   Y02076 56988402
         B     RESIO030                 XCTL INTERFACE           Y02076 56988502
RESYNAD  MVI   CKRETCOD+E1,CKIOERR      RTN TO SET I/O ERROR     Y02076 56988602
         BR    RE                       RETURN                   Y02076 56989502
*********************************************************************** 56991902
*     THIS ROUTINE WRITES OUT THE CHECKPOINT END RECORD          Y02076 56992802
*********************************************************************** 56993702
ENDRECA  EQU   *                        WRITE END RECORD         Y02076 56994602
         L     RWKB,CKBFOFST            GET ADR  END RECORD BUFF Y02076 56995502
         AR    RWKB,RWRK                GET ABS ADR OF BUFFER    Y02076 56995902
         XC    E0(E20,RWKB),E0(RWKB)    CLEAR END RECORD BUFFER  Y02076 56996402
         MVC   E0(E2,RWKB),ENDRECID     MOVE FFFF INTO ID BYTE   Y02076 56997302
         MVI   E4(RWKB),SPACE           BLANK OUT CHECKID        Y02076 56998202
         MVC   E5(E15,RWKB),E4(RWKB)       FIELD OF END RECORD   Y02076 56999102
         TM    CKFLAG2,CKUSPCHD         DID USER SUPPLY CHECKID  Y02076 57000002
         BZ    ENDRECB                  BR IF NO TO MOVE GEN ID  Y02076 57046202
         L     RWKC,CKPARMAD            GET ADR OF CHKPT PARMLST Y02076 57056202
         USING PARMSECT,RWKC                                     Y02076 57066202
         L     RWK9,IDADDR              GET LNGTH & ADR OF ID    Y02076 57076202
         LR    RTPG,RWK9                LNGTH & ID ADR IN REG8   Y02076 57086202
         SRL   RTPG,E24                 SHIFT OUT ADDR           Y02076 57088202
         BCTR  RTPG,E0                  REDUCE LNGTH BY 1 FOR EX Y02076 57090202
         LA    RWK9,E0(RWK9)            CLEAR HI ORDER BYTE ADR  Y02076 57092202
         EX    RTPG,IDMOVE              EXECUTE MOVE INSTRUCTION Y02076 57094202
         B     ENDRECC                  BR TO WRITE              Y02076 57094602
ENDRECB  EQU   *                        MOVE IN GEN. CHECKID     Y02076 57095002
         LA    RWK9,CKCHEKID            GET ADR - GEN. CHECKID   Y02076 57095402
         MVC   E4(E8,RWKB),E0(RWK9)     MOVE CHECKID TO RECORD   Y02076 57095802
ENDRECC  EQU   *                        PREPARE FOR WRITE        Y02076 57095902
         ST    RWKB,CMBUF               STORE END REC BUFF ADR   Y02076 57096002
         BAL   R7,C13B2A                WRITE END OF CKPT RECORD Y02076 57122802
         B     RESUMEIO                 GO TO RESTORE PURG'D IO ZA00617 57124802
***                                                                 *** 57129502
*                                                                     * 57146202
XADDR    DC    CL8'IGC0Q06C'            CHECKPOINT EXIT ROUTINE         57500018
IDMOVE   MVC   E4(E1,RWKB),E0(RWK9)     MVC INSTR FOR EXECUTE    Y02076 57550002
NOIOPRGD DC    XL3'FFFFFF'              'NO I/O REQSTS PRGD' IND Y02076 57600002
ENDRECID DC    XL2'FFFF'                ID FOR END OF CHKPT REC  Y02076 57650002
*                                                                     * 58000018
*                                                                     * 59000018
*********************************************************************** 59500018
*                                                                     * 59550000
*        MAINTENANCE SPACE                                       Y01909 59600000
*                                                                     * 59650000
PATCH    DC    XL((*-IGC0N06C)/20)'00'   FIVE PERCENT SPACE      Y01909 59700000
*                                                                     * 59750000
*********************************************************************** 60000018
DEBPRFLN EQU   16                       LNGTH OF DEB PREFIX      Y02076 60050002
VSAMIDCD EQU   X'01'                    VSAM ID CODE             Y02076 60100002
DUMMYDEB EQU   X'00'                    DUMMY DEB CODE(DEBEXSCL) Y02076 60150002
ERRMSGC3 EQU   207                      SS INTERFACE ERR CODE    Y02076 60310002
HIORDER2 EQU   X'80'                    HI ORDER BYTE BIT        Y02076 60320002
HIORDER  EQU   8                        HI ORDER BYTE MASK       Y02076 60322002
ADDRBYTS EQU   7                        ADDRESS BYTES MASK       Y02076 60330002
E0       EQU   0                        CONSTANT 0               Y02076 60330402
E1       EQU   1                        CONSTANT 1               Y02076 60330802
E2       EQU   2                        CONSTANT 2               Y02076 60330902
E3       EQU   3                        CONSTANT 3               Y02076 60331502
E4       EQU   4                        CONSTANT 4               Y02076 60331602
E5       EQU   5                        CONSTANT 5               Y02076 60331702
E6       EQU   6                        CONSTANT 6               Y02076 60331802
E7       EQU   7                        CONSTANT 7               Y02076 60332302
E8       EQU   8                        CONSTANT 8               Y02076 60333802
E9       EQU   9                        CONSTANT 9               Y02076 60334202
E10      EQU   10                       CONSTANT 10              Y02076 60334302
E15      EQU   15                       CONSTANT 15              Y02076 60334702
E20      EQU   20                       CONSTANT 20              Y02076 60334902
E24      EQU   24                       CONSTANT 24              Y02076 60335402
SPACE    EQU   X'40'                    SPACE                    Y02076 60335502
ENDRECLN EQU   20                       LNGTH OF CHKPT END REC.  Y02076 60335702
RESPOPTB EQU   X'C0'                    PIRL OPT BYT FOR RESTORE Y02076 60335802
VSAMOFF  EQU   X'BF'                    TURN OFF VSAM LOAD MASK  Y02076 60336302
VSAMON   EQU   X'40'                    TURN ON VSAM LOAD MASK   Y02076 60336702
RESTERCD EQU   X'18'                    RESTORE ERR RETURN CODE  Y02076 60337102
RESRETCD EQU   4                        BAD RESTORE RETURN CODE  Y02076 60337802
ERR215   EQU   215                      ERR CODE FOR BAD RESTORE Y02076 60338402
C2       EQU   C'2'                     CHAR 2                   Y02076 60339002
F2       EQU   X'F2'                    FOR XCTL TO IGC0206C     Y02076 60339602
CKERIO3  EQU   X'0317'                  CHKPT D/S WRITE ERR      Y02076 60340202
CKERIO7  EQU   X'031B'                  EOV ERR MSG CODE         Y02076 60340802
VSAMODUL DC    C'IDA0I96C'              VSAM MODULE NAME       @Z30SSDT 60341437
BLOCKLNG DC    AL3(4096)                SSCR BLOCK LENGTH        Y02076 60342002
SP253    DC    AL1(253)                 SUBPOOL NO.              Y02076 60342302
SSCR     DSECT                                                   Y02076 60343902
SSCRID   DS    C                        SSCR RECORD ID           Y02076 60345502
SSCRIDCK EQU   X'01'                    CHECKPOINT ID            Y02076 60347102
SSCRSSID DS    C                        SUBSYSTEM ID             Y02076 60348702
SSCRSS   EQU   X'00'                    SUBSYSTEM                Y02076 60350302
SSCRVSAM EQU   X'01'                    VSAM                     Y02076 60351902
SSCRSPIE EQU   X'02'                    SPIE                     Y02076 60353502
SSCRHDRL DS    H                        HDR LNGTH(OFSET TO DATA) Y02076 60355102
SSCRFCHN DS    F                        CHAIN PTR TO XTRA SSCRS  Y02076 60365502
SSCRFLG1 DS    C                        FLAG BYTE                Y02076 60365902
SSCRCKRS EQU   X'80'                    CHECKPOINT TIME          Y02076 60366302
SSCRDATL DS    H                        DATA LENGTH              Y02076 60370002
SSCRDCBA DS    F                        ADDR OF ASSOC. DCB       Y02076 60372002
SSCRDATA DS    F                        1ST WORD DATA AREA       Y02076 60372402
PARMSECT DSECT                                                   Y02076 60372802
PARMFLG  DS    1C                       FLAG                     Y02076 60373202
PARMDCB  DS    3C                       DCB ADDR                 Y02076 60373602
IDADDR   DS    0F                       CHECKID ADDRESS          Y02076 60373702
LNCHKID  DS    1C                       CHECKID LENGTH           Y02076 60373802
         DS    3C                       ADDR OF CHECKID          Y02076 60377502
         IEFJSSOB   (DA),CONTIG=YES                              Y02076 60381402
         IEFJSSIB                                                Y02076 60385102
         IEZDEB                                                  Y02076 60388802
         IEFTIOT1                                                Y02076 60398802
         CVT   DSECT=YES,PREFIX=YES,LIST=YES                     Y02076 60398902
         IEFJESCT                                                Y02076 60408902
         DCBD  DSORG=(BS,PO),DEVD=(DA,TA)                        Y02076 60410902
         IHADSAB                                                 Y02076 60629502
         EJECT                                                          60646202
TCB      DSECT      TASK CONTROL BLOCK                                  81000018
*                                                                       81500018
TCBRBP   DS    A                       POINTER TO EXECUTING RB          82000018
TCBPIE   DS    A                       POINTER TO PROG. INTERRUPT EL.   82500018
TCBDEB   DS    A                       POINTER TO DEB QUEUE             83000018
TCBTIO   DS    A                       POINTER TO TIOT                  83500018
TCBCMP   DS    F                       TASK COMPLETION CODE             84000018
TCBTRN   DS    A                       TESTRAN FIELD                    84500018
TCBMSS   DS    A                       DATA BLOCK QUEUE ELEMENT POINTER 85000018
TCBPRTK  DS    BL1                     PROTECTION TAG                   85500018
TCBFLGS  DS    BL5                     FLAG BYTES                       86000018
TCBLMP   DS    BL1                     LIMIT PRIORITY                   86500018
TCBDSP   DS    BL1                     DISPATCHING PRIORITY             87000018
TCBLLS   DS    A                       POINTER TO LOAD LIST             87500018
TCBJLB   DS    A                       POINTER TO JOBLIB DCB            88000018
TCBJSE   DS    A                       LIST OF INACTIVE PROGRAMS ADDR.  88500018
TCBGRS   DS    16F                     GENERAL REGISTER SAVE AREA       89000018
TCBIDF   DS    0BL1                    TCB IDENTIFIER FIELD             89500018
TCBFSA   DS    A                       POINTER TO 1ST PROB.PROG.SAVEAR  90000018
TCBTCB   DS    A                       NEXT TCB ON READY QUEUE POINTER  90500018
TCBTME   DS    A                       POINTER TO TIMER ELEMENT         91000018
*                                                                       91500018
*                                                                       92000018
*                                                                       92500018
*                                                                       93000018
CHKIOWA  DSECT      CHECKIO'S WORK AREA                                 93500018
*                                                                       94000018
LIST     DS    3F   AREA WHERE ENTRY POINT NAME IS STORED               94500018
         EJECT                                                          95000018
         IEEVCHWA VER=3                 USE AOS2 VERSION OF WA          95550000
*                                                                       96000018
**********************************************************************  96500018
SSREQPRM EQU   CKERAS05                 CONTAINS SSOB ADDR       Y02076 96550002
CMBUF    EQU   CKERAS06                 OUTPUT BUFFER ADDR       Y02076 96600002
VSAMLOAD EQU   CKERAS00                 VSAM MODULE NAME         Y02076 96650002
CKTSTEOV EQU   CKUNIT                   END OF VOLUME TEST       Y02076 96750002
CKEOVCMR EQU   CKUNIT+4                 END OF VOLUME TEST       Y02076 96800002
         END   IGC0N06C                                                 97500018
