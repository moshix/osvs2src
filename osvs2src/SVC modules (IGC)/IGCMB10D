         TITLE 'IGCMB10D - 3705 GOTRACE/NOTRACE SUPPORT MODULE'         00100022
IGCMB10D CSECT                                                          00200022
*********************************************************************** 00300022
*                                                                     * 00400022
*  MODULE NAME = IGCMB10D(TCAM, OP CONTROL)                    @Y17XARW 00500000
*                                                                     * 00600022
*  DESCRIPTIVE NAME = 3705 GOTRACE/NOTRACE SUPPORT MODULE             * 00700022
*                                                                     * 00800022
*  COPYRIGHT = NONE                                                   * 00900022
*                                                                     * 01000022
*  STATUS = VERSION 10.0                                       @Y17XARW 01100000
*                                                                     * 01200022
*  FUNCTION = SUPPORT OF THE OPERATOR CONTROL FUNCTIONS GOTRACE AND   * 01300022
*     NOTRACE FOR LINES CONNECTED TO A 3705.                          * 01400022
*     THE MODULE COMPLETES THE SCANNING OF THE OPERATOR CONTROL       * 01600022
*     REQUEST INPUT DATA AND VALIDITY-CHECKS THE INPUT.               * 01700022
*                                                                     * 01800000
*     FOR AN ACTIVATE-LINE-TRACE REQUEST THE ROUTINE THROWS AWAY      * 01900022
*     THE OLD INACTIVE TRACE TABLE FOR THIS 3705 IF ONE IS PRESENT.   * 02000022
*     IT THEN GETS CORE FOR A NEW TABLE AND INITIALIZES THE CONTROL   * 02100022
*     INFORMATION IN IT AND LOADS THE TRACE ROUTINE.           @Y17XARW 02200000
*                                                                     * 02210000
*     A PACKED REQUEST UNIT IS THEN BUILT AND SENT TO IGC0210D @Y17XARW 02220000
*     WHO SENDS A REQUEST TO THE 3705.  WHEN THE RESPONSE UNIT @Y17XARW 02230000
*     IS RETURNED, THE MODULE REGAINS CONTROL AND ISSUES THE   @Y17XARW 02240000
*     THE PROPER COMPLETION MESSAGE.                           @Y17XARW 02250000
*                                                                     * 02600022
*     FOR A DEACTIVATE LINE TRACE REQUEST, A PACKED RU IS BUILT@Y17XARW 02800000
*     AND SENT TO IGC0210D WHO SENDS A REQUEST TO THE 3705.    @Y17XARW 02880000
*     WHEN A RESPONSE UNIT IS RETURNED THE MODULE REGAINS      @Y17XARW 02960000
*     CONTROL AND ISSUES THE PROPER COMPLETION MESSAGE.        @Y17XARW 03040000
*                                                                     * 03120000
*  NOTES = SEE BELOW                                                  * 03200000
*                                                                     * 03300022
*    DEPENDENCIES = CHARACTER-CODE DEPENDENCY                         * 03400000
*     THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL           * 03500022
*     REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS           * 03600022
*     EQUIVALENT TO THAT USED AT ASSEMBLY TIME.  THE CODING HAS BEEN  * 03700022
*     ARRANGED SO THAT REDEFINITION OF CHARACTER CONSTANTS BY         * 03800022
*     REASSEMBLY WILL RESULT IN A CORRECT MODULE FOR THE NEW          * 03900022
*     DEFINITION.                                                     * 04000022
*                                                                     * 04100022
*     RESTRICTIONS = NONE                                             * 04200022
*                                                                     * 04300022
*     REGISTER CONVENTIONS:                                           * 04400022
*        SEE PAGE FOLLOWING THESE SPECIFICATIONS                      * 04500022
*                                                                     * 04600022
*     PATCH LABEL = ZAPAREA                                    @Y17XARW 04700000
*                                                                     * 04800022
*  MODULE TYPE = PROCEDURE                                            * 04900022
*                                                                     * 05200022
*    PROCESSOR = ASSEMBLER XF                                         * 05250000
*                                                                     * 05260000
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY              @Y17XARW 05270000
*                                                                     * 05280000
*     ATTRIBUTES:                                                     * 05300022
*        REFRESHABLE, DISABLED, REUSEABLE, TRANSIENT(TYPE 4),         * 05400022
*       SUPERVISOR STATE,REENTRANT                                    * 05500000
*                                                                     * 05600022
*  ENTRY POINT = IGCMB10D                                             * 05700022
*                                                                     * 05800022
*     PURPOSE = ENTERED FROM IGCM610D WHEN A GOTRACE OR NOTRACE       * 05900022
*        OPERATOR CONTROL REQUEST IS ENTERED FOR A GROUPNAME/RLN ON A * 06000022
*        3705.                                                        * 06100022
*        ENTERED FROM IGC0210D WHEN A RESPONSE UNIT IS         @Y17XARW 06300000
*        RETURNED FROM TCAM FOR A GOTRACE/NOTRACE REQUEST      @Y17XARW 06400000
*                                                                     * 06500022
*     LINKAGE = ALL MODULES XCTL TO IGCMB10D                   @Y17XARW 06600000
*               IGCM610D XCTL'S TO MB ON A FIRST REQUEST FOR   @Y17XARW 06610000
*                 3705 LINE TRACE                              @Y17XARW 06620000
*               IGC0010D XCTL'S TO MB AFTER CHECKING OCWTG     @Y17XARW 06630000
*               IGC0210D XCTL'S TO MB AFTER CHECKING OCWTG     @Y17XARW 06640000
*                                                                     * 06650000
*                                                                     * 06700022
*  INPUT =                                                            * 06800000
*        COMMON - R1 = OP CONTROL AVT ADDRESS                  @Y17XARW 06900000
*        ENTRY FROM M6 - OCMODNME= BYTES LEFT TO SCAN          @Y17XARW 07100000
*                        OCMODNME+4= NEXT BYTE SCANNED         @Y17XARW 07110000
*                        OCLINTTE = LINE TTE ADDRESS           @Y17XARW 07120000
*                        OCBACKUP = GRPNME                     @Y17XARW 07130000
*        ENTRY FROM 00 - OCLINTTE = LINE TTE ADDRESS           @Y17XARW 07140000
*                        OCBACKUP = GRPNME                     @Y17XARW 07150000
*        ENTRY FROM 02 - OCMODNME = NCP ADDRESS                @Y17XARW 07160000
*                        OCUNIT = BUFFER ADDRESS               @Y17XARW 07170000
*                        OCBACKUP = GRPNME                     @Y17XARW 07180000
*                                                                     * 07190000
*                                                                     * 07200022
*     OUTPUT =                                                        * 07300000
*        COMMON     - R1 = OP CONTROL AVT ADDRESS              @Y17XARW 07370000
*                          OPCCOPCE = ADDRESS OF CURRENT ELEM  @Y17XARW 07440000
*        EXIT TO 00 - OCWTG = ID OF NEXT MODULE TO GAIN CONTROL@Y17XARW 07510000
*        EXIT TO 02 - OCWTG = ID OF NEXT MODULE TO GAIN CONTROL@Y17XARW 07580000
*                     OCUNIT= ADDRESS OF PACKED RU             @Y17XARW 07650000
*        EXIT TO M1 - R0 = OUTPUT MESSAGE NUMBER               @Y17XARW 07720000
*                  - OCBACKUP = GRPNAME INSERT FOR MSG         @Y17XART 07760000
*                                                                     * 07800022
*  EXITS, NORMAL:                                                     * 07900022
*     TO IGC0010D TO PROCESS THE NEXT OPCE AFTER ENQUEUEING AN OPCE   * 08000022
*     ON THE OPCFMDFC CHAIN BEHIND AN IN-PROCESS OPCE FOR THE  @Y17XARW 08100000
*     SAME 3705.                                               @Y17XARW 08200000
*     TO IGC0210D TO SEND AN RU TO THE 3705 IF REQUEST HAS     @Y17XARW 08300000
*     BEEN ANALYZED BUT NOT YET CARRIED OUT.                   @Y17XARW 08400000
*     TO IGCM110D TO WRITE OUT THE PROPER MESSAGE IF REQUEST IS ALL   * 08700022
*     PROCESSED.                                                      * 08800022
*                                                                     * 08900022
*  EXIT, ERROR:                                                       * 09000022
*     TO IGC0310D TO SEND AN ERROR MESSAGE TO THE ORIGINATOR OF THE   * 09100022
*     REQUEST.                                                        * 09200022
*                                                                     * 09300022
*  EXTERNAL REFERENCES:                                               * 09400022
*     ROUTINES:                                                       * 09500022
*        XCTL                                                         * 09600022
*        OPCDCBLK - DCB LOOKUP ROUTINE IN IEDQCA                      * 09700022
*        OPCGETBF - GET-BUFFER ROUTINE IN IEDQCA                      * 09800022
*        OPCFREBF - FREE-BUFFER ROUTINE IN IEDQCA                     * 09900022
*        GETMAIN                                                      * 10000022
*        FREEMAIN                                                     * 10100022
*        COHORTLK                                              @Y17XARW 10120000
*        LOAD                                                  @Y17XARW 10140000
*        IEDQTL-DEVICE DEPENDENTS FIELD LOOKUP ROUTINE         @Y17XARW 10160000
*                                                                     * 10200022
*     DATA AREAS:                                                     * 10300022
*        OPERATOR CONTROL AVT                                         * 10400022
*                                                                     * 10500022
*     CONTROL BLOCKS:                                                 * 10600022
*        AVT                                                   @Y17XARW 10620000
*        NCP                                                   @Y17XARW 10640000
*        OP CONTROL AVT                                        @Y17XARW 10660000
*        OPCE (OPERATOR CONTROL ELEMENT)                              * 10700022
*        PRU                                                   @Y17XARW 10730000
*        TRM                                                   @Y17XARW 10760000
*                                                                     * 11100022
*  TABLES/WORK AREAS = LINE TRACE TABLE CONTROL AND PREFIX AREAS      * 11200022
*                                                                     * 11300022
*  MACROS:                                                            * 11400022
*     GETMAIN                                                         * 11500022
*     FREEMAIN                                                        * 11600022
*     LOAD                                                     @Y17XARW 11650000
*     XCTL                                                            * 11700022
*                                                                     * 11800022
*  CHANGE ACTIVITY = AS FOLLOWS:                                      * 11820000
************************MICROFICHE FLAGS*********************SUPT CODE* 11840000
*A000000-999999                                                @Y16X5R0 11860000
*A158500,181500,185100,257500,395200-402600,419200-419600,       Y06328 11900205
*A480200-480600,484200-484800                                    Y06328 11900305
*C199000-228000,416000,455000,477000                             Y06328 11900405
*D418000,483000                                                  Y06328 11900505
*     A319000,417000                                           SA67105* 11900654
*A523500                                                       @YA04878 11900756
*C291000,292000                                                @YA04878 11900856
*D418000                                                       @YA09099 11900958
*A419600,319000                                                @YA09099 11901058
*A052500,101000,106000,116000,142000,155000,158000,            @Y17XARW 11911000
*A172000,185600,299000,414000,471000,476000-484800,516000      @Y17XARW 11921000
*C005000,011000,023000-031000,047000,063000-064000,066000,     @Y17XARW 11931000
*C069000-071000,074000-077000,084000-085000,109000-110000,     @Y17XARW 11941000
*C119000-119001,145000-148000,191000-193000,199000-229000,     @Y17XATW 11951000
*C254000,257000-264000,272000,                                 @Y17XARW 11961000
*C276000-282000,291000-293000,297000-298000,                   @Y17XARW 11971000
*C306000,309000,311000-3121000,317000-320000,327000,329000,    @Y17XARW 11981000
*C330000,342000-343000,358000,380000,382000,415000-419800,     @Y17XARW 11991000
*C422000,426000-427000,430000-432000,435000,436000,            @Y17XARW 12001000
*C438000-439000,443000,450000,452000-453000,455000,459000,     @Y17XARW 12011000
*C463000,469000-471000                                         @Y17XARW 12021000
*D011500,518000                                                @Y17XARW 12031000
*A412000,579000,585000                                         @OZ30601 12061082
*                                                                     * 12100022
*********************************************************************** 12200022
         EJECT                                                          12300022
RZERO    EQU   0                        PARM REG 0                      12400022
RPARM    EQU   1                        PARM REG 1                      12500022
ROPCAVT  EQU   2                        OP CONTROL AVT ADDR             12600022
ROPCE    EQU   3                        OP CONTROL ELEMENT ADDR         12700022
RAVT     EQU   4                        TCAM AVT ADDR                   12800022
RTERML   EQU   5                        ADDR OF LINE'S TERMINAL ENTRY   12900022
RTRCA    EQU   6                        ADDR OF TRACE TABLE AREA        13000022
RWORK6   EQU   6                        WORK REG                        13100022
RDCB     EQU   7                        DCB                             13200022
RWORK8   EQU   8                        WORK REG                        13300022
RSAVT    EQU   8                        SAVT ADDRESS           @Y17XARW 13320000
RNCP     EQU   9                        NCP DEV DEP FIELDS ADDR@Y17XARW 13340000
RNCPTTE  EQU   9                        NCP TTE ADDRESS        @Y17XARW 13360000
RSIZE    EQU   10                       SIZE OR LENGTH REG              13500022
RWORK10  EQU   10                       WORK REG                        13600022
RSCAN    EQU   11                       SCAN-POSITION REGISTER          13700022
RWORK11  EQU   11                       WORK REG                        13800022
RBASE    EQU   12                       BASE REG                        13900022
RSAVE    EQU   13                       SAVE AREA ADDR                  14000022
RRET     EQU   14                       SUBROUTINE ENTRY ADDR           14100022
RBRNCH   EQU   15                       SUBROUTINE BRANCH ENTRY POINT   14200022
         USING IEDQAVTD,RAVT            TCAM AVT ADDRESS       @Y17XARW 14250000
         USING IEDQOPCD,ROPCAVT         OP CONTROL AVT                  14300022
         USING IEDQOPCN,ROPCE           OPCE NEGATIVE PREFIX   @Y17XARW 14400000
         USING IEDNCP,RNCP              NCP DEVICE DEP FIELDS  @Y17XARW 14500000
         USING IEDNSVTD,RSAVT           SAVT                   @Y17XARW 14600000
         USING IEDNTRM,RTERML           TTE NEGATIVE PREFIX    @Y17XARW 14700000
         USING IEDPRUND,RPARM           PACKED RU NEG PREFIX   @Y17XARW 14800000
         USING IEDHED,RTRCA             TRACE AREA                      14900000
         EJECT                                                          15000022
ZERO     EQU   0                        VALUE 0                         15100022
ONE      EQU   1                        VALUE 1                         15200022
TWO      EQU   2                        VALUE 2                         15300022
THREE    EQU   3                        VALUE 3                         15400022
FOUR     EQU   4                        VALUE 4                         15500022
FIVE     EQU   5                        VALUE 5                @Y17XARW 15550000
SIX      EQU   6                        VALUE 6                         15600022
SEVEN    EQU   7                        VALUE 7                         15700022
EIGHT    EQU   8                        VALUE 8                         15800022
FMASK    EQU   B'1111'                  FULLWORD ICM MASK      @Y17XARW 15820000
SIXTEEN  EQU   16                       VALUE 16                 S05331 15850005
SEVNTEEN EQU   17                       DCB-NOT-OPEN ERROR MSG NO       15900022
EIGHTEEN EQU   18                       INVALID-REQUEST MESSAGE NO.     16000022
TWENTY3  EQU   23                       TRACE-STARTED MSG NO.           16100022
TWENTY4  EQU   24                       TRACE ALREADY STARTED  @YM07023 16150000
TWENTY8  EQU   28                       LENGTH OF CTL DATA / HALF TBL   16200022
TWENTY9  EQU   29                       TRACE-STOPPED MSG NO.           16300022
THIRTY   EQU   30                       TRACE-ALREADY-OFF MSG NO.       16400022
FORTY8   EQU   48                       LENGTH OF TABLE CONTROL INFO    16500022
SEVENTY6 EQU   76                       TBL CTL INFO + HALF-TBL INFO    16600022
HUNDRED  EQU   100                      TABLE-SIZE DEFAULT              16700022
LTRCOSZ  EQU   104                      LINE TRACE OVERHEAD AREA SIZE   16800022
NOCORE   EQU   423                      CORE-UNAVAILABLE MSG NUMBER     16900000
TWOFIFTY EQU   250                      SUBPOOL NO FOR GETMAIN/FREEMAIN 17000022
TWO55    EQU   255                      INTERVAL MAX (AND DEFAULT)      17100022
COMWTBSY EQU   376                      COMWRITE-USING-TABLE MSG NO     17200022
MSG400   EQU   400                      3705 NOT ACTIVE        @Y17XARW 17250000
FOUR03   EQU   403                      TRACE-DEACTIVATED ERROR MSG NO  17300022
MSG404   EQU   404                      ALREADY IN PROGRESS MESSAGE     17400022
X01      EQU   X'01'                    TRACE-INACTIVE SWITCH           17500022
TRACEOFF EQU   X'19'                    CODE FOR DEACTIVATE REQUEST     17800022
XF0      EQU   X'F0'                    HEX F0                          18200022
XFA      EQU   X'FA'                    HEX FA                          18300022
XFF      EQU   X'FF'                    HEX FF                          18400022
COMMA    EQU   C','                     SCAN DELIMITER                  18500022
CHAR0    EQU   C'0'                     CHARACTER 0                     18530022
CHAR9    EQU   C'9'                     CHARACTER 9                     18560022
RHFLAG0  EQU   X'0B'                    RH FLAG 0              @Y17XARW 18570000
RHFLAG1  EQU   X'80'                    RH FLAG 1              @Y17XARW 18580000
THFLAGS  EQU   X'1C'                    TH FLAGS               @Y17XARW 18590000
         EJECT                                                          18600022
         BALR  RBASE,0                  SET BASE REG                    18700022
         USING *,RBASE                  MODULE ADDRESSABILITY           18800022
IGCMB10D IEDHJN SKIPID                  MODULE IDENTIFIER               18850000
         LR    ROPCAVT,RPARM            OP CONTROL AVT BASE             18900022
         L     RAVT,OPCAVTPT            OP CONTROL AVT         @Y17XARW 18950000
         L     ROPCE,OPCCOPCE           OP CONTROL ELEMENT ADDRESS      19100022
         LA    RWORK8,OCPREFSZ          SETUP NEG PREF SIZE    @Y17XARW 19130000
         SR    ROPCE,RWORK8             BACKUP TO NEGATIVE PREF@Y17XARW 19160000
         TM    OCFLAG,OCRESP            RU RESPONSE?           @Y17XARW 19200000
         BO    PROCRU                   YES, GO PROCESS IT     @Y17XARW 19300000
         SPACE 2                                                        19400022
*********************************************************************** 19500022
*              THE OPCE IS A NEW REQUEST FOR GOTRACE OR NOTRACE.      * 19600022
*********************************************************************** 19700022
         SPACE                                                          19800022
         TM    OCSWITCH,OCSCANON        SCAN ALREADY DONE      @Y17XARW 22900000
         BO    ENDSCAN                  YES, BYPASS SCANNING            23000022
         SPACE 2                                                        23100022
*********************************************************************** 23200022
*              SCAN THE REQUEST MESSAGE STARTING AFTER THE 'ON' OR    * 23300022
*              'OFF'.                                                 * 23400022
*********************************************************************** 23500022
         SPACE                                                          23600022
         LM    RSIZE,RSCAN,OCMODNME     PICK UP SAVED SCAN REGS         23700022
         BAL   RRET,SCANOP              SCAN FOR INTERVAL OPERAND       23800022
         CH    RZERO,CON255             INTERVAL > 255                  23900022
         BH    INVALID                  YES, INVALID REQUEST            24000022
         LTR   RZERO,RZERO              INTERVAL = 0                    24100022
         BP    INTVALOK                 NO, DATA IS OK                  24200022
         LA    RZERO,TWO55              YES, USE DEFAULT OF 255         24300022
         SPACE                                                          24400022
INTVALOK STC   RZERO,OCMODNME+SIX       SAVE INTERVAL IN OPCE           24500022
         BAL   RRET,SCANOP              SCAN FOR TABLE-SIZE OPRND       24600022
         LTR   RSIZE,RSIZE              ANY REMAINING OPERANDS ?        24610022
         BNZ   INVALID                  YES, INVALID REQUEST            24620022
         BCTR  RSCAN,ZERO               POINT BACK TO LAST CHAR         24630022
         CLI   ZERO(RSCAN),COMMA        WAS LAST CHAR A COMMA ?         24640022
         BE    INVALID                  YES, INVALID REQUEST            24650022
         CH    RZERO,CONMAXH            SIZE > LIMIT                    24700022
         BH    INVALID                  YES, INVALID REQUEST            24800022
         LTR   RZERO,RZERO              SIZE = 0                        24900022
         BP    SIZEOK                   NO, DATA IS OK                  25000022
         LA    RZERO,HUNDRED            YES, USE DEFAULT OF 100         25100022
         SPACE                                                          25200022
SIZEOK   STH   RZERO,OCMODNME+FOUR      SAVE TABLE SIZE IN OPCE         25300022
         SPACE                                                          25304000
*********************************************************************** 25308000
*                                                                     * 25312000
*   THE COHORTLK RTN WILL BE USED TO FIND THE NCP TTE WHICH    @Y17XARW 25316000
*   WILL BE SAVED BY IGCMB10D IN THE OPCE.                     @Y17XARW 25320000
*                                                                     * 25324000
*********************************************************************** 25328000
         SPACE                                                          25332000
         L     RPARM,OCLINTTE           RESTORE LINE TTE ADDR  @Y17XARW 25336000
*                                        CALCULATED IN M6      @Y17XARW 25340000
         LA    RSAVE,OPCSAVE            SETUP SAVEAREA ADDR    @Y17XARW 25344000
         L     RBRNCH,OPCHORT           SETUP LOOKUP RTN ADDR  @Y17XARW 25348000
         BALR  RRET,RBRNCH              CALL COHORTLK TO FIND  @Y17XARW 25352000
*                                        NCP TTE ADDRESS       @Y17XARW 25356000
         LTR   RZERO,RZERO              FOUND NCP TTE          @Y17XARW 25360000
         BNZ   GOODRTN                  YES, GOOD RETURN       @Y17XARW 25364000
         LA    RZERO,MSG400             3705 NOT ACTIVE MSG    @YM07393 25368000
         B     XCTLERR                  ERROR EXIT             @Y17XARW 25372000
GOODRTN  EQU   *                                               @Y17XARW 25376000
         STH   RZERO,OCTRMTBL           SAVE NCP TNT           @Y17XARW 25380000
         LA    RPARM,ZERO(RPARM)        CLEAR HI-ORDER BYTE    @Y17XARW 25384000
         ST    RPARM,OCMODNME           SAVE NCP TTE           @Y17XARW 25388000
         SPACE                                                          25392000
ENDSCAN  EQU   *                                                        25600022
         NI    OCSWITCH,XFF-OCSCANON    TURN OFF SCAN-COMPLETE @Y17XARW 25700000
         L     RNCPTTE,OCMODNME         RESTORE NCP TTE ADDR   @Y17XARW 25750000
         SPACE 2                                                        25800022
*********************************************************************** 25900022
*              SEARCH THE OPCFMDFC CHAIN TO SEE IF  THERE IS A @Y17XARW 26000000
*              PREVIOUS REQUEST FOR THIS NCP.                  @Y17XARW 26100000
*********************************************************************** 26200022
         SPACE                                                          26300022
         LA    RWORK6,OPCFMDFC          INITIALIZE FOR SEARCH  @Y17XARW 26400000
         SPACE                                                          26500022
NLOOPA   L     RWORK6,ZERO(RWORK6)      NEXT OPCE ON WAIT CHAIN         26600022
         LA    RWORK6,ZERO(RWORK6)      CLEAR HIGH-ORDER BYTE           26700022
         LTR   RWORK6,RWORK6            END OF CHAIN                    26800022
         BZ    NLOOPANO                 BRANCH IF YES                   26900022
         CLC   OCWTG-IEDQOPCE(TWO,RWORK6),THISMOD  OPCE FROM MB         27000022
         BNE   NLOOPA                   BRANCH IF NO                    27100022
         C     RNCPTTE,OCMODNME-IEDQOPCE(FOUR,RWORK6)          @Y17XARW 27200000
*                                       OPCE FOR SAME 3705?    @Y17XARW 27260000
         BNE   NLOOPA                   NO, KEEP SEARCHING              27320000
         SPACE 2                                                        27400022
*********************************************************************** 27500022
*        AN OPCE HAS BEEN FOUND ON THE OPCFMDFC CHAIN WHICH    @Y17XARW 27600000
*        CARRIES A REQUEST FOR THE SAME 3705 AS THE NEW OPCE   @Y17XARW 27700000
*        WE ARE PROCESSING.  ENQUEUE THE NEW OPCE OFF THE ONE  @Y17XARW 27800000
*        CURRENTLY IN THE CHAIN.                               @Y17XARW 27900000
*********************************************************************** 28000022
         SPACE                                                          28100022
         OI    OCSWITCH,OCSCANON        FLAG OPCE SCAN COMPLETE@Y17XARW 28200000
         SPACE                                                          28300022
NLOOPAQ  TM    OCFLAG-IEDQOPCE(RWORK6),OCATTACH  SIDE-CHAIN END         28400022
         BZ    ADDA                     BRANCH IF YES                   28500022
         L     RWORK6,OCELEM-IEDQOPCE(RWORK6)  GET NEXT ONE             28600022
         B     NLOOPAQ                  KEEP LOOKING                    28700022
         SPACE                                                          28800022
ADDA     OI    OCFLAG-IEDQOPCE(RWORK6),OCATTACH  SIDE-CHAIN END         28850000
         MVC   OCWTG(TWO),THISMOD       MARK FOR RETURN TO MB  @Y17XARW 29100000
         LA    ROPCE,OCPREFSZ(ROPCE)    ADJUST FOR OPCE        @Y17XARW 29130000
         ST    ROPCE,OCELEM-IEDQOPCE(RWORK6) ATTACH NEW OPCE   @Y17XARW 29160000
         MVC   OPCMODID(TWO),FIRSTLD        SET FOR XCTL TO    @Y17XARW 29300000
         B     EXIT                     FIRST LOAD OF OPEN              29400022
         SPACE 2                                                        29500022
*********************************************************************** 29600022
*        NO PREVIOUS OPCE FOR THIS SAME 3705 WAS FOUND. SETUP  @Y17XARW 29700000
*        ADDRESSABILITY TO THE NCP DEVICE DEPENDENTS FIELDS.   @Y17XARW 29760000
*        THEN CHECK REQUEST TYPE.                              @Y17XARW 29820000
*********************************************************************** 29900022
         SPACE                                                          30000022
NLOOPANO EQU   *                                               @Y17XARW 30030000
         BAL   RWORK8,NCPDEV            DEVICE DEP FIELDS ADDR @Y17XARW 30060000
         CLI   OCSWITCH,TRACEOFF        DEACTIVATE REQUEST              30100000
         BNE   ACTIVATE                 BRANCH IF NO                    30200022
         SPACE 2                                                        30300022
*********************************************************************** 30400022
*              DEACTIVATE REQUEST - CHECK THE REQUEST & BUILD & SEND  * 30500022
*              THE PROPER REQUEST UNIT.                        @Y17XARW 30600000
*********************************************************************** 30700022
         SPACE                                                          30800022
         OC    NCPLTRAC,NCPLTRAC        TRACE ADDR IN NCP      @Y17XARW 30900000
         BZ    ALOF                     NO, ALREADY DEACTIVATED         31000022
         TM    NCPFLAG1,NCPTRACE        IS IT ACTIVE           @Y17XARW 31100000
         BZ    ALOF                     BRANCH IF NO           @Y17XARW 31140000
         ICM   RTRCA,FMASK,NCPLTRAC     TRACE TABLE ADDRESS    @Y17XARW 31180000
         CLC   OCRLN,HEDRLN             SAME RELATIVE LINE NUMBER?      31220000
         BNE   ALOF                     BRANCH IF NO                    31230000
         ICM   RWORK8,7,HEDFSTHF        ADDR OF 1ST HALF OF TABLE       31240000
         CLC   OCBACKUP,TABLINUM-TABHALF(RWORK8)  SAME GROUP NAME?      31250000
         BE    DEACTVAT                 BRANCH IF YES                   31260000
         SPACE                                                          31300022
ALOF     LA    RZERO,THIRTY             ALREADY-OFF ERROR MSG           31400022
         B     XCTLERR                  ERROR EXIT                      31500022
         SPACE                                                          31600022
DEACTVAT BAL   RWORK8,BUILDRU           BUILD A REQUEST UNIT   @Y17XARW 31700000
         MVC   PRUDATA(THREE),DEACT     SETUP COMMAND          @Y17XARW 31750000
         MVI   PRUDATA+SIX,ZERO         RESERVED BYTE          @Y17XARW 31800000
         L     RTERML,OCLINTTE          SETUP LINE TTE ADDRESS @Y17XARW 31850000
         LA    RWORK8,TRMPRFSZ          LEN OF NEG PREFIX      @Y17XARW 31900000
         SR    RTERML,RWORK8            POINT TO NEG PREFIX    @Y17XARW 31950000
         NI    TRMLINK,XFF-TRMLINT      MARK LINE TRACE INACT  @Y17XARW 32000000
         B     SETSND                   EXIT TO SEND THE RU    @Y17XARW 32050000
         SPACE 2                                                        32100022
*********************************************************************** 32200022
*              ACTIVATE REQUEST - CHECK THE REQUEST VS PRESENT STATE  * 32300022
*              OF THE SYSTEM.                                         * 32400022
*********************************************************************** 32500022
         SPACE                                                          32600022
ACTIVATE OC    NCPLTRAC,NCPLTRAC        TRACE ADDR IN NCP      @Y17XARW 32700000
         BZ    ACT1                     NO, GO ACTIVATE TRACE           32800022
         TM    NCPFLAG1,NCPTRACE        IS IT ACTIVE           @Y17XARW 32900000
         BZ    NOTACTIV                 BRANCH IF NO           @Y17XARW 33000000
         LA    RZERO,MSG404             ALREADY IN PROGRESS ERROR MSG   33100022
         B     XCTLERR                  ERROR EXIT                      33200022
         SPACE 2                                                        33300022
*********************************************************************** 33400022
*              THERE IS A TRACE TABLE AREA FOR THIS 3705 LEFT OVER    * 33500022
*              FROM A PREVIOUS GOTRACE COMMAND, NOW DEACTIVATED.      * 33600022
*              THROW AWAY THE OLD TRACE TABLE UNLESS IT IS STILL IN   * 33700022
*              USE BY COMWRITE.                                       * 33800022
*********************************************************************** 33900022
         SPACE                                                          34000022
NOTACTIV EQU   *                                                        34100022
         ICM   RTRCA,FMASK,NCPLTRAC     GET TRACE AREA ADDR    @Y17XARW 34200000
         OI    NCPFLAG1,NCPTRACE        TURN ON ACTIVE FLAG    @Y17XARW 34300000
         TM    HEDFLAG,HEDCWOK          COMWRITE IN PROGRESS?           34400000
         BO    CLEARTRC                 NO, GO CLEAR OLD TABLE          34500022
         LA    RZERO,COMWTBSY           SET ERROR MSG NO                34600022
         B     XCTLERR                  ERROR EXIT                      34700022
         DROP  RPARM                                                    34800022
         USING LSTDSECT,RPARM           GETMAIN/FREEMAIN LIST           34900022
         SPACE                                                          35000022
CLEARTRC L     RPARM,OPCOPTLK           ADDR OF FREEMAIN LIST           35100022
         MVC   LSTSIZE,HEDSIZE          SIZE OF AREA TO FREE            35200022
         LA    RWORK8,OPCDOUBL          ADDR OF PTR TO AREA             35300022
         ST    RWORK8,LSTADDR           ADDR OF PTR TO AREA             35400022
         ST    RTRCA,OPCDOUBL           POINTER TO AREA TO FREE         35500022
         MVI   LSTSP,TWOFIFTY           SPECIFY SUBPOOL 250             35600022
         FREEMAIN  ,MF=(E,(1))          FREE CORE FROM OLD TABLE        35700022
         XC    NCPLTRAC,NCPLTRAC        ZERO TABLE ADDRESS     @Y17XARW 35800000
         SPACE 2                                                        35900022
*********************************************************************** 36000022
*              GET THE CORE NEEDED FOR THE TRACE TABLE, INITIALIZE    * 36100022
*              THE CONTROL INFORMATION, AND LOAD THE TRACE ROUTINE.   * 36200022
*********************************************************************** 36300022
         SPACE                                                          36400022
ACT1     LH    RSIZE,OCMODNME+FOUR      NUMBER OF TABLE ENTRIES         36500022
         LA    RSIZE,ONE(RSIZE)         ROUND UP TO EVEN NUMBER ...     36600000
         SRL   RSIZE,ONE                ... (IF NECESSARY) AND ...      36700022
         SLL   RSIZE,THREE              ... MULTIPLY BY FOUR            36800022
         LA    RSIZE,LTRCOSZ(RSIZE)     ADD SIZE OF CONTROL INFO        36900022
         L     RPARM,OPCOPTLK           ADDR OF GETMAIN LIST            37000022
         ST    RSIZE,LSTSIZE            STORE SIZE NEEDED               37100022
         LA    RWORK8,OPCDOUBL          ADDR OF PTR TO AREA             37200022
         ST    RWORK8,LSTADDR           STORE ADDR IN LIST              37300022
         XC    OPCDOUBL(FOUR),OPCDOUBL  CLEAR FIRST WORD OF PARM LIST   37350022
         MVI   LSTSP,TWOFIFTY           SPECIFY SUBPOOL 250             37400022
         GETMAIN  ,MF=(E,(1))           GET CORE FOR TABLE              37500022
         LTR   RBRNCH,RBRNCH            SUCCESSFUL GETMAIN              37600022
         BZ    OKGETMN                  BRANCH IF YES                   37700022
         LA    RZERO,NOCORE             NO-CORE-AVAILABLE MSG NO        37800022
         B     XCTLERR                  ERROR EXIT                      37900022
         USING IEDPRUND,RPARM           RU BUFF ADDRESSABILITY @Y17XARW 38000000
         SPACE                                                          38100022
OKGETMN  MVC   NCPLTRAC,OPCDOUBL        MOVE TRACE ADDR TO NCP @Y17XARW 38200000
         L     RTRCA,OPCDOUBL           TRACE ADDR BASE                 38300022
         XC    IEDHED(SEVENTY6),IEDHED  ZERO OUT CONTROL INFO           38400000
*                                       & FIRST HALF-TBL HEADER         38500022
         MVI   HEDSWCHS,HEDTBL1         SET UP SWITCHES                 38600000
         OI    HEDFLAG,HEDCWOK          SET COMWRITE COMPLETION FLAG    38630000
         MVC   HEDID,LINTID             INITIALIZE ID FOR COMWRITE      38660000
         ST    RSIZE,HEDSIZE            OVER-ALL TRACE AREA SIZE        38700022
         SH    RSIZE,CON48              SUBTRACT SIZE OF CTL AREA       38800022
         SRL   RSIZE,ONE                DIVIDE BY TWO TO GET            38900022
*                                       SIZE OF EACH HALF-TABLE         39000022
         STH   RSIZE,HEDHLFSZ           SET UP HALF-TABLE SIZE FIELD    39100022
         LA    RWORK11,FORTY8(RTRCA)    ADDR OF 1ST HALF-TABLE          39200022
         STCM  RWORK11,7,HEDFSTHF       STORE IN CTL INFO               39300000
         USING TABHALF,RWORK11                                          39400022
         MVC   TABLINUM,OCBACKUP        GROUP NAME                      39500022
         MVI   TABCOMMA,C','            INITIALIZE COMMA CONSTANT       39600022
         SR    RZERO,RZERO              CLEAR REGISTER                  39700022
         IC    RZERO,OCRLN              GET RELATIVE LINE NO (BINARY)   39800022
         STC   RZERO,HEDRLN             SAVE RLN IN CTL AREA            39850000
         CVD   RZERO,OPCDOUBL           CONVERT IT TO PACKED DECIMAL    39900022
         UNPK  OPCDOUBL(THREE),OPCDOUBL+SIX(TWO)  UNPACK THE RLN DATA   40000022
         OI    OPCDOUBL+TWO,XF0         MAKE SIGNED LAST DIGIT READABLE 40100022
         MVC   TABRLN,OPCDOUBL          MOVE RLN INTO TABLE AREA        40200022
         SPACE 1                                                 S05331 40230005
SECHALF  EQU   *                                                 S05331 40260005
         LA    RBRNCH,ZERO(RWORK11,RSIZE)  ADDR OF 2ND TBL-HALF         40300022
         MVC   ZERO(TWENTY8,RBRNCH),TABHALF  COPY 1ST HALF HEADER       40400022
*                                       INFO INTO 2ND HALF              40500022
         LA    RWORK11,TABDATA          ADDR OF 1ST TABLE ENTRY         40600022
         ST    RWORK11,HEDTBPOS         STORE 1ST TABLE ENTRY           40700022
         DROP  RWORK11                                                  40800022
         STCM  RBRNCH,7,HEDSECHF        ADDR OF 2ND TABLE-HALF          40900022
         SH    RSIZE,CON28              DATA LENGTH/HALF-TABLE          41000022
         STH   RSIZE,HEDREMLN           INITIALIZE DATA-LENGTH          41100022
         STH   RSIZE,HEDDATLN           ... FIELDS IN CTL INFO          41200022
         EJECT                                                 @OZ30601 41201082
************************************************************** @OZ30601 41202082
* THE FOLLOWING SECTION OF CODE CHECKS THAT THE BLOCKSIZE    * @OZ30601 41203082
* FOR THE COMWRITE DATA SET(IF OPEN) IS LARGE ENOUGH TO      * @OZ30601 41204082
* CONTAIN 1/2 OF THE 3705 LINE TRACE TABLE DEFINED BY THE    * @OZ30601 41205082
* START LINE TRACE COMMAND.  IF THE BLOCKSIZE IS LARGE       * @OZ30601 41206082
* ENOUGH, ACTION PROCEEDS AS BEFORE.  IF THE BLOCKSIZE IS    * @OZ30601 41207082
* NOT LARGE ENOUGH, THEN SOME LINE TRACE DATA WILL BE LOST.  * @OZ30601 41208082
* THIS FIX WILL WRITE MESSAGE IED624I TO THE OPERATOR,       * @OZ30601 41209082
* INFORMING HIM THAT DATA WILL BE LOST.  THE MESSAGE WILL    * @OZ30601 41210082
* ALSO TELL HIM THE MAXIMUM NUMBER OF TRACE TABLE ENTRIES HE * @OZ30601 41211082
* CAN REQUEST WITHOUT LOSING TRACE DATA WITH HIS CURRENT     * @OZ30601 41212082
* COMWRITE DATA SET.  THE COMMAND WILL THEN CONTINUE         * @OZ30601 41213082
* EXECUTING AS NORMAL.  THE SHORT TERM SOLUTION TO THE       * @OZ30601 41214082
* PROBLEM IS FOR THE OPERATOR TO STOP LINE TRACE AND THEN    * @OZ30601 41215082
* START IT AGAIN SPECIFYING AN ACCEPTABLE NUMBER OF ENTRIES. * @OZ30601 41216082
* THE LONG TERM SOLUTION TO THE PROBLEM IS FOR THE OPERATOR  * @OZ30601 41217082
* TO SPECIFY A BLKSIZE ON HIS COMWRITE DD CARD WHICH WILL BE * @OZ30601 41218082
* LARGE ENOUGH TO CONTAIN 1/2 OF THE TRACE TABLE HE DESIRES. * @OZ30601 41219082
************************************************************** @OZ30601 41220082
         SPACE 1                                               @OZ30601 41221082
* REGISTER EQUATES FOR THIS PTM FIX ONLY                       @OZ30601 41222082
         SPACE 1                                               @OZ30601 41223082
RWORK    EQU   0                                               @OZ30601 41224082
ROFF     EQU   0                                               @OZ30601 41225082
RTCB     EQU   1                                               @OZ30601 41226082
RDEB     EQU   1                                               @OZ30601 41227082
RTIOT    EQU   8                                               @OZ30601 41228082
RLEN     EQU   11                                              @OZ30601 41229082
RDCB2    EQU   11                                              @OZ30601 41230082
         SPACE 1                                               @OZ30601 41231082
         USING TCB,RTCB                                        @OZ30601 41232082
         USING TIOT,RTIOT                                      @OZ30601 41233082
         USING IHADCB,RDCB2                                    @OZ30601 41234082
         EJECT                                                 @OZ30601 41235082
         TM    AVTCWFL2,AVTCWACT IS COMWRITE ACTIVE?           @OZ30601 41236082
         BZ    NOCOMWR       NO-NO NEED TO MAKE CHECK          @OZ30601 41237082
         L     RTCB,AVTCWTCB GET COMWRITE TCB ADDRESS          @OZ30601 41238082
         L     RTIOT,TCBTIO  GET TCAM TIOT ADDRESS             @OZ30601 41239082
         SLR   RLEN,RLEN     CLEAR LENGTH WORKING REGISTER     @OZ30601 41240082
DDLOOP   ICM   RLEN,1,TIOELNGH GET LENGTH OF NEXT DD           @OZ30601*41241082
                             ENTRY IN TIOT                     @OZ30601 41242082
         BZ    NOCOMWR       COMWRITE DD ENTRY NOT FOUND       @OZ30601 41243082
         CLC   TIOEDDNM,COMWRITE IS THE CURRENT ENTRY          @OZ30601*41244082
                             THE COMWRITE ENTRY?               @OZ30601 41245082
         BE    DDFOUND       BRANCH IF YES                     @OZ30601 41246082
         AR    RTIOT,RLEN    GET NEXT DD ENTRY IN TIOT         @OZ30601 41247082
         B     DDLOOP        CHECK NEXT DD ENTRY IN TIOT       @OZ30601 41248082
DDFOUND  SLR   RWORK,RWORK   CLEAR REGISTER                    @OZ30601 41249082
         ICM   RWORK,7,TCBTIO+1 GET TIOT START ADDR            @OZ30601 41250082
         LA    RTIOT,TIOELNGH GET TIOELNGH ADDRESS             @OZ30601 41251082
         SR    RTIOT,RWORK   CALCULATE TIOT OFFSET OF          @OZ30601*41252082
                             COMWRITE DD ENTRY                 @OZ30601 41253082
         LA    RDEB,TCBDEB-4 SET UP DEB CHAIN SCAN             @OZ30601 41254082
         SLR   ROFF,ROFF     CLEAR WORK REGISTER FOR LOAD      @OZ30601 41255082
         USING DEBBASIC,RDEB                                   @OZ30601 41256082
NEXTDEB  ICM   RDEB,7,DEBDEBB GET NEXT DEB ADDRESS             @OZ30601 41257082
         BZ    NOCOMWR       NO DEB FOUND FOR COMWRITE DD      @OZ30601 41258082
         L     RDCB2,DEBDCBAD GET DCB ADDRESS FOR DEB          @OZ30601 41259082
         ICM   ROFF,3,DCBTIOT GET TIOT OFFSET OF DD            @OZ30601*41260082
                             ENTRY FOR THIS DCB                @OZ30601 41261082
         CR    RTIOT,ROFF    IS DCB TIOT OFFSET SAME AS        @OZ30601*41262082
                             COMWRITE DD OFFSET?               @OZ30601 41263082
         BNE   NEXTDEB       NO--GET NEXT DEB                  @OZ30601 41264082
         SLR   ROFF,ROFF     CLEAR REGISTER                    @OZ30601 41265082
         ICM   ROFF,3,DCBBLKSI GET COMWRITE BLOCKSIZE          @OZ30601 41266082
* WE NOW HAVE THE BLOCKSIZE OF THE COMWRITE DATASET            @OZ30601 41267082
         SH    ROFF,CON28    SUBTRACT 1/2 TABLE CONTROL WORD   @OZ30601*41268082
                             LENGTH                            @OZ30601 41269082
         CR    ROFF,RSIZE    IS THE BLOCKSIZE LARGE ENOUGH?    @OZ30601 41270082
         BNL   NOCOMWR       YES                               @OZ30601 41271082
         SRL   ROFF,2        DIVIDE TRACE ENTRY SPACE BY 4     @OZ30601 41272082
         CVD   ROFF,OPCDOUBL CONVERT BINARY TO PACKED DECIMAL  @OZ30601 41273082
         UNPK  OPCDOUBL(5),OPCDOUBL+5(3) CONVERT 3 BYTES OF    @OZ30601*41274082
                             PACKED DECIMAL TO 5 BYTES OF      @OZ30601*41275082
                             ZONED DECIMAL                     @OZ30601 41276082
         OI    OPCDOUBL+4,XF0 CONVERT SIGNED BYTE TO EBCDIC    @OZ30601 41277082
         MVC   ENTRYNUM(5),OPCDOUBL MOVE MAXIMUM ENTRY NUMBER  @OZ30601*41278082
                             INTO MESSAGE                      @OZ30601 41279082
         WTO   MF=(E,MSG624) WRITE MESSAGE TO OPERATOR         @OZ30601 41280082
         B     NOCOMWR       SKIP DATA                         @OZ30601 41281082
         EJECT                                                 @OZ30601 41282082
MSG624   WTO   'IED624I TRACE DATA WILL BE LOST-SPECIFY NO MORE THAN YY*41283082
               YYY ENTRIES',MF=L,ROUTCDE=(8),DESC=(5)          @OZ30601 41284082
         SPACE 1                                               @OZ30601 41285082
ENTRYNUM EQU   MSG624+57                                       @OZ30601 41286082
         SPACE 1                                               @OZ30601 41287082
COMWRITE DC    CL8'COMWRITE'                                   @OZ30601 41288082
         SPACE 1                                               @OZ30601 41289082
         DROP  RDCB2                                           @OZ30601 41290082
         USING IEDPRUND,RPARM                                  @OZ30601 41291082
         USING IEDNSVTD,RSAVT                                  @OZ30601 41292082
         EJECT                                                 @OZ30601 41293082
NOCOMWR  EQU   *     END OF COMWRITE BLOCKSIZE CHECK           @OZ30601 41294082
         LOAD  EP=IEDNLT                LOAD TRACE ROUTINE              41300022
         ST    RZERO,HEDTRCAD           STORE ROUTINE ADDRESS           41400022
         L     RSAVT,AVTSAVTP           POINT TO SAVT          @Y17XARW 41430000
         ST    RZERO,SAVTRNTA           STORE RTN ADDR IN SAVT @Y17XARW 41460000
         BAL   RWORK8,BUILDRU           BUILD A REQUEST UNIT   @Y17XARW 41500000
         MVC   PRUDATA(THREE),ACT       SETUP COMMAND TYPE     @Y17XARW 41560000
         MVC   PRUDATA+SIX(ONE),OCMODNME+SIX  SETUP INTERVAL   @Y17XARW 41620000
         L     RTERML,OCLINTTE          SETUP LINE TTE         @Y17XARW 41680000
         LA    RWORK8,TRMPRFSZ          LEN OF NEG PREFIX      @Y17XARW 41740000
         SR    RTERML,RWORK8            POINT TO NEG PREFIX    @Y17XARW 41800000
         OI    TRMLINK,TRMLINT          MARK LINE TRACE ACTIVE @Y17XARW 41860000
         SPACE 2                                                        42000022
*********************************************************************** 42100022
*              SET UP TO SEND THE PACKED RU TO THE 3705.       @Y17XARW 42200000
*********************************************************************** 42300022
         SPACE                                                          42400022
SETSND   MVC   OCWTG(TWO),THISMOD       SET RETURN TO THIS MOD          42500022
         MVC   OPCMODID(TWO),RUDISP     SET DISP MOD NAME      @Y17XARW 42600000
         B     EXIT                     GO XCTL TO RU DISP     @Y17XARW 42700000
         EJECT                                                          42800022
*********************************************************************** 42900022
*              THE OPCE REPRESENTS A RESPONSE UNIT RETURNED    @Y17XARW 43000000
*              FROM THE 3705.  ANALYZE THE RESPONSE AND SETUP  @Y17XARW 43100000
*              THE PROPER MESSAGE NUMBER AND EXIT.             @Y17XARW 43200000
*********************************************************************** 43300022
         SPACE                                                          43400022
PROCRU   EQU   *                                               @Y17XARW 43500000
         BAL   RWORK8,NCPDEV            GET NCP DEVICE DEPEN-  @Y17XARW 43560000
*                                       DENT FIELDS ADDRESS    @Y17XARW 43620000
         L     RPARM,OCUNIT             BUFFER ADDRESS                  43700022
         LA    RWORK8,PRUNLEN           SETUP NEG PREF LEN     @Y17XARW 43800000
         SR    RPARM,RWORK8             POINT TO NEG PREFIX    @Y17XARW 43900000
         MVC   OPCDOUBL(EIGHT),OCBACKUP SET GRPNAME PARAMETER           44050022
         CLI   OCSWITCH,TRACEOFF        DEACTIVATE REQUEST              44100022
         BNE   ENDACT                   NO, ITS AN ACTIVATE REQUEST     44200022
         NI    NCPFLAG1,XFF-NCPTRACE    MARK TRACE INACTIVE    @Y17XARW 44300000
         LA    RZERO,TWENTY9            TRACE-STOPPED MSG NO            44400022
         B     XCTLMOD                  EXIT TO CHECKPOINT AND          44500022
*                                       MESSAGE-WRITER MODULES          44600022
         SPACE                                                          44700022
ENDACT   LA    RZERO,TWENTY3            TRACE-STARTED MSG NO            44800022
         OI    NCPFLAG1,NCPTRACE        TRACE ACTIVE           @YM07023 44900000
         TM    PRURHFG0,PRURHSDI        ERROR ON RESPONSE      @Y17XARW 45000000
         BZ    XCTLMOD                  NO, EXIT TO CHKPT AND MSG       45100000
         CLC   PRUDATA(TWO),ACTIVE      ALREADY ACTIVE         @YM07023 45110000
         BNE   AROUND                   MUST BE AN ERROR       @YM07023 45120000
         LA    RZERO,TWENTY4            ALREADY STARTED        @YM07023 45130000
         B     XCTLERR                  PUT OUT MSG            @YM07023 45140000
AROUND   EQU   *                                               @YM07023 45150000
*                                       WRITER MODULES         @Y17XARW 45200000
         NI    NCPFLAG1,XFF-NCPTRACE    MARK TRACE INACTIVE    @Y17XARW 45300000
         LA    RZERO,FOUR03             TRACE-DEACTIVATED ERROR MSG NO  45400022
         CLC   PRUDATA(TWO),BADRSP      ERROR ON RESPONSE      @Y17XARW 45500000
         BNE   XCTLERR                  BRANCH IF NO             S05331 45550005
         SPACE                                                          45600022
INVALID  LA    RZERO,EIGHTEEN           INVALID-REQUEST MSG NO          45700022
         SPACE                                                          45800022
XCTLERR  MVC   OPCMODID(TWO),ERRWRT     SET FOR XCTL TO ERR RTN@Y17XARW 45900000
         B     EXIT                     EXIT                            46000022
         SPACE                                                          46100022
XCTLMOD  EQU   *                                                        46200022
         MVC   OPCMODID(TWO),WRTMOD     SET XCTL TO MSG MOD    @Y17XARW 46300000
         SPACE                                                          46400022
EXIT     LR    RPARM,ROPCAVT            PASS OP CONTROL AVT ADDR        46500022
         XCTL  SF=(E,OPCXCTL)           CALL NEXT MODULE                46600022
         EJECT                                                          46700022
*********************************************************************** 46800022
*      THIS SUBROUTINE GETS A BUFFER UNIT, SAVES THE UNIT ADDR @Y71XATW 46900000
*      IN THE OPCE, AND BUILDS A PACKED RU IN THE BUFFER.      @Y17XARW 47000000
*********************************************************************** 47100022
         SPACE                                                          47200022
BUILDRU  EQU   *                                               @Y17XARW 47250000
         LA    RPARM,ONE                SET NUMBER OF UNITS REQD        47300000
         LA    RSAVE,OPCSAVE            SETUP SAVEAREA         @Y17XARW 47350000
         L     RBRNCH,OPCGETBF          LOAD GET-BFR RTN ADDRESS        47400022
         BALR  RRET,RBRNCH              LINK TO GET BUFFER UNIT         47500022
         ST    RPARM,OCUNIT             SET UNIT ADDR IN OPCE           47600022
*********************************************************************** 47603000
*   SETUP RH AND TH FLAGS IN NEGATIVE PART OF RU PREFIX        @Y17XARW 47606000
*********************************************************************** 47609000
         LA    RWORK6,PRUNLEN           SETUP LENGTH OF NEGATIVE        47612000
*                                        PREFIX                @Y17XARW 47615000
         SR    RPARM,RWORK6             BACKUP TO NEG PREFIX   @Y17XARW 47618000
         XC    IEDPRUND(PRUNLEN),IEDPRUND  ZERO OUT NEG PREFIX @Y17XARW 47621000
         MVI   PRURHFG0,RHFLAG0         SETUP FOLLOWING IN RU: @Y17XARW 47624000
*                                        FM DATA, FORMAT INDICATOR,     47627000
*                                        BEGIN CHAIN, AND END CHAIN     47630000
         MVI   PRURHFG1,RHFLAG1         SETUP FOLLOWING IN RU: @Y17XARW 47633000
*                                        DEFINITE RESPONSE              47636000
         MVI   PRUFIDN,THFLAGS          SETUP FOLLOWING IN RU: @Y17XARW 47639000
*                                        FID1 INDICATOR, BEGIN SEGMENT, 47642000
*                                        AND END SEGMENT                47645000
         SPACE                                                          47648000
*********************************************************************** 47651000
*   SETUP 12 BYTE PACKED RU                                    @Y17XARW 47654000
*********************************************************************** 47657000
         MVC   PRUTTCIN,OCTRMTBL        SETUP NCP TNT AS DEST  @Y17XARW 47660000
         LA    RWORK6,EIGHT             SETUP LENGTH OF DATA   @Y17XARW 47663000
         STH   RWORK6,PRUDATCT            IN RU                @Y17XARW 47666000
         MVC   PRUTIC(FOUR),INVALTIC    INDICATE ONE UNIT      @Y17XARW 47669000
         MVC   PRUDATA+THREE(TWO),OCRSID  SETUP NETWORK ADDRESS@Y17XARW 47672000
         MVI   PRUDATA+FIVE,ONE         INDICATE LINK TRACE    @Y17XARW 47675000
         MVI   PRUDATA+SEVEN,ZERO       INDICATE NCP LINES ONLY@Y17XARW 47678000
         BR    RWORK8                   RETURN TO CALLER       @Y17XARW 47681000
         EJECT                                                          48500022
*********************************************************************** 48600022
*              THIS SUBROUTINE SCANS A NUMERIC FIELD IN THE REQUEST   * 48700022
*              MESSAGE AND CONVERTS THE DATA TO BINARY IN REGISTER 0  * 48800022
*********************************************************************** 48900022
         SPACE                                                          49000022
SCANOP   SR    RZERO,RZERO              INITIALIZE SCAN LIMIT           49100022
         MVI   OPCDOUBL,XF0             SET OPCDOUBL TO ZEROS           49200022
         MVC   OPCDOUBL+ONE(SEVEN),OPCDOUBL    (ZONED FORMAT)           49300022
         SPACE                                                          49400022
SCANLOOP LTR   RSIZE,RSIZE              ANY MORE BYTES TO SCAN          49500022
         BZ    SCANEXIT                 NO, EXIT                        49600022
         CLI   ZERO(RSCAN),COMMA        NEXT BYTE A COMMA               49700022
         BE    SCANOUT                  YES, GET OUT                    49800022
         CLI   ZERO(RSCAN),CHAR0        IS BYTE NUMERIC ?               49900022
         BL    INVALID                  NO, INVALID REQUEST             50000022
         CLI   ZERO(RSCAN),CHAR9        VALID NUMERIC ?                 50100022
         BH    INVALID                  NO, INVALID REQUEST             50200022
         MVC   OPCDOUBL(SEVEN),OPCDOUBL+ONE  SHIFT DATA 1 BYTE          50400022
         MVC   OPCDOUBL+SEVEN(ONE),ZERO(RSCAN)  MOVE IN THIS BYTE       50500022
         BCTR  RSIZE,RZERO              DECREMENT RSIZE                 50600022
         LA    RSCAN,ONE(RSCAN)         BUMP SCAN POINTER               50700022
         LA    RZERO,ONE(RZERO)         BUMP NO. OF BYTES SCANNED       50720022
         CH    RZERO,CON5               HAVE MORE THAN 5 BYTES BEEN     50740022
*                                       SCANNED ?                       50760022
         BH    INVALID                  YES, INVALID REQUEST            50780022
         B     SCANLOOP                 LOOP                            50800022
         SPACE                                                          50900022
SCANOUT  BCTR  RSIZE,RZERO              DECREMENT RSIZE                 51000022
         LA    RSCAN,ONE(RSCAN)         BUMP SCAN POINTER               51100022
         SPACE                                                          51200022
SCANEXIT PACK OPCDOUBL+FOUR(FOUR),OPCDOUBL+ONE(SEVEN)  PACK DATA        51300022
         XC    OPCDOUBL(FOUR),OPCDOUBL  ZERO FIRST WORD                 51400022
         CVB   RZERO,OPCDOUBL           CONVERT DATA TO BINARY          51500022
         BR    RRET                     RETURN TO CALLER                51600022
         EJECT                                                          51700022
*********************************************************************** 51704000
*                                                                     * 51708000
*     THIS ROUTINE CALLS IEDQTL, THE DEVICE DEPENDENT FIELD    @Y17XARW 51712000
*     LOOKUP ROUTINE, WHICH WILL RETURN IN REG15 THE ADDRESS   @Y17XARW 51716000
*     OF THE REQUESTED DEVICE DEPENDENT FIELDS.  THESE FIELDS  @Y17XARW 51720000
*     CONTAIN TRACE INFORMATION NEEDED BY IGCMB10D.            @Y17XARW 51724000
*                                                                     * 51728000
*********************************************************************** 51732000
         SPACE                                                          51736000
NCPDEV   EQU   *                                               @Y17XARW 51740000
         LA    RZERO,TRMNCPI            SETUP MASK             @Y17XARW 51744000
         L     RPARM,OCMODNME           SETUP NCP TTE ADDRESS  @Y17XARW 51748000
         LA    RSAVE,OPCSAVE            SETUP A SAVEAREA       @Y17XARW 51752000
         L     RBRNCH,AVTDDFT           SETUP ADDR OF QTL RTN  @Y17XARW 51756000
         BALR  RRET,RBRNCH              LOOKUP ADDR OF DEVICE  @Y17XARW 51760000
*                                       DEPENDENT FIELDS       @Y17XARW 51764000
         LR    RNCP,RBRNCH              RNCP WAS RNCPTTE AND   @Y17XARW 51768000
*                                       CONTAINED NCP TTE ADDR,@Y17XARW 51772000
*                                       RNCP NOW CONTAINS ADDR @Y17XARW 51776000
*                                       OF DEVICE DEPEND FLDS  @Y17XARW 51780000
         BR    RWORK8                   RETURN                 @Y17XARW 51784000
         EJECT                                                          51788000
CON5     DC    H'5'                     MAX OPERAND LENGTH              51850022
CON28    DC    H'28'                    HALF-TABLE CTL INFO LENGTH      51900022
CON48    DC    H'48'                    LINE-TRACE CTL AREA SIZE        52000022
CON255   DC    H'255'                   INTERVAL-SIZE MAXIMUM           52100022
CONMAXH  DC    H'16366'                 TABLE-SIZE MAXIMUM              52200000
WRTMOD   DC    C'M1'                    MSG WRITER MODULE               52300022
THISMOD  DC    C'MB'                    ID FOR THIS MODULE              52400022
FIRSTLD  DC    C'00'                    FIRST LOAD OF OPEN              52500022
RUDISP   DC    C'02'                    RU DISPATCHER          @Y17XARW 52600000
ERRWRT   DC    C'03'                    ERROR WRITER MODULE             52700022
LINTID   DC    C'LINT'                  ID FOR COMWRITE RECORDS         52750022
DEACT    DC    X'010303'                DEACTIVATE CMD TYPE    @Y17XARW 52758000
ACT      DC    X'010302'                ACTIVATE CMD TYPE      @Y17XARW 52766000
INVALTIC DC    X'08000002'              INVALID TIC            @Y17XARW 52774000
BADRSP   DC    X'0801'                  ERROR ON RESPONSE      @Y17XARW 52782000
ACTIVE   DC    X'0815'                  ALREADY ACTIVE         @YM07023 52786000
ZAPAREA  DC    50X'00'                  ZAP AREA               @Y17XARW 52790000
         EJECT                                                          53590000
TABHALF  DSECT                          HALF-TABLE CONTROL AREA         56500022
         DS    CL16                     ---FILLER---                    56600022
TABLINUM DS    CL8                      GROUP NAME                      56700022
TABCOMMA DS    CL1                      COMMA                           56800022
TABRLN   DS    CL3                      RELATIVE LINE NUMBER            56900022
TABDATA  DS    0CL1                     START OF TABLE DATA             57000022
         EJECT                                                          57100022
LSTDSECT DSECT                          DSECT OF GETMAIN/FREEMAIN LIST  57200022
LSTSIZE  DS    F                        SIZE OF CORE AREA               57300022
LSTADDR  DS    A                        ADDRESS OF AREA POINTER         57400022
         DS    X                        ---FILLER---                    57500022
LSTSP    DS    X                        SUBPOOL NUMBER                  57600022
         EJECT                                                          57700022
         TAVTD                                                          57800000
         EJECT                                                          57900022
         IEZDEB                                                @OZ30601 57906082
         EJECT                                                 @OZ30601 57912082
         DCBD  DSORG=(PS),DEVD=(DA,TA)                         @OZ30601 57918082
         EJECT                                                 @OZ30601 57924082
         THEDD                                                          57930000
         EJECT                                                          57960000
         TNCPID                                                         58000000
         EJECT                                                          58100022
         TOPCED                                                         58400022
         EJECT                                                          58420000
         TOPCAVTD                                                       58440000
         EJECT                                                          58460000
         TPRUD                                                          58480000
         EJECT                                                          58500022
         IKJTCB                                                @OZ30601 58510082
         EJECT                                                 @OZ30601 58520082
TIOT     DSECT                                                 @OZ30601 58530082
         IEFTIOT1                                              @OZ30601 58540082
         EJECT                                                 @OZ30601 58550082
         TTRMD                                                          58600022
         END                                                            58700022
