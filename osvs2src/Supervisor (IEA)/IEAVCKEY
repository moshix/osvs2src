         TITLE '** IEAVCKEY-VS2/SU7 CHANGE STORAGE PROTECT KEY ROUTINE *00001000
                **      '                                               00002000
IEAVCKEY CSECT ,                                                   0001 00003000
@MAINENT DS    0H                                                  0001 00004000
         USING *,@15                                               0001 00005000
         B     @PROLOG                                             0001 00006000
         DC    AL2(@EP00001-@MAINENT)                                   00007000
         DC    AL1(16)                                             0001 00008000
         DC    C'IEAVCKEY  76.239'                                 0001 00009000
CKEYRTRY DS    0H                                                  0001 00010000
         USING *,@15                                               0001 00011000
         B     @PROLOG                                             0001 00012000
         DC    AL2(@EP00241-CKEYRTRY)                                   00013000
         ENTRY CKEYRTRY                                                 00014000
         DROP  @15                                                      00015000
@PROLOG  AH    @15,4(,@15)                                         0001 00016000
         BR    @15                                                 0001 00017000
@EP00001 DS    0H                                                  0002 00018000
*                                     /*ENTRY LINKAGE                   00019000
         USING PSA,0                  ADDRESS LOW STORAGE               00020000
         L     @15,PSAAOLD            ADDRESS                           00021000
         USING ASCB,@15                 CURRENT ASCB                    00022000
         L     @15,ASCBLDA            ADDRESS                           00023000
         USING LDA,@15                  LDA                             00024000
         LA    @15,CFAPWKAR           TEMP ADDRESSABILITY               00025000
         USING @DATD,@15                FOR WORK/SAVE AREA              00026000
*                                                                       00027000
*        THE 75-WORD AREA, CFAPWKAR, IN THE LDA IS USED AS A WORK/SAVE  00028000
*        AREA TO ACHIEVE REENTRANT ATTRIBUTE.                           00029000
*                                                                       00030000
         STM   @00,@14,SAVEREGS       SAVE CALLER'S REGS                00031000
*                                                                       00032000
*        IF THE CALLING PGM IS NOT PSW KEY 0, A PGM CHECK WILL RESULT   00033000
*        FROM EXECUTION OF THIS INSTRUCTION.                            00034000
*                                                                       00035000
         DROP  @15                                                      00036000
         LR    @09,@15                DATAREG                           00037000
         USING @DATD,@09              ADDRESS WORK/SAVE AREA            00038000
         BALR  @10,0                  CODEREG                           00039000
         USING *,@10                  ADDRESSABILITY FOR MODULE         00040000
FRRON   SETFRR A,FRRAD=CKFRR,PARMAD=PARMPTR,WRKREGS=(REG03,REG04),    --00041000
               RELATED=(FRR,CKEY(FRROFF,FRROFF2))                       00042000
*   CKEYBASE=REG10;                 /* INITIALIZE FRR PARM AREA      */ 00043000
         L     @12,PARMPTR                                         0042 00044000
         ST    REG10,CKEYBASE(,@12)                                0042 00045000
*   IF REQUEST=LTYPE THEN           /* DETERMINE INTERFACE USED      */ 00046000
         CLI   REQUEST,128                                         0043 00047000
         BNE   @RF00043                                            0043 00048000
*     CALL LISTPROC;                /* PROCESS L-TYPE REQUESTS       */ 00049000
         BAL   @14,LISTPROC                                        0044 00050000
*   ELSE                                                           0045 00051000
*     CALL REGPROC;                 /* PROCESS R-TYPE REQUESTS       */ 00052000
         B     @RC00043                                            0045 00053000
@RF00043 BAL   @14,REGPROC                                         0045 00054000
*   GEN SETS(REG03,REG04);                                         0046 00055000
@RC00043 DS    0H                                                  0046 00056000
*                       /*                                              00057000
FRROFF   SETFRR D,WRKREGS=(REG03,REG04),RELATED=(FRR,CKEY(FRRON))       00058000
*   IF RETCODE^=0 THEN              /* TEST RETURN CODE              */ 00059000
         LTR   RETCODE,RETCODE                                     0047 00060000
         BZ    @RF00047                                            0047 00061000
*     DO;                           /* ABEND(O8F) SYSTEM             */ 00062000
*       RESPECIFY                                                  0049 00063000
*        (GPR01F) RESTRICTED;                                      0049 00064000
*       GPR01F=((O8F)&'00000FFF'X)*4096;/* COMP CODE IN BITS 8-19    */ 00065000
         LA    GPR01F,143                                          0050 00066000
         N     GPR01F,@CF01514                                     0050 00067000
         SLA   GPR01F,12                                           0050 00068000
*       SVC(13);                    /* ISSUE ABEND SVC               */ 00069000
         SVC   13                                                  0051 00070000
*       RESPECIFY                                                  0052 00071000
*        (GPR01F) UNRESTRICTED;                                    0052 00072000
*     END;                          /* ABEND(O8F) SYSTEM NOT ZERO: 0053 00073000
*                                      CHANGE KEY FAILED             */ 00074000
*   REG00=OLDKEYFP;                 /* ZERO: CHANGE KEY SUCCESSFUL.     00075000
*                                      RETURN ORIGINAL STORAGE KEY   */ 00076000
@RF00047 SLR   REG00,REG00                                         0054 00077000
         IC    REG00,OLDKEYFP                                      0054 00078000
*   GEN REFS(SAVEREGS);                                            0055 00079000
*                             /*                                        00080000
         LM    @01,@14,INR1           RESTORE CALLER'S REGS             00081000
*   RETURN;                         /* RETURN TO CALLING PGM         */ 00082000
@EL00001 DS    0H                                                  0056 00083000
@EF00001 DS    0H                                                  0056 00084000
@ER00001 BR    @14                                                 0056 00085000
*                                                                  0057 00086000
*   /*****************************************************************/ 00087000
*   /*                                                               */ 00088000
*   /* ROUTINE TO PROCESS R-TYPE REQUESTS                            */ 00089000
*   /*                                                               */ 00090000
*   /*****************************************************************/ 00091000
*                                                                  0057 00092000
*REGPROC:                                                          0057 00093000
*   PROC OPTIONS(NOSAVE);                                          0057 00094000
REGPROC  DS    0H                                                  0058 00095000
*   RETAD1=REG14;                   /* SAVE RETURN ADDRESS           */ 00096000
         ST    REG14,RETAD1                                        0058 00097000
*   FLAGS=0;                        /* INTERNAL INDICATORS OFF       */ 00098000
         MVI   FLAGS,X'00'                                         0059 00099000
*   ELTAD=ADDR(INR1);               /* ONE VA RANGE GIVEN BY INPUT R1   00100000
*                                      AND R2                        */ 00101000
*                                                                  0060 00102000
         LA    @12,INR1                                            0060 00103000
         ST    @12,ELTAD                                           0060 00104000
*   /*****************************************************************/ 00105000
*   /*                                                               */ 00106000
*   /* VALIDITY CHECK INPUT PARAMETERS: STORAGE DEFINED BY VA RANGE  */ 00107000
*   /* MUST BE IN PROBLEM PROGRAM SUBPOOLS                           */ 00108000
*   /*                                                               */ 00109000
*   /*****************************************************************/ 00110000
*                                                                  0061 00111000
*   CALL PAGEVCK;                   /* VALIDITY CHECK: STORAGE IN  0061 00112000
*                                      PROBLEM PROGRAM SUBPOOLS      */ 00113000
         BAL   @14,PAGEVCK                                         0061 00114000
*   IF RETCODE=0 THEN               /* TEST RETURN CODE              */ 00115000
         LTR   RETCODE,RETCODE                                     0062 00116000
         BNZ   @RF00062                                            0062 00117000
*     DO;                           /* RC ZERO: VA RANGE VALID       */ 00118000
*       SAVEKEY=YES;                /* SAVE ORIGINAL KEY             */ 00119000
         OI    SAVEKEY,B'10000000'                                 0064 00120000
*       GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);             0065 00121000
*                                                   /*OBTAIN SALLOC     00122000
LOCKON   SETLOCK OBTAIN,TYPE=SALLOC,MODE=UNCOND,                      --00123000
               RELATED=(PAGES,CKEY(LOCKOFF))                            00124000
*       LPC=NONE;                   /* NO KEY FOR ANY PAGE CHANGED   */ 00125000
*                                                                  0066 00126000
         SLR   @12,@12                                             0066 00127000
         ST    @12,LPC                                             0066 00128000
*       /*************************************************************/ 00129000
*       /*                                                           */ 00130000
*       /* CHANGE STORAGE KEY: THE XPTPROT FIELD IN THE XPTE AND THE */ 00131000
*       /* HARDWARE KEY FOR EACH PAGE IS CHANGED                     */ 00132000
*       /*                                                           */ 00133000
*       /*************************************************************/ 00134000
*                                                                  0067 00135000
*       CALL ELTPROC;               /* CHANGE STORAGE KEY FOR RANGE  */ 00136000
         BAL   @14,ELTPROC                                         0067 00137000
*       IF RETCODE^=0 THEN          /* TEST RETURN CODE              */ 00138000
         LTR   RETCODE,RETCODE                                     0068 00139000
         BZ    @RF00068                                            0068 00140000
*         CALL RECOVER;             /* RC NOT ZERO: CHANGE         0069 00141000
*                                      INCOMPLETE, RESTORE ORIGINAL     00142000
*                                      KEY                           */ 00143000
         BAL   @14,RECOVER                                         0069 00144000
*       ELSE                                                       0070 00145000
*         ;                         /* RC ZERO: KEY CHANGED          */ 00146000
@RF00068 DS    0H                                                  0071 00147000
*       GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);             0071 00148000
*                                                  /*RELEASE SALLOC     00149000
LOCKOFF  SETLOCK RELEASE,TYPE=SALLOC,                                 --00150000
               RELATED=(PAGES,CKEY(LOCKON))                             00151000
*     END;                                                         0072 00152000
*   ELSE                                                           0073 00153000
*     ;                             /* RC NOT ZERO: VA RANGE INVALID    00154000
*                                      , KEY NOT CHANGED             */ 00155000
@RF00062 DS    0H                                                  0074 00156000
*   REG14=RETAD1;                   /* RESTORE RETURN ADDRESS        */ 00157000
         L     REG14,RETAD1                                        0074 00158000
*   RETURN CODE(RETCODE);           /* RETURN TO TOP ROUTINE         */ 00159000
@EL00002 DS    0H                                                  0075 00160000
@EF00002 DS    0H                                                  0075 00161000
@ER00002 BR    @14                                                 0075 00162000
*   END REGPROC;                                                   0076 00163000
*                                                                  0077 00164000
*   /*****************************************************************/ 00165000
*   /*                                                               */ 00166000
*   /* ROUTINE TO PROCESS L-TYPE REQUESTS                            */ 00167000
*   /*                                                               */ 00168000
*   /*****************************************************************/ 00169000
*                                                                  0077 00170000
*LISTPROC:                                                         0077 00171000
*   PROC OPTIONS(NOSAVE);                                          0077 00172000
LISTPROC DS    0H                                                  0078 00173000
*   RETAD1=REG14;                   /* SAVE RETURN ADDRESS           */ 00174000
         ST    REG14,RETAD1                                        0078 00175000
*   FLAGS=0;                        /* INTERNAL INDICATORS OFF       */ 00176000
         MVI   FLAGS,X'00'                                         0079 00177000
*   LPC=NONE;                       /* NO KEY FOR ANY PAGE CHANGED   */ 00178000
         SLR   @12,@12                                             0080 00179000
         ST    @12,LPC                                             0080 00180000
*   ELTAD=INR1-LENGTH(LISTELT);     /* ADDRESS-8 OF FIRST ELEMENT IN    00181000
*                                      LIST                          */ 00182000
         L     @12,INR1                                            0081 00183000
         SL    @12,@CF00068                                        0081 00184000
         ST    @12,ELTAD                                           0081 00185000
*   GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);                 0082 00186000
*                                                                  0082 00187000
*                                                   /*OBTAIN SALLOC     00188000
LOCKON2  SETLOCK OBTAIN,TYPE=SALLOC,MODE=UNCOND,                      --00189000
               RELATED=(PAGES,CKEY(LOCKOFF2))                           00190000
*   /*****************************************************************/ 00191000
*   /*                                                               */ 00192000
*   /* VALIDITY CHECK INPUT PARAMETERS: PARAMETER LIST MUST BE IN    */ 00193000
*   /* FIXED STORAGE. STORAGE DEFINED BY EACH ELEMENT IN LIST MUST BE*/ 00194000
*   /* IN PROBLEM PROGRAM SUBPOOLS                                   */ 00195000
*   /*                                                               */ 00196000
*   /*****************************************************************/ 00197000
*                                                                  0083 00198000
*   DO UNTIL(ERROR=YES|LASTELT=YES);/* CHECK EACH ELT IN LIST OR   0083 00199000
*                                      UNTIL ERROR IS DETECTED       */ 00200000
@DL00083 DS    0H                                                  0084 00201000
*     ELTAD=ELTAD+LENGTH(LISTELT);  /* LIST ELEMENT ADDRESS          */ 00202000
         LA    @12,8                                               0084 00203000
         AL    @12,ELTAD                                           0084 00204000
         ST    @12,ELTAD                                           0084 00205000
*     CALL ELTVCK;                  /* VALIDITY CHECK: ELT IN FIXED     00206000
*                                      STORAGE                       */ 00207000
         BAL   @14,ELTVCK                                          0085 00208000
*     IF RETCODE=0 THEN             /* TEST RETURN CODE              */ 00209000
         LTR   RETCODE,RETCODE                                     0086 00210000
         BNZ   @RF00086                                            0086 00211000
*       DO;                         /* RC ZERO: ELEMENT VALID        */ 00212000
*         CALL PAGEVCK;             /* VALIDITY CHECK: VA RANGE IN 0088 00213000
*                                      PROBLEM PGM SUBPOOLS          */ 00214000
         BAL   @14,PAGEVCK                                         0088 00215000
*         IF RETCODE^=0 THEN        /* TEST RETURN CODE              */ 00216000
         LTR   RETCODE,RETCODE                                     0089 00217000
         BZ    @RF00089                                            0089 00218000
*           ERROR=YES;              /* RC NOT ZERO: RANGE INVALID    */ 00219000
         OI    ERROR,B'01000000'                                   0090 00220000
*         ELSE                                                     0091 00221000
*           ;                       /* RC ZERO:RANGE VALID           */ 00222000
@RF00089 DS    0H                                                  0092 00223000
*       END;                                                       0092 00224000
*     ELSE                          /* RC NOT ZERO: ELT INVALID      */ 00225000
*       ERROR=YES;                  /* INDICATE ERROR CONDITION      */ 00226000
         B     @RC00086                                            0093 00227000
@RF00086 OI    ERROR,B'01000000'                                   0093 00228000
*   END;                                                           0094 00229000
*                                                                  0094 00230000
@RC00086 DS    0H                                                  0094 00231000
@DE00083 TM    ERROR,B'01000000'                                   0094 00232000
         BO    @DC00083                                            0094 00233000
         L     @12,ELTAD                                           0094 00234000
         TM    LASTELT(@12),B'10000000'                            0094 00235000
         BNO   @DL00083                                            0094 00236000
@DC00083 DS    0H                                                  0095 00237000
*   /*****************************************************************/ 00238000
*   /*                                                               */ 00239000
*   /* CHANGE STORAGE KEY: THE FIELD XPTPROT IN THE XPTE AND THE     */ 00240000
*   /* HARDWARE KEY FOR EACH PAGE IS CHANGED                         */ 00241000
*   /*                                                               */ 00242000
*   /*****************************************************************/ 00243000
*                                                                  0095 00244000
*   IF ERROR=NO THEN                /* WAS AN ERROR DETECTED ?       */ 00245000
         TM    ERROR,B'01000000'                                   0095 00246000
         BNZ   @RF00095                                            0095 00247000
*     DO;                           /* NO: CONTINUE KEY PROCESSING   */ 00248000
*       ELTAD=INR1-LENGTH(LISTELT); /* ADDRESS-8 OF FIRST ELT IN LIST*/ 00249000
         L     @12,INR1                                            0097 00250000
         SL    @12,@CF00068                                        0097 00251000
         ST    @12,ELTAD                                           0097 00252000
*       SAVEKEY=YES;                /* SAVE ORIGINAL KEY             */ 00253000
         OI    SAVEKEY,B'10000000'                                 0098 00254000
*       DO UNTIL(LASTELT=YES|ERROR=YES);/* CHANGE KEY OF ALL RANGES     00255000
*                                      OR UNTIL ERROR IS DETECTED    */ 00256000
@DL00099 DS    0H                                                  0100 00257000
*         ELTAD=ELTAD+LENGTH(LISTELT);/* LIST ELEMENT ADDRESS        */ 00258000
         LA    @12,8                                               0100 00259000
         AL    @12,ELTAD                                           0100 00260000
         ST    @12,ELTAD                                           0100 00261000
*         CALL ELTPROC;             /* CHANGE KEY OF SINGLE RANGE    */ 00262000
         BAL   @14,ELTPROC                                         0101 00263000
*         IF RETCODE^=0 THEN        /* TEST RETURN CODE              */ 00264000
         LTR   RETCODE,RETCODE                                     0102 00265000
         BZ    @RF00102                                            0102 00266000
*           DO;                                                    0103 00267000
*             ERROR=YES;            /* INDICATE ERROR CONDITION      */ 00268000
         OI    ERROR,B'01000000'                                   0104 00269000
*             CALL RECOVER;         /* RESTORE ORIGINAL KEY          */ 00270000
         BAL   @14,RECOVER                                         0105 00271000
*           END;                                                   0106 00272000
*         ELSE                                                     0107 00273000
*           ;                       /* RC ZERO: KEY CHANGED          */ 00274000
@RF00102 DS    0H                                                  0108 00275000
*       END;                                                       0108 00276000
@DE00099 L     @12,ELTAD                                           0108 00277000
         TM    LASTELT(@12),B'10000000'                            0108 00278000
         BO    @DC00099                                            0108 00279000
         TM    ERROR,B'01000000'                                   0108 00280000
         BNO   @DL00099                                            0108 00281000
@DC00099 DS    0H                                                  0109 00282000
*     END;                                                         0109 00283000
*   ELSE                                                           0110 00284000
*     ;                             /* YES: KEY UNCHANGED            */ 00285000
@RF00095 DS    0H                                                  0111 00286000
*   GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);                 0111 00287000
*                                                /*RELEASE SALLOC       00288000
LOCKOFF2 SETLOCK RELEASE,TYPE=SALLOC,                                 --00289000
               RELATED=(PAGES,CKEY(LOCKON2))                            00290000
*   REG14=RETAD1;                   /* RESTORE RETURN ADDRESS        */ 00291000
         L     REG14,RETAD1                                        0112 00292000
*   RETURN CODE(RETCODE);           /* RETURN TO TOP ROUTINE         */ 00293000
@EL00003 DS    0H                                                  0113 00294000
@EF00003 DS    0H                                                  0113 00295000
@ER00003 BR    @14                                                 0113 00296000
*   END LISTPROC;                                                  0114 00297000
*                                                                  0115 00298000
*   /*****************************************************************/ 00299000
*   /*                                                               */ 00300000
*   /* ROUTINE TO CHANGE THE KEY OF THE STORAGE AREA DEFINED BY ONE  */ 00301000
*   /* VA RANGE                                                      */ 00302000
*   /*                                                               */ 00303000
*   /*****************************************************************/ 00304000
*                                                                  0115 00305000
*ELTPROC:                                                          0115 00306000
*   PROC OPTIONS(NOSAVE);                                          0115 00307000
ELTPROC  DS    0H                                                  0116 00308000
*   RETAD2=REG14;                   /* SAVE RETURN ADDRESS           */ 00309000
         ST    REG14,RETAD2                                        0116 00310000
*   PGAD=FPA;                       /* FIRST PAGE PROCESSED          */ 00311000
*                                                                  0117 00312000
         L     @12,ELTAD                                           0117 00313000
         L     @12,FPA-1(,@12)                                     0117 00314000
         LA    @12,0(,@12)                                         0117 00315000
         ST    @12,PGAD                                            0117 00316000
*   /*****************************************************************/ 00317000
*   /*                                                               */ 00318000
*   /* STORAGE KEY CHANGED BY CHANGING THE PROTECT KEY FOR EACH PAGE */ 00319000
*   /* IN THE VA RANGE. PROCESSING IS NOT COMPLETED IF A PAGE IN THE */ 00320000
*   /* VA RANGE IS FOUND THAT HAS NOT BEEN GETMAINED.                */ 00321000
*   /*                                                               */ 00322000
*   /*****************************************************************/ 00323000
*                                                                  0118 00324000
*NEWSEG:                            /* REPEATED FOR EACH PAGE IN A 0118 00325000
*                                      NEW SEGMENT                   */ 00326000
*   RESPECIFY                                                      0118 00327000
*    (REG01,                                                       0118 00328000
*     REG02,                                                       0118 00329000
*     REG03) RSTD;                  /* REGS USED BY FINDPAGE         */ 00330000
NEWSEG   DS    0H                                                  0119 00331000
*   REG01=PGAD;                     /* PAGE ADDRESS                  */ 00332000
         L     REG01,PGAD                                          0119 00333000
*   REG02=RSMHDPTR;                 /* RSMHD ADDRESS                 */ 00334000
         L     @12,ASCBPTR                                         0120 00335000
         L     REG02,RSMHDPTR(,@12)                                0120 00336000
*   REG03=PVTPTR;                   /* PVT ADDRESS                   */ 00337000
         L     @12,CVTPTR                                          0121 00338000
         L     @12,PVTPTR(,@12)                                    0121 00339000
         LR    REG03,@12                                           0121 00340000
*   CALL IEAVFP2;                   /* GET PGTE,XPTE FOR PAGE        */ 00341000
         L     @15,PVTPFP2(,@12)                                   0122 00342000
         BALR  @14,@15                                             0122 00343000
*   PTEPTR=REG00;                   /* ADDRESS PGTE                  */ 00344000
         ST    REG00,PTEPTR                                        0123 00345000
*   XPTEPTR=REG01;                  /* ADDRESS XPTE                  */ 00346000
         ST    REG01,XPTEPTR                                       0124 00347000
*   RESPECIFY                                                      0125 00348000
*    (REG01,                                                       0125 00349000
*     REG02,                                                       0125 00350000
*     REG03) UNRSTD;                                               0125 00351000
*   IF RETCODE=0 THEN               /* TEST RETURN CODE              */ 00352000
         LTR   RETCODE,RETCODE                                     0126 00353000
         BNZ   @RF00126                                            0126 00354000
*SAMESEG:                                                          0127 00355000
*     DO;                           /* RC ZERO: PGTE,XPTE FOUND.   0127 00356000
*                                      REPEATED FOR EACH PAGE IN THE    00357000
*                                      SAME SEGMENT.                 */ 00358000
SAMESEG  DS    0H                                                  0128 00359000
*       IF PGTPAM=YES THEN          /* PAGE GM ASSIGNED ?            */ 00360000
         L     @12,PTEPTR                                          0128 00361000
         TM    PGTPAM(@12),B'00000001'                             0128 00362000
         BNO   @RF00128                                            0128 00363000
*         DO;                       /* YES: KEY WILL BE CHANGED      */ 00364000
*           IF SAVEKEY=YES THEN     /* SAVE KEY OF THIS PAGE ?       */ 00365000
         TM    SAVEKEY,B'10000000'                                 0130 00366000
         BNO   @RF00130                                            0130 00367000
*             DO;                   /* YES: XPTPROT IS SAVED         */ 00368000
*               OLDKEYFP=XPTPROT;   /* ORIGINAL STORAGE KEY          */ 00369000
         L     @12,XPTEPTR                                         0132 00370000
         IC    @11,XPTPROT(,@12)                                   0132 00371000
         STC   @11,OLDKEYFP                                        0132 00372000
*               SAVEKEY=NO;         /* NO OTHER KEY IS SAVED         */ 00373000
         NI    SAVEKEY,B'01111111'                                 0133 00374000
*             END;                                                 0134 00375000
*           ELSE                                                   0135 00376000
*             ;                     /* NO: CONTINUE                  */ 00377000
@RF00130 DS    0H                                                  0136 00378000
*           LPC=PGAD;               /* PAGE ADDRESS BEING PROCESSED  */ 00379000
         L     @12,PGAD                                            0136 00380000
         ST    @12,LPC                                             0136 00381000
*           CALL KEYCHG;            /* CHANGE KEY OF PAGE            */ 00382000
         BAL   @14,KEYCHG                                          0137 00383000
*           PGAD=PGAD+C4K;          /* NEXT PAGE ADDRESS IN RANGE    */ 00384000
         L     @12,@CF00106                                        0138 00385000
         AL    @12,PGAD                                            0138 00386000
         ST    @12,PGAD                                            0138 00387000
*           COND1=NO;                                              0139 00388000
*           COND2=NO;                                              0140 00389000
         NI    COND1,B'11001111'                                   0140 00390000
*           IF PGAD<=LPA THEN       /* ALL PAGES PROCESSED ?         */ 00391000
         L     @11,ELTAD                                           0141 00392000
         L     @11,LPA-1(,@11)                                     0141 00393000
         LA    @11,0(,@11)                                         0141 00394000
         CR    @12,@11                                             0141 00395000
         BH    @RF00141                                            0141 00396000
*             DO;                   /* NO: CONTINUE WITH NEXT PAGE   */ 00397000
*               COND1=YES;          /* INDICATE PAGE EXISTS          */ 00398000
         OI    COND1,B'00100000'                                   0143 00399000
*               IF SEG^=NEW THEN    /* PAGE IN SAME SEGMENT ?        */ 00400000
         TM    SEG,B'11110000'                                     0144 00401000
         BZ    @RF00144                                            0144 00402000
*                 DO;               /* YES: PGTE,XPTE BY INCREMENTING   00403000
*                                      DOWN TABLES                   */ 00404000
*                   PTEPTR=PTEPTR+LENGTH(PGTPTE);/* NEXT PGTE ADDRESS*/ 00405000
         LA    @12,2                                               0146 00406000
         AL    @12,PTEPTR                                          0146 00407000
         ST    @12,PTEPTR                                          0146 00408000
*                   XPTEPTR=XPTEPTR+LENGTH(XPTE);/* NEXT XPTE ADDRESS*/ 00409000
         LA    @12,12                                              0147 00410000
         AL    @12,XPTEPTR                                         0147 00411000
         ST    @12,XPTEPTR                                         0147 00412000
*                   COND2=YES;      /* INDICATE SAME SEGMENT         */ 00413000
         OI    COND2,B'00010000'                                   0148 00414000
*                 END;                                             0149 00415000
*               ELSE                                               0150 00416000
*                 ;                 /* NO: PGTE,XPTE BY FINDPAGE     */ 00417000
@RF00144 DS    0H                                                  0151 00418000
*             END;                                                 0151 00419000
*           ELSE                                                   0152 00420000
*             ;                     /* YES: END PROCESSING           */ 00421000
@RF00141 DS    0H                                                  0153 00422000
*         END;                                                     0153 00423000
*       ELSE                        /* NO: ERROR CONDITION           */ 00424000
*         DO;                                                      0154 00425000
         B     @RC00128                                            0154 00426000
@RF00128 DS    0H                                                  0155 00427000
*           RETCODE=8;              /* IDENTIFY ERROR                */ 00428000
         LA    RETCODE,8                                           0155 00429000
*           ERROR=YES;              /* INDICATE ERROR DETECTED       */ 00430000
         OI    ERROR,B'01000000'                                   0156 00431000
*         END;                                                     0157 00432000
*     END;                                                         0158 00433000
*   ELSE                            /* RC NOT ZERO: NO PGTE,XPTE     */ 00434000
*     DO;                                                          0159 00435000
         B     @RC00126                                            0159 00436000
@RF00126 DS    0H                                                  0160 00437000
*       RETCODE=16;                 /* IDENTIFY ERROR                */ 00438000
         LA    RETCODE,16                                          0160 00439000
*       ERROR=YES;                  /* INDICATE ERROR DETECTED       */ 00440000
         OI    ERROR,B'01000000'                                   0161 00441000
*     END;                                                         0162 00442000
*   IF COND2=YES&ERROR=NO THEN      /* SAME SEG AND NO ERROR ?       */ 00443000
@RC00126 TM    COND2,B'00010000'                                   0163 00444000
         BNO   @RF00163                                            0163 00445000
         TM    ERROR,B'01000000'                                   0163 00446000
         BZ    @RT00163                                            0163 00447000
*     GOTO SAMESEG;                 /* YES: REPEAT SAMESEG           */ 00448000
*   ELSE                                                           0165 00449000
*     ;                             /* NO: CONTINUE                  */ 00450000
@RF00163 DS    0H                                                  0166 00451000
*   IF COND1=YES&ERROR=NO THEN      /* NEW SEG AND NO ERROR ?        */ 00452000
         TM    COND1,B'00100000'                                   0166 00453000
         BNO   @RF00166                                            0166 00454000
         TM    ERROR,B'01000000'                                   0166 00455000
         BZ    @RT00166                                            0166 00456000
*     GOTO NEWSEG;                  /* YES: REPEAT NEWSEG            */ 00457000
*   ELSE                                                           0168 00458000
*     ;                             /* NO: ALL PAGES ARE PROCESSED OR   00459000
*                                      ERROR HAS BEEN DETECTED       */ 00460000
@RF00166 DS    0H                                                  0169 00461000
*   REG14=RETAD2;                   /* RESTORE RETURN ADDRESS        */ 00462000
         L     REG14,RETAD2                                        0169 00463000
*   RETURN CODE(RETCODE);           /* RETURN TO CALLING ROUTINE     */ 00464000
@EL00004 DS    0H                                                  0170 00465000
@EF00004 DS    0H                                                  0170 00466000
@ER00004 BR    @14                                                 0170 00467000
*   END ELTPROC;                                                   0171 00468000
*                                                                  0172 00469000
*   /*****************************************************************/ 00470000
*   /*                                                               */ 00471000
*   /* ROUTINE TO VERIFY THAT A PARAMETER LIST ELEMENT IS IN FIXED   */ 00472000
*   /* STORAGE AT THE TIME IEAVCKEY WAS INVOKED.                     */ 00473000
*   /*                                                               */ 00474000
*   /*****************************************************************/ 00475000
*                                                                  0172 00476000
*ELTVCK:                                                           0172 00477000
*   PROC OPTIONS(NOSAVE);                                          0172 00478000
ELTVCK   DS    0H                                                  0173 00479000
*   GEN REFS(ELTAD);                                               0173 00480000
*                 /*                                                    00481000
*         ELEMENT IS IN REAL STORAGE IF THE FIRST AND LAST BYTE OF      00482000
*         THE ELEMENT ARE IN REAL STORAGE                               00483000
         L     @15,ELTAD              ELEMENT VA                        00484000
         LRA   @15,C0(@15)            FIRST BYTE IN REAL STORAGE ?      00485000
         BNZ   ERR12                  NO: ERROR CONDITION               00486000
         L     @15,ELTAD              YES: ELEMENT ENDING               00487000
         LA    @15,C7(@15)                 VIRTUAL ADDRESS              00488000
         LRA   @15,C0(@15)            LAST BYTE IN REAL STORAGE?        00489000
         BNZ   ERR12                  NO: ERROR CONDITION               00490000
         SR    @15,@15                YES: ELT IN FIXED STORAGE         00491000
         BR    @14                    RETURN TO LISTPROC                00492000
ERR12    LA    @15,12                 IDENTIFY ERROR                    00493000
*   RETURN;                         /* RETURN TO LISTPROC            */ 00494000
@EL00005 DS    0H                                                  0174 00495000
@EF00005 DS    0H                                                  0174 00496000
@ER00005 BR    @14                                                 0174 00497000
*   END ELTVCK;                                                    0175 00498000
*                                                                  0176 00499000
*   /*****************************************************************/ 00500000
*   /*                                                               */ 00501000
*   /* ROUTINE TO VERIFY STORAGE DEFINED BY A VA RANGE IS FROM       */ 00502000
*   /* SUBPOOLS 0-127, 251, AND 252                                  */ 00503000
*   /*                                                               */ 00504000
*   /*****************************************************************/ 00505000
*                                                                  0176 00506000
*PAGEVCK:                                                          0176 00507000
*   PROC OPTIONS(NOSAVE);                                          0176 00508000
PAGEVCK  DS    0H                                                  0177 00509000
*   IF FPA<=LPA THEN                /* WRAP AROUND NOT PERMITTED     */ 00510000
         L     @12,ELTAD                                           0177 00511000
         CLC   FPA(3,@12),LPA(@12)                                 0177 00512000
         BH    @RF00177                                            0177 00513000
*     DO;                                                          0178 00514000
*       IF FPA>=PASTRT THEN         /* STORAGE ABOVE PRIVATE AREA  0179 00515000
*                                      START ?                       */ 00516000
         L     @11,CVTPTR                                          0179 00517000
         L     @01,GDAPTR(,@11)                                    0179 00518000
         L     @11,FPA-1(,@12)                                     0179 00519000
         LA    @11,0(,@11)                                         0179 00520000
         C     @11,PASTRT(,@01)                                    0179 00521000
         BL    @RF00179                                            0179 00522000
*         DO;                       /* YES: CONTINUE                 */ 00523000
*           IF LPA<CURRGNTP THEN    /* STORAGE BELOW CURRENT REGION     00524000
*                                      TOP ?                         */ 00525000
         L     @11,ASCBPTR                                         0181 00526000
         L     @01,LDAPTR(,@11)                                    0181 00527000
         L     @12,LPA-1(,@12)                                     0181 00528000
         LA    @12,0(,@12)                                         0181 00529000
         C     @12,CURRGNTP(,@01)                                  0181 00530000
         BNL   @RF00181                                            0181 00531000
*             RETCODE=0;            /* YES: STORAGE RANGE VALID      */ 00532000
         SLR   RETCODE,RETCODE                                     0182 00533000
*           ELSE                                                   0183 00534000
*             RETCODE=4;            /* NO: STORAGE RANGE INVALID     */ 00535000
         B     @RC00181                                            0183 00536000
@RF00181 LA    RETCODE,4                                           0183 00537000
*         END;                                                     0184 00538000
*       ELSE                                                       0185 00539000
*         RETCODE=4;                /* NO: STORAGE RANGE INVALID     */ 00540000
         B     @RC00179                                            0185 00541000
@RF00179 LA    RETCODE,4                                           0185 00542000
*     END;                                                         0186 00543000
*   ELSE                                                           0187 00544000
*     RETCODE=4;                                                   0187 00545000
         B     @RC00177                                            0187 00546000
@RF00177 LA    RETCODE,4                                           0187 00547000
*   RETURN CODE(RETCODE);           /* RETURN TO CALLING ROUTINE     */ 00548000
@RC00177 DS    0H                                                  0188 00549000
@EL00006 DS    0H                                                  0188 00550000
@EF00006 DS    0H                                                  0188 00551000
@ER00006 BR    @14                                                 0188 00552000
*   END PAGEVCK;                                                   0189 00553000
*                                                                  0190 00554000
*   /*****************************************************************/ 00555000
*   /*                                                               */ 00556000
*   /* ROUTINE TO CHANGE PROTECT KEY AND FETCH PROTECT FLAG OF A     */ 00557000
*   /* SINGLE PAGE-REFERENCE BIT IS PRESERVED-CHANGE BIT IS TURNED   */ 00558000
*   /* ON- THIS IS DONE TO PREVENT ANOTHER CPU FROM TURING IT ON     */ 00559000
*   /* WHILE THE KEY IS BEING CHANGED AND THUS LOSING THE CHANGE     */ 00560000
*   /*                                                               */ 00561000
*   /*****************************************************************/ 00562000
*                                                                  0190 00563000
*KEYCHG:                                                           0190 00564000
*   PROC OPTIONS(NOSAVE);                                          0190 00565000
KEYCHG   DS    0H                                                  0191 00566000
*   XPTPROT=KEYANDFP;               /* CHANGE KEY IN XPTE            */ 00567000
         L     @12,XPTEPTR                                         0191 00568000
         IC    @11,KEYANDFP                                        0191 00569000
         STC   @11,XPTPROT(,@12)                                   0191 00570000
*   XPTCKF=YES;                     /* INDICATE KEY FOR PAGE WAS   0192 00571000
*                                      CHANGED                       */ 00572000
         OI    XPTCKF(@12),B'00100000'                             0192 00573000
*   GEN REFS(PGAD,RCBITS,INR1,CHANGBIT);                           0193 00574000
*                                    /*                                 00575000
*         CHANGE HARDWARE KEY IF PAGE IS ASSIGNED TO A FRAME IN REAL    00576000
*         STORAGE                                                       00577000
         L     @15,PGAD               PAGE VA                           00578000
         LRA   @15,C0(@15)            PAGE IN REAL STORAGE ?            00579000
         BNZ   CHGEND                 NO:ROUTINE COMPLETE               00580000
         ISK   @00,@15                YES: HDW KEY FOR PAGE             00581000
         N     @00,RCBITS             SAVE REFERENCE BIT      @ZA11388  00582000
         O     @00,CHANGBIT           TURN ON CHANGE BIT      @ZA11388  00583000
         O     @00,NEWKEY             APPEND BITS TO NEW KEY            00584000
         SSK   @00,@15                CHANGE HDW KEY OF FIRST 2K        00585000
         LA    @15,C2K(@15)           ADDRESS OF SECOND 2K              00586000
         ISK   @00,@15                HDW KEY FOR HALF PAGE             00587000
         N     @00,RCBITS             SAVE REFERENCE BIT      @ZA11388  00588000
         O     @00,CHANGBIT           TURN ON CHANGE BIT      @ZA11388  00589000
         O     @00,NEWKEY             APPEND BITS TO NEW KEY            00590000
         SSK   @00,@15                CHANGE HDW KEY OF SECOND 2K       00591000
CHGEND   EQU   *                                                        00592000
*   RETURN CODE(0);                 /* RETURN TO CALLING ROUTINE     */ 00593000
         SLR   @15,@15                                             0194 00594000
@EL00007 DS    0H                                                  0194 00595000
@EF00007 DS    0H                                                  0194 00596000
@ER00007 BR    @14                                                 0194 00597000
*   END KEYCHG;                                                    0195 00598000
*                                                                  0196 00599000
*   /*****************************************************************/ 00600000
*   /*                                                               */ 00601000
*   /* ROUTINE TO RESTORE THE ORIGINAL STORAGE KEY FOR ALL PAGES     */ 00602000
*   /* WHOSE KEY HAS BEEN CHANGED. THE ROUTINE IS CALLED INTERNALLY  */ 00603000
*   /* WHEN AN INVALID PAGE HAS BEEN DETECTED IN THE VA RANGE        */ 00604000
*   /* REQUESTED DURING CHANGE KEY PROCESSING. IT IS ALSO A PART OF  */ 00605000
*   /* RETRY PROCESSING REQUESTED BY THE FRR FOR UNEXPECTED ERRORS.  */ 00606000
*   /*                                                               */ 00607000
*   /*****************************************************************/ 00608000
*                                                                  0196 00609000
*RECOVER:                                                          0196 00610000
*   PROC OPTIONS(NOSAVE);                                          0196 00611000
RECOVER  DS    0H                                                  0197 00612000
*   INRCV=YES;                      /* INDICATE ROUTINE ENTERED      */ 00613000
         L     @12,PARMPTR                                         0197 00614000
         OI    INRCV(@12),B'10000000'                              0197 00615000
*   RETAD2=REG14;                   /* SAVE RETURN ADDRESS           */ 00616000
         ST    REG14,RETAD2                                        0198 00617000
*   IF LPC^=NONE THEN               /* KEY FOR ANY PAGES CHANGED ?   */ 00618000
         L     @12,LPC                                             0199 00619000
         LTR   @12,@12                                             0199 00620000
         BZ    @RF00199                                            0199 00621000
*     DO;                           /* YES: RESTORE KEY              */ 00622000
*       RCSAVE=REG15;               /* SAVE RC OF CALLING ROUTINE    */ 00623000
         ST    REG15,RCSAVE                                        0201 00624000
*       KEYANDFP=OLDKEYFP;          /* ORIGINAL STORAGE KEY          */ 00625000
         IC    @12,OLDKEYFP                                        0202 00626000
         STC   @12,KEYANDFP                                        0202 00627000
*       IF REQUEST=LTYPE THEN       /* DETERMINE REQUEST TYPE        */ 00628000
         CLI   REQUEST,128                                         0203 00629000
         BNE   @RF00203                                            0203 00630000
*         DO;                       /* L-TYPE REQUEST                */ 00631000
*           ELTAD=INR1;             /* FIRST ELEMENT ADDRESS         */ 00632000
         L     @12,INR1                                            0205 00633000
         ST    @12,ELTAD                                           0205 00634000
*           DO UNTIL(LPG=LPC);      /* KEY FOR EACH RANGE CHANGED IS    00635000
*                                      RESTORED                      */ 00636000
@DL00206 DS    0H                                                  0207 00637000
*             IF FPA<=LPC&LPC<=LPA THEN/* LAST RANGE THAT KEY WAS  0207 00638000
*                                      CHANGED ?                     */ 00639000
         L     @12,LPC                                             0207 00640000
         L     @11,ELTAD                                           0207 00641000
         L     @08,FPA-1(,@11)                                     0207 00642000
         LA    @08,0(,@08)                                         0207 00643000
         CR    @12,@08                                             0207 00644000
         BL    @RF00207                                            0207 00645000
         L     @11,LPA-1(,@11)                                     0207 00646000
         LA    @11,0(,@11)                                         0207 00647000
         CR    @12,@11                                             0207 00648000
         BH    @RF00207                                            0207 00649000
*               LPG=LPC;            /* YES: RANGE ENDS WITH LAST PAGE   00650000
*                                      WHOSE KEY WAS CHANGED         */ 00651000
         ST    @12,LPG                                             0208 00652000
*             ELSE                                                 0209 00653000
*               LPG=LPA;            /* NO: KEY FOR ENTIRE RANGE WAS     00654000
*                                      CHANGED                       */ 00655000
         B     @RC00207                                            0209 00656000
@RF00207 L     @12,ELTAD                                           0209 00657000
         L     @12,LPA-1(,@12)                                     0209 00658000
         LA    @12,0(,@12)                                         0209 00659000
         ST    @12,LPG                                             0209 00660000
*             CALL KEYRSTR;         /* RESTORE KEY FOR RANGE         */ 00661000
@RC00207 BAL   @14,KEYRSTR                                         0210 00662000
*             ELTAD=ELTAD+LENGTH(LISTELT);/* NEXT ELEMENT IN LIST    */ 00663000
         LA    @12,8                                               0211 00664000
         AL    @12,ELTAD                                           0211 00665000
