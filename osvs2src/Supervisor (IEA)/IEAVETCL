         TITLE 'SUSPEND/RESUME/TCTL PROCESSOR'                          00050040
IEAVETCL CSECT                                                          00060040
         MODID  BR=NO                                                   00065040
         AGO   .SKIPFL1                                                 00070040
*/*IEAVETCL: CHART SUSPEND/RESUME/TCTL */                               00080040
*/*HEADER                                                               00100040
*/*                                                                     00150040
*/*                                                                     00200040
*/*                                     SECTION:3.1.8.11.3.14.3         00250040
*/*        SUSPEND/RESUME/TCTL                                          00300040
*/*                                        PAGE # */                    00350040
*/*IEAVSUSP: E SUSPEND ENTRY */                                         00370040
*/* N R1=0=CURRENT R1^=0=PREVIOUS */                                    00450040
*/* P USE REG 15 FOR ADDRESSABILITY */                                  00500040
*/* D (PREV,PREVIOUS,CURR,) RB=? */                                     00550040
*/* P GET CURRENT ASCB */                                               00600040
*/* COMMENT (4,19,) PSAAOLD */                                          00650040
*/*SUSP001: P (FAIL,SUSP001,OK,)                                        00700040
*/* #1C|   ASCBTCBS                                                     00750040
*/* #2 |                                                                00800040
*/* #3-|------------                                                    00850040
*/* #4S|   ASCBTCBS-1                                                   00900040
*/* #5 |   */                                                           00950040
*/* P GET CURRENT TCB */                                                01000040
*/* COMMENT (4,19,) PSATOLD */                                          01050040
*/* P GET CURRENT RB */                                                 01100040
*/* COMMENT (4,19,) TCBRBP */                                           01150040
*/*SUSP002: P (FAIL,SUSP002,OK,)                                        01200040
*/* #1C|   RBSCF                                                        01250040
*/* #2 |                                                                01300040
*/* #3-|------------                                                    01350040
*/* #4S|   RBSCF+1                                                      01400040
*/* #5 |   */                                                           01450040
*/* P MAKE SURE R0=@TCB AND R1=@RB */                                   01500040
*/* R RETURN TO CALLER */                                               01550040
*/*PREVIOUS: P GET CURRENT TCB */                                       01600040
*/* COMMENT (4,19,) PSATOLD */                                          01650040
*/* P GET CURRENT RB */                                                 01700040
*/* COMMENT (4,19,) TCBRBP */                                           01750040
*/* D (Y,SUSABEND,N,) RB POINT TO TCB? */                               01950040
*/* COMMENT (4,19,) RBTCBNXT */                                         01960040
*/* P GET PREVIOUS RB */                                                01970040
*/* COMMENT (4,19,) RBLINK */                                           01980040
*/*SUSP003: P (FAIL,SUSP003,OK,)                                        02000040
*/* #1C|   RBSCF                                                        02050040
*/* #2 |                                                                02100040
*/* #3-|------------                                                    02150040
*/* #4S|   RBSCF+1                                                      02200040
*/* #5 |   */                                                           02250040
*/* P MAKE SURE R0=@TCB AND R1=@RB */                                   02300040
*/* R RETURN TO CALLER */                                               02350040
*/*SUSABEND: P SET UP ERROR CODE _ NO PREVIOUS RB */                    02400040
*/* R ABEND CALLER */                                                   02450040
*/*IEAVRSME: E RESUME ENTRY */                                          02500040
*/* N #1     R4=@TCB#2     R5=@RB#3     R14=RETURN OR 0#4     R15=EP */ 02550040
*/* P ESTABLISH COMMON ADDRESSABILITY */                                02600040
*/* P REFERENCE RB FOR VALIDITY CHECK (OI X'00') */                     02650040
*/*RESU001: P                                                           02700040
*/* #1C|   ACTIV OFF                                                    02750040
*/* #2 |   S3A OFF                                                      02800040
*/* #3-|------------                                                    02850040
*/* #4S| ACTIV + S3A ON                                                 02900040
*/* #5 | CCPVI=CPULA */                                                 02950040
*/* COMMENT (4,19,) TCBXSCT */                                          03000040
*/* D  (YES,GETLOCK,NO,) FAIL? */                                       03050040
*/RESU002:  D (Y,RESU006,N,) RBSCF=0 ? */                               03160040
*/*RESU002: P (FAIL,RESU002,OK,)                                        03200040
*/* #1C|   RBSCF                                                        03300040
*/* #2 |                                                                03350040
*/* #3-|------------                                                    03400040
*/* #4S|   RBSCF-1                                                      03450040
*/* #5 |             */                                                 03500040
*/*RESU003: D (N,RESU005,Y,) TOP RB ? */                                03550040
*/* D (N,RESU011A,Y,) TCB DISPATCHABLE ? */                             03600040
*/* COMMENT (4,19,) TCBFLGS4 */                                         03650040
*/* D (N,RESU011A,Y,) RB DISPATCHABLE ? */                              03700040
*/* COMMENT (4,19,) RBWCF */                                            03750040
*/* D (N,RESU011A,Y,) ASCB DISPATCHABLE ? */                            03800040
*/* COMMENT (4,19,) ASCBSTND */                                         03850040
*/*RESU004: P (FAIL,RESU004,OK,)                                        03900040
*/* #1C|   ASCBTCBS                                                     03950040
*/* #2 |                                                                04000040
*/* #3-|------------                                                    04050040
*/* #4S|   ASCBTCBS+1                                                   04100040
*/* #5 |   */                                                           04150040
*/*RESU005: D (N,RESU006,Y,) RETURN= ? */                               04200040
*/* P TURN OFF ACTIV AND S3A */                                         04250040
*/* R RETURN TO CALLER */                                               04300040
*/*RESU006: D (Y,RESU0061,N,) CALLER SRB ? */                           04350040
*/* COMMENT (4,19,) LCCADSF2 */                                         04400040
*/* P TURN OFF ACTIV AND S3A */                                         04450040
*/* COMMENT (4,19,) TCBXSCT */                                          04500040
*/*RESABEND: P SET UP ERROR CODE */                                     04550040
*/* R ABEND CALLER */                                                   04600040
*/*RESU0061: P SET UP SUPER FRR AND FLAGS */                   @ZA18126 04650040
*/* COMMENT (3,19,) PSACSTK */                                          04900040
*/* COMMENT (4,19,) PSASUP1 */                                          04950040
*/* P SET CDAL FLAG     (STATUS INTERSECT) */                           05000040
*/* COMMENT (4,19,) CDALTCTL */                                         05030040
*/* D (Y,TCTL003,N,TCTL002) STATUS RUNNING ? */                         05100040
*/*GETLOCK: D (N,RESU001,Y,) ACTIV/ S3A STILL ON ? */                   05120040
*/* P SHOW LOCK HELD, IN CASE SETLOCK SKIPPED */                        05123040
*/* D (Y,RESU007A,N,) IS THIS CPU ACTIVE? */                            05126040
*/* P SAVE RETURN ADDRESS */                                            05130040
*/* S SETLOCK: GET LOCAL LOCK */                                        05150040
*/* N RETURN CODE MAY SHOW LOCK ALREADY HELD */                         05200040
*/*RESU007A: D (Y,RESU010,N,) RBSCF=0 ? */                              05250040
*/*RESU007: P (FAIL,RESU007,OK,)                                        05300040
*/* #1C|   RBSCF                                                        05350040
*/* #2 |                                                                05400040
*/* #3-|------------                                                    05450040
*/* #4S|   RBSCF-1                                                      05500040
*/* #5 |             */                                                 05550040
*/*RESU008: P                                                           05600040
*/* #1C|   ACTIV OFF                                                    05650040
*/* #2 |                                                                05700040
*/* #3-|------------                                                    05750040
*/* #4S| ACTIV + S3A ON                                                 05800040
*/* #5 | CCPVI=CPULA   */                                               05830040
*/* COMMENT (4,19,) TCBXSCT */                                          05900040
*/* D (OTHR,RESU008,ACT,RESU012,N,) FAIL ? */                           05950040
*/* COMMENT (7,22,) ACTIV */                                            06000040
*/* COMMENT (9,22,) ON */                                               06030040
*/* D (N,RESU003,Y,) LOCK ACQUIRED ? */                                 06100040
*/* S (,RESU008A) SETLOCK: RELEASE LOCAL LOCK */                        06150040
*/*RESU012: D (N,RESU010,Y,) RB = TOP RB ? */                           06200040
*/*RESU009: P (FAIL,RESU009,OK,)                                        06250040
*/* #1C|   ASCBTCBS                                                     06300040
*/* #2 |                                                                06350040
*/* #3-|------------                                                    06400040
*/* #4S|   ASCBTCBS+1                                                   06450040
*/* #5 |   */                                                           06500040
*/*RESU010: D (N,RESU011,Y,) LOCK ACQUIRED ? */                         06550040
*/* S SETLOCK: RELEASE LOCAL LOCK */                                    06600040
*/* P RESTORE RETURN ADDRESS */                                         06620040
*/*RESU011: D (N,RESU013,Y,) RETURN=? */                                06650040
*/* R RETURN TO CALLER */                                               06700040
*/*RESU013: D (N,RESABEND,Y,) SRB MODE ? */                             06750040
*/* R SRB EXIT */                                                       06800040
*/*RESU011A: P TURN OFF INTERSECT FLAGS */                              06810040
*/* D (NO,RESU013,YES,) RETURN REQUESTED ? */                           06820040
*/* R RETURN TO CALLER */                                               06830040
*/*RESU008A: P (,RESU003) RESTORE RETURN ADDRESS */                     06840040
*/*IEAVTCTL: E TCTL ENTRY */                                            06850040
*/* D (N,TCTABEND,Y,) SRB MODE ? */                                     06900040
*/* P SET KEY TO ZERO */                                                06950040
*/* P GET @LCCA (INTO REG 7) */                                         07000040
*/* P DISABLE FOR INTERRUPTS */                                         07050040
*/* COMMENT (4,19,) LCCAPSMK */                                         07100040
*/* P SET UP SUPER FRR AND FLAGS */                                     07150040
*/* COMMENT (3,19,) PSACSTK */                                          07200040
*/* COMMENT (3,19,) PSASUP1 */                                          07250040
*/* P ESTABLISH COMMON ADDRESSABILITY */                                07300040
*/* P SET CDAL FLAG (STATUS INTERSECT) */                               07350040
*/* D (Y,TCTL003,N,) STATUS RUNNING ? */                                07360040
*/* COMMENT (4,19,) ASCBSTA */                                          07370040
*/*TCTL001: P                                                           07400040
*/* #1C|   ACTIV OFF                                                    07450040
*/* #2 |   S3A OFF                                                      07500040
*/* #3-|------------                                                    07550040
*/* #4S| ACTIV + S3A ON                                                 07600040
*/* #5 | CCPVI=CPULA */                                                 07650040
*/* COMMENT (4,19,) TCBXSCT */                                          07700040
*/*TCTL002: D (N,TCTL003,Y,) TCB DISPATCHABLE ? */                      08000040
*/* COMMENT (4,19,) TCBFLGS4 */                                         08050040
*/* D (Y,TCTL003,N,) TCB AFFINITY TO OTHER PROCESSOR ? */     @ZA16831  08070040
*/* D (N,TCTL003,Y,) RB DISPATCHABLE ? */                               08100040
*/* COMMENT (4,19,) RBWCF */                                            08150040
*/* D (N,TCTL003,Y,) ASCB DISPATCHABLE ? */                             08200040
*/* COMMENT (4,19,) ASCBSTND */                                         08250040
*/* L DISPATCHER JOB STEP TIMING ROUTINE */                             08300040
*/* N REG 9 NOW HAS DISPATCHER BASE */                                  08350040
*/* P RESET SRB MODE FLAGS */                                           08400040
*/* S SETLOCK: GET DISP LOCK    */                                      08450040
*/* P DECREMENT COUNT OF SRBS IN MEMORY */                              08460040
*/* D (GE,%SET2,LT,) COMPARE ASCBSEQN OF AOLD:ANEW */         @ZA16832  08475040
*/* P UPDATE PSAANEW TO EQUAL PSAAOLD */                      @ZA16832  08480040
*/*%SET2: S SETLOCK: RELEASE DISP LOCK */                               08485040
*/* N */                                                      @ZA18126  08707040
*/* COMMENT (7,6,) CDAL IS CLEARED IN */                      @ZA18126  08717040
*/* COMMENT (8,5,) THE DISPATCHER AFTER */                    @ZA18126  08747040
*/* COMMENT (9,4,) ASCBCPUS IS INCREMENTED */                 @ZA18126  08777040
*/* R SPECIAL DISPATCHER EP */                                          08900040
*/*TCTL003: P TURN OFF INTERSECT FLAGS */                               08950040
*/* P CLEAR CDAL */                                                     08960040
*/* COMMENT (4,19,) CDALCPUX */                                         09000040
*/* P RESTORE FRR AND FLAGS */                                          09050040
*/* COMMENT (3,19,) PSACSTK */                                          09100040
*/* COMMENT (4,19,) PSASUP1 */                                          09150040
*/* P ENABLE */                                                         09200040
*/* R NORMAL SRB EXIT */                                                09250040
*/*TCTABEND: P SET UP ABEND CODE */                                     09300040
*/* R ABEND */                                                          09350040
.SKIPFL1  ANOP                                                          09400040
*        SPACE 2                                                        09400140
*             MODULE PROLOG                                             09400240
*                                                                       09400340
*  MODULE NAME = IEAVETCL                                               09400440
*                                                                       09400540
*  DESCRIPTIVE NAME = SUSPEND/RESUME/TCTL PROCESSOR                     09400640
*                                                                       09400740
*  COPYRIGHT = NONE                                                     09400840
*                                                                       09400940
*  STATUS = SEE CHANGE ACTIVITY AT END OF PROLOGUE.            @ZA31944 09401040
*                                                                       09404740
*  FUNCTION = THIS MODULE CONTAINS THE SUSPEND, RESUME AND              09404840
*             TCTL FUNCTIONS.                                           09404940
*                                                                       09405040
*           SUSPEND: THE FUNCTION OF SUSPEND IS TO INCREMENT            09405140
*           THE RESCF COUNT. THIS CAUSES THE ROUTINE TO ENTER           09405240
*           A SUSPENDED STATE WHEN IT LOSES CONTROL TO THE              09405340
*           DISPATCHER. IF THE CURRENT RB IS SUSPENDED,                 09405440
*           ASCBTCBS IS ALSO DECREMENTED BY 1.                          09405540
*                                                                       09405640
*           RESUME: RESUME'S PRIMARY FUNCTION IS TO DECREMENT           09405740
*           THE SUSPEND COUNT (RBSCF) IN THE RB'S                       09405840
*           WAIT COUNT FIELD. IF THIS CAUSES THE TCB/RB                 09405940
*           TO BECOME DISPATCHABLE, THEN THE COUNT OF                   09406040
*           READY TCB'S (ASCBTCBS) MUST BE INCREMENTED.                 09406140
*                                                                       09406240
*           TCTL: THE TCTL FUNCTION PASSES CONTROL                      09406340
*           DIRECTLY FROM AN SRB TO A READY TCB. ONLY                   09406440
*           SRB'S MAY INVOKE IT AS A MEANS OF EXITING                   09406540
*           FROM THE SRB PROCESS. NO DISPATCH AS SUCH                   09406640
*           WILL BE DONE, ALTHOUGH SOME COMMON DISPATCHER               09406740
*           CODE WILL BE USED TO PASS CONTROL TO THE REQUESTED TCB.     09406840
*                                                                       09406940
*  DEPENDENCIES =                                                       09407040
*           LOCAL LOCK MAY BE ACQUIRED, THEREFORE NO LOCK               09407140
*           HIGHER IN HIERARCHY MAY BE HELD ON ENTRY.                   09407240
*                                                                       09407340
*  CHARACTER CODE DEPENDENCIES = NONE                                   09407440
*                                                                       09407540
*  RESTRICTIONS = NONE                                                  09407640
*                                                                       09407740
*  PROCESSOR = ASSEMBLER-370R                                           09407840
*                                                                       09407940
*  MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY                         09408040
*                                                                       09408140
*  ATTRIBUTES = NUCLEUS,ZERO PSQ PROTECT KEY, DISABLED                  09408240
*               (TCTL ONLY), SUPERVISOR MODE                            09408340
*                                                                       09408440
*  ENTRY POINT = IEAVSPND                                               09408540
*                                                                       09408640
*  ENTRY POINT = IEAVSPND                                               09408740
*                                                                       09408840
*     PURPOSE = PERFORM SUSPEND FUNCTION                                09408940
*                                                                       09409040
*     LINKAGE = VIA SUSPEND MACRO                                       09409140
*                                                                       09409240
*     INPUT   = REGISTER:  1  =  0 IF RB = CURRENT                      09409340
*                                4 IF RB = PREVIOUS                     09409440
*                         14  =  RETURN ADDRESS                         09409540
*                         15  =  ENTRY POINT                            09409640
*                                                                       09409740
*     OUTPUT  = REGISTERS UNCHANGED                                     09409840
*                       2,3,4,5,6,7,8,9,10,11,12                        09409940
*               REGISTER:  0  =  TCB ADDRESS                            09410040
*                          1  =  ADDRESS OF SUSPENDED RB                09410140
*                         13  =  N/A                                    09410240
*                         14  =  RETURN ADDRESS                         09410340
*                         15  =  N/A                                    09410440
*               - RBSCF COUNT INCREMENTED                               09410540
*               - ASCBTCB5 COUNT MAY BE DECREMENTED                     09410640
*                                                                       09410740
*     EXITS-NORMAL  =  RETURN TO CALLER                                 09410840
*                                                                       09410940
*     EXITS-ERROR   =  ABEND 070 WITH REGISTER 15 = 0 IF RB = PREVIOUS  09411040
*                      WAS SPECIFIED BUT NO PREVIOUS RB EXISTED.        09411140
*                                                                       09411240
*     ROUTINES      =  NONE                                             09411340
*                                                                       09411440
*     DATA AREAS    =  NONE                                             09411540
*                                                                       09411640
*     CONTROL BLOCKS =   FIELD         REF     MACRO                    09411740
*                                                                       09411840
*         ASCB         ASCBTCBS         W     IHAASCB                   09411940
*                                                                       09412040
*         PSA          PSAAOLD          R     IHAPSA                    09412140
*                      PSATOLD                                          09412240
*                                                                       09412340
*         RB           RBLINK           R     IHARB                     09412440
*                      RBSCF                                            09412540
*                                                                       09412640
*         TCB          TCBRBP           R     IKJTCB                    09412740
*                                                                       09412840
*     MACROS         =   ABEND                                          09412940
*                                                                       09413040
*     SERIALIZATION  =   CS SERIALIZES USE OF ASCBTCBS.                 09413140
*                        THE TCB/RB CHAIN IS PROTECTED BY THE           09413240
*                        TCBACTIV FLAG, SINCE SUSPEND CAN               09413340
*                        ONLY BE ISSUED BY THE CURRENT                  09413440
*                        ACTIVE TCB.                                    09413540
*                                                                       09413640
*  ENTRY POINT       =   IEAVRSME                                       09413740
*                                                                       09413840
*     PURPOSE        =   PERFORM RESUME FUNCTION                        09413940
*                                                                       09414040
*     LINKAGE        =   VIA RESUME MACRO                               09414140
*                                                                       09414240
*     INPUT          =   REGISTER:  4   =   TCB ADDRESS                 09414340
*                                   5   =   RB ADDRESS                  09414440
*                                  14   =   RETURN ADDRESS OR 0         09414540
*                                  15   =   ENTRY POINT                 09414640
*                         0,1,11,12,13  =   WORK REGISTERS              09414740
*                                                                       09414840
*     OUTPUT         =   REGISTERS UNCHANGED:                           09414940
*                                2,3,4,5,6,7,8,9,10,14                  09415040
*                           - RBSCF COUNT DECREMENTED                   09415140
*                           - ASCBTCBS COUNT MAY BE INCREMENTED         09415240
*                           - NO RETURN CODE IS PASSED FROM RESUME      09415340
*                                                                       09415440
*     EXITS-NORMAL   =                                                  09415540
*          -    RETURN TO CALLER IF REGISTER 14 IS NON-0;               09415640
*               OTHERWISE:                                              09415740
*          -    IF CALLER IS IN SRB MODE, TRY TO TCTL TO                09415840
*               THE TCB BEING RESUME'D;                                 09415940
*                                                                       09416040
*     EXITS-ERROR    =   ABEND 070 WITH REGISTER 15 = 4 IF NON-SRB MODE 09416140
*                        CALLER ISSUES A RESUME RETURN = N.             09416240
*                                                                       09416340
*  EXTERNAL REFERENCES = NONE                                           09416440
*                                                                       09416540
*     ROUTINES       =   RESUME BRANCHES TO AN INTERNAL ENTRY POINT     09416640
*                        IN THE TCTL LOGIC WHEN PROCESSING AN SRB       09416740
*                        MODE CALLER WITH NO RETURN ADDRESS. CONTROL    09416840
*                        IS NOT RETURNED TO RESUME.                     09416940
*                                                                       09417040
*     DATA-AREAS     =   NONE                                           09417140
*                                                                       09417240
*     CONTROL BLOCKS   =      FIELD       REF        MACRO              09417340
*                                                                       09417440
*        ASCB                ASCBSTA       C        IHAASCB             09417540
*                            ASCBSTND      C                            09417640
*                            ASCBTCBS      C,W                          09417740
*                                                                       09417840
*        CVT                 CVTSRBRT      R        CVT                 09417940
*                                                                       09418040
*        LCCA                LCCADSF2      C        IHALCCA             09418140
*                            LCCAPSMK      W                            09418240
*                                                                       09418340
*        PSA                 PSACPULA      R        IHAPSA              09418440
*                            PSACSTK       W                            09418540
*                            PSASSTK       R                            09418640
*                            PSASUP1       W                            09418740
*                                                                       09418840
*        RB                  RBSCF         C,W      IHARB               09418940
*                                                                       09419040
*        TCB                 TCBACTIV      C,W      IKJTCB              09419140
*                            TCBCCPVI      W                            09419240
*                            TCBFLGS4      C                            09419340
*                            TCBFLGS5      C                            09419440
*                            TCBS3A        C, W                         09419540
*                                                                       09419640
*     MACROS         =   ABEND,SETLOCK                                  09419740
*                                                                       09419840
*     SERIALIZATION  =   TCBACTIV FLAG IS USED TO SERIALIZE THE         09419940
*                        TCB/RB BETWEEN DISPATCHER AND RESUME.          09420040
*                                                                       09420140
*                        TCBS3A FLAG IS USED TO SERIALIZE THE           09420240
*                        TCB/RB BETWEEN STAGE 3 AND RESUME.             09420340
*                                                                       09420440
*                        THE LOCAL LOCK IS USED TO SERIALIZE            09420540
*                        THE TCB/RB IF EITHER ABOVE FLAG IS             09420640
*                        ALREADY ON WHEN RESUME CHECKS IT VIA           09420740
*                        COMPARE AND SWAP.                              09420840
*                                                                       09420940
*     ENTRY POINT    =   IEAVTCTL                                       09421040
*                                                                       09421140
*        PURPOSE     =   PERFORM TCTL FUNCTION                          09421240
*                                                                       09421340
*        LINKAGE     =   VIA TCTL MACRO                                 09421440
*                                                                       09421540
*        INPUT       =   REGISTER:   4  =  TCB ADDRESS                  09421640
*                                   15  =  ENTRY POINT                  09421740
*                                   (ALL OTHERS AVAILABLE FOR WORK)     09421840
*                                                                       09421940
*  OUTPUT            =   (SEE EXTERNAL-REFERENCES FOR INPUT TO          09422040
*                         DISPATCHER)                                   09422140
*                                                                       09422240
*        EXITS-NORMAL  =                                                09422340
*             - IF TCB/RB IS DISPATCHABLE, INTERFACE WITH               09422440
*               DISPATCHER TO PASS CONTROL TO TCB;                      09422540
*               OTHERWISE:                                              09422640
*               - RETURN TO SRB EXIT.                                   09422740
*                                                                       09422840
*        EXITS-ERROR   =                                                09422940
*               - ABEND 070 WITH REGISTER 15 = 4 IF TCTL                09423040
*                 CALLER IS NOT IN SRB MODE.                            09423140
*                                                                       09423240
*        EXTERNAL REFERENCES =                                          09423340
*               DISPATCHER JOB STEP TIMING ROUTINE:                     09423440
*                    THIS ROUTINE IS USED TO ACCUMULATE THE             09423540
*                    JOB STEP TIME FOR THE CURRENT ADDRESS              09423640
*                    SPACE.                                             09423740
*               INPUT:                                                  09423840
*                    REGISTER  7  =  LCCA ADDRESS                       09423940
*                    REGISTER  8  =  ASCB ADDRESS                       09424040
*                    REGISTER 14  =  RETURN ADDRESS                     09424440
*                    (THIS ROUTINE SETS UP ITS OWN                      09424840
*                    ADDRESSABILITY)                                    09425240
*                                                                       09425640
*               ON RETURN FROM JOB STEP TIMING, REGISTER 9              09426040
*               CONTAINS THE DISPATCHERS BASE ADDRESS. THIS             09426440
*               IS SAVED AS INPUT TO THE FOLLOWING EXTERNAL             09426840
*               REFERENCE.                                              09427240
*                                                                       09427640
*               DISPATCHER TCB STATUS RESTORE:                          09428040
*                    THIS ROUTINE RESTORES THE STATUS OF A              09428440
*                    DISPATCHABLE TCB AND GIVES CONTROL TO ITS          09428840
*                    TOP RB VIA LPSW.                                   09429240
*               INPUT:                                                  09429640
*                    REGISTER  5  =  RB ADDRESS                         09430040
*                    REGISTER  6  =  TCB ADDRESS                        09430440
*                    REGISTER  7  =  LCCA ADDRESS                       09430840
*                    REGISTER  8  =  ASCB ADDRESS                       09431240
*                    REGISTER  9  =  BASE ADDRESS OF DISPATCHER         09431640
*                    REGISTER 13  =  NON-ZERO VALUE (USED AS FLAG       09432040
*                                    THAT ROUTINE WAS EXTERNALLY        09432440
*                                    ENTERED)                           09432840
*                                                                       09433240
*               LOCK MGR SPECIAL ENTRY FOR DISP LOCK:                   09433340
*                    THIS ROUTINE ACQUIRES THE DISPATCHER               09433440
*                    LOCK WITHOUT VALIDITY CHECKS.                      09433540
*               INPUT:                                                  09433640
*                    REGISTER 13 = ENTRY POINT                          09433740
*                    REGISTER 14 = RETURN ADDRESS                       09433840
*                                                                       09433940
*        DATA AREAS    =    NONE                                        09434240
*                                                                       09434340
*     CONTROL BLOCKS   =     FIELD        REF       MACRO               09434440
*                                                                       09434840
*          ASCB             ASCBSTA        C       IHAASCB              09435240
*                           ASCBSTND       C                            09435640
*                           ASCBTCBS       C,W                          09436040
*                                                                       09436440
*          CDAL             CDALASCB       W       IHACDAL              09436840
*                                                                       09437240
*          CVT              CVTSRBRT       R       CVT                  09437640
*                                                                       09438040
*          LCCA             LCCADSF2       C       IHALCCA              09438440
*                           LCCAPSMK       W                            09438840
*                                                                       09439240
*          PSA              PSACPULA       R       IHAPSA               09439640
*                           PSACSTK        W                            09440040
*                           PSASSTK        R                            09440440
*                           PSASUP1        W                            09440840
*                                                                       09441240
*          RB               RBWCF          C       IHARB                09441640
*                                                                       09442040
*          TCB              TCBACTIV       C,W     IKJTCB               09442440
*                           TCBCCPVI       W                            09442840
*                           TCBFLGS4       C                            09443240
*                           TCBFLGS5       C                            09443640
*                           TCBS3A         C,W                          09444040
*                                                                       09444440
*     MACROS       =    ABEND                                           09444840
*                                                                       09445240
*     SERIALIZATION =   TCBACTIV FLAG IS USED TO SERIALIZE THE          09445640
*                       TCB/RB BETWEEN DISPATCHER AND TCTL              09446040
*                                                                       09446440
*                       TCBS3A FLAG IS USED TO SERIALIZE THE            09446840
*                       TCB/RB BETWEEN STAGE 3 AND TCTL                 09447240
*                       CDALASCB FIELD IS USED TO PREVENT AN            09447640
*                       INTERSECT WITH STATUS.                          09448040
*                                                                       09448440
*                       IF EITHER ABOVE FLAG IS ALREADY ON, NO          09448840
*                       OTHER SERIALIZATION IS ATTEMPTED, AND           09449240
*                       TCTL ESCAPES TO THE NORMAL SRB EXIT.            09449640
*                                                                       09450040
*     CHANGE ACTIVITY =                                        @ZA31944 09450140
*          OZ11326                                             @ZA31944 09452140
*          OZ11584                                             @ZA31944 09452240
*          OZ14227                                             @ZA31944 09452340
*          OZ14983                                             @ZA31944 09452440
*          OZ16831-CHANGE TO CHECK FOR TCB AFFINITY BEFORE     @ZA31944 09452540
*                  PERFORMING TCTL.                            @ZA31944 09452640
*          OZ16832                                             @ZA31944 09452740
*          OZ17792-ON RESUME RET=NO OR TCTL TO TASK WITH       @ZA31944 09452840
*                  AFFINITY TO ANOTHER PROCESSOR, ASCBLOCK HAD @ZA31944 09452940
*                  BEEN ZEROED EVEN WHEN THE LOCAL LOCK WAS    @ZA31944 09453040
*                  NOT OWNED.                                  @ZA31944 09453140
*          OZ18126-IMPROPER SERIALIZATION WITH IEAVSETS OF     @ZA31944 09453240
*                  FIELD TCBXSCT.                              @ZA31944 09453340
*          OZ18162-SUSPEND DID NOT INCREMENT SHORT WAIT COUNT  @ZA31944 09453440
*                  WHEN ASCBTCBS GOES TO ZERO.                 @ZA31944 09453540
*          OZ25947-CHANGE TO SAVE SYSTEM MASK WHEN RESUME      @ZA31944 09453640
*                  OBTAINS THE LOCAL LOCK, BECAUSE THE PSA IS  @ZA31944 09453740
*                  NOT SERIALIZED THEN.                        @ZA31944 09453840
*          OZ31944-THE SYSTEM MASK SAVED BY RESUME IN THE PSA  @ZA31944 09453940
*                  MAY BE OVERLAID BY OTHER DISABLED MODULES   @ZA31944 09454040
*                  WHICH MAY BE INVOKED WHEN THE LOCAL LOCK IS @ZA31944 09454140
*                  RELEASED.                                   @ZA31944 09454240
         TITLE 'SUSPEND PROCESSOR'                                      09454340
*        REGISTER EQUATES                                               09454440
R0       EQU   0                                                        09454540
R1       EQU   1                                                        09456040
R2       EQU   2                                                        09458040
R3       EQU   3                                                        09460040
R4       EQU   4                                                        09462040
R5       EQU   5                                                        09464040
R6       EQU   6                                                        09466040
R7       EQU   7                                                        09468040
R8       EQU   8                                                        09470040
R9       EQU   9                                                        09472040
R10      EQU   10                                                       09474040
R11      EQU   11                                                       09476040
R12      EQU   12                                                       09478040
R13      EQU   13                                                       09480040
R14      EQU   14                                                       09482040
R15      EQU   15                                                       09484040
         SPACE 2                                               @ZA18162 09492040
         ENTRY IEAVSPND                                                 09500040
IEAVSPND DS    0H                    SUSPEND ENTRY POINT                09530040
         SPACE                                                          09560040
*        THIS ROUTINE IS ENTERED BY THE SUSPEND MACRO                   09600040
*        TO PLACE AN RB IN THE SUSPENDED STATE.                         09650040
         SPACE                                                          09700040
         USING PSA,0                                                    09750040
         USING *,R15                 USE ENTRY REG FOR ADDRESSABILITY   09800040
         LTR   R1,R1                 RB=CURRENT IF ZERO                 09850040
         BNZ   PREVIOUS              RB=PREVIOUS IF NON-ZERO            09900040
         SPACE 2                                                        09950040
*        CURRENT RB IS GOING TO BE SUSPENDED. THEREFORE                 10000040
*        ASCBTCBS COUNT MUST BE DECREMENTED.                            10050040
         SPACE                                                          10070040
         L     R13,PSAAOLD           CURRENT ASCB                       10100040
         USING ASCB,R13                                                 10150040
         L     R0,ASCBTCBS           GET COUNT OF TCBS                  10190040
SUSP001  LTR   R1,R0                 ASCBTCBS=0?               @ZA14983 10210040
         BNP   SUSPINCR              YES, DO NOT DECR COUNT    @ZA14983 10230040
         BCTR  R1,0                  DECREMENT IT BY ONE                10270040
         CS    R0,R1,ASCBTCBS        REPLACE OLD COUNT                  10310040
         BNE   SUSP001               REPEAT IF COMPARE FAILS            10350040
         LTR   R1,R1                 ASCBTCBS=0?               @ZM43088 10353040
         BNZ   SUSPINCR              NO, WORK ON SUSP CT       @ZM43088 10357040
         LH    R1,ASCBSWCT           PICK UP SHORT WAIT CONT   @ZM43088 10364040
         LA    R1,C1(R1)             BUMP BY 1                 @ZA18162 10371040
         STH   R1,ASCBSWCT           RESTORE                   @ZM43088 10378040
SUSPINCR DS    0H                                              @ZM43088 10385040
         SPACE                                                          10400040
*        NOW THE SUSPEND COUNT IN THE RB MUST BE INCREMENTED            10450040
         SPACE                                                          10470040
         L     R1,PSATOLD            GET CURRENT TCB                    10500040
         USING TCB,R1                                                   10550040
         L     R1,TCBRBP             GET CURRENT RB                     10600040
         USING RBSECT,R1                                                10650040
         L     R13,RBSCF             GET SUSPEND CT AND LINK FIELD      10700040
SUSP002  LR    R0,R13                COPY FIELD                         10750040
         AL    R0,HIBYTE1            ADD ONE TO HIGH BYTE               10800040
         CS    R13,R0,RBSCF          REPLACE OLD COUNT                  10850040
         BNE   SUSP002               REPEAT IF COMPARE FAILS            10900040
         L     R0,PSATOLD            @TCB IN REG 0 FOR CALLER           10950040
*                                    @RB ALREADY IN REG 1 FOR CALLER    11000040
         BR    R14                   RETURN TO CALLER                   11050040
         DROP  R1,R13                                                   11100040
         SPACE 2                                                        11150040
*        PREVIOUS RB IS GOING TO BE SUSPENDED. IF NO PREVIOUS           11200040
*        RB EXISTS, THE CALLER IS ABENDED.                              11250040
         SPACE                                                          11270040
PREVIOUS L     R1,PSATOLD            GET CURRENT TCB                    11300040
         USING TCB,R1                                                   11350040
         L     R1,TCBRBP             GET CURRENT RB                     11400040
         USING RBSECT,R1                                                11450040
         TM    RBSTAB2,RBTCBNXT      IS THERE A PREVIOUS RB?            11500040
         BO    SUSABEND              NO, ABEND CALLER                   11550040
         L     R1,RBLINK             GET PREVIOUS RB                    11600040
         L     R13,RBSCF             GET SUSPEND CT AND LINK FIELD      11650040
SUSP003  LR    R0,R13                COPY FIELD                         11700040
         AL    R0,HIBYTE1            ADD ONE TO HIGH BYTE               11750040
         CS    R13,R0,RBSCF          REPLACE OLD COUNT                  11800040
         BNE   SUSP003               REPEAT IF COMPARE FAILS            11850040
         L     R0,PSATOLD            @TCB IN REG 0 FOR CALLER           11900040
*                                    @RB ALREADY IN REG 1 FOR CALLER    11950040
         BR    R14                   RETURN TO CALLER                   12000040
         DROP  R1,R15                                                   12050040
         SPACE 2                                                        12100040
*        NO PREVIOUS RB EXISTS; ABEND CALLER                            12150040
         SPACE                                                          12170040
SUSABEND SLR   R15,R15               CODE FOR ABOVE ERROR               12200040
         ABEND  X'070',DUMP,,SYSTEM  ABEND CALLER                       12250040
         TITLE 'RESUME PROCESSOR'                                       12350040
         ENTRY IEAVRSME                                                 12400040
IEAVRSME DS    0H                    RESUME ENTRY POINT                 12450040
         SPACE                                                          12470040
*        THIS ROUTINE IS ENTERED BY THE RESUME MACRO TO                 12500040
*        REMOVE AN RB FROM THE SUSPENDED STATE                          12550040
         SPACE                                                          12570040
         USING IEAVRSME,R15          COMMON ADDRESSABILITY IS           12600040
*                                    USED BY RESUME AND TCTL SINCE      12650040
*                                    RESUME MAY EXIT TO TCTL            12700040
         USING TCB,R4                @TCB IS IN R4 ON ENTRY             12750040
         USING RBSECT,R5             @RB IS IN R5 ON ENTRY              12800040
         OI    RBSIZE,X'00'          DUMMY REFERENCE OF RB AS  @ZA11584 12820040
*                                    VALIDITY CHECK BEFORE THE          12900040
*                                    ACTIV FLAG IS SET                  12950040
         STNSM PSAIPCR+C1,DISABLE    DISABLE FOR I/O + EXT INT @ZA11584 12970040
RESU001  L     R1,TCBXSCT            LOAD INTERSECT FLAGS               13000040
         N     R1,MASK1              TURN OFF ACTIV/S3A FLAGS IN REG    13050040
         LR    R0,R1                 COPY REG FOR CS                    13100040
         O     R0,MASK2              TURN ON ACTIV/S3A FLAGS IN REG     13150040
         IC    R0,PSACPULA+1         INSERT CPUID INTO REG              13200040
*                                    ONLY LOW BYTE HAS VALUE, SO        13250040
*                                    IC MAY BE USED; IF VALUE IS        13300040
*                                    EVER EXPANDED TO TWO BYTES,        13350040
*                                    IC MUST BE CHANGED TO ICM.         13400040
         CS    R1,R0,TCBXSCT         IF ACTIV/S3A FLAGS ARE OFF,        13450040
*                                    SET THEM AND CCPVI.                13500040
         BNE   GETLOCK               INTERFACE FLAGS MAY BE ON,  SO     13550040
*                                    CHECK IF TCB IS IN USE.            13600040
         SPACE 2                                                        13650040
*        IF SUSPEND COUNT IS NOT ZERO, DECREMENT IT VIA CS              13700040
         SPACE                                                          13720040
         L     R0,RBSCF              GET COUNT AND LINK FIELD           13750040
RESU002  LR    R1,R0                 COPY REGISTER FOR CS               13800040
         LA    R1,0(R1)              ZERO COUNT IN ONE REGISTER         13850040
         CR    R1,R0                 IS COUNT ZERO?                     13900040
         BE    RESU005               YES, EXIT FROM RESUME              13950040
         LR    R1,R0                 RECOPY REGISTER                    14000040
         SL    R1,HIBYTE1            SUBTRACT 1 FROM HIGH BYTE          14050040
         CS    R0,R1,RBSCF           REPLACE COUNT                      14100040
         BNE   RESU002               RETRY IF FIELD CHANGES             14150040
         SPACE 2                                                        14200040
*        IF THE RESUME IS FOR THE TOP RB, CHECK THE DISPATCHABILITY     14250040
*        OF THIS UNIT OF WORK TO SEE IF ASCBTCBS MUST BE INCREMENTED    14300040
         SPACE                                                          14320040
RESU003  C     R5,TCBRBP             IS RB THE CURRENT RB?              14350040
         BNE   RESU005               NO, EXIT FROM RESUME               14400040
         LH    R1,TCBFLGS4           TEST TCB                           14450040
         LTR   R1,R1                    DISPATCHABILITY FLAGS           14500040
         BNZ   RESU011A              EXIT; NOT DISPATCHABLE             14550040
         CLI   RBWCF,X'00'           IS RB WAITING/SUSPENDED            14600040
         BNE   RESU011A              YES, EXIT RESUME                   14650040
         L     R13,PSAAOLD           GET CURRENT ASCB                   14700040
         USING ASCB,R13                                                 14750040
         TM    ASCBFLG1,ASCBSTND     ASCB DISPATCHABLE?                 14800040
         BO    RESU011A              NO, EXIT FROM RESUME               14850040
         L     R1,ASCBTCBS           GET COUNT OF READY TCBS            14900040
RESU004  LA    R0,1(R1)              ADD 1 TO COUNT IN 2ND REGISTER     14950040
         CS    R1,R0,ASCBTCBS        REPLACE OLD COUNT                  15000040
         BNE   RESU004               REPEAT IF CS FAILS                 15050040
         SPACE                                                          15100040
RESU005  LTR   R14,R14               RETURN TO CALLER?                  15150040
         BZ    RESU006               NO RETURN REQUESTED                15200040
         NI    TCBXSCT1,X'FF'-(TCBACTIV+TCBS3A) TURN OFF INTERSECT      15250040
*                                    FLAGS. CS IS NOT NEEDED SINCE THE  15300040
*                                    FLAGS CANNOT BE CHANGED BY ANYONE  15350040
*                                    WHILE WE HAVE THEM ON              15400040
         EX    R0,PSAIPCR            RESTORE CALLER'S STATE    @ZA11584 15410040
         BR    R14                   RETURN TO CALLER                   15450040
         DROP  R13                                                      15470040
         EJECT                                                          15500040
*        RETURN=NO WAS REQUESTED ON RESUME MACRO. THIS IS ONLY          15550040
*        ALLOWED FOR SRB MODE ISSUERS. IF NOT IN SRB MODE,              15600040
*        THE CALLER IS ABENDED.                                         15650040
         SPACE                                                          15700040
RESU006  L     R7,PSALCCAV           GET @LCCA                 @ZA11584 15720040
         USING LCCA,R7                                                  15800040
         TM    LCCADSF2,LCCASRBM     SRB MODE?                          15850040
         BNO   RESU0062              NO, ABEND CALLER                   15900040
         SPACE                                                          15950040
*        CALLER IS IN SRB MODE. SET UP TO ENTER THE TCTL FUNCTION       16000040
*        IN BEHALF OF THE RESUMED TCB.                                  16050040
         SPACE                                                          16070040
         L     R1,PSASSTK            PLACE SUPER STACK                  16300040
         ST    R1,PSACSTK               IN CURRENT FRR STACK            16350040
         OI    PSASUP1,PSADISP+PSATCTL  TURN ON FRR FLAGS               16400040
         L     R10,PSACDAL           GET COMMON DISPATCHER ACTIVE LIST  16450040
         USING CDAL,R10                                                 16500040
         OI    CDALDSP4,CDALTCTL     INDICATE TO  STATUS THAT  A        16600040
*                                    DISPATCHER(TCTL) IS  ACTIVE FOR    16650040
*                                    THIS MEMORY                        16700040
         L     R8,PSAAOLD            PICK UP ASCB ADDRESS               16720040
         USING ASCB,R8                                                  16750040
         TM    ASCBSRQ1,ASCBSTA      IS STATUS RUNNING?                 16800040
         BNO   TCTL002               NO, GO  TO TCTL                    16850040
         B     TCTL003               EXIT SRB THRU TCTL                 16950040
         DROP  R7,R8,R10                                                16970040
         EJECT                                                          17000040
*        NON-SRB MODE USER ISSUED RESUME WITH RETURN=NO                 17050040
         SPACE                                                          17070040
RESU0062 NI    TCBXSCT1,X'FF'-(TCBACTIV+TCBS3A) TURN OFF FLAGS          17100040
RESABEND STOSM  TCTLPSMK,ENABLE      ENABLE                    @ZM43116 17170040
         LA    R15,4                 CODE FOR ABOVE ERROR      @ZM43116 17180040
         ABEND  X'070',DUMP,,SYSTEM                                     17200040
         EJECT                                                          17250040
*        IF THE DISPATCHER OR STAGE 3 INTERSECT FLAG WAS ON             17300040
*        (TCBACTIV,TCBS3A) THE LOCAL LOCK MUST BE ACQUIRED TO           17350040
*        SYNCHRONIZE THE RESUME FUNCTION. THE TCB FLAGS THEMSELVES      17400040
*        ARE TESTED TO SEE IF THEY CAUSED THE CS TO FAIL. THIS          17450040
*        WAY, IF THEY GET TURNED OFF BEFORE THE FOLLOWING TEST,         17500040
*        THE CS IS RETRIED RATHER THAN THE LOCAL LOCK ACQUIRED.         17550040
         SPACE                                                          17570040
GETLOCK  TM    TCBXSCT1,TCBACTIV+TCBS3A  ARE FLAGS ON?                  17600040
         BZ    RESU001               NO,RETRY THE CS                    17650040
         LR    R0,R14                SAVE RETURN REGISTER               17660040
         LA    R13,4                 SET UP LOCKHELD CODE IN CASE WE    17666040
*                                    SKIP THE SETLOCK                   17672040
         C     R4,PSATOLD            ARE WE THE ACTIVE TCB? IN OTHER    17678040
*                                    WORDS, DID CALLER RESUME HIMSELF   17684040
         BE    RESU007A              YES, SKIP SETLOCK                  17690040
*                                                                       17692040
*        IT IS NO LONGER NECESSARY TO SAVE PSAIPCR+1           @ZA31944 17695040
*        BECAUSE PSAIPCR+1 WILL BE RESET TO X'03' AFTER THE    @ZA31944 17695540
*        LOCAL LOCK IS RELEASED.                               @ZA31944 17696040
         STOSM TCTLPSMK,ENABLE       ENABLE FOR SETLOCK OBTAIN @ZA25947 17697040
SETLOCK1 SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        X17700040
               RELATED=(SETLOCK2,SETLOCK3,'GET LOCAL LOCK')             17750040
         SPACE                                                          17770040
*        REGISTER 13 NOW CONTAINS A 0 IF WE OBTAINED THE LOCK; OR       17800040
*        A 4 IF THE LOCK WAS OWNED BY THE CALLER. ONCE THE LOCK IS      17850040
*        ACQUIRED, SUSPEND COUNT MAY BE DECREMENTED.                    17900040
         SPACE 2                                                        17950040
         STNSM TCTLPSMK,DISABLE      DISABLE AGAIN AFTER LOCK  @ZA25947 17958040
*                                    IS OBTAINED               @ZA25947 17966040
         SPACE 1                                               @ZA25947 17990040
*        IF SUSPEND COUNT IS NOT ZERO, DECREMENT IT VIA CS              18000040
         SPACE                                                          18020040
RESU007A L     R14,RBSCF             GET COUNT AND LINK FIELD           18050040
RESU007  LR    R1,R14                COPY REGISTER FOR CS               18080040
         LA    R1,0(R1)              ZERO COUNT IN ONE REGISTER         18150040
         CR    R1,R14                IS COUNT ZERO?                     18200040
         BE    RESU010               YES, EXIT FROM RESUME              18250040
         LR    R1,R14                RECOPY REGISTER                    18300040
         SL    R1,HIBYTE1            SUBTRACT 1 FROM HIGH BYTE          18350040
         CS    R14,R1,RBSCF          REPLACE COUNT                      18400040
         BNE   RESU007               RETRY IF FIELD CHANGES             18450040
         SPACE                                                          18470040
*        TRY AGAIN  TO  TURN ON INTERSECT FLAGS                         18500040
         SPACE                                                          18520040
RESU008  L     R1,TCBXSCT            LOAD INTERSECT FLAGS               18550040
         N     R1,MASK1              TURN OFF ACTIV/S3A FLAGS IN REG    18600040
         LR    R14,R1                COPY REG FOR CS                    18650040
         O     R14,MASK2             TURN ON ACTIV/S3A FLAGS IN REG     18680040
         IC    R14,PSACPULA+1        INSERT CPUID INTO REG              18710040
*                                    ONLY LOW BYTE HAS VALUE, SO        18800040
*                                    IC MAY BE USED; IF VALUE IS        18850040
*                                    EVER EXPANDED TO TWO BYTES,        18900040
*                                    IC MUST BE CHANGED TO ICM.         18950040
         CS    R1,R14,TCBXSCT        IF ACTIV/S3A FLAGS ARE OFF,        19000040
*                                    SET THEM AND CCPVI.                19050040
         BNE   RESU012               INTERFACE FLAGS ON, EXIT           19100040
         SPACE 2                                                        19150040
*        WE SUCCEEDED IN TURNING ON THE INTERSECT FLAGS WHILE           19200040
*        HOLDING THE LOCAL LOCK. WE CAN NOW RELEASE THE LOCAL LOCK      19250040
*        AND CONTINUE WITH NORMAL PROCESSING.                           19300040
         SPACE                                                          19320040
         LTR   R13,R13               DID CALLER HOLD LOCK?              19350040
         BNZ   RESU008A              YES, GO RESTORE RETURN ADDR        19400040
SETLOCK2 SETLOCK  RELEASE,TYPE=LOCAL,RELATED=(SETLOCK1,'RELEASE LOCK')  19450040
*                                                                       19450540
*        IT IS NECESSARY TO RESET THE SYSTEM MASK AT PASIPCR+1 @ZA31944 19451040
*        BECAUSE IT MAY HAVE BEEN OVERLAID WHEN THE LOCK WAS   @ZA31944 19452040
*        RELEASED. FOR EXAMPLE, IN SU 7, IEAVELK MAY INVOKE    @ZA31944 19453040
*        IEAVEMS0 WHICH MAY INVOKE IEAVERP WHICH WILL SAVE THE @ZA31944 19454040
*        CURRENT (DISABLED) SYSTEM MASK AT PSAIPCR+1.          @ZA31944 19455040
*                                                                       19456040
*        UNLESS OTHER CODE CHANGES WERE MADE, IT WOULD NOT BE  @ZA31944 19456840
*        CORRECT TO SAVE AND RESTORE PSAIPCR+1 OR TO DO AN OI. @ZA31944 19457640
*        THIS MIGHT                                            @ZA31944 19458440
*        CAUSE VALID CHANGES TO THE SYSTEM MASK TO BE LOST.    @ZA31944 19459240
*        THE MVI IS VALID BECAUSE INITIALLY IEAVETCL           @ZA31944 19460040
*        DISABLED THE SYSTEM MASK. WHEN STOSM IS ISSUED AT     @ZA31944 19460840
*        EXIT FROM IEAVETCL WITH A MASK OF 3,                  @ZA31944 19461640
*        THE SYSTEM MASK WILL THEN BE RESTORED TO BEING        @ZA31944 19462440
*        ENABLED BUT WILL NOT OTHERWISE BE ALTERED.            @ZA31944 19463240
*        (IT IS DOCUMENTED THAT IF RESUME MAY REQUIRE THE      @ZA31944 19464040
*        LOCAL LOCK, THE CALLER MUST BE ENABLED.)              @ZA31944 19464840
*                                                                       19465640
*        NOTE THAT THE MASK AT PSAIPCR+1 MUST BE RESTORED AT   @ZA31944 19465840
*        BOTH PLACES AT WHICH THE LOCAL LOCK IS RELEASED.      @ZA31944 19466040
*                                                                       19466240
         MVI   PSAIPCR+C1,ENABLE                               @ZA31944 19466440
         SPACE                                                          19467240
RESU008A LR    R14,R0                RESTORE RETURN ADDRESS             19470040
         B     RESU003               BACK TO MAINLINE                   19500040
         EJECT                                                          19550040
*        WE FAILED TO TURN ON THE INTERSECT FLAGS, EVEN UNDER THE       19600040
*        LOCAL LOCK. WE MUST NOW DO SOME CLEANUP AND EXIT.              19650040
*        IF THE RB BEING RESUMED IS THE TOP RB, AND WE COULD NOT        19700040
*        TURN ON THE ACTIV FLAG, THIS MEANS THAT THE RB ISSUED          19750040
*        A SUSPEND, BUT IS STILL RUNNING. IN THIS CASE, RESUME          19800040
*        MUST INCREMENT THE TCB READY COUNT.                            19850040
         SPACE 2                                                        19900040
RESU012  C     R5,TCBRBP             IS RB THE CURRENT RB?              19950040
         BNE   RESU010               NO, DONT INCREMENT TCB COUNT       20000040
         L     R11,PSAAOLD           GET ASCB ADDRESS                   20010040
         USING ASCB,R11                                                 20020040
         L     R1,ASCBTCBS           GET COUNT OF READY TCBS            20050040
RESU009  LA    R14,1(R1)             ADD 1 TO COUNT IN 2ND REGISTER     20100040
         CS    R1,R14,ASCBTCBS       REPLACE OLD COUNT                  20130040
         BNE   RESU009               REPEAT IF CS FAILS                 20200040
         DROP  R11                                                      20220040
         SPACE                                                          20250040
RESU010  LTR   R13,R13               DID CALLER HOLD LOCK?              20300040
         BNZ   RESU011               YES, GO TO MAINLINE                20350040
SETLOCK3 SETLOCK  RELEASE,TYPE=LOCAL,RELATED=(SETLOCK1,'RELEASE LOCK')  20400040
         SPACE                                                          20405040
         MVI   PSAIPCR+C1,ENABLE     RESET MASK FOR STOSM     @ZA31944  20406040
         SPACE                                                          20407040
RESU011  EX    R0,PSAIPCR            RESTORE CALLER MODE      @ZA11584  20410040
         LTR   R14,R0                RETURN TO CALLER? & RESTORE R14    20420040
         BNZR  R14                   YES                                20500040
         SPACE 2                                                        20550040
*        RETURN=NO WAS REQUESTED ON RESUME MACRO. THIS IS ONLY          20600040
*        ALLOWED FOR SRB MODE ISSUERS. IF NOT IN SRB MODE,              20650040
*        THE CALLER IS ABENDED.                                         20700040
         SPACE                                                          20750040
         STNSM TCTLPSMK,DISABLE      DISABLE                  @ZM43116  20755040
RESU013  L     R13,PSALCCAV          GET @LCCA                @ZA11584  20760040
         USING LCCA,R13                                                 20850040
         TM    LCCADSF2,LCCASRBM     SRB MODE?                          20900040
         BNO   RESABEND              NO, ABEND CALLER                   20950040
         SPACE                                                          21000040
*        CALLER IS IN SRB MODE. SET UP TO ENTER NORMAL SRB EXIT         21050040
         SPACE                                                          21070040
         L     R14,FLCCVT            GET CVT ADDRESS                    21100040
         USING CVT,R14                                                  21150040
         L     R14,CVTSRBRT          GET SRB EXIT ADDRESS               21200040
         BR    R14                   GO TO SRB EXIT                     21250040
         SPACE 2                                                        21252040
*        UNIT OF WORK WAS FOUND TO BE NON-DISPATCHABLE                  21254040
         SPACE                                                          21255040
RESU011A NI    TCBXSCT1,X'FF'-(TCBACTIV+TCBS3A) TURN OFF INTERSECT FLGS 21256040
         LTR   R14,R14               RETURN TO CALLER?                  21258040
         BZ    RESU013               NO, CONTINUE              @ZA11584 21259040
         EX    R0,PSAIPCR            RESTORE CALLER MODE       @ZA11584 21259540
         BR    R14                   RETURN TO THE CALLER               21260040
         DROP  R4,R5,R13,R14                                            21270040
         TITLE 'TCTL PROCESSOR'                                         21350040
         ENTRY IEAVTCTL                                                 21400040
IEAVTCTL DS    0H                    TCTL ENTRY                         21450040
         SPACE                                                          21470040
*        THIS ROUTINE IS ENTERED BY THE TCTL MACRO TO PASS CONTROL      21500040
*        FROM AN SRB DIRECTLY TO A TCB. IT IS ALSO ENTERED AT           21550040
*        AN INTERNAL ENTRY POINT BY THE RESUME FUNCTION FOR THE         21600040
*        SAME PURPOSE.                                                  21650040
         SPACE 2                                                        21700040
         MODESET  EXTKEY=ZERO        SET UP ZERO PROTECT KEY  @ZM43116  21710040
         USING TCB,R4                REG 4 HAS TCB ON ENTRY             21750040
         USING IEAVTCTL,R15                                             21800040
         STNSM TCTLPSMK,DISABLE      DISABLE FOR INTERRUPTS   @ZM43116  21820040
         L     R15,COMMADDR          SET UP COMMON ADDRESSABILITY       21850040
         USING IEAVRSME,R15                                             21870040
         L     R7,PSALCCAV           GET @LCCA                          21900040
         USING LCCA,R7                                                  21950040
         TM    LCCADSF2,LCCASRBM     SRB MODE?                          22000040
         BNO   TCTABEND              NO, ABEND CALLER                   22050040
         SPACE                                                          22100040
*        CALLER IS IN SRB MODE. SET UP TO   DO  THE TCTL FUNCTION       22150040
*        IN BEHALF OF THE REQUESTED TCB.                                22200040
         SPACE                                                          22220040
         L     R1,PSASSTK            PLACE SUPER STACK                  22350040
         ST    R1,PSACSTK               IN CURRENT FRR STACK            22400040
         OI    PSASUP1,PSADISP+PSATCTL  TURN ON FRR FLAGS               22450040
         L     R10,PSACDAL           GET COMMON DISPATCHER ACTIVE LIST  22500040
         USING CDAL,R10                                                 22550040
         OI    CDALDSP4,CDALTCTL     INDICATE TO  STATUS THAT  A        22650040
*                                    DISPATCHER(TCTL) IS  ACTIVE FOR    22700040
*                                    THIS MEMORY                        22750040
*        REGS 8 AND 10 ARE NOW SET UP FOR LATER DISPATCHER INTERFACE.   22800040
         SPACE                                                          22820040
         L     R8,PSAAOLD            PICK UP ASCB ADDRESS               22830040
         USING ASCB,R8                                                  22850040
         TM    ASCBSRQ1,ASCBSTA      IS STATUS RUNNING?                 22900040
         BO    TCTL003A              YES, EXIT  TCTL           @ZA11584 22920040
TCTL001  L     R1,TCBXSCT            LOAD INTERSECT FLAGS               23100040
         N     R1,MASK1              TURN OFF ACTIV/S3A FLAGS IN REG    23150040
         LR    R0,R1                 COPY REG FOR CS                    23200040
         O     R0,MASK2              TURN ON ACTIV/S3A FLAGS IN REG     23250040
         IC    R0,PSACPULA+1         INSERT CPUID INTO REG              23300040
*                                    ONLY LOW BYTE HAS VALUE, SO        23350040
*                                    IC MAY BE USED; IF VALUE IS        23400040
*                                    EVER EXPANDED TO TWO BYTES,        23450040
*                                    IC MUST BE CHANGED TO ICM.         23500040
         CS    R1,R0,TCBXSCT         IF ACTIV/S3A FLAGS ARE OFF,        23550040
*                                    SET THEM AND CCPVI.                23600040
         BNE   TCTL006               INTERFACE FLAGS MAY BE ON,  SO     23650040
*                                    CHECK IF TCB IS IN USE.            23700040
         DROP  R4                                                       23870040
         SPACE 2                                                        23900040
TCTL002  LR    R6,R4                 MOVE @TCB FOR DISPATCHER           23910040
         USING TCB,R6                                                   23920040
         LH    R1,TCBFLGS4           TEST TCB                           23950040
         LTR   R1,R1                    DISPATCHABILITY FLAGS           24000040
         BNZ   TCTL003               EXIT; NOT DISPATCHABLE             24050040
         LH    R1,TCBAFFN            TCBS AFFINITY MASK        @ZA16831 24052040
         C     R1,CPUAFFN            TEST TCB AFFINITY         @ZA16831 24054040
         BE    TESTRB                NONE, GO TEST RBWCF       @ZA16831 24056040
         LTR   R1,R1                 TEST TCB AFFINITY         @ZA16831 24058040
         BZ    TESTRB                NONE, GO TEST RBWCF       @ZA16831 24060040
         SPACE 1                                                        24062040
*        TCB HAS PROCESSOR AFFINITY. CANNOT TCTL TO TCB        @ZA16831 24064040
*        IF AFFINITY IS TO ANOTHER PROCESSOR.                  @ZA16831 24066040
         SPACE 1                                                        24068040
         L     R2,PSAPCCAV           GET PCCA ADDRESS          @ZA16831 24070040
         USING PCCA,R2               PCCA ADDRESSABILITY       @ZA16831 24072040
         LH    R2,PCCACAFM           GET CPUS AFFINITY MASK    @ZA16831 24074040
         DROP  R2                    DROP PCCA ADDRESSABILITY  @ZA16831 24076040
         NR    R1,R2                 TEST PROCESSOR AFFINITY   @ZA16831 24078040
         BZ    TCTL003               AFFINITY TO OTHER CPU,EXIT@ZA16831 24080040
TESTRB   DS    0H                    CONTINUE DISP TESTS       @ZA16831 24082040
         L     R5,TCBRBP             GET CURRENT RB                     24100040
         USING RBSECT,R5                                                24130040
         CLI   RBWCF,X'00'           IS RB WAITING/SUSPENDED            24200040
         BNE   TCTL003               YES, EXIT TCTL                     24250040
         TM    ASCBFLG1,ASCBSTND     ASCB DISPATCHABLE?                 24300040
         BO    TCTL003               NO, EXIT FROM TCTL                 24350040
         SPACE 2                                                        24400040
*        THE FOLLOWING CODE DUPLICATES THE SRB EXIT CODE IN THE         24450040
*        DISPATCHER. THE JOB STEP TIMING ROUTINE IS INVOKED. THIS       24500040
*        ROUTINE REQUIRES THE FOLLOWING INPUT:                          24550040
*        REG 7  = @LCCA                                                 24600040
*        REG 8  = @ASCB                                                 24650040
*        REG 14 = RETURN @                                              24700040
*        REGS 0-3 ARE USED AS WORK REGS                                 24750040
*        REG 9 IS SET UP WITH THE COMMON DISPATCHER BASE ADDRESS.       24770040
*        THIS ADDRESS IS USED AS INPUT TO THE FINAL EXIT TO THE         24850040
*        DISPATCHER.                                                    24900040
         SPACE                                                          24950040
         L     R14,DISPJST           GET @ JOB STEP TIME ROUTINE        25000040
         BALR  R14,R14               CALL IT                            25050040
         NI    LCCADSF2,X'FF'-(LCCASRBM+LCCAGSRB)                       25070040
*                                    RESET SRB MODE FLAG       @ZA11326 25100040
*        THE DISPATCHER LOCK IS GOTTEN HERE TO PROTECT AGAINST          25105040
*        DISPATCHER INTERFERENCE WHILE UPDATING ASCBSRBS. IF CS IS      25110040
*        EVER USED BY DISPATCHER TO UPDATE ASCBSRBS, THE LOCK HERE      25115040
*        MAY BE REPLACED BY CS.                                         25120040
*        THE DISPATCHER LOCK ALSO SERIALIZES PSAANEW WHICH     @ZA16832 25121040
*        MUST BE UPDATED TO EQUAL PSAAOLD IF AOLDS POSITION    @ZA16832 25122040
*        ON THE DISPATCHING QUEUE IS HIGHER THAN ANEWS.        @ZA16832 25123040
         SPACE                                                          25125040
SET1     DS    0H                    RELATED= LABEL                     25130040
*        SETLOCK OBTAIN,TYPE=DISP,MODE=UNCOND,                        - 25132040
*              RELATED=('ASCBSRBS,PSAANEW',SET2)               @ZA16832 25135040
         L     R13,AGSLDISP          LOCK MGR SPECIAL DISP ENTRY        25140040
         BALR  R14,R13               GO GET LOCK                        25145040
         LH    R1,ASCBSRBS           GET COUNT OF SRBS                  25150040
         BCTR  R1,0                  DECREMENT IT BY ONE                25250040
         STH   R1,ASCBSRBS           REPLACE OLD COUNT                  25300040
         L     R1,PSAANEW            GET PSAANEW               @ZA16832 25301040
         LTR   R1,R1                 TEST FOR MEMORY SWITCH    @ZA16832 25301340
         BZ    SET2                  INDICATED, NO ANEW UPDATE @ZA16832 25301640
         CLC   ASCBSEQN(L2),ASCBSEQN-ASCB(R1) TEST SEQ NUMBERS @ZA16832 25302040
         BNL   SET2                  AOLDS SEQN NOT GREATER,   @ZA16832 25303040
*                                    THEN DO NOT UPDATE ANEW   @ZA16832 25304040
         ST    R8,PSAANEW            UPDATE ANEW TO HIGHER ASCB@ZA16832 25305040
SET2     DS    0H                    RELATED= LABEL                     25306040
*        SETLOCK RELEASE,TYPE=DISP,RELATED=(SET1)                       25312040
         L     R11,DSDISPLK          ADDR OF DISPATCER LOCKWORD         25318040
         SLR   R13,R13               CLEAR A REGISTER                   25324040
         ST    R13,0(R11)            CLEAR LOCKWORD                     25330040
         NI    PSAHLHI+2,DISPOFF     TURN OFF DISP LOCK HELD FLAG       25336040
         SPACE                                                          25620040
*        TCB IS NOW READY TO BE DISPATCHED. TCBACTIV IS        @ZA18126 25630040
*        SUFFICIENT SERIALIZATION FOR THE TASK.                @ZA18126 25650040
         SPACE                                                          25700040
         NI    TCBXSCT1,X'FF'-TCBS3A TURN OFF S3A INTERSECT    @ZA18126 25720040
*                                    FLAG. ACTIV WILL NOW      @ZA18126 25750040
*                                    PREVENT INTERSECT.        @ZA18126 25760040
         L     R15,DISPTCB           ADDRESS OF DISPATCH-TCB ROUTINE    25800040
         BR    R15                   EXIT TO DISPATCH THE TCB  @ZA16831 25820040
         SPACE                                                          25870040
*        NOTE: CDAL IS CLEARED IN DISPATCHER AFTER ASCBCPUS    @ZA18126 25900040
*        IS INCREMENTED. THIS SEQUENCE IS REQUIRED TO PREVENT  @ZA18126 25930040
*        IMPROPER INTERSECT WITH STATUS.                       @ZA18126 25960040
         SPACE 1                                               @ZA18126 25990040
         DROP  R6                                                       26020040
         EJECT                                                          26050040
*        THIS CODE IS ENTERED IF THE CS OF THE INTERSECT FLAGS FAILS.   26100040
*        THE FLAGS ARE RETESTED, AND IF OFF, THS CS IS RETRIED          26150040
         SPACE                                                          26160040
         USING TCB,R4                                                   26170040
TCTL006  TM    TCBXSCT1,TCBACTIV+TCBS3A  ARE FLAGS ON?                  26200040
         BZ    TCTL001               NO, RETRY CS                       26250040
         SPACE                                                          26270040
*        THE FOLLOWING CODE EXITS TO THE NORMAL SRB EXIT, IF THE        26300040
*        REQUESTED TCB CANNOT BE DISPATCHED.                            26350040
         SPACE                                                          26400040
TCTL003A DS    0H                    CLEAR THE                          26450040
         NI    CDALDSP4,X'FF'-CDALTCTL       CDALTCTL FLAG              26480040
         NI    PSASUP1,X'FF'-(PSADISP+PSATCTL)  TURN OFF FRR FLAGS      26550040
         L     R1,PSANSTK            GET NORMAL STACK                   26600040
         ST    R1,PSACSTK            SET CURRENT TO NORMAL              26650040
         STOSM TCTLPSMK,ENABLE       ENABLE                    @ZA25947 26700040
         L     R15,FLCCVT            GET CVT ADDRESS                    26750040
         USING CVT,R15                                                  26800040
         L     R15,CVTSRBRT          GET NORMAL SRB EXIT ADDRESS        26850040
         BR    R15                   EXIT                               26900040
         DROP  R15                                                      26908040
         USING IEAVRSME,R15                                             26916040
TCTL003  NI    TCBXSCT1,X'FF'-(TCBACTIV+TCBS3A) TURN OFF       @ZA18126 26920040
*                                    INTERSECT FLAGS           @ZA18126 26924040
         B     TCTL003A              CONTINUE EXIT                      26932040
         SPACE 2                                                        26940040
*        ABEND THE NON-SRB MODE CALLER OF TCTL                          26950040
         SPACE                                                          26970040
TCTABEND STOSM  TCTLPSMK,ENABLE      ENABLE                    @ZM43116 27020040
         LA    R15,4                 CODE FOR ABOVE ERROR      @ZM43116 27030040
         ABEND  X'070',DUMP,,SYSTEM  ISSUE ABEND                        27050040
         EJECT                                                          27100040
*        CONSTANTS, ADCONS, VCONS, EQUATES                              27150040
         SPACE 2                                                        27200040
DISPJST  DC    V(DSJSTCSR)           JOB STEP TIME ROUTINE              27250040
DSDISPLK DC    V(DISPLOCK)           DISP LOCKWORD ADDRESS              27300040
AGSLDISP DC    V(GSLSDISP)           ENTRY FOR DISP LOCK OBTAIN         27310040
DISPTCB  DC    V(IEAVDSTC)           DIRECTED DISPATCH OF TCB           27320040
COMMADDR DC    A(IEAVRSME)           COMMON BASE ADDRESS                27350040
HIBYTE1  DC    X'01000000'           MASK TO ADD 1 TO HIGH BYTE         27400040
CPUAFFN  DC    X'FFFFFFFF'           NO PROCESSOR AFFINITY     @ZA16831 27420040
*        MASKS TO TURN INTERSECT FLAGS ON AND OFF                       27450040
MASK1    DC    AL1(255-(TCBACTIV+TCBS3A)),X'FFFFFF'                     27500040
MASK2    DC    AL1(TCBACTIV+TCBS3A),X'000000'                           27550040
C1       EQU   1                     CONSTANT 1                @ZA11584 27576040
L2       EQU   2                     LENGTH OPERAND OF TWO     @ZA16832 27586040
ENABLE   EQU   X'03'                 MASK TO ENABLE                     27600040
DISABLE  EQU   X'FF'-ENABLE          MASK TO DISABLE                    27650040
DISPOFF  EQU   X'EF'                 MASK TO TURN OFF DISP LOCK FLAG    27700040
TCTLPSMK DC    X'00'                 STNSM AREA                @ZM43116 27710040
         TITLE 'IEAVETCL - ASCB'                               @ZA18162 27720040
         IHAASCB                                                        27725040
         TITLE 'IEAVETCL - CDAL'                               @ZA18162 27730040
         CDAL                                                           27735040
         TITLE 'IEAVETCL - CVT'                                @ZA18162 27740040
         CVT   DSECT=YES                                                27750040
         TITLE 'IEAVETCL - LCCA'                               @ZA18162 27758040
         IHALCCA                                                        27766040
         TITLE 'IEAVETCL - PCCA'                               @ZA18162 27774040
         IHAPCCA                                               @ZA16831 27782040
         TITLE 'IEAVETCL - PSA'                                @ZA18162 27790040
         IHAPSA                                                         27800040
         TITLE 'IEAVETCL - RP'                                 @ZA18162 27806040
         IHARB                                                          27812040
         TITLE 'IEAVETCL - TCB'                                @ZA18162 27820040
         IKJTCB                                                         27850040
         END                                                            28650040
