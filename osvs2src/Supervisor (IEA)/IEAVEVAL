         TITLE 'IEAVEVAL- VALIDITY CHECK ROUTINE'                       00050002
*/** START OF SPECIFICATIONS ****************************************** 00070002
*                                                                       00100002
*01*  MODULE NAME=                                                      00150002
*             IEAVEVAL                                                  00200002
*02*      CSECT NAME=                                                   00210002
*             IEAVEVAL                                                  00220002
*01*  DESCRIPTIVE NAME=                                                 00250002
*                  VALIDITY CHECK                                       00300002
*01*  COPYRIGHT=                                                        00350002
*           N/A                                                         00400002
*01*  STATUS=                                                           00450002
*        VS2-RELEASE2                                                   00500002
*01*  FUNCTION=                                                         00550002
*          VALIDITY CHECK VALIDATES AN ADDRESS OR ADDRESS RANGE BY      00600002
*          DETERMINING IF THE STORAGE KEY AND PROTECT KEY MATCH         00650002
*02*      OPERATION=                                                    00700002
*           VALIDITY CHECK MUST BE ENTERED WITH THE LOCAL LOCK.         00750002
*           REGISTERS ARE SAVED IN A SUPERVISOR SAVE AREA FOR THE       00800002
*           MEMORY. THE INTEGRITY OF THIS SAVE AREA IS MAINTAINED BY    00850002
*           THE LOCAL LOCK.                                             00900002
*                                                                       00950002
*           VALIDITY CHECK SWITCHES TO THE TCBPKF KEY AND THEN FETCHES  01000002
*           AND STORES INTO THAT PAGE. AN INVALID FETCH OR STORE WILL   01050002
*           BE HANDLED BY THE FRR ROUTINE.                              01100002
*                                                                       01150002
*           IF A RANGE IS SPECIFIED, EACH PAGE WITHIN THAT RANGE WILL   01200002
*           HAVE ITS STORAGE KEY CHECKED AGAINST THE TCB PROTECT KEY    01250002
*           A ZERO CONDITION CODE IS SET FOR A VALID ADDRESS OR RANGE   01300002
*           OF ADDRESSES AND A NON ZERO CONDITION CODE FOR ANY INVALID  01350002
*           SITUATION ENCOUNTERED                                       01400002
*01*  NOTES:                                                            01450002
*02*      DEPENDENCIES=                                                 01700002
*                    1= A PREALLOCATED SAVE AREA, ADDRESSABLE THROUGH   01750002
*                       THE ASXB                                        01800002
*                    2- BOTH 2K SEGMENTS OF A PAGE HAVE SAME STORAGE    01850002
*                       PROTECT KEY                                     01900002
*                    3- CONTROL BLOCKS AND MAPPING MACROS               01950002
*                         TCB                                           02000002
*03*          CHARACTER CODE DEPENDENCIES=                              02010002
*                                   MODULE MUST BE REASSEMBLED IF ANY   02020002
*                                   CHARACTER CODE OTHER THAN EBCDIC    02030002
*                                   IS USED                             02040002
*02*      RESTRICTIONS=                                                 02050002
*                    NONE                                               02100002
*02*      REGISTER CONVENTIONS=                                         02150002
*                            R1= STARTING ADDRESS                       02200002
*                            R2= ENDING ADDRESS                         02250002
*                            R4= TCB ADDRESS                            02300002
*                            R13= SAVE AREA ADDRESS                     02350002
*                            R14= RETURN ADDRESS                        02400002
*                            R15= ENTRY POINT ADDRESS                   02450002
*02*      PATCH LABEL=                                                  02500002
*                   PATCH                                               02550002
*01*  MODULE TYPE=                                                      02600002
*             CSECT                                                     02650002
*02*      PROCESSOR=                                                    02700002
*                 ASSEMBLER                                             02750002
*02*      MODULE SIZE=                                                  02800002
*                   N/A                                                 02850002
*02*      ATTRIBUTES=                                                   02900002
*                  NUCLEUS, ZERO PSW PROTECT KEY, REENTRANT,            02950002
*                  SUPERVISOR MODE                                      03000002
*                                                                       03050002
*01*  ENTRY POINT=                                                      03100002
*              IEA0VL00                                                 03150002
*02*      PURPOSE=                                                      03200002
*               IEA0VL00 WILL COMPARE THE TCB PROTECT KEY WITH THE      03250002
*               STORAGE PROTECT KEY OF THE ADDRESS PASSED TO THE        03300002
*               ROUTINE TO DETERMINE IF THEY MATCH. IF THE RANGE SPANS  03350002
*               A PAGE THE SAME TEST ON PROTECT KEYS IS MADE FOR EACH   03400002
*               PAGE SPANNED.                                           03450002
*02*      LINKAGE=                                                      03500002
*               BRANCH ENTERED- ADDRESS OF ENTRY POINT IN CVT0VL00      03550002
*02*      INPUT DATA=                                                   03600002
*                  R1= STARTING ADDRESS                                 03650002
*                  R2= ENDING ADDRESS OR ZERO IF NO RANGE SPECIFIED     03700002
*                  R4= TCB ADDRESS OR ZERO  CURRENT TCB WILL BE USED    03750002
*                      IF ZERO IS SPECIFIED                             03800002
*                  R14= RETURN ADDRESS                                  03850002
*02*      REGISTERS SAVED=                                              03900002
*                       R14-R12                                         03950002
*02*      REGISTER CONTENTS DURING PROCESSING=                          04000002
*                                          R1= STARTING ADDRESS         04050002
*                                          R2= ENDING ADDRESS           04100002
*                                          R4= TCB ADDRESS              04150002
*                                          R13= SAVE AREA ADDRESS       04200002
*                                          R14= RETURN ADDRESS          04250002
*02*      REGISTERS RESTORED=                                           04300002
*                          R14-R12                                      04350002
*01*  ENTRY POINT=                                                      04400002
*             IEA0VL01                                                  04450002
*02*      PURPOSE=                                                      04500002
*               IEA0VL01 WILL DETERMINE IF STARTING ADDRESS IS ON A     04550002
*               FULL WORD BOUNDARY AND THEN COMPARE TCB PROTECT KEY     04600002
*               WITH STORAGE PROTECT KEY OF THE ADDRESS PASSED  TO THE  04650002
*               ROUTINE TO DETERMINE IF THEY MATCH. IF THE RANGE SPANS  04700002
*               A PAGE THE SAME TEST ON PROTECT KEYS IS MADE FOR EACH   04750002
*               PAGE SPANNED.                                           04800002
*02*      LINKAGE=                                                      04850002
*               BRANCH ENTERED- ADDRESS OF ENTRY POINT IN CVT0VL01      04900002
*02*      INPUT DATA=                                                   04950002
*                  R1= STARTING ADDRESS                                 05000002
*                  R2= ENDING ADDRESS OR ZERO IF NO RANGE SPECIFIED     05050002
*                  R4= TCB ADDRESS OR ZERO. CURRENT TCB WILL BE USED    05100002
*                      IF ZERO IS SPECIFIED                             05150002
*                  R14= RETURN ADDRESS                                  05200002
*02*      REGISTERS SAVED=                                              05250002
*                       R14-R12                                         05300002
*02*      REGISTER CONTENTS DURING PROCESSING=                          05350002
*                                           R1= STARTING ADDRESS        05400002
*                                           R2= ENDING ADDRESS          05450002
*                                           R4= TCB ADDRESS             05500002
*                                           R13= SAVE AREA ADDRESS      05550002
*                                           R14= RETURN ADDRESS         05600002
*02*      REGISTERS RESTORED=                                           05650002
*                          R14-R12                                      05700002
*01*  EXIT- NORMAL=                                                     05750002
*              CALLER                                                   05800002
*02*      CONDITIONS=                                                   05820002
*                   TCB PROTECT KEY MATCHED STORAGE PROTECT KEY FOR     05850002
*                   ALL PAGES WITHIN RANGE AND STARTING ADDRESS WAS     05900002
*                   ON FULLWORD BOUNDARY IF ENTRY POINT WAS IEA0VL01    05950002
*02*      OUTPUT DATA=                                                  06000002
*                   R0-R3 UNCHANGED                                     06050002
*                   R4    TCB ADDRESS                                   06100002
*                   R5-R14 UNCHANGED                                    06150002
*                   R15   UNPREDICTABLE                                 06200002
*02*      RETURN CODES=                                                 06250002
*                    NONE                                               06300002
*                    CONDITION CODE SET TO ZERO                         06350002
*01*  EXIT- ERROR=                                                      06400002
*             CALLER                                                    06450002
*02*      CONDITIONS=                                                   06470002
*                   ADDRESS WAS INVALID BECAUSE TCB PROTECT KEY DID     06500002
*                   NOT MATCH STORAGE PROTECT KEY,   ADDRESS WAS IN     06550002
*                   AN UNASSIGNED PAGE, ADDRESS WAS IN AN INVALID       06600002
*                   SEGMENT, OR ERROR RETURN CODE FROM FINDPAGE         06650002
*02*      OUTPUT DATA=                                                  06700002
*                   R0-R3 UNCHANGED                                     06750002
*                   R4-   UNCHANGED IF TCB ADDRESS SPECIFIED OR IF      06800002
*                         ZERO SPECIFIED AND STARTING ADDRESS WAS       06850002
*                         NOT ON FULWORD BOUNDARY FOR IEAOVL01          06900002
*                         ENTRY POINT. OTHERWISE, CONTAINS ADDRESS OF   06950002
*                         CURRENT TCB                                   07000002
*                   R5-R14 UNCHANGED                                    07050002
*                   R15   UNPREDICTABLE                                 07100002
*02*      RETURN CODES=                                                 07150002
*                    NONE                                               07200002
*                    CONDITION CODE SET TO NONZERO                      07250002
*01*  EXTERNAL REFERENCES                                               07300002
*02*      ROUTINES=                                                     07350002
*                NONE                                                   07400002
*02*      DATA AREAS=                                                   07450002
*                  NONE                                                 07500002
*02*      CONTROL BLOCKS= C-CREATED, U-USED, D-DELETED, M- MODIFIED     07550002
*                                                                       07600002
*                       TCB  -U                                         07650002
*01*  TABLES=                                                           07700002
*               NONE                                                    07750002
*01*  MACROS=                                                           07800002
*              NONE                                                     07850002
*02*      SERIALIZATION=                                                07900002
*                  LOCAL LOCK                                           07950002
*01*  CHANGE LEVEL=                                                     08000002
*                    REPLACES ENTRY POINTS FOR VALIDITY CHECK IN        08050002
*                    IEAVNU00                                           08100002
*01*  MESSAGES=                                                         08150002
*          NONE                                                         08200002
*01*  ABEND CODES=                                                      08210002
*             NONE                                                      08220002
*01*  SYSGEN=                                                           08230002
*        LOAD MODULE= IEANUC01                                          08240002
*        MODULE NAME= IEAVEVAL                                          08242002
*                                                                       08250002
***** END OF SPECIFICATIONS ******************************************/ 08300002
         EJECT                                                          08302002
*/*IEAVEVAL: CHART VALIDITY CHECK */                                    08310002
*/* HEADER                                                              08320002
*/* SEC. 3.1.8.8.17                     VALIDITY CHECK FLOWCHART        08330002
*/*                                                    PAGE  # */       08340002
*/*IEAVL01: E TEST FOR FULLWORD BOUNDARY */                             08342002
*/* D (NO,,YES,VL00) ADDRESS ON FULLWORD BOUNDARY */                    08344002
*/* R RETURN TO CALLER- CC NE 0 */                                      08346002
*/*IEAVL00: E TEST FOR VALID ADDRESS */                                 08348002
*/*VL00: D (NO,,YES,VL001) TCB ADDRESS SPECIFIED */                     08348402
*/* P GET CURRENT TCB POINTER */                                        08348802
*/*VL001: P GET ADDRESS OF SAVE AREA */                                 08349202
*/* P SAVE CALLER'S REGISTERS */                                        08349602
*/* P ROUND STARTING ADDRESS DOWN TO WORD BDY */                        08349702
*/* P ROUND ENDING ADDRESS DOWN  TO WORD BDY */                         08349802
*/* D (YES,,NO,VL002) RANGE SPECIFIED */                                08349902
*/* P DETERMINE # OF PAGES IN RANGE */                                  08366602
*/*VL002: P ADD 1 TO NUMBER OF PAGES */                                 08376602
*/* L SETFRR- ADD FRR */                                                08378602
*/* L MODESET- SWITCH TO TCB KEY */                                     08380602
*/*VL003: P CS INTO PAGE */                                             08382602
*/* D (YES,,NO,VL003) CS SUCCESSFUL */                                  08383002
*/* P ROUND TO PAGE BOUNDARY */                                         08383102
*/* P ADD SIZE OF PAGE TO ADDRESS */                                    08383202
*/* D (YES,,NO,VL003) ALL PAGES CHECKED */                              08388802
*/* L MODESET- SWITCH BACK TO KEY 0 */                                  08390802
*/* L SETFRR- DELETE FRR */                                             08392802
*/* P INDICATE SUCCESS- CC=0 */                                         08393202
*/* R RETURN TO CALLER */                                               08393602
*/*VLCKFRR: CHART VALIDITY CHECK FRR */                                 08393702
*/* HEADER                                                              08393802
*/* SEC. 3.1.8.8.17                VALIDITY CHECK FRR                   08393902
*/*                                                       PAGE   #   */ 08403902
*/*VLCKFRR: E START OF FRR ROUTINE */                                   08413902
*/* P SET UP ADDRESSABILITY */                                          08415502
*/* P SET UP POINTER TO PARM AREA */                                    08415902
*/* D (YES,,NO,CONTERM) CAN RETRY BE DONE */                            08416302
*/* D (NO,,YES,CONTERM) RECURSIVE ABEND */                              08420002
*/* P SET RECURSIVE INDICATOR */                                        08422002
*/* D (YES,,NO,CONTERM) PROGRAM CHECK */                                08422402
*/* D (NO,,YES,RETRY) PROTECTION EXCEPTION */                           08422802
*/* D (NO,,YES,RETRY) ADDRESSING EXCEPTION */                           08423202
*/* D (NO,,YES,RETRY) SEGMENT TRANSLATION ERROR */                      08423602
*/* D (YES,,NO,CONTERM) PAGE TRANSLATION ERROR */                       08423702
*/*RETRY: P SET UP SAVE AREA ADDRESS IN SDWA */                         08423802
*/* L SETRP RETRY AT VALRETRY */                                        08427502
*/* R RETURN TO RTM */                                                  08429502
*/*CONTERM: P MOVE MODULE NAME TO SDWA */                               08429902
*/* P MOVE CSECT NAME TO SDWA */                                        08430302
*/* L SETRP CONTINUE WITH TERMINATION */                                08430702
*/* R RETURN TO RTM                                                     08431102
*/*VLCKFRR: END FRR CHART */                                            08431202
*/*VALRETRY: CHART RETRY ROUTINE */                                     08431302
*/* HEADER                                                              08435002
*/* SEC. 3.1.8.8.17           VALIDITY CHECK RETRY ROUTINE              08437402
*/*                                                    PAGE  #       */ 08437802
*/*VALRETRY: E START OF RETRY ROUTINE */                                08438202
*/* L MODESET SWITCH BACK TO KEY 0 */                                   08438602
*/* L SETFRR DELETE FRR */                                              08438702
*/* P SET CONDITION CODE TO NONZERO */                                  08438802
*/* P RESTORE REGISTERS */                                              08449002
*/* R RETURN TO CALLER */                                               08459002
*/*VALRETRY: END RETRY CHART */                                         08459102
*/*IEAVEVAL: END   END VALIDITY CHECK FLOWCHART       */                08469102
         EJECT                                                          08469402
         IKJTCB                                                         08479602
         EJECT                                                          08489802
         IHAWSAVT                                                       08500002
         EJECT                                                          08550002
         IHAASCB                                                        08600002
         EJECT                                                          08650002
         IHAASXB                                                        08700002
         EJECT                                                          08750002
         IHAPSA                                                         08800002
         EJECT                                                          08850002
         IHAFRRS                                                        08900002
         EJECT                                                          08902002
         IHASDWA                                                        08906002
         EJECT                                                          08912002
PARMFRR  DSECT                        FRR PARAMETER AREA                08918002
SAVEPTR  DS    F                      REGISTER 13 SAVE AREA             08924002
FLAGS    DS    B                      FLAG FIELD                        08930002
RECURSB  EQU   X'80'                  RECURSIVE INDICATOR               08936002
         EJECT                                                          08950002
IEAVEVAL CSECT                  VALIDITY CHECK                          09000002
* C 133000,134000 A 133600-133900                              @YM01958 09030002
         MODID BR=NO            MODULE IDENTIFIER                       09072802
         ENTRY IEA0VL00,IEA0VL01  PRIMARY ENTRY POINTS                  09086402
*********************************************************************** 09100002
*                                                                     * 09150002
*                             E Q U A T E S                           * 09200002
*                                                                     * 09250002
*********************************************************************** 09300002
ONE      EQU   1                CONSTANT 1                              09350002
DISPL0   EQU   0                DISPLACEMENT ZERO                       09400002
DISPL20  EQU   20               DISPLACEMENT 20                         09450002
NOTZERO  EQU   5                MASK AFTER TM IF NOT ZEROS              09500002
HEX00    EQU   0                CONSTANT 0                              09550002
PGBITS   EQU   12               DIVIDE BY SIZE OF PAGE                  09600002
R0       EQU   0                REGISTER 0                              09650002
R1       EQU   1                REGISTER 1                              09700002
R2       EQU   2                REGISTER 2                              09750002
R3       EQU   3                REGISTER 3                              09800002
R4       EQU   4                REGISTER 4                              09850002
R5       EQU   5                REGISTER 5                              09900002
R6       EQU   6                REGISTER 6                              09950002
R7       EQU   7                REGISTER 7                              10000002
R8       EQU   8                REGISTER 8                              10050002
R9       EQU   9                REGISTER 9                              10100002
R10      EQU   10               REGISTER 10                             10150002
R11      EQU   11               REGISTER 11                             10200002
R12      EQU   12               REGISTER 12                             10250002
R13      EQU   13               REGISTER 13                             10300002
R14      EQU   14               REGISTER 14                             10350002
R15      EQU   15               REGISTER 15                             10400002
         EJECT                                                          10450002
*********************************************************************** 10500002
*                                                                     * 10550002
*       ENTRY POINT -IEA0VL01  TEST FOR STARTING ADDRESS ON A FULLWORD* 10600002
*                    BOUNDARY THEN TEST PROTECT KEYS                  * 10650002
*                                                                     * 10700002
*********************************************************************** 10750002
IEA0VL01 DS    0H               ENTRY FOR FULL WORD BDY TEST            10800002
         USING *,R15            MODULE ADDRESSABILITY                   10850002
         USING TCB,R4           ADDRESSABILITY FOR TCB                  10900002
         USING FLC,0            ADDRESSABILITY FOR LOW CORE             10950002
*********************************************************************** 11000002
*        EXECUTE A TM USING THE LOW ORDER BYTE OF THE STARTING ADDRESS* 11050002
*        AS THE MASK AND A X'03' AS THE ARGUMENT BYTE                 * 11100002
*********************************************************************** 11150002
         EX    R1,VLWRDTST      STARTING ADDRESS ON FULLWORD BOUNDARY?* 11200002
         BCR   NOTZERO,R14      NO, EXIT BY R14  CC NE 0                11250002
         LA    R15,IEA0VL00     GET ADDRESS OF IEA0VL00                 11300002
         BR    R15              BRANCH TO VALIDATE ADDRESS              11350002
*********************************************************************** 11400002
*                        DATA FOR FULLWORD BOUNDARY TEST              * 11450002
*********************************************************************** 11500002
VLWRDTST TM    VLWORD,HEX00     TEST FOR FULL WORD BOUNDARY             11550002
VLWORD   DC    X'03'            MASK TO DETERMINE IF ADDRESS ON FULL    11600002
*                               WORD BOUNDARY                           11650002
        EJECT                                                           11670002
*********************************************************************** 11700002
*                                                                     * 11750002
*       ENTRY POINT- IEA0VL00  TEST FOR MATCH OF PROTECT KEYS FOR     * 11800002
*                    STARTING ADDRESS AND RANGE OF ADDRESSES          * 11850002
*                                                                     * 11900002
*********************************************************************** 11950002
IEA0VL00 DS    0H               ENTRY FOR MAIN FUNCTION                 12000002
         USING *,R15            MODULE ADDRESSABILITY                   12050002
        EJECT                                                           12070002
*********************************************************************** 12100002
*       DETERMINE IF TCB ADDRESS SPECIFIED. IF NOT GET CURRENT TCB PTR* 12150002
*********************************************************************** 12200002
         LTR   R4,R4            TCB ADDRESS SPECIFIED?                  12250002
         BNZ   VLCK00           YES, BRANCH TO START VALIDITY CHECKING  12300002
         L     R4,PSATOLD       GET ADDRESS OF CURRENT TCB              12350002
        EJECT                                                           12370002
*********************************************************************** 12400002
*                  SAVE CALLER'S REGISTERS                            * 12450002
*********************************************************************** 12500002
VLCK00   DS    0H                                                       12550002
         L     R15,PSAAOLD      GET ADDRESS OF CURRENT ASCB             12600002
         USING ASCB,R15         SET UP ADDRESSABILITY FOR THE ASCB      12650002
         L     R15,ASCBASXB     GET ADDRESS OF ASXB                     12700002
         USING ASXB,R15         SET UP ADDRESSABILITY FOR THE ASXB      12750002
         L     R15,ASXBSPSA     GET ADDRESS OF WSAVT                    12800002
         USING WSAL,R15         SET UP ADDRESSABILITY FOR THE WSAVT     12850002
         L     R15,WSALVALC     GET ADDRESS OF VALIDITY CHECK'S SAVE    12900002
*                               AREA                                    12950002
         STM   R0,R15,DISPL0(R15) SAVE REGISTERS 0- 15                  13000002
         LR    R10,R15          SAVE ADDRESS OF SAVE AREA               13050002
         DROP  R15                                                      13100002
         BALR  R12,0                                                    13150002
         USING *,R12            ESTABLISH MODULE ADDRESSABILITY         13200002
        EJECT                                                           13205002
*********************************************************************** 13210002
*                   DETERMINE RANGE FOR CHECK                         * 13220002
*********************************************************************** 13230002
         SR    R8,R8            CLEAR RANGE COUNTER                     13240002
         LA    R1,DISPL0(R1)    CLEAR STARTING ADDRESS         @YM03647 13243002
         LA    R2,DISPL0(R2)    CLEAR ENDING ADDRESS           @YM03647 13246002
         N     R1,WORDBDY       ROUND STARTING ADDRESS DOWN TO WORD BDY 13250002
         N     R2,PGEBDY        ROUND ENDING ADDRESS DOWN TO PAGE BDY   13300002
         BZ    VLCK02           BRANCH IF NO RANGE SPECIFIED            13350002
         LR    R3,R1            SAVE STARTING ADDRESS                   13360002
         N     R3,PGEBDY        ROUND STARTING ADDRESS DOWN TO PAGE BDY 13370002
         CR    R3,R2            STARTING & ENDING ADDRESS ON SAME PAGE  13380002
         BE    VLCK02           YES, ONLY VALIDITY CHECK ONE PAGE       13390002
         LR    R8,R2            SET UP RANGE COUNTER                    13395002
         SR    R8,R3            GET SIZE OF RANGE                       13400002
         SRL   R8,PGBITS        DIVIDE BY SIZE OF PAGE                  13470002
VLCK02   DS    0H                                                       13550002
         LA    R8,ONE(R8)       ADD 1 TO NUMBER PAGES TO BE VALIDATED   13600002
        EJECT                                                           13620002
*********************************************************************** 13650002
*                  ESTABLISH FUNCTIONAL RECOVERY ROUTINE              * 13700002
*********************************************************************** 13750002
         LA    R6,VLCKFRR       GET ADDRESS OF FRR ROUTINE              13800002
*                               ESTABLISH FRR                           13850002
         SETFRR A,FRRAD=(R6),PARMAD=(R5),WRKREGS=(R5,R7)                13900002
         USING PARMFRR,R5          SET UP ADDRESSABILITY TO PARM AREA   13910002
         ST    R10,SAVEPTR         SAVE ADDRESS OF SAVE AREA            13920002
        EJECT                                                           13930002
*********************************************************************** 13950002
*              SWITCH TO TCBPKF KEY                                   * 14000002
*********************************************************************** 14050002
         MODESET EXTKEY=TCB,WORKREG=6                                   14100002
        EJECT                                                           14105002
*********************************************************************** 14110002
*                        FETCH AND STORE TEST                         * 14120002
*********************************************************************** 14130002
VLCK03   DS    0H               PAGE TEST LOOP                          14140002
         L     R6,DISPL0(R1)    PICK UP WORD FROM PAGE                  14150002
VLCK04   DS    0H                                                       14200002
         CS    R6,R6,DISPL0(R1) PERFORM FETCH AND STORE                 14250002
         BNZ   VLCK04           REPEAT TEST IF COMPARE UNEQUAL          14300002
*********************************************************************** 14350002
*        IF CS INSTRUCTION DID NOT CAUSE A PROGRAM CHECK TEST IS      * 14400002
*        SUCCESSFUL. FRR ROUTINE WILL INTERCEPT PROGRAM CHECKS        * 14450002
*********************************************************************** 14500002
         N     R1,PGEBDY        ROUND TO PAGE BOUNDARY FOR              14510002
*                               REMAINING PAGES                         14520002
         A     R1,PGESIZE       INCREASE STARTING ADDRESS BY PAGE       14550002
         BCT   R8,VLCK03        REPEAT TEST IF MORE PAGES TO CHECK      14600002
        EJECT                                                           14620002
*********************************************************************** 14650002
*              SWITCH BACK TO KEY 0                                   * 14700002
*********************************************************************** 14750002
         MODESET EXTKEY=SUPR        SWITCH BACK TO KEY 0                14800002
        EJECT                                                           14810002
*********************************************************************** 14820002
*                    DELETE FRR                                       * 14830002
*********************************************************************** 14840002
VLCK06   DS    0H                                                       14850002
         SETFRR D,WRKREGS=(R5,R7)     DELETE FRR                        14950002
        EJECT                                                           14970002
*********************************************************************** 15000002
*                        SET CONDITION CODE                           * 15050002
*********************************************************************** 15100002
         SR    R0,R0            SET CONDITION CODE EQ 0                 15150002
        EJECT                                                           15170002
*********************************************************************** 15200002
*                        RESTORE REGISTERS AND RETURN                 * 15250002
*********************************************************************** 15300002
VLCK08   DS    0H                                                       15350002
*        REG 4 WAS UPDATED BEFORE REGISTERS WERE STORED               * 15400002
         LM    R0,R15,DISPL0(R10) RESTORE REGISTERS 0-15                15450002
         BR    14               RETURN TO CALLER                        15550002
        EJECT                                                           15570002
*********************************************************************** 15600002
*                                                                     * 15650002
*                 S T O R A G E  C O N S T A N T S                    * 15700002
*                                                                     * 15750002
*********************************************************************** 15800002
         DS    0F                                                       15850002
WORDBDY  DC    X'FFFFFFFC'      CONSTANT TO RESET VALUE TO WORD BDY     15860002
PGEBDY   DC    X'FFFFF000'      CONSTANT TO RESET VALUE TO PAGE BDY     15900002
PGESIZE  DC    F'4096'          SIZE OF FULL PAGE                       15950002
PATCH    DC    40X'00'          PATCH AREA FOR ROUTINE                  16010002
         EJECT                                                          16030002
*********************************************************************** 16050002
*                                                                     * 16100002
*                        FRR ROUTINE                                  * 16150002
*                                                                     * 16200002
*********************************************************************** 16250002
VLCKFRR  DS    0H                                                       16300002
         BALR  R12,R0           ESTABLISH ADDRESSABILITY                16300802
         USING *,R12                                                    16301602
         LR    R11,R1           SET UP PTR TO SDWA                      16302402
         USING SDWA,R11                                                 16303202
         L     R10,SDWAPARM     SET UP PTR TO PARM AREA                 16304002
         USING PARMFRR,R10                                              16304802
         TM    SDWAERRD,SDWACLUP  CAN RETRY BE DONE?                    16305602
         BNZ   CONTERM          NO, CONTINUE WITH TERMINATION           16306402
         TM    FLAGS,RECURSB    RECURSIVE ABEND?                        16307202
         BO    CONTERM          YES, CONTINUE WITH TERMINATION          16308002
         OI    FLAGS,RECURSB    SET RECURSIVE INDICATOR                 16308802
         TM    SDWAERRA,SDWAPCHK PROGRAM CHECK?                         16309602
         BNO   CONTERM          NO, CONTINUE WITH TERMINATION           16310402
        EJECT                                                           16310602
*********************************************************************** 16310802
*                                                                     * 16310902
*                          PROGRAM CHECK                              * 16311002
*                                                                     * 16311102
*********************************************************************** 16361102
         CLI   SDWAICD1,PROTERR PROTECTION EXCEPTION                    16411102
         BE    RETRY            YES, EXPECTED ABEND- RETRY              16461102
         CLI   SDWAICD1,ADDRERR ADDRESSING EXCEPTION                    16511102
         BE    RETRY            YES, EXPECTED ABEND- RETRY              16561102
         CLI   SDWAICD1,SEGERR  SEGMENT TRANSLATION ERROR               16611102
         BE    RETRY            YES, EXPECTED ABEND- RETRY              16661102
         CLI   SDWAICD1,PAGERR  PAGE TRANSLATION ERROR                  16711102
         BNE   CONTERM          NO, NOT AN EXPECTED PGM CHECK           16761102
        EJECT                                                           16766102
*********************************************************************** 16771102
*                                                                     * 16781102
*                         EXPECTED PROGRAM CHECK                      * 16791102
*                          0C4, 0C5, 0D0, OR 0D1                      * 16801102
*                                                                     * 16803102
*********************************************************************** 16805102
RETRY    DS    0H               RETRY AT VALRETRY                       16811102
         L     R8,SAVEPTR       RESTORE SAVE AREA PTR IN                16861102
         ST    R8,SDWASR10      REGISTERS TO BE USED FOR RETRY          16911102
         SETRP RETADDR=VALRETRY,RECORD=NO,DUMP=NO,RETREGS=YES,RC=4,    *16961102
               WKAREA=(R11)                                             17011102
         BR    R14              RETURN TO RTM                           17061102
        EJECT                                                           17066102
*********************************************************************** 17071102
*                                                                     * 17081102
*                       UNEXPECTED ABEND                              * 17091102
*                                                                     * 17101102
*********************************************************************** 17103102
CONTERM  DS    0H               CONTINUE WITH TERMINATION               17111102
         MVC   SDWAMODN,MODNAME INITIALIZE MODULE NAME                  17161102
         MVC   SDWACSCT,CSCTNAME INITIALIZE CSECT NAME                  17211102
         MVC   SDWAREXN,RECNAME  INITIALIZE RECOVERY RTN NAME           17261102
         SETRP DUMP=YES,RECORD=YES,RC=0,WKAREA=(R11)       @ZA09451     17311103
         BR    R14                RETURN TO RTM                         17361102
        EJECT                                                           17381102
*********************************************************************** 17411102
*                                                                     * 17461102
*                             STORAGE CONSTANTS                       * 17511102
*                                                                     * 17561102
*********************************************************************** 17611102
         DS    0D                                                       17661102
MODNAME  DC    CL8'IEAVEVAL'    LOAD MODULE NAME                        17711102
CSCTNAME DC    CL8'IEAVEVAL'    CSECT NAME                              17761102
RECNAME  DC    CL8'VLCKFRR'     RECOVERY ROUTINE NAME                   17811102
PROTERR  EQU   X'04'            PROTECTION ERROR INTERRUPT CODE         17861102
ADDRERR  EQU   X'05'            ADDRESSING ERROR INTERRUPT CODE         17911102
SEGERR   EQU   X'10'            SEGMENT TRANSLATION INTERRUPT CODE      17961102
PAGERR   EQU   X'11'            PAGING TRANSLATION INTERRUPT CODE       18011102
         EJECT                                                          18061102
*********************************************************************** 18111102
*                                                                     * 18161102
*                             RETRY ROUTINE                           * 18211102
*                                                                     * 18261102
*********************************************************************** 18311102
VALRETRY DS    0H                                                       18361102
         BALR  R12,0            ESTABLISH ADDRESSABILITY                18411102
         USING *,12                                                     18461102
         MODESET EXTKEY=SUPR    RETURN TO KEY 0                         18511102
         SETFRR D,WRKREGS=(R5,R7) DELETE FRR                            18561102
         LTR   R10,R10          SET NONZERO CONDITION CODE              18611102
         LM    R0,R15,DISPL0(R10) RESTORE REGISTERS                     18661102
         BR    R14              RETURN TO CALLER                        18711102
         END                                                            18761102
