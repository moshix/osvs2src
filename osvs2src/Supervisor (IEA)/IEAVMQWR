         TITLE 'IEAVMQWR - COMM TASK WAIT AND ROUTER'                   00050002
IEAVMQWR CSECT                                                          00100001
* WRLOCK(C) APPROX 062603           OBLOCK(A)  APPROX 134057   @ZA11392 00120051
* WRWTO(A)  APPROX 109860           FRLOCKS(C) APPROX 134125   @ZA11392 00130051
* WRSWCH(A) APPROX 074400           TWENTY(A)  APPROX 144100   @ZA19273 00140051
**** START OF SPECIFICATIONS ****************************************** 00150002
*                                                                       00200002
*01*     MODULE-NAME = IEAVMQWR                                         00230002
*                                                                       00260002
*01*     DESCRIPTIVE-NAME = COMM TASK WAIT AND ROUTER                   00290002
*                                                                       00320002
*01*     COPYRIGHT = NONE                                               00350002
*                                                                       00380002
*01*     STATUS = MVS 3033 PROCESSOR SUPPORT(SCP)              @G51APSS 00385051
*                                                                       00440002
*01*     FUNCTION = THE WAIT ROUTINE WAITS ON ALL COMMUNICATIONS        00470002
*                   EVENT CONTROL BLOCKS.  IT ROUTES CONTROL TO THE     00500002
*                   COMM TASK SERVICE ROUTINES WHEN ANY OF THE ECBS     00530002
*                   IS POSTED.                                          00560002
*                                                                       00590002
*02*          OPERATION = WHEN THE WAIT ROUTINE IS AWAKENED IT CHECKS   00620002
*                         THE ECBS AND SERVICES REQUESTS ACCORDING TO   00650002
*                         THE FOLLOWING PRIORITY: AUTOMATIC CPU         00680002
*                         RECOVERY, EXTERNAL INTERRUPT,                 00710002
*                         ATTENTION, I/O COMPLETION, CONSOLE OUTPUT,    00740002
*                         WTO, DOM AND LOG INITIALIZATION.              00770002
*                                                                       00800002
*                         IF A NO-CONSOLES CONDITION EXISTS    @G51APSS 00800351
*                         AND THE MASTER CONSOLE CANDIDATE HAS @G51APSS 00800651
*                         BEEN CHOSEN THEN ONLY THE AUTOMATIC  @G51APSS 00800951
*                         CPU RECOVERY AND EXTERNAL INTERRUPT  @G51APSS 00801251
*                         ECBS ARE WAITED ON.                  @G51APSS 00801551
*                                                                       00802151
*                         BEFORE CHECKING TO SEE IF OECB IS    @ZA11392 00803051
*                         POSTED SEE IF MESSAGE IEA406I MSG    @ZA11392 00805051
*                         SHOULD BE ISSUED AND IF A DOM SHOULD @ZA11392 00807051
*                         BE ISSUED FOR MESSAGE IEA404A.       @ZA11392 00809051
*                                                              @ZA11392 00811051
*                         IF OECB IS POSTED THEN CHECK TO SEE  @ZA11392 00813051
*                         IF THE WQE THRESHOLD MESSAGES SHOULD @ZA11392 00815051
*                         BE ISSUED.(IEA405E IEA404A).         @ZA11392 00817051
*                                                              @ZA11392 00819051
*                         AFTER A POSTED ECB HAS BEEN SERVICED, IT      00830002
*                         RETURNS TO ITS STARTING POINT AND BEGINS      00860002
*                         CHECKING THE ECB LIST AGAIN IN THE SAME       00890002
*                         ORDER.  WHEN ALL THE ECBS HAVE BEEN CHECKED   00920002
*                         AND NOTHING IS POSTED, IT RETURNS TO A WAIT.  00950002
*                                                                       00980002
*01*     NOTES = NONE                                                   01010002
*                                                                       01040002
*02*          DEPENDENCIES = NO DEVICE DEPENDENCIES.                    01070002
*                                                                       01100002
*03*               CHARACTER-CODE-DEPENDENCIES = NONE.                  01130002
*                                                                       01160002
*02*          RESTRICTIONS = NONE.                                      01190002
*                                                                       01220002
*02*          REGISTER CONVENTIONS = SEE LABEL QWRREGS                  01250002
*                                                                       01280002
*02*          PATCH-LABEL = SPACE                              @G51APSS 01290051
*                                                                       01340002
*01*     MODULE TYPE = PROCEDURE                                        01370002
*                                                                       01400002
*02*          PROCESSOR = ASSEMBLER-370R                                01430002
*                                                                       01460002
*02*          MODULE-SIZE = X'43C' BYTES                       @G51APSS 01470051
*                                                                       01520002
*02*          ATTRIBUTES = KEY 0, SERIALLY REUSEABLE,                   01550002
*                          SUPERVISOR STATE, PART OF LOAD               01580002
*                          MODULE IEAVCTSK OF THE SYS1.LPALIB DATA SET  01610002
*                                                                       01640002
*01*     ENTRY-POINT = IEAVMQWR                                         01670002
*                                                                       01700002
*02*          PURPOSE = TO SET UP THE ENVIRONMENTAL REGISTERS, TO       01730002
*                       INITIALIZE THE ECBS IN THE EIL AND ISSUE A      01760002
*                       WAIT ON THE EIL.                                01790002
*                                                                       01820002
*02*          LINKAGE = BRANCHED TO FROM THE DISPATCHER AFTER SYSTEM    01850002
*                       INITIALIZATION.                                 01880002
*                                                                       01910002
*02*          INPUT = NONE.                                             01940002
*                                                                       01970002
*02*          OUTPUT = N/A (NO TRUE EXIT)                               02000002
*                                                                       02030002
*02*          REGISTER-SAVED = NONE                                     02040002
*                                                                       02050002
*02*          REGISTER-USAGE = SEE LABEL QWRREGS                        02052002
*                                                                       02054002
*02*          REGISTERS-RESTORED = N/A (NEVER ENDING ROUTINE)           02056002
*                                                                       02058002
*01*     ENTRY-POINT = WRABXLE                                          02060002
*                                                                       02090002
*02*          PURPOSE = TO CONTINUE THE SEARCH OF THE UCMES FOR AN      02120002
*                       ATTENTION PENDING.  THE CURRENT UCME WITH AN    02150002
*                       ATTENTION PENDING CANNOT BE PROCESSED.          02180002
*                                                                       02210002
*02*          LINKAGE = BRANCHED TO FROM MODULE IEAVMDSV.               02240002
*                                                                       02270002
*02*          INPUT = R2 - ADDR OF UCM                                  02300002
*                     R3 - ADDR OF NEXT UCME                            02330002
*                     R4 - ADDR OF UCM PREFIX                           02360002
*                     R8 - ADDR OF EIL                                  02390002
*                     R9 - BASE REGISTER                                02420002
*                     R11-13 - UCME BXLE REGISTERS                      02450002
*                     THE OTHER REGISTERS ARE IRRELEVANT.               02480002
*                                                                       02510002
*02*          OUTPUT = N/A (NO TRUE EXIT)                               02540002
*                                                                       02550002
*02*          REGISTERS-SAVED = NONE                                    02560002
*                                                                       02562002
*02*          REGISTER-USAGE = SEE LABEL QWRREGS                        02564002
*                                                                       02566002
*02*          REGISTERS-RESTORED = N/A (NEVER ENDING ROUTINE)           02568002
*                                                                       02570002
*01*     EXIT-NORMAL = NONE. (NEVER ENDING ROUTINE.)                    02600002
*                                                                       02630002
*01*     EXIT-ERROR = NONE.                                             02660002
*                                                                       02690002
*01*     EXTERNAL REFERENCES = THIS MODULE SERVES AS A ROUTER TO THE    02720002
*                              FOLLOWING ROUTINES:                      02750002
*                                                                       02780002
*02*          ROUTINES = IEAVSWCH, IEAVMDSV, IEAVMWSV, IEAVMDOM,        02810002
*                        IEAVMWTL                                       02840002
*                                                                       02870002
*02*          DATA AREAS = NONE.                                        02900002
*                                                                       02930002
*02*          CONTROL BLOCKS = IEECUCM-W,  CVT-R,  IHAFRRS-R,           02960002
*                  IHAPSA-R                                             02970002
*                                                                       02990002
*01*     TABLES = NONE.                                                 03020002
*                                                                       03050002
*01*     MACROS = WAIT, SETLOCK, LINK, GETMAIN, FREEMAIN, SETFRR,       03060051
*                 WTO, DOM                                     @ZA11392 03090051
*                                                                       03110002
*02*          SERIALIZATION = THE CMS AND LOCAL LOCKS ARE USED TO       03140002
*                             SERIALIZE USE OF THE UCM.                 03170002
*                                                                       03200002
*01*     CHANGE-ACTIVITY = ZM34522,ZA11392,ZA19273,G51APSS     @G51APSS 03205051
*                                                                       03260002
*01*     MESSAGES =                                                     03300051
*                                                                       03350051
*                   IEA404A WTO BUFFER SHORTAGE CRITICAL       @ZA11392 03356051
*                   IEA405E WTO BUFFER SHORTAGE                @ZA11392 03362051
*                   IEA406I WTO BUFFER SHORTAGE RELIEVED       @ZA11392 03368051
*                                                                       03380002
*01*     ABEND CODES = NONE                                             03470002
*                                                                       03500002
**** END OF SPECIFICATIONS ******************************************** 03850002
         EJECT                                                          03900001
         ENTRY WRABXLE                                                  03950001
         EXTRN IEAVMDSV                                                 04000001
         EXTRN IEAVMWSV                                                 04050001
         EXTRN IEAVMDOM                                                 04100001
         USING UCM,R2                                                   04150001
         USING UCMPRFX,R4                                               04200001
         USING UCMEIL,R8                                                04250001
         USING CVT,R10                                                  04300001
         USING UCMLIST,R11                                              04350001
         SPACE 1                                                        04400001
*********************************************************************** 04450001
*                                                                     * 04500001
*        IEECMWRT GETS CONTROL AFTER SYSTEM INITIALIZATION.           * 04550001
*        IT SETS UP ENVIRONMENTAL REGISTERS FOR ALL COMMUNICATIONS    * 04600001
*        TASK RESIDENT ROUTINES. IT THEN GIVES CONTROL TO CTWSTART    * 04650001
*                                                                     * 04700001
*********************************************************************** 04750001
IEECMWRT BALR  R9,ZERO             SET UP R9 BASE REGISTER              04800001
         USING *,R9                ESTABLISH ADDRESSABILITY             04850001
         MODID                                                          04900002
AA       L     R10,CVTPTR          LOAD CVT POINTER                     05050001
         L     R2,CVTCUCB          GET ADDRESS OF UCM                   05100001
         DROP  R10                 DROP BASE FOR CVT             Y02752 05120002
         L     R3,UCMVEA           SAVE UCM ENTRY PTR                   05150001
         LR    R5,R2               POINT TO BEGINNING OF UCM            05200001
         LA    R4,FOUR             DECREMENT BY FOUR                    05250001
         SR    R5,R4               POINT TO ADDED PREFIX POINTER        05300001
         L     R4,ZERO(R5)         R4 NOW POINTS TO THE PREFIX          05350001
         SPACE 1                                                        05400001
*********************************************************************** 05450001
*                                                                     * 05500001
*        CTWSTART ISSUES A WAIT ON ALL COMMUNICATIONS ECB'S.          * 05550001
*        THIS BECOMES THE ENTRY POINT OF THE WAIT MODULE AFTER        * 05600001
*        IEECMWRT EXITS.                                              * 05650001
*                                                                     * 05700001
*********************************************************************** 05750001
         L     R8,UCMLSTP          INITIALIZE EIL PTR                   05800001
CTWSTART LA    R1,UCMXECBA         POINT R1 TO LIST OF ECB ADDRESSES    05850001
WRNCCWAT EQU   *                                               @G51APSS 05900051
         WAIT  ECBLIST=(1)         WAIT FOR NEXT EVENT                  06200001
         EJECT                                                          06250001
**********************************************************************  06250151
*                                                                    *  06250251
*        OBTAIN THE LOCKS AND SET UP FRR RECOVERY             @ZA11392  06250651
*                                                                    *  06260051
**********************************************************************  06260151
         SPACE                                                          06260251
WRLOCK   EQU *            OBTAIN THE LOCKS TO SERIALIZE       @ZA11392  06260351
         BAL R10,OBLOCKS  THE USE OF THE UCM                  @ZA11392  06260551
         SPACE                                                          06261151
WREXT    EQU   *                   BEGIN CHECKING FOR POSTED ECBS       06261202
         SPACE                                                          06262002
*********************************************************************** 06262802
*                                                                     * 06263602
*        CHECK AUTOMATIC CPU RECOVERY ECB.  GO TO CONSOLE SWITCH FOR  * 06264402
*        EACH BIT ON IN THE CPU MASK CONTAINED IN THE COMPLETION CODE * 06265202
*        FIELD OF THE ECB.  ALL BITS IN UCMARECB MUST BE TURNED OFF   * 06266002
*        VIA A CS INSTRUCTION SINCE ACR DOES NOT USE THE CMS LOCK     * 06266802
*        TO SERIALIZE MODIFICATION OF UCMARECB.                       * 06267602
*                                                                     * 06268402
*********************************************************************** 06269202
         SPACE                                                          06270002
         TM    UCMARECB,POST       IS ACR ECB POSTED                    06270802
         BZ    WREXT1              NO, CHECK NEXT ECB                   06271602
WRACR    EQU   *                   SET UP TEST OF CPU ID MASK           06272402
         ICM   R11,CCMASK,UCMARECB+TWO GET CPU ID INTO FIRST 2          06273202
*                                  BYTES OF WORKREG                     06274002
         LA    R12,ONE             INITIALIZE CPU ID PARM REG           06274802
         SLL   R12,FIFTEEN         GET HIGH ORDER BIT OF 2ND            06275602
*                                  HALF WORD ON                         06276402
         LA    R13,SIXTEEN         NUMBER OF BITS IN CPU ID MASK        06277202
         SPACE                                                          06278002
WRACRLP  EQU   *                   LOOP THROUGH CPU ID MASK             06278802
*                                  LOOKING FOR A BIT ON AND AT          06279602
*                                  THE SAME TIME SETTING UP             06280402
*                                  CONSOLE SWITCH PARAMETER             06281202
         LTR   R11,R11             IS HIGH ORDER BIT OF CPU MASK        06282002
*                                  ON                                   06282802
         BM    WRACRGO             YES, GO TO CONSOLE SWITCH            06283602
         SLL   R11,ONE             NO, SET UP TO TEST NEXT BIT          06284402
         SRL   R12,ONE             SET UP CONSOLE SWITCH PARM           06285202
         BCT   R13,WRACRLP         GO TEST NEXT BIT                     06286002
* NO BITS IN CPU ID MASK ARE ON, TURN OFF POST BIT IN ECB               06286802
         SPACE                                                          06287602
         SR    R11,R11             ZERO SWAP REG                        06288402
         LA    R12,ONE             GET A BIT ON                         06289202
         SLL   R12,THIRTY          SET UP COMPARE REG WITH ONLY         06290002
*                                  POST BIT ON                          06290802
         CS    R12,R11,UCMARECB    ATTEMPT TO CLEAR POST BIT            06291602
         BNE   WRACR               SWAP FAILED - ANOTHER CPU BIT        06292402
*                                  WAS SET, GO SERVICE IT               06293202
         EJECT                                                          06293651
**********************************************************************  06300001
*                                                                     * 06350001
*        SERVICE EXTERNAL INTERRUPTS BY GOING TO IGC0407B FOR         * 06400001
*        EVERY INTERRUPT                                              * 06450001
*                                                                     * 06500001
**********************************************************************  06550001
         SPACE 1                                                        06600001
WREXT1   CLI   UCMXCT,ZERO         HAS EXTERNAL ECB BEEN POSTED         07050001
         BE    WRNCC               NO, CHECK FOR NO-CONSOLES           X07070051
                                   CONDITION                   @G51APSS 07100051
         SR    R6,R6               CLEAR REG BEFORE USE          Y02752 07150002
         L     R5,UCMXCT           GET CURRENT COPY OF           Y02752 07160002
*                                     INTERRUPT COUNT            Y02752 07170002
         SPACE                                                          07180002
WREXT2   DS    0H                  CS LOOP                       Y02752 07190002
         LR    R7,R5               MAKE WORKING COPY FOR CS INST Y02752 07200002
         SLDL  R6,ONEBYTE          ISOLATE INTERRUPT COUNT       Y02752 07210002
         BCTR  R6,ZERO             DECREMENT COUNT               Y02752 07220002
         SRDL  R6,ONEBYTE          MOVE COUNT BACK TO REG 7      Y02752 07230002
         CS    R5,R7,UCMXCT        STORE NEW COUNT IF OLD        Y02752 07240002
*                                     COUNT IS STILL VALID       Y02752 07250002
         BNE   WREXT2              IF COMPARE FAILED, GO BACK    Y02752 07260002
*                                     AND TRY AGAIN. NEW VALUE   Y02752 07270002
*                                     OF UCMXCT HAS BEEN PLACED  Y02752 07280002
*                                     IN REG 5 IF COMPARE FAILED Y02752 07290002
         MVI   UCMXSA+SIXTEEN,X04  INDICATE EXTERNAL INTERRUPT          07350002
         SPACE                                                          07370002
WRSWCH   EQU   *                   GO TO CONSOLE SWITCH                 07390002
         MVC   UCMXSA+EIGHT(EIGHT),WREXTNAM NAME OF CONSOLE             07410002
*                                  SWITCH ROUTINE                       07430002
         ST    R2,UCMXSA+TWENTY    PUT UCMBASE INTO PARMLIST   @ZA19273 07440051
         LA    R1,UCMXSA+EIGHT     POINT TO NAME FIELD                  07450001
         SPACE                                                          07457002
* RELEASE LOCKS IN ORDER TO ISSUE AN SVC                                07464002
         SPACE                                                          07471002
         BAL   R10,FRLOCKS         RELEASE LOCKS                 Y02752 07478002
         SVC   SVC72               SVC 72 - GO TO SWITCH RTN            07500001
         B     WRLOCK              REOBTAIN LOCKS AND CHECK ECBS        07550002
*                                  AGAIN                                07570002
         EJECT                                                          07600001
*********************************************************************** 07602051
*        IF A NO-CONSOLES CONDITION EXISTS AND A CANDIDATE     @G51APSS 07604051
*        FOR THE MASTER CONSOLE HAS BEEN CHOSEN THEN WAIT ONLY @G51APSS 07606051
*        ON THE ACR AND THE EXTERNAL INTERRUPT ECBS.           @G51APSS 07608051
*********************************************************************** 07610051
WRNCC    EQU   *                                               @G51APSS 07612051
         XC    UCMXECB(FOUR),UCMXECB CLEAR EXTERNAL ECB        @G51APSS 07614051
         TM    UCMSFLG1,UCMSYSE    DOES A NO-CONSOLES CONDITION EXIST? X07616051
                                                               @G51APSS 07618051
         BNO   WRATTN              NO, CHECK ATTN ECB          @G51APSS 07620051
         L     R7,UCMBFEXT         ADDR OF UCM FIXED EXTENSION BASE    X07622051
                                                               @G51APSS 07624051
         USING UCMFEXTA,R7         BASE TO UCM FIXED EXTENSION BASE    X07626051
                                                               @G51APSS 07628051
         L     R10,UCMFATCN        ADDR OF CANDIDATES UCME     @G51APSS 07630051
         LTR   R10,R10             CANDIDATE CHOSEN YET?       @G51APSS 07632051
         BNP   WRATTN              NO, CHECK ATTN ECB          @G51APSS 07634051
         BAL   R10,FRLOCKS         RELEASE THE LOCKS           @G51APSS 07636051
         LA    R1,UCMFECBL         ECB LIST TO WAIT ON         @G51APSS 07638051
         DROP  R7                  FREE BASE TO UCM FIXED EXTENSION    X07640051
                                   BASE                        @G51APSS 07642051
         B     WRNCCWAT            WAIT FOR ACR OR EXTERNAL INTERUPT   X07644051
                                                               @G51APSS 07646051
*********************************************************************** 07648051
*                                                                     * 07700001
*        GO THROUGH CONSOLE ENTRIES, AND WHENEVER AN ATTENTION IS     * 07720051
*        PENDING, GO TO ROUTINE WRATSERV.                             * 07800001
*                                                                     * 07850001
*********************************************************************** 07870051
WRATTN   EQU   *                                               @G51APSS 07920051
         TM    UCMAECB,POST        HAS ATTENTION ECB BEEN POSTED        08000001
         BZ    WRIOCOMP            NO, CHECK I/O ECB'S                  08050001
         TM    UCMSFLG2,UCMSYSO    WAS ATTN POSTED BY WTL               08100001
         BNO   WRALOOP1            NO - REGULAR ATTENTION               08150001
         NI    UCMSFLG2,MASK255-UCMSYSO TURN OFF FLAG                   08200002
         CLI   UCMAECB+THREE,HCSWCC HC SWITCH REQUESTED BY WTO   Y02756 08210002
         BE    WRHCSW              YES, SET UP TO ISSUE SVC 72   Y02756 08220002
         LA    R1,EIGHT            SIGNAL CLEANUP WITH CODE = 8         08250001
         B     WRAWTLSV            GO TO DEVICE SERVICE ROUTINE         08300001
WRALOOP1 LM    R11,R13,UCMVEA      INITIALIZE BXLE UCM ENTRY REGS       08350001
WRALOOP  TM    UCMSTS,UCMAF        IS ATTN PENDING FOR THIS ENTRY       08400001
         BNO   WRABXLE             NO, BRANCH TO GET NEXT ENTRY         08450001
         TM    UCMATR,UCMUF        IS THIS DEVICE ACTIVE?               08500002
         BO    WRATSERV            YES, BRANCH                          08550001
         NI    UCMSTS,MASK255-UCMAF NO, TURN OFF ATTENTION FLAG         08600002
WRABXLE  BXLE  R11,R12,WRALOOP     GET NEXT ENTRY                       08650001
         XC    UCMAECB(FOUR),UCMAECB  CLEAR ATTENTION ECB               08700001
         EJECT                                                 @G51APSS 08720051
**********************************************************************  08800001
*                                                                       08850001
*        GO THROUGH LIST OF I/O ECB'S, AND WHENEVER ONE IS POSTED       08900001
*        COMPLETE, GO TO ROUTINE WRIOSERV.                              08950001
*                                                                       09000001
**********************************************************************  09050001
WRIOCOMP LM    R11,R13,UCMVEA      GET BXLE UCM ENTRY REGS              09100001
         SR    R6,R6               INITIALIZE INDEX                     09150001
WRIOLOOP L     R1,UCMRECBA+FOUR(R6) GET ADDRESS OF THIS ENTRY'S ECB     09200001
         TM    ZERO(R1),POST       IS IT POSTED COMPLETED?              09250001
         BO    WRIOSERV            YES, BRANCH                          09300001
         LA    R6,FOUR(R6)         INCREMENT ECB PTR ADDRESS            09350001
         BXLE  R11,R12,WRIOLOOP    AND ENTRY ADDRESS TO DO NEXT ENTRY   09400001
         SPACE 3                                               @G51APSS 09420051
**********************************************************************  09500001
*                                                                       09550001
*        IF WE ARE STILL PROCESSING CONSOLE OUTPUT QUEUES,              09600001
*        CONTINUE PROCESSING BY GOING TO IEAVMDSV WITH OUTPUT CODE.     09650001
*        (NOTE: REG 3 IS UPDATED BY THE DEVICE SERVICE ROUTINE TO       09700001
*        POINT TO THE NEXT CONSOLE ENTRY TO BE PROCESSED.)              09750001
*                                                                       09800001
**********************************************************************  09850001
WRDVSERV C     R3,UCMVEA           ARE WE IN THE MIDDLE OF 'DEVSERV'?   09900001
         BNE   WROUTPUT            YES                                  09950001
         TM    UCMSFLG2,UCMSYSJ    NO, BUT IS THERE H.C. OUTPUT TO DO?  10000001
         BZ    WRWTO               NO, CHECK WTO/R ECB                  10050001
         NI    UCMSFLG2,MASK255-UCMSYSJ  TURN OFF H.C. OUTPUT FLAG      10100001
WROUTPUT SR    R1,R1               CODE = 0 FOR OUTPUT                  10150001
WRAWTLSV L     R15,ADDVSV          GET ADDRESS OF DEVICE SERVICE RTN    10200001
WRBALR   BALR  R14,R15             GO TO PROCESSOR                      10250001
         B     WREXT               RETURN TO CHECK EXTERNAL ECB         10300001
         EJECT                                                          10951051
*********************************************************************** 10952051
*                                                                     * 10954051
*        THE FOLLOWING CODE DETERMINES IF A WQE SHORTAGE       @ZA11392 10956051
*        CONDITION IS RELIEVED. IF SO THEN MESSAGE IEA406I     @ZA11392 10958051
*        IS ISSUED.                                            @ZA11392 10960051
*          1) IEA406I WTO BUFFER SHORTAGE RELIEVED             @ZA11392 10962051
*             ONE OR BOTH OF ABOVE MSGS HAVE BEEN ISSUED AND   @ZA11392 10964051
*             THE WQE COUNT HAS DROPPED BELOW 60%. IF MSG      @ZA11392 10966051
*             IEA404A WAS ISSUED THEN A DOM IS ISSUED FOR THE  @ZA11392 10968051
*             MSG.                                             @ZA11392 10970051
*                                                                     * 10982051
*********************************************************************** 10984051
WRWTO    EQU   *                                               @ZA11392 10985051
         L     R7,UCMBFEXT         ADDRESS OF FIXED EXTENSION  @G51APSS 10986051
         USING UCMFEXTA,R7         BASE TO FIXED EXTENSION     @ZA11392 10992051
         LH    R10,UCMWQLM         GET WQE BUFFER LIMIT        @ZA11392 10993051
         CH    R10,UCMWQLM1        IS LIMIT = IPL SPECIFIED LIMIT?     X11003851
                                                               @ZA11392 11004251
         BNE   TESTOECB            NO, DON'T TEST WQE THRESHOLD        X11004551
                                                               @ZA11392 11004651
         TM    UCMFFLG1,UCMFMSGN   SHOULD ANY MSGS BE ISSUED?  @ZA11392 11004751
         BNZ   TESTOECB            NO,DON'T TEST WQE THRESHOLD @ZA11392 11004851
         TM    UCMFFLG1,UCMFMSGE   MSG IEA405E ISSUED ?        @ZA11392 11004951
         BZ    TESTOECB            NO,GO SEE IF OECB POSTED    @ZA11392 11005051
         EJECT                                                          11005651
*********************************************************************** 11005751
*                                                                     * 11005851
*        SEE IF THE CURRENT WQE COUNT IS LESS THAN 60%         @ZA11392 11005951
*        OF THE LIMIT SPECIFIED AT IPL. IF SO ISSUE            @ZA11392 11006051
*        MESSAGE IEA406I                                       @ZA11392 11006151
*                                                                     * 11006351
*********************************************************************** 11006451
         SPACE                                                          11006551
         LH    R6,UCMWQNR          GET CURRENT WQE COUNT       @ZA11392 11006751
         CH    R6,UCMF60WQ         WQE COUNT <= 60% OF LIMIT?  @ZA11392 11007051
         BH    TESTOECB            NO,GO SEE IF OECB IS POSTED @ZA11392 11007351
         BAL   R10,FRLOCKS         RELEASE THE LOCKS           @ZA11392 11007651
         WTO   'IEA406I WTO BUFFER SHORTAGE RELIEVED',ROUTCDE=(2),     X11008451
               DESC=(4)                                        @ZA11392 11009051
         TM    UCMFFLG1,UCMFMSGA   MSG IEA404A ISSUED?         @ZA11392 11009451
         BZ    WRESET              NO, GO TURN OFF INDICATORS  @ZA11392 11009851
         L     R10,UCMFPPTR        GET ADDRESS OF PAGEABLE EXTENSION   X11010851
                                                               @ZA11392 11011451
         USING UCMPEXTA,R10        BASE TO PAGEABLE EXTENSION  @ZA11392 11012051
         L     R1,UCMPWQE          GET MSG IEA404A DOM ID      @ZA11392 11012651
         DOM   MSG=(1)             DOM THE MESSAGE             @ZA11392 11013251
         NI    UCMFMGFS,MASK255-UCMFMSGA TURN OFF MESSAGE IEA404A      X11014551
                                   INDICATOR                   @ZA11392 11014751
         XC    UCMPWQE,UCMPWQE     ZERO DOM ID FIELD           @ZA11392 11014851
         DROP  R10                                             @ZA11392 11014951
WRESET   EQU   *                                                        11015551
         NI    UCMFMGFS,MASK255-UCMFMSGE TURN OFF MESSAGE IEA405E      X11015651
                                   INDICATOR                   @ZA11392 11016051
         BAL   R10,OBLOCKS         GO OBTAIN THE LOCKS         @ZA11392 11016351
         EJECT                                                          11016951
**********************************************************************  11017051
*                                                                       11017151
*        IF CONSOLE OUTPUT QUEUES ARE STILL NOT BEING          @ZA11392 11017251
*        PROCESSED, SERVICE A POSTED WTO/R ECB BY GOING TO     @ZA11392 11017351
*        IEAVMWSV. NOTE - WHEN IEAVMWSV FINISHES QUEUEING, IT  @ZA11392 11017451
*        GOES TO IEAVMDSV TO START PROCESSING CONSOLE OUTPUT   @ZA11392 11017551
*        QUEUES. THIS GETS US INTO THE PREVIOUS LOOP, AND THE  @ZA11392 11017651
*        WTO/R ECB IS NOT CHECKED AGAIN UNTIL ALL CONSOLE      @ZA11392 11017751
*        QUEUES HAVE BEEN PROCESSED.                           @ZA11392 11017851
*                                                                       11018451
**********************************************************************  11018551
TESTOECB TM    UCMOECB,POST        IS WTO/R ECB POSTED?        @ZA11392 11018651
         BZ    WRCLNUP             NO, DO NEXT SERVICE         @ZA11392 11018751
         SPACE 2                                                        11018851
*********************************************************************** 11019151
*                                                                     * 11019251
*        SEE IF THE CURRENT WQE COUNT IS GREATER THAN 80% OF   @ZA11392 11019851
*        THE LIMIT SPECIFIED AT IPL. IF SO ISSUE MSG IEA405E.  @ZA11392 11020051
*          1) IEA405E WTO BUFFER SHORTAGE                      @ZA11392 11020251
*             80% OF WQE'S ARE IN USE                          @ZA11392 11020451
*                                                                     * 11021051
*********************************************************************** 11021651
         SPACE                                                          11022251
         LH    R10,UCMWQLM          GET WQE BUFFER LIMIT       @ZA11392 11022851
         CH    R10,UCMWQLM1         IS LIMIT = IPL SPECIFIED LIMIT?    X11023051
                                                               @ZA11392 11023151
         BNE   WRCONT               NO, DON'T TEST WQE THRESHOLD       X11023351
                                                               @ZA11392 11023451
         TM    UCMFFLG1,UCMFMSGN   SHOULD ANY MSGS BE ISSUED?  @ZA11392 11023751
         BNZ   WRCONT              NO,DON'T TEST WQE THRESHOLD @ZA11392 11024051
         LH    R6,UCMWQNR          GET CURRENT WQE COUNT       @ZA11392 11024351
         CH    R6,UCMF80WQ         WQE COUNT >= 80% OF LIMIT?  @ZA11392 11024651
         BL    WRCONT              NO,MSGS NOT NEEDED CONTINUE @ZA11392 11024951
         TM    UCMFFLG1,UCMFMSGE   WAS MSG IEA405E ISSUED ?    @ZA11392 11025251
         BO    WRCMP100            YES,GO COMPARE COUNT TO 100%@ZA11392 11025551
         BAL   R10,FRLOCKS         RELEASE THE LOCKS OVER WTO  @ZA11392 11025851
         WTO   'IEA405E WTO BUFFER SHORTAGE',ROUTCDE=(2),DESC=(3)       11026451
         OI    UCMFFLG1,UCMFMSGE   SET INDICATOR THAT MSG IEA405E WAS  X11026551
                                   ISSUED                      @ZA11392 11026851
         BAL   R10,OBLOCKS         OBTAIN THE LOCKS            @ZA11392 11027451
         EJECT                                                          11028851
*********************************************************************** 11029451
*                                                                     * 11030051
*        SEE IF CURRENT WQE COUNT IS EQUAL TO OR GREATER THAN  @ZA11392 11030651
*        THE LIMIT SPECIFIED AT IPL. IF SO ISSUE MSG IEA404A.  @ZA11392 11030851
*          1) IEA404A WTO BUFFER SHORTAGE CRITICAL             @ZA11392 11031051
*             ALL OF THE WQE'S ARE IN USE                      @ZA11392 11031251
*                                                                     * 11031851
*********************************************************************** 11032451
         SPACE                                                          11033051
WRCMP100 EQU   *                                               @ZA11392 11033651
         LH    R6,UCMWQNR          GET CURRENT WQE COUNT       @ZA11392 11034051
         CH    R6,UCMWQLM          WQE COUNT >= LIMIT OF WQE'S @ZA11392 11034451
         BL    WRCONT              NO,CONTINUE WITH PROCESSING @ZA11392 11034851
         TM    UCMFFLG1,UCMFMSGA   WAS MSG IEA404A ISSUED?     @ZA11392 11035251
         BO    WRCONT              YES,DON'T ISSUE AGAIN       @ZA11392 11035651
         BAL   R10,FRLOCKS         RELEASE THE LOCKS OVER WTO  @ZA11392 11036051
         WTO   'IEA404A WTO BUFFER SHORTAGE CRITICAL',ROUTCDE=(2),     X11037251
               DESC=(2)                                        @ZA11392 11037851
         L     R10,UCMFPPTR        GET ADDRESS OF PAGEABLE EXTENSION   X11038651
                                                               @ZA11392 11038851
         USING UCMPEXTA,R10        BASE TO PAGEABLE EXTENSION  @ZA11392 11038951
         ST    R1,UCMPWQE          SAVE THE MSG DOM ID         @ZA11392 11039051
         DROP  R10                                             @ZA11392 11039151
         OI    UCMFFLG1,UCMFMSGA   SET INDICATOR THAT MSG IEA404A WAS  X11039651
                                   ISSUED                      @ZA11392 11039851
         BAL   R10,OBLOCKS         OBTAIN THE LOCKS            @ZA11392 11040151
         DROP  R7                  DROP ADDRESSIBILITY TO UCM FIXED    X11040751
                                   EXTENSION                   @ZA11392 11040851
         EJECT                                                          11041451
*********************************************************************** 11042051
*                                                                     * 11042651
*        SET UP AND GO TO WTO/R SERVICE PROCESSOR              @ZA11392 11043251
*                                                                     * 11043851
*********************************************************************** 11044451
         SPACE                                                          11045051
WRCONT   EQU   *                                               @ZA11392 11045651
         XC    UCMOECB(FOUR),UCMOECB  YES, CLEAR ECB                    11046251
         L     R15,ADWTOSV         GET ADDRESS OF WTO/R SERVICE         11050001
         B     WRBALR              GO TO WTO/R SERVICE                  11100001
         SPACE 2                                                        11150001
**********************************************************************  11200001
*                                                                       11250001
*        IF THE SYSTEM WQE QUEUE NEEDS TO BE CONSOLIDATED,              11300001
*        GO TO IEAVMDSV WITH CLEANUP CODE.                              11350001
*                                                                       11400001
**********************************************************************  11450001
WRCLNUP  TM    UCMSFLG2,UCMSYSI    IS CLEANUP SERVICE NEEDED?           11500001
         BZ    WRDOM               NO, DO NEXT SERVICE                  11550001
         LA    R1,EIGHT            YES, CODE = 8 FOR CLEANUP            11600001
         NI    UCMSFLG2,MASK255-UCMSYSI  TURN OFF CLEANUP INDICATOR     11650001
         B     WRAWTLSV            GO TO DEVICE SERVICE ROUTINE         11700001
         EJECT                                                          11750001
**********************************************************************  11800001
*                                                                       11850001
*        IF THE DOM ECB HAS BEEN POSTED, GO TO THE DOM PROCESSOR        11900001
*        (IEAVMDOM).                                                    11950001
*                                                                       12000001
**********************************************************************  12050001
WRDOM    TM    UCMDECB,POST        IS DOM ECB POSTED?                   12100001
         BZ    PXFOXL              NO, GO TO SYSLOG CHECKER ROUTINE     12150001
         L     R15,ADDOM           YES, GET ADDRESS OF DOM PROCESSOR    12200001
         B     WRBALR              GO TO DOM PROCESSOR                  12250001
         SPACE 4                                                        12300001
**********************************************************************  12350001
*                                                                       12400001
*        IF THE LOG INITIALIZATION ECB HAS BEEN POSTED, GO TO           12450001
*        SERVICE ROUTINE (IEAVMWTL) TO CHECK IF HARDCOPY IS SYSLOG      12500001
*                                                                       12550001
**********************************************************************  12600001
PXFOXL   EQU   *                   CHECK LOG INITIALIZATION ECB         12650002
         SPACE                                                          12655002
* RELEASE LOCKS IN PREPARATION FOR LINK TO WTL ROUTINE OR WAIT          12660002
* ON ECBLIST.  UCMNPECB NEED NOT BE SERIALIZED.                         12665002
         SPACE                                                          12670002
         BAL   R10,FRLOCKS         RELEASE LOCKS                 Y02752 12672002
         SPACE                                                          12690002
         TM    UCMNPECB,POST       HAS LOG JUST BEEN INITIALIZED        12695002
         BZ    CTWSTART            NO, GO TO WAIT ROUTINE               12700001
         XC    UCMNPECB(FOUR),UCMNPECB CLEAR LOG ECB IN UCM             12705002
         GETMAIN R,LV=64,SP=255    SAVE AREA 16 WORDS IN LSQS           12710001
         LR    R13,R1              STANDARD LINKAGE CONVENTION          12720001
         LINK  EP=IEAVMWTL                                              12750001
         L     R0,SP255L64         SET UP TO FREE SAVEAREA              12760001
         LR    R1,R13              POINT R1 TO SAVE AREA                12770001
         FREEMAIN R,LV=(0),A=(1)                                        12780001
         B     WRLOCK              REOBTAIN LOCKS AND CHECK ECBS        12800002
*                                  AGAIN                                12850002
         SPACE 4                                                        12900001
**********************************************************************  12950001
*                                                                       13000001
*        IF AN ATTENTION OR I/O COMPLETE IS PENDING, SERVICE BY         13050001
*        GOING TO IEAVMDSV.                                             13100001
*                                                                       13150001
**********************************************************************  13200001
WRIOSERV OI    UCMDEVC,UCMDEVE     SET I/O COMPLETION FLAG              13250001
WRATSERV LA    R1,FOUR             CODE = 4 FOR ATTN OR I/O             13300001
         B     WRAWTLSV            GO TO DEVICE SERVICE ROUTINE         13350001
         SPACE                                                          13352002
* SET UP ACR PARAMETERS TO CONSOLE SWITCH                               13354002
* TURN OFF CORRESPONDING BIT IN CPU ID MASK IN ACR ECB                  13356002
         SPACE                                                          13358002
WRACRGO  EQU   *                   SET UP FOR CONSOLE SWITCH FOR        13360002
*                                  ACR                                  13362002
         MVI   UCM5WD,ACRCODE      INPUT CODE FOR ACR                   13364002
         STCM  R12,CSMASK,UCM5WD+ONE INSERT SINGLE CPU ID               13366002
         L     R11,UCMARECB        GET CONTENTS OF ACR ECB              13368002
         SPACE                                                          13372002
WRACRCS  EQU   *                   COMPARE AND SWAP LOOP                13374002
         LR    R13,R11             MOVE CONTENTS OF ACR ECB TO          13376002
*                                  SWAP REG                             13378002
         XR    R13,R12             TURN OFF BIT IN SWAPREG              13380002
         CS    R11,R13,UCMARECB    IF CONTENTS HAS NOT CHANGED,         13382002
*                                  TURN OFF BIT IN ACR ECB              13384002
         BNE   WRACRCS             CONTENTS HAS CHANGED, TRY            13386002
*                                  AGAIN                                13388002
         B     WRSWCH              SUCCESSFUL, GO TO CONSOLE            13390002
*                                  SWITCH                               13392002
         EJECT                                                          13392802
**************************************************************** Y02756 13393602
*                                                                Y02756 13394402
*   SET UP HC SWITCH PARAMETERS TO CONSOLE SWITCH ROUTINE TO     Y02756 13395202
*   SWITCH HC FROM THE SYSTEM LOG TO A CONSOLE.  WTO HAS         Y02756 13396002
*   REQUESTED A SWITCH BECAUSE THE LOG HAS NOT YET BEEN          Y02756 13396802
*   INITIALIZED, MESSAGES FOR HC ARE BEING KEPT IN WQES IN CSA   Y02756 13397602
*   SPACE WAITING TO BE HARDCOPIED AND THERE IS NO MORE CSA      Y02756 13398402
*   SPACE FOR WQES FOR ADDITIONAL MESSAGES OR ANY TYPE.          Y02756 13399202
*                                                                Y02756 13400002
**************************************************************** Y02756 13401802
         SPACE                                                          13402102
WRHCSW   EQU   *                   SWITCH HARDCOPY               Y02756 13402402
         MVI   UCMAECB+THREE,ZERO  CLEAR COMPLETION CODE         Y02756 13402702
         MVI   UCM5WD,HCSWCODE     INPUT CODE FOR HC SWITCH      Y02756 13403002
*                                  FROM SYSLOG                   Y02756 13403602
         B     WRSWCH              GO TO CONSOLE SWITCH          Y02756 13403902
         EJECT                                                          13404202
*********************************************************************** 13404451
*                  OBTAIN LOCKS SUBROUTINE                            * 13404651
* THE CMS LOCK IS USED TO SERIALIZE USE OF THE UCM.  THE LOCAL LOCK   * 13404851
* MUST BE HELD IN ORDER TO OBTAIN THE CMS LOCK.                       * 13405251
* DESTROYS REGS 11,12,13,14                                           * 13405351
* RETURN ON REG10                                             @ZA11392* 13405451
*********************************************************************** 13405751
         SPACE                                                          13405851
OBLOCKS  EQU   *                   OBTAIN LOCKS TO SERIALIZE USE        13405951
*                                  OF THE UCM                           13406051
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        X13406151
               RELATED=(UCM,IEAVMQWR,(FRLOCKS))                @ZA11392 13406251
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          X13406951
               RELATED=(UCM,IEAVMQWR,(FRLOCKS))                @ZA11392 13407251
         SPACE                                                          13407551
         SETFRR A,FRRAD=UCMFRRAD,PARMAD=(R12),WRKREGS=(R11,R12)  Y02755 13407651
         USING PARMLIST,R12        ADDRESSABILITY TO PARM AREA   Y02755 13407751
         MVC   PARMID,=CL4'CTSK'   LOAD MODULE ID                Y02755 13407851
         DROP  R12                                                      13407951
         BR    R10                 RETURN TO CALLER            @ZA11392 13408051
         EJECT                                                          13408551
FRLOCKS  DS    0H                  RELEASE LOCKS SUBROUTINE      Y02752 13408651
*                                                                Y02752 13408751
*   DESTROYS REGS 11,12,13,14                                    Y02752 13408851
*   RETURN ON REG 10                                             Y02752 13408951
*                                                                Y02752 13409002
         SPACE                                                          13410002
         SETFRR D,WRKREGS=(R11,R12)                              Y02755 13411002
         SPACE                                                          13412002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(UCM,IEAVMQWR(OBLOCKS))      X13412551
                                                               @ZA11392 13413051
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(UCM,IEAVMQWR(OBLOCKS))    X13413551
                                                               @ZA11392 13414051
         BR    R10                 RETURN TO CALLER              Y02752 13415002
         EJECT                                                          13416002
QWRREGS  EQU   *                   REGISTER EQUATES                     13417002
         SPACE                                                          13420002
R0       EQU   0                   GETMAIN REG                          13450002
R1       EQU   1                   ADDR OF PARM LIST OR INPUT CODE      13500002
R2       EQU   2                   PTR TO THE UCM                       13550002
R3       EQU   3                   PTR TO 1ST UCME                      13600002
R4       EQU   4                   PTR TO UCM PREFIX                    13650002
R5       EQU   5                   WORK REG                             13700002
R6       EQU   6                   WORK REG                             13750002
R7       EQU   7                   WORK REG                             13800002
R8       EQU   8                   PTR TO EIL                           13850002
R9       EQU   9                   BASE REGISTER                        13900002
R10      EQU   10                  PTR TO CVT, LINK TO FRLOCKS   Y02752 13950002
R11      EQU   11                  UCME LOOP REG, ACR WORK REG          14000002
R12      EQU   12                  UCME LOOP REG, ACR WORK REG          14050002
R13      EQU   13                  UCME LOOP REG, ACR WORK REG          14100002
R14      EQU   14                  BRANCH AND LINK REG                  14150002
R15      EQU   15                  BRANCH AND LINK REG                  14200002
ZERO     EQU   0                   USED FOR INDEXING                    14250002
ONE      EQU   1                   USED FOR SHIFT                       14300002
TWO      EQU   2                   OFFSET OF CPU ID INTO UCMARECB       14320002
THREE    EQU   3                   USED AS AN OFFSET             Y02756 14330002
FOUR     EQU   4                   LENGTH USED IN CLEARING ECBS         14350002
EIGHT    EQU   8                   USED AS AN OFFSET                    14400002
FIFTEEN  EQU   15                  USED FOR SHIFT                       14420002
SIXTEEN  EQU   16                  NO. OF BITS IN CPU ID MASK           14450002
TWENTY   EQU   20                  USED AS AN OFFSET           @ZA19273 14460051
THIRTY   EQU   30                  USED FOR SHIFT                       14470002
SVC72    EQU   72                  SVC 72                               14500002
MASK255  EQU   255                 USED TO TURN OFF FLAGS               14550002
X00      EQU   X'00'               USED TO CLEAR THE WAIT IN ECBS       14600002
X04      EQU   X'04'               EXTERNAL INTERRUPT CODE              14650002
X80      EQU   X'80'               INDICATES LAST ECB IN LIST           14700002
POST     EQU   X'40'               CHECK FOR POSTED ECB                 14850002
CCMASK   EQU   B'1100'             MASK FOR MOVING CPU ID FROM          15007002
*                                  UCMARECB                             15014002
ACRCODE  EQU   X'10'               INPUT CODE TO CONSOLE SWITCH         15021003
*                                  FOR  ACR                    @ZM34522 15025003
HCSWCODE EQU   X'02'               INPUT CODE TO CONSOLE SWITCH  Y02756 15029002
*                                    FOR HC SWITCH FROM SYSLOG   Y02756 15030002
HCSWCC   EQU   X'23'               UCMAECB COMPLETION CODE FOR   Y02756 15031002
*                                    HC SWITCH REQUEST FROM WTO  Y02756 15032002
CSMASK   EQU   B'0011'             MASK FOR STORING CPU ID INTO         15035002
*                                  CONSOLE SWITCH PARMS                 15036002
ONEBYTE  EQU   8                   USED TO ISOLATE EXTERNAL      Y02752 15037002
*                                     INTERRUPT COUNT            Y02752 15038002
ADDVSV   DC    A(IEAVMDSV)         ADDRESS OF DEVICE SERVICE ROUTINE    15050001
ADWTOSV  DC    A(IEAVMWSV)         ADDRESS OF WRITE SERVICE             15100001
ADDOM    DC    A(IEAVMDOM)         DOM PROCESSOR ROUTINE                15150001
SP255L64 DC    X'FF000040'         LSQA SUBPOOL 255, LENGTH 16 WORDS    15160001
WREXTNAM DC    CL8'IGC0407B'       NAME OF CONSOLE SWITCH ROUTINE       15200001
SPACE    DC    2CL25'** IEAVMQWR PATCH AREA **'                @G51APSS 15220051
         EJECT                                                          15310002
         CVT DSECT=YES                                                  15400001
         EJECT                                                          15450001
         IEECUCM FORMAT=NEW                                             15500001
         EJECT                                                          15510002
         IHACTM FTPT                                                    15520002
         EJECT                                                          15530002
         IHAFRRS                   REQUIRED FOR SETFRR                  15550002
         EJECT                                                          15600002
         IHAPSA                    REQUIRED FOR SETLOCK                 15650002
         END                                                            15700001
