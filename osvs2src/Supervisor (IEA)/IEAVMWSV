         TITLE 'IEAVMWSV - COMM TASK QUEUEING ROUTINE'                  00050002
IEAVMWSV CSECT                                                          00100001
* A 260502-260640,311200                                       @ZA01916 00103003
* C 001760,002730                                              @ZA01916 00106003
* C (ENQTSTCN) APPROX. 156500, C (ENQTSTCD) APPROX. 165000,    @ZA11370 00108003
* C (ENQQR01) APPROX. 211170, C (ENQMASTR) APPROX. 186000      @ZA11370 00108603
* C (ENQMASTR) APPROX. 185700                                  @ZA16551 00109303
***** START OF SPECIFICATIONS *******************************           00110002
*                                                                       00112002
*01*     MODULE-NAME=IEAVMWSV                                           00120002
*                                                                       00121002
*01*     DESCRIPTIVE-NAME= COMM TASK CONSOLE QUEUEING ROUTINE           00122002
*                                                                       00123002
*01*     COPYRIGHT=NONE                                                 00124002
*                                                                       00125002
*01*     STATUS=RELEASE 3                                      @ZA11370 00126003
*                                                                       00127002
*01*     FUNCTION= TO SELECTIVELY QUEUE MESSAGES TO CONSOLES' OUTPUT    00128002
*             QUEUES. THE CRITERIA FOR QUEUEING IS A FUNCTION OF        00129002
*             MESSAGE ROUTING CODES, THE MSGTYP PARAMETER, MCS FLAGS    00130002
*             AND TYPE OF CONSOLE. THIS MODULE ALSO DETERMINES IF THE   00131002
*             MESSAGE SHOULD BE HARDCOPIED.                             00133002
*                                                                       00134002
*02*          OPERATION= A WQE IS SELECTED FROM THE SYSTEM OUTPUT       00135002
*                  QUEUE. SUBROUTINE IEECMENQ IS INVOKED TO QUEUE THE   00136002
*                  WQE TO ALL APPROPRIATE CONSOLES. IT SEARCHES THE     00137002
*                  UCMES TO DETERMINE WHICH CONSOLES SHOULD RECEIVE     00138002
*                  THE MESSAGE. IF THE MESSAGE IS TO BE QUEUED,         00139002
*                  SUBROUTINE ENQCNSLE IS INVOKED TO CREATE A CQE       00140002
*                  ENTRY ON THE CONSOLE OUTPUT QUEUE. IF A WQE IS       00141002
*                  QUEUED TO AN INACTIVE CONSOLE, THE QREG0 PROCESSOR   00142002
*                  IS ATTACHED. IF A WQE WITH MSGTYPE IS FOUND AND      00143002
*                  THERE ARE MONITORING TSO TERMINALS, THE TPUT         00144002
*                  ROUTINE IS ATTACHED IF NECESSARY AND POSTED. WHEN    00145002
*                  ALL THE UCMES HAVE BEEN SEARCHED FOR ONE WQE,        00146002
*                  ANOTHER WQE IS SELECTED. WHEN THE QUEUE OF WQES IS   00147002
*                  EXHAUSTED, IEAVMDSV IS CALLED TO BEGIN OUTPUTTING    00148002
*                  THE MESSSAGES.                                       00149002
*                                                                       00150002
*01*     NOTES=NONE                                                     00151002
*                                                                       00152002
*02*          DEPENDENCIES= THERE IS A SYSGEN DEPENDENCY THAT THE TWO   00153002
*                  UCMES FOR A COMPOSITE CONSOLE ARE CONTIGUOUS WITH    00154002
*                  THE UCME FOR THE INPUT PORTION OF THE CONSOLE        00155002
*                  SPECIFIED FIRST.                                     00156002
*                                                                       00157002
*                  THE CALLER OF THIS ROUTINE MUST HOLD THE CMS AND     00158002
*                  LOCAL LOCKS.                                         00159002
*                                                                       00160002
*03*               CHARACTER-CODE-DEPENDENCIES= CHARACTER CODE          00161002
*                       INDEPENDENT                                     00161402
*                                                                       00162002
*02*          RESTRICTIONS= THE FOLLOWING REGISTERS AND FIELDS          00163002
*                  MUST BE PRESERVED ACROSS THE INTERFACE               00164002
*                  TO IEAVMDSV:                                         00165002
*                  R2= ADDR OF UCM                                      00166002
*                  R3= ADDR OF UCME                                     00167002
*                  R4= ADDR OF UCM PREFIX                               00168002
*                  R8= ADDR OF THE EIL                                  00169002
*                  R9= BASE REGISTER OF THE WAIT ROUTINE                00170002
*                  UCMSAVE0 IN UCM= RETURN ADDR TO THE WAIT             00171002
*                                   ROUTINE.                            00172002
*                                                                       00173002
*02*          REGISTER-CONVENTIONS= SEE LABEL WSVREGS                   00174002
*                                                                       00175002
*02*          PATCH-LABEL=PATCH                                @ZA01916 00176003
*                                                                       00177002
*01*     MODULE-TYPE=PROCEDURE                                          00178002
*                                                                       00179002
*02*          PROCESSOR=ASSEMBLER-370R                                  00180002
*                                                                       00181002
*02*          MODULE-SIZE=2500 BYTES                           @ZA16551 00182003
*                                                                       00183002
*02*          ATTRIBUTES= KEY 0, SUPERVISOR STATE, SERIALLY REUSABLE,   00184002
*                  RESIDES IN MASTER SCHEDULER MEMORY, PART OF  LOAD    00185002
*                  MODULE IEAVCTSK OF THE SYS1.LPALIB DATA SET.         00186002
*                                                                       00187002
*01*     ENTRY-POINT=IEAVMWSV                                           00188002
*                                                                       00189002
*02*          PURPOSE= TO QUEUE WQES ON THE SYSTEM OUTPUT QUEUE TO      00190002
*                  THE CONSOLES OUPUT QUEUES.                           00191002
*                                                                       00192002
*02*          LINKAGE= BRANCH AND LINK FROM IEAVMQWR WHEN THE WTO ECB   00193002
*                  IS POSTED                                            00194002
*                                                                       00195002
*02*          INPUT=    RO,R1,R3,R5-R9,R10-R13= IRRELEVANT              00196002
*                       R2=ADDR OF UCM                                  00197002
*                       R4=ADDR OF UCM PREFIX                           00198002
*                       R14=RETURN ADDR                                 00199002
*                       R15=ENTRY POINT ADDR                            00200002
*                                                                       00200402
*02*          OUTPUT=NONE                                               00200802
*                                                                       00201002
*02*          REGISTERS-SAVED=NONE                                      00202002
*                                                                       00203002
*02*          REGISTER-USAGE=R6,R7,R12,R10,R11,R13,R0,R1,R15            00204002
*                                                                       00205002
*02*          REGISTERS-RESTORED=NONE                                   00206002
*                                                                       00207002
*01*     ENTRY-POINT= IEECMENQ                                          00208002
*                                                                       00209002
*02*            PURPOSE= TO QUEUE A WQE TO ALL APPROPRIATE CONSOLES.    00210002
*                                                                       00211002
*02*          LINKAGE= BRANCH AND LINK FROM IEAVSWCH.  CONSOLE SWITCH   00212002
*                  CREATES ITS OWN WQE IN ORDER TO ISSUE A MESSAGE      00213002
*                  TO A CONSOLE AND CALLS THIS ROUTINE TO QUEUE IT.     00214002
*                                                                       00215002
*02*          INPUT=    R1=WQE ADDR                                     00216002
*                       R2=UCM ADDR                                     00217002
*                       R4=UCM PREFIX ADDR                              00218002
*                       R14=RETURN ADDR                                 00219002
*                       R15=ENTRY POINT ADDR                            00220002
*                       R0,R3,R5-R13= IRRELEVANT                        00221002
*                                                                       00221402
*02*          OUTPUT=NONE                                               00221802
*                                                                       00222002
*02*          REGISTERS-SAVED=R3-R14                                    00223002
*                                                                       00224002
*02*          REGISTER-USAGE=R0,R1,R3,R5-7,R9-13,R15                    00225002
*                                                                       00226002
*02*          REGISTERS-RESTORED=R3-R14                                 00227002
*                                                                       00228002
*01*     ENTRY-POINT=IEECMQCN                                           00229002
*                                                                       00230002
*02*          PURPOSE= TO CREATE A CQE ENTRY ON A GIVEN CONSOLES'S      00231002
*                  OUTPUT QUEUE.                                        00232002
*                                                                       00233002
*02*          LINKAGE= BRANCH AND LINK FROM IEAVMDSV TO QUEUE A         00234002
*                  HARDCOPY MESSAGE TO THE HARDCOPY CONSOLE.            00235002
*                                                                       00236002
*02*          INPUT=    R2=UCM ADDR                                     00237002
*                       R4=UCM PREFIX ADDR                              00238002
*                       R6=WQE ADDR                                     00239002
*                       R9=RETURN ADDR                                  00240002
*                       R11=UCME ADDR                                   00241002
*                       R1=ENTRY POINT ADDR                             00242002
*                                                                       00243002
*02*          OUTPUT=NONE                                               00243402
*                                                                       00243802
*02*          REGISTERS-SAVED=R3,R4,R15                                 00244002
*                                                                       00245002
*02*          REGISTER-USAGE=R0,R1,R5,R8,R10,R14,R15                    00246002
*                                                                       00247002
*02*          REGISTERS-RESTORED=R3,R4,R15                              00248002
*                                                                       00249002
*01*     EXIT-NORMAL= TO CALLER VIA BRANCH TO RETURN ADDR               00250002
*                                                                       00251002
*02*          CONDITIONS= FUNCTION COMPLETE                             00251402
*                                                                       00251802
*02*          OUTPUT=NONE                                               00252002
*                                                                       00253002
*02*          RETURN-CODES= NONE                                        00253402
*                                                                       00253802
*01*     EXIT-ERROR=NONE                                                00254002
*                                                                       00255002
*01*     EXTERNAL-REFERENCES=SEE BELOW                                  00256002
*                                                                       00257002
*02*          ROUTINES= WHEN ENTERED AT IEAVMWSV, IEAVMDSV IS CALLED    00258002
*                  TO BEGIN PROCESSING OUTPUT AFTER ALL THE WQES HAVE   00259002
*                  BEEN QUEUED.                                         00260002
*                                                                       00261002
*02*          DATA-AREAS=NONE                                           00262002
*                                                                       00263002
*02*          CONTROL-BLOCKS=IEAMMB-C,W,  IHAWQE-W,  IEECUCM-W,         00264002
*                  IHACTM(CQE)-C,W,  IHASCVT-R,  CVT-R                  00265002
*                                                                       00266002
*01*     TABLES=NONE                                                    00267002
*                                                                       00268002
*01*     MACROS=ATTACH, SETLOCK, GETMAIN                                00269002
*                                                                       00270002
*02*          SERIALIZATION= THE CMS AND LOCAL LOCKS ARE HELD           00271002
*                  TO SERIALIZE USE OF THE UCM, WQE AND CQE QUEUES.     00271402
*                                                                       00272002
*01*     CHANGE-ACTIVITY= ZA01916, OZ11370, OZ16551            @ZA16551 00273003
*                                                                       00274002
*01*     MESSAGES=NONE                                                  00275002
*                                                                       00276002
*01*     ABEND-CODES=NONE                                               00277002
*                                                                       00327002
**** END OF SPECIFICATIONS **************************************       00329102
         ENTRY IEECMENQ                                                 00329201
         ENTRY IEECMQCN                                                 00341001
          EJECT                                                         02050001
WSVREGS  DS    0H                  REGISTER-USAGE                Y02893 02060002
         SPACE ,                                                 Y02893 02070002
R0       EQU   0              WTOSERV- UNUSED                           02100001
*                             ENQ- PARAMETER REG, WORKREG ONLY          02150001
R1       EQU   1              PARAMETER REG, WORKREG ONLY               02200001
R2       EQU   2              UCM ADDRESS                               02250001
R3       EQU   3              WTOSERV- RESERVED                         02300001
*                             ENQ- MESSAGE ROUTED COUNT                 02350001
R4       EQU   4                   MCS UCM ADDRESS                      02400001
R5       EQU   5              WTOSERV- RESERVED                         02450001
*                             ENQ- WORKREG ONLY                         02500001
R6       EQU   6              WQE ADDRESS                               02550001
R7       EQU   7                  WTOSERV-WORKREG  ENQ- NON-GRPH COUNT  02600001
R8       EQU   8              WTOSERV- WORKREG                          02650001
*                             ENQ- UNUSED,WORKREG ONLY                  02700001
R9       EQU   9              WTOSERV- RESERVED                         02750001
*                             ENQ- WORKREG                              02800001
R10      EQU   10                 WTOSERV-BASE    ENQ-BASE              02850001
R11      EQU   11             WTOSERV- UNUSED   ENQ-  UCM ENTRY         02900001
R12      EQU   12             WTOSERV- UNUSED   ENQ-    BXLE            02950001
R13      EQU   13             WTOSERV- UNUSED   ENQ-    REGS            03000001
R14      EQU   14             RETURN REG                                03050001
R15      EQU   15             BRANCH REG                                03100001
ZERO     EQU   0                                                        03150001
ONE      EQU   1                                                        03200001
TWO      EQU   2                                                        03550001
THREE    EQU   3                                                        03600001
FOUR     EQU   4                                                        03650001
SEVEN    EQU   7                                                        03700001
EIGHT    EQU   8                   USED AS DIVISOR, OFFSET       Y02893 03740002
FOURTEEN EQU   14                                                       03790001
SIXTEEN  EQU   16                                                       03800001
SWMASK   EQU   255                                                      03950001
BLKLEN   EQU   24                                                       04000001
TWENTY5  EQU   25                  SHIFT VALUE TO MAKE MASK      S21002 04150001
POST     EQU   X'40'               POST FLAG IN AN ECB           Y02756 04200002
         EJECT                                                          04300001
         LR    R10,R15             SET UP BASE REGISTER          Y02893 04350002
         USING IEAVMWSV,R10        ESTABLISH ADDRESSABILITY      Y02893 04390002
         USING UCM,R2              PTR TO UCM - SET BY QWR       Y02893 04430002
         USING UCMPRFX,R4          PTR TO UCM PREFIX - SET UP BY Y02893 04470002
*                                  QWR                           Y02893 04510002
         USING UCMLIST,R11         PTR TO 1ST UCME               Y02893 04550002
         USING WQE,R6              PTR TO WQE                    Y02893 04590002
         SPACE  5                                                       04650001
         MODID                                                          04660002
         SPACE                                                          04680002
         L     R6,UCMWTOQ          GET 1ST WQE IN SYSTEM QUEUE          04700001
         SPACE                                                          04710002
WTOWQE   LA    R6,ZERO(R6)         ZERO HI BYTE                         04750001
         LTR   R6,R6               IS THIS LAST WQE                     04800001
         BZ    WTOMNEP             YES, DO MONITOR EPILOGUE      Y02756 04850002
         TM    WQEXA,WQESUSP       PROCESSING TEMPORILY          Y02757 04860002
*                                  SUSPENDED                     Y02757 04870002
         BO    WTONEXT             YES, DO NOT PROCESS WQE       Y02757 04880002
         TM    WQEAVAIL,WQEBUFE    NO,BUT HAS THIS WQE BEEN      Y02893 04900002
*                                  SERVICED                      Y02893 04920002
         BZ    WTOSERV             NO,GO TO SERVICE IT                  04950001
         CLI   WMJMMLW,ZERO        MAJOR WQE                     S21002 05000001
         BE    WTONEXT             NO                            S21002 05050001
         TM    WMJMMLW,WMJMMLWD    CHAIN ALTERED BY SVC 35       S21002 05100001
         BO    ALTMLWTO            YES, SERVICE CHAIN            Y02893 05150002
         SPACE                                                          05152002
WTONEXT  L     R6,WQELKP           GET NEXT WQE                         05160002
         B     WTOWQE              LOOP TO TEST FOR LAST                05170002
         SPACE 2                                                        05180002
WTOSERV  EQU   *                                                        05190002
         NI    WMJMMLW,SWMASK-WMJMMLWF   TURN OFF RE-USE FLAG    S21002 05196002
         SPACE                                                          05196402
         ST    R14,UCMSAVE0        SAVE RETURN ADDRESS TO ROUTER        05198002
         LR    R1,R6                                                    05198402
         L     R15,UCMQRTN                                              05198802
         BALR  R14,R15             GO TO ENQ RTN                        05199202
         L     R14,UCMSAVE0        RESTORE RETURN ADDRESS               05199602
         B     WTONEXT             GET NEXT WQE                         05199702
         EJECT ,                                                 Y02756 05199802
WTOMNEP  EQU   *                   MONITOR EPILOGUE                     05209802
*********************************************************************** 05219802
*                                                                     * 05229802
*        BEFORE EXIT TO THE DEVICE SERVICE ROUTINE TO BEGIN           * 05239802
*        PROCESSING CONSOLE OUTPUT QUEUES, A CHECK IS MADE TO         * 05249802
*        DETERMINE IF THE TPUT ROUTINE SHOULD BE ATTACHED.  IF        * 05259802
*        A MESSAGE WAS QUEUED FOR A MONITORING TERMINAL AND THE       * 05269802
*        TPUT ROUTINE IS NOT ATTACHED, IT IS ATTACHED HERE TO AVOID   * 05279802
*        RELEASING THE CMS LOCK WHILE PROCESSING THE SYSTEM OUTPUT    * 05289802
*        QUEUE.                                                       * 05299802
*                                                                     * 05309802
*********************************************************************** 05319802
         ST    R14,UCMSAVE0        SAVE RETURN ADDRESS TO ROUTER Y02756 05329802
         TM    UCMMNECB,POST       IS THE MONITOR ECB POSTED     Y02756 05339802
         BZ    WTODVSV             NO, NO NEED TO ATTACH         Y02756 05349802
         TM    UCMMODE,UCMTPUTA    IS THE TPUT ROUTINE ALREADY   Y02756 05359802
*                                  ATTACHED                      Y02756 05369802
         BO    WTODVSV             YES, NO NEED TO ATTACH        Y02756 05379802
         SPACE                                                          05389802
*                                                                Y02756 05399802
* NOTE:  SETLOCK WILL DESTROY REGISTERS 11,12,13,14              Y02756 05409802
*                                                                Y02756 05419802
         SPACE                                                          05429802
         SETFRR D,WRKREGS=(R11,R12)                              Y02755 05435802
         SPACE                                                          05441802
         SETLOCK RELEASE,TYPE=CMS,                                     *05449802
               RELATED=(UCM,IEAVMQWR(WRLOCK),IEAVMWSV(WTOMNEP))  Y02752 05451802
         SETLOCK RELEASE,TYPE=LOCAL,                                   *05459802
               RELATED=(UCM,IEAVMQWR(WRLOCK),IEAVMWSV(WTOMNEP))  Y02752 05461802
         ATTACH SF=(E,ATTPARM) ATTACH TPUT ROUTINE               Y02756 05469802
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        *05525802
               RELATED=(UCM,IEAVMWSV(WTOMNEP))                   Y02752 05527802
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          *05528202
               RELATED=(UCM,IEAVMWSV(WTOMNEP))                   Y02752 05528602
         SPACE                                                          05529002
         SETFRR A,FRRAD=UCMFRRAD,PARMAD=(R12),WRKREGS=(R11,R12)  Y02755 05529102
         USING PARMLIST,R12        ADDRESSABILITY TO PARM AREA   Y02755 05529202
         MVC   PARMID,CTSK         PUT LOAD MODULE ID            Y02755 05530202
         DROP  R12                                                      05531202
         SPACE                                                          05532202
         OI    UCMMODE,UCMTPUTA    INDICATE TPUT ROUTINE IS      Y02756 05533202
*                                  ATTACHED                      Y02756 05534202
         SPACE                                                          05535202
WTODVSV  SR    R1,R1               CODE=0 FOR OUTPUT                    05539802
         L     R15,ADDVSV          GET ADDR OF DEVSERV                  05549802
         BALR  R14,R15             GO TO DEVSERV                        05559802
         L     R14,UCMSAVE0        RESTORE RETURN ADDR                  05569802
         BR    R14                 RETURN TO WAIT ROUTINE               05579802
         EJECT ,                                                 Y02893 05589802
ALTMLWTO EQU   *                   SERVICE ALTERED MLWTO CHAIN          05599802
*********************************************************************** 05609802
*                                                                     * 05619802
*          MORE LINES MAY BE ADDED TO A MLWTO CHAIN AFTER IT HAS      * 05629802
*        BEEN QUEUED TO THE CONSOLES OUTPUT QUEUES.  A SEARCH IS      * 05639802
*        DONE OF THE CQE BLOCKS OF EACH UCME LOOKING FOR A MATCHING   * 05649802
*        WQE PTR IN THE CQE ENTRIES.  WHEN A MATCH IS FOUND,          * 05659802
*        OUTPUT PENDING IS INDICATED IN THE UCME.  IF THE MLWTO       * 05669802
*        SHOULD GO TO A MONITORING TSO TERMINAL, A MMB IS BUILT FOR   * 05679802
*        EACH TEXT LINE NOT ALREADY QUEUED FOR TPUT TO MONITORING     * 05689802
*        TERMINALS.                                                   * 05699802
*                                                                     * 05709802
*********************************************************************** 05719802
         SPACE                                                          05729802
         STM   R3,R14,UCMSVB0      SAVE REGS IN UCM SAVEAREA     Y02756 05730202
         SR    R8,R8               INIT NUMBER OF CQE ENTRIES    Y02756 05731802
         LA    R7,ONE              INIT START-AT-TOP INDICATOR   Y02893 05733802
         NI    WMJMMLW,SWMASK-WMJMMLWD TURN OFF ALTERED FLAG            05739802
         TM    WMJMMLW,WMJMMLWF    START AT TOP OF CHAIN         S21002 06050001
         BNO   ALTER5            NO                                     06100001
         SR    R7,R7               SET REG TO REMEMBER           S21002 06150001
         NI    WMJMMLW,SWMASK-WMJMMLWF   TURN OFF TOP FLAG       S21002 06200001
ALTER5   EQU   *                                                 S21002 06250001
         L     R11,UCMVEA          GET FIRST ENTRY POINTER       S21002 06300001
REQ      EQU   *                                                 S21002 06350001
         L     R12,UCMOUTQ         GET ITS QUEUE POINTER         S21002 06400001
         LTR   R12,R12             QUEUE EMPTY                   S21002 06450001
         BZ    REQ30               YES, CHECK NEXT ENTRY         S21002 06500001
REQ0     EQU   *                                                 S21002 06550001
         USING CQE,R12                                                  06600001
         TM    CQEFLAG,CQEENTR     VALID WQE ENTRY HERE ?               06650001
         BO    REQ2                YES                           S21002 06700001
REQ1     EQU   *                                                 S21002 06750001
         TM    CQEFLAG,CQEEOB     NEXT BLOCK ADDRESS             S21002 06800001
         BO    REQ4                YES                           S21002 06850001
         TM    CQEFLAG,CQEEOQ     END OF QUEUE                   S21002 06900001
         BO    REQ30               YES                           S21002 06950001
         LA    R12,FOUR(R12)       POINT TO NEXT ENTRY           S21002 07000001
         B     REQ0                TEST ENTRY                    S21002 07050001
REQ2     EQU   *                                                 S21002 07100001
         L     R13,CQEWQE          GET WQE POINTER                      07150001
         LA    R13,ZERO(R13)       CLEAR FLAGS                   S21002 07200001
         CLR   R13,R6              IS THE MLWTO THIS ONE         S21002 07250001
         BNE   REQ1                NO, CONTINUE LOOKUNG          S21002 07300001
         LA    R8,ONE(R8)          INCREMENT NUMBER OF CQES      Y02756 07310002
         TM    WMJMDEC1,WMJMDECH   DESCRIPTOR CODE 8                    07350001
         BNO   REQ2A               NO, INLINE WQE                S21002 07400001
         TM    WMJMDEC2,WMJMDECI   DESCRIPTOR CODE 9             S21002 07450001
         BNO   REQ2A               NO, INLINE WQE                S21002 07500001
         CLI   WMJMAREA,Z          AREA EQUAL Z                  S21002 07550001
         BE    REQ2A               YES, INLINE WQE               S21002 07600001
         LR    R0,R12              SAVE ENTRY POINTER            S21002 07650001
         LR    R1,R14              SAVE RETURN ADDRESS           S21002 07700001
         SR    R13,R13             CLEAR REGISTER                S21002 07750001
         IC    R13,UCMID           GET CONSOLE ID                S21002 07800001
         BCTR  R13,R0              REDUCE FOR ALGORITHM          S21002 07850001
         SR    R12,R12             CLEAR REGISTER                S21002 07900001
         LA    R15,EIGHT           GET DIVISOR                   S21002 07950001
         DR    R12,R15             DIVIDE ID BY 8                S21002 08000001
*        REG 13 HAS BYTE IN FIELD, REG 12 HAS BIT IN BYTE        S21002 08050001
         LA    R14,ONE             GET ONE BIT                   S21002 08100001
         SRDL  R14,TWENTY5(R12)    CREATE MASK                   S21002 08150001
         LA    R14,WMJMCONS        POINT TO FIELD IN MAJOR       S21002 08200001
         AR    R13,R14             POINT TO CORRECT BYTE         S21002 08250001
         LR    R12,R0              RESTORE                       S21002 08300001
         LR    R14,R1              REGISTERS                     S21002 08350001
         EX    R15,TESTWMJM        CAN I GO TO THIS CONSOLE FOR  S21002 08400001
*                                  THIS DISPLAY (FRAME NOT FULL) S21002 08450001
         BO    REQ3                NO, CONTINUE                  S21002 08500001
         OI    UCMSTS,UCMPF        OUTPUT PENDING AND            S21002 08550001
         OI    UCMSDS5,UCMSDS5C    OUT-OF-LINE OUTPUT PENDING    S21002 08600001
         B     REQ3                CONTINUE                      S21002 08650001
REQ2A    EQU   *                                                 S21002 08700001
         OI    UCMSTS,UCMPF        OUTPUT PENDING AND            S21002 08750001
         OI    UCMSDS5,UCMSDS5B    INLINE OUTPUT PENDING         S21002 08800001
REQ3     EQU   *                                                 S21002 08850001
         LTR   R7,R7               START AT TOP OF CHAIN         S21002 08900001
         BNZ   REQ30               NO                            S21002 08950001
         OI    CQEFLAG,CQEATTOP     TELL PROCESSORS              S21002 09000001
REQ30    EQU   *                                                 S21002 09050001
         A     R11,UCMVEZ          POINT TO NEXT ENTRY           S21002 09100001
         CL    R11,UCMVEL          WAS LAST ENTRY HANDLED        S21002 09150001
         BNH   REQ                 NO, LOOK AT THIS QUEUE        S21002 09200001
         LTR   R8,R8               ANY CQE ENTRIES FOUND         Y02756 09210002
         BNZ   REQ5                YES, CONTINUE                 Y02756 09220002
         OI    UCMSFLG2,UCMSYSI    NO, SET CLEANUP NEEDED FLAG   Y02756 09230002
         SPACE ,                                                 Y02756 09240002
REQ5     EQU   *                   TEST MSGTYPE                  Y02756 09242002
         TM    WQEMCSF1,WQEMCSD    WQE QUEUED BY MSGTYPE         Y02756 09244002
         BZ    ALTOUT              NO, EXIT                      Y02756 09246002
         L     R9,UCMMQPTR         GET PTR TO MONITOR QUEUE      Y02756 09248002
         LTR   R9,R9               IS THERE A MONITOR QUEUE      Y02756 09248402
         BZ    ALTMN               NO, CLEANUP AND EXIT          Y02756 09248802
         TM    WMJMBUF,WMJMBUFF    MAJOR QUEUED FOR TPUT         Y02756 09249202
         BZ    ALTOUT              NO, EXIT                      Y02756 09249602
         LA    R8,MNTRPROC         SET UP ADDR OF MNTRPROC       Y02756 09250302
*                                  SUBROUTINE                    Y02756 09251302
         L     R10,UCMQRTN         SET UP BASE REGISTER FOR      Y02756 09252302
*                                  CALL TO MNTRPROC SUBROUTINE   Y02756 09253302
         BALR  R9,R8               QUEUE ADDED MINORS FOR TPUT   Y02756 09254302
         SPACE                                                          09259802
ALTOUT   EQU   *                   EXIT FROM ALTMLWTO            Y02756 09263202
         LM    R3,R14,UCMSVB0      RESTORE REGS SAVED AT ENTRY   Y02756 09266602
*                                  TO ALTMLWTO                   Y02756 09276602
*                                  INCLUDES RESTORE OF BASE REG  Y02756 09278602
*                                  AFTER CALL TO MNTRPROC        Y02756 09280602
         B     WTONEXT             CONTINUE WITH NEXT WQE        Y02756 09283302
REQ4     EQU   *                                                 S21002 09300001
         L     R12,CQEWQE          POINT TO NEXT BLOCK                  09350001
         B     REQ0                CHECK ENTRIES                 S21002 09400001
         SPACE ,                                                 Y02756 09410002
ALTMN    EQU   *                   CLEANUP TPUT FLAGS            Y02756 09414002
         NI    WMJMBUF,SWMASK-WMJMBUFF TURN OFF POSSIBLE         Y02756 09418002
*                                  MAJOR QUEUED FOR TPUT FLAG    Y02756 09422002
*                                  SO THAT CHAIN CAN BE CLEANED  Y02756 09426002
*                                  UP EVEN THOUGH ALL MINORS     Y02756 09430002
*                                  HAVE NOT BEEN QUEUED FOR      Y02756 09434002
*                                  TPUT                          Y02756 09438002
         B     ALTOUT              EXIT                          Y02756 09442002
         SPACE 1                                                        09450001
TESTWMJM EQU   *                                                 S21002 09500001
         TM    ZERO(R13),ZERO      FRAME FULL BIT ON             S21002 09550001
         DROP  R12                 CQE BASE NO LONGER NEEDED     Y02893 09650002
         EJECT                                                          13300001
*********************************************************************** 13350001
*                                                                     * 13400001
*                       IEECMENQ                                      * 13450001
*                                                                     * 13500001
*        THIS ROUTINE DETERMINES THE APPROPRIATE CONSOLES TO          * 13550001
*        WHICH A SPECIFIED WQE IS TO BE QUEUED. WHEN EACH             * 13600001
*        APPROPRIATE CONSOLE IS FOUND, IEECMQCN IS CALLED             * 13650001
*        TO DO THE ACTUAL QUEUEING. AFTER ALL CONSOLES ARE            * 13700001
*        EXHAUSTED, IEECMENQ DETERMINES WHETHER THE WQE IS            * 13750001
*        TO GO TO HARDCOPY.                                           * 13800001
*                                                                     * 13850001
*        INPUT TO THIS ROUTINE CONSISTS OF THE FOLLOWING-             * 13900001
*              REGISTER 1- WQE ADDRESS                                * 13950001
*              REGISTER 2- UCM ADDRESS                                * 14000001
*              REGISTER 4- MCS UCM PREFIX ADDRESS                     * 14050001
*              REGISTER 14- RETURN ADDRESS                            * 14100001
*              REGISTER 15- ENTRY POINT ADDRESS                       * 14150001
*                                                                     * 14200001
*                                                                     * 14250001
*********************************************************************** 14300001
IEECMENQ EQU   *                   INTERNAL/EXTERNAL ENTRY POINT Y02893 14350002
         STM   R3,R14,UCMSVB0      SAVE REGS IN UCM SAVE AREA    Y02893 14380002
         LM    R11,R13,UCMVEA      INITIALIZE UCME BXLE REGS     Y02893 14410002
         LR    R10,R15             SET BASE REG - NEEDED FOR     Y02893 14440002
*                                  EXTERNAL CALL                 Y02893 14470002
         USING IEECMENQ,R10        ESTABLISH ADDRESSABILITY -    Y02893 14500002
*                                  NEEDED FOR EXTERNAL CALL      Y02893 14530002
         LR    R6,R1               SET UP WQE BASE               Y02893 14560002
         SR    R3,R3               INIT TOTAL COUNT              Y02893 14590002
         SR    R7,R7               INIT NON-GRAPHIC COUNT        Y02893 14640002
         SR    R0,R0               INIT OUTPUT-ONLY COUNT        Y02893 14690002
         TM    WQEMCSF,WQEMCSG     WQE FOR HARDCOPY ONLY         Y02893 14740002
         BZ    ENQWQE              NO,BRANCH                            14800001
         TM    WQEXA,WQEWTOR       YES, IS IT ALSO A WTOR        Y02893 14850002
         BZ    ENQSET              NO, SKIP CONSOLE QUEUEING     Y02893 14880002
         L     R11,UCMMCENT        YES, GET UCME ADDR OF MASTER  Y02893 14910002
         CL    R11,UCMHCUCM        IS MASTER ALSO HARDCOPY       Y02756 14940002
         BNE   ENQHCBYP            NO, BYPASS FLAG SETTING       Y02756 14970002
         OI    WQEXA,WQEQDFHC      YES, INDICATE QUEUED FOR HC   Y02756 15000002
ENQHCBYP EQU   *                   QUEUE WTOR TO MASTER          Y02756 15030002
         BAL   R9,ENQCNSLE         USE COMMON QUEUEING ROUTINE   Y02893 15060002
         B     ENQHCCHK            GO TO HARDCOPY ROUTINE        Y02893 15090002
         SPACE                                                          15180002
ENQSET   EQU   *                   HC ONLY - NOT A WTOR          Y02893 15210002
         OI    UCMSFLG2,UCMSYSI    YES, INDICATE CLEANUP NEEDED  Y02893 15230002
         OI    WQEAVAIL,WQEBUFC    INDICATE READY FOR HARDCOPY   Y02756 15250002
         B     ENQHCCHK            GO TO HARDCOPY ROUTINE        Y02893 15270002
ENQWQE   EQU   *                   START OF QUEUEING TESTS       Y02756 15300002
         TM    WQEMCSF1,WQEMCSH    Q BY ID UNCONDITIONALLY       Y02756 15330002
         BO    ENQQR01             YES, DO QREG0 TESTS           Y02756 15360002
ENQTSTCN TM    UCMSTS,UCMCF        IF CLOSE PENDING,                    15400001
         BO    ENQNEXT             OR DEVICE                            15450001
         TM    UCMATR,UCMUF       NOT ACTIVE                            15500001
         BC    FOURTEEN,ENQNEXT       DO NOT Q TO THIS CONSOLE          15550001
         TM    WQEMCSF1,WQEMCSFF     IF BROADCAST MSG,                  15600002
         BNO   ENQCONT             NO, CONTINUE WQE CHECK      @ZA11370 15650003
         L     R9,UCMCOMPC         GET COMP CONS ADR OR 0      @ZA11370 15655003
         LTR   R9,R9               IS THIS A COMPOSITE CONS    @ZA11370 15660003
         BZ    ENQGOOD             NO, CHECK HARDCOPY          @ZA11370 15665003
         TM    UCMATR,UCMOF        YES, OUTPUT UCME?           @ZA11370 15670003
         BNO   ENQNEXT             NO, GET NEXT UCME           @ZA11370 15675003
         B     ENQGOOD             YES, CHECK HARCOPY THEN     @ZA11370 15680003
ENQCONT  EQU   *                   QUEUE WQE TO THIS CONSOLE   @ZA11370 15685003
         SPACE ,                                                 Y02893 15700002
         TM    WQEMCSF,WQEMCSD     QUEUED BY MSGTYPE             Y02893 15780002
         BZ    ENQTSTCD            NO, CONTINUE WITH OTHER TESTS Y02893 15820002
         LH    R5,UCMMSG           GET MSGTYPE FLAGS FROM UCME          15860002
         SLL   R5,SIXTEEN         CLEAR HI TWO BYTES FOR N        19772 15900001
         SRL   R5,SIXTEEN         INSTRUCTION TO TEST MSGTYPE     19772 15950001
         N     R5,WQEMSGTP-TWO     Q TO THIS CONSOLE                    16000001
         BZ    ENQNEXT             GET NEXT ENTRY                       16050001
         B     ENQGOOD             GO TO Q MSG                          16100001
ENQTSTCD L     R5,UCMRTCD                                               16150001
         N     R5,WQEROUT          IF THE WQE ROUTING CODES             16200001
         BC    SEVEN,ENQGOOD        MATCH ANY OF THE CONSOLE'S CODES,   16250001
         TM    WQEMCSF,WQEMCSB    QUEUE TO THAT CONSOLE                 16300001
         BZ    ENQNEXT             IF A PARTICULAR CONSOLE              16350001
         CLC   WQEUCMID(ONE),UCMID  IS INDICATED, AND THIS IS           16450001
         BNE   ENQNEXT             THAT CONSOLE, Q TO THIS CONSOLE      16500001
         L     R9,UCMCOMPC         YES, IS THIS A COMPOSITE    @ZA11370 16505003
         LTR   R9,R9                CONSOLE?                   @ZA11370 16510003
         BZ    ENQGOOD             NO, QUEUE NORMALLY          @ZA11370 16515003
         TM    UCMATR,UCMOF        YES, OUTPUT UCME?           @ZA11370 16520003
         BO    ENQGOOD             YES, QUEUE NORMALLY         @ZA11370 16525003
*                                  OUTPUT UCME ALREADY IN R9.  @ZA11370 16527003
         CL    R9,UCMHCUCM         IS OUTPUT HALF HC?          @ZA11370 16535003
         BNE   ENQGOOD1            NO, SKIP HC FLAG SETTING    @ZA11370 16540003
         OI    WQEXA,WQEQDFHC      YES, SET HC FLAG IN WQE     @ZA11370 16545003
         B     ENQGOOD1            NO, QUEUE TO CNSLE        @ZA11370   16547003
ENQGOOD  EQU   *                   QUEUE IT                             16550002
         CL    R11,UCMHCUCM        IS THIS CONSOLE ALSO THE HC   Y02756 16630002
*                                  CONSOLE                       Y02756 16730002
         BNE   ENQGOOD1            NO, SKIP HC FLAGS SETTINGS    Y02756 16830002
         OI    WQEXA,WQEQDFHC      INDICATE QUEUED FOR HC        Y02756 16930002
ENQGOOD1 EQU   *                   QUEUE IT                      Y02756 17030002
         BAL   R9,ENQCNSLE         QUEUE TO CONSOLE                     17150001
ENQNEXT  BXLE  R11,R12,ENQWQE      GET NEXT CONSOLE ENTRY               17200001
         TM    WQEMCSF1,WQEMCSD    WQE QUEUED BY MSGTYPE         Y02756 17250002
         BZ    ENQCHK              NO, SKIP MONITOR PROCESSING   Y02756 17280002
         L     R11,UCMMQPTR        GET PTR TO MONITOR QUEUE      Y02756 17310002
         LTR   R11,R11             IS THERE A MONITOR QUEUE      Y02756 17340002
         BZ    ENQCHK              NO, SKIP MONITOR PROCESSING   Y02756 17370002
         BAL   R9,MNTRPROC         DO MONITOR PROCESSING         Y02756 17400002
         EJECT                                                          17430002
ENQCHK   EQU   *                   CHECK WHERE IT WAS QUEUED     Y02893 17460002
*********************************************************************** 17490002
*                                                                     * 17520002
*        THE FOLLOWING CODE DETERMINES WHERE THE WQE WAS QUEUED.      * 17550002
*        A WQE IS ALWAYS SENT TO SOME CONSOLE UNLESS IT IS A          * 17580002
*        MSGTYPE WQE.  IF IT HAS NOT BEEN QUEUED ANYWHERE, IT IS      * 17610002
*        SENT TO THE MASTER CONSOLE.                                  * 17640002
*                                                                     * 17670002
*********************************************************************** 17700002
         TM    WQEMCSF,WQEMCSB+WQEMCSH QUEUED BY ID              Y02893 17730002
         BZ    ENQWTOR             NO, CHECK FOR WTOR            Y02893 17760002
         CLI   WQEUCMID,ZERO       IS ID 0 - 0 ID IS USED TO     Y02893 17790002
*                                  DIRECT COMMAND RESPONSES TO   Y02893 17820002
*                                  THE MASTER CONSOLE WHEN THE   Y02893 17850002
*                                  COMMAND CAME FROM THE INPUT   Y02893 17880002
*                                  STREAM                        Y02893 17910002
         BNE   ENQWTOR             NO, CHECK FOR WTOR            Y02893 17940002
         L     R5,UCMMCENT         GET UCME FOR MASTER           Y02893 17970002
         L     R5,UCMRTCD-UCMLIST(R5) GET MASTERS ROUTE CODES    Y02893 18000002
         N     R5,WQEROUT          DO ANY ROUT CODES MATCH       Y02893 18030002
         BZ    ENQMASTR            NO, QUEUE WQE TO MASTER       Y02893 18060002
         SPACE                                                          18090002
ENQWTOR  EQU   *                   WTOR CHECK                    Y02893 18120002
         TM    WQEXA,WQEORE        IS THIS A WTOR                Y02893 18150002
         BZ    ENQNONE             NO, CHECK FOR NONE            Y02893 18180002
         LTR   R3,R3               IS TOTAL COUNT ZERO           Y02893 18210002
         BZ    ENQMASTR            YES, QUEUE TO MASTER          Y02893 18240002
         CR    R0,R3               QUEUED ONLY TO OUTPUT-ONLY    Y02893 18270002
*                                  CONSOLES                      Y02893 18300002
         BE    ENQMASTR            YES, QUEUE TO MASTER          Y02893 18330002
         SPACE                                                          18360002
ENQNONE  EQU   *                   NOT QUEUED CHECK              Y02893 18390002
         LTR   R3,R3               QUEUED TO ANY CONSOLE         Y02893 18420002
         BP    ENQHCCHK            YES, DO HC TESTS              Y02893 18450002
         TM    WQEMCSF1,WQEMCSD    QUEUED BY MSGTYPE             Y02893 18480002
         BZ    ENQMASTR            NO, QUEUE TO MASTER           Y02756 18530002
         TM    WQEMCSF1,WQEMCSE    WTO IN RESPONSE TO A WTOR     Y02756 18530402
         BO    ENQMASTR            YES,QUEUE TO MASTER           Y02756 18531202
         SPACE                                                          18532002
         OI    UCMSFLG2,UCMSYSI    SET WQE Q CLEANUP NEEDED FLAG Y02756 18534002
         B     ENQEND              GO TO SET SERVICED BIT        Y02756 18536002
         SPACE                                                          18540002
ENQMASTR EQU   *                   QUEUE TO MASTER CONSOLE       Y02893 18570002
         TM    WQEMCSF2,WQEMCSN    SHOULD HARDCOPY BY BYPASSED?@ZA16551 18570903
         BO    ENQMSCON            YES,CONTINUE MASTER QUEUEING@ZA16551 18571803
         L     R5,UCMHRDRT         GET HARDCOPY ROUT CODES.    @ZA16551 18572703
         N     R5,WQEROUT          DO ROUT CODES MATCH HARDCOPY@ZA16551 18573603
         BZ    ENQMSCON            NO, CONTINUE MASTER Q-ING   @ZA16551 18574503
         TM    UCMSFLG1,UCMSYSG    IS HARDCOPY SYSLOG?         @ZA16551 18575403
         BZ    ENQHCUCM            GET HARDCOPY UCME           @ZA16551 18576303
***************************************************************@ZA16551 18577203
* NEXT 3 STMTS WILL ALLOW A WQE TO BE AUEUED TO SYSLOG ONLY ON @ZA16551 18578103
* ENTRY TO IEAVMDSV WHEN SYSLOG IS HARDCOPY AND WQE ROUT CODES @ZA16551 18578503
* MATCH ONLY HARDCOPY ROUT CODES.                              @ZA16551 18578903
***************************************************************@ZA16551 18579903
         OI    WQEAVAIL,WQEBUFC    TURN ON READY FOR HARDCOPY  @ZA16551 18580803
         OI    WQEXA,WQEQFHC       TURN ON QUEUE FOR HARDCOPY  @ZA16551 18581203
         OI    UCMSFLG2,UCMSYSI    TURN ON CLEAN-UP NEEDED.    @ZA16551 18581703
         B     ENQCWTOR            CHECK WQE FOR WTOR TYPE     @ZA16551 18582103
ENQHCUCM EQU   *                   HERE TO CHECK HARDCOPY DEV  @ZA16551 18582603
         L     R11,UCMHCUCM        GET HARDCOPY DEV UCME OR 0  @ZA16551 18583503
         LTR   R11,R11             IS THERE A HARDCOPY DEVICE  @ZA16551 18584103
         BZ    ENQMSCON            NO, HARDCOPY NOT ACTIVE     @ZA16551 18585303
         OI    WQEXA,WQEQDFHC      INDICATE QUEUED FOR HARDCOPY@ZA16551 18586203
         BAL   R9,ENQCNSLE         QUEUE WQE TO HARDCOPY DEVICE@ZA16551 18587103
         L     R5,UCMMCENT         GET MASTER CONSOLE UCME     @ZA16551 18588003
         CL    R5,UCMHCUCM         IS MASTER CONS ALSO HARDCOPY@ZA16551 18588903
         BE    ENQHCCHK            YES, FINISH HARDCOPY PROCESS@ZA16551 18589803
         L     R5,UCMCOMPC-UCMECB(R5) GET OTHER HALF OF COMP.  @ZA16551 18590703
         LTR   R5,R5               IS MASTER CONSOLE A COMP    @ZA16551 18591603
         BZ    ENQCWTOR            NO, CHECK WQE FOR WTOR      @ZA16551 18592503
         CL    R5,UCMHCUCM         IS OTHER HALF HARCOPY DEV. @ZA16551  18593403
         BE    ENQHCCHK            YES, FINISH HARDCOPY PROCESS@ZA16551 18594303
ENQCWTOR EQU   *                   HERE TO CHECK FOR WTOR TYPE @ZA16551 18595203
         TM    WQEXA,WQEORE        IS WQE FOR A WTOR ?         @ZA16551 18596103
         BZ    ENQHCCHK            NO, DO NOT QUEUE WQE TO MAST@ZA16551 18597003
ENQMSCON EQU   *                   HERE TO QUEUE WQE TO MASTER @ZA16551 18597903
         L     R11,UCMMCENT        GET UCME OF MASTER            Y02893 18600002
         L     R9,UCMCOMPC         IS MASTER A COMPOSITE       @ZA11370 18603003
         LTR   R9,R9                  CONSOLE                  @ZA11370 18606003
         BZ    ENQMHCK             NO, CHECK MASTER FOR HC     @ZA11370 18609003
         TM    UCMATR,UCMOF        YES, IS THIS OUTPUT UCME    @ZA11370 18612003
         BO    ENQMHCK             YES, CHECK MASTER FOR HC    @ZA11370 18615003
         CL    R9,UCMHCUCM         NO, DOES OUTPUT HALF = HC   @ZA11370 18618003
         BNE   ENQCN               NO, QUEUE TO MASTER         @ZA11370 18621003
         B     ENQMSTHC            YES, QUEUE TO MASTER FOR HC @ZA11370 18624003
ENQMHCK  EQU   *                   CHECK MASTER FOR HC         @ZA11370 18627003
         CL    R11,UCMHCUCM        IS MASTER ALSO HC CONSOLE     Y02893 18630002
         BNE   ENQCN               NO, BYPASS FLAG SETTING       Y02893 18660002
ENQMSTHC EQU   *                   MASTER CONSOLE HARDCOPY     @ZA11370 18670003
         OI    WQEXA,WQEQDFHC      INDICATE QUEUED FOR HC        Y02893 18690002
         SPACE                                                          18750002
ENQCN    EQU   *                   QUEUE IT                      Y02893 18780002
         BAL   R9,ENQCNSLE         CALL ENQCNSLE TO QUEUE IT     Y02893 18810002
         EJECT                                                          18840002
ENQHCCHK EQU   *                   DETERMINE IF WQE SHOULD BE    Y02893 18870002
*                                  HARDCOPIED                           18900002
*********************************************************************** 18930002
*                                                                     * 18960002
*        THE FOLLOWING CODE DETERMINES IF THE WQE SHOULD BE           * 18990002
*        HARDCOPIED AND FLAGS THE WQE IF NECESSARY.                   * 19020002
*                                                                     * 19050002
*        A WQE THAT IS NOT A COMMAND RESPONSE OR A STATUS             * 19080002
*        DISPLAY IS HARDCOPIED IF                                     * 19110002
*           1) IT WAS QUEUED TO GRAPHIC CONSOLES ONLY OR              * 19140002
*           2) ITS ROUTE CODES MATCH ONE OF THE HARDCOPY ROUTE        * 19170002
*              CODES.                                                 * 19200002
*                                                                     * 19230002
*        A WQE THAT IS A COMMAND RESPONSE BUT NOT A STATUS            * 19260002
*        DISPLAY IS HARDCOPIED IF THE CMDS, STCMDS OR INCMDS          * 19290002
*        HARDCOPY OPTION IS SPECIFIED.                                * 19320002
*                                                                     * 19350002
*        A WQE THAT IS A STATUS DISPLAY IS HARDCOPIED IF              * 19380002
*          1) IT IS A STATIC DISPLAY AND STCMDS OR CMDS IS            * 19410002
*             SPECIFIED OR                                            * 19440002
*          2) IT IS A DYNAMIC DISPLAY AND CMDS IS SPECIFIED.          * 19470002
*                                                                     * 19500002
*********************************************************************** 19530002
         SPACE ,                                                        19560002
         TM    WQEMCSF2,WQEMCSN    SHOULD HARDCOPY BE BYPASSED   Y02893 19590002
         BO    ENQEND              YES, SKIP HARDCOPY TESTS      Y02893 19630002
         TM    UCMSFLG1,UCMSYSG    IS HARDCOPY SYSLOG            Y02893 19670002
         BO    ENQHCTST            YES, DO HARDCOPY TESTS        Y02893 19710002
         L     R11,UCMHCUCM        GET UCME ADDR OF HC CONSOLE   Y02893 19750002
         LTR   R11,R11             IS THERE A HC CONSOLE         Y02893 19790002
         BZ    ENQEND              NO, HARDCOPY NOT WANTED       Y02893 19830002
         SPACE ,                                                 Y02893 19870002
ENQHCTST EQU   *                   HARDCOPY TESTS                Y02893 19910002
         CLI   WMJMMLW,ZERO        IS WQE FOR A MLWTO            Y02893 19950002
         BE    ENQHCCR             NO, CANNOT BE A STATUS DISP   YM5570 19990002
         TM    WMJMDEC1,WMJMDECH   DESC CODE 8                   Y02893 20030002
         BZ    ENQHCCR             NO, CANNOT BE A STATUS DISP.  Y02893 20070002
         TM    WMJMDEC2,WMJMDECI   DESC CODE 9                   Y02893 20110002
         BZ    ENQHCCR             NO, CANNOT BE A STATUS DISP   Y02893 20150002
         TM    WMJMDEC2,WMJMDECJ   DESC CODE 10                  Y02893 20190002
         BZ    ENQHCSSD            NO, MUST BE A STATIC STATUS   Y02893 20230002
*                                  DISPLAY                       Y02893 20270002
*                                  YES, IT IS A DYNAMIC STATUS   Y02893 20310002
*                                  DISPLAY                       Y02893 20350002
         TM    UCMSFLG1,UCMSYSC    CMDS HARDCOPIED               Y02893 20390002
         BZ    ENQEND              NO, DO NOT HARDCOPY           Y02893 20430002
         SPACE ,                                                 Y02893 20470002
ENQHCQF  EQU   *                   HARDCOPY TEST SUCCESSFUL      Y02893 20510002
         OI    WQEXA,WQEQFHC       INDICATE QUEUE FOR HARDCOPY   Y02893 20550002
         SPACE ,                                                 Y02893 20590002
ENQEND   OI    WQEAVAIL,WQEBUFE   MARK WQE SERVICED                     20700001
         MVC   WQERTCT(ONE),WQEUSE SAVE ROUTED USE COUNT                20750001
         LR    R1,R6                                                    20900001
         LM    R3,R14,UCMSAVE0+FOUR RESTORE REGS                        20950001
         BR    R14                 RETURN                               21000001
         SPACE ,                                                 Y02893 21050002
ENQHCSSD EQU   *                   HC TESTS FOR STATIC STATUS    Y02893 21050502
*                                  DISPLAY                       Y02893 21051002
         TM    UCMSFLG1,UCMSYSC    CMDS HARDCOPIED               Y02893 21051502
         BO    ENQHCQF             YES, GOOD FOR HARDCOPY        Y02893 21052002
         TM    UCMSDS1,UCMSDS1A    STCMDS HARDCOPIED             Y02893 21052502
         BO    ENQHCQF             YES, GOOD FOR HARDCOPY        Y02893 21053002
         B     ENQEND              NO, DO NOT HARDCOPY           Y02893 21053502
         SPACE ,                                                 Y02893 21054002
ENQHCCR  EQU   *                   HC TESTS FOR NON-STATUS-      Y02893 21054502
*                                  DISPLAY                       Y02893 21055002
         TM    WQEMCSF1,WQEMCSC    COMMAND RESPONSE              Y02893 21055502
         BZ    ENQHCOLY            NO, DO OTHER HC TESTS         Y02893 21056002
         TM    UCMSFLG1,UCMSYSC    CMDS HARDCOPIED               Y02893 21056502
         BO    ENQHCQF             YES, GOOD FOR HC              Y02893 21057002
         TM    UCMSDS1,UCMSDS1A+UCMSDS1B STCMDS OR INCMDS        Y02893 21057502
*                                  HARDCOPIED                    Y02893 21058002
         BZ    ENQEND              NO, DO NOT HC                 Y02893 21058502
         B     ENQHCQF             YES, GOOD FOR HC              Y02893 21059002
         SPACE ,                                                 Y02893 21059502
ENQHCOLY EQU   *                   NORMAL HC TESTS               Y02893 21060002
         TM    WQEMCSF,WQEMCSG     WQE FOR HC ONLY               Y02893 21060502
         BO    ENQHCQF             YES, GOOD FOR HC              Y02893 21061002
         LTR   R7,R7               IS NON-GRAPHIC COUNT 0        Y02893 21061502
         BZ    ENQHCQF             YES, Q'D TO GRAPHICS ONLY -   Y02893 21062002
*                                  GOOD FOR HC                   Y02893 21062502
         TM    WQEMCSF1,WQEMCSD    MSGTYPE WQE                   Y02893 21063002
         BO    ENQEND              YES, IGNORE ROUTE CODES - DO  Y02893 21063502
*                                  NOT HARDCOPY                  Y02893 21064002
         L     R5,UCMHRDRT         GET HC ROUTE CODES            Y02893 21064502
         N     R5,WQEROUT          DO ANY ROUTE CODES IN WQE     Y02893 21065002
*                                  MATCH HC ROUTE CODES          Y02893 21065502
         BZ    ENQEND              NO, DO NOT HC                 Y02893 21066002
         B     ENQHCQF             YES, GOOD FOR HC              Y02893 21066502
         EJECT                                                          21067002
MNTRPROC EQU   *                   MONITOR PROCESSING            Y02756 21067502
*********************************************************************** 21068002
*                                                                     * 21068502
*        THE FOLLOWING SUBROUTINE PROCESSES A WQE WHICH IS TO BE      * 21069002
*        QUEUED FOR TPUT TO MONITORING TERMINALS.  IT IS CALLED       * 21069502
*        DURING NORMAL QUEUEING FROM IEECMENQ AND FOR AN ALTERED      * 21070002
*        MLWTO CHAIN FROM ALTMLWTO.  A MONITOR MESSAGE BLOCK IS       * 21070502
*        CREATED AND QUEUED FOR EACH TEXT LINE.  FOR A                * 21071002
*        MLWTO THE MAJOR AND MINORS ARE ALSO MARKED QUEUED FOR        * 21071502
*        TPUT TO AVOID REQUEUEING IF THE CHAIN IS ALTERED.            * 21072002
*                                                                     * 21072502
*        INPUT - R6=WQE ADDR                                          * 21073002
*                R9=RETURN ADDR                                       * 21073502
*                                                                     * 21074002
*        USAGE - R8=MINOR ADDR, R10,R11,R14,R15=USED FOR POST         * 21074502
*                                                                     * 21075002
*********************************************************************** 21075502
         CLI   WMJMMLW,ZERO        MAJOR WQE                     Y02756 21076002
         BE    MNTRNORM            NO, BUILD MMB FOR NORMAL      Y02756 21076502
         TM    WMJMBUF,WMJMBUFF    MAJOR ALREADY QUEUED FOR TPUT Y02756 21077002
         BO    MNTRMAJ1            YES, SKIP MMB BUILD           Y02756 21077502
         LR    R8,R6               SET UP INPUT TO BUILDMMB      Y02756 21078002
         BAL   R12,BUILDMMB        GET, BUILD, AND CHAIN A MMB   Y02756 21078502
         OI    WMJMBUF,WMJMBUFF    MARK MAJOR QUEUED FOR TPUT    Y02756 21079002
         SPACE                                                          21079502
MNTRMAJ1 EQU   *                                                 Y02756 21080002
         TM    WMJMLTY1,WMJMLTYD   IS MAJOR ALSO THE END LINE    Y02756 21080502
         BO    MNTREND             YES, ALL DONE                 Y02756 21081002
         TM    WMJMMLW,WMJMMLWH    IS FIRST MINOR A DUMMY        Y02756 21081502
         BO    MNTREND             YES, ALL DONE                 Y02756 21082002
         L     R8,WMJMMIN          GET PTR TO FIRST MINOR        Y02756 21082502
         USING WQE,R8              ADDRESSABILITY TO MINORS      Y02756 21083002
         SPACE                                                          21083502
MNTRMINL EQU   *                   MINOR LOOP                    Y02756 21084002
         LTR   R8,R8               DOES MINOR EXIST              Y02756 21084502
         BZ    MNTREND             NO, ALL DONE                  Y02756 21085002
         CLI   WMNMTL1,ZERO        IS MINOR TEXT LENGTH 0        Y02756 21085502
         BE    MNTRENDL            YES, MUST BE END LINE, ALL    Y02756 21086002
*                                  DONE                          Y02756 21086502
         TM    WMNMST1,WMNMTPD1    MINOR ALREADY QUEUED FOR TPUT Y02756 21087002
         BO    MNTRMINE            YES, SKIP MMB BUILD           Y02756 21087502
         BAL   R12,BUILDMMB        GET, BUILD, AND CHAIN A MMB   Y02756 21088002
*                                  FOR THE MINOR                 Y02756 21088502
         OI    WMNMST1,WMNMTPD1    MARK MINOR QUEUED FOR TPUT    Y02756 21089002
         SPACE                                                          21089502
MNTRMINE EQU   *                   CHECK FOR END IN MINOR        Y02756 21090002
         TM    WMNMLT1,WMNMLT1D    END LINE IN MINOR             Y02756 21090402
         BO    MNTREND             YES, ALL DONE                 Y02756 21090802
         L     R8,WMNMEXT          GET PTR TO NEXT MINOR         Y02756 21091202
         LA    R8,ZERO(R8)         CLEAR THE USE COUNT           Y02756 21091602
         B     MNTRMINL            PROCESS NEXT MINOR            Y02756 21092002
         SPACE ,                                                 Y02756 21092902
MNTRENDL EQU   *                   END LINE ONLY MINOR           Y02756 21093502
         TM    WMNMML1,WMNMML1F    ABEND'S MINOR                 Y02756 21094102
         BO    MNTREND             YES, SKIP FLAG SETTING        Y02756 21094702
         OI    WMNMST1,WMNMTPD1    INDICATRE QUEUED FOR TPUT     Y02756 21095302
         DROP  R8                  GIVE UP ADDRESSABILITY TO     Y02756 21096002
*                                  MINORS                        Y02756 21096402
         SPACE                                                          21096802
MNTREND  EQU   *                   NOTIFY TPUT ROUTINE VIA POST  Y02756 21097402
         LA    R11,UCMMNECB        ADDR OF MONITOR ECB           Y02756 21098102
         L     R15,CVTPTR          CVT POINTER                   Y02756 21098802
         USING CVT,R15             ADDRESSABILITY TO CVT         Y02756 21099502
         L     R15,CVT0PT01        ENTRY POINT OF POST           Y02756 21100202
         DROP  R15                 GIVE UP CVT BASE              Y02756 21100902
         ST    R10,UCMSAVE4        SAVE BASE REG                 Y02756 21101602
         LA    R10,ZERO            COMPLETION CODE               Y02756 21101802
         BALR  R14,R15             BRANCH TO POST                Y02756 21102002
         L     R10,UCMSAVE4        RESTORE BASE REG              Y02756 21102102
         BR    R9                  RETURN TO CALLER              Y02756 21102202
         SPACE                                                          21102802
MNTRNORM EQU   *                   NORMAL WQE                    Y02756 21103402
         LR    R8,R6               SET UP INPUT FOR BUILDMMB     Y02756 21104002
         BAL   R12,BUILDMMB        GET, BUILD AND CHAIN A MMB    Y02756 21104602
         B     MNTREND             GO DO POST                    Y02756 21105202
         EJECT                                                          21105802
ENQQR01  EQU   *                   QREG0 TESTS                   Y02756 21106402
         SPACE                                                          21107002
*********************************************************************** 21107602
*                                                                     * 21108202
*        IF A WQE INDICATES IT SHOULD BE QUEUED UNCONDITIONALLY       * 21108802
*        BY CONSOLE ID AND THE CONSOLE IS INACTIVE, THE WQE IS        * 21109402
*        QUEUED TO THE INACTIVE CONSOLE AND THE QREG0 PROCESSOR       * 21110002
*        IS ATTACHED.  THE QREG0 PROCESSOR WILL ISSUE A WTOR SO       * 21110602
*        THAT THE SYSTEM OPERATOR MAY DELETE OR REROUTE THE MSG.      * 21111202
*                                                                     * 21111802
*********************************************************************** 21112402
         SPACE                                                          21113002
         CLC   WQEUCMID(ONE),UCMID IS THIS THE SPECIFIED CONSOLE Y02756 21113602
         BNE   ENQTSTCN            NO, CONTINUE NORMAL TESTS     Y02756 21114202
         TM    UCMSTS,UCMCF        IS CLOSE PENDING              Y02756 21114802
         BO    ENQNEXT             YES, IGNORE QREG0 REQUEST     Y02756 21116602
         TM    UCMATR,UCMUF        IS THE CONSOLE ACTIVE         Y02756 21116802
         BNO   QREG0               NO, QUEUE UNCONDITIONALLY   @ZA11370 21117003
         L     R9,UCMCOMPC         YES, IS THIS A COMPOSITE    @ZA11370 21117103
         LTR   R9,R9                CONSOLE?                   @ZA11370 21117203
         BZ    ENQGOOD             NO, QUEUE NORMALLY          @ZA11370 21117303
         TM    UCMATR,UCMOF             YES, OUTPUT UCME?      @ZA11370 21117603
         BO    ENQGOOD             YES, QUEUE NORMALLY         @ZA11370 21118103
*                                  OUTPUT UCME ADDR IN REG 9   @ZA11370 21118203
         CL    R9,UCMHCUCM         IS OUTPUT HALF HC?          @ZA11370 21118803
         BNE   ENQGOOD1            NO, SKIP HC FLAG SETTING    @ZA11370 21118903
         OI    WQEXA,WQEQDFHC      YES, SET HC FLAG IN WQE     @ZA11370 21119003
         B     ENQGOOD1            NO, QEUE TO ACTIVE CONSOLE @ZA11370  21119103
QREG0    EQU   *                   UNCONDITIONALLY             @ZA11370 21119203
         SPACE                                                          21119303
         BAL   R9,ENQCNSLE         QUEUE TO CONSOLE              Y02756 21119403
         SPACE                                                          21119503
*                                                                       21119602
*        USE THE BRANCH ENTRY TO GETMAIN TO GET SPACE FOR A      Y02756 21120202
*        PARMATER LIST FOR IEAVMQR0 FROM SUBPOOL 250             Y02756 21120502
*        REGS 0,1,3,4,7,14,15 ARE USED FOR THE BRANCH TO GETMAIN Y02756 21120802
*        REGS 11,12,13,14 WILL BE DESTOYED BY SETLOCK BEFORE     Y02756 21121002
*        ATTACH.                                                 Y02756 21121202
*                                                                       21121402
         STM   R0,R4,UCMSAVE4      SAVE REGS NEEDED FOR GETMAIN  Y02756 21122002
         ST    R7,UCMSAVE4+20      SAVE REGS NEEDED FOR GETMAIN  Y02756 21122602
         STM   R11,15,UCMSAVE4+24  SAVE REGS NEEDED FOR GETMAIN  Y02756 21123802
*                                  AND SETLOCK                   Y02756 21124102
         L     R4,UCMPXA           GET COMMTASKS TCB ADDR        Y02756 21124402
         L     R7,UCMASCB          GET COMMTASKS ASCB ADDR       Y02752 21125002
         GETMAIN R,LV=QR0PSIZE,SP=QR0PSP,BRANCH=YES GET QR0PLIST Y02756 21125602
*                                                                       21133402
*        BUILD QREG0 PARAMETER LIST                                     21134002
*                                                                       21134602
         LA    R3,FOUR(R1)         SET PARAMETER LIST BASE       Y02756 21134902
         ST    R3,ZERO(R1)         STORE PTR TO PARM LIST        Y02756 21135202
         USING QR0,R3              ADDRESSABILITY TO PLIST MAP   Y02756 21136402
         ST    R6,QR0WQE           WQE ADDRESS                   Y02756 21137002
         ST    R11,QR0UCME         UCME ADDR OF INACTIVE CONSOLE Y02756 21140002
         ST    R2,QR0UCM           UCM ADDR                      Y02756 21140302
         LA    R0,IEECMQCN         GET ADDR OF CQE CREATE RTN    Y02756 21140602
         ST    R0,QR0CMQCN         STORE IN QREG0 PARM LIST      Y02756 21140802
         SPACE                                                          21140902
         SETFRR D,WRKREGS=(R11,R12)                              Y02755 21141002
         SPACE                                                          21141202
*        SETLOCK WILL DESTROY REGS 11, 12, 13, 14                Y02751 21142802
         SPACE                                                          21144402
         SETLOCK RELEASE,TYPE=CMS,                                     C21145202
               RELATED=(UCM,IEAVMQWR(WRLOCK))                    Y02751 21146002
         SETLOCK RELEASE,TYPE=LOCAL,                                   C21146402
               RELATED=(UCM,IEAVMQWR(WRLOCK))                    Y02751 21147702
         ATTACH EP=IEAVMQR0,SF=(E,ATTPARM) ATTACH QREG0 ROUTINE  Y02756 21147902
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        C21148102
               RELATED=(UCM,IEAVMQWR(WRLOCK))                    Y02751 21149002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                          C21149602
               RELATED=(UCM,IEAVMQWR(WRLOCK))                    Y02751 21150202
         SPACE                                                          21150802
         SETFRR A,FRRAD=UCMFRRAD,WRKREGS=(R11,R12),PARMAD=(R12)  Y02755 21151102
         USING PARMLIST,R12        ADDRESSABILITY TO PARM AREA   Y02755 21151402
         MVC   PARMID,CTSK         PUT LOAD MODULE ID IN PARMS   Y02755 21151602
         DROP  R12                                                      21151802
         SPACE                                                          21152002
*                                                                       21152602
*        RESTORE REGISTERS                                              21153202
*                                                                       21153802
         LM    R0,R4,UCMSAVE4      RESTORE REGISTERS             Y02756 21154402
         L     R7,UCMSAVE4+20      RESTORE REGISTERS             Y02756 21155002
         LM    R11,R15,UCMSAVE4+24 RESTORE REGISTERS             Y02756 21155602
         B     ENQNEXT             TEST NEXT UCME                Y02756 21156202
         EJECT                                                          21156802
BUILDMMB EQU   *                   GET, BUILD, AND QUEUE A MMB   Y02756 21158602
         USING WQE,R8                                            Y02756 21159602
         STM   R0,R4,UCMSAVE4      SAVE REGS AROUND GETMAIN      Y02756 21160602
         ST    R7,UCMSAVE4+20      SAVE REGS AROUND GETMAIN      Y02756 21161602
         STM   R14,R15,UCMSAVE4+24 SAVE REGS AROUND GETMAIN      Y02756 21162602
         SPACE ,                                                 Y02756 21163602
*   GET SPACE FOR A NEW MMB                                      Y02756 21164602
         SPACE ,                                                 Y02756 21165602
         L     R4,UCMPXA           GET COMMTASK TCB ADDRESS      Y02756 21166602
         L     R7,UCMASCB          GET COMMTASK ASCB ADDRESS     Y02756 21167602
         GETMAIN R,LV=MMBSIZE,SP=MMBSUBPL,BRANCH=YES GET MMB     Y02756 21168602
         USING MMB,R1              ADDRESSABILITY TO NEW MMB     Y02756 21169602
         SPACE ,                                                 Y02756 21170602
*   BUILD THE NEW MMB WITH DATA FROM THE WQE                     Y02756 21171602
         SPACE ,                                                 Y02756 21172602
         XC    MMB(MMBSIZE),MMB    CLEAR THE NEW MMB             Y02756 21173602
         MVC   MMBNAME,=CL4'MMB '  PUT IN CONTROL BLOCK ID       Y02756 21174602
         TM    WMJMMLW,WMJMMLWC    IS THIS A MINOR WQE           Y02756 21175602
         BO    BLDMMBMI            YES, BUILD MMB FOR A MINOR    Y02756 21176602
         MVC   MMBTXLN,WQENBR+2    COPY TEXT LENGTH FROM WQE     Y02756 21177602
         MVC   MMBTYPE,WQEMSGTP    COPY MSG TYPE FROM WQE        Y02756 21178602
         MVC   MMBTEXT,WQETXT      COPY TEXT FROM WQE            Y02756 21179602
         SPACE ,                                                 Y02756 21180602
*   CHAIN THE NEW MMB TO THE END OF THE MMB QUEUE                Y02756 21181602
         SPACE ,                                                 Y02756 21182602
BLDMMBCH DS    0H                  CHAIN THE NEW MMB             Y02756 21183602
         NC    UCMMBPTR,UCMMBPTR   IS THE MMB QUEUE EMPTY        Y02756 21184602
         BZ    BLDMMBH             YES, GO SET QUEUE HEAD PTR    Y02756 21185602
         L     R4,UCMMBEND         GET PTR TO LAST MMB           Y02756 21186602
         ST    R1,MMBLINK-MMB(R4)  SET FORWARD CHAIN PTR IN OLD  Y02756 21187602
*                                     LAST MMB                   Y02756 21188602
         MVC   MMBBKPTR,UCMMBEND   SET BACK PTR IN NEW MMB       Y02756 21189602
         B     BLDMMBT             SKIP SETTING QUEUE HEAD PTR   Y02756 21190602
         SPACE ,                                                 Y02756 21191602
BLDMMBH  DS    0H                  SET QUEUE HEAD PTR            Y02756 21192602
         ST    R1,UCMMBPTR                                       Y02756 21193602
BLDMMBT  DS    0H                  SET QUEUE TAIL PTR            Y02756 21194602
         ST    R1,UCMMBEND                                       Y02756 21195602
         LM    R0,R4,UCMSAVE4      RESTORE REGS                  Y02756 21196602
         L     R7,UCMSAVE4+20      RESTORE REGS                  Y02756 21197602
         LM    R14,R15,UCMSAVE4+24 RESTORE REGS                  Y02756 21198602
         BR    R12                 RETURN TO CALLER              Y02756 21199602
         SPACE ,                                                 Y02756 21200602
*   MMB BUILD FOR A MINOR                                        Y02756 21201602
         SPACE ,                                                 Y02756 21202602
BLDMMBMI DS    0H                  MMB BUILD FOR A MINOR         Y02756 21203602
         MVC   MMBTXLN+ONE,WMNMTL1 TEXT LENGTH                   Y02756 21204602
         MVC   MMBTEXT(WMNMST1-WMNMTXT1),WMNMTXT1 TEXT           Y02756 21205602
         MVC   MMBTYPE,WMJMMT-WMJM(R6) MSGTYPE FROM MAJOR WQE    Y02756 21206602
         B     BLDMMBCH            ADD THE NEW MMB TO THE CHAIN  Y02756 21207602
         DROP  R8                                                Y02756 21208602
         EJECT                                                          21221102
*        DEFINED CONSTANTS AND SOME EQUATES                             21227202
ADDVSV   DC    V(IEAVMDSV)         CMD SERVICE                          21233302
CTSK     DC    CL4'CTSK'           LOAD MODULE ID FOR SETFRR     Y02755 21236302
         SPACE ,                                                 Y02756 21239402
*   ATTACH PARAMETER LIST                                        Y02756 21249402
         SPACE ,                                                 Y02756 21259402
ATTPARM  ATTACH EP=IEAVTPUT,SF=L,SM=SUPV                         Y02756 21269402
         SPACE ,                                                 Y02756 21279402
MMBSUBPL EQU   250                 SUBPOOL NO. FOR MMB SPACE     Y02756 21289402
QR0PSIZE EQU   20                  LENTH OF QR0 PARMLIST + PTR   Y02756 21319902
*                                  TO PARM LIST                  Y02756 21719902
QR0PSP   EQU   250                 QR0 PARM LIST SUBPOOL         Y02756 22119902
Z        EQU   C'Z'                AREA ID Z (MESSAGE STREAM)    S21002 22650001
         EJECT                                                          22900001
*********************************************************************** 22950001
*                                                                     * 23000001
*                             IEECMQCN                                * 23050001
*                                                                     * 23100001
*        THIS ROUTINE QUEUES A PARTICULAR WQE ONTO A SPECIFIED        * 23150001
*        CONSOLE'S OUTPUT QUEUE                                       * 23200001
*                                                                     * 23250001
*        INPUT TO THIS ROUTINE CONSISTS OF THE FOLLOWING-             * 23300001
*            REGISTER 2- UCM ADDRESS                                  * 23350001
*            REGISTER 4- MCS UCM PREFIX ADDRESS                       * 23400001
*            REGISTER 6- WQE ADDRESS                                  * 23450001
*            REGISTER 9- RETURN ADDRESS                               * 23500001
*            REGISTER 11- CONSOLE ENTRY ADDRESS                       * 23550001
*                                                                     * 23600001
*        THIS ROUTINE  DESTROYS THE PREVIOUS CONTENTS OF-             * 23650001
*            REGISTERS 1, 5, 8, 10 (10 IS PRESERVED ONLY              * 23700001
*              IF THE CALLER IS IEECMENQ)                             * 23750001
*                                                                     * 23800001
*********************************************************************** 23850001
         SPACE 3                                                        23900001
ENQCNSLE EQU   *                                                        23950001
         LR    R15,R11                  SAVE UCM ENTRY PTR              24000001
         TM    UCMATR,UCMOF               ENTRY SUPPORT OUTPUT          24100001
         BNZ   CONSOK                   YES - CONTINUE NORMALLY         24150001
         L     R11,UCMCOMPC             GET OUTPUT PORTION OF           24200001
*                                        COMPOSITE CONSOLE              24250001
CONSOK   EQU   *                                                 S21003 24300001
         TM    UCMDISP,UCMDISPG    OUT-OF-LINE ONLY CONSOLE      S21003 24350001
         BNO   CONSOK1             NO                            S21003 24400001
         CLI   WMJMMLW,ZERO       MAJOR WQE?                            24450001
         BE    ENQADDQ1          NO,CONTINUE                            24500001
         TM    WMJMDEC1,WMJMDECH      DESCRIPTOR CODE 8          S21003 24550001
         BNO   ENQADDQ1            NO, NOT OUT-OF-LINE           S21003 24600001
         TM    WMJMDEC2,WMJMDECI   DESCRIPTOR CODE 9             S21003 24650001
         BNO   ENQADDQ1            NO, NOT OUT-OF-LINE           S21003 24700001
         CLI   WMJMAREA,Z          AREA EQUAL Z                  S21003 24750001
         BE    ENQADDQ1            YES, NOT OUT-OF-LINE          S21003 24800001
CONSOK1  EQU   *                                                 S21003 24850001
         LA    R3,ONE(R3)              INCREMENT ROUTED COUNT           24900001
         TM    UCMDISP,UCMDISPD         THIS CONSOLE OUTPUT ONLY        24950001
         BNO   ENQNTOUT            NO                                   25000001
         A     R0,FULL1          INCR OUTP ONLY COUNT                   25050001
ENQNTOUT EQU   *                                                        25100001
         TM    UCMDISP,UCMDISPC    IF NOT A GRAPHICS DEVICE             25150001
         BO    IEECMQCN            INCREMENT NON-GRAPHICS COUNT         25200001
         LA    R7,ONE(R7)                                               25250001
IEECMQCN EQU   *                                                        25300001
         BALR  R10,ZERO            SET BASE REG                         25350001
         USING *,R10                                                    25400001
         SR    R5,R5                                                    25450002
         IC    R5,WQEUSE           INCREMENT WQE USE COUNT              25500001
         LA    R5,ONE(R5)                                               25550001
         STC   R5,WQEUSE                                                25600001
         CLI   WMJMMLW,ZERO        MAJOR WQE                     S21002 25650001
         BE    ENQUSE2             NO, CONTINUE                  S21002 25700001
         TM    WMJMMLW,WMJMMLWH    DUMMY MINOR                   S21002 25750001
         BO    ENQUSE2             YES, CONTINUE                 S21002 25800001
         L     R8,WMJMMIN          POINT TO FIRST MINOR          S21002 25850001
         USING WQE,R8                                                   25900001
ENQUSE1  EQU   *                                                 S21002 25950001
         LTR   R8,R8               ANY ADDRESS                   S21002 26000001
         BZ    ENQUSE2             NO, CONTINUE                  S21002 26050001
***************************************************************@ZA01916 26050203
*                                                              @ZA01916 26050403
*         THE FOLLOWING TEST IS MADE TO DETERMINE IF THIS IS A @ZA01916 26050603
*         MLWTO THAT HAS NOT BEEN SERVICED BUT HAS BEEN MARKED @ZA01916 26050803
*         FOR ABEND. THIS CHECK MUST BE MADE BECAUSE AN MLWTO  @ZA01916 26051003
*         CAN BE MARKED FOR ABEND BEFORE IT HAS BE PLACED ON   @ZA01916 26051203
*         ANY CONSOLE QUEUE TO BE DISPLAYED.                   @ZA01916 26051403
*                                                              @ZA01916 26052003
***************************************************************@ZA01916 26055003
         TM    WMNMML1,WMNMML1F    MINOR MARKED FOR ABEND?     @ZA01916 26058003
         BO    ENQUSE2             YES, TERMINATE MLWTO SEARCH @ZA01916 26061003
         SR    R5,R5               CLEAR WORK REG                Y02756 26070003
         IC    R5,WMNMUC1          INCREMENT MINOR USE CT        Y02756 26080003
         LA    R5,ONE(R5)          INCREMENT MINOR USE CT        Y02756 26090003
         STC   R5,WMNMUC1          STORE COUNT OF FIRST MESSAGE  S21002 26100001
         TM    WMNMML2,WMNMML2H    IS LINE 2 AVAILABLE?                 26150001
         BO    ENQUSE1A            YES                                  26200001
         SR    R5,R5               CLEAR WORK REG                Y02756 26202002
         IC    R5,WMNMUC2          INCREMENT MINOR USE CT        Y02756 26211002
         LA    R5,ONE(R5)          INCREMENT MINOR USE CT        Y02756 26220002
         STC   R5,WMNMUC2          STORE COUNT OF SECOND MESSAGE S21002 26250001
ENQUSE1A EQU   *                                                 S21002 26300001
         L     R8,WMNMNX2-ONE          GET NEXT MINOR PTR        S21002 26350001
         LA    R8,ZERO(R8)         CLEAR USE COUNT               S21002 26400001
         B     ENQUSE1             CHECK IT                      S21002 26450001
ENQUSE2  EQU   *                                                 S21002 26500001
         DROP  R8                                                       26550001
         LA    R8,UCMOUTQ          INITIALIZE LINKAGE PTR ADDRESS       26600001
         L     R5,UCMOUTQ          GET FIRST PTR IN OUTPUT Q            26650001
         LTR   R5,R5                                                    26700001
         BP    ENQLOOPQ             IF THERE IS NO OUTPUT Q,            26750001
         B     ENQGETQ              AND BUILD FIRST BLOCK               26800001
         USING CQE,R5                                                   26850001
ENQLOOPQ TM    CQEFLAG,CQEEOB      TEST FOR END CONDITIONS IN QUEUE     26900001
         BM    ENQENDQ             BRANCH IF END-OF-QUEUE               26950001
         BO    ENQPTRQ             BRANCH IF PTR TO NEXT BLOCK          27000001
         LA    R5,FOUR(R5)                                              27050001
         B     ENQLOOPQ            GET NEXT PTR                         27100001
ENQPTRQ  LR    R8,R5               UPDATE LINK PTR ADDRESS              27150001
         L     R5,CQEWQEA-ONE         GET ADDRESS OF NEXT BLOCK         27200001
         B     ENQLOOPQ            CONTINUE SEARCH FOR END-OF-QUEUE     27250001
ENQENDQ  NI    CQEFLAG,SWMASK-CQEEOQ    TURN OFF END OF QUEUE INDICATOR 27300001
         LA    R5,FOUR(R5)                                              27350001
         TM    CQEFLAG,CQEEOB      IF NEXT PTR IS A PTR                 27400001
         BZ    ENQADDQ              TO THE NEXT BLOCK,                  27450001
         LR    R8,R5          A NEW BLOCK MUST BE GOTTEN                27500001
ENQGETQ  EQU   *                   GETMAIN BLOCK FOR CQE         Y02752 27550002
*                                                                       27610002
*        USE THE BRANCH ENTRY TO GETMAIN TO GET A 24 BYTE        Y02752 27660002
*        BLOCK FROM SUBPOOL 241 FOR A CQE BLOCK                  Y02752 27710002
*                                                                       27760002
         STM   R3,R4,UCM2WD        SAVE REGS AROUND GETMAIN      Y02752 27800002
         ST    R7,UCM4WD           SAVE REGS                     Y02752 27860002
         ST    R0,UCM5WD           SAVE REGS                     Y02752 27870002
         ST    R15,UCM6WD          SAVE REGS                     Y02752 27880002
         SPACE ,                                                 Y02752 27910002
* NOTE: REGS 3,4,7,0,15 ARE SAVED IN THE UCM PREFIX              Y02752 27950002
*       REGS 3,4,7,0,1,14,15 ARE DESTROYED TO USE GETMAIN        Y02752 28000002
         SPACE ,                                                 Y02752 28004002
         L     R4,UCMPXA           GET COMMTASKS TCB ADDR        Y02752 28204002
         L     R7,UCMASCB          GET COMMTASKS ASCB ADDR       Y02752 28510002
         GETMAIN RU,LV=CQESIZE,SP=CQESP,BRANCH=YES GET CQE SPACE Y02752 28560002
         SPACE 1                                                 Y02752 28566002
*   RESTORE THE UCM PREFIX BASE REGISTER.                        Y02752 28608002
         SPACE 1                                                        28626002
         LA    R3,FOUR             NEG OFFSET TO GET PRFX PTR    Y02752 28628002
         LR    R4,R2               UCMBASE ADDR                  Y02752 28630002
         SR    R4,R3               BACK UP ADDR TO PREFIX PTR    Y02752 28632002
         L     R4,ZERO(R4)         GET UCM PREFIX ADDRESS        Y02752 28634002
         LM    R3,R4,UCM2WD        RESTORE REGS AFTER GETMAIN    Y02752 28636002
         L     R7,UCM4WD           RESTORE REG                   Y02752 28638002
         L     R0,UCM5WD           RESTORE REG                   Y02752 28640002
         L     R15,UCM6WD          RESTORE REG                   Y02752 28642002
         SPACE ,                                                 Y02752 28646002
         ST    R1,UCMR9SV          SET UP FOR CHAINING           Y02893 28666002
         MVC   ONE(THREE,R8),UCMR9SV+ONE  LINK NEW BLOCK TO OLD QUEUE   28700001
         XC    ZERO(BLKLEN,R1),ZERO(R1)   CLEAR NEW BLOCK               28750001
         LR    R5,R1                   NEW CQE ADDRESS                  28800001
         OI    CQEEND,CQEEOB    INDICATE SPOT FOR NEXT BLOCK PTR        28850001
ENQADDQ  ST    R6,CQEWQEA-ONE     WQE ADDR AFTER PREVIOUS LAST ENTRY    28900001
         OI    CQEFLAG,CQEEOQ+CQEENTR      INDICATE NEW LAST ENTRY      28950001
         TM    WQEXA,WQEQDFHC      QUEUED FOR HARDCOPY           Y02756 28960002
         BZ    ENQMLT              NO, CHECK FOR MLWTO           Y02756 28970002
         CL    R11,UCMHCUCM        IS THIS THE HARDCOPY CONSOLE  Y02756 28980002
         BNE   ENQMLT              NO, CHECK FOR MLWTO           Y02756 28990002
         OI    CQEFLAG,CQEMLQHC    YES, INDICATE QUEUED FOR HC   Y02756 28992002
         SPACE                                                          28994002
ENQMLT   EQU   *                   MLWTO TESTS                   Y02756 28996002
         TM    WMJMMLW,WMJMMLWB        MLWTO CHAIN               S21002 29000001
         BNO   ENQADDQA            NO                            S21002 29050001
         OI    CQEFLAG,CQEMAJOR      SHOW THIS IS AN MLWTO       S21002 29100001
         TM    WMJMDEC1,WMJMDECH         DESCRIPTOR CODE 8       S21002 29600001
         BNO   ENQADDQA            NO OUT-OF-LINE                S21002 29650001
         TM    WMJMDEC2,WMJMDECI      DESCRIPTOR CODE 9          S21002 29700001
         BNO   ENQADDQA            NO OUT-OF-LINE                S21002 29750001
         CLI   WMJMAREA,Z          AREA ID EQUAL Z               S21002 29800001
         BE    ENQADDQA            YES, NOT OUT-OF-LINE          S21002 29850001
         OI    UCMSTS,UCMPF        INDICATE OUTPUT PENDING       S21002 29900001
         OI    UCMSDS5,UCMSDS5C    INDICATE OUT-OF-LINE PENDING  S21002 29950001
         B     ENQADDQ1            CONTINUE                      S21002 30000001
ENQADDQA EQU   *                                                 S21002 30050001
         TM    UCMSTS,UCMTC        IS CONSOLE WORKING ON INLINE  S21002 30100001
         BO    ENQADDQ1            MLWTO, YES, DON'T GO TO CONS  S21002 30150001
         OI    UCMSTS,UCMPF        INDICATE OUTPUT PENDING       S21002 30250001
         OI    UCMSDS5,UCMSDS5B    INDICATE INLINE OUTPUT PENDNG S21002 30300001
         USING UCMPRFX,R4                                               30350001
ENQADDQ1 EQU   *                                                        30400001
         L     R10,UCMQRTN         RESTORE BASE REG FOR ENQ             30450001
         BR    R9                  RETURN                               30500001
         DS    0F                                                       30950001
FULL1    DC    X'00000001'                                              31100001
PATCH    DC    CL150'***IEAVMWSV***'     PATCH AREA            @ZA01916 31120003
         EJECT                                                          31150001
         IEAMMB                                                  Y02756 31160002
         EJECT ,                                                 Y02756 31180002
         IHAWQE                                                         31200001
         EJECT                                                          31250001
         IEECUCM FORMAT=NEW                                             31300001
         EJECT                                                          31350001
         IHASCVT                                                        31400001
         EJECT                                                          31450001
         IHACTM CQE                                                     31500001
         EJECT                                                          31510002
         IHACTM QR0                                              Y02756 31520002
         EJECT                                                          31550001
         IHACTM FTPT                                                    31560002
         EJECT                                                          31570002
         CVT       SYS=AOS2,OPTIONS=(TSLICE),TSO=YES,DSECT=YES          31600001
         EJECT                                                          31650001
         IHAASVT                                                        31660002
         EJECT                                                          31670002
         IHAPSA                    REQUIRED FOR SETLOCK                 31680002
         EJECT                                                          31681002
         IHAFRRS                                                        31683002
         END   ,                                                 Y02893 31690002
