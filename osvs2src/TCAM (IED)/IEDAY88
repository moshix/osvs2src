         TITLE 'IEDAY88 - TIOC LOGOFF/TERMINATION QTIP'                 00700002
IEDAY88  CSECT                                                          01400002
**********************************************************************  02150002
*                                                                       02160002
*01 MODULE-NAME = IEDAY88                                               02200002
*                                                                       02250002
*01 DESCRIPTIVE-NAME = TIOC LOGOFF/TERMINATION QTIP                     02300002
*                                                                       02350002
*01 COPYRIGHT = NONE                                                    02400002
*                                                                       02450002
*01 STATUS = 01                                                         02500003
*                                                                       02550002
*01 FUNCTION = PERFORM TERMINATION CLEANUP (QTIP 23). TRY TO            02600002
*               RECONNECT A DISCONNECTED USER WHO HAS LOGGED BACK IN    02650002
*               (QTIP 1). LOG OFF DISCONNECTED USERS WHOSE RECONNECT    02700002
*               PERIOD HAS EXPIRED (QTIP 27). TEST WHETHER USER HAS     02750002
*               HUNG UP.                                                02760002
*                                                                       02770002
*01 NOTES = N/A                                                         02780002
*                                                                       02790002
*02   DEPENDENCIES = N/A                                                02792002
*                                                                       02794002
*02   RESTRICTIONS = N/A                                                02796002
*                                                                       02798002
*02   REGISTER-CONVENTIONS = SEE REGISTER EQUATES                       02798402
*                                                                       02798802
*02   PATCH-LABEL = PATCH                                               02799202
*                                                                       02799602
*01 MODULE-TYPE = ASSEMBLER LANGUAGE CSECT                              02799702
*                                                                       02799802
*02   PROCESSOR = ASSEMXF-370R                                          02799902
*                                                                       02849902
*02   MODULE-SIZE = SEE EXTERNAL SYMBOL DICTIONARY TYPE SD ID 01        02859902
*                                                                       02869902
*02   ATTRIBUTES = REENTRANT,REUSABLE ENABLED,SUPERVISOR STATE          02879902
*                                                                       02889902
*01 ENTRY-POINT = QTIP0230,QTIP0010,QTIP0270                            02891902
*                                                                       02892302
*02   PURPOSE = SEE FUNCTION                                            02892702
*                                                                       02893102
*02   LINKAGE = QTIP0230 FROM IEDAY8 (VIA IEDAYQT)                      02893502
*                QTIP0270 FROM IEDAY8 (VIA IEDAYQT)                     02943502
*                QTIP0010 FROM LOGON PROMPTER (VIA IEDAYQT)             02953502
*                                                                       02993502
*01 INPUT = REGISTER 12 CONTAINS ENTRY POINT                            03003502
*            REGISTER 14 CONTAINS RETURN ADDRESS                        03013502
*             (QTIP0010)                                                03023502
*            REGISTER 15 CONTAINS ADDRESS OF TWO WORD PARAMETER LIST.   03033502
*                        WORD 1 POINTS TO THE USER ID.                  03035502
*                        WORD 2 POINTS TO THE PASSWORD SUPPLIED BY USER 03037502
*             (QTIP0230)                                                03039902
*            REGISTER 15 CONTAINS ADDRESS OF RMPL                       03040302
*             (QTIP0270)                                                03040702
*            REGISTER 15 CONTAINS ADDRESS OF TIOCRPT                    03041102
*                                                                       03041202
*01 OUTPUT =                                                            03041502
*            QTIP0010                                                   03041602
*               REGISTER 15 = 0  -  SUCCESSFUL                          03041702
*                           = 4  -  PASSWORD DOES NOT MATCH             03041802
*                           = 8  -  USERID UNAVAILABLE(SEE REGISTER 0)  03043802
*               REGISTER  0 = 0  -  USERID NOT FOUND                    03045802
*                           = 4  -  USERID IN USE                       03045902
*            QTIP0230                                                   03046002
*               REGISTER 15 = 4  -  TELL IEDAY8 TO WAIT FOR TSOUTPUT    03048602
*                                   TO FINISH                           03050602
*            QTIP0270                                                   03051002
*               REGISTER 15 = 0  -  TELL IEDAY802 TO ISSUE ANOTHER      03051402
*                                   1 MINUTE STIMER                     03051502
*                           = 4  -  TELL IEDAY802 TO ISSUE WAIT ON      03051602
*                                   TIOCTECB                            03051702
*                                                                       03052102
*01 EXIT-NORMAL = TO IEDAYQT                                            03054302
*                                                                       03056902
*01 EXIT-ERROR = NONE                                                   03059502
*                                                                       03062102
*01 EXTERNAL-REFERENCES                                                 03064702
*                                                                       03067302
*02   ROUTINES = QTIP0140 IN CSECT IEDAYOO IN LOAD MODULE SVC 101       03069902
*                                                                       03072503
*                                                                       03072902
*02   DATA-AREAS = N/A                                                  03074102
*                                                                       03076102
*02   CONTROL-BLOCKS = CVT,TSB,ASCB,QCB,RMPL,TCX,TIOCRPT,TSI            03076502
*                                                                       03076602
*01 TABLES = N/A                                                        03076702
*                                                                       03082302
*01 MACROS = NONE                                                       03084302
*                                                                       03086302
*01 CHANGE-ACTIVITY                                                     03086403
*        VS2-3.0 CHANGES                                                03086503
*A756974-756979                                                 ZA01520 03086603
*D021000                                                        ZA01520 03086703
*C182000                                                        ZA01520 03087003
*        VS2-030 SERVICE UPDATE                                         03087103
*0000754794-754844                                             @ZA07703 03087203
*0000754845                                                    @ZA09645 03087303
*                                                                       03087503
*        VS2-037 CHANGES                                                03087703
*C754794                                                        ZA16621 03087903
*                                                                       03088903
*        VS2-MVS SU ACTIVITY                                   @ZA16608 03089903
* A 755092                      CODE FOR SU32 G32TKKM 07/15/76  ZA16608 03094903
*                                                              @ZA16608 03101903
*********************************************************************** 03108903
         EJECT                                                 @ZA16608 03115903
         ENTRY QTIP0010                                        @ZA16608 03122903
         ENTRY QTIP0230                                        @ZA16608 03129903
         ENTRY QTIP0270                                                 03137902
*                                                                       03193502
*   REGISTER EQUATES                                                    03500002
*                                                                       04200002
RWRK0    EQU   0                        WORK REGISTER                   04900002
RWRK1    EQU   1                        WORK REGISTER                   05600002
RWRK2    EQU   2                        WORK REGISTER                   06300002
RCVT     EQU   3                        CVT POINTER                     07000002
RWRK3    EQU   3                        WORK REGISTER                   07050002
RTCX     EQU   4                        TCX ADDRESS                     07100002
RTCB     EQU   4                        TCB POINTER                     07700002
RWRK4    EQU   4                        WORK REGISTER                   07750002
RWRK5    EQU   5                        WORK REGISTER                   07800002
RASCB    EQU   5                        ASCB POINTER                    08400002
RWRK6    EQU   6                        WORK REGISTER                   08450002
RWRK7    EQU   7                        WORK REGISTER                   08500002
RTIOC    EQU   7                        TIOC POINTER                    09800002
RTSB     EQU   8                        TSB POINTER                     10500002
RWRK8    EQU   8                        WORK REGISTER                   10550002
RWRK9    EQU   9                        WORK REGISTER                   10600002
RCSCB    EQU   9                        CSCB ADDRESS                    10650002
RWRK10   EQU   10                       WORK REGISTER                   11200002
RWRK11   EQU   11                       WORK REGISTER                   11900002
RBASE    EQU   12                       BASE REGISTER                   11950002
RSAVE    EQU   13                       SAVE AREA POINTER               12600002
RLINK    EQU   14                       LINK REGISTER                   13300002
RRMPL    EQU   15                       RMPL POINTER                    14000002
REPA     EQU   15                       ENTRY POINT ADDR                14700002
RCODE    EQU   15                       RETURN CODE REGISTER            14750002
         SPACE 3                                                        14800002
*                                                                       14810002
*        VALUE EQUATES                                                  14850002
*                                                                       14900002
E0       EQU   0                        ZERO                            14950002
E1       EQU   1                        ONE                             15000002
E2       EQU   2                        TWO                             15010002
E4       EQU   4                        FOUR                            15050002
E7       EQU   7                        SEVEN                   ZA09645 15070003
E8       EQU   8                        EIGHT                           15100002
E12      EQU   12                       OFFSET OF 12                    15110002
ALL      EQU   X'FF'                    FLAG FOR NI                     15120002
WAITCODE EQU   4                        IEDAY8 SHOULD WAIT FOR TCAM     15170002
         SPACE 3                                                        15200002
*                                                                       15400002
*   ADDRESSABILITY                                                      16100002
*                                                                       16800002
         DC    C'IEDAY88 '              MODULE I.D.                     17500002
         DC    X'6197'             DATE - 07/15/76              ZA16608 17800003
QTIP0230 EQU   *                                                        18900002
         USING *,RBASE                  MODULE ADDRESSABLE              19600002
         USING RMPL,RRMPL               RMPL ADDRESSABLE                20300002
         L     RASCB,RMPLASCB           GET ASCB ADDR                   21000002
         USING ASCB,RASCB               ASCB ADDRESSABLE                21700002
         L     RTSB,ASCBTSB             GET TSB ADDR                    22400002
         USING TSB,RTSB                 TSB ADDRESSABLE                 23100002
         L     RCVT,CVTPTR              GET CVT ADDR                    23800002
         USING CVT,RCVT                 CVT ADDRESSABLE                 24500002
         L     RTCX,CVTAQAVT            GET TCX ADDR                    25200002
         USING IEDQTCX,RTCX             TCX ADDRESSABLE                 25900002
         L     RTIOC,TCXRPT             GET TIOCRPT ADDR                26600002
         USING TIOCRPT,RTIOC            TIOCRPT ADDRESSABLE             27300002
*                                                                       28000002
*   IF THE USER HAS HUNG UP, EXIT TO QTIP 14 (IN IEDAYOO) TO            28700002
*   CLEAN UP THE TS CONTROL BLOCKS                                      29400002
*                                                                       30100002
         TM    TSBFLG4,TSBHUNG          HAS USER HUNG UP                30800002
         BNO   NOTHUNG                  NO, DON'T CLEANUP YET           31500002
*                                                                       32200002
*   REGISTERS AT ENTRY TO QTIP 14                                       32900002
*                                                                       33600002
*        08 - TSB ADDR                                                  34300002
*        12 - BASE ADDR OF IEDAYOO                                      35000002
*        14 - RETURN ADDR                                               35700002
*        15 - ADDR OF QTIP 14                                           36400002
*                                                                       37100002
         L     REPA,QTIP14AD            GET EPA OF QTIP 14              37800002
         DROP  RRMPL                    15 NOT RMPL BASE                38500002
         L     RBASE,AYOOBASE           GET BASE ADDR FOR AYOO          39200002
         DROP  RBASE                    BASE REGISTER ALTERED           39900002
         BR    REPA                     EXIT TO QTIP 14                 40600002
*                                                                       41300002
         USING QTIP0230,RBASE           REESTABLISH BASE ADDR           42000002
         USING RMPL,RRMPL               RMPL                            42700002
*                                                                       43400002
*   TERMINAL IS STILL CONNECTED.  CAUSE TSOUTPUT TO PERFORM             44100002
*   CONTROL BLOCK CLEANUP FOR THIS USER AFTER CURRENT OUTPUT            44800002
*   MESSAGES HAVE BEEN SENT.                                            45500002
*                                                                       46200002
NOTHUNG  EQU   *                                                        46900002
         OI    TSBSTAT,TSBDISC          FLAG TERM AS LOGGING OFF        47600002
         TM    RMPLFLG1,RMPLTYPE        IS THIS OUT-OF-CORE ABND        48300002
         BNO   TPOST                    NO, DON'T SET FLAG              49000002
         OI    TSBFLG4,TSBOCAB          HAVE IEDAYO SEND MSG            49700002
*                                                                       50400002
TPOST    EQU   *                                                        51100002
         LM    RWRK0,RWRK1,TSBTPOST     GET TPOST FLAGS                 51800002
RESET    EQU   *                                                        52500002
         LR    RWRK10,RWRK0             COPY TPOST FLAGS                53200002
         LR    RWRK11,RWRK1             COPY TPOST FLAGS                53900002
         O     RWRK11,DISCMASK          REQUEST QCB BIT SETTINGS        54600002
         O     RWRK10,TQCBMASK          REQUEST QCB TPOST               55300002
         CDS   RWRK0,RWRK10,TSBTPOST    UPDATE TPOST FLAGS              56000002
         BNE   RESET                    RETRY UNTIL SUCCESSFUL          56700002
*                                                                       57400002
*   CALL IEDAYTPQ TO TPOST THE TSB TO IEDAYP.                           58100002
*   IEDAYP WILL SET QCBWRBRK, QCBTPUT, AND QCBDISC AND WILL             58800002
*   TPOST THE QCB TO ITSELF.                                            59500002
*   THIS WILL CAUSE TSOUTPUT TO GAIN CONTROL.                           60200002
*   TSOUTPUT WILL THEN PERFORM LOGOFF CLEANUP PROCESSING                60900002
*   AFTER ALL OUTPUT MESSAGES HAVE BEEN SENT TO THE TERMINAL.           61600002
*                                                                       62300002
*   REGISTERS FOR IEDAYTPQ--                                            63000002
*                                                                       63700002
*        00 -- RETURN ADDR.                                             64400002
*        01 -- ZERO, INDICATING REQUEST TO TPOST TSB TO IEDQYP          65100002
*        02 -- TSB ADDR                                                 65800002
*        13 -- SIX WORD SAVE AREA                                       65850002
*        15 -- EPA                                                      66500002
*                                                                       67200002
         LA    RSAVE,TIOCSAVE           GET ADDR OF SAVE AREA           67900002
         SR    RWRK1,RWRK1              REQUEST TPOST OF TSB            68600002
         LR    RWRK2,RTSB               GET TSB ADDR                    69300002
         L     REPA,TPQEPA              GET ADDR OF IEDAYTPQ            70000002
         BALR  RWRK0,REPA               GO TPOST                        70700002
*                                                                       71400002
         LA    REPA,WAITCODE            TELL IEDAY8 TO WAIT             72100002
*                                       FOR TSOUTPUT TO FINISH          72800002
         BR    RLINK                    RETURN                          73500002
*                                                                       74200002
         EJECT                                                          74250002
*********************************************************************** 74300002
*        QTIP0010 IS ENTERED FROM THE LOGON PROMPTER(VIA IEDAYQT). IT * 74350002
*      IS USED TO RECONNECT A DISCONNECTED USER WHO HAS RELOGGED ON   * 74400002
*      WITH THE RECONNECT OPERAND. IT WILL SCAN THE TSB/ASCB/CSCB     * 74450002
*      CHAINS FOR A MATCHING USERID AND PASSWORD, PLUS CHECK IF THE   * 74500002
*      TSBHUNG BIT IS ON INDICATING THIS IS THE "OLD TSB". IT THEN    * 74550002
*      WILL REMOVE ANY WAITS VIA IEDAYQIO, MERGE THE TERMINAL         * 74600002
*      DEPENDENT FIELDS FROM THE "CURRENT OR NEW TSB" INTO THE "OLD   * 74650002
*      TSB", TURN ON TSBNEWID IN THE 'OLD TSB' AND POST IT TO IEDAYP. * 74700002
*         INPUT - REGISTER 4  =TCB ADDRESS                            * 74750002
*                 REGISTER 15 =ADDRESS OF TWO WORD PARAMETER          * 74800002
*                   WORD 1=USERID ADDRESS                             * 74850002
*                   WORD 2=PASSWORD ADDRESS                           * 74860002
*      NOTE - 'NEW TSB' IS THE TSB THE USER CURRENTLY HAS WHEN HE HAS * 74870002
*                       LOGGED ON WITH RECONNECT.                     * 74880002
*             'OLD TSB' IS THE TSB QTIP0010 IS SCANNING FOR, THE ONE  * 74890002
*                       HE WAS DISCONNECTED FROM.                     * 74892002
*********************************************************************** 74894002
QTIP0010 EQU   *                                                        74896002
         USING CSCB,RCSCB               CSCB ADDRESSABILITY             74898002
         MODESET EXTKEY=SUPR            KEY ZERO TO AVOID FETCH YM02856 74898402
*                                       PROTECTION CHK ON PARMS YM02856 74898502
****     FIND CURRENT TSB OF USER RECONNECTING                     **** 74898802
         L     RCVT,PSAAOLD-PSA         GET CURRENT ASCB ADDR           74948802
         L     RWRK1,ASCBTSB-ASCB(,RCVT) 'NEW TSB'                      74969902
         SPACE 1                                                        74979902
****     GET USERID AND PASSWORD ADDRESSES                         **** 74989902
         L     RWRK10,E0(,REPA)         USERID ADDRESS                  74991902
         L     RWRK11,E4(,REPA)         PASSWORD ADDRESS                74993902
         SPACE 1                                                        74995902
****     SET UP FOR TSB/ASCB/CSCB SCAN                             **** 74997902
         L     RCVT,CVTPTR              CVT ADDRESS                     74998302
         L     RCVT,CVTAQAVT-CVT(,RCVT) TCX ADDRESS                     74998702
         L     RTIOC,TCXRPT-IEDQTCX(,RCVT)  TIOCRPT ADDRESS             74999102
         USING TIOCRPT,RTIOC            TIOCRPT ADDRESSABILITY          74999502
         SR    RWRK2,RWRK2              CLEAR WORK REGISTER             74999602
         IC    RWRK2,TIOCTSBS           SIZE OF TSB                     74999702
         LH    RWRK3,TIOCNTSB           NUMBER OF TSBS                  74999802
         BCTR  RWRK3,E0                 DECREMENT BY ONE                75049802
         MR    RWRK2,RWRK2              OFFSET TO LAST TSB              75059802
         L     RTSB,TIOCTSB-E1          START OF TSBS                   75079802
         USING TSB,RTSB                 TSB ADDRESSABILITY              75080202
         LA    RTSB,E0(,RTSB)           ZERO HIGH ORDER BYTE            75080602
         AR    RWRK3,RTSB               ADDR OF LAST TSB                75080702
         SR    RWRK2,RWRK2              ZERO WORK REGISTER              75081002
         IC    RWRK2,TIOCTSBS           SIZE OF TSB                     75081402
         LA    RSAVE,TIOCSAVE           SAVE AREA FOR TPOST             75081802
         SPACE 2                                                        75089802
****     SCAN FOR 'OLD TSB'                                             75091802
SCAN     EQU   *                                                        75093802
         CR    RTSB,RWRK1               IS THIS 'NEW TSB'               75095802
         BE    BUMP                     YES, POINT TO NEXT TSB          75097802
         L     RASCB,TSBASCBA           ASCB OF TSB BEING SCAND         75098202
         LTR   RASCB,RASCB              VALID ASCB ADDRESS      YM04678 75098302
         BZ    BUMP                     NO,CHECK NEXT ONE       YM04678 75098402
         L     RCSCB,ASCBCSCB-ASCB(,RASCB) CSCB CONTAINS USERID         75098602
         USING CSCB,RCSCB               CSCB ADDRESSABILITY             75098802
         CLC   CHKEY,E0(RWRK10)         USERIDS MATCH                   75099002
         DROP  RCSCB                    DROP CSCB BASE REG              75099102
         BE    HUNG                     YES, CHECK FURTHER              75099402
BUMP     EQU   *                                                        75099502
         BXLE  RTSB,RWRK2,SCAN          POINT TO NEXT TSB & CHK         75099602
****     NO MATCHING USERID, ERROR, RETURN                         **** 75099702
         LA    RCODE,E8                 RETURN CODE = 8                 75149702
         LA    RWRK0,E0                 USERID NOT FOUND                75159702
         BR    RLINK                    RETURN TO CALLER                75169702
         SPACE 1                                                        75179702
HUNG     EQU   *                                                        75189702
         TM    TSBFLG4,TSBHUNG          IS THIS THE OLD TSB             75191702
         BNO   ERROR1                   NO,ERROR                        75193702
         CLC   TSBPSWD,E0(RWRK11)       PASSWORDS MATCH                 75195702
         BNE   ERROR2                   NO, ERROR                       75197702
         SPACE 1                                                        75198102
         MODESET EXTKEY=TCAM            CHANGE TSBS IN KEY 6    YM02856 75198202
****     START RECONNECT PROCESS HERE                              **** 75198502
         OI    TSBFLG4-TSB(RWRK1),TSBHUNG SET TSBHUNG IN NEW TSB        75198902
         NI    TSBFLG4,ALL-TSBHUNG      TURN OFF TSBHUNG IN OLD         75199302
         SPACE 1                                                        75199402
****     CHECK IF OLD TSB HAS ANY IWAIT OR OWAIT OUTSTANDING       **** 75199502
         TM    TSBFLG4,TSBIWAIT+TSBOWAIT ANY WAITS IN PROGRESS          75199602
         BZ    TERM                     NO,CONTINUE RECONNECT           75249602
         SPACE 1                                                        75259602
*********************************************************************** 75269602
*        BRANCH TO IEDAYQIO TO REMOVE USER IWAIT OR OWAIT             * 75279602
*          INPUT TO IEDAYQIO = REGS 15 - 2 WORK REGS                  * 75289602
*                              REG  4      RETURN ADDRESS             * 75291602
*                              REG  8      TSB ADDRESS                * 75293602
*                              REG  12     BASE ADDRESS               * 75295602
*          NOTE: REG 8 IS RTSB WHICH CONTAINS 'OLD TSB'               * 75297602
*********************************************************************** 75298002
         LR    RWRK3,RWRK1              SAVE 'NEW TSB ADDRESS           75298402
         LR    RWRK7,RBASE              SAVE BASE ADDRESS               75298802
         L     REPA,QIO                 ENTRY POINT TO IEDAYQIO         75298902
         L     RBASE,QIOBASE            BASE ADDR FOR IEDAYQIO          75299202
         DROP  RBASE                    DROP BASE ADDRESSABILITY        75299302
         BALR  RWRK4,REPA               BR TO IEDAYQIO                  75299402
         XI    TSBFLG2,TSBBIPI          INDICATE TO REMOVE OTHER WAIT   75316102
         USING QTIP0230,RWRK7           RESET ADDRESSABILITY            75318102
         L     REPA,QIO                 ENTRY POINT TO IEDAYQIO         75326102
         BALR  RWRK4,REPA               BR TO IEDAYQIO                  75328102
         DROP  RWRK7                    USE NORMAL BASE REG             75328502
         USING QTIP0230,RBASE           REESTABLISH ADDRESSABILITY      75328902
         XI    TSBFLG2,TSBBIPI          RESTORE ORIGINAL STATE          75330102
         LR    RBASE,RWRK7              RESTORE BASE ADDR               75332802
         LR    RWRK1,RWRK3              RESTORE 'NEW TSB' ADDRESS       75342802
         SPACE 1                                                        75349502
TERM     EQU   *                                                        75359502
****     MERGE TERMINAL DEPENDENT FIELDS FROM 'NEW TSB' TO 'OLD    **** 75369502
****       TSB' IN CASE USER HAS RECONNECTED ON A DIFFERENT TYPE   **** 75379502
****       TERMINAL. old tsb has addressability.                   **** 75389502
         TM    TSBSTAT-TSB(RWRK1),TSBDSPLY   NEW TSB A DISPLAY          75391502
         BZ    OFFDSPLY                 NO,INDICATE NO DISPLAY          75393502
         OI    TSBSTAT,TSBDSPLY         INDICATE A DISPLAY              75395502
         B     T3270                    TEST FOR 3270                   75397502
OFFDSPLY EQU   *                                                        75397902
         NI    TSBSTAT,ALL-TSBDSPLY     TURN OFF DISPLAY BIT            75398302
T3270    EQU   *                                                        75398702
         TM    TSBSTAT-TSB(RWRK1),TSB3270  NEW TSB A 3270               75399103
         BZ    NO3270                   NO,SHOW NO 3270                 75407103
         OI    TSBSTAT,TSB3270          INDICATE 3270 TERM              75415103
         B     LINSZE                   MOVE IN LINE SIZE               75423103
NO3270   EQU   *                                                        75431103
         NI    TSBSTAT,ALL-TSB3270      TURN OFF 3270 BIT               75459402
LINSZE   EQU   *                                                        75469402
         MVC   TSBOTBFP(E7),TSBOTBFP-TSB(RWRK1)  PHYSICAL LINE @ZA16621 75479403
*                           SIZE AND OUTPUT BUFFER QUEUES      @ZA07703 75484403
         XC    TSBOTBFP-TSB(E7,RWRK1),TSBOTBFP-TSB(RWRK1)      @ZA07703 75485403
         TM    TSBFLG3-TSB(RWRK1),TSBNOBRK BREAK FEATURE ALLOWD         75489402
         BZ    BRK                      YES,TURN BIT OFF                75491402
         OI    TSBFLG3,TSBNOBRK         BREAK NOT ALLOWED               75493402
         B     TERMCHAR                 COPY TERMINAL CHAR.             75495402
BRK      EQU   *                                                        75497402
         NI    TSBFLG3,ALL-TSBNOBRK     INDICATE BREAK ALLOWED          75497802
TERMCHAR EQU   *                                                        75498202
         MVC   TSBTERMC(E2),TSBTERMC-TSB(RWRK1) TERMINAL CHARS.         75498602
         MVC   TSBLNNO(E1),TSBLNNO-TSB(RWRK1)  # LINES ON SCREEN        75499002
         MVC   TSBASRCE(E2),TSBASRCE-TSB(RWRK1) TCAM TERM INDEX         75499102
         MVC   TSBLINE(E2),TSBLINE-TSB(RWRK1)  LINE ADDR OR 3705 ID     75499202
         MVC   TSBTRMID(E8),TSBTRMID-TSB(RWRK1) TCAM TERM ID    ZA16608 75499303
         SPACE 2                                               @ZA16608 75509303
*********************************************************************** 75532802
*        TURN ON TSBNEWID TO INDICATE TO IEDAYP THAT THE NEW QCBTJID  * 75542802
*           FIELD MUST BE UPDATED WITH THE OLD ASID(TJID).            * 75552802
*********************************************************************** 75562802
         LM    RWRK4,RWRK5,TSBTPOST     CONTENTS OF TSBTPOST            75564802
RETRY    EQU   *                                                        75565202
         LR    RWRK6,RWRK4              1ST WORD OF TSBTPOST            75565602
         LR    RWRK7,RWRK5              2ND WORD OF TSBTPOST            75566002
         O     RWRK6,TPMSK              TELL IEDAYP TO UPDATE QCBTJID   75566402
         TM    TSBFLG3,TSBTPUT          WAS A TPUT IN PROGRESS          75576402
         BZ    SWAP                     NO                              75586402
         O     RWRK6,TQCBMASK           TPOST QCB                       75586802
         O     RWRK7,TPQCBMSK           TURN ON QCBTPUT                 75587202
SWAP     EQU   *                                                        75587602
         CDS   RWRK4,RWRK6,TSBTPOST     STORE IN NEW TSBPOST            75588402
         BNE   RETRY                    FIELDS NOT EQUAL RETRY          75588502
         SR    RWRK1,RWRK1              INDICATE TSB TO TPOST           75589402
         ST    RWRK1,TSBMINL            ZERO RECONNECT LIMIT            75591402
         LTR   RWRK4,RWRK4              IS POST OUTSTANDING             75591902
         BM    RETURN                   YES,RETURN TO CALLER            75592802
         SPACE 2                                                        75593702
*********************************************************************** 75594602
*        CALL IEDAYTPQ TO TPOST THE TSB TO IEDAYP                     * 75595502
*          INPUT REGISTERS = REG  0 - RETURN ADDRESS                  * 75596402
*                            REG  1 - ZERO,INDICATING TPOST TSB TO AYP* 75596802
*                            REG  2 - TSB ADDRESS                     * 75597302
*                            REG 13 - SIX WORD SAVE AREA              * 75598202
*                            REG 15 - ENTRY POINT                     * 75599102
*********************************************************************** 75600002
         LR    RWRK2,RTSB               ADDRESS OF TSB                  75656202
         L     REPA,TPQEPA              ENTRY POINT ADDR                75666202
         BALR  RWRK0,REPA               TPOST TSB VIA IEDAYQTP          75676202
RETURN   EQU   *                                                        75678202
         LA    RCODE,E0                 RETURN CODE ZERO                75678602
         BR    RLINK                    RETURN TO CALLER                75679002
         SPACE 1                                                        75679402
ERROR1   EQU   *                                                        75679802
         LA    RCODE,E8                 USERID UNAVAILABLE              75679902
         LA    RWRK0,E4                 USERID IN USE                   75680002
         BR    RLINK                    RETURN TO CALLER                75680102
         SPACE 1                                                        75680402
ERROR2   EQU   *                                                        75687102
         LA    RCODE,E4                 PASSWORD UNEQUAL                75687202
         BR    RLINK                    RETURN TO CALLER                75687302
         EJECT                                                          75687402
*********************************************************************** 75687502
*        QTIP0270 IS USED TO CANCEL A DISCONNECTED USER WHOSE         * 75687802
*         RECONNECT PERIOD HAS EXPIRED,OR DECREMENT BY 1 MINUTE THE   * 75688102
*         TIME THAT IS LEFT.                                          * 75688402
*          INPUT: REGISTER 15 = TIOCRPT ADDRESS                       * 75688702
*********************************************************************** 75689002
QTIP0270 EQU   *                                                        75689302
         SR    RWRK10,RWRK10            ZERO WORK REGISTER              75689602
         LR    RTIOC,REPA               TIOCRPT ADDRESS                 75689902
         USING TIOCRPT,RTIOC            TIOCRPT ADDRESSABILITY          75690202
         SR    RWRK2,RWRK2              ZERO WORK REGISTER              75690802
         IC    RWRK2,TIOCTSBS           SIZE OF TSB                     75691102
         LH    RWRK3,TIOCNTSB           NUMBER OF TSBS                  75691402
         BCTR  RWRK3,E0                 ADJUST FOR OFFSET               75691702
         MR    RWRK2,RWRK2              OFFSET TO LAST TSB              75692002
         L     RTSB,TIOCTSB-E1          START OF TSBS                   75692602
         LA    RTSB,E0(,RTSB)           CLEAR HIGH ORDER BYTE           75692702
         AR    RWRK3,RTSB               ADDR OF LAST TSB                75693402
         SR    RWRK2,RWRK2              ZERO WORK REGISTER              75695202
         IC    RWRK2,TIOCTSBS           SIZE OF TSB                     75695902
         USING TSB,RTSB                 TSB ADDRESSABILITY              75696602
NEXTTSB  EQU   *                                                        75697302
         L     RWRK5,TSBASCBA           LOAD ADR OF ASCB        ZA01520 75697403
         LA    RWRK5,0(,RWRK5)          CLEAR HIGH ORDER BYTE   ZA01520 75697503
         LTR   RWRK5,RWRK5              DOES ASCB EXIST?        ZA01520 75697603
         BZ    NEXT                     NO,CHECK NEXT TSB       ZA01520 75697903
         TM    TSBFLG4,TSBHUNG          IS USER DISCONNECTED            75700202
         BNO   NEXT                     NO,CHECK NEXT TSB               75701202
         L     RWRK5,TSBMINL            RECONNECT TIME LIMIT            75702202
         LTR   RWRK5,RWRK5              RECONNECT TIME EXPIRED          75703202
         BNP   NEXT                     YES,CHECK NEXT TSB              75704202
         BCTR  RWRK5,E0                 DECREMENT BY 1 MINUTE           75705202
         ST    RWRK5,TSBMINL            SAVE NEW TIME LIMIT             75706202
         LTR   RWRK5,RWRK5              RECONNECT TIME EXPIRED NOW      75707202
         BZ    CANCEL                   YES,CANCEL USER                 75708202
         BCTR  RWRK10,E0                INDICATE RECONNECT PERIOD LEFT  75709202
NEXT     EQU   *                                                        75710202
         BXLE  RTSB,RWRK2,NEXTTSB       CHECK NEXT TSB                  75711202
         LTR   RWRK10,RWRK10            RECONNECT PERIOD OUTSTANDING    75712202
         BZ    RC4                      NO,RETURN CODE 4                75713202
         LA    RCODE,E0                 RETURN CODE OF 0                75714202
         BR    RLINK                    RETURN TO CALLER                75715202
RC4      EQU   *                                                        75716202
         XC    TIOCTECB(E4),TIOCTECB    CLEAR ECB                       75717202
         LA    RCODE,E4                 RETURN CODE OF 4                75718202
         BR    RLINK                    RETURN TO CALLER                75719202
         SPACE 3                                                        75720202
CANCEL   EQU   *                                                        75721202
*********************************************************************** 75722202
*        CANCEL USER WITH 622 ABEND WHEN RECONNECT PERIOD HAS         * 75723202
*         EXPIRED.                                                    * 75724202
*          REGISTER INPUT TO SYSTEM INITIATED CANCEL(SIC)             * 75725202
*            0 = POST CODE (622 ABEND)                                * 75726202
*            1 = ASCB ADDRESS                                         * 75727202
*           13 = SAVEAREA ADDRESS                                     * 75728202
*           14 = RETURN ADDRESS                                       * 75729202
*           15 = ENTRY POINT TO SIC                                   * 75730202
*********************************************************************** 75731202
         L     RWRK0,SICODE             622 ABEND CODE                  75732202
         L     RWRK1,TSBASCBA           ASCB ADDRESS                    75733202
         LA    RSAVE,TIOCSAVE           SAVE AREA ADDRESS               75734202
         LR    RWRK5,RLINK              SAVE RETURN ADDDRESS            75735202
         L     RLINK,CVTPTR             ADDRESS OF CVT                  75736202
         USING CVT,RLINK                CVT ADDRESSABILITY              75737202
         L     REPA,CVTSIC              ENTRY TO SIC                    75738202
         MODESET EXTKEY=SUPR            SUPERVISOR KEY FOR SIC          75739202
         DROP  RLINK                                                    75740202
         BALR  RLINK,REPA               GO SIC'M                        75741202
         MODESET EXTKEY=TCAM            BACK TO TCAMS KEY               75742202
         LR    RLINK,RWRK5              RESTORE RETURN ADDRESS          75743202
         B     NEXT                     CHECK NEXT TSB                  75744202
*   CONSTANTS                                                           75745202
*                                                                       75746202
TPQEPA   DC    V(IEDAYTPQ)              ADDR OF IEDAYTPQ                77000002
TQCBMASK DC    AL1(TSBTPQCB,0,0,0)      REQUEST QCB TPOST               77700002
DISCMASK DC    AL1(0,0)                 DON'T ALTER QCBTSOF2            78400002
         DC    AL1(QCBTPUT+QCBWRBRK+QCBDISC) MASK BYTE                  79100002
         DC    AL1(QCBTPUT+QCBWRBRK+QCBDISC) VALUE BYTE                 79800002
QTIP14AD DC    V(QTIP0140)              ADDR OF QTIP 14                 80500002
AYOOBASE DS    0A                       BASE ADDR OF QTIP 14            81200002
QIOBASE  DC    V(QTIP0110)              BASE ADDR FOR IEDAYQIO          81210002
QIO      DC    V(IEDAYQIO)              ENTRY POINT                     81220002
TPMSK    DC    AL1(TSBNEWID,0,0,0)      .TELL IEDAYP TO UPDATE QCBTJID  81230002
TPQCBMSK DC    AL1(0,0,QCBTPUT,QCBTPUT) TURN ON QCBTPUT                 81242002
SICODE   DS    0F                                                       81246002
         DC    XL4'00000622'            622 ABEND FOR SIC               81248002
PATCH    DC   16F'0'                    PATCH SPACE                     81250002
         EJECT                                                          81900002
         IHAASCB                                                        82600002
         EJECT                                                          83300002
CVT      DSECT                                                          84000002
         CVT                                                            84700002
         EJECT                                                          85400002
         TQCBD                                                          86100002
         EJECT                                                          86800002
         IHARMPL                                                        87500002
         EJECT                                                          88200002
         TTCXD                                                          88900002
         EJECT                                                          89600002
         IKJTIOCP                                                       90300002
         EJECT                                                          91000002
         IKJTSB                                                         91700002
         EJECT                                                          91750002
CSCB     DSECT                                                          91760002
         IEECHAIN                                                       91800002
         IKJTCB                                                         92000002
         EJECT                                                          92050002
         IHAPSA                                                         92100002
         END                                                            92400002
