CARR     TITLE '''IEDAYC''  -  TSO CARRIAGE ROUTINE.'                   00200022
IEDAYC   CSECT                                                          00220022
         SPACE 3                                                        00220205
*  CHANGE ACTIVITY AS FOLLOWS                                           00220405
******************** MICROFICHE FLAGS *********************** SUPT CODE 00220605
*C113000                                                         S21903 00221005
*C010000,024000,028000,032000-042000,060000-072000,076600-079600,S21903 00221105
*C081000-081450,081600-081700,084000-094000,285300-285350        S21903 00221205
*A124000                                                         S21903 00221305
*A076200-078700,081300-081450,312600-312800,373300-373600,398500,S22028 00221405
*A460500-461500,488500,509600,564600-565200,580500-581500,687000,S22028 00221505
*A701500                                                         S22028 00221605
*C004460,124000,352000-362000,420000-429000,511242               S22028 00221705
*D430000-433000                                                  S22028 00221805
*A081600                                                         S22029 00221905
*C285300                                                         S22029 00222005
*D258000-262000,269600-272000,298000-304000                      S22029 00222105
*C005060,005180,204000,286000,269600,304000,306600,307300,308400 S22025 00222205
*C309600,320000,327600,386000,388000,438000,492000,511800,518000 S22025 00222305
*C582000,682000,688000-694000,699000,702000                      S22025 00222405
*D706000                                                         S22025 00222505
*C511242-511246                                                 SA53605 00222605
*A112000                                                         A44022 00222705
*A285210,285220                                                  A44875 00222805
*A031000,081550,081800,103000                                    S22025 00222905
*A511239,511242                                                   M1191 00223005
*C030000,038000,090000,102000,130000,226000-230000,466000-468000 S22025 00223105
*C 401800-402400                                                SA59324 00223205
*C 077200,360000-361000                                         SA61786 00223305
*C 401800-402400                                                SA61787 00223405
*C004160,004460,004466,004472,005000,005100,005120,005260,005280,Y06327 00223505
*C016000,088000,106000,125000,420500                             Y06327 00223605
*A004165-004175,004476,081820-081940,328500-329500,353070-353210,Y06327 00223705
*A400620-401020,420509-420590,511810-511940,512450,513110        Y06327 00223805
*A355410,355420,468100-468600                                    Y06327 00223905
*C214900-215200                                                 SA67755 00224405
*D217000                                                        SA67755 00224905
*C200000-204000                                                @YA00488 00304957
*A081940                                                       @ZA02057 00305058
*C400640-402600                                                @ZA02057 00305158
*A317200                                                       @YA11532 00305258
*C511188                                                       @YA12281 00305358
*A511400                                                       @YA12281 00305458
*A079600,353000                                                @OZ12513 00325400
*D 076500,080400,080800,080900                                 @Y17XAYZ 00345400
*A133500,134000,124000,128000,081200-081300,401100-401200      @Y17XAYP 00355400
*A50200-50400,278000                                           @Y17XAYP 00365400
*C133500,125000,400700,420518,468200,511820,511880             @Y17XAYP 00375400
*                                                              @G36XRYP 00377400
*A734000                                                       @G36XRYP 00379400
*C220000-234000,216000,285100,312600,313800,352000,354000      @G36XRYP 00381400
*C373300,374000,378000,400720,400740,420000,420200,420400      @G36XRYP 00383400
*C425300,425440,426930,460500,468400,474000,511243,511245      @G36XRYP 00385400
*C511248,511440,511910,512200,512900,564600,566000,570000      @G36XRYP 00387400
*C580500                                                       @G26XRYP 00389400
*D072000-076400,081880-081920                                  @G36XRYP 00391400
*D212000-214000,112500-113000,720000-722000                    @G36XRYP 00393400
*C284000-285000                                                @OZ29032 00393582
*                                                              @G36XRYP 00395400
         SPACE 3                                                        00401605
*********************************************************************** 00402020
*                                                                     * 00404005
*  TITLE:  'IEDAYC'  TSO CARRIAGE ROUTINE                             * 00404605
*                                                                     * 00405205
*  MODULE NAME = IEDAYC  (TCAM,TSO)                            @Y17XAYP 00405800
*                                                                     * 00406405
*  DESCRIPTIVE NAME = TSO CARRIAGE ROUTINE                            * 00407005
*                                                                     * 00407605
*  COPYRIGHT = 'NONE'                                                 * 00408205
*                                                                     * 00408805
*  STATUS:  VERSION 10.0                                       @G36XRYP 00409400
*                                                                     * 00410020
*FUNCTION -- THE CARRIAGE SUBROUTINE MAINTAINS A COUNT IN THE QCB OF  * 00412020
*   CARRIAGE POSITIONS FOR KEYBOARD DEVICES, SO THAT WHEN OUTPUT IS   * 00414020
*   SENT, IDLE CHARACTERS CAN BE INSERTED PROPERLY, FOR DEVICES       * 00416005
*   ATTACHED TO A 270X. FOR KEYBOARD TERMINALS ATTACHED TO A 3705     * 00416505
*   (IDLE CHARACTERS ARE INSERTED BY THE 3705) A CARRIAGE RETURN IS   * 00417005
*   INDICATED AFTER ALL DATA HAS BEEN CHECKED. IF A TRANSLATION       * 00417505
*   ERROR HAS OCCURRED, OR IF THE CURRENT BUFFER IS A ZERO-LENGTH     * 00418020
*   BUFFER, CONTROL IS PASSED TO THE MH VIA THE RETURN INTERFACE.     * 00420020
*   OTHERWISE, THE BUFFER IS SCANNED CHARACTER BY CHARACTER FOR NEW   * 00422020
*   LINE CHARACTERS AND BACKSPACE CHARACTERS.  WHEN A BACKSPACE CHAR- * 00424020
*   ACTER IS FOUND, THE CARRIAGE POSITION COUNT IS DECREMENTED BY ONE,* 00426020
*   UNLESS THE BACKSPACE IS THE FIRST CHARACTER IN THE BUFFER.  WHEN  * 00428020
*   A NEW LINE CHARACTER IS FOUND, THE CARRIAGE POSITION COUNT IS RE- * 00430020
*   SET TO ZERO, AND FOR 2260'S, THE QCB SIMULATED ATTENTION LINE     * 00432020
*   COUNT IS UPDATED, UNLESS THE NEW LINE IS THE LAST CHARACTER IN    * 00434020
*   THE BUFFER.  IF IT IS, THE QCB RETRY COUNT FIELD IS SET TO RE-    * 00436020
*   FLECT THIS, SO THAT, WHEN THIS SUBROUTINE IS ENTERED TO SCAN THE  * 00438020
*   NEXT BUFFER, SCANNING WILL BEGIN AT THE FIRST CHARACTER IN THE    * 00440020
*   BUFFER.  THE CARRIAGE SUBROUTINE ALSO ZEROES OUT CIRCLE D'S FROM  * 00442020
*   ALL DEVICES EXCEPT 2741'S AND STX/ADDRESSING CHARACTER SEQUENCES  * 00444020
*   FROM 2260'S, IF THEY APPEAR IN INPUT BUFFERS. FOR 3270 REMOTES,   * 00446005
*   ATTACHED TO A 270X, IT ZEROS OUT STX/CU/DEV CONTROL CHARACTERS    * 00446605
*   AND REDUCES DATA LENGTH BY ONE FOR ETX. FOR 3270 REMOTES, ATTACHED* 00447205
*   TO A 3705, IT ZEROS OUT CU/DEV CONTROL CHARACTERS. IT ALSO COUNTS * 00447605
*   OUTPUT LINES FOR SIMULATED ATTENTION BY LINE COUNT, AND SETS ON   * 00448020
*   THE SIMULATED ATTENTION BIT IN THE SCB WHEN REQUIRED.  AFTER ALL  * 00450020
*   UNITS OF THE BUFFER HAVE BEEN SCANNED, THE CARRIAGE POSITION      * 00452020
*   COUNT IN THE QCB IS UPDATED, AND CONTROL RETURNS TO THE MH VIA    * 00454020
*   THE RETURN INTERFACE. FOR SNA DEVICES THE HDR BUFFERS ARE  @Y17XAYP 00456000
*   SCANNED FOR DATA FLOW CONTROL COMMANDS. CANCEL IS PROCESSED@Y17XAYP 00456600
*   A LINE DELETE AND ESIG IS PROCESSED AS ATTENTION.          @Y17XAYP 00457200
*                                                                     * 00458020
*ENTRY POINT -- IEDAYC - TO MAINTAIN A COUNT OF CARRIAGE MOVEMENT IN  * 00460020
*   EITHER DIRECTION.                                                 * 00462020
*   CALLING SEQUENCE          L    R12,AVTMSGS+OFFSET                 * 00464020
*                             BR   R12                                * 00466020
*                                                                     * 00468020
*INPUT -- IEDAYC IS ENTERED FROM THE TCAM USER INTERFACE ROUTINE      * 00470020
*   (IEDQUI) WHEN A CARRIAGE MACRO INSTRUCTION IS CODED IN AN INBUF   * 00472020
*   SUBGROUP OF AN MH. AT ENTRY, THE FOLLOWING REGISTERS ARE SET      * 00474005
*   R3 HAS THE ADDRESS OF THE SCB.                                    * 00475005
*   R4 HAS THE ADDRESS OF THE LCB                                     * 00476005
*   R6 HAS THE CURRENT BUFFER ADDRESS                                 * 00478020
*   R12 HAS THE ENTRY POINT ADDRESS                                   * 00480020
*   R13 HAS THE AVT ADDRESS                                           * 00482020
*                                                                     * 00484020
*OUTPUT -- ON EXIT TO THE RETURN INTERFACE, THE QCB CARRIAGE POSITION * 00486020
*   COUNT IS UPDATED.  IF REQUIRED, THE QCB SIMULATED ATTENTION LINE  * 00488020
*   COUNT MAY ALSO BE UPDATED, AND THE SCB SIMULATED ATTENTION BIT    * 00490020
*   MAY BE ON.  IF A NEW LINE CHARACTER WAS THE LAST CHARACTER IN THE * 00492020
*   BUFFER, THE QCB WILL INDICATE THIS.  AT EXIT, THE FOLLOWING       * 00494020
*   REGISTERS ARE SET.                                                * 00496020
*   R3 HAS THE SCB ADDRESS                                            * 00498020
*   R4 HAS THE LCB/PLCB ADDRESS                                       * 00500005
*   R10 HAS THE QCB ADDRESS                                           * 00502020
*   R11 HAS THE BUFFER ADDRESS                                        * 00504020
*   R15 HAS THE ENTRY POINT ADDRESS OF IEDQUI                    S22025 00506022
*                                                                     * 00508020
*EXTERNAL ROUTINE -- IEDQTNT - TO GET THE TERMINAL ENTRY FROM THE     * 00510005
*   PREFIX SOURCE INDEX.                                              * 00512005
*                                                                     * 00516020
*EXIT-NORMAL -- TO THE MH VIA THE RETURN INTERFACE (IEDQUI+4)    S22025 00518022
*                                                                     * 00520020
*EXITS-ERROR -- NONE                                                  * 00522020
*                                                                     * 00524020
*TABLES/WORK AREAS -- CVT, AVT, TSB, LCB/PLCB, SCB, DCB, QCB,  @G36XRYP 00526000
*   BUFFER PREFIX, TERMINAL ENTRY, ASVT, ASCB                  @G36XRYP 00528000
*                                                                     * 00530020
*ATTRIBUTES -- REENTRANT, ENABLED, RESIDENT, PROBLEM PROGRAM MODE.    * 00532020
*                                                                     * 00534020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 00536020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET. * 00538020
*      THIS MODULE TREATS NEW LINE CHARACTERS (X'15') AND CARRIAGE    * 00540020
*   RETURN CHARACTERS (X'0D') IDENTICALLY.                            * 00542020
*                                                                     * 00544020
*********************************************************************** 00546020
*       R E G I S T E R  E Q U A T E S                                  00600020
         SPACE                                                          00800020
RWORK    EQU   0                        WORK REGISTER            S22025 00900005
RPARM    EQU   1                        REGISTER EQUATE          S21903 01000022
RLIM     EQU   1                        LIMIT                    S21903 01100005
RNDX     EQU   2                        DATA INDEX                      01200020
RSCB     EQU   3                        SCB                      S21903 01400005
RLCB     EQU   4                        LCB/PLCB ADDR. FROM PREFXY06327 01600005
RCNT     EQU   5                        DATA COUNT FOR CARR POSN        01800020
RRH      EQU   5                        RH BASE REG            @YM06988 01900000
RPREFIX  EQU   6                        TCAM PREFIX                     02000020
RSCAN    EQU   7                        DATA POINTER                    02200020
RUNDX    EQU   8                        UNIT INDEX                      02400005
RAVT     EQU   9                        AVT ADDRESS              S22025 03100022
RQCB     EQU   10                       QCB ADDRESS              S21903 03200022
RBUF1    EQU   11                       BUFFER1 POINTER          S21903 03400022
RBASE    EQU   12                       BASE                     S21903 03600022
R13      EQU   13                       REGISTER EQUATE          S21903 03800022
REXIT    EQU   14                       EXIT REGISTER            S21903 04000022
RLINK    EQU   15                       LINKING REGISTER         S21903 04200022
         SPACE                                                          04400020
*       M I S C E L L A N E O U S  E Q U A T E S                        04600020
         SPACE                                                          04800020
XXNL     EQU   X'15'                    NEW LINE CHAR                   05000020
XXBSP    EQU   X'16'                    BACKSPACE CHARACTER             05200020
XXTAB    EQU   X'05'                    HORIZONTAL TAB                  05400020
XXEOT    EQU   X'37'                    CIRCLE C                        05600020
XXEOA    EQU   X'7B'                    # = CIRCLE D                    05800020
XXEOB    EQU   X'26'                    EOB                      S21903 06000022
XXCR     EQU   X'0D'                    CARRIAGE RETURN          S21903 06200022
XXLF     EQU   X'25'                    LINE FEED                S21903 06400022
NOMASK   EQU   X'00'                    MASK                     S22028 07660022
XXFM     EQU   X'1E'                    3270 FIELDMARK          SA61786 07720005
XXETBEBC EQU   X'26'                    EBCDIC ETB               S22028 07750022
XXSBA    EQU   X'11'                    SET BUFFER ADDRESS       S22028 07780022
IDCARD   EQU   X'E6'                    ID CARD READER AID       S22028 07870022
XXSTX    EQU   X'02'                    START OF TEXT            S21903 07900022
XXETX    EQU   X'03'                    END OF TEXT              S21903 07960022
XXON     EQU   X'11'                    TWX-ON                 @OZ12513 07980000
XXOFF    EQU   X'3C'                    3705 TWX X-OFF           Y06327 08000005
NOT      EQU   X'FF'                    MASK                     S21903 08100022
EZERO    EQU   0                        DECIMAL ZERO             S21903 08105022
EONE     EQU   1                        DECIMAL ONE              S21903 08110022
ETWO     EQU   2                        DECIMAL TWO              S21903 08115022
ETHREE   EQU   3                        DECIMAL THREE            S21903 08120022
EFOUR    EQU   4                        DECIMAL FOUR           @Y17XAYP 08125000
EFIVE    EQU   5                        DECIMAL FIVE           @Y17XAYP 08130000
ESEVEN   EQU   7                        DECIMAL SEVEN            S22028 08135022
BYTE234  EQU   7                        ADDRESS MASK FOR STCM  @Y17XAYP 08140000
E128     EQU   128                      DECIMAL                  S22028 08145022
FOUR     EQU   4                        OFFSET FOR RETURN ROUT   S22025 08155022
E80      EQU   80                       DECIMAL                  S21903 08160022
FORTY4   EQU   44                       OFFSET TO R6 IN SAVE AREAS22025 08180022
RN3705   EQU   X'EF'                    TURN OFF 3270 REMOTE FLG Y06327 08182005
LF3705   EQU   X'25'                    3705 TWX LF CODE         Y06327 08184005
CR3705   EQU   X'0D'                    3705 TWX CR CODE         Y06327 08186005
ESIX     EQU   6                        DECIMAL 6                Y06327 08194005
UNEX     EQU   X'01'                                           @ZA02057 08197058
         EJECT                                                          08200020
         USING IEDQPRF,RPREFIX          BUFFER BASE              S21903 08400022
         USING IEDQQCB,RQCB             QCB BASE                 S21903 08600022
         USING IEDQLCB,RLCB             LCB/PLCB BASE            Y06327 08800005
         USING IEDQAVTD,RAVT            AVT BASE                 S22025 09000022
         USING IEDQSCB,RSCB             SCB BASE                 S21903 09200022
         USING IEDNTRM,RPARM            WORK REGISTER          @YM04685 09400000
         SPACE 3                                                        09600020
         USING *,RBASE                                                  09800020
IEDAYC   IEDHJN ID,HJN                                         @Y17XAYP 10000000
         TM    SCBERR2,SCBCODER         HAS TRANSLATION ERROR OCCURRED  11000020
         BO    EXIT                     BRANCH ON YES                   11200020
         TM    AVTBIT3,AVTTSAB          IS TSO ABENDING          A44022 11250021
         BO    EXIT                     BRANCH YES               S21903 11300022
         LH    RPARM,PRFSRCE            INDEX TO TNT                    11400020
         L     RLINK,AVTRNMPT           TERM NAME TABLE ROUTINE         11600020
         BALR  REXIT,RLINK              EXECUTE IT                      11800020
         L     RQCB,EZERO(,RPARM)       GET QCB ADDRESS                 12000020
         TM    QCBFLAG,QCBTSSES         IN TSO SESSION         @YM05704 12060000
         BZ    EXIT                     BR NO                  @YM05704 12120000
         SPACE                                                          12200020
         LR    RBUF1,RPARM              SAVE TRM TABLE ENTRY ADDRS22028 12400022
         LA    RNDX,TRMPRFSZ            GET TRM PREFIX SIZE    @Y17XAYP 12410000
         SR    RPARM,RNDX               BACK UP TO PREFIX      @Y17XAYP 12420000
         STCM  RPARM,ESEVEN,AVTDOUBL+EFIVE  SAVE TRM PREFIX    @Y17XAYP 12430000
*                                       ADDRESS                @Y17XAYP 12440000
         MVC   AVTDOUBL+EFOUR(EONE),TRMSTATE SAVE TRMSTATE     @Y17XAYP 12450000
*                                       FOR ACCESS             @Y17XAYP 12460000
         SPACE 3                                                        12600020
         LR    RNDX,RPREFIX             SAVE TCAM BUF PTR       SA67755 12800005
         IEDDCT REG=RUNDX,FLD=AVTPARM3,LEN=4                   @Y17XAYP 13000000
OKTSB    EQU   *                                                        20600020
         L     RPREFIX,CVTPTR           ADDRESS OF CVT                  20800020
         USING CVT,RPREFIX                                              21000020
         TM    QCBTSOF1,QCBDELAY        IS QCB ON DELAY QUEUE           21430020
         BNO   NODELAY                  NO, GET TJID AS USUAL           21460020
         LR    RPARM,RQCB               ADDR OF QCB TO MOVE     SA67755 21490005
         L     RLINK,AVTHG02            TIME DELAY REMOVAL      SA67755 21510005
         BALR  REXIT,RLINK              REMOVE QCB FROM DELAY   SA67755 21530005
************************************************************** @G36XRYP 21535000
*        FIND TSB                                              @G36XRYP 21540000
************************************************************** @G36XRYP 21545000
NODELAY  EQU   *                                                        21550020
         L     RPREFIX,CVTPTR           GET CVT ADDRESS        @G36XRYP 21560000
         L     RPREFIX,CVTASVT-CVT(RPREFIX) GET ASVT ADDRESS   @G36XRYP 21570000
         LH    RSCAN,QCBTJID            GET ASID FROM QCB      @G36XRYP 21600000
         BCTR  RSCAN,EZERO              REDUCE BY 1                     21800020
         SLL   RSCAN,2                  MULTIPLY ASID BY 4     @G36XRYP 21850000
         L     RPREFIX,ASVTENTY-ASVT(RSCAN,RPREFIX) GET ASCB   @ZM46782 21900000
         L     RPREFIX,ASCBTSB-ASCB(RPREFIX) GET TSB ADDRESS   @G36XRYP 21950000
         USING TSB,RPREFIX                                              23600020
         MVC   AVTPARM3(1),TSBLNSZ      GET LINE SIZE FROM TSB          23620020
         SR    RWORK,RWORK              CLEAR REGISTER                  23640020
         IC    RWORK,TSBLNNO            GET NUMBER OF LINES IF DISPLAY  23660020
         BCTR  RWORK,0                  REDUCE BY ONE                   23680020
         STC   RWORK,AVTDOUBL+2         STORE IN AVT                    23700020
         MVI   AVTDOUBL+1,EZERO         CLEAR BYTE FOR FLAGS            23720020
         TM    TSBSTAT,TSBATNLD         IS ATTN FOR LINE DELETE         23740020
         BZ    NODELE                   BRANCH NO                       23760020
         OI    AVTDOUBL+1,TSBATNLD      SAVE BIT IN AVT FOR NOW         23780020
NODELE   EQU   *                                                        23800020
         TM    TSBFLG2,TSBAULST+TSBAUTON  IF ON MOVE TO AVT BYTE        23840020
*                                       ELIMINATES NEED FOR TSB REG     23880020
         BNO   CONTIN                   BRANCH IF NOT ON                23920020
         OI    AVTDOUBL+1,TSBAULST+TSBAUTON SAVE BITS                   23960020
CONTIN   EQU   *                                                        24000020
         LR    RPREFIX,RNDX             RETRIEVE TCAM BUF PTR  SA67755  24200005
         ST    RPREFIX,FORTY4(R13)      SAVE 1ST TCAM BUF ADR  SA67755  24300005
         USING IEDQPRF,RPREFIX                                          24400020
         SPACE                                                          24600020
         SR    RUNDX,RUNDX                                              24800020
         IC    RUNDX,PRFNBUNT           NO. UNITS/BUFFER                25000020
         LH    RNDX,PRFSIZE             SIZE OF DATA                    25200020
         TM    SCBERR3,SCBATTN          WAS ATTN SET IN LINE END        25220020
         BZ    EXIT1050                 BR IF NO                        25240020
         TM    SCBERR4,SCBSLCTN          WAS ATTN ON READ RESPONSE      25260020
         BZ    EXIT1050                 BR IF NO                        25280020
         OI    SCBERR3,SCBSATTN          YES SET NULL LINE IND.         25300020
         NI    SCBERR4,255-SCBSLCTN      TURN OFF SELECT ERROR          25320020
*                                                                       25340020
EXIT1050 EQU   *                                                        25360020
*                                                                       25380020
         LTR   RNDX,RNDX                ZERO LENGTH BUFFER?             25400020
         BZ    LOCCHK                   CHK FOR 2260L NULL LINE         25600020
         SR    RLINK,RLINK             CLEAR FOR IC OF ISIZE     Y06327 25800005
         IC    RLINK,LCBISZE           GET NUMBER OF RESERVES    Y06327 26000005
         TM    PRFSTAT1,PRFNHDRN        HDR BUFFER                      26260020
         BO    NOTHDR                   NO                              26320020
         LA    RSCAN,PRFSHDR            POINT BEYOND TCAM PFX           26420020
         AR    RSCAN,RLINK             START OF DATA             Y06327 26600005
         LA    RLIM,AVTHDRSZ(RLINK)    SIZE HDR PRF AND RESERVES Y06327 26700005
         B     TSOB1                    BRANCH FOR HEADER BUFFER S22025 26800022
NOTHDR   EQU   *                                                        26840020
         LA    RSCAN,PRFSTXT            START TCAM TEXT                 26880020
         AR    RSCAN,RLINK             START OF DATA             Y06327 26920005
         LA    RLIM,AVTTXTSZ(RLINK)    SIZE TXT PRF AND RESERVES Y06327 27120005
TSOB1    EQU   *                                                        27400020
         SR    RNDX,RLIM                REDUCE SIZE FOR PREFIX          27600020
         BZ    LOCCHK                   CHK FOR 2260L NULL LINE         27800020
         EJECT                                                          27800300
***************************************************************@YM06629 27800600
*                                                              @YM06629 27800900
*        THIS SECTION OF CODE DOES THE SPECIAL PROCESSING      @YM06629 27801200
*        NECESSARY FOR DFC COMMANDS AND NULL RU'S.             @YM06629 27801500
*                                                              @YM06629 27801800
***************************************************************@YM06629 27802100
         SPACE                                                          27802400
         USING IEDRH,RRH                RH ADDRESSABILITY      @YM06988 27802700
         SPACE                                                          27803000
         CLI   LCBFLAG1,LCBPLCB         NCP RESOURCE?          @YM06988 27804000
         BNE   PROCDATA                 BR NO                  @YM06629 27808000
         TM    LCBSTAT5,LCBLUNIT        LU?                    @YM06988 27812000
         BNO   PROCDATA                 BR NO                  @YM06629 27816000
         LA    RRH,PRF1LEN              LNG OF NEG PREFIX      @YM06988 27856000
         LNR   RRH,RRH                  MAKE IT NEGATIVE       @YM06988 27860000
         AR    RRH,RPREFIX              BACK UP TO RH          @YM06988 27864000
         TM    TRHBYTE0,TRHDFC          IS THIS A DFC COMMAND  @Y17XAYP 27872000
         BNO   NOTDFC                   BR NO                  @YM06629 27876000
         TM    TRHBYTE0,TRHSDI          IS SENSE DAT INCLUDED  @Y17XAYP 27877000
         BNO   NOTEXR                   NO, FIRST BYTE IS CMD  @YM06988 27878000
         LA    RSCAN,L'SNSSYSTM+L'SNSUSER(RSCAN)  POINT        @YM06988 27880000
*                                       TO FIRST BYTE          @Y17XAYP 27882000
NOTEXR   CLI   AVTEZERO(RSCAN),CD1CANCL CANCEL DFC CMD         @YM06988 27884000
         BNE   CKESIG                   CHECK FOR SIGNAL CMD   @Y17XAYP 27886000
         OI    SCBERR3,SCBXPD           INDICATE LINE DELETE   @Y17XAYP 27888000
         NI    SCBERR3,NOT-SCBXPI-SCBSATTN-SCBATTN  RESET      @Y17XAYP 27888800
         OI    PRFSTAT1,PRFCNCLN        INDICATE TO IEDAYI     @YM07261 27889600
*                                       THAT THE LINE IS TO BE @YM07261 27890400
*                                       CANCELLED              @YM07261 27891200
         B     EXIT                     EXIT                   @YM07261 27892000
CKESIG   CLI   AVTEZERO(RSCAN),CD1SIG   SIGNAL DFC CMD         @YM06988 27894000
         BNE   CKLUSTAT                 CHECK FOR LUSTAT CMD   @Y17XAYP 27896000
         OI    SCBERR3,SCBATTN          INDICATE HDWRE ATTN    @Y17XAYP 27898000
         B     RTNBFR                   GO SET BFR RTN         @YM06629 27900000
CKLUSTAT CLI   AVTEZERO(RSCAN),CD1LSTAT LUSTATUS DFC CMD       @YM06988 27902000
         BNE   RTNBFR                   BR NO                  @YM06629 27904000
*                                       COMPONENT AVAILABLE    @YM06629 27906000
         CLC   EONE(L'COMPAV,RSCAN),COMPAV                     @YM06629 27908000
         BNE   CKPERM                   BR NO                  @YM06629 27910000
         NI    QCBFLAG,X'FF'-QCBREAD    ALLOW SEND NEXT TIME   @YM06629 27912000
         B     RTNBFR                   GO SET BFR RTN         @YM06629 27914000
CKPERM   EQU   *                                               @YM06629 27916000
*                                       PERMANENT ERROR STATUS @YM07002 27918000
         CLC   EONE(L'PERMERR,RSCAN),PERMERR                   @YM07002 27920000
         BNE   CKNOFMD                  BR NO                  @YM06629 27922000
         OI    SCBERR4,SCBCTLUN         INDICATE HANGUP PROCESS@Y17XAYP 27924000
         B     RTNBFR                   GO SET BFR RTN         @YM06629 27926000
CKNOFMD  EQU   *                                               @YM06629 27928000
*                                       NO FM DATA TO XMIT     @YM06629 27930000
         CLC   EONE(L'NOFMD,RSCAN),NOFMD                       @YM06629 27932000
         BNE   RTNBFR                   BR NO                  @YM06629 27934000
         OI    SCBERR4,SCBCTLUN         FORCE HANGUP           @YM06629 27936000
         B     RTNBFR                   GO SET BFR RTN         @YM06629 27938000
         SPACE                                                          27940000
NOTDFC   EQU   *                                               @YM06629 27942000
         CH    RNDX,H1                  ONE BYTE OF DATA       @YM07001 27944000
         BNE   PROCDATA                 BR NO                  @YM06629 27946000
         CLI   AVTEZERO(RSCAN),AVTEZERO IS IT A NULL RU        @YM07001 27948000
         BNE   PROCDATA                 BR NO                  @YM06629 27950000
RTNBFR   EQU   *                                               @YM06629 27952000
         LA    RPARM,AVTBFRTB           ADDRESS OF BFR RETURN  @YM06629 27952500
         STCM  RPARM,BYTE234,SCBDESTQ   SET DESTINATION TO     @YM06629 27953000
*                                       BUFFER RETURN          @Y17XAYP 27953500
         B     EXIT                     EXIT                   @Y17XAYP 27954000
         SPACE                                                          27954500
         DROP  RRH                                                      27955000
         SPACE                                                          27955500
COMPAV   DC    X'0001'                  COMPONENT AVAILABLE    @YM06629 27956000
NOFMD    DC    X'0002'                  NO FM DATA TO XMIT     @YM06629 27957000
PERMERR  DC    X'081C'                  PERMANENT ERROR        @YM06629 27958000
         EJECT                                                          27959000
PROCDATA EQU   *                                               @Y17XAYP 27960000
         SR    RCNT,RCNT                INITIALIZE CARR POSITION        28000020
         TM    PRFSTAT1,PRFNHDRN        THIS HEADER?                    28100020
         BO    TEXT                     NO. LEAVE BITS ON               28200020
         TM    QCBRETCT,QCBCR           NL SEEN LAST TIME               28300020
         BO    NLAST                    BRANCH NO                       28350020
         B     TEXT                     NO PICK UP CARRIAGE CNT@OZ29032 28400082
         SPACE                                                          28505020
LOCCHK   EQU   *                                                        28510020
         TM    AVTPARM3+2,DCTLOCAL      LOCAL 2260             @G36XRYP 28515000
         BZ    EXIT                     BRANCH IF NO                    28520020
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BFR     A44875 28521095
         BO    EXIT                     BRANCH NO. IS NOT NULL   A44875 28522095
         MVC   SCBDESTQ(3),AVTTSOPT+1   SET TO POST TO TSINPUT          28525020
         MVI   PRFSIZE+1,X'1F'          SET SIZE TO HDR SIZE+1   S22029 28530022
         MVI   PRFSHDR,X'15'            PUT NEW LINE IN BUFFER   S22029 28535022
         B     GIETX2                   GO COUNT IT                     28540020
         SPACE                                                          28550020
TEXT     EQU   *                                                        28600020
         IC    RCNT,QCBCARCT            PRESET LINE POSITION            28650020
         B     NCNT                     START SCAN                      28700020
NLAST    EQU   *                                                        28800020
         NI    QCBRETCT,NOT-QCBNL       TURN OFF CR/LF AT HDR TIME      29000020
NCNT     EQU   *                                                        29200020
         MVI   QCBCARCT,EZERO           CLEAR FOR NEW LINE              29400020
         LH    RLIM,AVTKEYLE            UNIT SIZE                       29600020
         SR    RLIM,RLINK              UNIT SIZE MINUS RESERVES  Y06327 30100005
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER  S22025 30660022
         BO    TXTIN                    BRANCH IF NO             S22025 30730022
         SH    RLIM,H30                 SUBTRACT FOR TCAM HEADER PREFIX 30800020
         B     TSX                      BRANCH FOR HEADER BUFFER S22025 30840022
TXTIN    EQU   *                                                        30880020
         SH    RLIM,H23                 SUBTRACT FOR TCAM TEXT BUF      30920020
         B     MAINLOOP                 BYPASS EOT/EOA CHECK     S22025 30960022
TSX      EQU   *                                                        31030020
         TM    PRFSTAT1,PRFNHDRN        THIS A HEADER BFR               31100020
         BO    MAINLOOP                 BRANCH ON NO                    31170020
         MVI   AVTDOUBL,0                                               31240020
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 31260000
         BO    CHKDISP                  YES, BRANCH              S22028 31280022
*  THIS IS A HEADER BUFFER. IF TWX LINE, MAKE SPECIAL TEST              31310020
         TM    AVTPARM3+2,DCTTWX+DCTLOCAL  TWX OR 2260 LOCAL   @G36XRYP 31380000
*                                          NO EOA              @G36XRYP 31410000
         BM    MAINLOOP                 CAN BYPASS EOT/EOA CHECK        31450020
         SPACE                                                          31520020
         CLI   0(RSCAN),XXEOT           LOOK FOR EOT ONLY               31660020
         BE    NULL                     NULL LINE                       31720020
         CLI   LCBFLAG1,EZERO           3705 ATTACHED DEVICE   @YA11532 31750058
         BE    CHKDISP                  BRANCH YES             @YA11532 31780058
         CLI   EZERO(RSCAN),XXEOA       IS FIRST CHAR CIRCLE D          31820020
         BNE   CHKDISP                  BRANCH NO TO CHECK ON STXS22025 32000022
         TM    LCBTSOB,LCB2741N         IS THIS A 2741?                 32200020
         BO    MAINLOOP                 YES. FIRST BYTE IS DATA         32400020
         MVI   0(RSCAN),0               ZERO INPUT CIRCLE D             32600020
         B     NEXT                     DONT COUNT CIRCLE D             32700020
NULL     EQU   *                                                        32710020
         OI    SCBERR3,SCBATTN+SCBSATTN BOTH ON FOR NULL LINE           32740020
         OI    QCBRETCT,QCBNL                                           32750020
         B     GIEOB                    BRANCH TO STRIP END CNTRLS22025 32760022
         SPACE                                                          32770020
MAINLOOP EQU *                                                          32800020
         CLI   EZERO(RSCAN),LF3705      3705 TWX LF CODE         Y06327 32850005
         BE    TWXCHK                   YES. TEXT FOR 3705 TWX   Y06327 32900005
MAIN1    EQU   *                                                 Y06327 32950005
         CLI   EZERO(RSCAN),XXNL        SEE IF NEW LINE CHAR            33000020
         BE    REPLNL                   TRANS TABL REPLACES LF WITH NL  33200020
         CLI   0(RSCAN),XXBSP           BACKSPACE?                      34200020
         BE    GIBKSP                   YES                             34400020
         CLI   0(RSCAN),XXTAB           HOW ABOUT HORIZ. TAB            34600020
         BE    GITAB                    GOT ONE                         34800020
         TM    AVTPARM3+1,DCT3270       THIS A 3270 TERMINAL?  @G36XRYP 35200000
         BO    TESTETX                  YES, BRANCH              S22028 35300022
         CLI   EZERO(RSCAN),XXON        IS IT TWX X-ON         @OZ12513 35302000
         BE    GIEOT                    YES...TREAT AS X-OFF   @OZ12513 35304000
         CLI   EZERO(RSCAN),CR3705      3705 TWX CR CODE         Y06327 35307005
         BE    TWXCHK1                  YES. TEST FOR 3705 TWX   Y06327 35314005
MAIN2    EQU   *                                                 Y06327 35321005
         CLI   EZERO(RSCAN),XXEOB       EOB RECEIVED             S22028 35330022
         BE    REPLEOB                  YES, BRANCH              S22028 35360022
         TM    AVTPARM3+3,DCTNOIDL      IS THIS A 2260 REMOTE? @G36XRYP 35400000
         BO    TESTETX                  YES, BRANCH              S22028 35500022
         CLI   0(RSCAN),XXEOT           IS IT AN EOT             S22028 35520022
         BE    GIEOT                    YES, BRANCH              S22028 35540022
         CLI   0(RSCAN),XXOFF           IS IT 3705 TWX X-OFF     Y06327 35541005
         BE    TWXCHK2                  BRANCH IF YES            Y06327 35542005
         B     NOTREM                   NO CONTINUE              S22028 35560022
TESTETX  CLI   0(RSCAN),XXETX           ETX RECEIVED ?           S22028 35600022
         BE    GIETX                    ETX SAME AS TWX XOFF     S22028 35700022
         CLI   EZERO(RSCAN),XXETBEBC    EBCDIC ETB RECEIVED      S22028 35800022
         BE    NEXT                     YES, DO NOT COUNT        S22028 35900022
         CLI   EZERO(RSCAN),XXFM        IS THIS 3270 FIELDMARK  SA61786 36000005
         BE    REPLCR                   YES - CHANGE TO NL      SA61786 36100005
         CLI   EZERO(RSCAN),XXSTX       STX RECEIVED             S22028 36200022
         BE    NEXT                     YES, DO NOT COUNT        S22028 36300022
         CLI   0(RSCAN),XXCR            END OF LINE?                    36500020
         BE    REPLCR                   YES. CHANGE TO NL AND CHK       36600020
NOTREM   EQU   *                                                        36800020
         LA    RCNT,1(,RCNT)            COUNT 1 POSITION                37200020
         MVI   AVTPARM,NOT              INDICATE DATA SEEN              37230020
         NI    QCBRETCT,NOT-QCBNL       TURN OF LF/CR INDICATORS        37260020
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 37330000
         BO    CLRLINK                  YES, BRANCH              S22028 37360022
         TM    AVTPARM3+3,DCTNOIDL      IS DEVICE 2260 REMOTE  @G36XRYP 37400000
         BO    CLRLINK                  YES, BRANCH                     37600020
         TM    AVTPARM3+2,DCTLOCAL      IS DEVICE 2260 LOCAL   @G36XRYP 37800000
         BNO   NEXT                     NO, BRANCH                      38000020
CLRLINK  SR    RLINK,RLINK              CLEAR REGISTER                  38200020
         IC    RLINK,AVTPARM3           GET LINE SIZE                   38400020
         CR    RCNT,RLINK               COUNT GREATER THAN LINE  S22025 38600022
         BNL   RESET                    BRANCH YES TO RESET COUNTS22025 38800022
NEXT     EQU   *                                                        39000020
         MVC   AVTDOUBL(1),0(RSCAN)                                     39200020
         LA    RSCAN,1(,RSCAN)          STEP BUF POINTER                39400020
         BCT   RNDX,NXTBYTE             MORE TO GO                      39600020
**  ALL DONE                                                            39800020
         L     RBUF1,FORTY4(R13)        RESTORE BUFFER ADDRESS   S22028 39850022
         TM    PRFSTAT1-IEDQPRF(RBUF1),PRFNLSTN IS THIS LAST BUFFER     39900020
         BNZ   NEXT01                   DO HAVE ANOTHER BFR             40060020
         SPACE 1                                                 Y06327 40062005
*                                                                       40064058
*        THIS SECTION OF CODE SETS UP FOR AUTOMATIC CARRIAGE RETURN     40065058
*        FOR NON-DISPLAY DEVICES ATTACHED TO A 3705 (WHICH DOES NOT     40066058
*        SEE EOB/EOT)                                                   40067058
*                                                                       40068058
         SPACE 1                                                 Y06327 40069058
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE PREFIX        @Y17XAYP 40070000
         BZ    RNCHK                    NO. CONTINUE             Y06327 40071058
         TM    AVTPARM3+ETHREE,DCT1050  1050 TERMINAL          @G36XRYP 40072000
         BO    KEYBD                    YES. CONTINUE            Y06327 40073058
         TM    AVTPARM3+EONE,DCT5041+DCT2741 5041/2741 TERM    @G36XRYP 40074000
         BNM   GIETX1                   NO, DISPLAY OR TWX     @ZA02057 40075058
*                                       YES, 5041 OR 2741      @ZA02057 40076058
         SPACE 2                                                        40077058
KEYBD    EQU   *                                                        40078058
         CLI   AVTDOUBL,XXNL            WAS LAST CHAR NEW LINE @ZA02057 40079058
         BE    EOB05                    YES, DON'T SET ATTN    @ZA02057 40080058
         TM    QCBRETCT,QCBCR           WAS NEW LINE ENTERED   @ZA02057 40081058
         BO    EOB05                    YES, BRANCH            @ZA02057 40082058
         TM    LCBCSW+3,UNEX            WAS EOT RECEIVED       @ZA02057 40083058
         BZ    EOB05                    NO BRANCH              @ZA02057 40084058
         OI    SCBERR3,SCBATTN          SET ATTN               @ZA02057 40085058
         L     RBUF1,FORTY4(R13)        RESTORE BUFFER ADDR    @ZA02057 40086058
         TM    PRFSTAT1-IEDQPRF(RBUF1),PRFNHDRN THIS IS HDR BUF@ZA02057 40087058
         BO    EOB05                    NO, MUST HAVE DATA     @ZA02057 40088058
         LTR   RCNT,RCNT                IS DATA COUNT ZERO     @ZA02057 40089058
         BNZ   EOB05                    NO, BRANCH             @ZA02057 40090058
         OI    SCBERR3,SCBSATTN         SET NO DATA            @ZA02057 40091058
EOB05    EQU   *                                               @ZA02057 40092058
         LTR   RCNT,RCNT                NEED CARRIAGE RETURN     Y06327 40100058
         BNZ   ETXX                     BRANCH YES               Y06327 40110058
         TM    AVTDOUBL+EFOUR,TRMPREF   IS THERE A PREFIX      @Y17XAYP 40111000
         BZ    NOPREFIX                 NO,SKIP PREFIX PROCESS @Y17XAYP 40112000
         ICM   RBUF1,ESEVEN,AVTDOUBL+EFIVE  GET TRM PREFIX     @Y17XAYP 40113000
*                                       ADDRESS                @Y17XAYP 40114000
         NI    TRMBYTE2-IEDNTRM(RBUF1),NOT-TRMWRBRK INDICATE   @YM04685 40115000
*                                       WRITE BREAK NOT IN     @Y17XAYP 40116000
*                                       PROGRESS               @Y17XAYP 40117000
NOPREFIX EQU   *                                               @Y17XAYP 40118000
         NI    LCBTSOB,X'FF'-LCBWRBRK   NO. SET WRITE BRK BIT OFFY06327 40120058
         NI    SCBERR1,SCBCUTFF-SCBNOBFN AND ERROR BITS          Y06327 40130058
         B     FINAL                    EXIT                     Y06327 40140058
RNCHK    EQU   *                                                 Y06327 40150058
         LTR   RCNT,RCNT                WAS NL LAST                     40160058
         BNZ   GIETX1                   B NO. COUNT LINE IF NEEDSA59324 40170058
         TM    QCBRETCT,QCBNL           NL OR CR/LF RCVD        SA59324 40180058
         BO    FINAL                    B YES. NO SPCL ACTION   SA59324 40190058
         SPACE 1                                                SA61787 40200058
         B     ETXX                     FLAG FOR NL/CR/LF INSERTSA59324 40210058
NEXT01   EQU   *                                                        40300020
*  ANOTHER BUFFER IS COMING. SAVE INDIC OF NL IF LAST IN BFR.           40400020
         CLI   AVTDOUBL,XXNL            WAS LAST CHAR NL                40600020
         BNE   FINAL                    NO                              40900020
         OI    QCBRETCT,QCBCR           INDICATE NL IN THIS BFR         41200020
         B     FINAL                    RETURN                          41600020
CHKDISP  EQU   *                                                        41800020
         TM    AVTPARM3+3,DCTNOIDL      2260 REMOTE ?          @G36XRYP 42000000
         BO    CHKSTX                   IF YES CHK FOR STX       S22028 42010022
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 42020000
         BNO   MAINLOOP                 NO, BRANCH               S22028 42030022
         TM    AVTPARM3+2,DCTBISYN+DCTSTCTL 3270 REMOTE ?      @G36XRYP 42040000
         BNO   CHKLOC                   NO. BRANCH FOR 3270 LOCALY06327 42050005
*                                       YES. REMOTE 3270         Y06327 42050905
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE PREFIX        @Y17XAYP 42051800
         BNO   CKAUTOPL                 NO. CHECK FOR AUTOPOLL   Y06327 42052705
         NI    AVTPARM3+ETWO,RN3705     YES. TREAT 3705/3270     Y06327 42053605
*                                       REMOTE AS A 3270 LOCAL   Y06327 42054505
         XC    EZERO(ETWO,RSCAN),EZERO(RSCAN) ZERO OUT CU & DEV  Y06327 42055405
         LA    RSCAN,ETWO(RSCAN)        INCREMENT SCAN PTR BY 2  Y06327 42056305
         SH    RNDX,H2                  REDUCE DATA SIZE BY 2    Y06327 42057205
         SH    RLIM,H2                  REDUCE BUFFERSIZE BY 2   Y06327 42058105
CHKLOC   EQU   *                                                 Y06327 42059005
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER  S22028 42060022
         BO    NXTBYTE                  NO, GO ADVANCE SCAN PTR  S22028 42070022
SAVEADDR LA    RWORK,ESEVEN             GET # OF BITS TO CHECK   S22028 42080022
         DROP  RPARM                    DROP ADDRESSABILITY      S22028 42090022
         USING IEDQTRM,RBUF1            SET UP ADDRESSABILITY    S22028 42100022
         LR    REXIT,RWORK              GET # OF BITS TO CHECK   S22028 42110022
         LA    RLINK,E128               SET FOR TM EX INSTR      S22028 42120022
CHKBITS  EQU   *                                                 S22028 42130022
         EX    RLINK,TESTBITS           IS THIS TRMDEVFL ON ?    S22028 42140022
         BO    SHIFTMSK                 YES, DONT DECREMENT      S22028 42150022
*                                       NUMBER OF BITS ON        S22028 42160022
         BCTR  RWORK,0                  DECR # OF BITS ON        S22028 42170022
SHIFTMSK EQU   *                                                 S22028 42180022
         SRL   RLINK,EONE               SHIFT MASK RIGHT ONE     S22028 42190022
         BCT   REXIT,CHKBITS            BRANCH IF ALL BITS       S22028 42200022
*                                       NOT CHECKED              S22028 42210022
         LA    RLINK,TRMOPNO            ADDR OF NUMBER OF        S22028 42220022
*                                       OPTIONS IF ANY, ELSE     S22028 42230022
*                                       ADDRESS OF FIRST         S22028 42240022
*                                       DEVICE DEPENDENT FIELD   S22028 42250022
         SR    REXIT,REXIT              ZERO REG FOR IC INSTR    S22028 42260022
         TM    TRMSTATE,TRMOPTFN        ANY OPTION FIELDS ?      S22028 42270022
         BZ    CHECKDDF                 NO, CHECK FOR            S22028 42280022
*                                       DEVICE DEPENDENT FIELDS  S22028 42290022
         IC    REXIT,TRMOPNO            GET NUMBER AND           S22028 42300022
*                                       SIZE OF OPTIONS          S22028 42310022
         LA    RLINK,ETHREE(REXIT,RLINK) BUMP PAST REST OF TERM  S22028 42320022
*                                        ENTRY AND ANY OPTIONS   S22028 42330022
CHECKDDF EQU   *                                                 S22028 42340022
         LTR   RWORK,RWORK              ANY TRMDEVFL BITS ON ?   S22028 42350022
         BZ    STORINFO                 NO - RLINK NOW POINTS TO S22028 42360022
*                                       FIRST DEV DEP FIELD      S22028 42370022
BUMPDDF  EQU   *                                                 S22028 42380022
         IC    REXIT,0(0,RLINK)         GET LENGTH OF DDF        S22028 42390022
         LA    RLINK,EONE(REXIT,RLINK)  BUMP PAST LENGTH FIELD   S22028 42400022
*                                       AND DEV DEP FIELD        S22028 42410022
         BCT   RWORK,BUMPDDF            BRANCH IF MORE FIELDS    S22028 42420022
STORINFO EQU   *                                                 S22028 42430022
         LA    RLINK,ETHREE(RLINK)      BUMP PAST USED BYTES     S22028 42440022
         MVC   0(1,RLINK),EZERO(RSCAN)  SAVE AID BYTE            S22028 42450022
ADDINCR  EQU   *                                                 S22028 42510022
         LR    RWORK,RNDX               GET DATA SIZE            S22028 42520022
         TM    AVTPARM3+2,DCTBISYN+DCTSTCTL  3270 REMOTE?      @G36XRYP 42530000
         BNO   ADDINCR1                 NO, BRANCH               S22028 42531022
         BCTR  RWORK,0                  REDUCE BY ONE FOR ETX    S22028 42532022
ADDINCR1 EQU   *                                                 S22028 42533022
         CH    RWORK,H1                 IS THIS AID BYTE ONLY    S22028 42534022
         BE    AIDONLY                  YES, REDUCE BUFFERSIZE   S22028 42535022
         CH    RWORK,H3                 IS THIS ENTER KEY ONLY   S22028 42536022
         BNE   CHKSBA                   NO, BRANCH TO CHECK SBA  S22028 42537022
         MVI   3(RSCAN),XXNL            INSERT NEW LINE IN BUFFERS22028 42538022
         LA    RNDX,1(RNDX)             ADD 1 TO DATA SIZE       S22028 42539022
         LA    RLIM,1(RLIM)             ADD 1 TO BUFFERSIZE      S22028 42540022
         LH    RLINK,PRFSIZE            GET SIZE OF DATA         S22028 42541022
         LA    RLINK,1(RLINK)           ADD ONE TO IT            S22028 42542022
         STH   RLINK,PRFSIZE            STORE SIZE OF DATA       S22028 42543022
         TM    AVTPARM3+2,DCTBISYN+DCTSTCTL  3270 REMOTE?      @G36XRYP 42544000
         BNO   ADDINCR3                 NO, REDUCE BUFFERSIZE    S22028 42545022
         MVI   4(RSCAN),XXETX           INSERT ETX FOR REMOTE    S22028 42546022
ADDINCR3 EQU   *                                                 S22028 42547022
         LA    RSCAN,ETWO(RSCAN)        INCREMENT SCAN PTR BY 2  S22028 42560022
         BCTR  RNDX,0                   REDUCE DATA SIZE BY 1    S22028 42570022
         BCTR  RLIM,0                   REDUCE BUFFERSIZE BY 1   S22028 42580022
         B     ONEMORE                  REDUCE BY ONE MORE       S22028 42590022
CHKSBA   EQU   *                                                 S22028 42591022
         CLI   3(RSCAN),XXSBA           IS SBA PRESENT IN DATA   S22028 42592022
         BNE   ADDINCR3                 NO, BRANCH TO INCREMENT  S22028 42593022
         CLI   0(RSCAN),IDCARD          ID CARD READER DATA      S22028 42593122
         BNE   CHKSBA1                  NO, BRANCH TO INCREMENT  S22028 42593222
         CLI   6(RSCAN),XXSBA           IS SECOND SBA PRESENT    S22028 42593322
         BNE   CHKSBA1                  NO, BRANCH TO INCREMENT  S22028 42593422
         MVC   3(3,RSCAN),EZERO(RSCAN)  OVERLAY FIRST SBA/ADR/ADRS22028 42593522
*                                       WITH AID/CUR/CUR         S22028 42593622
         XC    0(3,RSCAN),0(RSCAN)      ZERO OUT AID/CUR/CUR     S22028 42593722
         LA    RSCAN,ETHREE(RSCAN)      INCREMENT SCAN PTR BY 3  S22028 42593822
         SH    RNDX,H3                  REDUCE DATA SIZE BY 3    S22028 42593922
         SH    RLIM,H3                  REDUCE BUFFERSIZE BY 3   S22028 42594022
CHKSBA1  EQU   *                                                 S22028 42594122
         LA    RSCAN,ETHREE(RSCAN)      INCREMENT SCAN PTR BY 3  S22028 42594222
         SH    RNDX,H3                  REDUCE DATA SIZE BY 3    S22028 42595022
         SH    RLIM,H3                  REDUCE BUFFERSIZE BY 3   S22028 42596022
         B     ADDINCR3                 BRANCH TO INCREMENT SCAN S22028 42597022
         SPACE                                                          42598022
CHKSTX   CLI   0(RSCAN),XXSTX           STX ?                    S22028 42600022
         BNE   MAINLOOP                 NO, BRANCH               S22028 42610022
         XC    0(2,RSCAN),0(RSCAN)      ZERO STX AND ADDR CHAR   S22028 42620022
         LA    RSCAN,1(,RSCAN)                                   S22028 42630022
ONEMORE  EQU   *                                                 S22028 42640022
         BCTR  RNDX,0                   REDUCE LINE SIZE BY      S22028 42650022
*                                       ONE FOR SMI              S22028 42660022
         BCT   RLIM,NEXT                REDUCE BU SIZE AND       S22028 42670022
*                                       GO TO NEXT CHARACTER     S22028 42680022
         B     NXTBYTE                  GO ADVANCE SCAN POINTER  S22028 42690022
         SPACE                                                          42691022
AIDONLY  EQU   *                                                 S22028 42692022
         TM    AVTPARM3+2,DCTBISYN+DCTSTCTL  3270 REMOTE?      @G36XRYP 42693000
         BO    GIETX                    YES, STRIP ETX           S22028 42694022
         B     GIETX1                   COUNT LINE               S22028 42695022
         SPACE                                                          42696022
CKAUTOPL EQU   *                                                 S22028 42700022
         CLI   0(RSCAN),NOMASK          IS THIS A HEX ZERO       S22028 42701022
         BNE   CHKSOH                   NO, CHECK FOR SOH%R MSG  S22028 42702022
         LA    RSCAN,EONE(RSCAN)        IF YES SKIP OVER IT      S22028 42703022
         BCTR  RNDX,EZERO               AND ADJUST DATA AND      S22028 42704022
         BCTR  RLIM,EZERO               BUFFER SIZE BY ONE.      S22028 42705022
CHKSOH   EQU   *                                                 S22028 42706022
         TM    SCBERR2,SCBSOHE          IS THIS 3270 SOH%R MSG   S22028 42710022
         BZ    CHKSTX1                  NO, BRANCH TO CHECK STX  S22028 42730022
         OI    QCBRETCT,QCBIEND         SET 3270 SCREEN FORMAT BIT22028 42736022
         B     EXIT                     BRANCH TO EXIT           S22028 42742022
CHKSTX1  CLI   0(RSCAN),XXSTX           STX?                     S22028 42750022
         BNE   MAINLOOP                 NO, BRANCH               S22028 42760022
         XC    0(3,RSCAN),0(RSCAN)      ZERO OUT STX,CU AND DEV  S22028 42770022
         LA    RSCAN,ETHREE(RSCAN)      INCREMENT SCAN PTR BY 3  S22028 42780022
         SH    RNDX,H3                  REDUCE DATA SIZE BY 3    S22028 42790022
         SH    RLIM,H3                  REDUCE BUFFERSIZE BY 3   S22028 42990022
         B     SAVEADDR                 GO SAVE AID BYTE         S22028 43190022
NXTBYTE  EQU   *                                                        43600020
         BCT   RLIM,MAINLOOP            REDUCE UNIT SIZE, CONT.  S22025 43800022
**  END OF UNIT                                                         44000020
         BCT   RUNDX,NXU                ANY MORE UNITS THIS BUFFER?     44200020
         B     FINAL                    NO                              44400020
NXU      EQU   *                                                        44600020
         L     RPREFIX,PRFTIC           ADDRESS OF NEXT UNIT            44800020
         LA    RSCAN,AVTUMALN(,RPREFIX) SCAN BEYOND CCW-TIC             45000020
         LH    RLIM,AVTKEYLE            UNIT SIZE                       45200020
         B     MAINLOOP                 START NEXT UNIT                 45400020
FINAL    EQU   *                                                        45600020
**  LAST UNIT AND BUFFER CHECKED. WE CAN EXIT NOW                       45800020
         STC   RCNT,QCBCARCT            STORE CURRENT POSITION          46000020
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 46050000
         BZ    EXIT                     NO, EXIT                 S22028 46100022
         NI    QCBRETCT,NOT-QCBNL       TURN OFF NL INDICATOR    S22028 46150022
         SPACE                                                          46200020
EXIT     EQU   *                                                        46400020
         L     RLINK,AVTUI              ADDR OF RETURN ROUT      S22025 46600022
         B     FOUR(RLINK)              RETURN TO CALLER         S22025 46800022
TWXCHK2  EQU   *                                                        46810005
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE PREFIX        @Y17XAYP 46820000
         BZ    NOTREM                   NO. CONTINUE CHECKING    Y06327 46830005
         TM    AVTPARM3+2,DCTTWX        IS THIS A TWX LINE     @G36XRYP 46840000
         BO    TWXEOT                   BRANCH IF YES            Y06327 46850005
         B     NOTREM                   NO. CONTINUE CHECKING    Y06327 46860005
         SPACE 3                                                        47000020
GIEOT    EQU   *                                                        47200020
         TM    AVTPARM3+2,DCTTWX        IS THIS A TWX LINE     @G36XRYP 47400000
         BO    TWXEOT                   BRANCH YES                      47600020
         CLI   AVTDOUBL,XXNL                                            47800020
         BE    GIEOB                    LAST WAS NL. DO NOT SET ATTN    48000020
         TM    QCBRETCT,QCBCR           HAVE WE SEEN THE NL             48200020
         BO    GIEOB                    BRANCH YES                      48400020
         OI    SCBERR3,SCBATTN          SET ATTENTION BIT               48800020
         L     RBUF1,FORTY4(R13)        RESTORE BUFFER ADDRESS   S22028 48850022
         TM    PRFSTAT1-IEDQPRF(RBUF1),PRFNHDRN  THIS HDR BFR           48900020
         BO    GIEOB                    NO. MUST HAVE HAD DATA          49000020
         LTR   RCNT,RCNT                IF HDR, CONTAINS COUNT OF DATA  49100020
         BNZ   GIEOB                    BRANCH IF COUNT          S22025 49200022
         OI    SCBERR3,SCBSATTN         NO DATA                         49400020
         SPACE                                                          49600020
GIEOB    EQU   *                                                        49800020
         BAL   REXIT,MINUS1             STRIP END CONTROL               49900020
         LTR   RCNT,RCNT                NEED CARR REUTRN                50000020
         BNZ   ETXX                     BRANCH YES                      50200020
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE A PREFIX      @Y17XAYP 50220000
         BZ    NOPRF                    NO,SKIP PREFIX PROCESS @Y17XAYP 50240000
         ICM   RBUF1,ESEVEN,AVTDOUBL+EFIVE  GET TRM PREFIX     @Y17XAYP 50260000
*                                       ADDRESS                @Y17XAYP 50280000
         NI    TRMBYTE2-IEDNTRM(RBUF1),NOT-TRMWRBRK  INDICATE  @YM04685 50300000
*                                       WRITE BREAK NO LONGER  @Y17XAYP 50320000
*                                       IN PROGRESS            @Y17XAYP 50340000
NOPRF    EQU   *                                               @Y17XAYP 50360000
         NI    LCBTSOB,NOT-LCBWRBRK     SET WRITE BREAK BIT OFF  S21903 50400005
         NI    SCBERR1,SCBCUTFF-SCBNOBFN                                50600020
         B     NEXT                     TO GET NEXT CHAR IF ANY         50900020
TWXEOT   EQU   *                                                        51040020
GIETX    EQU   *                        LOOK FOR ETX ONLY               51050020
         BAL   REXIT,MINUS1             STRIP EOT                       51060020
GIETX1   EQU   *                                                        51065020
         TM    QCBRETCT,QCBCR+QCBLF     WER BOTH LF AND CR SEEN         51070020
         BO    FINAL                    IF SO BRANCH                    51080020
         SR    RLINK,RLINK              CLEAR FOR INSERT CHAR           51090020
         IC    RLINK,AVTPARM3           GET LINE SIZE                   51100020
         CR    RCNT,RLINK               IF END LINE, HAS BEEN COUNTED   51118420
         BE    ENDLINE                  DECIDE IF CR NEEDED    @YA12281 51118858
*  NOT FULL LINE. LINE HAS BEEN COUNTED IF LAST CHAR WAS NL.            51119220
         TM    QCBRETCT,QCBNL           WAS LAST CHAR NL                51119620
         BO    ET00                     IF YES, NONE NEEDED             51120620
GIETX2   EQU   *                                                        51121620
         CLI   QCBSATCT,NOT             FF COMPARE               S21903 51122605
         BE    ETXX                     BRANCH IF YES                   51123620
         TM    QCBTSOF2,QCBSIMRD        RESP TO SIM ATTN READ?    M1191 51123900
         BZ    GIETX3                   NO, COUNT LINE          SA53605 51124222
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 51124300
         BO    GIETX3                   YES, COUNT LINE          S22028 51124422
         TM    AVTPARM3+3,DCTNOIDL      IS THIS A 2260 REMOTE  @G36XRYP 51124500
         BO    GIETX3                   YES, COUNT LINE         SA53605 51124722
         TM    AVTPARM3+2,DCTLOCAL      IS THIS A 2260 LOCAL   @G36XRYP 51124800
         BZ    ETXX                     NO, DO NOT COUNT LINE   SA53605 51125022
GIETX3   EQU   *                                                SA53605 51125222
         IC    RLINK,QCBSATCT           CURRENT LINE COUNT      SA53605 51125422
         LA    RLINK,EONE(,RLINK)       ADD ONE                         51125620
         STC   RLINK,QCBSATCT           STORE IT BACK                   51126620
ETXX     EQU   *                                                        51128620
         LA    RCNT,NOT                 IF NOT, SET INPUT FLAG FOR AYE  51133320
         B     FINAL                    END OF DATA IS X-OFF (EOT)      51140020
ENDLINE  EQU   *                                               @YA12281 51142058
         TM    AVTPARM3+2,DCTTWX        IS THIS A TWX LINE?    @G36XRYP 51144000
         BO    ETXX                     YES, NEED A CR         @YA12281 51146058
         SPACE                                                          51150020
ET00     EQU   *                                                        51160020
         SR    RCNT,RCNT                CLEAR LINE COUNT                51170020
         B     FINAL                    RETURN TO MH             S22025 51180022
TWXCHK   EQU   *                                                 Y06327 51181005
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE PREFIX        @Y17XAYP 51182000
         BZ    MAIN1                    NO. CONTINUE CHECKING    Y06327 51183005
         TM    AVTPARM3+ETWO,DCTTWX     YES. IS THIS A TWX LINE@G36XRYP 51184000
         BZ    MAIN1                    NO. CONTINUE CHECKING    Y06327 51185005
         B     REPLNL1                  YES. SET QCB LF BIT      Y06327 51186005
         SPACE 1                                                 Y06327 51187005
TWXCHK1  EQU   *                                                 Y06327 51188005
         TM    AVTDOUBL+EFOUR,TRMPREF   TRM HAVE PREFIX        @Y17XAYP 51189000
         BZ    MAIN2                    NO. CONTINUE CHECKING    Y06327 51190005
         TM    AVTPARM3+ETWO,DCTTWX     YES. IS THIS A TWX LINE@G36XRYP 51191000
         BZ    MAIN2                    NO. CONTINUE CHECKING    Y06327 51192005
         B     REPLEOB1                 YES. SET QCB CR BIT      Y06327 51193005
         SPACE 1                                                 Y06327 51194005
         SPACE                                                          51200020
REPLNL   EQU   *                                                        51210020
         TM    AVTPARM3+2,DCTTWX        IS THIS A TWX LINE     @G36XRYP 51220000
         BZ    GINL                     BRANCH NO                       51230020
         MVI   0(RSCAN),XXLF            CHANGE NL TO LF                 51240020
REPLNL1  EQU   *                                                 Y06327 51245005
         OI    QCBRETCT,QCBLF                                           51250020
         B     REP01                    USE COMMON CODE                 51260020
         SPACE                                                          51270020
REPLEOB  EQU   *                                                        51280020
         TM    AVTPARM3+2,DCTTWX        IS THIS A TWX LINE     @G36XRYP 51290000
         BZ    GIEOB                    BRANCH NO                       51300020
         MVI   0(RSCAN),XXCR            REPLACE EOB WITH TTY CR         51310020
REPLEOB1 EQU   *                                                 Y06327 51311005
         OI    QCBRETCT,QCBCR           INDICATE CR RECEIVED            51313020
         SR    RCNT,RCNT                INDICATE CARR AT LEFT MARGIN    51316020
REP01    EQU   *                                                        51319020
         MVI   AVTPARM,EZERO            TURN OFF DATA INDICATOR         51322020
         B     NEXT                     GET NEXT CHARACTER              51325020
         SPACE                                                          51330020
GITAB    EQU   *                        DUMMY FOR NOW                   51400020
         LA    RCNT,132                 ASSUME WORST CASE               51600020
         B     NEXT                     GET NEXT CHARACTER       S22025 51800022
         SPACE                                                          51850020
REPLCR   EQU   *                                                        51900020
         MVI   0(RSCAN),XXNL            2260R CR TO NL                  51950020
         SPACE                                                          52000020
GINL     EQU   *                                                        52200020
         LA    RLINK,2                  SEE IF MORE THAN 2 CHAR LEFT    52900020
         CR    RNDX,RLINK               INCLUDING THIS ONE              53600020
         BH    RESET                    YES. RESET COUNT TO 0           54300020
         SR    RCNT,RCNT                RESET COUNT REGISTER            55000022
         OI    QCBRETCT,QCBNL           INDICATE NL RECEIVED            55700020
RESET    EQU   *                                                        56400020
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 56460000
         BO    BALUPL                   YES, BRANCH              S22028 56520022
         TM    AVTPARM3+3,DCTNOIDL      IS DEVICE 2260 REMOTE  @G36XRYP 56600000
         BO    BALUPL                   YES, BRANCH                     56800020
         TM    AVTPARM3+2,DCTLOCAL      IS DEVICE 2260 LOCAL   @G36XRYP 57000000
         BNO   NOTDISP                  NO, BRANCH                      57200020
BALUPL   EQU   *                                                        57400020
         CLI   QCBSATCT,NOT             FF COMPARE               S21903 57430005
         BE    NOTDISP                  BRANCH IF YES                   57460020
         IC    RLINK,QCBSATCT           SIM ATTN LINE COUNT             57500020
         LA    RLINK,1(,RLINK)          INCR BY 1                       57600020
         STC   RLINK,QCBSATCT           PUT IT BACK                     57700020
NOTDISP  EQU   *                                                        57800020
         SR    RCNT,RCNT                RESET COUNT REG                 58000020
         TM    AVTPARM3+1,DCT3270       IS THIS A 3270 TRM     @G36XRYP 58050000
         BZ    NEXT                     NO, GET NEXT CHARACTER   S22028 58100022
         TM    QCBRETCT,QCBNL           WAS NL RECEIVED          S22028 58110022
         BZ    NEXT                     NO, GET NEXT CHARACTER   S22028 58120022
         LA    RCNT,NOT                 SET N/L FLAG FOR AYB     S22028 58150022
         B     NEXT                     GET NEXT CHARACTER       S22025 58200022
         SPACE                                                          58400020
GIBKSP   EQU   *                                                        67400020
         LTR   RCNT,RCNT                SEE IF ANY COUNTED              67600020
         BZ    NEXT                     DON'T BSP PAST 0                67800020
         BCT   RCNT,NEXT                DELETE 1                        68000020
         B     NEXT                     GET NEXT CHARACTER       S22025 68200022
         SPACE                                                          68400020
MINUS1   EQU   *                                                        68600020
         L     RBUF1,FORTY4(R13)        RESTORE BUFFER ADDRESS   S22028 68700022
         LH    RLINK,PRFSIZE-IEDQPRF(RBUF1) GET SIZE OF DATA     S22025 68800022
         BCTR  RLINK,0                  SUBTRACT ONE FROM SIZE   S22025 68900022
         STH   RLINK,PRFSIZE-IEDQPRF(RBUF1) OF DATA IN BUFFER    S22025 69000022
         BR    REXIT                    UPDATE PRFSIZE & RETURN  S22025 69100022
H1       DC    H'1'                     HALFWORD OF ONE          S22025 69200022
H2       DC    H'2'                     HALFWORD OF TWO          Y06327 69300005
H3       DC    H'3'                     HALFWORD OF THREE        S22025 69400022
H23      DC    H'23'                    TCAM TEXT PREFIX SIZE    S22025 69900022
H30      DC    H'30'                    TCAM HEADER BUFFER PREFIX SIZE  70100020
TESTBITS TM    TRMDEVFL,NOMASK          EXECUTED DEVFL BIT TEST  S22028 70150005
ZAPSPACE DC    6F'0'                    PATCH AREA               S22025 70200022
         EJECT                                                          70400020
         TPRFD                                                          70800020
         TQCBD                                                          71200020
         TAVTD                                                          71400020
         TCD1D                                                          71450000
         TDCTD                                                          71500000
CVT      DSECT                                                          71600020
         CVT                                                            71800020
         IKJTSB                                                         72400020
         TSCBD                                                          72600020
         TLCBD                                                          72800020
         TRHD                                                           72860000
         TSIBD                                                          72890000
         TSNSD                                                          72920000
         TTNTD                                                          73000020
         TTRMD                                                          73200020
         IHAASCB                                                        73300000
         IHAASVT                                               @ZM46782 73350000
         END                                                            73400020
