         TITLE 'IEDAYGP - TYPE 1 SVC PORTION OF TGET AND TPUT'          00090020
IEDAYGP  CSECT                                                  YS02019 00100002
         GBLC  &LIB                                            @Z944FIX 00120001
&LIB     SETC  'LIB4'                                          @Z944FIX 00150001
*                   VS- 2 RELEASE 3.7 MAINT                             00153003
*                                                                       00156003
*                                                                       00159003
*                                                                       00162003
*  C 314040,314060                                              ZA26776 00162503
*  C 917094                                                     ZA25139 00163003
*  C 763039                                                     ZA24904 00164003
*  D 261100,261200                                              ZA16628 00165003
*  A 266700-267000,268600                                       ZA16628 00167003
*A262000-253000                                                 ZA14775 00169003
*                                                              @ZA12530 00171003
*                                                              @ZA12530 00174003
*304500,304800                                                  ZA12530 00177003
         SPACE 2                                                        00180020
*********************************************************************** 00270020
***** US02278 FIXES APAR OS60002 *****                          SA60002 00270102
***** UY70029 IS THE SAME AS US02278, BUT FOR VS *****          YA00677 00270202
*1150113800,203300,522900,945580                                 S22028 00270402
*1150113800,856600                                               M1800  00272021
*1150306000,333900                                               M1770  00280021
*1150113800,840600,842600,849600,868600-879600,886600-889600,    M0139  00300021
*1150923480-923520                                               M0139  00330021
*                                                                     * 00360020
*                                                                S21A12 00360121
*1150113800,167400-173200,178900,180000-182700,183600-190800,    M0094  00360321
*1150203400-204300,227700,229500,265500,399600,522900,582300,    M0094  00360621
*1150593100,598500,606600-607500,623800,632100,664200-665100,    M0094  00360921
*1150690300,706500,708300,716400,723600,742500-743400,751500-    M0094  00361221
*1150754200,758700,818560-818590,818740-818950,819100-819160,    M0094  00361521
*1150819190,819340-819370,820800,839600,895000,898000,900800,    M0094  00361821
*1150901600,902600,904200                                        M0094  00362121
*1150036000,113800,128700,130500,771300-774900,784800,798300,    S21008 00363021
*1150816300-818100,819000,832500-893700,894600-909320            S21008 00366021
*1150                                                            M0103  00368021
*                                                                M2152  00370020
*                                                                M3280  00380020
*                                                                M0707  00400020
*0000823980,825700                                               M0019  00450020
*0000338400                                                      TS1615 00540020
*0000                                                            TS0018 00630020
*                                                                M0661  00720020
*0000                                                            TS0020 00760020
*                                                                TS1628 00780020
*                                                                M1479  00790020
*                                                                M2688  00800020
*                                                                 M3396 00805020
*                                                                M2793  00807020
*                                                                M4022  00808020
*                                                                 M1966 00809020
*                                                                 M5113 00809220
*                                                                 M4415 00809520
*                                                                 M5442 00809720
*                                                                 M5718 00809820
*                                                                     * 00814802
*                   RELEASE 2, VS-2, DELETIONS                        * 00819802
*                                                                     * 00824802
*D035100-037800,117000,132700,153900,156600,157500,157900       YS02019 00829802
*D160200,183400,765900-906000,923440-924100,924700              YS02019 00834802
*                                                                       00839802
*                                       3/28/73                 VS00129 00841802
*                                       5/30/73                 YM01246 00843802
*                    RELEASE 3  VS/2  CHANGES                  @ZA12528 00843903
*                                                              @ZA12528 00844003
*                                                              @ZA12528 00844103
*  A 507680-508000,509700                                       ZA12528 00844203
*  C 270090                                                     ZA12534 00844303
*0000114100,270080,270084                                      @ZA11573 00844437
*0000114100,244344,244394,244420,314052                        @ZA11104 00844537
*0000114100,284400,305200-305500,313361,313362,313842          @ZA10217 00844637
*0000114100,244344-244454,313281-313284,314001-314023          @ZA07613 00844737
*0000914701,914840                                             @ZA05453 00844837
*C114100                                                        ZA02652 00844937
*A270041,270042                                                 ZA02652 00845437
*A313210-313300                                                 ZA02652 00846237
*C114100                                                        ZA01354 00847037
*A178300,178400,265100-265400                                   ZA01354 00847837
*                                                                       00848837
* STATUS -                                                            * 00849802
*    CHANGE LEVEL 003                                           YS02019 00869802
*                                                                     * 00900020
* FUNCTION -                                                          * 00990020
*                                                                     * 01080020
*    THIS MODULE HAS THREE FUNCTIONS & IS DIVIDED INTO THREE          * 01170020
*    PARTS (ENTRIES 18, 19 AND 20) INTRODUCTORY COMMENTS FOR          * 01260020
*    THE LATTER TWO ENTRIES APPEAR AT THEIR RESPECTIVE                * 01350020
*    BEGINNINGS.                                                      * 01440020
*                                                                     * 01530020
*    THE FUNCTION OF QTIP0180 IS TO PERFORM THE EDIT AND MOVE         * 01620020
*    STEPS OF TGET. THESE STEPS INCLUDE- THE REMOVAL OF ALL           * 01710020
*    CONTROL CHARACTERS BUT HORIZONTAL TAB AND BACKSPACE (IF          * 01800020
*    BACKSPACE IS NOT USED FOR CHARACTER DELETE) FROM EDIT            * 01890020
*    TYPE MESSAGES, THE REMOVAL OF CARRIAGE RETURN OR NEW             * 01980020
*    LINE CONTROL CHARACTERS FROM THE END OF ALL MESSAGES,            * 02070020
*    THE REMOVAL OF UP TO ONE LINE FEED CONTROL CHARACTER             * 02160020
*    IF IT IS AT END OF MESSAGE AFTER CR OR NL HAS BEEN               * 02250020
*    REMOVED, MOVEMENT OF DATA FROM TS BUFFERS TO USER                * 02340020
*    BUFFER, THE PADDING WITH BLANKS ANY UNFILLED PORTION OF          * 02430020
*    THE USERS BUFFER ON EDIT TYPE MESSAGES, RETURNING EMPTY          * 02520020
*    TS BUFFERS TO THE FREE QUEUE AND UPDATE THE FREE AND             * 02610020
*    INPUT QUEUE COUNTS.                                              * 02700020
*                                                                     * 02790020
* ENTRY POINTS                                                        * 02880020
*                                                                     * 02970020
*         QTIP0180 - ENTRY FROM MODULE IGC0009C TO PERFORM            * 03060020
*                    INPUT EDITING AND DATA MOVE FOR TGET.            * 03150020
*                                                                     * 03240020
*         QTIP0190 - ENTRY FROM MODULE IGG09301 OR IGG09302           * 03330020
*                    TO PERFORM MOVE OF DATA FOR TPUT.                * 03420020
*                                                                     * 03870020
*         QTIP0290 - ENTRY FROM ABEND TO CLEAN UP                     * 03890020
*                    ANY TSBECB'S WAITED ON BY THE                    * 03910020
*                    ABENDING TASK.                                   * 03930020
*   NOTE THAT, EXCEPT FOR QTIP0290, EVERY ENTRY IS VIA BRANCH-        * 03990020
*                   L    0,ENTRYCD      ENTRY CODE                    * 04050020
*                   L    15,TSCVTQTP    QTIP ENTRY                    * 04140020
*                   BALR 14,15          GO TO QTIP                    * 04230020
*    BRANCH TABLE WITHIN QTIP (MODULE IKJGGQT0) WILL USE              * 04320020
*    THE ENTRY CODE TO BRANCH TO THE PROPER ENTRY                     * 04410020
*                                                                     * 04500020
* INPUT                                                               * 04590020
*                                                                     * 04680020
*    UPON ENTRY TO QTIP0180 THE FOLLOWING REGISTERS CONTAIN           * 04770020
*    USABLE INFORMATION                                               * 04860020
*                                                                     * 04950020
*         2- POINTER TO TS BUFFER , 5 - POINTER TO SVRB               * 05040020
*         9- POINTER TO TSB, 10- POINTER TO TIOCRPT                   * 05130020
*         12- BASE REGISTER (LOADED IN IKJGGQT0), 14- RETURN ADDR     * 05220020
*                                                                     * 05310020
*    THE EXTENDED SAVE AREA OF THE SVRB CONTAINS THE FOLLOWING        * 05400020
*    INFORMATION AT THE OFFSETS INDICATED                             * 05490020
*                                                                     * 05580020
*         00 - TJID OF TASK (TWO BYTES)                               * 05670020
*         02 - SIZE OF USER BUFFER (TWO BYTES)                        * 05760020
*         04 - FLAG BYTE OF OPTIONS REQUESTED (ONE BYTE)              * 05850020
*         05 - POINTER TO USER BUFFER (THREE BYTES)                   * 05940020
*                                                                     * 06030020
* OUTPUT                                                              * 06120020
*                                                                     * 06210020
*    UPON LEAVING QTIP0180 REGISTERS 3 THRU 11 WILL BE THE            * 06300020
*    SAME AS THEY WERE ON ENTRY.                                      * 06390020
*                                                                     * 06480020
*    REGISTER 0 WILL CONTAIN THE RETURN CODE                          * 06570020
*         00 - SUCCESSFUL                                             * 06660020
*         0C - USER BUFFER TOO SMALL FOR MESSAGE                      * 06750020
*                                                                     * 06840020
*         REGISTER 1 WILL CONTAIN THE COUNT OF DATA MOVED             * 06930020
*                                                                     * 07020020
* EXTERNAL REFERENCES                                                 * 07110020
*                                                                     * 07200020
*         IEDAYQBR - BUFFER RETURN SUBROUTINE IN IEDAYQT              * 07290002
*                                                                     * 07380020
* EXITS,NORMAL                                                        * 07470020
*                                                                     * 07560020
*         EXIT IS MADE BY BRANCHING TO ADDRESS IN RETURN REG          * 07650020
*                                                                     * 07740020
* EXITS,ERROR                                                         * 07830020
*                                                                     * 07920020
*         THERE ARE NO ERROR EXITS FOR THIS ROUTINE                   * 08010020
*                                                                     * 08100020
* TABLES/WORK AREAS                                                   * 08190020
*                                                                     * 08280020
*    THE TABLES USED BY THIS ROUTINE ARE DESCRIBED BY                 * 08370020
*    THE DSECTS AT THE END OF THE LISTING.                            * 08460020
*                                                                     * 08550020
* ATTRIBUTES                                                          * 08640020
*                                                                     * 08730020
*    REENTRANT, REFRESHABLE, PRIVILEGED, HOLDS LOCAL AND CMS LOCKS,   * 08820002
*    RUNS IN USER KEY AND KEY 0                                       * 08850002
* NOTES                                                               * 08880002
*                                                                     * 08910020
* CHARACTER CODE DEPENDENCY                                           * 09000020
*                                                                     * 09090020
*    THE OPERATION OF THIS MODULE DEPENDS UPON THE FOLLOWING          * 09180003
*    PROPERTIES OF THE INTERNAL REPRESENTATION OF THE EXTERNAL        * 09270003
*    CHARACTER SET- NO PRINTABLE CHARACTER HAVING A HEX VALUE         * 09360003
*    LESS THAN 40, HORIZONTAL TAB EQUAL TO X'05', CARRIAGE            * 09450003
*    RETURN EQUAL TO X'0D', NEW LINE EQUAL TO X'15', BACKSPACE        * 09540003
*    EQUAL TO X'16', LINE FEED EQUAL TO X'25',                        * 09630003
*    STX LINE CTL CHAR EQUAL TO X'02', ETB LINE CTL CHAR              * 09680003
*    EQUAL TO X'26',SOH DEVICE CTL CHAR EQUAL TO X'01',               * 09690003
*    SBA DEVICE CTL CHAR EQUAL TO X'11'                               * 09700003
*    BLANK EQUAL TO X'40', ILLEGAL CHARACTER EQUAL TO X'3F'.          * 09810003
*    THE SPECIFIC INSTRUCTIONS WHICH REQUIRE MODIFICATION IF          * 09900003
*    THESE PROPERTIES OF THE CHARACTER SET ARE CHANGED MAY BE         * 09990003
*    IDENTIFIED BY- BLNKCHAR, BKSPCHAR, HTCHAR, NLCHAR, LFCHAR,       * 10080003
*    CRCHAR, ILLCHAR, STXCHAR, ETBCHAR, SOHCHAR,  AND SBACHAR.        * 10170003
*                                                                     * 10260020
* NOTES                                                               * 10350020
*                                                                     * 10440020
*    NONE                                                             * 10530002
*                                                                     * 10620020
*********************************************************************** 10710020
         EJECT                                                          10800020
*********************************************************************** 10890020
*****                                                             ***** 10980020
*****               REGISTER EQUATES                              ***** 11070020
*****                                                             ***** 11160020
*********************************************************************** 11250020
         DC    C'IEDAYGP'               MODULE IDENTIFICATION           11360020
         DC    X'7131'                  DATE - 05/11/77        @ZA16628 11410003
         DS    0H                                                       11420002
         SPACE 2                                                        11430020
         ENTRY QTIP0180                                                 11520020
         ENTRY QTIP0190                                                 11610020
         ENTRY QTIP0290                                                 11740020
         SPACE                                                          11790020
R0       EQU   0                        USED TO SPEED ASSEMBLY          11880020
RCODE    EQU   0                        RETURN CODE                     11970020
RCNT     EQU   1                        COUNT OF DATA MOVED             12060020
RBUF     EQU   2                        POINTER TO TS BUFFER            12150020
RCVT     EQU   3                        POINTER TO CVT                  12240020
RBN      EQU   3                        NEXT BYTE TO BE SCANNED         12330020
RSAVE    EQU   4                        WORK REGISTER                   12420020
RTCB     EQU   4                        POINTER TO TCB                  12510020
RUBN     EQU   5                        USER BFR POSITION WHERE         12600020
*                                       NEXT BYTE GOES                  12690020
RSVRB    EQU   5                        SVRB POINTER                    12780020
RQCB     EQU   6                        QCB POINTER              S21008 12870021
RUBE     EQU   6                        END OF USER BUFFER              12960020
RTBASE   EQU   7                        TEMPORARY BASE REGISTER  S21008 13050021
RLVC     EQU   7                        PTR TO TS BFR CONTAINING        13140020
*                                       A VALID CHAR NOT MOVED          13230020
RASCB    EQU   8                        POINTER TO ASCB         YS02019 13270002
RTSB     EQU   9                        POINTER TO TSB                  13410020
RRPT     EQU   10                       POINTER TO TIOCRPT              13500020
RTSI     EQU   11                       TSINPUT QCB POINTER             13590020
RTCX     EQU   11                       POINTER TO TCAM CVT EXT YS02019 13680002
RASVT    EQU   11                       POINTER TO ASVT         YS02019 13730002
RBE      EQU   11                       POINTER TO END OF TS BFR        13770020
RECBP    EQU   11                       ECB POINTER FOR POST            13860020
RBASE    EQU   12                       BASE REG                        14040020
RAVT     EQU   13                       AVT POINTER                     14130020
RTJID    EQU   13                       TJID                            14220020
RXSA     EQU   13                       TEMP SVRB POINTER               14310020
RETURN   EQU   14                       RETURN ADDRESS                  14400020
RGOTO    EQU   15                       BRANCH ADDRESS                  14490020
RWRK     EQU   15                       WORK REGISTER                   14580020
         EJECT                                                          14670020
*********************************************************************** 14760020
*****                                                             ***** 14850020
*****               CONSTANT EQUATES                              ***** 14940020
*****                                                             ***** 15030020
*********************************************************************** 15120020
K0       EQU   0                        OFFSET                          15210020
K1       EQU   1                        OFFSET & INCREMENT & SZ         15300020
K2       EQU   2                        OFFSET AND SIZE         YS02019 15350002
K3       EQU   3                        OFFSET AND SIZE                 15480020
K4       EQU   4                        OFFSET AND SIZE                 15570020
SAVER14  EQU   12                       OFFSET TO THE 4TH WORD  YS02019 15620002
*                                       IN TIOCSAVE             YS02019 15670002
K16      EQU   16                       OFFSET                          15840020
K24      EQU   24                       SHIFT CONSTANT                  15930020
TPQSAVE  EQU   44                       OFFSET TO LAST 6 WORDS  YS02019 15980002
*                                       IN TIOCSAVE FOR AYTPQ   YS02019 15990002
*                                       TO USE                  YS02019 16000002
         SPACE 3                                                        16110020
***                                                                     16200020
***                 OTHER EQUATES                                       16290020
***                                                                     16380020
RC0C     EQU   X'0C'                    USER BFR TOO SMALL CODE         16470020
KZIP     EQU   X'00'                    ZERO LENGTH                     16560020
KONE     EQU   X'01'                    LENGTH OF ONE                   16650020
OFF      EQU   X'FF'                    TO TURN OFF SELECTED BIT        17370020
HTCHAR   EQU   X'05'                    HORIZONTA TAB                   17460020
CRCHAR   EQU   X'0D'                    CHARRIAGE RETURN                17550020
NLCHAR   EQU   X'15'                    NEW LINE                        17640020
BKSPCHAR EQU   X'16'                    BACKSPACE                       17730020
LFCHAR   EQU   X'25'                    LINE FEED                       17820020
STXCHAR  EQU   X'02'                    STX CONTROL CHAR        ZA01354 17830003
ETBCHAR  EQU   X'26'                    ETB CONTROL CHAR        ZA01354 17840003
ILLCHAR  EQU   X'3F'                    TCAM SUBSTITUTES THIS FOR ILLE -17850020
                                        GAL CHARACTERS                  17880020
BLNKCHAR EQU   X'40'                    BLANK                           17910020
SOHCHAR  EQU   X'01'                    SOH CHARACTER            S22028 17960002
SBACHAR  EQU   X'11'                    SBA CHARACTER            S22028 17970002
PLUSCHAR EQU   C'+'                     TO SHOW NONAUTH USER    YS02019 18010002
WAITBIT  EQU   X'80'                    ECB IS WAITED ON        YM03998 18060002
***                                                                     18280020
***                 MASKS FOR BCR INSTRUCTIONS                          18290020
***                                                                     18300020
ONES     EQU   1                        AFTER TEST UNDER MASK           18310020
NOTONES  EQU   14                       AFTER TEST UNDER MASK           18320020
EQUAL    EQU   8                        AFTER COMPARE INSTRUCTIONS      18330020
         EJECT                                                          19170020
QTIP0180 EQU   *                                                        19260020
         SPACE 4                                                        19350020
*********************************************************************** 19440020
*********************************************************************** 19530020
*****                                                             ***** 19620020
*****          QTIP ENTRY FOR EDITING AND MOVEMENT OF DATA        ***** 19710020
*****          FROM TS BUFFER(S) TO USER BUFFER.                  ***** 19800020
*****                                                             ***** 19890020
*********************************************************************** 19980020
*********************************************************************** 20070020
         SPACE 2                                                        20160020
         USING *,RBASE                                                  20250020
         USING RBSECT,RSVRB                                      M0094  20290021
         DROP  RSVRB                                             M0094  20370021
         LR    RXSA,RSVRB               SAVE RB POINTER          M0094  20410021
         USING RBSECT,RXSA                                       M0094  20450021
         SR    RCODE,RCODE              CLEAR                           20610020
         SR    RCNT,RCNT                CLEAR                           20700020
         SR    RLVC,RLVC                CLEAR                           20790020
         USING TIOCBUF,RBUF                                             20880020
         USING TSB,RTSB                                                 20970020
         USING TIOCRPT,RRPT                                             21060020
         SPACE 2                                                        21150020
***                                                             YS02019 21200002
***                  SAVE SVC CALLER'S KEY                      YS02019 21210002
***                                                             YS02019 21220002
         L     RTCB,RBLINK              NEXT RB ADDRESS         YS02019 21236002
         IC    RTCB,RBOPSW+K1-RBBASIC(,RTCB)  KEY FROM RB OPSW  YS02019 21238002
         MODESET EXTKEY=SUPR            CHANGE TO KEY 0         YS02019 21238102
         STC   RTCB,XSAUSERK            SAVE CALLER'S KEY       YS02019 21238402
         MODESET EXTKEY=TCAM            GET BACK TO TCAM'S KEY  YS02019 21238802
         SPACE 2                                                YS02019 21239202
***                                                                     21240002
***                 PLACE NEXT MESSAGE ONTO THE TRAILER                 21330020
***                 QUEUE TO PROCESS                                    21420020
***                                                                     21510020
         CLC   TSBITBFP(K3),KZERO       ANY TRAILER QUEUE MSG           21600020
         BNE   QTIE0200                 IF PARTIAL MSG                  21690020
         MVC   TSBIBFP(K3),BUFFHEAD     LINK NEXT MSG TO QUEUE          21780020
         LA    RBUF,K0(R0,RBUF)         CLEAR FIRST BYTE                21870020
         IC    RWRK,TSBITBFP-K1         GET FLAG BYTE                   21960020
         SLL   RWRK,K24                 LEFT ADJUST FLAG                22050020
         OR    RWRK,RBUF                ADD FLAG TO PTR                 22140020
         ST    RWRK,TSBITBFP-K1         UPDATE QUEUE                    22230020
         SPACE 2                                                        22320020
QTIE0200 EQU   *                                                        22410020
***                                                                     22500020
***                 SET UP USER BUFFER POINTERS                         22590020
***                                                                     22680020
         L     RUBN,XSAPRM1             GET ADDR OF USER BUFFER  M0094  22770021
         LA    RUBN,K0(R0,RUBN)         DROP FLAG BYTE                  22860020
         LH    RUBE,XSAPRMSZ            GET SIZE OF USER BUFFER  M0094  22950021
         AR    RUBE,RUBN                END OF USER BUFFER              23040020
         CLI   BUFFLNTH,K0              NULL LINE                       23130020
         BNE   QTIE0300                 IF NOT NULL LINE        YS02019 23220002
         MODESET KEYADDR=XSAUSERK,WORKREG=4 GET INTO CALLER KEY YS02019 23270002
         B     QTIE7000                 GO TO PAD USER'S BFR    YS02019 23280002
         SPACE 2                                                        23310020
QTIE0300 EQU   *                                                        23400020
***                                                                     23490020
***                 SET UP TS BUFFER DATA POINTERS                      23580020
***                                                                     23670020
         LR    RBN,RBUF                 START OF TS BFR                 23760020
         SR    RWRK,RWRK                                                23850020
         IC    RWRK,BUFFOFST            DATA OFFSET                     23940020
         AR    RBN,RWRK                 POINTER TO START OF DATA        24030020
         SR    RBE,RBE                                                  24120020
         IC    RBE,BUFFLNTH             DATA LENGTH                     24210020
         TM    BUFFFL1,BUFFHDR          IS THIS A HDR BFR        S22028 24260002
         BZ    QTIE0350                 BR IF NO                 S22028 24270002
         TM    BUFFFL2,BUFF3270         DOES THIS BFR HAVE 3270  S22028 24280002
*                                       CONTROL CHARACTERS       S22028 24290002
         BZ    QTIE0350                 BR IF NO                 S22028 24292002
         TM    XSAOPTNS,MASIS           ASIS OPTION SPECIFIED    S22028 24294002
         BO    QTIE0350                 BR IF YES                S22028 24296002
         CLI   BUFFLNTH,K3              IS DATA LENGTH LESS THAN S22028 24298002
*                                       3                        S22028 24298402
         BNL   QTIE0320                 NO, BRANCH AROUND        S22028 24298802
         LA    RBN,K1(R0,RBN)           STRIP FIRST CHAR FOR     S22028 24299202
*                                       EDIT                     S22028 24299602
         BCTR  RBE,R0                   MINUS 1 FROM DATA LNG    S22028 24299702
         B     QTIE0330                 GOTO UPDATE TS BFR       S22028 24299802
         SPACE 1                                                        24299902
QTIE0320 EQU   *                                                 S22028 24329902
         LA    RBN,K3(R0,RBN)           STRIP 3 BYTES FOR EDIT   S22028 24339902
         SH    RBE,KTHREE               SUBTRACT 3 FROM DATA LGN S22028 24349902
         CLI   K0(RBN),SBACHAR          CHECK FOR SBA CHAR       S22028 24359902
         BNE   QTIE0330                 BRANCH IF NOT            S22028 24369902
         LA    RBN,K3(R0,RBN)           STRIP 3 BYTES FOR EDIT   S22028 24379902
         SH    RBE,KTHREE               SUBTRACT 3 FROM DATA LGN S22028 24383202
         SPACE 1                                                 S22028 24385202
QTIE0330 EQU   *                                                 S22028 24385602
         STC   RBE,BUFFLNTH             UPDATE LNG IN TS BFR     S22028 24386002
         LR    RWRK,RBUF                GET TS BFR ADDR          S22028 24386402
         SR    RWRK,RBN                 OFFSET IN NEGATIVE       S22028 24386502
         LPR   RWRK,RWRK                GET POSITIVE VALUE       S22028 24386602
         STC   RWRK,BUFFOFST            UPDATE OFFSET IN TS BFR  S22028 24409902
         NI    BUFFFL2,OFF-BUFF3270     INDICATE CONTROL CHARS   S22028 24419902
*                                       ALREADY STRIPPED         S22028 24429902
         SPACE 1                                                        24431902
QTIE0350 EQU   *                                                 S22028 24432302
         AR    RBE,RBN                  POINTER TO END OF DATA          24433402
         CLC   TSBSBASV(K1),KZERO CONTROL CHAR TO SKIP?        @ZA11104 24434401
         BNH   QTIE0400                 NO GO CHECK DATA       @ZA07613 24435437
         SR    RWRK,RWRK                ZERO WORK REG.         @ZA07613 24436437
         IC    RWRK,BUFFOFST            GET OFFSET             @ZA07613 24437437
         SR    RSAVE,RSAVE              ZERO WORK REG.         @ZA07613 24438437
         IC    RSAVE,TSBSBASV           GET # OF CHARS TO SKIP @ZA11104 24439437
         AR    RWRK,RSAVE               ADD # OF CHARS TO OFFST@ZA07613 24440037
         STC   RWRK,BUFFOFST            STORE NEW OFFSET       @ZA07613 24440637
         SR    RWRK,RWRK                ZERO WORK REG          @ZA07613 24441237
         STC   RWRK,TSBSBASV            ZERO WORK AREA         @ZA11104 24441837
         IC    RWRK,BUFFLNTH            GET LENGTH             @ZA07613 24442437
         SR    RWRK,RSAVE               SUB. # OF CHARS FROM LN@ZA07613 24443437
         STC   RWRK,BUFFLNTH            STORE NEW LENGTH       @ZA07613 24444437
         AR    RBN,RSAVE                ADD # TO CHAR. POINTER @ZA07613 24445437
         SPACE 2                                                        24456702
QTIE0400 EQU   *                                                        24480020
***                                                                     24570020
***                 CHECK IF ALL DATA SCANNED                           24660020
***                                                                     24750020
         CR    RBN,RBE                  LAST CHAR ALREADY DONE          24840020
         BL    QTIE0500                 IF NOT                          24930020
         CLC   BUFFTRLR(K3),KZERO       IS THIS THE LAST TS             25020020
*                                       BFR OF THE MESSAGE              25110020
         BE    QTIE6000                 IF SO GO TO END OF DATA         25200020
*                                       ROUTINE                         25290020
         L     RBUF,BUFFTRLR-K1         IF NOT LAST PREPARE             25380020
*                                       TO CHECK NEXT BUFFER            25470020
         LA    RBUF,K0(R0,RBUF)         CLEAR FIRST BYTE                25560020
         B     QTIE0300                 START CHECK OF NEXT BFR         25650020
         SPACE 2                                                        25740020
QTIE0500 EQU   *                                                        25830020
***                                                                     25920020
***                 CHECK NEXT CHARACTER IN TS BUFFER                   26010020
***                                                                     26100020
         CLI   TSBCHDCC,K0              0 MEANS NO DELETE CHAR  OS58447 26150002
         BE    QTIE0520                 NO CHAR, DON'T COMPARE  OS58447 26170002
         CLC   K0(K1,RBN),TSBCHDCC      IS IT CHAR DELETE CHAR          26190020
         BE    QTIE1000                 IF SO HANDLE CHAR DELETE        26280020
         SPACE 1                                                        26282002
QTIE0520 EQU   *                                                OS58447 26290002
         CLI   K0(RBN),ILLCHAR          HEX '3F' IS ILLEGAL FOR ALL     26310020
         BE    QTIE0550                 IF ILLEGAL, DON'T MOVE          26340020
         CLI   K0(RBN),BLNKCHAR         IS CHARACTER VALID              26370020
         BNL   QTIE0600                 IF VALID TRY TO MOVE            26460020
*                                                                       26470003
*                  DON'T MOVE LINE CONTROL CHARACTERS.                  26480003
*                                                                       26490003
         CLI   K0(RBN),STXCHAR          STX CHAR?               ZA01354 26510003
         BE    QTIE0550                 YES, DON'T MOVE         ZA01354 26520003
         CLI   K0(RBN),ETBCHAR          ETB CHAR?               ZA01354 26530003
         BE    QTIE0550                 YES, DON'T MOVE         ZA01354 26540003
         TM    XSAOPTNS,MASIS           ASIS OPTION SPECIFIED    M0094  26550021
         BO    QTIE0600                 IF ASIS TRY TO MOVE             26640020
         TM    TSBSTAT,TSB3270          TEST FOR 3270           ZA16628 26670003
         BO    QTIE0540                 SKIP BACKSPACE TEST     ZA16628 26700003
         CLI   K0(RBN),BKSPCHAR         BACKSPACE CHAR                  26730020
         BE    QTIE0600                 IF SO TRY TO MOVE               26820020
QTIE0540 EQU   *                                                ZA16628 26860003
         CLI   K0(RBN),HTCHAR           HORIZONTAL TAB CHAR             26910020
         BE    QTIE0600                 IF SO TRY TO MOVE               27000020
         TM    TSBSTAT,TSB3270          TEST FOR 3270 TERMINAL   S22028 27002002
         BZ    QTIE0550                 BR IF NO                 S22028 27004002
         CLI   K0(RBN),SBACHAR          SBA CHARACTER ?         ZA02652 27004637
         BE    QTIE0960                 YES SKIP THREE CHAR     ZA02652 27005237
         CLI   K0(RBN),SOHCHAR          SOH CHAR                 S22028 27006002
         BNE   QTIE0550                 BR IF NO                 S22028 27008002
         MODESET EXTKEY=SUPR            CHANGE TO KEY ZERO     @ZA11573 27008437
         OI    XSAFLAG2,XSAATR          INDICATE NEXT CHAR IS A  S22028 27008637
*                                       3270 ATTRIBUTE BYTE             27008837
         B     QTIE0600                 TRY TO MOVE              S22028 27009202
         SPACE 1                                                        27010020
QTIE0550 EQU   *                                                        27020020
***                                                                     27030020
***                 CHARACTER SHOULD NOT BE MOVED                       27040020
***                                                                     27050020
         LTR   RLVC,RLVC                ANY UNMOVED DATA                27090020
         BZ    QTIE0900                 IF NOT                          27180020
         B     QTIE0950                 IF UNMOVED               M1770  27270021
         SPACE 2                                                        27360020
QTIE0600 EQU   *                                                        27450020
***                                                                     27540020
***                 MOVE CHARACTER TO USER BUFFER                       27630020
***                                                                     27720020
         CR    RUBE,RUBN                ANY ROOM LEFT IN BFR            27810020
         BNH   QTIE0700                 IF NOT                          27900020
         SPACE 2                                                YS02019 27990002
***                                                             YS02019 27996002
***                 ASSUME USER KEY FOR STORE                   YS02019 28002002
***                                                             YS02019 28008002
         IC    RWRK,K0(,RBN)            GET NEXT CHAR           YS02019 28014002
         MODESET KEYADDR=XSAUSERK,WORKREG=4                     YS02019 28032002
         STC   RWRK,K0(,RUBN)           STORE NEXT CHAR         YS02019 28038002
         MODESET EXTKEY=TCAM                                    YS02019 28044002
         SPACE 2                                                YS02019 28056002
***                                                             YS02019 28062002
***                 UPDATE COUNTS                               YS02019 28068002
***                                                             YS02019 28074002
         LA    RUBN,K1(R0,RUBN)         POINT TO NEXT USER              28080020
*                                       BUFFER SPACE                    28170020
         LA    RCNT,K1(R0,RCNT)         ADD ONE TO COUNT OF DATA        28260020
*                                       MOVED TO USER BUFFER            28350020
         B     QTIE0925                 GO UPDATE TS BFR       @ZA10217 28440037
         SPACE 2                                                        28530020
QTIE0700 EQU   *                                                        28620020
***                                                                     28710020
***                 NO ROOM LEFT IN USER BUFFER                         28800020
***                                                                     28890020
         LTR   RLVC,RLVC                WAS THERE A PRIOR VALID         28980020
*                                       CHAR THAT DIDN'T MOVE           29070020
         BNZ   QTIE0800                 IF THERE WAS                    29160020
         LR    RLVC,RBUF                SAVE TS BFR PTR                 29250020
         SPACE 2                                                        29340020
QTIE0800 EQU   *                                                        29430020
         LA    RBN,K1(R0,RBN)           POINT TO NEXT CHARACTER         29520020
*                                       IN TS BUFFER                    29610020
         LA    RUBN,K1(R0,RUBN)         POINT TO WHERE NEXT CHAR        29700020
*                                       WOULD GO IF IT COULD            29790020
         B     QTIE0400                 CHECK NEXT CHARACTER            29880020
         SPACE 2                                                        29970020
QTIE0900 EQU   *                                                        30060020
***                                                                     30150020
***                 UPDATE TS BUFFER PRIOR TO CHECKING                  30240020
***                 THE NEXT CHARACTER OF THE MESSAGE                   30330020
***                                                                     30420020
         TM    TSBSTAT,TSB3270          IS THIS 3270?           ZA12530 30450003
         BZ    QTIE0925                 NO GO UPDATE OFST-LNTH  ZA12530 30480003
         SPACE                                                          30510020
         CR    RUBE,RUBN                ANY ROOM IN USER BFR?  @ZA10217 30540037
         BNH   QTIE0950                 IF NOT                 @ZA10217 30570037
         SPACE 1                                                        30600037
QTIE0925 EQU   *                                               @ZA10217 30630037
         SR    RWRK,RWRK                                                30690020
         IC    RWRK,BUFFOFST            DATA OFFSET                     30780020
         LA    RWRK,K1(R0,RWRK)         INCREMENT BY ONE                30870020
         STC   RWRK,BUFFOFST            UPDATE OFFSET                   30960020
         IC    RWRK,BUFFLNTH            DATA LENGTH                     31050020
         BCTR  RWRK,R0                  DECREMENT                       31140020
         STC   RWRK,BUFFLNTH            UPDATE LENGTH                   31230020
QTIE0950 EQU   *                                                 M1770  31240021
         LA    RBN,K1(R0,RBN)           POINT TO NEXT CHAR       M1770  31280021
         B     QTIE0400                 CHECK NEXT CHARACTER            31320020
QTIE0960 EQU   *                                                ZA02652 31328037
         LR    RWRK,RBE                 LOAD END OF BUFFER PTR @ZA07613 31329037
         SH    RWRK,KTHREE              SUBTRACT THREE         @ZA07613 31330037
         CR    RBN,RWRK                 WITHIN 3 OF END OF BUF.@ZA07613 31331037
         BH    QTIE0975                 YES GO CALCULATE       @ZA07613 31332037
         SR    RWRK,RWRK                ZERO WORK REG           ZA02652 31336037
         CR    RUBE,RUBN                ANY ROOM IN USER BFR?  @ZA10217 31338037
         BNH   QTIE0965                 IF NOT                 @ZA10217 31340037
         IC    RWRK,BUFFOFST            GET DATA OFFSET         ZA02652 31344037
         LA    RWRK,K3(R0,RWRK)         INCREMENT BY THREE      ZA02652 31352037
         STC   RWRK,BUFFOFST            UPDATE OFFSET           ZA02652 31360037
         IC    RWRK,BUFFLNTH            GET DATA LENGTH         ZA02652 31368037
         SH    RWRK,KTHREE              DECREMENT BY THREE      ZA02652 31376037
         STC   RWRK,BUFFLNTH            UPDATE LENGTH           ZA02652 31384037
         SPACE 1                                                        31386037
QTIE0965 EQU   *                                               @ZA10217 31388037
         LA    RBN,K3(R0,RBN)           SKIP THREE CHARS        ZA02652 31392037
         B     QTIE0400                 CHECK NEXT CHAR         ZA02652 31400037
         SPACE 2                                               @ZA07613 31400437
***              CALCULATE FOR NUMBER OF CONTROL               @ZA07613 31400837
***              CHARACTERS FOLLOWING SBA WITHIN               @ZA07613 31401237
***              THIS BUFFER AND FOLLOWING BUFFER.             @ZA07613 31401637
         SPACE 2                                               @ZA07613 31402037
QTIE0975 EQU   *                                               @ZA07613 31402437
         LR    RWRK,RBN                 LOAD CHAR POINTER      @ZA07613 31402837
         SR    RWRK,RBE                 HOW MANY CHARACTERS ?  @ZA07613 31403237
         LPR   RWRK,RWRK                CONVERT TO POS. NUMBER @ZA07613 31403637
         STH   RWRK,BUFFWORK            STORE IN WORK AREA      ZA26776 31404003
         SH    RWRK,KTHREE              GET 3'S COMPLEMENT     @ZA07613 31404437
         LPR   RWRK,RWRK                CONVERT TO POS NUMBER  @ZA07613 31404837
         STC   RWRK,TSBSBASV            PUT # TO SKIP IN NXT BF@ZA11104 31405237
         SR    RWRK,RWRK                ZERO WORK REG.         @ZA07613 31405637
         LH    RWRK,BUFFWORK            GET # TO SKIP IN THIS 1 ZA26776 31406003
         AR    RBN,RWRK                 INCREMENT CHAR PTR     @ZA07613 31406437
         IC    RWRK,BUFFOFST            GET BUFFER OFFSET      @ZA07613 31406837
         AH    RWRK,BUFFWORK            ADD # OF CHARS TO OFFST@ZA07613 31407237
         STC   RWRK,BUFFOFST            STORE NEW OFFSET       @ZA07613 31407637
         IC    RWRK,BUFFLNTH            GET LENGTH             @ZA07613 31408037
         SH    RWRK,BUFFWORK            SUB # OF CHARS FROM LN @ZA07613 31408437
         STC   RWRK,BUFFLNTH            STORE NEW LENGTH       @ZA07613 31408837
         B     QTIE0400                 CHECK NEXT CHARACTER   @ZA07613 31409237
         SPACE 2                                                        31410020
QTIE1000 EQU   *                                                        31500020
*********************************************************************** 31590020
*****                                                             ***** 31680020
*****               CHARACTER DELETE ROUTINE                      ***** 31770020
*****                                                             ***** 31860020
*********************************************************************** 31950020
         SPACE                                                          32040020
         LTR   RCNT,RCNT                ANY DATA MOVED YET              32130020
         BZ    QTIE0550                 IF NOTHING TO DELETE            32220020
         BCTR  RUBN,R0                  MOVE BACK USER BFR PTR          32310020
         LTR   RLVC,RLVC                ANY UNMOVED DATA                32400020
         BNZ   QTIE1100                 IF UNMOVED DATA                 32490020
         BCTR  RCNT,R0                  DECREMENT DATA COUNT            32580020
         SPACE 2                                                        32670020
         B     QTIE0900                 PREPARE FOR NEXT CHAR           32760020
         SPACE 2                                                        32850020
QTIE1100 EQU   *                                                        32940020
         CR    RUBN,RUBE                HAVE ENOUGH CHARACTERS          33030020
*                                       BEEN DELETED TO ACCOUNT         33120020
*                                       FOR ALL VALID CHAR'S            33210020
*                                       THAT WERE NOT MOVED             33300020
         BNE   QTIE0950                 IF NOT                   M1770  33390021
         SPACE 2                                                        33480020
***                                                                     33570020
***                 REMOVE ALL VALID NON-MOVED CHARACTERS               33660020
***                 FROM TS BUFFERS                                     33750020
***                                                                     33840020
         CR    RLVC,RBUF                ARE ALL UNMOVED CHARS IN        33930020
*                                       TS BFR BEING SCANNED            34020020
         BE    QTIE1500                 IF SO                           34110020
         LR    RSAVE,RBUF               SAVE PRESENT BFR POINTER        34200020
         LR    RBUF,RLVC                                                34290020
         SPACE 2                                                        34380020
QTIE1300 EQU   *                                                        34470020
         MVI   BUFFLNTH,KZIP            ZERO LENGTH                     34560020
         L     RBUF,BUFFTRLR-K1         NEXT TS BFR PTR                 34650020
         LA    RBUF,K0(R0,RBUF)         CLEAR FIRST BYTE                34740020
         CR    RBUF,RSAVE               ALL BUT PRESENT ZEROED          34830020
         BNE   QTIE1300                 IF NOT ZERO NEXT ONE            34920020
         SPACE 2                                                        35010020
QTIE1500 EQU   *                                                        35100020
***                                                                     35190020
***                 UPDATE PRESENT BFR TO DROP DELETED CHARS            35280020
***                                                                     35370020
         LA    RBN,K1(R0,RBN)           POINT TO NEXT CHAR              35460020
         SR    RLVC,RLVC                CLEAR LAST VALID                35550020
*                                       CHARACTER BFR POINTER           35640020
         LR    RWRK,RBN                 CALCULATE THE CORRECT           35730020
         SR    RWRK,RBUF                OFFSET FOR PRESENT BFR          35820020
         STC   RWRK,BUFFOFST            AND UPDATE IT                   35910020
         LR    RWRK,RBE                 CALCULATE THE CORRECT           36000020
         SR    RWRK,RBN                 LENGTH FOR PRESENT BFR          36090020
         STC   RWRK,BUFFLNTH            AND UPDATE IT            TS1615 36180020
         B     QTIE0400                 CHECK NEXT CHAR                 36270020
         SPACE 3                                                        36360020
QTIE6000 EQU   *                                                        36450020
*********************************************************************** 36540020
*****                                                             ***** 36630020
*****               END OF MESSAGE PROCESSING                     ***** 36720020
*****                                                             ***** 36810020
*********************************************************************** 36900020
         SPACE                                                          36990020
         MODESET KEYADDR=XSAUSERK,WORKREG=4  GET CALLER'S KEY   YS02019 37060002
         LTR   RLVC,RLVC                ANY UNMOVED DATA                37080020
         BNZ   QTIE8000                 IF ANY                          37170020
         LTR   RCNT,RCNT                ANY DATA MOVED                  37260020
         BZ    QTIE7000                 IF NOT GO TO PAD                37350020
         BCTR  RUBN,R0                  LOOK AT LAST CHAR               37440020
         CLI   K0(RUBN),CRCHAR          CARRIAGE RETURN CHAR            37530020
         BE    QTIE6100                 IF SO                           37620020
         CLI   K0(RUBN),NLCHAR          NEW LINE CHAR                   37710020
         BNE   QTIE6200                 IF NEITHER                      37800020
         SPACE 2                                                        37890020
QTIE6100 EQU   *                                                        37980020
         BCTR  RCNT,R0                  DECREMENT DATA COUNT            38070020
         BCTR  RUBN,R0                  LOOK AT PRECEEDING CHAR         38160020
         LTR   RCNT,RCNT                ANY DATA LEFT                   38250020
         BZ    QTIE6500                 IF NOT                          38340020
         SPACE 2                                                        38430020
QTIE6200 EQU   *                                                        38520020
***                                                                     38610020
***                 CHECK FOR LINE FEED                                 38700020
***                                                                     38790020
         CLI   K0(RUBN),LFCHAR          IS THIS A LINE FEED             38880020
         BNE   QTIE6500                 IF NOT                          38970020
         BCTR  RCNT,R0                  DECREMENT COUNT                 39060020
         B     QTIE7000                 GO TO PAD                       39150020
         SPACE 2                                                        39240020
QTIE6500 EQU   *                                                        39330020
         LA    RUBN,K1(R0,RUBN)         RE-ADJUST USER DATA PTR         39420020
         SPACE 2                                                        39510020
QTIE7000 EQU   *                                                        39600020
***                                                                     39690020
***                 PAD USER BUFFER WITH BLANKS                         39780020
***                                                                     39870020
         TM    XSAOPTNS,MASIS           ASIS OPTION SPECIFIED    M0094  39960021
         BO    QTIE7250                 IF SO DON'T PAD         YS02019 40050002
         LR    RWRK,RUBE                END OF USER BFR                 40140020
         SR    RWRK,RUBN                AMOUNT OF BLANKS NEEDED         40230020
         LTR   RWRK,RWRK                ANY BLANKS NEEDED               40320020
         BZ    QTIE7250                 IF NONE GO TO END RTN   YS02019 40410002
         MVI   K0(RUBN),BLNKCHAR        BLANK FIRST BYTE                40500020
         BCTR  RWRK,R0                  DECREMENT NO. OF BLANKS         40590020
         LTR   RWRK,RWRK                ANY MORE TO BLANK               40680020
         BZ    QTIE7250                 NO GET TCAMS KEY        YS02019 40770002
         SPACE 2                                                        40860020
QTIE7200 EQU   *                                                        40950020
         CH    RWRK,KMAX                MORE THAN 255 MORE BLNKS        41040020
         BH    QTIE7300                 IF TOO MANY FOR ONE MOVE        41130020
         BCTR  RWRK,R0                  DECREMENT FOR EXECUTE           41220020
         EX    RWRK,QTIEPAD             PAD REMAINDER OF BFR            41310020
         SPACE 2                                                        41312002
QTIE7250 EQU   *                                                YS02019 41320002
         MODESET EXTKEY=TCAM            GET TCAM'S KEY          YS02019 41360002
         B     QTIE9500                 GO TO END ROUTINE               41400020
         SPACE 2                                                        41490020
QTIE7300 EQU   *                                                        41580020
***                                                                     41670020
***                 PAD NEXT 255 BYTES                                  41760020
***                                                                     41850020
         LH    RSAVE,KMAX               NO. TO BE MOVED                 41940020
         BCTR  RSAVE,R0                 DECREMENT FOR EXECUTE           42030020
         EX    RSAVE,QTIEPAD            PAD NEXT 255 BYTES              42120020
         AH    RUBN,KMAX                ADJUST POINTER                  42210020
         SH    RWRK,KMAX                ADJUST BLANK COUNT              42300020
         B     QTIE7200                 RECHECK NO. LEFT                42390020
         SPACE 3                                                        42480020
QTIE8000 EQU   *                                                        42570020
***                                                                     42660020
***                 CHECK FOR  CR, NL AND LF NOT MOVED                  42750020
***                                                                     42840020
         MODESET EXTKEY=TCAM            GET INTO TCAM'S KEY     YS02019 42890002
         BCTR  RBN,R0                   LOOK AT LAST CHAR OF MSG        42930020
         CLI   K0(RBN),CRCHAR           LAST CHAR CARRIAGE RET          43020020
         BE    QTIE8200                 IF SO DROP IT                   43110020
         CLI   K0(RBN),NLCHAR           LAST CHAR NEW LINE              43200020
         BE    QTIE8200                 IF SO DROP IT                   43290020
         CLI   K0(RBN),LFCHAR           LAST CHAR                       43380020
         BE    QTIE8500                 IF SO MAY DROP IT               43470020
         SPACE 2                                                        43560020
QTIE8100 EQU   *                                                        43650020
***                                                                     43740020
***                 MESSAGE TOO LONG RETURN                             43830020
***                                                                     43920020
         LA    RCODE,RC0C               RETURN CODE                     44010020
         B     QTIE9500                 GO TO END ROUTINE               44100020
         SPACE 2                                                        44190020
QTIE8200 EQU   *                                                        44280020
         IC    RWRK,BUFFLNTH            GET DATA LENGTH                 44370020
         BCTR  RWRK,R0                  DECREMENT ONE                   44460020
         STC   RWRK,BUFFLNTH            UPDATE LENGTH                   44550020
         BCTR  RUBN,R0                  UPDATE USER BFR PTR             44640020
         CLI   BUFFLNTH,K0              LENGTH OF TS BFR NOW 0          44730020
         BNZ   QTIE8400                 IF NOT ZERO                     44820020
         CR    RLVC,RBUF                IS ALL OF MSG MOVED             44910020
         BNE   QTIE8300                 IF NOT                          45000020
         BCTR  RUBN,R0                  DECREMENT USER BFR PTR          45090020
         MODESET KEYADDR=XSAUSERK,WORKREG=4  GET CALLER'S KEY   YS02019 45160002
         B     QTIE6200                 CHECK IF LAST CHAR              45180020
*                                       MOVED WAS LINE FEED             45270020
         SPACE 2                                                        45360020
QTIE8300 EQU   *                                                        45450020
***                                                                     45540020
***                 CHECK PREVIOUSLY SCANNED TS BUFFER                  45630020
***                 TO SEE IF ONLY THING LEFT IS ONE LF                 45720020
***                                                                     45810020
         LR    RSAVE,RBUF               SAVE PTR TO LAST TS BFR         45900020
         LR    RBUF,RLVC                PTR TO BFR W/UNMOVED            45990020
*                                       VALID CHARACTER                 46080020
         CLI   BUFFLNTH,KONE            LENGTH ONE                      46170020
         BNE   QTIE8100                 MSG TOO LONG                    46260020
         L     RWRK,BUFFTRLR-K1         TRAILER POINTER                 46350020
         LA    RWRK,K0(R0,RWRK)         CLEAR FIRST BYTE                46440020
         CR    RWRK,RSAVE               ANY TS BUFFERS BETWEEN          46530020
*                                       THIS ONE AND LAST ONE           46620020
         BNE   QTIE9500                 IF MORE QUIT                    46710020
         IC    RBN,BUFFOFST             OFFSET TO CHAR                  46800020
         AR    RBN,RBUF                 POINTER TO CHAR                 46890020
         B     QTIE9000                 CHECK IF LINE FEED              46980020
         SPACE 2                                                        47070020
QTIE8400 EQU   *                                                        47160020
***                                                                     47250020
***                 PREPARE TO CHECK PREVIOUS CHAR IN TS BFR            47340020
***                                                                     47430020
         BCTR  RBN,R0                   POINTER TO CHAR                 47520020
         SPACE 2                                                        47610020
QTIE8500 EQU   *                                                        47700020
***                                                                     47790020
***                 CHECK FOR LAST CHAR IN TS BUFFERS BEING LF          47880020
***                                                                     47970020
         CR    RLVC,RBUF                IS THIS LAST BFR                48060020
         BNE   QTIE8100                 IF NOT                          48150020
         CLI   BUFFLNTH,KONE            LENGTH EQUAL ONE                48240020
         BNE   QTIE8100                 IF MORE                         48330020
         SPACE 2                                                        48420020
QTIE9000 EQU   *                                                        48510020
***                                                                     48600020
***                 CHECK CHARACTER KNOWN TO BE ONLY ONE                48690020
***                 NOT MOVED TO USER BUFFER                            48780020
***                                                                     48870020
         CLI   K0(RBN),LFCHAR           IS IT LINE FEED                 48960020
         BNE   QTIE8100                 IF NOT                          49050020
         MVI   BUFFLNTH,KZIP            ZERO LNTH                       49140020
         SPACE 3                                                        49230020
QTIE9500 EQU   *                                                        49320020
*********************************************************************** 49410020
*****                                                             ***** 49500020
*****               END OF ROUTINE CLEAN UP                       ***** 49590020
*****                                                             ***** 49680020
*********************************************************************** 49770020
         L     RBUF,TSBITBFP-K1         FIRST TS BFR OF MSG             49860020
*                                       JUST MOVED                      49950020
         CLI   BUFFLNTH,KZIP            BUFFER EMPTY                    50040020
         BNE   QTIE9900                 IF NOT LEAVE                    50130020
         SPACE 2                                                        50220020
***                                                                     50310020
***                 REMOVE TS BUFFER FROM INPUT QUEUE                   50400020
***                 AND PLACE ON FREE QUEUE                             50490020
***                                                                     50580020
         MVC   TSBITBFP(K3),BUFFTRLR    UPDATE TRAILER QUEUE            50670020
         L     RGOTO,QTIEQBR            ADDRESS OF BFR RETURN   YS02019 50760002
         TM    BUFFFL1,BUFFIHOT     BFR ON BOTH QUEUES?         ZA12528 50768003
         BZ    QTIE9600             NO, GO FREE BFR             ZA12528 50776003
         NI    BUFFFL1,OFF-BUFFIHOT TURN OFF FLAG               ZA12528 50784003
         B     QTIE9800             GO HANDLE NEXT BFR          ZA12528 50792003
QTIE9600 EQU   *                                                ZA12528 50800003
         LR    RSVRB,RCODE              SAVE RETURN CODE        YS02019 50810002
         BALR  R0,RGOTO                 GO THERE AND RETURN     YS02019 50860002
         LR    RCODE,RSVRB              RESTORE RETURN CODE     YS02019 50910002
QTIE9800 EQU   *                                                ZA12528 50970003
         SR    RWRK,RWRK                                                51030020
         IC    RWRK,TSBNIBF             NO. OF INPUT BFRS               51120020
         BCTR  RWRK,R0                  DECREMENT                       51210020
         STC   RWRK,TSBNIBF             UPDATE COUNT                    51300020
         CLC   TSBITBFP(K3),KZERO       ANY MORE BFRS TO FREE           51660020
         BNE   QTIE9500                 IF SO CHECK NEXT ONE            51750020
         SPACE 2                                                        51840020
QTIE9900 EQU   *                                                        51930020
***                                                                     52020020
***                 RESTORE REGISTERS AND LEAVE                         52110020
***                                                                     52200020
         LR    RSVRB,RXSA               RESTORE SVRB ADDR       YS02019 52250002
         BR    RETURN                   RETURN TO IGC0009C              52380020
         SPACE 2                                                        52470020
***                                                                     52560020
***                 MOVE INSTRUCTION FOR BLANK PADDING                  52650020
***                                                                     52740020
QTIEPAD  MVC   K1(K1,RUBN),K0(RUBN)     MOVE WITH OVERLAP               52830020
         SPACE 2                                                YS02019 52840002
***                                                             YS02019 52850002
***                 ADDRESS OF BUFFER RETURN ROUTINE            YS02019 52860002
***                                                             YS02019 52870002
QTIEQBR  DC    V(IEDAYQBR)              IN IEDAYQT              YS02019 52880002
         EJECT                                                          52920020
*********************************************************************** 53010020
*                                                                     * 53100020
* FUNCTION -                                                          * 53190020
*                                                                     * 53280020
*    THE FUNCTION OF QTIP0190 IS TO GET A TS BUFFER FROM THE FREE     * 53370020
*    QUEUE, PLACE IN THE PROPER LOCATION ON THE OUTPUT QUEUE,         * 53460020
*    FORMAT THE BUFFER PREFIX, MOVE DATA FROM USER BUFFER TO THE      * 53550020
*    TS BUFFER.                                                       * 53640020
*                                                                     * 53730020
* ENTRY POINTS                                                        * 53820020
*                                                                     * 53910020
*    SEE QTIP0180                                                     * 54000020
*                                                                     * 54090020
* INPUT                                                               * 54180020
*                                                                     * 54270020
*    UPON ENTRY TO QTIP0190 THE FOLLOWING REGISTERS CONTAIN           * 54360020
*    USABLE INFORMATION                                               * 54450020
*                                                                     * 54540020
*         5- SVRB PTR, 9- TSB PTR, 10- TIOCRPT PTR,                   * 54630020
*         13 - SAVE AREA POINTER, 14 - RETURN ADDRESS                 * 54720002
*                                                                     * 55620020
* OUTPUT                                                              * 55710020
*                                                                     * 55800020
*    UPON LEAVING QTIP0190 THE TS BUFFER WILL BE COMPLETED            * 55890020
*    AS DESCRIBED UNDER FUNCTION, AND THE FIELDS 'XSAUBFRP,' AND      * 55980002
*    'XSAUBFRS' WILL BE UPDATED IN THE EXTENDED SAVE AREA.            * 56070002
*                                                                     * 56160020
* EXTERNAL REFERENCES                                                 * 56250020
*                                                                     * 56340020
*         IEDAYQBA - BUFFER ALLOCATE SUBROUTINE IN IEDAYQT            * 56430002
*                                                                     * 56520020
* EXITS, NORMAL                                                       * 56610020
*                                                                     * 56700020
*    EXIT IS MADE BY BRACHING TO THE ADDR IN RETURN REGISTER          * 56790020
*                                                                     * 56880020
* EXITS, ERROR                                                        * 56970020
*                                                                     * 57060020
*    THERE ARE NO ERROR EXITS FROM THIS ROUTINE                       * 57150020
*                                                                     * 57240020
* TABLES/WORK AREAS                                                   * 57330020
* ATTRIBUTES                                                          * 57420020
* CHARACTER CODE DEPENDENCY                                           * 57510020
* NOTE                                                                * 57600020
*                                                                     * 57690020
*     SEE QTIP0180 FOR ALL OF THESE                                   * 57780020
*                                                                     * 57870020
*********************************************************************** 57960020
         DROP  RXSA                                              M0094  57990021
         USING RBSECT,RSVRB                                      M0094  58020021
         SPACE 4                                                        58050020
QTIP0190 EQU   *                                                        58140020
         SAVE  (14,12)                  SAVE THE REGISTERS      YS02019 58230002
         SPACE 2                                                        58320020
***                                                                     58370002
***                 SET UP RECOVERY ENVIROMENT FOR QTIP 19              58380002
***                                                                     58390002
         MODESET EXTKEY=SUPR            KEY 0 FOR FRR           YM05909 58400002
         LA    RBN,QTOMFRR              FRR ROUTINE ADDRESS     YM05909 58402002
         SETFRR A,FRRAD=(RBN),WRKREGS=(RUBE,RLVC)               YM05909 58404002
         MODESET EXTKEY=TCAM            GET BUFR IN TCAM KEY    YM05909 58406002
         SPACE  2                                                       58408002
***                                                                     58410020
***                 GO TO IEDAYQBA TO GET A BUFFER              YS02019 58500002
***                                                             YS02019 58600002
         L     RGOTO,QTOMQBA            ADDRESS OF ROUTINE      YS02019 58700002
         BALR  R0,RGOTO                 REGISTER 2 (RBUF) NOW   YS02019 58800002
*                                       HAS A BUFFER ADDRESS    YS02019 58900002
         MODESET EXTKEY=SUPR            GET IN SUPERVISOR KEY   YM05909 58910002
         OI    XSAFLAG2,XSABFRAL        INDICATE TO ESTAE TIOC  YM05909 58950002
*                                       HAS BEEN ALLOCATED      YM05909 59000002
         MODESET EXTKEY=TCAM            GET BACK IN TCAM KEY    YM05909 59050002
         XC    TIOCBUF(BUFFHDLN),TIOCBUF  CLEAR BUFFER PREFIX   YS02019 59220002
         SPACE 2                                                        59400020
***                                                                     59490020
***                 FIND PROPER PLACE ON OUTPUT QUEUE                   59580020
***                 FOR THE NEXT BUFFER                                 59670020
***                                                                     59760020
         TM    XSAF,HSW                 HAS HDR BFR BEEN PLACED  M0094  59850021
*                                       ON OUTPUT QUEUE YET             59940020
         BO    QTOM0500                 IF HDR DONE                     60030020
         SPACE 2                                                        60120020
***                                                                     60210020
***                 FIND SPOT FOR HEADER BFR                            60300020
***                                                                     60390020
         CLC   TSBOBFP(K3),KZERO        ANYTHING ON OUTPUT QUEUE        60480020
         BNE   QTOM0100                 IF QUEUE NOT EMPTY              60570020
         STCM  RBUF,B'0111',TSBOBFP     LINK BFR TO PREVIOUS    YS02019 60670002
         B     QTOM0300                 GO FORMAT HDR BFR               60840020
         SPACE 2                                                        60930020
QTOM0100 EQU   *                                                        61020020
***                                                                     61110020
***                 FIND END OF QUEUE                                   61200020
***                                                                     61290020
         L     RSAVE,TSBOBFP-K1         FIRST HDR PTR                   61380020
         DROP  RBUF                                                     61470020
         USING TIOCBUF,RSAVE            TO CHECK OTHER BFRS             61560020
         SPACE                                                          61650020
QTOM0150 EQU   *                                                        61740020
         CLC   BUFFHEAD(K3),KZERO       IS THIS LAST MSG                61830020
         BE    QTOM0200                 IF IT IS                        61920020
         L     RSAVE,BUFFHEAD-K1        IF NOT CHECK NEXT ONE           62010020
         B     QTOM0150                 CHECK NEXT MSG                  62100020
         SPACE 2                                                        62190020
QTOM0200 EQU   *                                                        62280020
         STCM  RBUF,B'0111',BUFFHEAD    LINK NEW BFR TO END     YS02019 62380002
         DROP  RSAVE                                                    62550020
         USING TIOCBUF,RBUF                                             62640020
         SPACE 2                                                        62730020
QTOM0300 EQU   *                                                        62820020
***                                                                     62910020
***                 FORMAT HEADER BUFFER                                63000020
***                                                                     63090020
         SR    RWRK,RWRK                                        YS02019 63180002
         ST    RWRK,BUFFHEAD-K1         ZERO FLAG AND HDR PTR   YS02019 63190002
         LH    RWRK,XSAPRMTJ            GET DESTINATION TJID     M0094  63210021
         LTR   RWRK,RWRK                WAS IT SPECIFIED                63240020
         BZ    QTOM0400                 IF NOT                          63270020
         OI    BUFFFL2,BUFFTJID         INDICATE TJID MESSAGE           63300020
QTOM0400 EQU   *                                                        63330020
         MVI   BUFFOFST,BUFFHDLN        SET OFFSET                      63360020
         OI    BUFFFL1,BUFFHDR          HEADER BUFFER INDICATOR         63450020
         MVI   BUFFLNTH,K0              SET SIZE TO ZERO        YS02019 63459002
         SPACE 2                                                YS02019 63468002
***                                                             YS02019 63477002
***                 INSERT '+' SIGN IF CALLER NOT AUTHORIZED    YS02019 63486002
***                                                             YS02019 63495002
         TM    XSAF,XSAAUTH             IS CALLER AUTHORIZED    YS02019 63504002
         BO    QTOM2000                 YES, SKIP               YS02019 63513002
         MVI   BUFFHDAT,PLUSCHAR        ADD + SIGN              YS02019 63522002
         MVI   BUFFLNTH,K1              SIZE IS NOW 1           YS02019 63531002
         B     QTOM2000                 FORMAT REST OF BUFFER           63540020
         SPACE 2                                                        63630020
QTOM0500 EQU   *                                                        63720020
***                                                                     63810020
***                 FIND PROPER LOCATION FOR TRAILER                    63900020
***                                                                     63990020
         CLC   TSBOBFP(K3),KZERO        IS HEADER QUEUE EMPTY           64040020
         BNE   QTOM0800                 IF NOT, PUT ON HEADER QUEUE     64090020
         CLC   TSBOTBFP(K3),KZERO       IS TRAILER QUEUE EMPTY          64140020
         BE    QTOM0750                 IF SO, PUT ON TRAILER QUEUE     64190020
         SPACE 2                                                        64260020
***                                                                     64350020
***                 FIND END OF TRAILER QUEUE                           64440020
***                                                                     64530020
         DROP  RBUF                                                     64620020
         USING TIOCBUF,RSAVE                                            64710020
         L     RSAVE,TSBOTBFP-K1        FIRST TRAILER QUEUE BFR         64800020
         SPACE                                                          64890020
QTOM0600 EQU   *                                                        64980020
         CLC   BUFFTRLR(K3),KZERO       IS THIS THE LAST BFR            65070020
         BE    QTOM0650                 IF LAST                         65160020
         L     RSAVE,BUFFTRLR-K1        PREPARE TO CHECK NEXT           65250020
         B     QTOM0600                 CHECK NEXT BUFFER               65340020
         SPACE 2                                                        65430020
QTOM0650 EQU   *                                                        65520020
         TM    BUFFFL1,BUFFNLCR         IS THIS MSG COMPLETE            65610020
         BZ    QTOM1100                 IF NOT                          65700020
         SPACE 2                                                        65790020
QTOM0700 EQU   *                                                        65880020
***                                                                     65970020
***                 FIND END OF HEADER QUEUE                            66060020
***                                                                     66150020
         CLC   TSBOBFP(K3),KZERO        QUEUE EMPTY                     66240020
         BNE   QTOM0800                 IF NOT EMPTY                    66330020
         SPACE                                                          66340020
QTOM0750 EQU   *                                                        66350020
***                                                                     66360020
***                 PUT BUFFER ONTO TRAILER QUEUE                       66370020
***                                                                     66380020
         STCM  RBUF,B'0111',TSBOTBFP    MAKE THIS 1ST ON TRLR Q YS02019 66480002
         B     QTOM1200                 FORMAT TRAILER BFR              66600020
         SPACE 2                                                        66690020
QTOM0800 EQU   *                                                        66780020
***                                                                     66870020
***                 FIND LAST MESSAGE                                   66960020
***                                                                     67050020
         L     RSAVE,TSBOBFP-K1         FIRST HDR POINTER               67140020
         SPACE                                                          67230020
QTOM0900 EQU   *                                                        67320020
         CLC   BUFFHEAD(K3),KZERO       IS THIS LAST MSG                67410020
         BE    QTOM1000                 IF LAST                         67500020
         L     RSAVE,BUFFHEAD-K1        IF NOT CHECK NEXT ONE           67590020
         B     QTOM0900                 CHECK NEXT MSG FOR LAST         67680020
         SPACE 2                                                        67770020
QTOM1000 EQU   *                                                        67860020
***                                                                     67950020
***                 FIND END OF LAST MESSAGE                            68040020
***                                                                     68130020
         CLC   BUFFTRLR(K3),KZERO       IS THIS LAST BUFFER             68220020
         BE    QTOM1100                 IF SO LINK NEW BFR              68310020
         L     RSAVE,BUFFTRLR-K1        IF NOT PREP TO CHECK            68400020
         B     QTOM1000                 THE NEXT BUFFER OF MSG          68490020
         SPACE 2                                                        68580020
QTOM1100 EQU   *                                                        68670020
***                                                                     68760020
***                 LINK BUFFER TO LAST BUFFER OF LAST MESSAGE          68850020
***                                                                     68940020
         STCM  RBUF,B'0111',BUFFTRLR    MAKE THIS LAST OF MSG   YS02019 69030002
         DROP  RSAVE                                                    69120020
         USING TIOCBUF,RBUF                                             69210020
         SPACE 2                                                        69300020
QTOM1200 EQU   *                                                        69390020
***                                                                     69480020
***                 ADD OFFSET TO THE PREFIX                            69570020
***                                                                     69660020
         MVI   BUFFOFST,BUFFTRLN        SET OFFSET                      69750020
         SPACE 4                                                        69840020
QTOM2000 EQU   *                                                        69930020
***                                                                     70020020
***                 FORMAT FLAG BYTE OF BUFFER                          70110020
***                                                                     70200020
         SR    RWRK,RWRK                                                70290020
         IC    RWRK,TSBNOBF             GET NO. OF OUTPUT BFRS          70380020
         LA    RWRK,K1(R0,RWRK)         ADD ONE TO COUNT                70470020
         STC   RWRK,TSBNOBF             UPDATE COUNT                    70560020
         TM    XSAOPTNS,MCNTRL+MASIS    TEST FOR BOTH = FULLSCR SA60002 70650002
         BO    QTOM2050                 BOTH ON, FULL SCREEN    SA60002 70700002
         BZ    QTOM2100                 NEITHER, MUST BE EDIT   SA60002 70740002
         TM    XSAOPTNS,MASIS           TEST FOR ASIS           SA60002 70790002
         BO    QTOM2200                 GO TO ASIS PROCESS      SA60002 70800002
         OI    BUFFFL1,BUFFCNTL         MUST BE CONTROL         SA60002 70810002
         B     QTOM2200                 GO TO FURTHER CHECK     SA60002 70820002
         SPACE 2                                                        70822002
QTOM2050 EQU   *                                                SA60002 70824002
         OI    BUFFFL1,BUFFCNTL         SET FLAG FOR FULLSCR    SA60002 70826002
         SPACE 2                                                        70828002
QTOM2100 EQU   *                                                SA60002 70828402
         OI    BUFFFL1,BUFFEDIT         SET FLAG FOR EDIT       SA60002 70829202
         SPACE 2                                                        70829602
QTOM2200 EQU   *                                                        71550020
         TM    XSAOPTNS,MHOLD           HOLD OPTION SPECIFIED    M0094  71640021
         BZ    QTOM2500                 IF NOT                          71730020
         OI    BUFFFL1,BUFFHOLD         INDICATE HOLD OPTION            71820020
         SPACE 2                                                        71910020
QTOM2500 EQU   *                                                        72000020
***                                                                     72090020
***                 DETERMINE AMOUNT OF DATA TO MOVE                    72180020
***                                                                     72270020
         SR    RWRK,RWRK                                        YS02019 72280002
         SR    RSAVE,RSAVE                                      YS02019 72290002
         IC    RWRK,BUFFLNTH            GET CURRENT LENGTH      YS02019 72300002
         IC    RSAVE,BUFFOFST           GET CURRENT OFFSET      YS02019 72310002
         AR    RSAVE,RWRK               ADD OFFSET AND SIZE     YS02019 72320002
         LH    RWRK,XSAUBFRS            USER BUFFER SIZE         M0094  72360021
         AR    RWRK,RSAVE               ADD USER BFR & PREFIX           72630020
         CH    RWRK,TIOCBFSZ            CAN ALL OF MSG BE MOVED         72720020
         BH    QTOM3000                 IF NOT ROOM FOR ALL             72810020
         OI    BUFFFL1,BUFFNLCR         INDICATE EOM                    72900020
         B     QTOM4000                 MOVE ALL DATA                   72990020
         SPACE 2                                                        73080020
QTOM3000 EQU   *                                                        73170020
***                                                                     73260020
***                 MOVE ONE BFR FULL OF DATA                           73350020
***                                                                     73440020
         LH    RWRK,TIOCBFSZ            TS BFR SIZE                     73530020
         SPACE 2                                                        73620020
QTOM4000 EQU   *                                                        73710020
         SR    RWRK,RSAVE               AMOUNT OF DATA TO MOVE          73800020
         SR    RASCB,RASCB                                      YS02019 73890002
         IC    RASCB,BUFFLNTH           GET OLD SIZE            YS02019 73910002
         AR    RASCB,RWRK               ADD NEW SIZE            YS02019 73930002
         STC   RASCB,BUFFLNTH           STORE TOTAL SIZE        YS02019 73950002
         LR    RCNT,RBUF                COPY OF TS BFR PTR              73980020
         AR    RCNT,RSAVE               POINTER TO WHERE DATA           74070020
*                                       IS TO BE MOVED                  74160020
         L     RSAVE,XSAUBFRP           NEXT DATA FROM HERE      M0094  74260021
         BCTR  RWRK,R0                  SUBTRACT ONE FOR EXECUTE        74430020
         SPACE 2                                                YS02019 74436002
***                                                                     74442002
***                 REFERENCE BUFFER IN USER KEY BEFORE MOVING IN       74448002
***                 KEY ZERO                                            74454002
***                                                                     74460002
         L     RASCB,TSBCTCB            GET TCB PT FOR MODESET  YS02019 74466002
         USING TCB,RASCB                                        YS02019 74472002
         MODESET EXTKEY=RBT234,WORKREG=8                        YS02019 74478002
         CLI   K0(RSAVE),K0             TOUCH FIRST BYTE        YS02019 74484002
         AR    RSAVE,RWRK               GO TO LAST BYTE         YS02019 74490002
         CLI   K0(RSAVE),K0             ...AND TOUCH IT         YS02019 74496002
         SR    RSAVE,RWRK               BACK TO 1ST BYTE        YS02019 74502002
         MODESET EXTKEY=SUPR,WORKREG=8                          YS02019 74508002
         DROP  RASCB                                            YS02019 74514002
         EX    RWRK,QTOMMOVE            MOVE DATA                       74520020
         SPACE 2                                                        74610020
***                                                                     74700020
***                 UPDATE USER BUFFER POINTER AND SIZE                 74790020
***                                                                     74880020
         LA    RWRK,K1(R0,RWRK)         ADD BACK TO AMOUNT MOVED        74970020
         AR    RSAVE,RWRK               ADD AMOUNT TO POINTER           75060020
         ST    RSAVE,XSAUBFRP           UPDATE 'NEXT' POINTER    M0094  75130021
         LH    RSAVE,XSAUBFRS           GET OLD SIZE             M0094  75200021
         SR    RSAVE,RWRK               CALC REMAINING LENGTH    M0094  75270021
         STH   RSAVE,XSAUBFRS           STORE UPDATED SIZE       M0094  75340021
***                                                                     75426020
***                 CHECK WHETHER SYSTEM SHOULD BE IN LWAIT             75432020
***                                                                     75438020
         SR    RWRK,RWRK                                                75444020
         CH    RWRK,TIOCNFBF            ANY FREE BFRS AT ALL            75450020
         BE    QTOM4100                 NO, PUT SYS INTO LWAIT          75456020
         CLC   TIOCNFBF,TIOCUSLW        ARE ENOUGH BFRS FREE            75462020
         BNL   QTOM4200                 YES, DON'T PUT SYS IN LWT       75468020
QTOM4100 EQU   *                                                        75474020
***                                                                     75480020
***                 PUT SYSTEM IN LWAIT                                 75486020
***                                                                     75492020
         OI    TIOCFLG,TIOCSYLW         INDICATE SYSTEM LWAIT           75498020
QTOM4200 EQU   *                                                        75504020
         SETFRR D,WRKREGS=(RCNT,RBUF)   DELETE FRR FROM STACK   YM05909 75506002
         SPACE 2                                                        75510020
***                                                                     75600020
***                 RETURN TO USER                                      75690020
***                                                                     75780020
         RETURN (14,12)                 RESTORE REGS AND RETURN YS02019 75870002
         EJECT                                                          75920002
*********************************************************************** 75970002
*                                                                     * 76020002
*          Q T I P  19   FRR EXIT ROUTINE                             * 76070002
*     THIS ROUTINE GETS CONTROL WHEN AN ABEND OCCURS DURING THE       * 76120002
*     PROCESSING OF QTIP 19. IT WILL THEN CHECK IF TIOC BUFFERS       * 76130002
*     WERE ALLOCATED,AND IF SO FREE THEM. UPON EXIT FOR THIS          * 76132002
*     ROUTINE, R T M WILL CONTINUE ITS TERMINATION PROCESSING.        * 76134002
*                                                                     * 76134402
*             REGISTERS AT ENTRY                                      * 76136002
*                                                                     * 76138002
*             REGISTER  1 - SDWA                                      * 76138402
*             REGISTER 14 - R T M RETURN ADDRESS                      * 76138802
*             REGISTER 15 - ENTRY POINT                               * 76139202
*                                                                     * 76139602
*********************************************************************** 76139702
QTOMFRR  EQU   *                                                YM05909 76139802
         USING SDWA,RCNT                SDWA ADDRESSABILITY     YM05909 76139902
         LM    RSVRB,RAVT,SDWAGR05      RESTORE REGS 5-13       YM05909 76169902
         TM    XSAFLAG2,XSABFRAL        TIOC BFR ALLOCATED      YM05909 76179902
         BZ    QTOMRP                   NO,RETURN TO RTM        YM05909 76189902
*                                                                       76199902
*   PREPARE TO FREE THE MESSAGE BEING BUILT WHEN A TPUT FAILED          76209902
*                                                                       76219902
         SR    RCVT,RCVT                CLEAR WORK REGISTER     YM05909 76223202
         USING TSB,RTSB                 TSB ADDRESSABLE         YM05909 76225202
         ICM   RCVT,7,TSBOBFP           GET ADDR OF FIRST BFR   YM05909 76225602
         BZ    QTOMRP                   BR IF QUEUE EMPTY       YM05909 76226002
         LA    RBUF,TSBOBFP-(BUFFHEAD-TIOCBUF)  PRETEND THAT    YM05909 76226402
*                                       THE BFR PTR IS IN A BFR YM05909 76226502
*                                       RATHER THAN IN THE TSB  YM05909 76226602
         SPACE 1                                                        76249902
*                                                                       76259902
*   SCAN FOR LAST MESSAGE ON OUTPUT (HEADER) QUEUE                      76269902
*                                                                       76271902
         SPACE 1                                                        76272302
QTOMNHDR EQU   *                                                YM05909 76272702
         LR    RCNT,RBUF                SAVE BFR POINTER ADDR   YM05909 76273102
         LR    RBUF,RCVT                SAVE BFR ADDRESS        YM05909 76273202
         USING TIOCBUF,RBUF             BUFFER ADDRESSABLE      YM05909 76273302
         ICM   RCVT,7,BUFFHEAD          GET ADDR OF NEXT BUFFER YM05909 76281102
         BNZ   QTOMNHDR                 BR UNLESS NO MORE       YM05909 76283102
         DROP  RBUF                     BFR ADDRESSABILITY ENDS YM05909 76285102
*                                                                       76287102
*   CLEAR POINTER TO THIS MESSAGE AND FREE ALL ITS BUFFERS              76287502
*                                                                       76287902
         USING TIOCBUF,RCNT             BUFFER PTR ADDRESSABLE  YM05909 76288302
         XC    BUFFHEAD,BUFFHEAD        CLEAR BUFFER POINTER    YM05909 76288702
         DROP  RCNT                     BFR ADDRESSIBILITY ENDS YM05909 76288802
         IC    RCVT,TSBNOBF             GET NUMBER OF BUFFERS   YM05909 76296602
QTOMBFR  EQU   *                                                YM05909 76298702
         USING TIOCBUF,RBUF             BUFFER ADDRESSABLE      YM05909 76300702
         L     RGOTO,QTIEQBR            ADDR OF BFR RETURN CODE YM05909 76302702
         ICM   RCNT,7,BUFFTRLR          POINT TO NEXT BUFFER    YM05909 76303102
         BCTR  RCVT,R0                  DECREMENT BUFFER COUNT  YM05909 76303502
         BALR  R0,RGOTO                 GO TO FREE BFR IN REG 2 ZA24904 76303903
         LTR   RBUF,RCNT                ADDR OF NEXT BUFFER     YM05909 76304302
*                                       (IF ANY)                YM05909 76325402
         BNZ   QTOMBFR                  BR UNLESS NO MORE       YM05909 76335402
         DROP  RBUF                     BFR ADDRESSABILITY ENDS YM05909 76345402
         STC   RCVT,TSBNOBF             STORE UPDATED COUNT     YM05909 76345802
QTOMRP   EQU   *                                                YM05909 76346202
         LR    RBN,RETURN               SAVE R T M RETURN ADDR  YM05909 76346602
         SETRP RC=0,FRELOCK=(CMS,LOCAL) CANCEL FRR              YM05909 76353602
         BR    RBN                      RETURN TO R T M         YM05909 76355602
***                                                                     76360802
***                 DATA MOVE EXECUTION                                 76367802
***                                                                     76388902
QTOMMOVE MVC   K0(K1,RCNT),K0(RSAVE)    MOVE DATA TO TS BUFFER          76410020
         SPACE 2                                                YS02019 76420002
***                                                                     76430002
***                 ADCON FOR BUFFER ALLOCATION ROUTINE         YS02019 76440002
***                                                                     76450002
QTOMQBA  DC    V(IEDAYQBA)              ADDRESS OF BFR ALLOC RT YS02019 76460002
         EJECT                                                          76500020
         EJECT                                                          90936020
*********************************************************************** 90940020
*                                                                     * 90944020
*    QTIP0290                                                         * 90948020
*                                                                     * 90952020
* FUNCTION -                                                          * 90956020
*                                                                     * 90960020
*     QTIP0290 CLEANS UP THE TSBECB WHEN THE TASK WAITING             * 90964020
*     THEREUPON ABENDS.  IF ANOTHER TASK IS WAITING TO USE            * 90968020
*     THE TSB, THIS ROUTINE REMOVES THAT TASK FROM OWAIT.             * 90972020
*                                                                     * 90974002
*     NORMALLY, THIS ROUTINE IS INVOKED VIA A BRANCH ENTRY TO         * 90974402
*     SVC 101 (QTIP) FROM SVC 93'S ESTAE.  HOWEVER, IN THE CASE       * 90974802
*     OF AN ABNORMAL MEMORY TERMINATION, ESTAE'S ARE NOT ABLE TO      * 90975202
*     GET CONTROL, SO QTIP 29 IS ISSUED BY THE TIOC RMTR (RESOURCE    * 90975602
*     MANAGER TERMINATION ROUTINE), IEDAY8.                           * 90975702
*                                                                     * 90975802
*  ENTRY POINT -                                                      * 90993702
*                                                                     * 90996702
*     QTIP0290                                                        * 90999702
*                                                                     * 91002702
* INPUT -                                                             * 91005702
*                                                                     * 91008702
*    UPON ENTRY FROM IGC0009C ESTAE                                   * 91011702
*                                                                     * 91014702
*    REGISTER 2 - ASID OF THE ABENDING TASK                           * 91017702
*    REGISTER 3 - POINTER TO TCB OF ABENDING TASK, OR ZERO            * 91020702
*                                                                     * 91029702
*    UPON ENTRY FROM IEDAY8                                           * 91032702
*                                                                     * 91035702
*    REGISTER 15 - ADDRESS OF RMPL                                    * 91038702
*                                                                     * 91041702
* OUTPUT                                                              * 91044702
*                                                                     * 91047702
*    IF THE ABENDING TASK WAS WAITING ON ANY TSBECB'S, THE            * 91050702
*    FIRST BYTE OF EACH SUCH ECB IS ZEROED.                           * 91053702
*                                                                     * 91056702
* EXTERNAL REFERENCES -                                               * 91059702
*                                                                     * 91062702
*    TIME-SHARING INTERFACE PROGRAM, ENTRY CODE 4, TO BRING A USER    * 91065702
*    INTO MAIN STORAGE AND MAKE HIM ACTIVE.                           * 91068702
*                                                                     * 91071702
* EXITS, NORMAL                                                       * 91074702
*                                                                     * 91077702
*    THIS MODULE ZEROES REGISTER 15, AND BRANCHES VIA REGISTER 14.    * 91080702
*                                                                     * 91083702
* EXITS, ERROR                                                        * 91086702
*                                                                     * 91089702
*    NONE                                                             * 91092702
*                                                                     * 91095702
* TABLES/WORK AREAS -                                                 * 91098702
*                                                                     * 91101702
*    SEE QTIP0180                                                     * 91104702
*                                                                     * 91107702
* ATTRIBUTES -                                                        * 91110702
*                                                                     * 91113702
*    REENTRANT, REFRESHABLE, PRIVILEGED, DISABLED                     * 91116702
*                                                                     * 91119702
* CHARACTER CODE DEPENDENCY -                                         * 91122702
*                                                                     * 91125702
*    NONE                                                             * 91128702
*                                                                     * 91132020
* NOTES -                                                             * 91136020
*                                                                     * 91140020
*    NONE                                                             * 91144020
*                                                                     * 91148020
*********************************************************************** 91152020
         SPACE 3                                                        91156002
QTIP0290 EQU   *                                                        91160020
*********************************************************************** 91164020
*****                                                             ***** 91168020
*****               ENTRY FOR TSBECB CLEANUP                      ***** 91172020
*****                                                             ***** 91176020
*****    REGS 5, 6, 7, 8 ARE PRESERVED THROUGOUT THIS ROUTINE     ***** 91178002
*****                                                             ***** 91178402
*********************************************************************** 91180020
         SPACE 2                                                        91184020
         LR    RTCB,RCVT                TCBPT PASSED IN RCVT (R3)       91192020
         L     RCVT,CVTPTR              ADDRESS OF CVT          YS02019 91194002
         USING CVT,RCVT                 CVT ADDRESSABLE         YS02019 91196002
         L     RRPT,CVTAQAVT            ADDRESS OF TCX          YS02019 91196402
         L     RRPT,TCXRPT-IEDQTCX(,RRPT)  ADDRESS OF RPT       YS02019 91196802
         USING TIOCRPT,RRPT             TIOCRPT ADDRESSABLE     YS02019 91197202
         C     RGOTO,TIOCQTIP           IS CALL MADE BY AY8     YS02019 91197702
         BE    NOTOOCA                  NO, CALLED BY ESTAE     YS02019 91199602
         SR    RTCB,RTCB                DENOTE OOCA             YS02019 91211002
         USING RMPL,RGOTO               RMPL ADDRESSABLE        YS02019 91211502
         MODESET EXTKEY=SUPR            CHANGE INTO KEY 0       YS02019 91212002
         LH    RBUF,RMPLASID            GET ASID                YS02019 91212502
         MODESET EXTKEY=TCAM            GET BACK INTO TCAM KEY  YS02019 91213002
         SPACE 1                                                YS02019 91214002
NOTOOCA  EQU   *                                                YS02019 91216002
         LR    RTJID,RBUF               ASID PASSED IN RBUF     YS02019 91218002
         L     RASVT,CVTASVT            ADDRESS OF ASVT         YS02019 91220002
         USING ASVT,RASVT               ASVT ADDRESSABLE        YS02019 91222002
         SLL   RTJID,K2                 ASID * 4                YS02019 91224002
         L     RTJID,ASVTENTY-L'ASVTENTY(RTJID)  ADDR OF ASCB   YS02019 91226002
         USING ASCB,RTJID               ASCB ADDRESSABLE        YS02019 91228002
         L     RTSB,ASCBTSB             ADDRESS OF TSB OR 0     YS02019 91230002
         LTR   RTSB,RTSB                FOREGROUND TASK         YS02019 91232002
         BNZ   GOTTJID                  IF SO, DON'T NEED TCB           91234002
         LTR   RTCB,RTCB                TCB BETTER BE SPECIFIED         91236002
         BZ    DONE29                   IF NEITHER TCB NOR TJID, QUIT   91238002
         DROP  RTJID                    ASCB NOT ADDRESSABLE    YS02019 91238402
*                                                                       91240002
*              ASCBTSB = 0 MEANS BACKGROUND TASK                        91242002
*                        TCB # 0 REQUIRED                               91244002
*                        TCB = 0 MEANS EFFECTIVE NOP                    91246002
*              ASCBTSB # 0 MEANS FOREGROUND TASK                        91248002
*                        TCB = 0 MEANS OUT-OF-CORE ABEND                91250002
*                        TCB # 0 IS ABENDING TASK                       91252002
*                                                                       91254002
         SPACE 1                                                        91256002
GOTTJID  EQU   *                                                        91258002
*                                                                       91260020
*   SEE IF ABENDING USER HAS CONTROL OF TSB OUTPUT                      91264020
*                                                                       91268020
         LTR   RTSB,RTSB                CHECK FOR BACKGROUND    YS02019 91278002
         BZ    TJIDS                    YES, ONLY ASID TPUT     YS02019 91288002
         LR    RTJID,RBUF               ASID PASSED AT ENTRY    YM01373 91290002
         TM    TSBFLG1,TSBOWIP+TSBTJIP  IS TSB IN USE BY NORMAL TPUT    91296020
         BNM   TJIDS                    IF NOT, CHECK TSB TABLE         91300020
         LTR   RTCB,RTCB                TCB GIVEN                       91301020
         BZ    CLEAN                    NO. CLEAN-UP FOR OUT-OF-        91302020
*                                       CORE ABEND                      91303020
         C     RTCB,TSBCTCB             IS CURRENT TCB ABENDING         91304020
         BNE   TJIDS                    IF NOT, DON'T CLEAN THIS TSB    91308020
*                                                                       91312020
*   GO CLEAN UP TSB AND TURN OFF QCBPARTO, IF NECESSARY                 91316020
*                                                                       91320020
CLEAN    EQU   *                                                        91322020
         BAL   RCVT,CLEANUP             GO DO IT                        91324020
         SPACE                                                          91328020
*                                                                       91332020
*   POST TSBECB IF WAITED ON BY A LOGGED-ON USER                        91336020
*                                                                       91340020
         TM    TSBECB,WAITBIT           IS ECB WAITED ON        YM03998 91344002
         BNO   TJIDS                    IF NOT, DON'T POST              91348020
         LH    RTJID,TSBWTJID           GET WAITING ASID        YS02019 91358002
         SLL   RTJID,K2                 ASID * 4                YS02019 91368002
         L     RTJID,ASVTENTY-L'ASVTENTY(RTJID)  ASCB OF WAITER YS02019 91378002
         DROP RASVT                     ASVT NOT ADDRESSABLE    YS02019 91378402
         SPACE                                                          91380020
*                                                                       91388020
*   GO TO POST ROUTINE TO AWAKEN WAITING TJID TPUT, SO IT CAN FIND      91392020
*   OUT THAT THIS USER HAS HUNG UP.                                     91396020
*                                                                       91400020
*   REGISTERS FOR POST: 10 - COMPLETION CODE          RRPT              91404002
*                       11 - PTR TO ECB, BIT 0 = 1    RECBP             91408002
*                       12 - ADDR OF CVTBRET          RBASE             91412002
*                       13 - WAITING ASCB             RTJID             91416002
*                       14 - RETURN                   RETURN            91420020
*                       15 - POST ENTRY ADDRESS       RGOTO,RWRK        91424020
*                                                                       91428020
         L     RCVT,CVTPTR              ADDRESS OF CVT          YS02019 91438002
         L     RWRK,CVT0PT01            POST ROUTINE ADDRESS            91444002
         LR    RCNT,RBASE               SAVE BASE REGISTER      YS02019 91448002
         LA    RBASE,CVTBRET            ADDRESS OF CVTBRET      YS02019 91450002
         DROP  RBASE                    MODULE NOT ADDRESSABLE  YS02019 91450402
         USING QTIP0180,RCNT            USE RCNT AS MOD BASE    YS02019 91451202
         LR    R0,RRPT                  SAVE RPT ADDRESS        YS02019 91452002
         SR    RRPT,RRPT                MAKE COMPLETION CODE 0          91460020
         LA    RECBP,TSBECB             ECB POINTER              S21A12 91469021
         O     RECBP,HIGHON             HIGH-ORDER BIT FOR POST  S21A12 91470021
         MODESET EXTKEY=SUPR            CHANGE TO SUP KEY      @ZA05453 91484037
         BALR  RETURN,RGOTO             GO TO POST                      91484137
         MODESET EXTKEY=TCAM            CHANGE BACK TO TCAM    @ZA05453 91484237
*                                                                       91484402
*   NOTE - RBUF STILL CONTAINS TJID PASSED AT ENTRY, SO RTJID NOT SAVED 91486002
*                                                                       91486402
         SPACE 2                                                        91488020
*                                                                       91492020
*   RESTORE REGISTERS ON RETURN FROM POST                               91496020
*                                                                       91500020
         LR    RBASE,RCNT               BASE REGISTER           YS02019 91504002
         DROP  RCNT                     RCNT NO LONGER MOD BASE YS02019 91514002
         USING QTIP0180,RBASE           USE RBASE AS MOD BASE   YS02019 91514402
         LR    RRPT,R0                  TIOCRPT ADDRESS         YS02019 91516002
         LR    RTJID,RBUF               TJID PASSED AT ENTRY            91520020
         L     RETURN,TIOCSAVE+SAVER14  GET RETURN ADDR FROM    YS02019 91522002
*                                       SAVE AREA (SAVED BY     YS02019 91522402
*                                       SUBROUTINE CLEANUP)     YS02019 91522802
         SPACE 2                                                        91524020
TJIDS    EQU   *                                                        91528020
         L     RTSB,TIOCTSB-K1          ADDRESS OF 1ST TSB      YS02019 91538002
         SR    RBUF,RBUF                CLEAR WORK REGISTER     YS02019 91540002
         IC    RBUF,TIOCTSBS            TSB SIZE FOR INCREMENT  YS02019 91542002
         LH    RCNT,TIOCNTSB            NO. OF TSB'S AS LIMIT   YS02019 91544002
*                                                                       91548020
*    LOOK AT EACH TSB AND CHECK FOR A WAITED-UPON TSBECB AND TJID=RTJID 91552002
*                                                                       91560020
TSBLOOP  EQU   *                                                        91564020
         TM    TSBSTAT,TSBINUSE         IS THIS TSB IN USE      YS02019 91574002
         BZ    NEXTTSB                  NO, CHECK NEXT TSB      YS02019 91576002
         CH    RTJID,TSBWTJID           CAN ABEND'G TJID BE             91580020
*                                       EITHER WAITING OR IN PROGRESS.  91584020
         BNE   NEXTTSB                  NO. GET NEXT TSB                91588020
         TM    TSBFLG1,TSBTJIP          YES.IS IT IN PROGRESS.          91592020
         BO    CKCTCB                   YES.                            91596020
         TM    TSBECB,WAITBIT           NO. IS IT WAITING       YM03998 91600002
         BNO   NEXTTSB                  NO. GET NEXT TSB                91604020
         L     RWRK,TSBWTCB-K1          YES. GET WAITING TCB            91608020
         LA    RWRK,K0(,RWRK)           GET RID OF FLAGS        YS02019 91610002
         CR    RWRK,RTCB                IS WAITING TCB = ABEND'G TCB    91616020
         BE    THISTSB                  YES. GO CLEAN                   91620020
         B     CKRTCB                   NO. BUT....                     91624020
CKCTCB   EQU   *                                                        91628020
         C     RTCB,TSBCTCB             IS ABEND'G TCB= IN PROGRESS TCB 91632020
         BE    THISTSB                  YES. GO CLEAN                   91636020
*                                       NO. BUT...                      91640020
CKRTCB   EQU   *                                                        91644020
         LTR   RTCB,RTCB                WAS TCB GIVEN                   91648020
         BZ    THISTSB                  NO. GO CLEAN                    91652020
*                                       YES. GET NEXT TSB               91656020
         SPACE 1                                                        91670520
NEXTTSB  EQU   *                                                        91671020
*                                                                       91671520
*   CHECK NEXT TSB, OR JUMP OUT IF LAST HAS BEEN CHECKED                91672020
*                                                                       91672520
         AR    RTSB,RBUF                PT TO NEXT TSB          YS02019 91673002
         BCT   RCNT,TSBLOOP             CHECK AGAIN IF THIS WASN'T LAST 91673520
         SPACE 2                                                        91674020
*                                                                       91674520
*   ALL TSBS HAVE BEEN CHECKED.  SET CODE AND RETURN                    91675020
*                                                                       91675520
DONE29   EQU   *                                                        91676020
         SR    RGOTO,RGOTO              SET CODE TO ZERO                91676520
         BR    RETURN                   RETURN                          91677020
         EJECT                                                          91677520
THISTSB  EQU   *                                                        91678020
*                                                                       91678520
*  THIS TSB IS WAITED ON OR IN USE BY THE ABENDING TASK                 91679020
*                                                                       91679520
         MVI   TSBECB,K0                ZERO WAIT AND POST BITS         91680020
         TM    TSBFLG1,TSBTJIP          IS TJID TPUT GOING              91680520
         BZ    NEXTTSB                  IF NOT, NO FURTHER ACTION       91681020
         LA    RCVT,NEXTTSB             RETURN ADDR FOR SUBROUTINE      91681220
         SPACE                                                          91681320
CLEANUP  EQU   *                                                        91681420
*                                                                       91681520
*   SUBROUTINE TO CLEAN UP TSB AND HANDLE QCBPARTO                      91681620
*                                                                       91681720
         STM   RASVT,RBUF,TIOCSAVE      SAVE REGISTERS (11-2)   YS02019 91681802
         NI    TSBFLG1,OFF-(TSBOWIP+TSBTJIP+TSBTJBF+TSBTJOW)           -91681902
                                        INDICATE TSB NO LONGER SIEZED   91682002
         NI    TSBSTAT,OFF-TSBNOBUF     DON'T FORGET THIS               91682102
         L     RWRK,CVTPTR(,R0)         GET CVT POINTER         YS02019 91682202
         USING CVT,RWRK                 CVT ADDRESSABLE         YS02019 91682302
         TM    CVTTCMFG,CVTTCRDY        IS TCAM UP                      91682402
         BNO   NOQCB                    IF NOT, DON'T TOUCH QCB         91682502
*                                                                       91682602
*   TURN OFF QCBPARTO VIA IEDAYP SO TCAM WON'T EXPECT MORE OUTPUT       91682702
*                                                                       91682802
         TM    TSBFLG4,TSBCANC          IS USER STILL WITH US   YS02019 91693802
         BO    NOQCB                    NO. DON'T TURN OFF PARTO        91695602
         SPACE 2                                                        91697602
         L     R0,TSBF2M                GET SETTING OF TSB              91697702
RETRY    EQU   *                                                YS02019 91697802
         LR    RWRK,R0                  PUT IT IN WORK REGISTER YS02019 91697902
         O     RWRK,TPSTMSK1            * TURN OFF QCBPARTO     YS02019 91698002
         N     RWRK,TPSTMSK2            * IN QCBTSOF1           YS02019 91698102
         CS    R0,RWRK,TSBF2M           UPDATE TSB              YS02019 91698202
         BNE   RETRY                    LOOP UNTIL DONE         YS02019 91698302
         SPACE 3                                                        91698402
*                                                                       91698802
*   GO TO IEDAYTPQ FOR TPOST THE TSB TO IEDAYP                  YS02019 91698902
*                                                                       91699002
*        INTERFACE WITH IEDAYTPQ                                YS02019 91699102
*                                                                       91699202
*        REGISTER  0 - RETURN ADDRESS                           YS02019 91699302
*        REGISTER  1 - ZERO (MEANS TPOST TSB TO AYP)            YS02019 91699702
*        REGISTER  2 - TSB ADDRESS                              YS02019 91699802
*        REGISTER 13 - 6-WORD SAVE AREA                         YS02019 91700202
*        REGISTER 15 - ENTRY POINT ADDRESS TO IEDAYTPQ          YS02019 91700402
*                                                                       91700802
         SR    RCNT,RCNT                ZERO OUT REG 1          YS02019 91700902
         LR    RBUF,RTSB                TSB ADDRESS IN REG 2    YS02019 91701002
         LA    RTJID,TIOCSAVE+TPQSAVE   SAVE AREA ADDRESS       YS02019 91701202
         L     RGOTO,AYTPQAD            EPA OF IEDAYTPQ         YS02019 91701402
         BALR  R0,RGOTO                 GO TO UPDATE QCBPARTO   YS02019 91701502
         SPACE 2                                                        91701602
NOQCB    EQU   *                                                        91701802
*                                                                       91702002
*      CHECK FOR OTHER WAITING TPUTS FROM THIS TASK                     91702802
*                                                                       91704602
         TM    TSBFLG1,TSBWOWIP         IS A REGULAR TPUT WAITING       91706402
         BNO   RESTREGS                 IF NOT, THIS TSB DONE   YS02019 91708202
         TM    TSBFLG4,TSBOCAB          OUT OF CORE ABEND CHECK YS02019 91708602
         BO    RESTREGS                 YES, DONE WITH THIS TSB YS02019 91709002
         NI    TSBFLG4,OFF-(TSBOWAIT+TSBHOLD)  OUT OF OWAIT     ZA25139 91709403
         SPACE 1                                                        91710002
*                                                                       91711802
*   A NORMAL TPUT IS WAITING FOR THIS TSB.  MAKE ALL TCB'S              91713602
*   ASSOCIATED WITH THIS TSB ACTIVE                                     91715602
*                                                                       91717202
*        INTERFACE WITH STATUS                                          91717602
*                                                                       91718002
*        REGISTER  0 - BYTES 0-1 - ASID                                 91718402
*                      BYTES 2-3 - STATUS ENTRY CODE (8)                91718802
*        REGISTER  1 - X'80000000' (REQUESTS RESETTING)                 91718902
*        REGISTER 13 - TCB NONDISPATCHABILITY BIT MASK                  91722402
*        REGISTER 14 - RETURN ADDRESS                                   91724402
*        REGISTER 15 - ENTRY POINT ADDRESS                              91726402
*                                                                       91728402
         LM    R0,RCNT,INITREGS         LOAD PARMS FOR STATUS   YS02019 91778402
         L     RGOTO,TSBASCBA           GET ASCB ADDRESS        YS02019 91828402
         ICM   R0,B'1100',ASCBASID-ASCB(RGOTO)  GET ASID        YS02019 91878402
         L     RAVT,MSKOWAIT            SET TO REMOVE OWAIT     YS02019 91878602
         L     RGOTO,CVTPTR             CVT ADDRESS             YS02019 91878702
         L     RGOTO,CVTABEND-CVT(,RGOTO)   SCVT ADDRESS        YS02019 91878802
         USING SCVTSECT,RGOTO           SCVT ADDRESSABLE        YS02019 91879202
         L     RGOTO,SCVTSTAT           GET EPA OF STATUS       YS02019 91879302
         DROP  RGOTO                    SCVT NOT ADDRESSABLE    YS02019 91882802
         MODESET EXTKEY=SUPR            CHANGE INTO KEY 0       YS02019 91884802
         BALR  RETURN,RGOTO             GO TO STATUS            YS02019 91890002
         MODESET EXTKEY=TCAM            GET BACK TO TCAM'S KEY  YS02019 91892002
         SPACE 1                                                        91894002
RESTREGS EQU   *                                                YS02019 91896002
         LM    RASVT,RBUF,TIOCSAVE      RESTORE REGS (11-2)     YS02019 91899302
         SPACE 1                                                        91902802
         BR    RCVT                     GO BACK TO MAINLINE     YS02019 91906102
         SPACE 5                                                        91913202
*********************************************************************** 91923202
*****                                                             ***** 91925202
*****               ADCON FOR TPOSTING ROUTINE                    ***** 91927202
*****                                                             ***** 91929202
*********************************************************************** 91929602
         SPACE 2                                                        91929702
AYTPQAD  DC    V(IEDAYTPQ)              EPA OF IEDAYTPQ         YS02019 91929802
         EJECT                                                          91929902
*********************************************************************** 91946602
*****                                                             ***** 91963302
*****               THE FOLLOWING CONSTANTS ARE USED              ***** 91980020
*****                                                             ***** 92070020
*********************************************************************** 92160020
         SPACE 2                                                        92250020
KZERO    DC    F'0'                     ZERO COMPARATOR                 92340020
MSKOWAIT DC    AL1(0,0,TCBOWAIT,0)      MASK FOR STATUS         YS02019 92390002
TPSTMSK1 DC    AL1(0,0,QCBPARTO,0)      QCBPARTO IS THE BIT     YS02019 92394002
TPSTMSK2 DC    AL1(255,255,255,255-QCBPARTO) TURN OFF QCBPARTO  YS02019 92396002
INITREGS DC    A(8)                     REGISTERS 0 AND 1       YS02019 92400002
INITREG1 DC    X'80000000'              FOR STATUS              YS02019 92410002
HIGHON   EQU   INITREG1                 FOR CORSS MEMORY POST   YS02019 92412002
KMAX     DC    H'255'                   MAXIMUM MOVABLE                 92414002
KTHREE   DC    H'3'                     USED TO STRIP 3270       S22028 92416002
*                                       CONTROL CHARACTER        S22028 92418002
PATCHREA DC    10F'0'                   PATCH AREA               Y01018 92420000
         EJECT                                                          92520020
         IHAASCB                                                YS02019 92610002
         EJECT                                                  YS02019 92660002
         IHAASVT                                                YS02019 92670002
         EJECT                                                  YS02019 92710002
         TAVTD                                                  YS02019 92810002
         EJECT                                                  YS02019 92910002
         IKJTIOCB                                               YS02019 93010002
         EJECT                                                  YS02019 93110002
CVT      DSECT                                                  YS02019 93210002
         CVT                                                    YS02019 93310002
         EJECT                                                  YS02019 93410002
         TPRIOR                                                 YS02019 93510002
         EJECT                                                  YS02019 93610002
         TQCBD                                                  YS02019 93710002
         EJECT                                                          94508100
         IKJRB                                                          94509400
***                                                                     94510700
***      EXTENDED SAVE AREA.  THSES STATEMENTS SHOULD FOLLOW            94512000
***      THE MACRO 'IKJRB.'                                             94513300
***                                                                     94514600
         ORG   RBEXSAVE                 START OF SAVE AREA       M0094  94515900
XSAPRM0  DS    0F                       REG 0 AT ENTRY           M0094  94517200
XSAPRMTJ DS    H                        TJID PASSED              M0094  94518500
XSAPRMSZ DS    H                        SIZE PASSED              M0094  94519800
XSAPRM1  DS    0F                       REG 1 AT ENTRY           M0094  94521100
XSAOPTNS DS    X                        USER OPTIONS             M0094  94522400
MASIS    EQU   X'01'                    ASIS OPTION SPECIFIED    M0094  94523700
MCNTRL   EQU   X'02'                    1 MEANS CONTROL          M0094  94525000
*                                                                       94526300
*   BOTH OF THE ABOVE BITS OFF MEANS EDIT OPTION                        94527600
*                                                                       94528900
MBREAK   EQU   X'04'                    BREAKIN SPECIFIED        M0094  94530200
MHOLD    EQU   X'08'                    1 MEANS HOLD             M0094  94531500
MTGET    EQU   X'80'                    1 MEANS TGET REQUESTED   M0094  94532800
MUSERID  EQU   X'40'                    USERID PTD TO BY REG 15 YS02019 94534102
MLOWP    EQU   X'20'                    0 HIGHPRI, 1 LOWPRI      M0094  94535400
MWAIT    EQU   X'10'                    1 MEANS NOWAIT           M0094  94536700
         DS    AL3                      REST OF REGISTER ONE     M0094  94538000
XSAWD3   DS    0F                       FOR SAVING REGISTERS     M0094  94539300
XSAFLAG  DS    X                        FLAG PASSED BY 9C TO 01  M0094  94540600
*                                       AND 02                   M0094  94541900
XSATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT   M0094  94543200
         DS    AL3                      REST OF WORD             M0094  94544500
         ORG   XSAWD3+2                 INPUT ED, OUTPUT MOVE    M0094  94545800
XSAUBFRS DS    H                        AMT DATA LEFT TO MOVE    M0094  94547100
XSAUBFRP DS    0F                       LOC DATA LEFT TO MOVE    M0094  94548400
XSAESTAL DS    CL16                     LIST FOR ESTAE MACRO    YS02019 94558402
         ORG   XSAUBFRP+4               USED FOR SAVE AREA WHEN YS02019 94560102
*                                       NOT NEEDED BY ESTAE     YS02019 94561402
XSAWD5   DS    F                        FOR SAVING REGISTERS     M0094  94562700
XSAWD6   DS    F                        FOR SAVING REGISTERS     M0094  94564000
         ORG   XSAWD5                   USE WORDS 5-6 FOR NAME   M0094  94565300
XSAENQNM DS    CL8                      ENQ NAME FOR TJID TPUT   M0094  94566600
XSAWD7   DS    F                        FOR SAVING REGISTERS     M0094  94567900
XSAWD8   DS    F                        FOR SAVING REGISTERS     M0094  94569200
         ORG   XSAWD7                   USE WDS 7-8 FOR ENQ PRMS M0094  94570500
XSAENQAD DS    2F                       WORK AREA FOR ENQ/DEQ    M0094  94571800
XSAUSERP DS    0F                       USER ID POINTER         YS02019 94572402
XSAWD9   DS    F                        FOR SAVING REGISTERS     M0094  94573100
XSARETRG DS    0F                       TGET/TPUT RETURN ADDRES YS02019 94573702
XSAWD10  DS    F                        FOR SAVING REGISTERS     M0094  94574400
         DS    CL1                      RESERVED                YS02019 94574802
XSAUSERK DS    CL1                      SVC CALLER'S KEY        YS02019 94575202
XSARC    DS    H                        RETURN CODE SAVE AREA   YS02019 94575702
XSATJID  DS    H                        CALLER'S TJID            M0094  94577000
XSAFLAG2 DS    X                        FLAGS                   YM05909 94579002
XSAATR   EQU   X'80'                    NEXT CHAR IN TS BFR IS   S22028 94579402
*                                       A 3270 ATTRIBUTE BYTE    S22028 94579502
XSABFRAL EQU   X'40'                    TIOC BUFFER HAS BEEN    YM05909 94589502
*                                       ALLOCATED               YM05909 94599502
XSA15D   EQU   X'20'                    CHANGE COMPLETION CODE  YM05909 94609502
*                                       TO 15D IN ETAE          YM05909 94611502
*                   NEXT 5 BITS UNUSED                          YM05909 94617602
XSAF     DS    X                        FLAGS USED BY TPUT. INI- M0094  94656602
*                                       TIALIZED FROM XSAFLAG.          94694702
HSW      EQU   X'80'                    HEADER BFR DONE          M0094  94732802
PSW      EQU   X'40'                    NEED TO TPOST QCB        M0094  94770902
*SATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT          94809002
OSW      EQU   X'10'                    TSBOWIP TURNED ON BY US  M0094  94847102
*                                       (NOT SOME OTHER TPUT)           94885202
XSADMOVE EQU   X'08'                    DATA IS MOVING          YS02019 94923302
XSAAUTH  EQU   X'04'                    USER IS AUTHORIZED      YS02019 94961402
XSAIDENQ EQU   X'02'                    ASID TPUT ASID ENQUEUED YS02019 94999502
XSAPARTO EQU   X'01'                    QCBPARTO IS SET ON      YM01246 95009502
         EJECT                                                          95037602
         IHASCVT                                                YS02019 95075702
         EJECT                                                  YS02019 95113802
         IHARMPL                                                YS02019 95123802
         EJECT                                                  YS02019 95133802
         IKJTCB                                                         95151902
         EJECT                                                          95190002
         TTCXD                                                          95790002
         EJECT                                                          96390002
         IKJTIOCP                                                       96990002
         EJECT                                                          97590002
         IKJTSB                                                         98190002
         EJECT                                                          98240002
         IHAFRRS                                                        98290002
         EJECT                                                          98340002
         IHASDWA                                                        98390002
         EJECT                                                          98440002
         IHAPSA                                                         98490002
         END                                                            99390002
