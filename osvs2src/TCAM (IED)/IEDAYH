         TITLE 'IEDAYH - TIOC HANG UP/ERROR'                            00100000
IEDAYH   CSECT                                                          00200000
         SPACE 3                                                        00300000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 00400000
*                                                                     * 00500000
*                                                                     * 00600000
*    NAME - IEDAYH, TIOC HANG UP/ERROR ROUTINE                        * 00700000
*                                                                     * 00800010
*     TCAM VERSION 10.0 CHANGES                                @G36XRYP 00840010
*A575000,863000                                                @G36XRYP 00880010
*C131000,596000,656000                                         @G36XRYP 00920010
*D576000-585000,606000,668000-670000,774000                    @G36XRYP 00960010
*                                                              @Y17XAYP 01000000
*A207000,273000,314000,336000,430000,620000,676000,713000      @Y17XAYP 01100000
*A718000                                                       @Y17XAYP 01200000
*C158000,245000,259000,313000,469000,574000,593000,599500      @Y17XAYP 01300000
*C619000,625000,629000,676000,683000                           @Y17XAYP 01400000
*D672000                                                       @Y17XAYP 01500000
*A400000                                                       @SA77953 01530010
*A786000                                                       @OZ18790 01560010
*                                                                       01600000
*     RA0034 CHANGES                                                    01700000
*                                                                       01800000
*A128000,716000                                                @OY14092 01900000
*C484000,721500                                                @OY14092 02000000
*C714000                                                       @OY15019 02120000
*A757000                                                       @OY15019 02140000
*A721000                                                       @OY15030 02160000
*                                                                     * 02200000
*        VS2-1.6 SU                                                     02300000
*0000212600,283200,391421-391429                               @YA12165 02400000
*0000746500-747800                                             @YA08078 02500000
*                                                                       02600000
*    POST VS2-1.6 CHANGES                                               02700000
*0000283200,630000,630100                                      @YA11542 02800000
*A755100,769100-769440,785620                                   YA00689 02900000
*C370000,372000                                                 YZ04575 03000000
*A370500-371940                                                 YA04575 03100000
*C283200                                                        YA04486 03200000
*D390700,391000                                                 YA04486 03300000
*A189500,212500,390700-391484,876500                            YA04486 03400000
*D000100,178300,179500,188200,188600,202100,202500,852400,      YA04486 03500000
*D853200-855000,856030,857590,934200,935600                     YA04486 03600000
*    RELEASE 21 DELETIONS/CHANGES                                     * 03700000
*1021283200                                                      S22029 03800000
*1021282600-283300                                               A46135 03900000
*1021283200                                                      A44839 04000000
*    RELEASE 20 DELETIONS/CHANGES                                     * 04100000
*                                                                TS1628 04200000
*                                                                M2655  04300000
*                                                                M3546  04400000
*                                                                 M4019 04500000
*                                                                M4681  04600000
*                                                                 M4665 04700000
*                                                                 M5711 04800000
*                                                                     * 04900000
************************************************************** @Y17XAYP 05000000
* MODULE NAME = IEDAYH (TCAM,TSO)                              @Y17XAYP 05100000
*                                                              @Y17XAYP 05200000
* DESCRIPTIVE NAME = TIME SHARING HANG UP/ ERROR ROUTINE       @Y17XAYP 05300000
*                                                              @Y17XAYP 05400000
* COPYRIGHT = NONE                                             @Y17XAYP 05500000
*                                                              @Y17XAYP 05600000
* STATUS = VERSION 10.0                                        @G36XRYP 05700010
*                                                              @Y17XAYP 05800000
* FUNCTION -                                                          * 05900000
*    HANDLE VARIOUS TERMINAL I/O ERRORS                               * 06000000
*    DISCONNECT TERMINAL WHEN NECESSARY                               * 06100000
*                                                                     * 06200000
* ENTRY POINTS -                                                      * 06300000
*         ENTRY1 (IEDAYH), WHEN BRANCHED TO AT TNE END OF EVERY INPUT * 06400000
*         AND OUPTUT MESSAGE                                          * 06500000
*                                                                     * 06600000
*         ENTRY2 (IEDAYH+12), WHEN QPOSTED DUE TO A HANG UP OCCURRING * 06700000
*         ON A MONITORING CHANNEL PROGRAM OR ON A MSGGEN              * 06800000
*                                                                     * 06900000
* INPUT -                                                             * 07000000
*    ENTRY1                                                           * 07100000
*    REGISTER  1 HAS POST  LIST (BUFFERS TO BE POSTED TO TSINPUT) AD- * 07200000
*    DRESS OR ZERO                                                    * 07300000
*    REGISTER  3 HAS SCB ADDRESS                                      * 07400000
*    REGISTER  4 HAS LCB ADDRESS                                      * 07500000
*    REGISTER 11 HAS TCAM DISPATCHER ADDRESS                          * 07600000
*    REGISTER 12 HAS ENTRY ADDRESS                                    * 07700000
*    REGISTER 13 HAS SAVE AREA ADDRESS, AVTSAVE2                      * 07800000
*                                                                     * 07900000
*    ENTRY2                                                           * 08000000
*    REGISTER  1 HAS LCB ADDRESS                                      * 08100000
*    REGISTER  7 HAS ENTRY ADDRESS                                    * 08200000
*    REGISTER 11 HAS TCAM DISPATCHER ADDRESS                          * 08300000
*    REGISTER 13 SAVE AREA ADDRESS, AVTSAVE2                          * 08400000
*                                                                     * 08500000
*    ENTRY1 AND ENTRY2                                                * 08600000
*    SCBERRST AND LCBSENS0 HAVE VARIOUS BITS SET TO INDICATE THE TYPE * 08700000
*    OF ERRORS THAT HAVE OCCURRED                                     * 08800000
*                                                                     * 08900000
* OUTPUT -                                                            * 09000000
*    NONE                                                             * 09100000
*                                                                     * 09200000
* EXTERNAL REFERENCES -                                               * 09300000
*         QTIP 4, VIA SVC 101                                         * 09400000
*         IEDQTNT, VIA BRANCH ENTRY AT AVTTRNMPT                      * 09500000
*                                                                     * 09600000
* EXITS, NORMAL -                                                     * 09700000
*         BRANCH TO TCAM  DISPATCHER AT ADDRESS DSPCHAIN WITH ADDRESS * 09800000
*         OF ERB IN REGISTER 1 (IF TERMINAL IS STILL CONNECTED)       * 09900000
*                                                                     * 10000000
*         BRANCH TO TCAM  DISPATCHER AT ADDRESS  DSPDISP (IF TERMINAL * 10100000
*         IS, OR IS TO BE, DISCONNECTED)                              * 10200000
*                                                                     * 10300000
* EXITS, ERROR -                                                      * 10400000
*         NONE                                                        * 10500000
*                                                                     * 10600000
* TABLES/WORK AREAS -                                                 * 10700000
*    QCB (12 BYTES) PRECEDES THIS ROUTINE                             * 10800000
*    CONTROL BLOCKS ARE DESCRIBED IN THE DSECTS AT END OF LISTING     * 10900000
*                                                                     * 11000000
* ATTRIBUTES -                                                        * 11100000
*    ENABLED, PROBLEM PROGRAM MODE, REFRESHABLE, REUSABLE             * 11200000
*                                                                     * 11300000
* CHARACTER CODE DEPENDENCY -                                         * 11400000
*    THIS MODULE IS ASSEMBLED IN EBCDIC AND MUST BE RE-ASSEMBLED IF A * 11500000
*    DIFFERENT CHARACTER SET IS TO BE USED DURING EXECUTION           * 11600000
*                                                                     * 11700000
* NOTES -                                                             * 11800000
*    REGISTER EQUATES START WITH 'R'                                  * 11900000
*    LENGTH AND DISPLACEMENT EQUATES START WITH 'E'                   * 12000000
*                                                                     * 12100000
*                                                                     * 12200000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 12300000
         EJECT                                                          12400000
********                                                                12500000
******** REGISTER EQUATES                                               12600000
********                                                                12700000
EZERO    EQU   0                                               @OY14092 12800000
RWORK    EQU   0                        WORK REGISTER                   12900000
R1       EQU   1                        WORK REGISTER                   13000000
RASCB    EQU   2                        ASCB ADDRESS           @G36XRYP 13100010
RSCB     EQU   3                        SCB ADDRESS                     13200000
RLCB     EQU   4                        LCB ADDRESS                     13300000
RAT      EQU   5                        WORK REGISTER                   13400000
ROT      EQU   6                        WORK REGISTER                   13500000
RQCB     EQU   7                        QCB ADDRESS                     13600000
RBUF     EQU   8                        BUFFER ADDRESS                  13700000
RTSB     EQU   9                        TSB ADDRESS                     13800000
RPLAY    EQU   10                       WORK REGISTER                   13900000
RDISPA   EQU   11                       DISPATCHER ADDRESS              14000000
RBASE    EQU   12                       ENTRY1 ENT POINT AND BASE ADDR  14100000
RAVTSAVE EQU   13                       SAVE AREA ADDRESS, AVTSAVE2     14200000
RETURN   EQU   14                       RETURN ADDRESS                  14300000
R15      EQU   15                       WORK AND PARAMETER REG          14400000
RWORK2   EQU   2                        WORK REGISTER           YS6327  14500000
RWORK5   EQU   5                        WORK REGISTER           YS6327  14600000
RWORK9   EQU   9                        WORK REGISTER           YS6327  14700000
         SPACE 3                                                        14800000
********                                                                14900000
******** MASKS                                                          15000000
********                                                                15100000
E1       EQU   1                        GIVES A VALUE OF 1              15200000
E2       EQU   2                        GIVES A VALUE OF 2              15300000
E3       EQU   3                        GIVES A VALUE OF 3              15400000
E1F      EQU   X'1F'                    TESTS FOR ERROR STATUS  YA04486 15500000
NOT      EQU   X'FF'                    ZEROS VARIOUS BITS              15600000
INTREQ   EQU   X'40'                    TESTS FOR INTERVENTION REQUIRED 15700000
DATACHK  EQU   X'08'                    TESTS FOR DATA CHECK            15800000
TIMEOUT  EQU   X'01'                    TESTS FOR TIME OUT              15900000
CINHIBIT EQU   X'80'                    TERMINAL HAS INHIBIT FEATURE    16000000
CBREAK   EQU   X'40'                    TERMINAL HAS BREAK FEATURE      16100000
C5041    EQU   X'10'                    TERMINAL IS ON 5041 LINE        16200000
SETINHB  EQU   X'10'                    MODE BIT FOR 3705       YS6327  16300000
ELEVEN   EQU   11                       GIVES A VALUE OF 11     YS6327  16400000
STMONITR EQU   X'02'                    MODE BIT FOR 3705       YS6327  16500000
LCBDELAY EQU   X'02'                    LCB IS IN DELAY QUEUE           16600000
HANGUP   EQU   4                        CALLS QTIP FOR HANG UP DUTIES   16700000
D7       EQU   7                        DISPLACEMENT OF 7 BYTES YA04486 16800000
D6       EQU   6                        DISPLACEMENT OF 6 BYTES@YA12165 16900000
         SPACE 3                                                        17000000
********                                                                17100000
******** ESTABLISH ADDRESSABILITY                                       17200000
********                                                                17300000
         USING IEDAYH,RBASE             BASE ADDR IS PASSED             17400000
         USING IEDNTRM,R1               TTE ADDRESSABILITY     @Y17XAYP 17500000
         USING IEDQSCB,RSCB             SCB ADDR IS PASSED (ENTRY1)     17600000
*                                       OR DETERMINED LATER (ENTRY2)    17700000
         USING IEDQLCB,RLCB             LCB ADDR IS PASSED              17800000
         USING IEDQQCB,RQCB             QCB ADDR IS DETERMINED LATER    17900000
         USING IEDQDISP,RDISPA          DISPATCHER ADDR IS PASSED       18000000
         USING AVTSAVE2,RAVTSAVE        AVTSAVE2 ADDR IS PASSED         18100000
         USING IEDQPRF,RBUF             BFR ADDR IS DETERMINED LATER    18200000
         SPACE 3                                                        18300000
* * * * * * * * * * * *  FIRST ('NORMAL') ENTRY * * * * * * * * * * * * 18400000
         SPACE 3                                                        18500000
********                                                                18600000
******** BRANCH PAST SECOND ENTRY'S QCB                                 18700000
********                                                                18800000
ENTRY1   EQU   *                                                        18900000
         B     SETUP                    QCB WORD 1 - GO TO ENTRY1       19000000
         DC    F'0'                     QCB WORD 2 - FILLER             19100000
         DC    AL1(DSPMCPL4),AL3(*-1)   QCB WORD 3 - INDEX AND CHAIN    19200000
         SPACE 3                                                        19300000
* * * * * * * * * SECOND ('POST' OR 'HANG UP') ENTRY  * * * * * * * * * 19400000
         SPACE 3                                                        19500000
********                                                                19600000
******** SET UP ADDRESSES TO MATCH FIRST ENTRY'S                        19700000
********                                                                19800000
ENTRY2   EQU   *                                                        19900000
         LR    RBASE,RQCB               SET UP BASE                     20000000
         LR    RLCB,R1                  PUT LCB ADDR IN LCB REG         20100000
         L     RSCB,LCBSCBA-1           GET SCB ADDR                    20200000
         SR    RPLAY,RPLAY              DENOTE ENTRY2 TAKEN (ZERO)      20300000
         B     FINDQCB                  BR PAST SETTING UP FOR ENTRY1   20400000
IEDAYH   IEDHJN ,                                                       20500000
         SPACE 3                                                        20600000
********                                                                20700000
******** INITIALIZE FOR FIRST ENTRY                                     20800000
********                                                                20900000
SETUP    DS    0H                                                       21000000
         BALR  RPLAY,0                  DENOTE ENTRY1 TAKEN (NON-ZERO)  21100000
         LR    RBUF,R1                  SAVE POST LIST ADDR             21200000
         SPACE 3                                                        21300000
* * * * * * * * * * * * CODE FOR ERROR CHECKING * * * * * * * * * * * * 21400000
         SPACE 3                                                        21500000
********                                                                21600000
******** FIND THE ASSOCIATED QCB                                        21700000
********                                                                21800000
FINDQCB  EQU   *                                                        21900000
         LH    R1,LCBTTCIN              GET INDEX TO TNT                22000000
         N     R1,AVTCLRHI              CLEAR HI-ORDER HALFWORD         22100000
         L     R15,AVTRNMPT             GET ADDR OF TNT                 22200000
         BALR  RETURN,R15               BR TO TNT CODE TO GET ADDR      22300000
*                                       OF TERMINAL ENTRY IN REG 1      22400000
         LA    R15,TRMPRFSZ             GET SIZE OF TTE PREFIX @Y17XAYP 22500000
         SR    R1,R15                   SET TTE BASE           @Y17XAYP 22600000
         L     RQCB,TRMDESTQ-1          GET QCB ADDR FROM TERMINAL ENT  22700000
         LR    R15,RPLAY                PUT ENTRY CODE IN PARM REG      22800000
         SPACE 3                                                        22900000
********                                                                23000000
******** SEE IF THIS IS A TSO USER'S QCB                                23100000
********                                                                23200000
         TM    QCBFLAG,QCBTSSES         IS THIS A TSO USER              23300000
         BO    SEEIFERR                 YES - SEE IF ANY ERRS OCCURRED  23400000
         LTR   R15,R15                  EXIT ACCORDING TO ENTRY TAKEN   23500000
         BZ    DSPDISP                  ENTRY2 - GO TO TCAM DISPATCHER  23600000
         B     SAYONARA                 ENTRY1 - GO POST ERB            23700000
         SPACE 3                                                        23800000
********                                                                23900000
******** SEE IF HANG UP OR ERROR DURING DISCONNECT HAS OCCURRED         24000000
********                                                                24100000
SEEIFERR EQU   *                                                        24200000
         LTR   R15,R15                  HANG UP ENTRY, ENTRY2, TAKEN    24300000
         BZ    HANGITUP                 YES - CLEAN OUT THE USER        24400000
         TM    SCBERR4,SCBCONNN         ERROR DURING DISCONNECT         24500000
         BO    AUREVOIR                 YES - SET UP TO EXIT            24600000
         SPACE 3                                                        24700000
********                                                                24800000
******** SEE IF NO ERRORS HAVE OCCURRED AND EXIT IF SO                  24900000
********                                                                25000000
         CLI   SCBERR1,AVTEZERO         1ST BYTE ZERO           YA04575 25100000
         BNE   CHKMODE                  NO, ERROR               YA04575 25200000
         TM    SCBERR2,NOT-SCBCRMIN-SCBCRMAX 2ND BYTE O.K.      YA04575 25300000
*                                       NOTE THAT CRMIN AND MAX YA04575 25400000
*                                       ARE NOT ERRORS FOR TSO  YA04575 25500000
         BNZ   CHKMODE                  OTHERS ON, ERROR        YA04575 25600000
         CLI   SCBERR3,AVTEZERO         3RD BYTE ZERO           YA04575 25700000
         BNE   CHKMODE                  NO, ERROR               YA04575 25800000
         CLI   SCBERR4,AVTEZERO         4TH BYTE ZERO           YA04575 25900000
         BNE   CHKMODE                  NO, ERROR               YA04575 26000000
         NC    LCBSENS0,LCBSENS0        ANY ERRORS                      26100000
         BNZ   CHKMODE                  YES - PROCESS THEM              26200000
         NI    QCBRETCT,NOT-QCBHUCT3    ZERO RETRY COUNT       @Y17XAYP 26300000
         B     AUREVOIR                 SET UP TO EXIT                  26400000
         SPACE 3                                                        26500000
********                                                                26600000
******** SEE WHETHER LINE IS SENDING OR RECEIVING                       26700000
********                                                                26800000
CHKMODE  EQU   *                                                        26900000
         TM    SCBERR2,SCBSOHE          IS THIS A SOH%R FOR 3270 S22028 27000000
         BZ    CHKMODE1                 NO, CHECK LINE SENDING   S22028 27100000
         L     ROT,AVTADBUF             GET CUR BUF ADDR        YA04486 27200000
         DROP  RBUF                     DROP ADDRESSABILITY     YA04486 27300000
         USING IEDQPRF,ROT                                      YA04486 27400000
         TM    PRFSTAT1,PRFNHDRN        NOT HEADER?             YA04486 27500000
         BO    CHKMODE1                 YES - SKIP TEST         YA04486 27600000
         TM    TRMSTATE,TRMPREF         IS THIS 3705?          @Y17XAYP 27700000
         BO    CHK3705                  CHECK FOR ERROR AT +6  @YA12165 27800000
         TM    PRFSHDR+D7,E1F           3270 SERIOUS ERROR?    @YA12165 27900000
         BM    COUNT                    YES GO COUNT           @YA12165 28000000
         B     CHKMODE1                 NO CONTINUE            @YA12165 28100000
CHK3705  EQU   *                                               @YA12165 28200000
         TM    PRFSHDR+D6,E1F            3270-3705 SERIOUS ERR @YA12165 28300000
         BM    COUNT                    YES GO COUNT           @YA12165 28400000
         DROP  ROT                      DROP ADDRESSABILITY     YA04486 28500000
         USING IEDQPRF,RBUF             RESTORE PREV. ADDABIL   YA04486 28600000
CHKMODE1 EQU   *                                                 S22028 28700000
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING                 28800000
         BO    SENDMODE                 YES - TEST SEND ERRORS          28900000
         SPACE 3                                                        29000000
* * * * * * * * * * CODE FOR ERRORS WHILE RECEIVING * * * * * * * * * * 29100000
         SPACE 3                                                        29200000
         TM    TRMSTATE,TRMPREF         TRM HAVE PREFIX        @Y17XAYP 29300000
         BNO   NOTSNAER                 NO,DON'T CHECK SNA     @Y17XAYP 29400000
         TM    TRMBYTE0,TRMSNA          IS THIS A SNA TERMINAL @Y17XAYP 29500000
         BNO   NOTSNAER                 NO, SKIP CHECKING SNA  @Y17XAYP 29600000
*                                       SENSE CODES            @Y17XAYP 29700000
********                                                       @Y17XAYP 29800000
******** SNA ERRORS WHILE RECEIVING                            @Y17XAYP 29900000
********                                                       @Y17XAYP 30000000
         SPACE 3                                                        30100000
         TM    SCBERR2,SCBRRJN          REQUEST REJECTED       @Y17XAYP 30200000
         BNO   NOTRQREJ                 NO,CHECK FOR OTHER ERR @Y17XAYP 30300000
         CLI   LCBSMIN,SNSNGRB          NEG RSP TO BID RETRY   @Y17XAYP 30400000
         BE    COUNT                    YES,COUNT ERROR        @Y17XAYP 30500000
         CLI   LCBSMIN,SNSINTRQ         INTERVENTION REQUIRED  @Y17XAYP 30600000
         BE    COUNT                    YES,COUNT ERROR        @Y17XAYP 30700000
         CLI   LCBSMIN,SNSRTRY          RETRY REQUESTED        @Y17XAYP 30800000
         BE    MSG                      YES,SEND MSG,COUNT ERR @Y17XAYP 30900000
NOTRQREJ EQU   *                        NOT REQUEST REJECTED   @Y17XAYP 31000000
         TM    SCBERR4,SCBSTERN         SNA STATE ERROR        @Y17XAYP 31100000
         BO    MSG                      YES,SEND MSG,COUNT ERR @Y17XAYP 31200000
         TM    SCBERR3,SCBFIERN         FUNCTION INTERPRETOR   @Y17XAYP 31300000
*                                       ERROR                  @Y17XAYP 31400000
         BO    MSG                      YES,SEND MSG,COUNT ERR @Y17XAYP 31500000
         TM    SCBERR3,SCBPERRN         SNA PATH ERROR         @Y17XAYP 31600000
         BO    HANGITUP                 YES, HANG UP           @Y17XAYP 31700000
         TM    SCBERR4,SCBCPMEN         SNA CPM ERROR          @Y17XAYP 31800000
         BO    HANGITUP                 YES, HANG UP           @Y17XAYP 31900000
         SPACE 3                                                        32000000
NOTSNAER EQU   *                        NO SNA ERRORS          @Y17XAYP 32100000
********                                                                32200000
******** HAS A PERMANENT ERROR OCCURRED IN A 3705 ATTACHED TERMINAL     32300000
********                                                                32400000
         TM    TRMSTATE,TRMPREF         IS THIS 3705 TERMINAL  @Y17XAYP 32500000
         BNO   NOT3705                  NO, SKIP CTL UNIT TEST  YS6327  32600000
         TM    SCBERR4,SCBCTLUN         CONTROL UNIT ERROR      YS6327  32700000
         BO    HANGITUP                 YES, HANG UP NOW        YS6327  32800000
         SPACE 3                                                YS6327  32900000
********                                                                33000000
******** HAS A 'COUNTABLE' ERROR OCCURRED (COUNT AND MESSAGE)           33100000
********                                                                33200000
NOT3705  EQU   *                                                YS6327  33300000
         TM    SCBERR4,SCBSLCTN         IS IT ERROR DURING SELECT       33400000
         BO    COUNT                    YES - COUNT, CNCL, RET          33500000
         TM    SCBERR4,SCBUNDFN         A COUNTABLE ERROR               33600000
         BO    MSG                      YES - SEND MSG, CNT, CNCL, RET  33700000
         TM    LCBSENS0,NOT-TIMEOUT     ANY COUNTABLE ERRORS            33800000
         BNZ   MSG                      YES - SEND MSG, CNT, CNCL, RET  33900000
         SPACE 3                                                        34000000
********                                                                34100000
******** HAS A 'NON-COUNTABLE' ERROR OCCURRED (MESSAGE)                 34200000
********                                                                34300000
         TM    SCBERR1,SCBNOBFN+SCBCUTFN     ANY NON-COUNTABLE ERRS     34400000
         BNZ   CANCEL                   NO - CANCEL AND RET TO TCAM     34500000
         SPACE 3                                                        34600000
********                                                                34700000
******** FORGET 'REENTER' MESSAGE AND FORGET A RETRY COUNT              34800000
********                                                                34900000
         B     FORGET                   TELL USER WHAT HAPPENED         35000000
         SPACE 3                                                        35100000
* * * * * * * * * *  CODE FOR ERRORS WHILE SENDING  * * * * * * * * * * 35200000
         SPACE 3                                                        35300000
SENDMODE EQU   *                                                        35400000
********                                                                35500000
******** HAS A PERMANENT ERROR OCCURRED                                 35600000
********                                                                35700000
         TM    SCBERR3,SCBTMINN         TERMINAL INOPERATIVE            35800000
         BO    HANGITUP                 YES - CLEAN OUT THE USER        35900000
         TM    TRMSTATE,TRMPREF         IS THIS 3705 TERMINAL  @Y17XAYP 36000000
         BNO   SKIP3705                 NO, SKIP CTL UNIT TEST  YS6327  36100000
         TM    SCBERR4,SCBCTLUN         CONTROL UNIT ERROR      YS06328 36200000
         BO    HANGITUP                 YES - CLEAN OUT         YS6327  36300000
         TM    TRMBYTE0,TRMSNA          IS THIS A SNA TERMINAL @Y17XAYP 36400000
         BNO   SKIP3705                 NO,SKIP SNA CHECKS     @Y17XAYP 36500000
         SPACE 3                                                        36600000
********                                                       @Y17XAYP 36700000
******** SNA ERRORS WHILE SENDING                              @Y17XAYP 36800000
********                                                       @Y17XAYP 36900000
         TM    SCBERR2,SCBRRJN          REQUEST REJECTED       @Y17XAYP 37000000
         BNO   OTHERERR                 NO,CHECK FOR OTHER ERR @Y17XAYP 37100000
         CLI   LCBSMIN,SNSRCXMT         RCVR IN TRANSMITT MODE @Y17XAYP 37200000
         BE    CHKBRK                   YES,CHECK FOR BREAK-IN @Y17XAYP 37300000
         CLI   LCBSMIN,SNSNGRB          NEGATIVE RSP TO BID    @Y17XAYP 37400000
         BE    COUNT                    YES, COUNT ERROR       @Y17XAYP 37500000
         CLI   LCBSMIN,SNSINTRQ         INTERVENTION REQUIRED  @Y17XAYP 37600000
         BE    COUNT                    YES, COUNT ERROR       @Y17XAYP 37700000
         CLI   LCBSMIN,SNSRTRY          RETRY REQUESTED        @Y17XAYP 37800000
         BE    CNTRTRY                  COUNT ERROR AND RETRY  @Y17XAYP 37900000
OTHERERR EQU   *                        NOT REQUEST REJECTED   @Y17XAYP 38000000
         TM    SCBERR4,SCBSTERN         SNA STATE ERROR        @Y17XAYP 38100000
         BO    COUNT                    YES, COUNT ERROR       @Y17XAYP 38200000
         TM    SCBERR3,SCBFIERN         FUNCTION INTERPRETOR   @Y17XAYP 38300000
*                                       ERROR                  @Y17XAYP 38400000
         BO    COUNT                    YES, COUNT ERROR       @Y17XAYP 38500000
         TM    SCBERR3,SCBPERRN         SNA PATH ERROR         @Y17XAYP 38600000
         BO    HANGITUP                 YES, HANG UP           @Y17XAYP 38700000
         TM    SCBERR4,SCBCPMEN         SNA CPM ERROR          @Y17XAYP 38800000
         BO    HANGITUP                 YES, HANG UP           @Y17XAYP 38900000
         SPACE 3                                                        39000000
SKIP3705 EQU   *                                                YS6327  39100000
********                                                                39200000
******** HAS A 'COUNTABLE' ERROR OCCURRED (COUNT ONLY)                  39300000
********                                                                39400000
         TM    SCBERR3,SCBXCEPN         A COUNTABLE ERROR               39500000
         BO    COUNT                    YES - COUNT AND RET TO TCAM     39600000
         TM    SCBERR4,SCBSLCTN+SCBUNDFN     ANY COUNTABLE ERRORS       39700000
         BNZ   COUNT                    YES - COUNT AND RET TO TCAM     39800000
         TM    LCBSENS0,NOT-DATACHK     ANY COUNTABLE ERRORS            39900000
         BNZ   COUNT                    YES - COUNT AND RET TO TCAM     40000000
         L     ROT,AVTADBUF             GET BUFFER ADDRESS     @SA77953 40020010
         TM    PRFSTAT1-IEDQPRF(ROT),PRFERMGN ERROR ON MESSAGE @SA77953 40040010
         BO    COUNT                    BRANCH YES             @SA77953 40060010
         SPACE 3                                                        40100000
********                                                                40200000
******** FORGET A RETRY COUNT AND FORGET CANCEL                         40300000
********                                                                40400000
FORGET   EQU   *                                                        40500000
         NI    SCBERR4,NOT-SCBTXTTN     ZERO 'REENTER' MSG BIT          40600000
         NI    LCBSENS0,NOT-INTREQ      ZERO INTERVENTION REQ           40700000
         B     AUREVOIR                 RETURN TO TCAM                  40800000
         SPACE 3                                                        40900000
********                                                       @Y17XAYP 41000000
******** COUNT THIS ERROR AND REQUEST RETRY OF OUTPUT          @Y17XAYP 41100000
********                                                       @Y17XAYP 41200000
CNTRTRY  EQU   *                                               @Y17XAYP 41300000
*GET BUFFER AND SET INDICATOR FOR IEDAYO TO RETRY THIS OUTPUT  @Y17XAYP 41400000
         ICM   ROT,7,LCBLSPCI           GET BUFFER ADDRESS     @Y17XAYP 41500000
         OI    PRFSTAT1-IEDQPRF(ROT),PRFERMGN IEDAYO RETRY     @Y17XAYP 41600000
         B     COUNT                    COUNT THIS ERROR       @Y17XAYP 41700000
         SPACE 3                                                        41800000
* * CODE FOR SENDING MESSAGE, RETRY COUNT, CANCEL AND RETURN TO TCAM  * 41900000
         SPACE 3                                                        42000000
********                                                                42100000
******** SEND A 'REENTER' MESSAGE AND GO MAKE A RETRY COUNT             42200000
********                                                                42300000
MSG      EQU   *                                                        42400000
         OI    SCBERR4,SCBTXTTN         SEND 'REENTER' MSG              42500000
         SPACE 3                                                        42600000
********                                                                42700000
******** SET UP A RETRY COUNT, IF ONE NOT PREVIOUSLY ESTABLISHED        42800000
********                                                                42900000
COUNT    EQU   *                                                        43000000
         TM    QCBRETCT,QCBHUCT3        HAS HANGUP SET UP A RETRY CNT   43100000
*                                                              @Y17XAYP 43200000
         BNZ   DECRECT                  YES - DECREMENT IT              43300000
         OI    QCBRETCT,QCBHUCT3        NO - SET ONE UP        @Y17XAYP 43400000
         B     CHKCANCL                 TELL USER WHAT HAPPENED         43500000
         SPACE 3                                                        43600000
********                                                                43700000
******** DECREMENT RETRY COUNT...IF COUNT HITS ZERO, HANG UP ON USER    43800000
********                                                                43900000
DECRECT  EQU   *                                                        44000000
         TM    QCBRETCT,QCBHUCT3        IS COUNT 3                      44100000
         BO    CTOF3                    YES - GO DECREMENT COUNT        44200000
         TM    QCBRETCT,QCBHUCT1        IS COUNT 1                      44300000
         BO    HANGITUP                 YES - BEGIN HANGUP PROCESS      44400000
         XI    QCBRETCT,QCBHUCT3        DECR COUNT BY 1 (IS NOW 1)      44500000
         B     CHKCANCL                 TELL USER WHAT HAPPENED         44600000
CTOF3    EQU   *                                                        44700000
         NI    QCBRETCT,QCBHUCT2        DECR COUNT BY 1 (IS NOW 2)      44800000
         SPACE 3                                                        44900000
********                                                                45000000
******** SEE IF CANCELLING OF MESSAGE MUST BE SKIPPED                   45100000
********                                                                45200000
CHKCANCL EQU   *                                                        45300000
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING                 45400000
         BO    AUREVOIR                 YES - SKIP CANCEL               45500000
         SPACE 3                                                        45600000
********                                                                45700000
******** CANCEL THIS MESSAGE                                            45800000
********                                                                45900000
CANCEL   EQU   *                                                        46000000
         NI    SCBSTATE,NOT-SCBCKPT     CANCEL CHECKPOINT REQUEST       46100000
         LTR   RBUF,RBUF                END OF POST LIST                46200000
         BZ    SAYONARA                 YES - EXIT                      46300000
TRYNEXT  EQU   *                                                        46400000
         NC    PRFLINK,PRFLINK          ANY BFRS IN CHAIN               46500000
         BZ    HAVEBFR                  NO - BFR ADDR IN RBUF           46600000
         L     RBUF,PRFLINK-1           GET NEXT ADDR IN POST LIST      46700000
         B     TRYNEXT                  CHECK IT OUT                    46800000
HAVEBFR  EQU   *                                                        46900000
         OI    PRFSTAT1,PRFCNCLN        CANCEL THIS MSG                 47000000
         SPACE 3                                                        47100000
********                                                                47200000
******** SEE IF MUST POST ERB TO BUFFER DISPOSITION                     47300000
********                                                                47400000
AUREVOIR EQU   *                                                        47500000
         LTR   R15,R15                  ENTRY2 TAKEN                    47600000
         BZ    ENTRY2X                  YES - SKIP THE FOLLOWING        47700000
         CLI   LCBTSTSW,AVTEFF          HAS HANGUP OCCURRED             47800000
         BNE   SAYONARA                 NO - CAN LEAVE NOW              47900000
         B     STOPMSG                  SEND NO MORE MSGGEN MSGS        48000000
ENTRY2X  EQU   *                                                        48100000
         TM    LCBSTAT2,LCBMSGNN        MSGGEN IN PROCESS               48200000
         BO    NOSET                    YES - DON'T RESET LINE          48300000
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN  CLEAR STATUS         @OY14092 48400000
         OI    LCBSTAT1,LCBRECVN        SET RECEIVE STATE      @YA11542 48600000
NOSET    EQU   *                                                        48700000
         SPACE 3                                                        48800000
********                                                                48900000
******** POST ERB TO BUFFER DISPOSITION                                 49000000
********                                                                49100000
         ST    R15,LCBERBLK-1           CLEAR LINK FIELD                49200000
         MVI   LCBERBPY,PRIRCQCB        SET PRIORITY                    49300000
         L     RPLAY,AVTMSGS-1          GET MHR ADDR                    49400000
         L     RPLAY,0(0,RPLAY)         GET ADDR OF BFR DISPOSITION     49500000
         ST    RPLAY,LCBERBQB-1         POST TO BFR DISPOSITION         49600000
         SPACE 3                                                        49700000
********                                                                49800000
******** BYPASS SUBSEQUENT MSGGENS                                      49900000
********                                                                50000000
STOPMSG  EQU   *                                                        50100000
         LA    RWORK,X0100              GET ADDR OF X0100 FOR           50200000
*                                       BFR DISPOSITION                 50300000
         IC    RPLAY,SCBRCVCT           SAVE MSG LIMIT                  50400000
         ST    RWORK,SCBMACR-1          STORE ADDR IN SCB               50500000
         STC   RPLAY,SCBRCVCT           RESTORE MSG LIMIT               50600000
         SPACE 3                                                        50700000
********                                                                50800000
******** EXIT TO TCAM DISPATCHER                                        50900000
********                                                                51000000
SAYONARA EQU   *                                                        51100000
         LA    R1,LCBERB                PUT ADDR OF ERB WHERE EXPECTED  51200000
         BAL   RETURN,DSPCHAIN          GO BACK                @Y17XAYX 51300000
         SPACE 3                                                        51400000
************************************************************** @Y17XAYP 51500000
*        THIS ROUTINE SET INDICATORS THAT CAUSE THIS OUTPUT    @Y17XAYP 51600000
*        TO BE RE-SENT IF THE TERMINAL IS A BREAK TERMINAL AND @Y17XAYP 51700000
*        THE SNA STATUS (RECEIVER IN TRANSMIT MODE) WAS        @Y17XAYP 51800000
*        RECEIVED. IT ALSO SETS AN INDICATOR THAT CAUSES A     @Y17XAYP 51900000
*        SIGNAL DFC COMMAND TO BE SENT BEFORE THIS OUTPUT IS   @Y17XAYP 52000000
*        RE-TRIED.                                             @Y17XAYP 52100000
************************************************************** @Y17XAYP 52200000
CHKBRK   EQU   *                                               @Y17XAYP 52300000
         TM    QCBFLAG,QCBNOBRK         IS THIS A NOBREAK TERM @Y17XAYP 52400000
         BO    COUNT                    COUNT THE ERROR        @Y17XAYP 52500000
         ICM   ROT,7,LCBLSPCI           GET BUFFER THAT WILL   @Y17XAYP 52600000
*                                       POSTED TO IEDAYO       @Y17XAYP 52700000
         OI    PRFSTAT1-IEDQPRF(ROT),PRFERMGN  IEDAYO RETRY    @Y17XAYP 52800000
         TM    TRMBYTE2,TRMWRBRK        IS WRITE BREAK ALREADY @Y17XAYP 52900000
*                                       IN PROGRESS            @Y17XAYP 53000000
         BO    NOBRK                    YES,POST ERB TO BD     @Y17XAYP 53100000
         OI    QCBFLAG,QCBREAD          ASSUME TPUT NOBREAK    @Y17XAYP 53200000
*                                       AND SET QCBREAD TO     @Y17XAYP 53300000
*                                       PREVENT RETRY UNTIL    @Y17XAYP 53400000
*                                       EITHER DATA IS ENTERED @Y17XAYP 53500000
*                                       OR LUSTAT (COMPONENT   @Y17XAYP 53600000
*                                       AVAILABLE) IS RECEIVED @Y17XAYP 53700000
         TM    QCBTSOF1,QCBWRBRK        TPUT BREAK REQUEST     @Y17XAYP 53800000
         BNO   NOBRK                    NO,POST ERB TO BD      @Y17XAYP 53900000
         NI    QCBFLAG,NOT-QCBREAD      RESET QCBREAD          @Y17XAYP 54000000
         LA    RPLAY,QCBPRFSZ           GET SIZE OF QCB PREFIX @Y17XAYP 54100000
         SR    RQCB,RPLAY               BACK UP TO PREFIX      @Y17XAYP 54200000
         DROP  RQCB                                            @Y17XAYP 54300000
         USING IEDNQCB,RQCB             PREFIX ADDRESSABILITY  @Y17XAYP 54400000
         OI    QCBSTAT1,QCBESIG         INDICATE THAT SIGNAL   @Y17XAYP 54500000
*                                       SHOULD BE SENT         @Y17XAYP 54600000
NOBRK    EQU   *                                               @Y17XAYP 54700000
         XC    SCBERRST,SCBERRST        CLEAR ERROR WORD       @Y17XAYP 54800000
         B     SAYONARA                 POST ERB TO BD         @Y17XAYP 54900000
         SPACE 3                                                        55000000
* * * * * * * * * * * * * DISCONNECT THE USER * * * * * * * * * * * * * 55100000
         SPACE 3                                                        55200000
********                                                                55300000
******** GET ASID FROM QCB AND ENSURE THAT IT IS NON-ZERO               55400010
********                                                                55500000
HANGITUP EQU   *                                                        55600000
         DROP  RQCB                                            @Y17XAYP 55700000
         USING IEDQQCB,RQCB             QCB ADDRESSABILITY     @Y17XAYP 55800000
         TM    QCBTSOF1,QCBDELAY        QCB IN DELAY QUEUE              55900000
         BO    DIFFASID                 YES,GET ASID FROM LINK @G36XRYP 56000010
         LH    RPLAY,QCBTJID            GET ASID               @G36XRYP 56100010
         B     TESTASID                 CHK FOR NON-ZERO TJID  @G36XRYP 56200010
DIFFASID EQU   *                                               @G36XRYP 56300010
         LH    RPLAY,QCBLINK+1          LOAD ASID              @G36XRYP 56400010
TESTASID EQU   *                                               @G36XRYP 56500010
         LTR   RPLAY,RPLAY              ASID VALID (NON-ZERO)  @G36XRYP 56600010
         BZ    AUREVOIR                 NO - WE ALREADY DID OUR THING   56700000
         SPACE 3                                                        56800000
********                                                                56900000
******** FIND THE ASSOCIATED ASCB AND TSB                               57000010
********                                                                57100000
         TM    AVTBIT3,AVTTSAB          TEST FOR TSO HAS ABENDED A44839 57200000
         BO    CHKERB                   YES, GOTO DEQUEUE ERB    A44839 57300000
         L     RAT,CVTPTR               GET CVT ADDR                    57400000
         USING CVT,RAT                                                  57500000
         L     RTSB,CVTASVT             GET ASVT ADDRESS       @ZM47649 57510010
         DROP  RAT                                             @G36XRYP 57520010
         BCTR  RPLAY,0                  DECREMENT ASID FOR     @G36XRYP 57530010
*                                       ZERO ORIGIN            @G36XRYP 57540010
         SLL   RPLAY,2                  MULTIPLY BY 4          @G36XRYP 57550010
         AR    RTSB,RPLAY                                      @G36XRYP 57560010
         L     RASCB,ASVTENTY-ASVT(,RTSB)   ASCB ADDRESS       @ZM46782 57570010
         USING ASCB,RASCB               ASCB ADDRESSABILITY    @G36XRYP 57580010
         L     RTSB,ASCBTSB             GET TSB ADDRESS        @G36XRYP 57590010
         USING TSB,RTSB                                                 58600000
         SPACE 3                                                        58700000
********                                                                58800000
******** SEE IF ASCB/TSB HAVE BEEN THRU HANG UP OR LOGOFF ALREADY       58900010
********                                                                59000000
         TM    TRMSTATE,TRMPREF         IS THIS 3705 TERMINAL  @Y17XAYP 59100000
         BZ    NONCP1                   NO,CONTINUE            @YA08078 59200000
         TM    SCBERR4,SCBCTLUN         CU ERROR               @UA08078 59300000
         BO    CHKERB                   YES,CONTINUE           @YA08078 59400000
NONCP1   EQU   *                                               @YA08078 59500000
         TM    TSBFLG4,TSBHUNG          HANG UP ALREADY        @G36XRYP 59600010
         BO    AUREVOIR                 YES - NO NEED TO GO THRU AGAIN  59700000
         TM    TSBSTAT,TSBDISC          LOGOFF BEEN ENTERED BEFORE      59800000
         BO    AUREVOIR                 YES - NO NEED TO GO THRU AGAIN  59900000
         SPACE 3                                                        60000000
********                                                                60100000
******** SEE IF ERB MUST BE DEQUEUED AND BASIC UNITS TPOSTED TO BFR RET 60200000
********                                                                60300000
CHKERB   EQU   *                                                 A44839 60400000
         LR    RAT,R1                   SAVE TRM ADDR                   60500000
         LR    ROT,R15                  SAVE ENTRY CODE                 60700000
         TM    LCBERBST,LCBINQ          IS ERB ENQUEUED                 60800000
         BNO   INQEXIT                  NO - NO NEED TO REMOVE          60900000
         SPACE 3                                                        61000000
********                                                                61100000
******** SCAN BUFFER RETURN QUEUE TO FIND ERB                           61200000
********                                                                61300000
         LA    RWORK,LCBERB             GET THIS LINE'S ERB ADDR        61400000
         LA    RPLAY,AVTBFRTB           GET ADDR OF ERB POINTER         61500000
INQSRCH  EQU   *                                                        61600000
         CLC   E1(E3,RPLAY),AVTDELAD+1  IS THIS THE END OF QUEUE        61700000
         BZ    INQRESET                 YES - ERB NOT FOUND             61800000
         L     R15,0(0,RPLAY)           GET ADDR OF ERB (IF ANY)        61900000
         LA    R15,0(0,R15)             CLEAR HI-ORDER BYTE             62000000
         CR    R15,RWORK                ERB FOR THIS LINE               62100000
         BE    INQDEQ                   YES - GO DEQUEUE IT             62200000
         LA    RPLAY,LCBERBLK-1-LCBERB(0,R15)     GET ADDR OF           62300000
*                                       ERB POINTER                     62400000
         B     INQSRCH                  CONTINUE SEARCHING              62500000
         SPACE 3                                                        62600000
********                                                                62700000
******** DEQUEUE ERB AND RETURN BASIC UNITS                             62800000
********                                                                62900000
INQDEQ   EQU   *                                                        63000000
         MVC   E1(E3,RPLAY),LCBERBLK    REMOVE ERB FROM CHAIN           63100000
         NC    LCBERBCH,LCBERBCH        ANY BASIC UNITS TO FREE         63200000
         BZ    INQRESET                 NO - SHOW ERB DEQUEUED          63300000
         DROP  R1                       DROP TRM ADDRESSABILITY         63400000
         L     R1,LCBERBCH-1            GET ADDR OF BFR FRAGMENT        63500000
         DROP  RBUF                                                     63600000
         USING IEDQPRF,R1               TCAM BFR ADDRESSABLE            63700000
         XC    LCBERBCH,LCBERBCH        CLEAR CHAIN POINTER             63800000
         SPACE 3                                                        63900000
********                                                                64000000
******** TPOST BASIC UNITS TO BUFFER RETURN                             64100000
********                                                                64200000
INQLOOP  EQU   *                                                        64300000
         LA    RPLAY,AVTBFRTB           GET BFR RET QCB ADDR            64400000
         ST    RPLAY,PRFQCBA-1          PUT QCB ADDR IN ELEMENT         64500000
         MVI   PRFPRI,PRIBFRTB          SET TPOST PRIORITY              64600000
         L     RPLAY,PRFLINK-1          GET NEXT BFR'S ADDRESS          64700000
         XC    PRFLINK,PRFLINK          CLEAR BUFFER POINTER            64800000
         LR    RTSB,RQCB                SAVE QCB ADDR                   64900000
         BAL   RETURN,DSPPOSTR          GO TPOST                        65000000
         L     RSCB,LCBSCBA-1           RESTORE SCB ADDR                65100000
         LR    RQCB,RTSB                RESTORE QCB ADDR                65200000
         LA    RPLAY,0(0,RPLAY)         ZERO HI-ORDER BYTE              65300000
         LTR   R1,RPLAY                 MORE BASIC UNITS TO TPOST       65400000
         BNZ   INQLOOP                  YES - GO TPOST                  65500000
         L     RTSB,ASCBTSB             RESTORE TSB ADDR       @G36XRYP 65600010
INQRESET EQU   *                                                        65700000
         NI    LCBERBST,NOT-LCBINQ      SHOW ERB DEQUEUED               65800000
INQEXIT  EQU   *                                                        65900000
         DROP  R1                       DROP BFR ADDRESSABILITY         66000000
         USING IEDQPRF,RBUF                                             66100000
         USING IEDQTRM,R1               TRM AGAIN ADDRESSABLE           66200000
         SPACE 3                                                        66300000
         TM    AVTBIT3,AVTTSAB          TEST FOR TSO HAS ABENDED A44839 66400000
         BO    CHKLCB                   YES, DO NOT ISSUE QTIP   A44839 66500000
         USING TSB,RTSB                                         YA00689 67100000
         SPACE 3                                                 A44839 67200000
********                                                                67300000
******** GO TO QTIP TO TELL TSC ABOUT THIS HANG UP AND TO INVOKE SIL    67400000
********                                                                67500000
         LR    R1,RAVTSAVE              GET SAVE AREA ADDR FOR QTIP     67600000
         QTIP  HANGUP,(1)               TELL TSO ABOUT THIS HANG UP     67700000
         SPACE 3                                                        67800000
********                                                                67900000
******** REMOVE LCB FROM DELAY QUEUE IF NECESSARY                       68000000
********                                                                68100000
CHKLCB   EQU   *                                                 A44839 68200000
         TM    LCBINSRC+2,LCBDELAY      IS LCB IN DELAY QUEUE           68300000
         BZ    CHKQCB                   NO - SEE IF QCB IS              68400000
         LR    R1,RLCB                  PUT LCB ADDR WHERE NEC          68500000
         L     R15,AVTHG02              GET ADDR OF REMOVAL RTN         68600000
         BALR  RETURN,R15               GO REMOVE LCB FROM QUEUE        68700000
         SPACE 3                                                        68800000
********                                                                68900000
******** PUT RECEIVE SCHEDULER BACK INTO STCB CHAIN                     69000000
********                                                                69100000
         LA    RQCB,LCBRSKEY            GET ADDR OF FIRST STCB          69200000
         LR    R1,RQCB                  GET ADDR OF FIRST STCB          69300000
         BAL   RETURN,DSPPRIOR          GO CHAIN                        69400000
         L     RSCB,LCBSCBA-1           RESTORE SCB ADDR                69500000
         L     RQCB,TRMDESTQ-1-IEDNTRM(,RAT)  RESTORE QCB ADDR @Y17XAYP 69600000
         SPACE 3                                                        69700000
********                                                                69800000
******** REMOVE QCB FROM DELAY QUEUE IF NECESSARY                       69900000
********                                                                70000000
CHKQCB   EQU   *                                                        70100000
         TM    QCBTSOF1,QCBDELAY        IS QCB IN DELAY QUEUE           70200000
         BZ    CLEANUP                  NO - GO CLEAN CTRL BLKS         70300000
         LR    R1,RQCB                  PUT QCB ADDR WHERE NEC          70400000
         L     R15,AVTHG02              GET ADDR OF REMOVAL RTN         70500000
         BALR  RETURN,R15               GO REMOVE QCB FROM QUEUE        70600000
         SPACE 3                                                        70700000
* * * * * * * * * * * * CONTROL BLOCK CLEAN UP  * * * * * * * * * * * * 70800000
         SPACE 3                                                        70900000
********                                                                71000000
******** PREPARE LCB AND SCB FOR NEXT USER                              71100000
********                                                                71200000
CLEANUP  EQU   *                                                        71300000
         ST    RAT,AVTDOUBL+4           SAVE TERM ADDR         @OY15019 71400000
         USING IEDNTRM,R1               TTE ADDRESSABILITY     @Y17XAYP 71500000
         ST    ROT,AVTDOUBL             SAVE ENTRY CODE        @OY14092 71600000
         MVI   LCBTSTSW,AVTEFF          IND LINE IS TO BE ENABLED       71700000
         OI    LCBSTAT2,LCBNEGRP        TELL TCAM TO DISCONNECT         71800000
         NI    LCBSTAT2,NOT-LCBRESP     TERM NEEDS NO RESPONSE   A46135 71900000
         NI    LCBTSOB,NOT-LCBTSBUF-LCBSATRD-LCBCIRCD  RESET FLAG       72000000
         MVI   LCBSENS0,AVTEZERO        RESET STATUS                    72100000
         MVI   LCBTPCD+ELEVEN,AVTEZERO  CLEAR TP OP CODE       @OY15030 72150000
         L     RPLAY,LCBDCBPT           GET DCB ADDR           @OY14092 72500000
         TM    DCBDSORG-IHADCB(RPLAY),TRMLGB  3705 RESOURCE    @OY14092 72560000
         BO    NOSTOP                   YES, BRANCH            @OY14092 72620000
         TM    LCBSTAT1,LCBOCWTN        STOPLINE IN PROGRESS   @OY14092 72680000
         BZ    NOSTOP                   NO, BRANCH             @OY14092 72740000
         SR    RAT,RAT                  CLEAR FOR RLN          @OY14092 72800000
         IC    RAT,LCBUCBX              GET RLN                @OY14092 72900000
         SLL   RAT,E2                   MULTIPLY BY FOUR       @OY14092 73000000
         L     RAT,DCBINVLI-IHADCB(RAT,RPLAY) GET LIST ADDR    @OY14092 73100000
         SR    RPLAY,RPLAY              CLEAR FOR              @OY14092 73200000
         IC    RPLAY,E1(,RAT)           GET NO. ACTIVE ENTRIES @OY14092 73300000
         LTR   RPLAY,RPLAY              ANY ACTIVE             @OY14092 73400000
         BZ    NOWAIT                   NO, GO SET BIT         @OY14092 73500000
         LA    ROT,D7(,RAT)             POINT TO ENTRY-ONE     @OY14092 73600000
ENTLOOP  EQU   *                                               @OY14092 73700000
         SR    R1,R1                    CLEAR                  @OY14092 73800000
         IC    R1,E2(,RAT)              GET WIDTH              @OY14092 73900000
         AR    ROT,R1                   POINT TO INDEX BYTE    @OY14092 74000000
         SR    RWORK,RWORK              CLEAR                  @OY14092 74100000
         IC    RWORK,EZERO(,ROT)        GET INDEX BYTE         @OY14092 74200000
         SLL   RWORK,E1                 MULTIPLY BY TWO        @OY14092 74300000
         LR    R1,RAT                   GET LIST ADDR          @OY14092 74400000
         SR    R1,RWORK                 BACKUP TO TNT          @OY14092 74500000
         LH    R1,EZERO(,R1)            PICK UP TNT            @OY14092 74600000
         L     R15,AVTRNMPT             GET LOOKUP ROUTINE     @OY14092 74700000
         BALR  RETURN,R15               CALL ROUTINE           @OY14092 74800000
         L     R1,TRMDESTQ-1-IEDQTRM(,R1) GET QCB ADDR         @OY14092 74900000
         TM    QCBFLAG-IEDQQCB(R1),QCBTSSES IN SESSION         @OY14092 75000000
         BNZ   NOSTOP                   YES, GET OUT           @OY14092 75100000
         BCT   RPLAY,ENTLOOP            GET NEXT               @OY14092 75200000
NOWAIT   EQU   *                                               @OY14092 75300000
         NI    LCBSTAT1,AVTEFF-LCBOCWTN RESET WAIT BIT         @OY14092 75400000
         OI    LCBSTAT1,LCBOCNI         SET STOP BIT           @OY14092 75500000
NOSTOP   EQU   *                                               @OY14092 75600000
         L     R15,AVTDOUBL             RESTORE ENTRY CODE     @OY14092 75700000
         L     R1,AVTDOUBL+4            RESTORE TRM ADDR       @OY15019 75750000
         XC    SCBERRST(SCBRGSAV-SCBERRST),SCBERRST  RESET SCB          75800000
         SPACE 3                                                        75900000
********                                                                76000000
******** PREPARE QCB FOR NEXT USER                                      76100000
********                                                                76200000
         NI    QCBFLAG,NOT-QCBTSSES-QCBREAD-QCBNOBRK  RESET STATUS      76300000
         NI    QCBDSFLG,NOT-QCBALTMH    RESET ALTERNATE MH PATH  S22029 76400000
         MVI   QCBRETCT,AVTEZERO        ZERO RETRY COUNT                76500000
         MVI   QCBCARCT,AVTEZERO        ZERO CARRIAGE COUNT             76600000
         XC    QCBTJID,QCBTJID          ZERO ASID              @G36XRYP 76700010
         MVC   QCBSATCT(E3),AVTFZERO    ZERO COUNT AND FLAGS            76800000
         SPACE 3                                                        76900000
********                                                                77000000
******** FIND TERMINAL CHARACTERISTICS TABLE TO INITIALIZE QCB BITS     77100000
********                                                                77200000
         SR    RPLAY,RPLAY              ZERO REG FOR IC INSTR           77300000
         IC    RPLAY,TRMCHCIN           GET INDEX                       77500000
         BCTR  RPLAY,0                  SUBTRACT 1                      77600000
         MH    RPLAY,AVTDCTLN           MULT BY DCT ENTRY SIZE @Y17XAYP 77700000
         A     RPLAY,AVTCSTCS           ADD BASE FOR CHAR TBL           77800000
         USING IEDDCT,RPLAY             DCT ADDRESSABILITY     @Y17XAYP 77900000
         SPACE 3                                                        78000000
********                                                                78100000
******** INITIALIZE QCB BITS ACCORDING TO TERMINAL CHARACTERISTICS TBL  78200000
********                                                                78300000
         TM    DCTBYTE1,DCTBREAK        BREAK FEATURE PRESENT  @Y17XAYP 78400000
         BO    CHK5041                  YES - CHK 5041 STATUS           78500000
         OI    QCBFLAG,QCBNOBRK         DENOTE ABSENCE OF BREAK         78600000
         NI    LCBSTAT2,NOT-LCBSNDPR    TURN OFF SEND PRIORITY @OZ18790 78650010
CHK5041  EQU   *                                                        78700000
         TM    DCTBYTE1,DCT5041         5041 LINE              @Y17XAYP 78800000
         BNO   SKIPRST                  NO, DON'T RESET         YS6327  78900000
         NI    LCBTSOB,NOT-LCB2741N     RESET 2741 INDICATOR    YS6327  79000000
SKIPRST  EQU   *                                                YS6327  79100000
         SPACE 3                                                YS6327  79200000
********                                                                79300000
******** FOR 3705, SET UP DEVICE MODE FIELD TO RESET TERMINAL TO        79400000
******** MATCH DCT SPECIFICATIONS                                       79500000
********                                                                79600000
         TM    TRMDEVFL+1,TRMRNTRM      IS THIS 3705 LINE       YS6327  79700000
         BNO   AUREVOIR                 NO, SKIP DEV MODE       YS6327  79800000
         TM    TRMSTATE,TRMOPTFN        ARE THERE ANY OPTN FLDS YS6327  79900000
         LA    RWORK2,TRMOPNO           ASSUME NONE             YS6327  80000000
         BNO   NOOPTION                 BRANCH ON NO OPTN FLDS  YS6327  80100000
         SR    RWORK5,RWORK5            CLEAR REGISTER FOR IC   YS6327  80200000
         IC    RWORK5,TRMOPNO           NUMBER OF OPTION FIELDS YS6327  80300000
         LA    RWORK2,TRMOPT(RWORK5)    SKIP OPTION FIELDS      YS6327  80400000
NOOPTION EQU   *                                                YS6327  80500000
         LH    RWORK5,TRMDEVFL          GET DEVICE DEP FLAGS    YS6327  80600000
         LA    RWORK9,ELEVEN            SET FOR BIT SEARCH      YS6327  80700000
         SLL   RWORK5,16                SHIFT BITS TO HI ORDER  YS6327  80800000
*                                       TWO BYTES               YS6327  80900000
         SR    ROT,ROT                  CLEAR REGISTER          YS6327  81000000
SHIFT    EQU   *                                                YS6327  81100000
         LTR   RWORK5,RWORK5            IS BIT PRESENT          YS6327  81200000
         BNM   CHKCOUNT                 BRANCH ON NO            YS6327  81300000
         LA    ROT,E1(ROT)              NUMBER OF BITS FOUND    YS6327  81400000
CHKCOUNT EQU   *                                                YS6327  81500000
         SLL   RWORK5,1                 SHIFT TO CHECK NEXT BIT YS6327  81600000
         BCT   RWORK9,SHIFT             HAVE ALL BITS BEEN CHKD YS6327  81700000
         LTR   ROT,ROT                  ANY DEV DEP FIELDS      YS6327  81800000
         BZ    SETMODE                  NO, SET DEV MODE FLDS   YS6327  81900000
         SR    RWORK5,RWORK5            CLEAR REG FOR IC        YS6327  82000000
SKIP     IC    RWORK5,AVTEZERO(,RWORK2) GET DEV DEP FLD LENGTH  YS6327  82100000
         LA    RWORK2,E1(RWORK5,RWORK2) SKIP OVER FIELD         YS6327  82200000
         BCT   ROT,SKIP                 SKIP TO NEXT FIELD      YS6327  82300000
SETMODE  EQU   *                                                YS6327  82400000
         LA    RWORK2,E1(RWORK2)        GET DEV DEP FOR SETMODE YS6327  82500000
         SPACE 3                                                YS06327 82600000
********                                                                82700000
******** INDICATE HANGUP PROCESSING COMPLETE                            82800000
********                                                                82900000
         NI    E1(RWORK2),NOT-STMONITR  TURN OFF MONITOR MODE   YS06327 83000000
         NI    TRMPRE1,NOT-TRMLYNCH    TURN OFF TRMLYNCH BIT   @Y17XAYP 83100000
         OI    TRMPRE,TRMCMODE          INDICATE SET MODE      @Y17XAYP 83200000
*                                       SHOULD BE SENT         @Y17XAYP 83300000
         SPACE 3                                                YS06327 83400000
********                                                                83500000
******** SET DEVICE MODE FIELDS SO 3705 MATCHES DCT                     83600000
********                                                                83700000
         MVI   0(RWORK2),AVTEZERO       ZERO BYTE 0, AND ...    YS6327  83800000
         MVI   E1(RWORK2),AVTEZERO      1, TO FORCE SET MODE    YS6327  83900000
         TM    DCTBYTE1,DCTINHIB        T.O.-SUPPRESSION       @Y17XAYP 84000000
         BNO   OFFINHIB                 NO, GO TURN BIT OFF     YS6327  84100000
         OI    E3(RWORK2),SETINHB       YES, SET T.O. SUPPRESS  YS6327  84200000
         B     AUREVOIR                 DONE                    YS6327  84300000
OFFINHIB EQU   *                                                YS6327  84400000
         NI    E3(RWORK2),NOT-SETINHB   DON'T INHIBIT TIMEOUTS  YS6327  84500000
         SPACE 3                                                YS6327  84600000
         SPACE 3                                                        84700000
********                                                                84800000
******** EXIT TO TCAM DISPATCHER                                        84900000
********                                                                85000000
         B     AUREVOIR                 SET UP TO EXIT                  85100000
         SPACE 3                                                        85200000
********                                                                85300000
******** CONSTANTS                                                      85400000
********                                                                85500000
X0100    DC    X'0100'                  MSGGEN INDICATOR                85600000
PATCH    DC    20F'0'                   PATCH AREA              YA04486 85700000
         SPACE 3                                                        85800000
* * * * * * * * * * * *  CONTROL BLOCK DSECTS * * * * * * * * * * * * * 85900000
         SPACE 3                                                        86000000
CVT      DSECT                                                          86100000
         CVT                                                            86200000
         SPACE 3                                                        86300000
         IHAASCB                                                        86400010
         SPACE 3                                                        86430010
         IHAASVT                                                        86460010
         SPACE 3                                                        86500000
         IKJTSB                                                         86600000
         SPACE 3                                                        86900000
         TAVTD                                                          87000000
         SPACE 3                                               @Y17XAYP 87100000
         TDCTD                                                          87200000
         SPACE 3                                                        87300000
         TLCBD                                                          87400000
         SPACE 3                                                        87500000
         TQCBD                                                          87600000
         SPACE 3                                                        87700000
         TSCBD                                                          87800000
         SPACE 3                                               @Y17XAYP 87900000
         TSNSD                                                          88000000
         SPACE 3                                                        88100000
         TPRFD                                                          88200000
         SPACE 3                                                        88300000
         TTRMD                                                          88400000
         SPACE 3                                                        88500000
         TDISPD                                                         88600000
         SPACE 3                                                        88700000
         TPRIOR                                                         88800000
         TLGBD                                                          88900000
         SPACE                                                          89000000
         DCBD  DSORG=TX                                                 89100000
         SPACE                                                          89200000
         END                                                            89300000
