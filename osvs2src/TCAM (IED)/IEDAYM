         TITLE 'IEDAYM - TSO MESSAGE GENERATION ROUTINE'                00060000
IEDAYM   CSECT                                                          00120000
         SPACE 3                                                        00180000
*                    CHANGE ACTIVITY AS FOLLOWS                         00240000
**************************MICROFICHE FLAGS********************SUPT CODE 00300000
*C000000-999999                                                @Y17XAYP 00360000
*C576600,577200                                                @OY15597 00360700
*A591600                                                       @OY16109 00361400
*A819600                                                       @OY16357 00362100
*A073800,078000,104400,653400,659400,693000,847800             @OY13623 00362800
*C044400,069600,097800,120600,128400,277200,288000,332400      @OY13623 00363500
*A357000,466200,503400,529800,556800,561000,612000,729000      @OY13623 00364200
*A735600,273000,433200,534000,817200                           @OY13623 00364900
*D817800                                                       @OY13623 00365600
*A151800,592200,817450,849600                                  @G36XRYP 00366300
*C256800,271200,393000,417000,431400                           @G36XRYP 00367000
*D058800,152400-156600,592800-597000,817460-817540             @G36XRYP 00367700
*D848000-848200,850200                                         @G36XRYP 00368400
*C831600                                                       @OY18057 00388400
*A296400,838200                                                @OZ26884 00388582
*C304800,315000-316800                                         @OZ26884 00388682
*A731400                                                       @OY20502 00388782
***************************************************************         00420000
*TITLE -- IEDAYM: TSO MESSAGE GENERATION ROUTINE                        00480000
*                                                                       00540000
*MODULE NAME -- IEDAYM            (TCAM,TSO)                   @G36XRYP 00600000
*                                                                       00660000
*DESCRIPTIVE NAME -- TSO MESSAGE GENERATION ROUTINE                     00720000
*                                                                       00780000
*COPYRIGHT -- NONE                                                      00840000
*                                                                       00900000
*STATUS -- VERSION 10.0                                        @G36XRYP 00960000
*                                                                       01020000
*FUNCTION:                                                              01080000
*    THIS ROUTINE BUILDS MSGGEN MESSAGES FOR TRANSMISSION TO            01140000
*    TSO TERMINALS.  THESE MESSAGES ARE SENT EITHER FOR INFOR-          01200000
*    MATIONAL REASONS OR PURPOSES OF TERMINAL CONTROL. SOURCE           01260000
*    TEXT IS CONTAINED IN THE MSGGEN CSECT AND IS MOVED INTO            01320000
*    THE SCB FOR TRANSMISSION TO OX/EP TERMINALS OR BUFFER              01380000
*    UNITS FOR TRANSMISSION TO NCP CONNECTED TERMINALS.                 01440000
*                                                                       01500000
*ENTRY POINTS:                                                          01560000
*    THE FIRST INSTRUCTION -- VIA BRANCH FROM IEDQBD, OR ONE            01620000
*    OF THE FOLLOWING:  IEDAYA,IEDAYO,IEDAYS,IEDAYZ,IGG019Q1,IEDAYJ     01680000
*    THE PRIMARY QCB -- VIA POST FROM LINEEND APPENDAGE OR              01740000
*    DEBLOCK ROUTINES FOR SCREEN ERASURE.                               01800000
*    THE ERB RETURN QCB -- VIA POST FROM IEDQGA WHEN REQUESTED          01860000
*    BUFFERS HAVE BEEN ALLOCATED.                                       01920000
*                                                                       01980000
*                                                                       02040000
*INPUT -- TSO MSGGEN TEXT TO BE TRANSMITTED.                            02100000
*                                                                       02160000
*OUTPUT -- BUILT AND EDITED MESSAGE READY FOR CONTACT WITH              02220000
*    DESTINATION TERMINAL TO BE MADE.                                   02280000
*                                                                       02340000
*                                                                       02400000
*                                                                       02460000
*EXTERNAL ROUTINES                                                      02520000
*   IEDQTNT - TO LOCATE THE TERMINAL ENTRY                              02580000
*   IEDQAE - TO LOCATE A TRANSLATION TABLE OPTION FIELD FOR TRA         02640000
*   IEDAYE - TO EDIT THE MESSAGE                                        02700000
*   IEDQGA - TO GET A BUFFER                                            02760000
*                                                                       02820000
*EXITS-NORMAL -- TO THE DISPATCHER CHAIN FUNCTION                       02880000
*                                                                       02940000
*EXITS-ERROR  -- NONE                                                   03000000
*                                                                       03060000
*TABLES/WORKAREAS -- CVT, TSCVT, AVT, LCB, QCB, SCB, DCB, TSB,          03120000
*   TERMINAL ENTRY, TPRIOR, ERB, DCT, PRF, LGB.                         03180000
*                                                                       03240000
*ATTRIBUTES -- REENTRANT, REFRESHABLE, ENABLED, RESIDENT, PROBLEM       03300000
*   PROGRAM MODE                                                        03360000
*                                                                       03420000
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A           03480000
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER        03540000
*   SET.                                                                03600000
***************************************************************         03660000
         EJECT                                                          03720000
R0       EQU   0                        REGISTER ZERO                   03780000
R1       EQU   1                        REGISTER ONE                    03840000
R2       EQU   2                        REGISTER TWO                    03900000
RSCB     EQU   3                        SCB REGISTER                    03960000
RLCB     EQU   4                        LCB REGISTER                    04020000
R5       EQU   5                        REGISTER FIVE                   04080000
R6       EQU   6                        REGISTER SIX                    04140000
RQCB     EQU   7                        QCB REGISTER                    04200000
R8       EQU   8                        REGISTER EIGHT                  04260000
R9       EQU   9                        REGISTER NINE                   04320000
R10      EQU   10                       REGISTER TEN                    04380000
R11      EQU   11                       REGISTER ELEVEN        @OY13623 04440000
R12      EQU   12                       REGISTER TWELVE                 04500000
R13      EQU   13                       REGISTER THIRTEEN               04560000
R14      EQU   14                       REGISTER FOURTEEN               04620000
R15      EQU   15                       REGISTER FIFTEEN                04680000
TIMEOUT  EQU   1                        TIMEOUT MASK                    04740000
OFFSET   EQU   14                       DATA OFFSET                     04800000
ZERO     EQU   C'0'                     ZERO                            04860000
RESET    EQU   X'42'                    RESET DEVICE QUEUES             04920000
X01      EQU   X'01'                    ONE                             04980000
X03      EQU   X'03'                    THREE                           05040000
X04      EQU   X'04'                    FOUR                            05100000
X05      EQU   X'05'                    FIVE                            05160000
X07      EQU   X'07'                    SEVEN                           05220000
X0C      EQU   X'0C'                    HEX 0C                          05280000
XFE      EQU   X'FE'                    HEX FE                          05340000
BLANK    EQU   C' '                     BLANK                           05400000
ERASECOM EQU   X'05'                    3270 ERASE COMMAND              05460000
ASTERISK EQU   C'*'                                                     05520000
NEWLINE  EQU   X'15'                    NEW LINE CHARACTER              05580000
IDLE     EQU   X'17'                    IDLE CHARACTER                  05640000
ERASE    EQU   X'40'                    2260 REMOTE ERASE               05700000
ADDRCHAR EQU   X'20'                    ADDRESSING CHARACTERS           05760000
CCWWRITE EQU   X'01'                    WRITE OPERATION CODE            05820000
C3270    EQU   X'04'                    3270 TERMINAL                   05880000
PROFILE2 EQU   X'22'                    FMTS PROFILE 2                  05940000
SHFT2BYT EQU   16                                                       06000000
FOURTEN  EQU   14                                                       06060000
TWELVE   EQU   12                                                       06120000
EIGHT8   EQU   8                                                        06180000
SEVEN    EQU   7                                                        06240000
FOUR     EQU   4                                                        06300000
THREE    EQU   3                                                        06360000
TWO      EQU   2                                                        06420000
ONE      EQU   1                                                        06480000
SIX      EQU   6                                               @ZM47758 06510000
         USING IEDAYM,R12                                               06540000
         USING IEDQSCB,RSCB                                             06600000
         USING IEDQLCB,RLCB                                             06660000
         USING AVTSAVE2,R13                                             06720000
         USING IEDQQCB,RQCB                                             06780000
         USING TSB,R6                                                   06840000
         USING IEDQTRM,R9                                               06900000
         USING EDIT,R11                 SET UP ADDRESSABILITY  @OY13623 06950000
         EJECT                                                          07020000
         L     R2,4(,R8)                ASSUME MASK NOT PRESENT         07080000
         B     AYM005                   BRANCH                          07140000
         DC    AL1(DSPMCPL4),AL3(*-1)   STCB                            07200000
         USING *,R15                                                    07260000
         L     R12,AYMBFRQ              LOAD BASE ADDRESS               07320000
         DROP  R15                                                      07380000
         L     R11,VEDIT                SET UP ADDRESSABILITY  @OY13623 07400000
         B     AYM0001                                                  07440000
IEDAYM   IEDHJN ,                                                       07500000
AYMBFRQ  DC    A(IEDAYM)                ADDR FOR RESTORING BASE         07560000
         DC    A(0)                     LINK FIELD                      07620000
STCB3705 DC    X'06'                    STCB KEY                        07680000
         DC    AL3(STCB3705)            STCB CHAIN POINTER              07740000
         L     R12,AVTEZERO(,RQCB)      SET UP BASE REG                 07800000
         L     R11,VEDIT                SET UP ADDRESSABILITY  @OY13623 07830000
         LA    R1,AVTEZERO(,R1)         CLEAR HIGH ORDER BYTE           07860000
         L     RQCB,AVTMSGS-1           PTR TO LIST OF QCBS             07920000
         L     RQCB,AVTEZERO(,RQCB)     ADDR OF IEDQBD QCB              07980000
         LA    RLCB,AVTEZERO(,R1)       ADDRESS OF ERB                  08040000
         SH    RLCB,LCBSIZE             GET ADDRES OF LCB               08100000
         TM    LCBERBST,LCBPRCPG        ERB FROM DEBLOCK AFTER          08160000
*                                       RESET                           08220000
         BZ    AYM0002                  BRANCH YES                      08280000
         NI    LCBERBST,AVTEFF-LCBPRCPG CLEAR REQUEST BIT               08340000
         L     RSCB,LCBSCBA-1           ADDRESS OF SCB                  08400000
         L     R8,SCBSRCE+16            RESTORE PARAMETER LIST          08460000
*                                       ADDRESS                         08520000
         L     R2,4(,R8)                ASSUME MASK NOT PRESENT         08580000
         MVC   T3270(2),AVTFZERO        INITIALIZE 3270 FIELD           08640000
         MVI   LOCSWTCH,0               CLEAR LOCAL SWITCHES   @YM06995 08700000
         SR    R1,R1                    CLEAR REGISTER                  08760000
         B     AYM010                   BRANCH TO THE BEGINNING         08820000
         EJECT                                                          08880000
AYM0001  EQU   *                                                        08940000
         LA    RLCB,AVTEZERO(,R1)       ADDRESS OF ERB                  09000000
         SH    RLCB,LCBSIZE             GET ADDRESS OF LCB              09060000
AYM0002  EQU   *                                                        09120000
         MVC   T3270(2),AVTFZERO        INITIALIZE 3270 FIELD           09180000
         MVI   LOCSWTCH,0               CLEAR LOCAL SWITCHES   @YM06995 09240000
         XC    LCBERBLK,LCBERBLK        AVOID ERROR POST                09300000
         CLI   LCBTSTSW,AVTEFF          TERMINAL DISCONNECTED           09360000
         BNE   AYM0171                  BYPASS SENDING                  09420000
         L     R6,AVTMSGS-1             GET ADDRESS                     09480000
         L     R6,AVTEZERO(,R6)         IEDQBD                          09540000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        09600000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     09660000
         LA    R1,LCBERB                ELEMENT TO POST                 09720000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 09750000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 09780000
AYM0171  EQU   *                                                        09840000
         L     RSCB,LCBSCBA-1           ADDRESS OF SCB                  09900000
         L     R8,SCBMACR-1             ADDRESS OF MACRO LIST           09960000
         TM    SCBERR2,SCBCODER         TRANSLATION ERROR               10020000
         BO    AYM450                   BRANCH YES                      10080000
         TM    SCBSTATE,SCBERSDS        DISPLAY TO BE ERASED            10140000
         BO    AYM300                   BRANCH TO ERASE ROUTINE         10200000
         NI    LCBTSOB,AVTEFF-LCBSATRD  RESET POST FLAG                 10260000
         B     AYM015                   BRANCH                          10320000
         EJECT                                                          10380000
AYM005   EQU   *                                                        10440000
         L     R11,VEDIT                SET UP ADDRESSABILITY  @OY13623 10480000
         ST    R8,SCBSRCE+16            SAVE ADDR OF PARM LIST          10500000
         XC    LCBERBCH,LCBERBCH        CLEAR BUFFER CHAIN              10560000
         MVC   T3270(2),AVTFZERO        INITIALIZE 3270 FIELD           10620000
         MVI   LOCSWTCH,0               CLEAR LOCAL SWITCHES   @YM06995 10680000
AYM010   EQU   *                                                        10740000
         ST    R1,LCBERBLK-1            LINK ELEMENTS FOR POST          10800000
         CLI   LCBTSTSW,AVTEFF                                          10860000
         BE    AYM160                   BYPASS MSGGEN                   10920000
         TM    SCBSTATE,SCBERSDS        DISPLAY TO BE ERASED            10980000
         BO    AYM300                   GO TO ERASE ROUTINE             11040000
         TM    SCBERR2,SCBCODER+SCBOLTR INVALID OLT REQUEST             11100000
*                                       AND DYNAMIC TRANSLATION         11160000
         BO    AYM160                   BRANCH YES                      11220000
         TM    SCBERR2,SCBCODER         TRANSLATION ERROR               11280000
         BO    AYM400                   BRANCH ON YES                   11340000
         NI    LCBTSOB,AVTEFF-LCBSATRD  RESET POST FLAG                 11400000
         TM    1(R8),X0C                IS MASK PRESENT                 11460000
         BC    9,AYM100                 BRANCH IF IT IS                 11520000
         CLC   0(2,R2),X01FF            AUTO LINE OR PROMPT             11580000
         BNE   AYM110                   BRANCH ON NO                    11640000
         LA    R6,IEDAYM                ADDRESS OF THIS ROUTINE         11700000
         NC    LCBERBLK,LCBERBLK        BUFFER ALREADY POSTED           11760000
         BZ    AYM015                   BRANCH ON NO                    11820000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        11880000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     11940000
         LA    R1,LCBERB                ELEMENT TO POST                 12000000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 12050000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 12100000
         EJECT                                                          12120000
AYM160   EQU   *                                                        12180000
         XC    SCBERR1(4),SCBERR1       CLEAR ERROR BYTES               12240000
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE ERRORS              12300000
         NI    SCBSTATE,AVTEFF-SCBCODE  NO TRANSLATE REQUEST            12360000
         LA    R5,X0100                 SET UP FOR BUFFER DISP          12420000
         STCM  R5,7,SCBMACR             REMAINING INMSG/OUTMSG          12480000
         L     R6,AVTMSGS-1             GET ADDRESS                     12540000
         L     R6,AVTEZERO(,R6)         IEDQBD                          12600000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        12660000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     12720000
         LA    R1,LCBERB                ELEMENT TO POST                 12780000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 12800000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 12850000
         EJECT                                                          12900000
AYM015   EQU   *                                                        12960000
         LH    R1,LCBLNENT              GET LINE ENTRY                  13020000
         CLI   LCBFLAG1,LCBPLCB         3705 RESOURCE        @YM07750   13040000
         BE    USETTCIN                 USE TTCIN            @YM07750   13060000
         TM    LCBSTAT2,LCBDIAL         IS THIS A DIAL LINE             13080000
         BO    AYM017                   BRANCH IF YES                   13140000
USETTCIN EQU   *                                             @YM07750   13170000
         LH    R1,LCBTTCIN              GET CONNECTED INDEX             13200000
AYM017   EQU   *                                                        13260000
         N     R1,AVTCLRHI                                              13320000
         L     R15,AVTRNMPT             TERMINAL NAME ROUTINE           13380000
         BALR  R14,R15                  BRANCH TO ROUTINE               13440000
         LR    R9,R1                    SAVE TERM ENTRY ADDRESS         13500000
         L     RQCB,TRMDESTQ-1          GET QCB ADDRESS                 13560000
         TM    AVTBIT3,AVTTSAB          TSO ABEND                       13620000
         BO    AYM030X                  BRANCH YES                      13680000
         TM    SCBERR2,SCBALN           AUTO LINE OR PROMPT             13740000
         BO    AYM030A                  BRANCH ON YES                   13800000
AYM030X  EQU   *                                                        13860000
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING                 13920000
         BO    AYM0181                  RETURN ON YES                   13980000
         TM    QCBRETCT,QCBCR+QCBLF     CARRIAGE RETURNED               14040000
         BO    AYM0181                  BRANCH YES                      14100000
         TM    SCBERR2,SCBSOHE          IS THIS 3270 SOH%R MSG          14160000
         BO    AYM0181                  RETURN ON YES                   14220000
         TM    0(R8),X01                IS MASK PRESENT                 14280000
         BO    AYM030B                  BRANCH ON NO                    14340000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBSATTN+SCBXPI+SCBXPD    14400000
*                                       ANY THING IN MASK               14460000
         BM    AYM100                   BRANCH IF YES                   14520000
         TM    SCBERR1-SCBERRST+3(R8),SCBCUTFN  CUTOFF ERROR            14580000
         BO    AYM100                   BRANCH IF YES                   14640000
         TM    SCBERR4-SCBERRST+3(R8),SCBTXTTN  TEXT ERROR              14700000
         BO    AYM100                   BRANCH IF YES                   14760000
AYM030B  EQU   *                                                        14820000
         TM    LCBSENS0,TIMEOUT         WAS THERE A TIME OUT            14880000
         BO    AYM0181                  BRANCH ON YES                   14940000
         SR    R2,R2                    SET FOR LEFT ADJUST             15000000
         B     AYM110                   BRANCH                          15060000
AYM030A  EQU   *                                                        15120000
         L     R6,CVTPTR                GET CVT ADDRESS        @G36XRYP 15180600
         L     R6,CVTASVT-CVT(R6)       GET ASVT ADDRESS       @G36XRYP 15181200
         LA    R6,ASVTENTY-ASVT(R6)     GET ASCB LIST ADDRESS  @G36XRYP 15181800
         LH    R2,QCBTJID               GET ASID               @G36XRYP 15182400
         BCTR  R2,0                     DECREMENT FOR ZERO     @G36XRYP 15183000
*                                       ORIGIN                 @G36XRYP 15183600
         SLL   R2,2                     MULTIPLY BY 4          @G36XRYP 15184200
         L     R6,AVTEZERO(R2,R6)       GET ASCB ADDRESS       @G36XRYP 15184800
         L     R6,ASCBTSB-ASCB(R6)      GET TSB ADDRESS        @G36XRYP 15185400
         TM    TSBFLG2,TSBAUTOC         PROMPT REQUESTED                15720000
         BZ    AYM050                   BRANCH ON NO                    15780000
         LA    R2,TSBAUTOS              ADDRESS OF MSG + LENGTH         15840000
         B     AYM110                   BRANCH                          15900000
AYM050   EQU   *                                                        15960000
         TM    TSBFLG2,TSBAULST         OR IS IT AUTO LINE NO           16020000
         BZ    AYM030X                  IF NEITHER GO BACK              16080000
         L     RQCB,TSBAUTOS            GET AUTO LINE NUMBER            16140000
         CVD   RQCB,AVTDOUBL            CONVERT TO DECIMAL              16200000
         UNPK  SCBDESTL+1(8),AVTDOUBL   UNPACK                          16260000
         OI    SCBDESTL+8,ZERO          OR IN NUMBER ZONE               16320000
         LA    R2,SCBDESTL              ADDRESS OF NUMBER               16380000
         LA    RQCB,3                   SCAN THREE ZEROES               16440000
AYM060   EQU   *                                                        16500000
         CLI   1(R2),ZERO               SCANNING FOR NUMBER OF          16560000
         BNE   AYM070                   BRANCH IF NOT ZERO              16620000
         LA    R2,1(,R2)                UPDATE TO NEXT BYTE             16680000
         BCT   RQCB,AYM060              CONTINUE                        16740000
AYM070   EQU   *                                                        16800000
         AH    RQCB,FIVE                COMPUTE LENGTH OF MSG           16860000
         STC   RQCB,AVTEZERO(,R2)       STORE LENGTH                    16920000
         B     AYM110                   BRANCH                          16980000
         EJECT                                                          17040000
AYM100   EQU   *                                                        17100000
         L     R2,8(,R8)                GET ADDRESS OF MESSAGE          17160000
AYM110   EQU   *                                                        17220000
         L     R5,8(,R8)                ASSUME TRAN TABLE + NO          17280000
         CLC   0(2,8),X0100             END OF INMSG/OUTMSG             17340000
         BE    AYM150                   BRANCH ON YES                   17400000
         TM    2(R8),AVTE80             TRANSLATION TABLE               17460000
         BO    AYM150                   BRANCH ON NO                    17520000
         TM    1(R8),X0C                IS MASK PRESENT                 17580000
         BM    AYM200                   BRANCH IF NOT                   17640000
         L     R5,12(,R8)               GET TABLE ADDRESS               17700000
         B     AYM200                   BRANCH                          17760000
AYM150   EQU   *                                                        17820000
         CLI   LCBFLAG1,LCBPLCB         3705 RESOURCE?      @YM07750    17840000
         BE    AYM150A                  DON'T USE LCBLNENT  @YM07750    17860000
         TM    LCBSTAT2,LCBDIAL         IS THIS DIAL LINE               17880000
         BZ    AYM150A                  BRANCH ON NO                    17940000
         MVC   LCBTTCIN(2),LCBLNENT     SET CONNECTED INDEX             18000000
AYM150A  EQU   *                                                        18060000
         L     R5,LCBDCBPT              DCB ADDRESS                     18120000
         L     R5,DCBTRANS-1-IHADCB(,R5) GET TRANSLATE TABLE            18180000
         TM    0(R5),AVTE80             IS IT A TRANSLIST MACRO         18240000
         BZ    AYM200                   BRANCH ON NO                    18300000
         ST    R14,AVTPARM              SAVE REG                        18360000
         LA    R1,AVTPARM3              ADDRESS OF PARM LIST            18420000
         MVC   AVTPARM3,AELIST          MOVE IN LIST                    18480000
         MVC   AVTPARM3+2(1),1(R5)      OFFSET TO OPTION FIELD          18540000
         STM   2,12,28(R13)             SAVE AS IEDQUI DOES             18600000
         LA    R14,LOCRTN               SET RETURN ADDRESS              18660000
         ST    R14,12(,R13)             TO SAVE AREA                    18720000
         L     R9,CVTPTR                SEQ TO FIND AVT ADDRESS         18780000
         L     R9,AVTCVTPT(,R9)         *                               18840000
         L     R9,AVTEZERO(,R9)         *                               18900000
         LR    R12,R13                  LOAD CALLERS ADDR               18960000
         LA    R13,72(,R13)             LOAD AE SAVE ADDR               19020000
         ST    R12,4(,R13)              STORE BACK CHAIN                19080000
         ST    R13,8(,R12)              STORE FORWARD CHAIN             19140000
         L     R12,AVTMSGS-1-AVTSVSIZ   AVT REG AT SAVE 3 NOW           19200000
         L     R12,20(,R12)             OFFSET TO IEDQAE VCON           19260000
         BR    R12                      GO TO LOCOPT                    19320000
LOCRTN   EQU   *                                                        19380000
         L     R14,AVTPARM              RETRIEVE REG                    19440000
         L     R5,AVTEZERO(,R15)        ADDRESS OF OPTION FIELD         19500000
         LTR   R15,R15                  OPTION FIELD PRESENT            19560000
         BZ    AYM0181                  BRANCH ON NO                    19620000
         LTR   R5,R5                    TRANSLATE TABLE STORED          19680000
         BZ    AYM0181                  BRANCH ON NO                    19740000
         TM    SCBERR2,SCBCODER         TRANSLATION ERROR               19800000
         BNZ   AYM0181                  BRANCH YES                      19860000
AYM200   EQU   *                                                        19920000
         LA    R14,AYM225               EDIT RETURN ADDRESS             19980000
         LH    R1,LCBLNENT              GET LINE ENTRY                  20040000
         CLI   LCBFLAG1,LCBPLCB         3705 RESOURCE?       @YM07750   20060000
         BE    USELCB                   USE LCBTTCIN         @YM07750   20080000
         TM    LCBSTAT2,LCBDIAL         IS THIS A DIAL LINE             20100000
         BO    AYM206                   BRANCH IF YES                   20160000
USELCB   EQU   *                                             @YM07750   20190000
         LH    R1,LCBTTCIN              GET CONNECTED INDEX             20220000
AYM206   EQU   *                                                        20280000
         N     R1,AVTCLRHI              CLEAR HIGH HALF                 20340000
         L     R15,AVTRNMPT             ADDRESS OF NAME ROUTINE         20400000
         LR    R9,R14                   SAVE RETURN ADDRESS             20460000
         BALR  R14,R15                  BRANCH                          20520000
         LR    R14,R9                   RESTORE RETURN ADDRESS          20580000
         LR    R9,R1                    SAVE TERM ENTRY ADDRESS         20640000
         L     RQCB,TRMDESTQ-1          ADDRESS OF QCB                  20700000
         LA    R1,TRMPRFSZ              PICK UP PREFIX SIZE             20760000
         DROP  R9                                                       20820000
         SR    R9,R1                    BACK UP TO PREFIX               20880000
         USING IEDNTRM,R9                                               20940000
         L     R15,AVTTSOPT             GET ADDR OF TSO QCB             21000000
*                                                                       21060000
*  MOVE THE DCT ENTRY FROM THE DCT TO THE TSO WORK AREA AND             21120000
*  SET THE DCT3270 BIT IF THE TTE IS AN LU TYPE 0,2, OR 3               21180000
*                                                                       21240000
   IEDDCT REG=R1,FLD=TSITSW-IEDQTSI+TSWDCT-IEDQTSW(R15),LEN=6           21300000
         DROP  R9                                                       21360000
         LA    R9,TRMPRFSZ(,R9)         INCREMENT PAST PREFIX           21420000
         USING IEDQTRM,R9                                               21480000
         USING IEDDCT,R1                DCT ADDRESSABILITY              21540000
         MVC   T3270+ONE(1),DCTBYTE1    MOVE DCT BYTE WITH              21600000
*                                       3270 BIT                        21660000
         TM    T3270+ONE,DCT3270        IS THIS A 3270 TERM             21720000
         BO    AYM306A1                 YES, SKIP 2260 CHECKS           21780000
         TM    DCTBYTE3,DCTNOIDL        THIS 2260 REMOTE                21840000
         BO    AYM306A1                 BRANCH ON YES                   21900000
         TM    DCTBYTE2,DCTLOCAL        THIS 2260 LOCAL                 21960000
         BNO   AYM306D1                 BRANCH ON NO                    22020000
AYM306A1 EQU   *                                                        22080000
         TM    0(R8),X01                IS MASK PRESENT                 22140000
         BO    AYM306D1                 BRANCH ON NO                    22200000
         TM    SCBERR3-SCBERRST+3(R8),SCBXPI                            22260000
         BNO   AYM306B1                 BRANCH ON NO                    22320000
         LA    R2,DISPXPI               !I FOR DISPLAYS                 22380000
         B     AYM306F1                 BRANCH                          22440000
AYM306B1 EQU   *                                                        22500000
         TM    SCBERR3-SCBERRST+3(R8),SCBXPD                            22560000
         BNO   AYM306C1                 BRANCH ON NO                    22620000
         LA    R2,DISPXPD               !D FOR DISPLAYS                 22680000
         B     AYM306F1                 BRANCH                          22740000
AYM306C1 EQU   *                                                        22800000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBSATTN                  22860000
         BZ    AYM306D1                 BRANCH ON NO                    22920000
         LA    R2,DISPATTN              ! FOR DISPLAYS                  22980000
AYM306F1 EQU   *                                                        23040000
         CLI   QCBCARCT,AVTEFF          CARRIAGE TO BE RETURNED         23100000
         BNE   AYM306D1                 BRANCH ON NO                    23160000
         TM    DCTBYTE1,DCT3270         3270 TERMINAL                   23220000
         BO    AYM306G1                 YES, BRANCH                     23280000
         LA    R2,15(,R2)               POINT TO PROPER MESSAGE         23340000
AYM306G1 EQU   *                                                        23400000
         MVI   QCBCARCT,AVTEZERO        RESET CARRIAGE COUNT            23460000
         NI    QCBRETCT,AVTEFF-QCBNL    RESET CARRIAGE FLAGS            23520000
AYM306D1 EQU   *                                                        23580000
         SR    R0,R0                    CLEAR REGISTER                  23640000
         IC    R0,AVTSCBSZ              SCB SIZE                        23700000
         SH    R0,NOTUSED               UNUSABLE PART OF SCB            23760000
         DROP  R1                                                       23820000
         LA    R1,SCBMBSSA              SCB DATA AREA ADDRESS           23880000
         TM    QCBTSOF2,QCBDSSMI        IS SMI BEING SENT               23940000
         BO    AYM2091                  BRANCH ON YES                   24000000
         LTR   R2,R2                    ONLY LEFT ADJUST                24060000
         BZ    AYM2201                  BRANCH ON YES                   24120000
         O     R1,JUSTIFY               LEFT JUSTIFICATION              24180000
         TM    0(R8),X01                IS MASK PRESENT                 24240000
         BO    AYM306E1                 BRANCH ON NO                    24300000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBXPI+SCBXPD             24360000
         BM    AYM209B1                 BRANCH ON YES                   24420000
AYM306E1 EQU   *                                                        24480000
         CLI   1(R2),XFE                NO LEFT ADJUST                  24540000
         BNE   AYM2081                  BRANCH YES                      24600000
         LA    R2,1(,R2)                SKIP FE FLAG                    24660000
         B     AYM2101                  BRANCH                          24720000
AYM2081  EQU   *                                                        24780000
         TM    0(R8),X01                IS MASK PRESENT                 24840000
         BO    AYM2201                  BRANCH ON NO                    24900000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBXPI+SCBXPD             24960000
         BZ    AYM2201                  BRANCH ON NO                    25020000
         B     AYM2101                  NO LEFT JUSTIFICATION           25080000
AYM2091  EQU   *                                                        25140000
         CLI   1(R2),ASTERISK           SIMATTN PROMPT                  25200000
         BE    AYM209A1                 BRANCH ON YES                   25260000
         O     R1,NOJUST                NO JUSTIFICATION                25320000
         B     AYM2201                  BRANCH                          25380000
AYM209A1 EQU   *                                                        25440000
         O     R1,JUSTIFY               LEFT JUSTIFICATION              25500000
         B     AYM2201                  BRANCH                          25560000
AYM209B1 EQU   *                                                        25620000
         TM    T3270+1,DCT3270          IS IT A 3270           @G36XRYP 25680000
         BO    AYM209C1                 IS A 3270 TERMINAL              25740000
         MVI   QCBCARCT,120             PRESET FOR MAX IDLES            25800000
AYM209C1 EQU   *                                                        25860000
         NI    QCBRETCT,AVTEFF-QCBNL    INDICATE NL/LF NOT SENT         25920000
AYM2101  EQU   *                                                        25980000
         X     R1,LEAVE                 NO LEFT JUSTIFICATION           26040000
         NC    0(4,R5),0(R5)            EBCD TRANSLATE TABLE            26100000
         BZ    AYM2201                  BRANCH ON YES                   26160000
         MVC   LCBCPA(1),1(R2)          MOVE BYTE TO WORK AREA          26220000
         L     R8,0(,R5)                GET ADDR OF TRANS TABLE         26280000
         TR    LCBCPA(1),0(R8)          TRANS TO LINE CODE              26340000
         TR    LCBCPA(1),4(R5)          TRANS TO EBCDIC                 26400000
         CLC   LCBCPA(1),1(R2)          EQUAL TO ORIGINAL               26460000
         BE    AYM2201                  BRANCH IF THE SAME              26520000
         MVC   SCBDESTL+1(4),2(R2)      MSG TO WORK AREA                26580000
         IC    R2,AVTEZERO(,R2)         GET LENGTH OF MESSAGE           26640000
         BCTR  R2,0                     REDUCE BY ONE                   26700000
         STC   R2,SCBDESTL              SET UP MESSAGE LENGTH           26760000
         LA    R2,SCBDESTL              ADDRESS OF MESSAGE              26820000
AYM2201  EQU   *                                                        26880000
         TM    TRMSTATE,TRMPREF         IS THERE A PREFIX               26940000
         BO    NCPSNA                   BRANCH YES, NCP OR SNA          27000000
         LR    R8,R5                    SAVE TABLE ADDRESS              27060000
         TM    T3270+1,DCT3270          3270 DEVICE            @G36XRYP 27120000
         BNO   GOEDIT                   BRANCH NO                       27180000
         O     R1,FRSTUNIT              SET FIRST MSGGEN                27240000
         B     EDIT3270                 EDIT 3270 DATA         @OY13623 27300000
AYM0181  EQU   *                                                        27360000
         L     R6,AVTMSGS-1             GET ADDRESS                     27420000
         L     R6,AVTEZERO(,R6)         IEDQBD                          27480000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        27540000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     27600000
         LA    R1,LCBERB                ELEMENT TO POST                 27660000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 27700000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 27750000
         EJECT                                                          27780000
AYM400   EQU   *                                                        27840000
         L     R1,SCBDESTQ-1            DESTINATION OF MSG              27900000
         LA    R1,AVTEZERO(,R1)         ZERO HIGH-ORDER BYTE            27960000
         LA    R2,AVTBFRTB              BUFFER RETURN QUEUE             28020000
         CR    R1,R2                    BUFFER TO RETURN                28080000
         BE    AYM4001                  BRANCH ON NO                    28140000
         XC    SCBERR1(4),SCBERR1       CLEAR ERROR BYTES               28200000
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE ERRORS              28260000
         NI    SCBSTATE,AVTEFF-SCBCODE  NO TRANSLATE REQUEST            28320000
         LA    R5,X0100                 SET UP FOR BUFFER DISP          28380000
         STCM  R5,7,SCBMACR             REMAINING INMSG/OUTMSG          28440000
         L     R6,AVTMSGS-1             GET ADDRESS                     28500000
         L     R6,AVTEZERO(,R6)         IEDQBD                          28560000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        28620000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     28680000
         LA    R1,LCBERB                ELEMENT TO POST                 28740000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 28780000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 28800000
AYM4001  EQU   *                                                        28860000
         L     R5,8(,R8)                ASSUME TABLE IN MACRO           28920000
         TM    2(R8),AVTE80             IS TRAN TABLE IN MACRO          28980000
         BZ    AYM1201                  BRANCH ON YES                   29040000
         L     R5,LCBDCBPT              DCB ADDRESS                     29100000
         L     R5,DCBTRANS-1-IHADCB(,R5) GET TRANLIST MACRO             29160000
         IC    R5,3(,R5)                NUMBER OF TABLES                29220000
         STC   R5,SCBMBSSA              SAVE COUNT                      29280000
AYM450   EQU   *                                                        29340000
         LH    R1,LCBLNENT              GET LINE ENTRY                  29400000
         CLI   LCBFLAG1,LCBPLCB         3705 RESOURCE?       @YM07750   29420000
         BE    GETTCIN                  USE LCBTTCIN         @YM07750   29440000
         TM    LCBSTAT2,LCBDIAL         IS THIS DIAL LINE               29460000
         BO    AYM450A                  BRANCH ON YES                   29520000
GETTCIN  EQU   *                                             @YM07750   29550000
         LH    R1,LCBTTCIN              GET CONNECTED INDEX             29580000
AYM450A  EQU   *                                                        29640000
         TM    SCBMBSSA,X'F0'           WAS LAST MSG INCOMPLETE@OZ26884 29642082
         BZ    AYM450B                  NO                     @OZ26884 29644082
         LA    R6,SCBMBSSA+1            DATA MOVE DESTINATION  @OZ26884 29646082
         L     R5,LCBDCBPT              DCB ADDRESS            @OZ26884 29648082
         L     R5,DCBTRANS-1-IHADCB(,R5) GET TRANSLIST MACRO   @OZ26884 29650082
         SR    R2,R2                    CLEAR REG              @OZ26884 29652082
         IC    R2,SCBMBSSA              GET NUMBER             @OZ26884 29654082
         SLR   R2,4                         OF STRINGS LEFT    @OZ26884 29656082
         NI    SCBMBSSA,X'0F'           ERASE STRING COUNT     @OZ26884 29658082
         SR    R9,R9                    CLEAR REG              @OZ26884 29660082
         IC    R9,3(,R5)                GET NO. OF TABLES      @OZ26884 29662082
         SLL   R9,2                     MULTIPLY BY FOUR       @OZ26884 29664082
         LA    R8,4(R5,R9)              GET ADDRESS OF STRING  @OZ26884 29666082
         IC    R9,2(,R5)                GET TOTAL STRING COUNT @OZ26884 29668082
         SR    R1,R1                    CLEAR  REG             @OZ26884 29670082
SKIPCHAR IC    R1,AVTEZERO(R8,R1)       GET STRING LENGTH      @OZ26884 29672082
         LA    R8,1(R8,R1)              POINT TO NEXT STRING   @OZ26884 29674082
         BCT   R9,0                     REDUCE COUNT           @OZ26884 29676082
         CR    R9,R2                    IS THIS CORRECT STRING @OZ26884 29678082
         BH    SKIPCHAR                 NO                     @OZ26884 29680082
         LA    R9,X'11'                 DATA LENGTH TO MOVE    @OZ26884 29682082
         EX    R9,MOVE                  MOVE REST OF DATA STRIN@OZ26884 29684082
         SR    R1,R1                    CLEAR DATA COUNT       @OZ26884 29686082
         B     AYM460                   DECIDE WHERE TO PUT    @OZ26884 29688082
*                                       NL AND IDLES           @OZ26884 29690082
AYM450B  EQU   *                                               @OZ26884 29692082
         N     R1,AVTCLRHI              CLEAR HIGH HALF                 29700000
         L     R15,AVTRNMPT             ADDRESS OF NAME ROUTINE         29760000
         BALR  R14,R15                  BRANCH AND LINK                 29820000
         LR    R9,R1                    SAVE TERMINAL ENTRY             29880000
         L     RQCB,TRMDESTQ-1          ADDRESS OF QCB                  29940000
         LA    R2,ENTER                 ADDRESS OF MSG TO SEND          30000000
         LA    R0,SCBTRANS-(SCBMBSSA+1) MAX SIZE MSGGEN IN SCB          30060000
         LA    R1,SCBMBSSA+1            LOCATION IN SCB                 30120000
         O     R1,NOJUST                NO LEFT JUSTIFICATION           30180000
         L     R15,AVTTSOPT             TSO QCB ADDRESS                 30240000
         L     R15,TSIEDIT-IEDQTSI(,R15) POINT TO IEDAYE                30300000
         BALR  R14,R15                  BRANCH TO AYE                   30360000
         LA    R6,SCBMBSSA+1(R1)        DATA MOVE DESTINATION           30420000
         LA    R9,X'2E'                 SAVE ROOM FOR NL & IDLE@OZ26884 30480082
         SR    R9,R1                    CALCULATE SIZE OF DATA          30540000
         L     R5,LCBDCBPT              DCB ADDRESS                     30600000
         L     R5,DCBTRANS-1-IHADCB(,R5) GET TRANLIST MACRO             30660000
         SR    R2,R2                                                    30720000
         IC    R2,3(,R5)                GET NUMBER OF TABLES            30780000
         SLL   R2,2                     MULTIPLY BY FOUR                30840000
         LA    R8,4(R5,R2)              GET ADDRESS OF CHARS            30900000
         BCTR  R9,0                     REDUCE BY ONE                   30960000
         EX    R9,MOVE                  MOVE CHARACTERS                 31020000
         SR    R2,R2                                                    31080000
         IC    R2,2(,R5)                GET NUMBER OF STRINGS           31140000
AYM460   EQU   *                                                        31200000
         IC    R9,AVTEZERO(,R6)         LENGTH OF STRING                31260000
         MVI   0(R6),BLANK              OVERLAY NUMBER                  31320000
         LA    R6,1(R6,R9)              UPDATE TO NEXT STRING           31380000
         LA    R1,1(R1,R9)              ADD LENGTH OF CHARACTER         31440000
         CLM   R1,1,TWOE                WAS DATA TRUNCATED     @OZ26884 31500082
         BNH   CKSTRNG                  NO, CONTINUE           @OZ26884 31510082
         SR    R1,R1                    CLEAR REG              @OZ26884 31520082
         IC    R1,SCBMBSSA              GET NO. TABLES LEFT    @OZ26884 31530082
         SLL   R2,4                     STR NO. IN HIGH ORDER  @OZ26884 31540082
         LA    R9,AVTEZERO(R1,R2)       COMBINE STR & TAB CNT  @OZ26884 31550082
         LR    R2,R1                    SAVE TABLE COUNT       @OZ26884 31560082
         LR    R1,R8                    GET LAST DATA LENGTH   @OZ26884 31570082
         SLL   R2,2                     SIZE OF EACH TABLE     @OZ26884 31580082
         LA    R8,AVTEZERO(R5,R2)       ADDRESS TABLE          @OZ26884 31590082
         B     AYM490                   SET UP TO RETURN       @OZ26884 31600082
CKSTRNG  LR    R8,R1                    SAVE DATA LENGTH       @OZ26884 31610082
         BCT   R2,AYM460                SEE IF MORE STRINGS    @OZ26884 31620082
         MVC   0(9,R6),NLIDLES          MOVE NL & IDLES        @OZ26884 31630082
         LA    R1,9(R1)                 AND COUNT THEM         @OZ26884 31640082
         IC    R2,SCBMBSSA              NUMBER OF TABLES LEFT           31740000
         LR    R9,R2                                                    31800000
AYM465   EQU   *                                                        31860000
         LR    R2,R9                                                    31920000
         SLL   R2,2                     SIZE OF EACH TABLE              31980000
         LA    R8,AVTEZERO(R5,R2)       ADDRESS TABLE                   32040000
         CLI   0(R8),X01                IS IT A 5041 LINE               32100000
         BL    AYM480                   BRANCH ON NO                    32160000
         BH    AYM470                   BRANCH IF 1050                  32220000
         TM    LCBTSOB,LCB2741N         IS IT A 2741                    32280000
         BO    AYM480                   BRANCH  ON YES                  32340000
         BCT   R9,AYM465                BRANCH IF MORE TABLES           32400000
         B     AYM475                   BRANCH IF NO MORE TABLE         32460000
AYM470   EQU   *                                                        32520000
         TM    LCBTSOB,LCB2741N         IS IT A 1050                    32580000
         BZ    AYM480                   BRANCH ON YES                   32640000
         BCT   R9,AYM465                BRANCH IF MORE TABLES           32700000
AYM475   EQU   *                                                        32760000
         STC   R9,SCBMBSSA              REINITIALIZE                    32820000
         NI    LCBTSOB,AVTEFF-LCBSATRD  SET BIT TO POST TO BD           32880000
         L     R6,AVTMSGS-1             GET ADDRESS                     32940000
         L     R6,AVTEZERO(,R6)         IEDQBD                          33000000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        33060000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     33120000
         LA    R1,LCBERB                ELEMENT TO POST                 33180000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 33200000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 33240000
AYM480   EQU   *                                                        33300000
         BCT   R9,AYM490                BRANCH IF MORE TABLES           33360000
         NI    LCBTSOB,AVTEFF-LCBSATRD  SET BIT TO POST TO BD           33420000
         LA    R9,X0100                 ADDRESS INMSG/OUTMSG            33480000
         STCM  R9,7,SCBMACR             SET MACRO ADDRESS               33540000
         B     AYM495                   BRANCH                          33600000
AYM490   EQU   *                                                        33660000
         OI    LCBTSOB,LCBSATRD         SET BIT TO POST TO AYM          33720000
AYM495   EQU   *                                                        33780000
         STC   R9,SCBMBSSA              RESET COUNT                     33840000
         L     R8,AVTEZERO(,R8)         GET ADDRESS OF TABLE            33900000
         BCTR  R1,0                     REDUCE FOR EXECUTE              33960000
         LA    R8,AVTEZERO(,R8)         CLEAR HIGH BYTE                 34020000
         LTR   R8,R8                    ADDR OF TRANS TABLE             34080000
         BZ    AYM496                   NO                              34140000
         USING AYMTRAN,R8                                               34200000
         L     R8,TRANSLAT              ADDRESS OF OUTPUT TABLE         34260000
         LTR   R8,R8                    ADDR                            34320000
         BZ    AYM496                   NO                              34380000
         EX    R1,ERRTRANS              TRANSLATE                       34440000
AYM496   EQU   *                                                        34500000
         LA    R6,SCBMBSSA+1            ADDRESS OF MESSAGE              34560000
         ST    R6,LCBCPA                PUT ADDRESS IN CCW              34620000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN FLAG                 34680000
         MVI   LCBCPA,CCWWRITE          SET WRITE OP CODE               34740000
         LA    R1,1(,R1)                ADJUST COUNT                    34800000
         ST    R1,LCBCPA+4              PUT LENGTH IN CCW               34860000
         LH    R6,LCBTTCIN              GET TERMINAL INDEX              34920000
         STH   R6,LCBTTBIN              SET FOR ACTIVATE                34980000
         SR    R6,R6                    CLEAR REGISTER                  35040000
         STH   R6,LCBTTCIN              CLEAR CURRENT CONNECTED         35100000
         STH   R6,LCBTPCD               SET TP OP CODES                 35160000
         MVI   LCBERBPY,PRIACTIV        PRIORITY                        35220000
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS         35280000
         BZ    AYM309A                  BRANCH IF NO                    35340000
         OI    LCBTSOB,LCBTSBUF         SET TSO BUFFER                  35400000
AYM309A  EQU   *                                                        35460000
         LA    R6,AVTACTIB              I/O GENERATOR QCB               35520000
         ST    R6,LCBERBQB-1            FOR POST                        35580000
         LA    R1,LCBERB                ELEMENT                         35640000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 35680000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 35700000
AYM1201  EQU   *                                                        35760000
         TM    1(R8),X0C                IS MASK PRESENT                 35820000
         BM    AYM2001                  BRANCH IF NOT                   35880000
         L     R5,12(,R8)               TRANSLATE TABLE ADDRESS         35940000
AYM2001  EQU   *                                                        36000000
         LA    R14,AYM225               EDIT RETURN ADDRESS             36060000
         LH    R1,LCBLNENT              GET LINE ENTRY                  36120000
         TM    LCBSTAT2,LCBDIAL         IS THIS A DIAL LINE             36180000
         BO    AYM2061                  BRANCH IF YES                   36240000
         LH    R1,LCBTTCIN              GET CONNECTED INDEX             36300000
AYM2061  EQU   *                                                        36360000
         N     R1,AVTCLRHI              CLEAR HIGH HALF                 36420000
         L     R15,AVTRNMPT             ADDRESS OF NAME ROUTINE         36480000
         LR    R9,R14                   SAVE RETURN ADDRESS             36540000
         BALR  R14,R15                  BRANCH                          36600000
         LR    R14,R9                   RESTORE RETURN ADDRESS          36660000
         LR    R9,R1                    SAVE TERM ENTRY ADDRESS         36720000
         L     RQCB,TRMDESTQ-1          ADDRESS OF QCB                  36780000
         LA    R1,TRMPRFSZ              PICK UP PREFIX SIZE             36840000
         DROP  R9                                                       36900000
         SR    R9,R1                    BACK UP TO PREFIX               36960000
         USING IEDNTRM,R9                                               37020000
         L     R15,AVTTSOPT             GET ADDR OF TSO QCB             37080000
*                                                                       37140000
*  MOVE THE DCT ENTRY FROM THE DCT TO THE TSO WORK AREA AND             37200000
*  SET THE DCT3270 BIT IF THE TTE IS AN LU TYPE 0,2, OR 3               37260000
*                                                                       37320000
   IEDDCT REG=R1,FLD=TSITSW-IEDQTSI+TSWDCT-IEDQTSW(R15),LEN=6           37380000
         DROP  R9                                                       37440000
         LA    R9,TRMPRFSZ(,R9)        INCREMENT PAST PREFIX            37500000
         USING IEDQTRM,R9                                               37560000
         USING IEDDCT,R1                DCT ADDRESSABILITY              37620000
         MVC   T3270+ONE(1),DCTBYTE1    MOVE DCT BYTE WITH              37680000
*                                       3270 BIT                        37740000
         TM    T3270+ONE,DCT3270        IS THIS A 3270 TERM             37800000
         BO    AYM306A                  YES,SKIP 2260 CKS               37860000
         TM    DCTBYTE3,DCTNOIDL        THIS 2260 REMOTE                37920000
         BO    AYM306A                  BRANCH ON YES                   37980000
         TM    DCTBYTE2,DCTLOCAL        THIS 2260 LOCAL                 38040000
         BNO   AYM306D                  BRANCH ON NO                    38100000
AYM306A  EQU   *                                                        38160000
         TM    0(R8),X01                IS MASK PRESENT                 38220000
         BO    AYM306D                  BRANCH ON NO                    38280000
         TM    SCBERR3-SCBERRST+3(R8),SCBXPI                            38340000
         BNO   AYM306B                  BRANCH ON NO                    38400000
         LA    R2,DISPXPI               !I FOR DISPLAYS                 38460000
         B     AYM306F                  BRANCH                          38520000
AYM306B  EQU   *                                                        38580000
         TM    SCBERR3-SCBERRST+3(R8),SCBXPD                            38640000
         BNO   AYM306C                  BRANCH ON NO                    38700000
         LA    R2,DISPXPD               !D FOR DISPLAYS                 38760000
         B     AYM306F                  BRANCH                          38820000
AYM306C  EQU   *                                                        38880000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBSATTN                  38940000
         BZ    AYM306D                  BRANCH ON NO                    39000000
         LA    R2,DISPATTN              ! FOR DISPLAYS                  39060000
AYM306F  EQU   *                                                        39120000
         CLI   QCBCARCT,AVTEFF          CARRIAGE TO BE RETURNED         39180000
         BNE   AYM306D                  BRANCH ON NO                    39240000
         TM    1(R1),C3270              IS THIS A 3270 TERMINAL         39300000
         BO    AYM306G                  YES, BRANCH                     39360000
         LA    R2,15(,R2)               POINT TO PROPER MESSAGE         39420000
AYM306G  EQU   *                                                        39480000
         MVI   QCBCARCT,AVTEZERO        RESET CARRIAGE COUNT            39540000
         NI    QCBRETCT,AVTEFF-QCBNL    RESET CARRIAGE FLAGS            39600000
AYM306D  EQU   *                                                        39660000
         SR    R0,R0                    CLEAR REGISTER                  39720000
         IC    R0,AVTSCBSZ              SCB SIZE                        39780000
         SH    R0,NOTUSED               UNUSABLE PART OF SCB            39840000
         LA    R1,SCBMBSSA              SCB DATA AREA ADDRESS           39900000
         TM    QCBTSOF2,QCBDSSMI        IS SMI BEING SENT               39960000
         BO    AYM209                   BRANCH ON YES                   40020000
         LTR   R2,R2                    LEFT ADJUST REQUESTED           40080000
         BZ    AYM220                   BRANCH ON YES                   40140000
         O     R1,JUSTIFY               LEFT JUSTIFICATION              40200000
         TM    0(R8),X01                IS MASK PRESENT                 40260000
         BO    AYM306E                  BRANCH ON NO                    40320000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBXPI+SCBXPD             40380000
         BM    AYM209B                  BRANCH ON YES                   40440000
AYM306E  EQU   *                                                        40500000
         CLI   1(R2),XFE                NO LEFT ADJUST                  40560000
         BNE   AYM208                   BRANCH YES                      40620000
         LA    R2,1(,R2)                SKIP FE FLAG                    40680000
         B     AYM210                   BRANCH                          40740000
AYM208   EQU   *                                                        40800000
         TM    0(R8),X01                IS MASK PRESENT                 40860000
         BO    AYM220                   BRANCH ON NO                    40920000
         TM    SCBERR3-SCBERRST+3(R8),SCBATTN+SCBXPI+SCBXPD             40980000
         BZ    AYM220                   BRANCH ON NO                    41040000
         B     AYM210                   NO LEFT JUSTIFICATION           41100000
AYM209   EQU   *                                                        41160000
         CLI   1(R2),ASTERISK           SIMATTN PROMPT                  41220000
         BE    AYM209A                  BRANCH ON YES                   41280000
         O     R1,NOJUST                NO JUSTIFICATION                41340000
         B     AYM220                   BRANCH                          41400000
AYM209A  EQU   *                                                        41460000
         O     R1,JUSTIFY               LEFT JUSTIFICATION              41520000
         B     AYM220                   BRANCH                          41580000
AYM209B  EQU   *                                                        41640000
         TM    T3270+1,DCT3270          IS IT A 3270           @G36XRYP 41700000
         BO    AYM209C                  IS A 3270 TERMINAL              41760000
         MVI   QCBCARCT,120             PRESET FOR MAX IDLES            41820000
AYM209C  EQU   *                                                        41880000
         NI    QCBRETCT,AVTEFF-QCBNL    INDIC  NL/LF NOT SENT           41940000
AYM210   EQU   *                                                        42000000
         X     R1,LEAVE                 NO LEFT JUSTIFICATION           42060000
         NC    0(4,R5),0(R5)            EBCD TRANSLATE TABLE            42120000
         BZ    AYM220                   BRANCH ON YES                   42180000
         MVC   LCBCPA(1),1(R2)          MOVE BYTE TO WORK AREA          42240000
         L     R8,AVTEZERO(,R5)         GET ADDR OF TRANS TABLE         42300000
         TR    LCBCPA(1),0(R8)          TRANS TO LINE CODE              42360000
         TR    LCBCPA(1),4(R5)          TRANS TO EBCDIC                 42420000
         CLC   LCBCPA(1),1(R2)          CHARACTERS EQUAL                42480000
         BE    AYM220                   BRANCH IF THE SAME              42540000
         MVC   SCBDESTL+1(4),2(R2)      MSG TO WORK AREA                42600000
         IC    R2,AVTEZERO(,R2)         GET LENGTH OF MESSAGE           42660000
         BCTR  R2,0                     REDUCE BY ONE                   42720000
         STC   R2,SCBDESTL              SET UP MESSAGE LENGTH           42780000
         LA    R2,SCBDESTL              ADDRESS OF MESSAGE              42840000
AYM220   EQU   *                                                        42900000
         TM    TRMSTATE,TRMPREF         IS TERMINAL VIA 3705            42960000
         BO    NCPSNA                   BRANCH YES                      43020000
         LR    R8,R5                    SAVE TABLE ADDRESS              43080000
         TM    T3270+1,DCT3270          3270 DEVICE            @G36XRYP 43140000
         BNO   GOEDIT                   BRANCH NO                       43200000
         O     R1,FRSTUNIT              SET FIRST MSGGEN                43260000
         B     EDIT3270                 EDIT 3270 DATA         @OY13623 43320000
         EJECT                                                          43380000
AYM300   EQU   *                                                        43440000
         LH    R1,LCBTTCIN              GET TERMINAL INDEX              43500000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER BYTES          43560000
         L     R15,AVTRNMPT             TERMINAL NAME ROUTINE           43620000
         BALR  R14,R15                  LINK TO ROUTINE                 43680000
         LR    R9,R1                    TERM ENTRY ADDRESS              43740000
         L     RQCB,TRMDESTQ-1          GET ADDRESS OF DEST QCB         43800000
         TM    TRMDEVFL,ADDRCHAR        ARE ADDR CHARS PRESENT          43860000
         BNO   AYM302                   BRANCH ON NO                    43920000
         LA    R5,2                     NUMBER OF BITS TO CHECK         43980000
         LR    R2,R5                    SAME IN REG 2                   44040000
         LA    R6,AVTE80                MASK FOR EXECUTED TM            44100000
AYM304   EQU   *                                                        44160000
         EX    R6,TEST                  EXECUTE TEST UNDER MASK         44220000
         BO    AYM305                   BRANCH IF BIT ON                44280000
         BCTR  R5,0                     REDUCE BIT COUNT                44340000
AYM305   EQU   *                                                        44400000
         SRL   R6,1                     SHIFT MASK RIGHT ONE            44460000
         BCT   R2,AYM304                BRANCH IF NOT ALL CHECK         44520000
         LA    R6,TRMOPNO               ADDRESS OF OPTIONS              44580000
         SR    R2,R2                    CLEAR REGISTER                  44640000
         TM    TRMSTATE,TRMOPTFN        ARE OPTIONS PRESENT             44700000
         BNO   AYM301                   BRANCH ON NO                    44760000
         IC    R2,TRMOPNO               NUMBER OF OPTIONS               44820000
         LA    R6,3(R2,R6)              BUMP PAST OPTION FIELD          44880000
AYM301   EQU   *                                                        44940000
         LTR   R5,R5                    ANY BITS ON IN TRMDEVFL         45000000
         BZ    AYM307                   BRANCH ON NO                    45060000
AYM306   EQU   *                                                        45120000
         IC    R2,AVTEZERO(,R6)         FIELD LENGTH                    45180000
         LA    R6,1(R2,R6)              BUMP PAST FIELD                 45240000
         BCT   R5,AYM306                BRANCH IF MORE TO SKIP          45300000
AYM307   EQU   *                                                        45360000
         LR    R2,R6                    SAVE ADDRESS                    45420000
         CLI   0(R2),X03                IS NUMBER OF CHARS 3            45480000
         BE    AYM302                   YES, BRANCH                     45540000
         CLI   0(R2),X05                IS NUMBER OF CHARS 5            45600000
         BE    AYM302                   YES, BRANCH                     45660000
         CLI   0(R2),X04                IS NUMBER OF CHARS 4            45720000
         BNE   AYM1604                  NO, BRANCH                      45780000
         CLI   4(R2),AVTEFF             CONTROL CHAR FOR 2260           45840000
         BE    AYM302                   YES, BRANCH                     45900000
AYM1604  EQU   *                                                        45960000
         XC    SCBERR1(4),SCBERR1       CLEAR ERROR BYTES               46020000
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE ERRORS              46080000
         NI    SCBSTATE,AVTEFF-SCBCODE  NO TRANSLATION                  46140000
         LA    R5,X0100                 SET UP FOR BUFFER DISP          46200000
         STCM  R5,7,SCBMACR             REMAINING INMSG/OUTMSG          46260000
         L     R6,AVTMSGS-1             GET ADDRESS                     46320000
         L     R6,AVTEZERO(,R6)         IEDQBD                          46380000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        46440000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     46500000
         LA    R1,LCBERB                ELEMENT TO POST                 46560000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 46580000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 46600000
AYM302   EQU   *                                                        46680000
         LA    R1,TRMPRFSZ              PICK UP PREFIX SIZE             46740000
         DROP  R9                                                       46800000
         SR    R9,R1                    BACK UP TO PREFIX               46860000
         USING IEDNTRM,R9                                               46920000
         L     R1,AVTTSOPT              GET ADDR OF TSO QCB             46980000
*                                                                       47040000
*  MOVE THE DCT ENTRY FROM THE DCT TO THE TSO WORK AREA AND             47100000
*  SET THE DCT3270 BIT IF THE TTE IS AN LU TYPE 0,2, OR 3               47160000
*                                                                       47220000
   IEDDCT REG=R5,FLD=TSITSW-IEDQTSI+TSWDCT-IEDQTSW(R1),LEN=6            47280000
         DROP  R9                                                       47340000
         LA    R9,TRMPRFSZ(,R9)        INCREMENT PAST PREFIX            47400000
         USING IEDQTRM,R9                                               47460000
         USING IEDDCT,R5                DCT ADDRESSABILITY              47520000
         TM    DCTBYTE2,DCTLOCAL        IS IT A LOCAL DEVICE            47580000
         BO    AYM308                   BRANCH ON YES                   47640000
         TM    DCTBYTE3,DCTNOIDL        IS IT 2260 REMOTE               47700000
         BNO   AYM310                   BRANCH ON NO                    47760000
         MVC   SCBMBSSA(2),STXETX       MOVE MESSAGE TO SCB             47820000
         LA    R1,1                     SET UP COUNT                    47880000
         OI    3(R2),ERASE              SET TO ERASE                    47940000
         OI    LCBTSOB,LCBSATRD         SET POST TO AYM                 48000000
         NI    SCBSTATE,AVTEFF-SCBERSDS RESET ERASE REQUEST             48060000
         B     AYM230                   SEND MESSAGE                    48120000
AYM308   EQU   *                                                        48180000
         LA    R6,SCBSRCE               GET DATA ADDRESS                48240000
         ST    R6,LCBCPA                STORE IN CCW                    48300000
         TM    DCTBYTE1,DCT3270         IS THIS A 3270 TERMINAL         48360000
         BO    AYM308A                  YES, SET TO ERASE               48420000
         MVI   LCBCPA,X07               SET TO ERASE                    48480000
AYM308B  EQU   *                                                        48540000
         LA    R1,1                     SET COUNT                       48600000
         ST    R1,LCBCPA+4              STORE IN CCW                    48660000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN                      48720000
         OI    LCBTSOB,LCBSATRD         SET POST BACK TO AYM            48780000
         NI    SCBSTATE,AVTEFF-SCBERSDS RESET ERASE REQUEST             48840000
         B     AYM309                   BRANCH                          48900000
AYM308A  EQU   *                                                        48960000
         MVC   SCBMBSSA(1),ERASELOC     MOVE MESSAGE TO SCB             49020000
         LA    R6,SCBMBSSA              GET DATA ADDRESS                49080000
         ST    R6,LCBCPA                PUT ADDRESS IN CCW              49140000
         MVI   LCBCPA,ERASECOM          SET TO ERASE 3270 LOCAL         49200000
         OI    QCBRETCT,QCBIEND         SET QCBIEND ON FOR              49260000
*                                       SCREEN FORMAT ON OUTPUT         49320000
         B     AYM308B                  BRANCH TO COMPLETE              49380000
AYM310   EQU   *                                                        49440000
         MVC   T3270(1),DCTBYTE1        MOVE 3270                       49500000
         MVC   T3270+ONE(1),DCTBYTE1    INDICATORS                      49560000
         TM    T3270,DCT3270            IS THIS A 3270 ERASE            49620000
         BO    AYM1609                  BRANCH YES                      49680000
         XC    SCBERR1(4),SCBERR1       CLEAR ERROR BYTES               49740000
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE ERRORS              49800000
         NI    SCBSTATE,AVTEFF-SCBCODE  NO TRANSLATE REQUEST            49860000
         LA    R5,X0100                 SET UP FOR BUFFER DISP          49920000
         STCM  R5,7,SCBMACR             REMAINING INMSG/OUTMSG          49980000
         L     R6,AVTMSGS-1             GET ADDRESS                     50040000
         L     R6,AVTEZERO(,R6)         IEDQBD                          50100000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        50160000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     50220000
         LA    R1,LCBERB                ELEMENT TO POST                 50280000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 50340000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 50380000
AYM1609  EQU   *                                                        50400000
         TM    TRMSTATE,TRMPREF         IS TERMINAL VIA 3705            50460000
         BO    NCPSNA                   GO GET BUFFERS                  50520000
         MVC   SCBMBSSA(5),ERASEREM     MOVE MESSAGE TO SCB             50580000
         LA    R1,5                     SET DATA COUNT                  50640000
         DROP  R5                                                       50700000
         L     R5,LCBDCBPT              GET DCB ADDR                    50760000
         L     R5,DCBTRANS-1-IHADCB(,R5)  TRANSLATE TABLE               50820000
         OI    LCBTSOB,LCBSATRD                                         50880000
         NI    SCBSTATE,AVTEFF-SCBERSDS RESET ERASE REQUESTED           50940000
         OI    QCBRETCT,QCBIEND         SET QCBIEND ON                  51000000
         LA    R5,AVTEZERO(,R5)         CLEAR HIGH BYTE                 51060000
         LTR   R8,R5                    ADDR OF TRANS TABLE             51120000
         BZ    AYM230                   NO                              51180000
         LTR   R1,R1                    ANYTHING TO TRANSLATE           51240000
         BZ    AYM0183                  BRANCH NO                       51300000
         BCTR  R1,0                     REDUCE BY ONE                   51360000
         USING AYMTRAN,R8                                               51420000
         L     R8,TRANSLAT              ADDRESS OUTPUT TABLE            51480000
         LTR   R8,R8                    ADDR                            51540000
         BZ    AYM230                   NO                              51600000
         EX    R1,AYMTRANS              TRANSLATE                       51660000
AYM230   EQU   *                                                        51720000
         LA    R6,SCBMBSSA                                              51780000
         ST    R6,LCBCPA                PUT ADDRESS IN CCW              51840000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN FLAG                 51900000
         MVI   LCBCPA,CCWWRITE          SET WRITE OP CODE               51960000
         LA    R1,1(,R1)                ADJUST COUNT                    52020000
         ST    R1,LCBCPA+4              PUT LENGTH IN CCW               52080000
AYM309   EQU   *                                                        52140000
         LH    R6,LCBTTCIN              GET TERMINAL INDEX              52200000
         STH   R6,LCBTTBIN              SET FOR ACTIVATE                52260000
         SR    R6,R6                    CLEAR REGISTER                  52320000
         STH   R6,LCBTTCIN              CLEAR CURRENT CONNECTED         52380000
         STH   R6,LCBTPCD               SET TP OP CODES                 52440000
         MVI   LCBERBPY,PRIACTIV        PRIORITY                        52500000
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS         52560000
         BZ    AYM309A4                 BRANCH IF NO                    52620000
         OI    LCBTSOB,LCBTSBUF         SET TSO BUFFER                  52680000
AYM309A4 EQU   *                                                        52740000
         LA    R6,AVTACTIB              I/O GENERATOR QCB               52800000
         ST    R6,LCBERBQB-1            FOR POST                        52860000
         LA    R1,LCBERB                ELEMENT                         52920000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 52940000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 52960000
AYM0183  EQU   *                                                        53040000
         L     R6,AVTMSGS-1             GET ADDRESS                     53100000
         L     R6,AVTEZERO(,R6)         IEDQBD                          53160000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        53220000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     53280000
         LA    R1,LCBERB                ELEMENT TO POST                 53340000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 53380000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 53400000
         EJECT                                                          53460000
EDIT3270 EQU   *                  @OY13623                              53462000
         BAL   R14,SETGMAIN             INITIALIZE WORK AREA   @OY13623 53464000
         L     R15,AVTTSOPT             ADDR OF TIME SHARING   @OY13623 53466000
         L     R15,TSI3270-IEDQTSI(,R15) ADDR OF 3270 EDIT     @OY13623 53468000
         BALR  R14,R15                  GO TO IEDAYQ TO EDIT   @OY13623 53470000
         LR    R1,R15                   GET LENGTH OF DATA MOVE@OY13623 53472000
         SRL   R1,SHFT2BYT              GET LENGTH IN LOW HALF @OY13623 53474000
         B     AYM225                   CONTINUE NORMAL PROCESS@OY13623 53478000
         EJECT                                                          53480000
GOEDIT   EQU   *                        BRANCH TO EDIT                  53520000
         L     R15,AVTTSOPT             ADDRESS OF TIME SHARING         53580000
         L     R15,TSIEDIT-IEDQTSI(,R15) ADDRESS OF EDIT                53640000
         BALR  R14,R15                  BRANCH TO IEDAYE                53700000
AYM225   EQU   *                                                        53760000
         LA    R5,AVTEZERO(,R5)         CLEAR HIGH BYTE                 53820000
         LTR   R8,R5                    ADDRESS TRANSLATE TABLE         53880000
         BZ    AYM2303                  NO                              53940000
         LTR   R1,R1                    ANYTHING TO TRANSLATE           54000000
         BZ    AYM0184                  BRANCH NO                       54060000
         BCTR  R1,0                     REDUCE BY ONE                   54120000
         USING AYMTRAN,R8                                               54180000
         L     R8,TRANSLAT              ADDRESS OUTPUT TABLE            54240000
         LTR   R8,R8                    ADDRESS PRESENT                 54300000
         BZ    AYM2303                  NO                              54360000
         EX    R1,AYMTRANS              TRANSLATE                       54420000
AYM2303  EQU   *                                                        54480000
         LA    R6,SCBMBSSA                                              54540000
         ST    R6,LCBCPA                PUT ADDRESS IN CCW              54600000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN FLAG                 54660000
         MVI   LCBCPA,CCWWRITE          SET WRITE OP CODE               54720000
         LA    R1,1(,R1)                ADJUST COUNT                    54780000
         ST    R1,LCBCPA+4              PUT LENGTH IN CCW               54840000
         LH    R6,LCBTTCIN              GET TERMINAL INDEX              54900000
         STH   R6,LCBTTBIN              SET FOR ACTIVATE                54960000
         SR    R6,R6                    CLEAR REGISTER                  55020000
         STH   R6,LCBTTCIN              CLEAR CURRENT CONNECTED         55080000
         STH   R6,LCBTPCD               SET TP OP CODES                 55140000
         MVI   LCBERBPY,PRIACTIV        PRIORITY                        55200000
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS         55260000
         BZ    AYM309A3                 BRANCH IF NO                    55320000
         OI    LCBTSOB,LCBTSBUF         SET TSO BUFFER                  55380000
AYM309A3 EQU   *                                                        55440000
         LA    R6,AVTACTIB              IO GENERATOR QCB                55500000
         ST    R6,LCBERBQB-1            FOR POST                        55560000
         LA    R1,LCBERB                OF                              55620000
         L     R11,AVTEA                GET DISPATCHER ADDR    @OY13623 55640000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 55680000
AYM0184  EQU   *                                                        55740000
         L     R6,AVTMSGS-1             GET ADDRESS                     55800000
         L     R6,AVTEZERO(,R6)         IEDQBD                          55860000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        55920000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     55980000
         LA    R1,LCBERB                ELEMENT TO POST                 56040000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 56080000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 56120000
         EJECT                                                          56160000
**************************************************************          56220000
*                                                                       56280000
*        TERMINALS ATTACHED VIA NCP AND SNA TERMINALS ARE               56340000
*        PROCESSED HERE. TRM ADDRESSABILITY IS SET UP TO                56400000
*        THE PREFIX.                                                    56460000
*                                                                       56520000
**************************************************************          56580000
NCPSNA   EQU   *                        CHECK FOR ERASE OF LU           56640000
         DROP  R9                       RELEASE TRM REG                 56700000
         LH    R1,LCBTTCIN              GET THE TTCIN                   56760000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF           56820000
         L     R15,AVTRNMPT             GET TNT CONVERT RTN             56880000
         BALR  R14,R15                  GET THE TERMINAL ADDR           56940000
         LR    R9,R1                    EST. ADDRESSABILITY             57000000
         LA    R1,TRMPRFSZ              GET PREFIX LENGTH               57060000
         SR    R9,R1                    BACKUP TO THE PREFIX            57120000
         USING IEDNTRM,R9               EST. ADDRESSABILITY             57180000
         TM    TRMBYTE0,TRMSNA          SNA RESOURCE?                   57240000
         BO    TSOSNA                   YES,CHK SNA DEPENDENCY          57300000
         TM    TRMBYTE0,TRMDIAL         DIAL?                           57360000
         BZ    NONDIAL                  DIAL FALL THRU                  57420000
         TM    TRMPRE1,TRMSESSN         IN NCP SESSION?                 57480000
         BZ    AYM160A                  CAN'T SEND MSGGEN               57540000
NONDIAL  EQU   *                                                        57600000
         TM    TRMPRE1,TRMOCNI          STOP IN PROGRESS       @OY15597 57630000
         BZ    CHKSTPND                 BR NO                  @OY15597 57660000
         TM    TRMPRE,TRMSTMM           STOPLINE,I             @OY15597 57690000
         BO    AYM160A                  BR YES                 @OY15597 57720000
CHKSTPND EQU   *                                               @OY15597 57750000
         TM    TRMPRE,TRMSTPND          IS STATUS PENDING               57780000
         BO    AYM160A                  BRANCH YES                      57840000
         CLI   TRMTYPE,TRMCLUST         IF A CLUSTER                    57900000
         BE    AYM160A                  DON'T SEND THE MSGGEN           57960000
         B     CKBFR                    SEND MSGGEN                     58020000
TSOSNA   EQU   *                                                        58080000
         USING IEDGENDS,R8                                     @YM06037 58140000
         L     R1,4(R8)                 ASSUME NO MASK         @YM06037 58200000
*                                       GET MESSAGE ADDRESS    @YM06037 58260000
         TM    GENFLAGS,GENNOMSG        WAS MSG DATA CODED     @YM06037 58320000
         BZ    HAVEMSG                  BRANCH MSG CODED       @YM06037 58380000
         OI    LOCSWTCH,GENNOMSG        SET LOCAL NOMSG SWITCH @YM06037 58440000
HAVEMSG  EQU   *                                               @YM06037 58500000
         TM    GENLNGTH,TWELVE          WAS A MASK CODED       @YM06995 58560000
         BZ    CKSES                    SEND MSGGEN            @YM06995 58620000
         BM    HAVEDATA                 DATA WAS               @YM06635 58680000
         L     R1,8(R8)                 GET MESSAGE ADDRESS    @YM06635 58740000
HAVEDATA EQU   *                                               @YM06635 58800000
         CLC   0(L'X01FF,R1),X01FF      THIS LAST MSGGEN       @YM06635 58860000
         BNE   CKSES                    BRANCH NOT LAST        @YM06635 58920000
         TM    AVTBIT3,AVTTSAB          IS TSO ABENDING        @YM06635 58980000
         BO    CKSES                    BRANCH YES CK SESSION  @YM06635 59040000
         TM    QCBFLAG,QCBTSSES         IS TERM IN TSO SESSION @YM06635 59100000
         BZ    CKSES                    BRANCH NO CK SESSION   @YM06635 59160000
         TM    T3270,DCT3270            3270 ERASE             @OY16109 59170000
         BO    CKSES                    BR YES                 @OY16109 59180000
         L     R1,CVTPTR                GET CVT ADDRESS        @G36XRYP 59190000
         L     R1,CVTASVT-CVT(R1)       GET ASVT ADDRESS       @G36XRYP 59220600
         LA    R1,ASVTENTY-ASVT(R1)     GET ASCB LIST ADDRESS  @G36XRYP 59221200
         LH    R14,QCBTJID              GET ASID               @G36XRYP 59221800
         BCTR  R14,0                    DECREMENT FOR ZERO     @G36XRYP 59222400
*                                       ORIGIN                 @G36XRYP 59223000
         SLL   R14,2                    MULTIPLY BY 4          @G36XRYP 59223600
         L     R1,AVTEZERO(R1,R14)      GET ASCB ADDRESS       @G36XRYP 59224200
         L     R14,ASCBTSB-ASCB(R1)     GET TSB ADDRESS        @G36XRYP 59224800
         TM    TSBFLG2-TSB(R14),TSBBRKIN  IS THIS INPUT FROM   @YM06635 59760000
*                                       A BREAKIN              @YM06635 59820000
         BO    AYM160A                  YES DON'T SEND NEW LINE@YM06635 59880000
*                                       UNTIL TPUT BRK DATA    @YM06635 59940000
*                                       IS SENT                @YM06635 60000000
CKSES    EQU   *                                               @YM06635 60060000
         SR    R1,R1                    CLEAR                           60120000
         ICM   R1,7,TRMSIBPT            GET THE SIB POINTER             60180000
         LTR   R1,R1                    SIB POINTER?                    60240000
         BZ    AYM160A                  NO, GET OUT                     60300000
         TM    SIBSESSN-IEDSIBD(R1),SIBDAPND+SIBDRPND DATA TRAFFIC      60360000
*                                       ACTIVE?                         60420000
         BO    CKBFR                    SEND MSGGEN                     60480000
AYM160A  EQU   *                                                        60540000
         XC    SCBERR1(4),SCBERR1       CLEAR ERROR BYTES               60600000
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE ERRORS              60660000
         NI    SCBSTATE,AVTEFF-SCBCODE  NO TRANSLATE REQUEST            60720000
         LA    R5,X0100                 SET UP FOR BUFFER DISP          60780000
         STCM  R5,7,SCBMACR             REMAINING INMSG/OUTMSG          60840000
         L     R6,AVTMSGS-1             GET ADDRESS                     60900000
         L     R6,AVTEZERO(,R6)         IEDQBD                          60960000
         MVI   LCBERBPY,PRIRCQCB        PRIORITY                        61020000
         ST    R6,LCBERBQB-1            QCB ADDRESS                     61080000
         LA    R1,LCBERB                ELEMENT TO POST                 61140000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 61170000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 61210000
         EJECT                                                          61260000
CKBFR    EQU   *                                                        61320000
         NC    LCBERBCH,LCBERBCH        BUFFER ASSIGNED?                61380000
         BNZ   RCVDBFR                  YES, GO SEND MSGGEN             61440000
         BAL   R14,GETBFR               GO GET A BUFFER                 61500000
         STCM  R15,SEVEN,LCBERBCH       PUT BFR REC'D ON CHAIN          61560000
*                                       ERROR LOCK TO IEDQNKA           61620000
**************************************************************          61680000
*                                                                       61740000
*        USE THE UNITS ON THE ERB CHAIN TO SEND THE MSGGEN              61800000
*                                                                       61860000
**************************************************************          61920000
RCVDBFR  EQU   *                                                        61980000
         ICM   R10,SEVEN,LCBERBCH       GET ADDRESS OF FIRST            62040000
*                                       UNIT OF BUFFER                  62100000
*                                       FOR NIR GENERATOR               62160000
         USING IEDQPRF,R10              BFR ADDRESSABILITY              62220000
         BAL   R14,BLDPRF               GO BUILD BUFFER PREFIX          62280000
         USING IEDNSVTD,R8              SAVT ADDRESSABILITY             62340000
         L     R8,AVTSAVTP              GET THE ADDRESS OF THE          62400000
*                                       SECONDARY AVT                   62460000
         MVC   LCBERBQB(THREE),SAVTDNIR+ONE  SET QCB ADDRESS            62520000
*                                       TO DATA NIR GENERATOR           62580000
         MVI   LCBERBPY,PRIOUTBD        SET POST PRIORITY               62640000
         TM    LOCSWTCH,GENNOMSG        IS THIS A RH ONLY      @YM06995 62700000
*                                       MSGGEN                 @YM06995 62760000
         BZ    CKERSE                   NO CK FOR ERASE        @YM06995 62820000
**************************************************************          62880000
*                                                                       62940000
*        PROCESS A MSSGEN THAT HAD ONLY A RH CODED.                     63000000
*        FOR SNA 3270 NULL RU CANNOT BE SENT, SEND A WRITE              63060000
*        NULL.                                                          63120000
*                                                                       63180000
**************************************************************          63240000
         TM    TRMBYTE0,TRMSNA          IS THIS SNA TERMINAL   @YM06995 63300000
         BZ    CKERSE                   NO CK FOR ERASE        @YM06995 63360000
         TM    T3270+ONE,DCT3270        IS THIS SNA 3270       @YM06995 63420000
         BNO   EDIT                     EDIT                   @YM06995 63480000
         MVC   PRFSHDR(TWO),WRNUL       MOVE WRITE COMMAND     @YM06995 63540000
         LA    R15,TWO                  INDICATE TWO BYTES OF  @YM06995 63600000
*                                       TEXT MOVED             @YM06995 63660000
         B     ALLUSED                                         @YM06995 63720000
CKERSE   EQU   *                                               @YM06995 63780000
         TM    T3270,DCT3270            IS THIS A 3270 ERASE            63840000
         BNO   EDIT                     NO,GO TO TSO OUTPUT             63900000
*                                       EDIT                            63960000
**************************************************************          64020000
*                                                                       64080000
*        MOVE THE PROPER ERASE COMMAND SEQUENCE TO THE                  64140000
*        BUFFER                                                         64200000
*                                                                       64260000
**************************************************************          64320000
         MVC   PRFSHDR(THREE),ERAS3270  MOVE ERASE COMMAND TO           64380000
*                                       BUFFER                          64440000
         LA    R15,THREE                INDICATE THREE BYTES            64500000
*                                       OF TEXT MOVED                   64560000
         OI    QCBRETCT,QCBIEND         INDICATE THAT THE               64620000
*                                       SCREEN REQUIRES                 64680000
*                                       FORMATTING BEFORE NEXT          64740000
*                                       OUTPUT                          64800000
         OI    LCBTSOB,LCBSATRD         INDICATE SIMATTN READ           64860000
*                                       IN PROGRESS SO DEBLOCK          64920000
*                                       WILL POST ERB BACK TO           64980000
*                                       IEDAYM TO SEND THE              65040000
*                                       MSGGEN AFTER THE ERASE          65100000
         NI    SCBSTATE,AVTEFF-SCBERSDS  INDICATE ERASE NO              65160000
*                                       LONGER REQUIRED                 65220000
         B     ALLUSED                  GO POST ERASE BUFFER            65280000
*                                       TO DATA NIR GENERATOR           65340000
VEDIT    DC    A(EDIT)                  EDIT SUBROUTINE        @OY13623 65360000
         EJECT                                                          65400000
**************************************************************          65460000
*                                                                       65520000
*        USE THE TSO OUTPUT EDITOR TO EDIT THE MSGGEN A UNIT            65580000
*        AT A TIME. CONTINUE EDITING UNTIL ALL OF THE MSGGEN            65640000
*        HAS BEEN EDITED (RETURN CODE= 0, TOTAL COUNT OF TEXT           65700000
*        MOVED IN THE HI-ORDER 2 BYTES OF REG 15.                       65760000
*                                                                       65820000
**************************************************************          65880000
EDIT     EQU   *                                                        65940000
         TM    T3270+ONE,DCT3270        IS THIS 3270           @OY13623 65960000
         BO    EDITBFR                  EDIT ENTIRE BFR        @OY13623 65980000
         LA    R1,PRFSHDR               GET THE ADDRESS TO              66000000
*                                       THE TEXT IN THE FIRST           66060000
*                                       UNIT                            66120000
         O     R1,FRSTUNIT              INDICATE TO TSO OUTPUT          66180000
*                                       EDIT THIS FIRST UNIT            66240000
         MVI   PRFNBUNT,ONE             SET UNIT COUNT TO ONE           66300000
EDITLOOP EQU   *                        CONTINUE EDIT                   66360000
         SR    R0,R0                    INDICATE TO TSO OUTPUT          66420000
*                                       BUFFER IS TO BE USED            66480000
         L     R15,AVTTSOPT             GET ADDRESS OF TSINPUT          66540000
*                                       QCB                             66600000
         USING IEDQTSI,R15              TSINPUT QCB                     66660000
*                                       ADDRESSABILITY                  66720000
         L     R15,TSIEDIT              GET ADDRESS OF TSO              66780000
*                                       OUTPUT EDIT                     66840000
         BALR  R14,R15                  GO EDIT THE TEXT                66900000
**************************************************************          66960000
*                                                                       67020000
*        RETURN FROM THE TSO OUTPUT EDITOR                              67080000
* REG 15 **************************************************             67140000
*        *  TOTAL COUNT         *       RETURN            *             67200000
*        *  DATA MOVED          *        CODE             *             67260000
*        **************************************************             67320000
* RETURN CODE    0 = EDIT COMPLETE                                      67380000
*             X'C' = GET ANOTHER UNIT FOR EDIT                          67440000
**************************************************************          67500000
         CLM   R15,THREE,AVTFZERO       WAS EDIT COMPLETED              67560000
         BE    FREEUNIT                 YES,GO FREE ANY UNUSED          67620000
*                                       UNITS AND POST TO DATA          67680000
*                                       NIR GENERATOR                   67740000
         EJECT                                                          67800000
**************************************************************          67860000
*                                                                       67920000
*        GET THE ADDRESS OF THE NEXT UNIT TO BE EDITED,                 67980000
*        SAVE IT AS THE CURRENT UNIT BEING EDITED, AND                  68040000
*        INCREMENT PRFNBUNT TO INDICATE THE CURRENT NUMBER              68100000
*        OF UNITS IN THE MSGGEN BUFFER,THEN RETURN TO CONTINUE          68160000
*        EDITING.                                                       68220000
*                                                                       68280000
**************************************************************          68340000
NEXTUNIT EQU   *                        GET NEXT UNIT TO EDIT           68400000
         L     R10,SCBSRCE+TWELVE       GET CURRENT UNIT ADDR           68460000
         ICM   R10,SEVEN,PRFTI0         GET ADDR OF NEXT UNIT           68520000
         STCM  R10,SEVEN,SCBSRCE+TWELVE UPDATE CURRENT UNIT             68580000
*                                       ADDRESS                         68640000
         LA    R1,PRFSUNIT              GET ADDRESS FOR TSO             68700000
*                                       OUTPUT EDIT TO MOVE             68760000
*                                       TEXT FOR SUBSEQUENT             68820000
*                                       UNITS                           68880000
         L     R10,SCBSRCE+EIGHT8       GET ADDR OF FIRST UNIT          68940000
         SR    R8,R8                    CLEAR FOR IC                    69000000
         IC    R8,PRFNBUNT              GET CURRENT UNIT COUNT          69060000
         LA    R8,ONE(R8)               INCREMENT CURRENT UNIT          69120000
         STC   R8,PRFNBUNT              UPDATE CURRENT COUNT            69180000
*                                       OF UNITS IN BUFFER              69240000
         B     EDITLOOP                 CONTINUE EDITING                69300000
         EJECT                                                          69302000
EDITBFR  EQU   *                                               @OY13623 69304000
         BAL   R14,SETGMAIN             SET UP WORK AREA       @OY13623 69306000
         LA    R1,PRFSHDR               ADDR OF WHERE TO MOVE  @OY13623 69308000
         SR    R0,R0                    PARM FOR EDIT          @OY13623 69310000
         L     R15,AVTTSOPT             ADDR OF TIME SHARING   @OY13623 69312000
         L     R15,TSI3270-IEDQTSI(,R15)  ADDR OF 3270 EDIT    @OY13623 69314000
         BALR  R14,R15                  GO TO IEDAYQ           @OY13623 69316000
         LR    R1,R15                   SAVE DATA MOVE COUNT   @OY13623 69318000
         SRL   R1,SHFT2BYT              MOVE DATA COUNT TO LOW @OY13623 69320000
         LA    R1,AVTHDRSZ(,R1)         ADD PREFIX SIZE TO CNT @OY13623 69322000
         LH    R10,AVTKEYLE             GET UNIT SIZE          @OY13623 69324000
         SR    R0,R0                    CLEAR FOR DIVIDE       @OY13623 69326000
         DR    R0,R10                   UNITS USED             @OY13623 69328000
         LTR   R0,R0                    IS THERE A REMAINDER   @OY13623 69330000
         BZ    UNITCNT                  NO, BRANCH             @OY13623 69332000
         LA    R1,ONE(,R1)              ADD UNIT FOR REMAINDER @OY13623 69334000
         SPACE                                                          69336000
UNITCNT  EQU   *                                               @OY13623 69338000
         L     R10,SCBSRCE+EIGHT8       GET ADDRESS OF FIRST            69338500
*                                       UNIT OF MSGGEN         @OY13623 69339000
         STC   R1,PRFNBUNT              SAVE NUMBER OF UNITS   @OY13623 69340000
         LA    R10,SCBSRCE              SET UP FOR LOOP        @OY13623 69342000
         SPACE                                                          69344000
FINDLAST EQU   *                                               @OY13623 69346000
         L     R10,PRFTIC               GET NEXT UNIT          @OY13623 69348000
         BCT   R1,FINDLAST              GET TO LAST UNIT       @OY13623 69350000
         ST    R10,SCBSRCE+TWELVE       SAVE CURRENT UNIT      @OY13623 69352000
         EJECT                                                          69360000
**************************************************************          69420000
*                                                                       69480000
*        FREE ANY UNITS NOT USED DURING THE EDITING AND                 69540000
*        EXIT TO DSPCHAIN TO POST THE CHAIN OF ELEMENTS                 69600000
*        ON LCBERBLK.                                                   69660000
*                                                                       69720000
**************************************************************          69780000
FREEUNIT EQU   *                        FREE ANY UNUSED UNITS           69840000
         SRL   R15,SHFT2BYT             MOVE DATA COUNT TO LOW          69900000
*                                       ORDER TWO BYTES                 69960000
         L     R10,SCBSRCE+TWELVE       GET CURRENT UNIT ADDR           70020000
         CLC   PRFTIC,TIC               WERE ALL UNITS USED             70080000
         BE    ALLUSED                  YES, NO UNITS TO FREE           70140000
         ICM   R1,SEVEN,LCBERBLK        GET CHAIN OF ELEMENTS           70200000
         MVC   LCBERBLK,PRFTI0          CHAIN IN UNITS TO BE            70260000
*                                       FREED FOR DSPCHAIN              70320000
         MVC   PRFTIC,TIC               PUT INVALID TIC IN              70380000
*                                       LAST MSGGEN UNIT                70440000
         ICM   R10,SEVEN,LCBERBLK       GET ADDR OF FIRST UNIT          70500000
*                                       TO BE FREED                     70560000
         MVI   PRFNBUNT,AVTEZERO        CLEAR FOR BUFFER RETURN         70620000
         LA    R5,AVTBFRTB              ADDR BUFFER RETURN QCB          70680000
         STCM  R5,SEVEN,PRFQCBA         SET QCB ADDRESS TO              70740000
*                                       BUFFER RETURN QCB               70800000
         MVI   PRFPRI,PRIBFRTB          SET POST PRIORITY               70860000
         STCM  R1,SEVEN,PRFLINK         LINK IN CHAIN OF                70920000
*                                       ELEMENTS FOR DSPCHAIN           70980000
ALLUSED  EQU   *                        COMPLETE PREFIX                 71040000
         LA    R1,LCBERB                GET ADDRESS OF ERB FOR          71100000
*                                       POST TO NIR GENERATOR           71160000
         LA    R15,AVTHDRSZ(R15)        ADD PREFIX SIZE TO              71220000
*                                       LENGTH OF TEXT MOVED            71280000
         L     R10,SCBSRCE+EIGHT8       GET ADDRESS OF FIRST            71340000
*                                       UNIT OF MSGGEN                  71400000
         STH   R15,PRFSIZE              SET PRFSIZE                     71460000
         LA    R14,AVTHDRSZ             GET HDR PREFIX SIZE             71520000
         TM    LCBSTAT5,LCBLUNIT        IS THIS A LU           @YM06037 71580000
         BZ    CKLEN                    NO DONT SEND ZERO      @YM06037 71640000
*                                       LENGTH MSGGEN          @YM06037 71700000
         TM    LOCSWTCH,GENNOMSG        IS THIS RH ONLY MSGGEN @YM06037 71760000
         BO    SNDNUL                   YES, SEND NULL RU      @YM06037 71820000
CKLEN    EQU   *                                               @YM06037 71880000
         CR    R14,R15                  WAS MSGGEN EDITED               71940000
         BE    NOMSGGEN                 NO, NO   MSGGEN                 72000000
SNDNUL   EQU   *                                               @YM06037 72060000
         MVI   LCBISZE,AVTEZERO         INDICATE NO RESERVES            72120000
         TM    LCBSTAT5,LCBLUNIT        LU?                             72180000
         BNO   NOIBUMP                  BRANCH NO                       72240000
         TM    T3270+ONE,DCT3270        3270 COMPATIBLE                 72300000
         BNO   NOIBUMP                  BRANCH NO                       72360000
         LA    R14,1                    SET IDLE COUNT TO 1             72420000
         STC   R14,LCBISZE              BUMP PAST ESCAPE                72480000
NOIBUMP  EQU   *                                                        72540000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN FLAG                 72600000
         TM    QCBFLAG,QCBTSSES         TERMINAL IN TSO SESSION         72660000
         BZ    EXIT                     NO, BRANCH                      72720000
         OI    LCBTSOB,LCBTSBUF         INDICATE TSO ON LINE            72780000
EXIT     EQU   *                                                        72840000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 72870000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 72920000
*                                       FREE UNUSED UNITS AND           72960000
*                                       POST MSGGEN BUFFER TO           73020000
*                                       DATA NIR GENERATOR              73080000
NOMSGGEN EQU   *                        NO MSGGEN, FREE UNITS           73140000
         CLM   R10,SEVEN,LCBERBLK       CURRENT UNIT ON RETURN @OY20502 73146082
         BE    ERBLKOK                  NO NEED TO SWAP        @OY20502 73152082
         CLC   LCBERBLK(THREE),AVTFZERO CHAIN UNITS TO CURRENT @OY20502 73153082
         BE    RETOK                    NO UNITS TO CHAIN      @OY20502 73154082
         MVC   PRFTI0,LCBERBLK          CHAIN UNITS TO CURRENT @OY20502 73158082
RETOK    EQU   *                                               @OY20502 73164082
         STCM  R10,SEVEN,LCBERBLK       ADDR OF UNIT TO FREE   @OY20502 73170082
         MVI   PRFNBUNT,AVTEZERO        CLEAR FOR BUFFER RETURN@OY20502 73176082
         MVI   PRFPRI,PRIBFRTB          SET POST PRIORITY      @OY20502 73182082
         LA    R5,AVTBFRTB              ADDR BUFFER RETURN QCB @OY20502 73188082
         STCM  R5,SEVEN,PRFQCBA         SET QCB ADDRESS IN BUFF@OY20502 73194082
ERBLKOK  EQU   *                                               @OY20502 73197082
         LA    R1,LCBERB                GET ADDRESS OF ERB FOR          73200000
*                                       POST                            73260000
         L     R14,AVTMSGS-ONE          GET BUFFER DISPOSITION          73320000
         L     R14,AVTEZERO(,R14)       ADDRESS                         73380000
         STCM  R14,SEVEN,LCBERBQB       SET ERB QCB TO QBD              73440000
         MVI   LCBERBPY,PRIRCQCB        POST PRIORITY                   73500000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 73540000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 73560000
         EJECT                                                          73620000
**************************************************************          73680000
*                                                                       73740000
*        THIS SUBROUTINE  IS EXECUTED FOR THE FIRST UNIT OF             73800000
*        EVERY MSGGEN. THE TCAM BUFFER PREFIX IS BUILT WITH             73860000
*        THE FIELDS REQUIRED BY BOTH THE CONTROL NIR                    73920000
*        GENERATOR AND THE DATA NIR GENERATOR. OTHER FIELDS             73980000
*        ARE FILLED IN LATER.                                           74040000
*                                                                       74100000
**************************************************************          74160000
BLDPRF   EQU   *                        BUILD TCAM PREFIX               74220000
         ST    R10,SCBSRCE+EIGHT8       SAVE THE BEGINNING              74280000
*                                       OF BUFFER ADDRESS               74340000
         ST    R10,SCBSRCE+TWELVE       SAVE THE ADDRESS OF             74400000
*                                       CURRENT UNIT                    74460000
         STCM  RLCB,SEVEN,PRFLCB        PUT PLCB ADDR IN PRF            74520000
         LH    R1,LCBTTCIN              GET TNT INDEX                   74580000
         STH   R1,PRFDEST               SET THE DESTINATION             74640000
         NI    PRFSTAT1,AVTEFF-PRFNLSTN-PRFNHDRN MAKE BUFFER            74700000
*                                       HEADER/LAST                     74760000
         MVI   PRFNBUNT,ONE             SET UNIT COUNT = ONE            74820000
         TM    TRMBYTE0,TRMSNA          IS IT A SNA TERMINAL            74880000
         BZ    RETURN                   NO, RETURN                      74940000
         LA    R1,PRF2LEN               GET LENGTH OF PREFIX            75000000
         LR    R5,R10                   GET BFR ADDRESS                 75060000
         SR    R5,R1                    BACK UP TO PREFIX               75120000
         USING IEDPF1,R5                PREFIX ADDRESSABILITY           75180000
         XC    IEDPF1(PRF2LEN),IEDPF1   CLEAR PREFIX                    75240000
         L     R1,TRMSIBPT-1            GET ADDRESS OF THE SIB          75300000
         TM    QCBFLAG,QCBTSSES         TERMINAL IN TSO SESSION         75360000
         BO    NOBREQ                   BRANCH YES                      75420000
         USING IEDSIBD,R1               SIB ADDRESSABILITY              75480000
         TM    SIBSTAT1,SIBINB          IN BRACKET STATE                75540000
         BZ    NOBREQ                   NO END BRACKET REQUIRED         75600000
         OI    PRF1RH+(TRHBYTE2-IEDRH),TRHEB  INDICATE END BKT          75660000
NOBREQ   EQU   *                                                        75720000
         DROP  R1                                                       75780000
         USING IEDGENDS,R8                                              75840000
         TM    GENFLAGS,GENRHINC        IS THERE A RH                   75900000
         BZ    RETURN                   NO, USE TSO DEFAULT             75960000
         SR    R1,R1                    CLEAR FOR IC                    76020000
         IC    R1,GENLNGTH              GET LENGTH OF PARAMETR          76080000
*                                       LIST                            76140000
         SRL   R1,2                     SHIFT OUT FLAG BITS             76200000
         SLL   R1,2                     SHIFT BACK TO LENGTH            76260000
         SH    R1,AVTHA4                BACK UP TO RH PTR LENGTH        76320000
         L     R1,0(R1,R8)              GET RH ADDRESS                  76380000
         MVC   PRF1RH(TRH1LEN),0(R1)    MOVE RH TO NEGATIVE             76440000
*                                       BUFFER PREFIX                   76500000
         DROP  R8                                                       76560000
         DROP  R5                                                       76620000
RETURN   EQU   *                                                        76680000
         BR    R14                      RETURN TO CALLER                76740000
         EJECT                                                          76800000
**************************************************************          76860000
*                                                                       76920000
*        COMPUTE THE NUMBER OF UNITS REQUIRED TO CONTAIN THE            76980000
*        EDITED MSGGEN AND A RESET ERROR LOCK IF REQUIRED.              77040000
*        USE THE BUFFER STEAL ROUTINE TO TRY TO OBTAIN ONE              77100000
*        BUFFER OF THE REQUIRED NUMBER OF UNITS.  IF THIS IS            77160000
*        UNSUCCESSFUL POST THE ERB TO REQUEST ONE BUFFER OF             77220000
*        OF THE REQUIRED NUMBER OF UNITS. WHEN ERB REQUEST              77280000
*        IS SATISFIED THE ERB IS POSTED BACK TO A QCB                   77340000
*        (AYMBFRQ).                                                     77400000
*                                                                       77460000
**************************************************************          77520000
GETBFR   EQU   *                        GET BFR FOR MSGGEN              77580000
         LA    R1,ONE                   ASSUME 3270 ERASE               77640000
         TM    T3270,DCT3270            IS THIS A 3270 ERASE            77700000
         BO    STEALBFR                 YES,REQUEST ONE UNIT            77760000
         SR    R1,R1                    CLEAR FOR IC                    77820000
         LTR   R2,R2                    LEFT JUSTIFY REQUIRED           77880000
         BZ    TEST3270                 BRANCH YES                      77940000
         IC    R1,AVTEZERO(,R2)         GET LENGTH OF MSGGEN            78000000
*                                       FROM MACRO EXPANSION            78060000
TEST3270 EQU   *                                                        78120000
         TM    T3270+ONE,DCT3270        IS THIS A 3270 TERMINAL         78180000
         BZ    NOT3270                  NO,BRANCH                       78240000
         LA    R1,FOURTEN(R1)           INCREMENT LENGTH BY             78300000
*                                       MAX NUMBER OF BYTES             78360000
*                                       TSO OUTPUT EDIT WILL            78420000
*                                       INSERT                          78480000
         B     CONCOMP                  CONTINUE COMPUTATION            78540000
NOT3270  EQU   *                                                        78600000
         LA    R1,FOUR(R1)              INCREMENT LENGTH BY             78660000
*                                       MAX NUMBER OF BYTES             78720000
*                                       TSO OUTPUT EDIT WILL            78780000
*                                       INSERT                          78840000
CONCOMP  EQU   *                        CONTINUE COMPUTATION            78900000
         LA    R1,AVTHDRSZ(R1)          ADD HEADER PREFIX SIZE          78960000
         LH    R10,AVTKEYLE             GET UNIT SIZE                   79020000
         SR    R0,R0                    CLEAR FOR DIVIDE                79080000
         DR    R0,R10                   DIVIDE TOTAL NUMBER OF          79140000
*                                       BYTES BY THE UNIT SIZE          79200000
         LTR   R0,R0                    IS THERE A REMAINDER            79260000
         BZ    STEALBFR                 NO,BRANCH                       79320000
         LA    R1,ONE(R1)               ADD ONE UNIT FOR REMAINDER      79380000
STEALBFR EQU   *                                                        79440000
         LR    R0,R1                    UNIT COUNT FOR BUFFER           79500000
*                                       STEAL ROUTINE                   79560000
         LA    R1,ONE                   ONE BFR COUNT FOR               79620000
*                                       BUFFER STEAL ROUTINE            79680000
         LR    R10,R14                  SAVE MAINLINE ADDRESS           79740000
         L     R15,AVTSTEAL             ENTRY POINT ADDRESS             79800000
         BALR  R14,R15                  GO TO BUFFER STEAL              79860000
         EJECT                                                          79920000
**************************************************************          79980000
*                                                                       80040000
*        RETURN FROM BUFFER STEAL                                       80100000
*        REG 15          0=BUFFER NOT AVAILABLE                         80160000
*                    NOT 0=ADDRESS OF BUFFER                            80220000
*                                                                       80280000
**************************************************************          80340000
         LR    R14,R10                  RESTORE MAINLINE                80400000
*                                       RETURN ADDRESS                  80460000
         LTR   R15,R15                  BFR STEAL SUCCESSFUL            80520000
         BNZR  R14                      YES,RETURN TO SEND              80580000
*                                       MSGGEN                          80640000
**************************************************************          80700000
*                                                                       80760000
*        POST ERB TO REQUEST ONE BUFFER WITH THE COMPUTED               80820000
*        NUMBER OF UNITS. BUFFER WILL BE RETURNED ON ERB                80880000
*        POSTED TO AYMBFRQ .                                            80940000
*                                                                       81000000
**************************************************************          81060000
         LA    R14,AVTBFREB             AVAILABLE BUFFER QCB            81120000
         LA    R5,AYMBFRQ               REENTRY QCB ADDR                81180000
         ST    R5,LCBRCQCB              RETURN QUEUE                    81240000
         MVI   LCBERBPY,PRIINTRQ        POST PRIORITY                   81300000
         STH   R0,LCBERBCT              SET UNIT COUNT TO               81360000
*                                       COMPUTED COUNT                  81420000
         STC   R1,LCBERBCT              SET BFR COUNT TO ONE            81480000
         OI    LCBERBST,LCBPRCPG        INDICATE POST BACK              81540000
         STCM  R14,SEVEN,LCBERBQB       BD QCB ADDRESS                  81600000
         LA    R1,LCBERB                ADDR OF ERB                     81660000
         L     R11,AVTEA                GET DISPATCHER ADDRESS @OY13623 81680000
         BAL   R14,DSPCHAIN-IEDQDISP(,R11) BR TO DISPATCHER    @OY13623 81690000
         DROP  R15                                             @OY13623 81700000
         EJECT                                                          81722700
SETGMAIN EQU   *                                               @OY13623 81723600
         USING IEDQTSI,R8                                      @OY13623 81724500
         ST    R14,AVTSAVE3             SAVE R14               @OY13623 81725400
         OI    LCBSTAT2,LCBMSGNN        INDICATE MSGGEN        @OY13623 81726300
         L     R8,AVTTSOPT              GET TSINPUT QCB        @OY13623 81727200
         XC    TSIGMAIN(GMXTNT-SIX),TSIGMAIN CLR EDIT WORKAREA @ZM47758 81727600
         TM    TRMSTATE,TRMPREF         NCP OR SNA?            @OY13623 81729000
         BZ    NOTNCP                   NO                     @OY13623 81729900
         MVC   GMCRBUF,SCBSRCE+EIGHT8   GET BUFFER ADDR        @OY13623 81730800
         SPACE                                                          81731700
*      GET DEVICE CHARACTERISTICS                              @OY13623 81732600
         SPACE                                                          81733500
NOTNCP   EQU   *                                               @OY13623 81734400
         MVC   GMCARCT+ONE(ONE),QCBCARCT SAVE CARRIAGE COUNT   @OY13623 81735300
         MVC   GMSATCT+ONE(ONE),QCBSATCT  AND LINE COUNT       @OY13623 81736200
         MVI   GMLNSZ,40                GET DEFAULT LINE SIZE  @OY13623 81737100
         MVI   GMLNNO,12                GET DEFAULT LINE NO.   @OY13623 81738000
         TM    QCBFLAG,QCBTSSES         IN TSO SESSION         @ZM47752 81738300
         BZ    DEFLNNO                  BRANCH, NO             @ZM47752 81738600
         SPACE                                                          81738900
*     GET TSB ADDRESS                                          @OY13623 81739800
         SPACE                                                          81740700
         USING CVT,R14                                         @OY13623 81741600
         L     R14,CVTPTR               LOAD CVT ADDR          @OY13623 81742500
         L     R15,CVTAQAVT             GET TCX ADDRESS        @G36XRYP 81743400
         L     R15,TCXRPT-IEDQTCX(R15)  GET TIOCRPT ADDRESS    @G36XRYP 81744300
         LTR   R15,R15                  ZERO IF TSO NOT ACTIVE @G36XRYP 81745200
         BZ    DEFLNNO                  NO, USE DEFAULT VALUES @G36XRYP 81746100
         LH    R15,QCBTJID              GET ASID               @G36XRYP 81747000
         BCTR  R15,0                    DECREMENT FOR ZERO     @G36XRYP 81747900
*                                       ORIGIN                 @G36XRYP 81748800
         SLL   R15,2                    MULTIPLY BY 4          @G36XRYP 81749700
         L     R14,CVTASVT              GET ASVT ADDRESS       @G36XRYP 81750600
         DROP  R14                                             @G36XRYP 81751500
         USING ASVT,R14                 ASVT ADDRESSABILITY    @G36XRYP 81752400
         LA    R14,ASVTENTY             GET ASCB LIST ADDRESS  @ZM47673 81753300
         L     R14,AVTEZERO(R15,R14)    GET ASCB ADDRESS       @ZM47673 81753900
         DROP  R14                                             @G36XRYP 81755100
         USING ASCB,R14                 ASCB ADDRESSABILITY    @G36XRYP 81756000
         L     R14,ASCBTSB              GET TSB ADDRESS        @G36XRYP 81756900
         DROP  R14                                             @OY13623 81757800
         SPACE                                                          81758700
*        SETUP LINE SIZE AND LINE NUMBER                       @OY13623 81759600
         SPACE                                                          81760500
         USING TSB,R14                                         @OY13623 81761400
         SR    R6,R6                    CLEAR REG              @OY13623 81762300
         IC    R6,TSBLNSZ               GET LINE SIZE          @OY13623 81763200
         LTR   R6,R6                    LINE SIZE SPECIFIED    @OY13623 81764100
         BZ    DEFLNSZ                  BRANCH NO              @OY13623 81765000
         STC   R6,GMLNSZ                SAVE NUMBER            @OY13623 81765900
         SPACE                                                          81766800
DEFLNSZ  EQU   *                                               @OY13623 81767700
         IC    R6,TSBLNNO               NUMBER OF LINES        @OY13623 81768600
         LTR   R6,R6                    SPECIFIED?             @OY13623 81769500
         BZ    DEFLNNO                  BRANCH NO              @OY13623 81770400
         STC   R6,GMLNNO                SAVE NUMBER            @OY13623 81771300
         SPACE                                                          81772200
DEFLNNO  EQU   *                                               @OY13623 81773100
         ST    R2,GMTSBUF               SETUP ADDR OF MSGGEN   @OY13623 81774000
         ST    R1,GMTCBUF               SETUP ADDR IN OF SCB   @OY13623 81774900
         L     R14,AVTSAVE3             GET RETURN ADDRESS     @OY13623 81775800
         BR    R14                      RETURN                 @OY13623 81776700
         DROP  R14                                             @OY13623 81777600
         EJECT                                                          81780000
ERRTRANS TR    SCBMBSSA+1(1),0(R8)      TRANSLATE                       81840000
AYMTRANS TR    SCBMBSSA(1),0(R8)        TRANSLATE                       81900000
MOVE     MVC   0(0,R6),0(R8)            MOVE TRANLIST CHARACTER         81960000
         DROP  R9                                              @OY16357 81970000
         USING IEDQTRM,R9                                      @OY16357 81980000
TEST     TM    TRMDEVFL,0               CHECK DEVICE DEPENDENT          82020000
*                                       FLAGS                           82080000
         EJECT                                                          82140000
PATCH    DC    30F'0'                   PATCH AREA                      82200000
LEAVE    DC    X'03000000'              RESET LEFT JUSTIFY              82260000
JUSTIFY  DC    X'05000000'              LEFT JUSTIFICATION              82320000
NOJUST   DC    X'06000000'              NO LEFT JUSTIFICATION           82380000
LEN3270  DC    X'00030000'              LENGTH                          82440000
FRSTUNIT DC    X'10000000'              FIRST UNIT OF 3705 MSGGEN       82500000
TIC      DC    X'08000002'              INVALID TIC                     82560000
T3270    DS    H                        3270 TERMINAL                   82620000
LOCSWTCH DS    X                        LOCAL SWICHES          @YM06995 82680000
ERAS3270 DC    X'27F540'                ERASE REQUEST                   82740000
WRNUL    DC    X'27F1'                  WRITE NULL             @YM06995 82800000
FIVE     DC    H'5'                     HALFWORD OF FIVE                82860000
NOTUSED  DC    AL2(SCBMBSSA-IEDQSCB)    UNUSED PORTION OF SCB           82920000
LCBSIZE  DC    AL2(LCBERB-IEDQLCB)      TO FIND START OF LCB            82980000
X01FF    DC    X'01FF'                  AUTO LINE OR PROMPT             83040000
X0100    DC    X'0100'                  END OF INMSG/OUTMSG             83100000
AELIST   DC    XL4'1404000F'            AEOF,,OPTOF,REG        @OY18057 83160000
DISPXPI  DC    X'034FC91540'            SIMULATED                       83220000
DISPXPD  DC    X'034FCC4150'            *                               83280000
DISPATTN DC    X'024F154040'            ATTENTION                       83340000
         DC    X'04154FC915'            *                               83400000
         DC    X'04154FC415'            PROMPT                          83460000
         DC    X'03154F1540'            *                               83520000
STXETX   DC    X'0203'                  2260 STX/ETX                    83580000
ERASEREM DC    X'0227F54003'            3270 REMOTE ERASE               83640000
ERASELOC DC    X'40'                    3270 LOCAL ERASE                83700000
ENTER    DC    X'10'                    MSGGEN ENTER                    83760000
         DC    C'IKJ53020A ENTER '      MESSAGE                         83820000
TWOE     DC    X'2E'                    MAX DATA LENGTH        @OZ26884 83840082
NLIDLES  DC    X'151717171717171717'    NL AND IDLES           @OZ26884 83860082
AYMTRAN  DSECT                          USE TO OBTAIN THE               83880000
TRANSLAT DS    A                        ADDRESS OF OUTPUT TABLE         83940000
         EJECT                                                          84000000
IEDGENDS DSECT                                                          84060000
GENINDEX DS    X                        AVTMSGS INDEX TO IEDQBL         84120000
GENMSKSP EQU   X'01'                    MASK SPECIFIED                  84180000
GENLNGTH DS    X                        PARM LIST LENGTH                84240000
GENFLAGS DS    X                        FLAG BYTE                       84300000
GENUSDCB EQU   X'80'                    USE TABLE IN DCB                84360000
GENRHINC EQU   X'40'                    RH DATA INCLUDED                84420000
GENNOMSG EQU   X'20'                    NOMSG CODED                     84480000
GENOCODE EQU   X'10'                    CODE=NO CODED                   84540000
GENMASK  DS    XL5                      MSGGEN MASK                     84600000
GENMSGAD DS    A                        ADDR MSGGEN DATA                84660000
GENCODE  DS    A                        TRANSLATE TABLE ADDR            84720000
GENRHADR DS    A                        ADDR RH DATA                    84780000
         EJECT                                                          84840000
CVT      DSECT                                                          84900000
         CVT                                                            84960000
         IKJTIOCP                                                       85080000
         IKJTSB                                                         85140000
         TSIBD                                                          85200000
         TTSWD                                                          85260000
         TSCBD                                                          85320000
         TLCBD                                                          85380000
         TAVTD                                                          85440000
         TQCBD                                                          85500000
         TTSID                                                          85560000
         TRHD                                                           85620000
         TPRIOR                                                         85680000
         TTRMD                                                          85740000
         TDCTD                                                          85800000
         TDISPD                                                         85860000
         DCBD  DSORG=TX                                                 85920000
         TPRFD                                                          85980000
         TLGBD                                                          86040000
         TTCXD                                                          86050000
         EJECT                                                          86060000
         IHAASVT                                                        86070000
         EJECT                                                          86080000
         IHAASCB                                                        86090000
         END                                                            86100000
