         TITLE 'IEDAYN - TSOUTPUT SUBTASK'                              00050000
IEDAYN   CSECT                                                          00100000
*********************************************************************** 00150000
*A860000,913000,894000                                         @G36XRYP 00200000
*C195000,216000,241000,246000,530000,546000,710000,715000      @G36XRYP 00250000
*C789000,805000,211000,681000                                  @G36XRYP 00300000
*D859000,861000-869000,920000-921000,923000-924000,125000      @G36XRYP 00350000
*A142500                                                       @OZ27604 00360000
*A394240,398500,402740,407200                                  @Z37XBYK 00370000
*D430500                                                       @Z37XBYK 00380000
*C020500,442500                                                @OZ28765 00390000
*A286500                                                       @OZ30295 00390186
*C288500                                                       @OZ30295 00390286
*D290000-292500                                                @OZ30295 00390386
*A215500                                                       @OZ30811 00390486
*C171500-174500                                                @OY20542 00390586
*A054500                                                       @OY20501 00390686
*C154500-155500                                                @OY20501 00390786
*********************************************************************** 00400000
*                                                                     * 00450000
* MODULE NAME = IEDAYN          (TCAM,TSO)                     @G36XRYP 00500000
*                                                                     * 00550000
* DESCRIPTIVE NAME = TSOUTPUT SUBTASK FOR 3270 TERMINALS              * 00600000
*                                                                     * 00650000
* COPYRIGHT = NONE                                                    * 00700000
*                                                                     * 00750000
* STATUS = VERSION 10.0                                        @G36XRYP 00800000
*                                                                     * 00850000
* FUNCTION = IEDAYN COMMUNICATES WITH TSO TO RECEIVE DATA READY       * 00900000
*            FOR TRANSMISSION TO 3270 TERMINALS.  DATA RECEIVED IS    * 00950000
*            POSTED TO THE CORRECT QCB FOR TRANSMISSION AFTER         * 01000000
*            BEING EDITED.                                            * 01050000
*                                                                     * 01100000
* NOTES = SEE BELOW                                                   * 01150000
*                                                                     * 01200000
*   DEPENDENCIES = NONE                                               * 01250000
*                                                                     * 01300000
*   RESTRICTIONS = NONE                                               * 01350000
*                                                                     * 01400000
*   REGISTER CONVENTIONS = 2  GMAIN BASE                              * 01450000
*                          3  SCB BASE                                * 01500000
*                          4  LCB BASE                                * 01550000
*                          6  BUFFER BASE                             * 01600000
*                          7  QCB BASE                                * 01650000
*                          8  TCB BASE                                * 01700000
*                          9  DCB BASE                                * 01750000
*                          11 DISPATCHER BASE                         * 01800000
*                          12 IEDAYN BASE                             * 01850000
*                          13 SAVE AREA BASE                          * 01900000
*                          14 RETURN REGISTER                         * 01950000
*                                                                     * 02000000
*   PATCH LABEL = PATCH                                        @OZ28765 02050000
*                                                                     * 02100000
* MODULE TYPE = CONTROL                                               * 02150000
*                                                                     * 02200000
*   PROCESSOR = ASSEMBLER F                                           * 02250000
*                                                                     * 02300000
*   MODULE SIZE = N/A                                                 * 02350000
*                                                                     * 02400000
*   ATTRIBUTES = SERIALLY REUSEABLE                                   * 02450000
*                                                                     * 02500000
* ENTRY POINT = IEDAYN                                                * 02550000
*   PURPOSE = ENTRY WITH BUFFER TO CAUSE TSO MESSAGE TO BE MARKED     * 02600000
*             SENT OR ERB TO REQUEST TSO MESSAGE BUFFERS              * 02650000
*   LINKAGE = STANDARD LINKAGE FROM THE TCAM DISPATCHER               * 02700000
* ENTRY POINT = IEDAYN02                                              * 02750000
*   PURPOSE = ENTRY WITH BUFFER FROM IEDQGB                           * 02800000
*   LINKAGE = STANDARD LINKAGE FROM THE TCAM DISPATCHER               * 02850000
*                                                                     * 02900000
* INPUT = BUFFER TO CAUSE TSO MESSAGE TO BE MARKED SENT               * 02950000
*         ERB TO REQUEST TSO MESSAGE BUFFERS                          * 03000000
*         BUFFER FROM IEDQGB FOR ADDITION TO BUFFERS ALREADY          * 03050000
*         CHAINED                                                     * 03100000
*                                                                     * 03150000
* OUTPUT = TSO MESSAGE MARKED SENT                                    * 03200000
*          TCAM BUFFER CHAIN OF BUFFERS TO BE TRANSMITTED             * 03250000
*                                                                     * 03300000
* EXIT-NORMAL = TO TCAM DISPATCHER                                    * 03350000
*               TO IEDAYM                                             * 03400000
*                                                                     * 03450000
* EXIT-ERROR = NONE                                                   * 03500000
*                                                                     * 03550000
* EXTERNAL REFERENCES = SEE BELOW                                     * 03600000
*                                                                     * 03650000
*   ROUTINES = IEDAYOO (VIA SVC 65) TO COMMUNICATE WITH TSO           * 03700000
*   DATA AREAS = TCAM BUFFER                                          * 03750000
*                TSO BUFFER                                           * 03800000
*                GMAIN EDIT WORK AREA                                 * 03850000
*   CONTROL BLOCKS = AVT                                              * 03900000
*                    LCB                                              * 03950000
*                    QCB                                              * 04000000
*                    SCB                                              * 04050000
*                    TIOCRPT                                          * 04100000
*                    TJB                                              * 04150000
*                    TSB                                              * 04200000
*                    TSCVT                                            * 04250000
*                                                                     * 04300000
* TABLES = NONE                                                       * 04350000
*                                                                     * 04400000
* MACROS = NONE                                                       * 04450000
*                                                                     * 04500000
*********************************************************************** 04550000
         ENTRY IEDAYN02                                                 04600000
         USING AVTSAVE2,R13                                             04650000
         USING IEDQTSI,RTSI                                             04700000
         USING IEDQDISP,RDISP                                           04750000
         USING IEDQLCB,RLCB                                             04800000
         USING IEDQSCB,RSCB                                             04850000
         USING IEDQQCB,RQCB                                             04900000
R0       EQU   0                                                        04950000
R1       EQU   1                        TERMINAL ENTRY BASE             05000000
R3       EQU   3                                                        05050000
R5       EQU   5                                                        05100000
R8       EQU   8                                                        05150000
R9       EQU   9                                                        05200000
R10      EQU   10                                                       05250000
R12      EQU   12                       IEDAYN BASE                     05300000
R13      EQU   13                       SAVE AREA BASE                  05350000
R14      EQU   14                       RETURN REGISTER                 05400000
R15      EQU   15                                                       05450000
ONE      EQU   1                        INCREMENT VALUE        @OY20501 05470086
RTSI     EQU   2                        TSINPUT BASE                    05500000
RSCB     EQU   3                        SCB BASE                        05550000
RLCB     EQU   4                        LCB BASE                        05600000
RPRF     EQU   6                        BUFFER BASE                     05650000
RQCB     EQU   7                        QCB BASE                        05700000
RTSB     EQU   8                        TSB BASE                        05750000
RDCB     EQU   10                       DCB BASE                        05800000
RDISP    EQU   11                       DISPATCHER BASE                 05850000
RBASE    EQU   12                       IEDAYO BASE                     05900000
BAKER    EQU   11                       QTIP ENTRY CODE                 05950000
CHARLIE  EQU   12                       QTIP ENTRY CODE                 06000000
DOG      EQU   13                       QTIP ENTRY CODE                 06050000
EASY     EQU   14                       QTIP ENTRY CODE                 06100000
FOX      EQU   15                       QTIP ENTRY CODE                 06150000
TEN      EQU   16                       QTIP ENTRY CODE                 06200000
TRMBUFSZ EQU   X'80'                    BUFSIZE SPECIFIED               06250000
XXCTUSED EQU   X'80'                    DISABLED COUNT IN USE           06300000
DELAY    EQU   X'02'                    TIME DELAY FLAG TEST            06350000
DYNMBFR  EQU   X'10'                    PCI TEST                        06400000
C3270    EQU   X'04'                    3270 DCT FLAG                   06450000
TICOPCD  EQU   X'08'                    TIC COMMAND CODE                06500000
         EJECT                                                          06550000
         DC    AL1(DSPMCPL8),AL3(0),A(0)                                06600000
         USING *,RBASE                                                  06650000
         LR    RBASE,R15                                                06700000
IEDAYN   IEDHJN IEDAYN01                                                06750000
         BAL   R14,ELEMENT              DETERMINE ELEMENT TYPE          06800000
*                                       BEGIN EDIT IF ERB, INDICATE     06850000
*                                       MESSAGE IS SENT IF BUFFER       06900000
NEWBFR   EQU   *                                                        06950000
         BAL   R14,BUFFERS              ALLOCATE REQUESTED BUFFERS      07000000
*                                       AND LINK BUFFERS POSTED BY      07050000
*                                       BUFFER RETURN                   07100000
         BAL   R14,MESSAGES             REQUEST TPUTS FROM TSO          07150000
*                                       AND EDIT DATA INTO TCAM BUFFERS 07200000
         B     NEWBFR                   RETURN TO DETERMINE IF MORE     07250000
*                                       OF THE MESSAGE WAS REQUESTED    07300000
*                                       BY PCI                          07350000
         DS    0F                                                       07400000
IEDAYN02 EQU   *                                                        07450000
         DC    AL1(DSPMCPL8),AL3(0),A(0)                                07500000
         L     RBASE,AVTDSIOB+8         LOAD BASE                       07550000
         LA    RBASE,8(,RBASE)          REGISTER                        07600000
         BAL   R14,CLEANUP              PROCESS BUFFERS RETURNED        07650000
*                                       BY IEDQGB                       07700000
         B     NEWBFR                   REATTEMPT TO GET REQUIRED       07750000
*                                       NUMBER OF BUFFERS               07800000
         EJECT                                                          07850000
ELEMENT  EQU   *                                                        07900000
         USING IEDQTRM,R1                                               07950000
         USING IEDQPRF,RPRF                                             08000000
         ST    R14,AVTSAVE3             SAVE RETURN REGISTER            08050000
         L     RTSI,AVTTSOPT            GET TSINPUT QCB                 08100000
         ST    RQCB,AVTDOUBL            SAVE QCB AND                    08150000
         ST    R1,AVTDOUBL+4            ELEMENT ADDRESS                 08200000
         TM    PRFTIC-IEDQPRF(R1),CCWTIC BUFFER OR ERB                  08250000
         BNO   ERB                      BRANCH NO                       08300000
         LR    RPRF,R1                  LOAD BUFFER BASE                08350000
         TM    PRFSTAT1,PRFTSMSG        TSO BUFFER                      08400000
         BNO   CPBINIT                  NO, INVOKE IEDQFA               08450000
         L     RLCB,PRFLCB-1            LOAD LCB ADDR                   08500000
         LH    R1,LCBTTCIN              GET CONNECT INDEX               08550000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER BYTES          08600000
         LTR   R1,R1                    INDEX ZERO                      08650000
         BZ    CPBINIT                  YES, INVOKE IEDQFA              08700000
         L     R15,AVTRNMPT             GET ADDRESS TNT CODE            08750000
         BALR  R14,R15                  LOCATE TERMINAL ENTRY           08800000
         L     RQCB,TRMDESTQ-1          GET QCB ADDRESS                 08850000
         NC    QCBTJID,QCBTJID          VALID TJID                      08900000
         BZ    RETBFR                   BRANCH NO                       08950000
         TM    AVTBIT3,AVTTSAB          TSO ABENDING                    09000000
         BO    RETBFR                   BRANCH YES                      09050000
         BAL   R14,TSBADDR              GET TSB ADDRESS                 09100000
         TM    PRFSTAT1,PRFERMGN        ERROR ON THIS MSG               09150000
         BNO   SUCCSEND                 BRANCH NO                       09200000
         QTIP  DOG,(R13)                INDICATE MESSAGE NOT SENT       09250000
*                                       REBUILD TSO BUFFER              09300000
         B     RETBFR                   RETURN BUFFER                   09350000
SUCCSEND EQU   *                                                        09400000
         QTIP  CHARLIE,(R13)            INDICATE MESSAGE SENT           09450000
*                                       FREE TSO BUFFER, CLEAR WAITS    09500000
         TM    TIOCFLG-TIOCRPT(R10),TIOCSYLW  TSO IN LWAIT              09550000
         BNO   RETBFR                   BRANCH NO                       09600000
         OI    QCBTSOF1,QCBNOBUF        SET OUT OF BUFFERS              09650000
RETBFR   EQU   *                                                        09700000
         LA    R1,AVTBFRTB              SET ADDRESS BUFFER              09750000
         ST    R1,PRFQCBA-1             RETURN QCB                      09800000
         MVI   PRFPRI,PRIBFRTB          SET RETURN PRIORITY             09850000
         LR    R1,RPRF                  SET BUFFER ADDRESS              09900000
         BAL   R14,DSPPOST              POST BUFFER            @G36XRYP 09950000
         EJECT                                                          10000000
ERB      EQU   *                                                        10050000
         ST    R14,AVTSAVE3             SAVE RETURN ADDRESS             10100000
         SR    RPRF,RPRF                INDICATE ERB ENTRY              10150000
         LA    RLCB,AVTEZERO(,R1)       CALCULATE                       10200000
         LA    R15,LCBERB-IEDQLCB       LCB                             10250000
         SR    RLCB,R15                 ADDRESS                         10300000
         L     RSCB,LCBSCBA-1           LOAD SCB BASE                   10350000
         TM    LCBSTAT1,LCBRCLLN        RECALLING                       10400000
         BO    CPBINIT                  YES, INVOKE IEDQFA              10450000
         L     RQCB,SCBDESTQ-1          LOAD QCB ADDRESS                10500000
         TM    QCBFLAG,QCBTSSES         TSO SESSION                     10550000
         BZ    CPBINIT                  NO, INVOKE IEDQFA               10600000
         BAL   R14,PREGMAIN             SET CONNECTED INDEX AND         10650000
*                                       DCT FIELD OF GMAIN              10700000
         TM    GMDEVCH+1,DCT3270        3270 TERMINAL          @G36XRYP 10750000
         BO    NEWAYO                   BRANCH YES                      10800000
         L     R3,TSIAYO                LOAD IEDAYO ADDRESS             10850000
         L     R1,AVTDOUBL+4            RESTORE ELEMENT AND             10900000
         L     RQCB,AVTDOUBL            QCB ADDRESS                     10950000
         BAL   R14,DSPBYPAS             BYPASS TO IEDAYO       @G36XRYP 11000000
NEWAYO   EQU   *                                                        11050000
         BAL   R14,SETGMAIN             INITIALIZE REST OF GMAIN        11100000
         MVI   LCBERBKY,AVTEZERO        CLEAR ERB KEY                   11150000
         NI    LCBERBST,LCBDLNKF        SET ERB NON POSTABLE            11200000
         XC    LCBERBCH,LCBERBCH        CLEAR ERB CHAIN                 11250000
         CLI   LCBERBPY,PRIINTRQ        INITIAL ERB POST                11300000
         BE    INITIAL                  BRANCH YES                      11350000
         TM    LCBERBST,LCBERROR        ERRORS ON OUTPUT                11400000
         BO    ERROR                    BRANCH NO ERRORS                11450000
         L     R14,AVTSAVE3             RESTORE RETURN ADDRESS          11500000
         TM    AVTBIT3,AVTTSAB          TSO ABENDING                    11550000
         BNO   CKATTN                   BRANCH NO                       11600000
         MVI   GMFLAG,GMENCON           ORDER ENDING CONTROL            11650000
         BR    R14                      RETURN                          11700000
CKATTN   EQU   *                                                        11750000
         TM    SCBERR3,SCBATTN          ATTENTION                       11800000
         BNOR  R14                      NO, RETURN                      11850000
         MVI   GMFLAG,GMENCON           ORDER ENDING CONTROL            11900000
         BR    R14                      RETURN                          11950000
ERROR    EQU   *                                                        12000000
         L     R1,LCBRCQCB              ERRORS HAVE OCCURRED            12050000
         ST    R1,LCBERB                SO POST ERB                     12100000
         MVI   LCBERBPY,PRIRCQCB        TO RETURN QCB                   12150000
         LA    R1,LCBERB                ADDRESS                         12200000
         BAL   R14,DSPPOST              DISPATCHER             @G36XRYP 12250000
CPBINIT  EQU   *                                                        12300000
         L     R3,TSICPBI               LOAD IEDQFA ADDRESS             12350000
         L     R1,AVTDOUBL+4            RESTORE ELEMENT AND             12400000
         L     RQCB,AVTDOUBL            QCB ADDRESS                     12450000
         BAL   R14,DSPBYPAS             BYPASS TO CPB INIT     @G36XRYP 12500000
         EJECT                                                          12550000
INITIAL  EQU   *                                                        12600000
         TM    AVTBIT3,AVTTSAB          TSO ABENDED                     12650000
         BNO   STILLRUN                 BRANCH NO                       12700000
         TM    LCBINSRC+2,DELAY         LCB ON TIME DELAY QUEUE         12750000
         BNO   ACTLCB                   BRANCH NO                       12800000
         LR    R1,RLCB                  LOAD ADDRESS LCB                12850000
         L     R15,AVTHG02              TIME DELAY REMOVAL              12900000
         BALR  R14,R15                  REMOVE LCB                      12950000
         LR    R15,R3                   SAVE                            13000000
         LR    RPRF,RQCB                REGISTERS                       13050000
         LA    RQCB,LCBRSKEY            LOAD STCB ADDRESS               13100000
         LR    R1,RQCB                  LOAD STCB ADDRESS               13150000
         BAL   R14,DSPPRIOR             PUT RECEIVE SCHEDULER IN LCB    13200000
         LR    R3,R15                   RESTORE                         13250000
         LR    RQCB,RPRF                REGISTERS                       13300000
ACTLCB   EQU   *                                                        13350000
         NI    LCBTSOB,AVTEFF-LCBTSBUF-LCBSATRD-LCBCIRCD RESET          13400000
         MVI   LCBSENS0,AVTEZERO        LCB FIELDS                      13450000
         NI    QCBFLAG,AVTEFF-QCBREAD   RESET                           13500000
         NI    QCBDSFLG,AVTEFF-QCBALTMH QCB                             13550000
         MVI   QCBRETCT,AVTEZERO        FIELDS                          13600000
         MVI   QCBCARCT,AVTEZERO        TO END                          13650000
         XC    QCBTJID,QCBTJID          TSO                             13700000
         XC    QCBINSRC,QCBINSRC        SESSION                         13750000
         LA    R9,ABNDMSK               TSO HAS ABENDED                 13800000
         MVI   LCBSTAT1,LCBRECVN        SO INITIALIZE                   13850000
         LA    R15,AVTINOUT             TO SEND                         13900000
         STCM  R15,7,SCBMACR            ABEND MSGGEN                    13950000
         LR    R8,R9                    AND EXIT                        14000000
         L     R12,TSIMSGEN             TO IEDAYM                       14050000
         SR    R1,R1                    FOR                             14100000
         BR    R12                      OUTPUT                          14150000
         EJECT                                                          14200000
STILLRUN  EQU  *                                                        14250000
         XC    SCBSRCE(1),SCBSRCE       CLEAR WORK AREA TO BE  @OZ27604 14260000
*                                       USED IF DATA CONTAINS  @OZ27604 14270000
*                                       BYPASS OR RESTORE CHAR @OZ27604 14280000
         USING TSB,RTSB                                                 14300000
         BAL   R14,TSBADDR              GET TSB ADDRESS                 14350000
         L     R14,AVTSAVE3             RESTORE RETURN REGISTER         14400000
         TM    TSBFLG2,TSBBRKIN         FLASHBACK REQUEST               14450000
         BZR   R14                      NO, RETURN                      14500000
         TM    TSBSTAT,TSBDSPLY         FLASHBACK                       14550000
         BZR   R14                      NO, RETURN                      14600000
         TM    TSBFLG3,TSBSPIT          TCLEARQ IN PROGRESS             14650000
         BOR   R14                      YES, RETURN                     14700000
         CLC   TSBOTBFP,AVTFZERO        TRAILER QUEUE EMPTY             14750000
         BNER  R14                      NO, RETURN                      14800000
         QTIP  FOX,(R13)                TSO MESSAGE TO TRAILER QUEUE    14850000
         BR    R14                      RETURN                          14900000
         DROP  RTSB                                                     14950000
         DROP  R1                                                       15000000
         DROP  RPRF                                                     15050000
         EJECT                                                          15100000
BUFFERS  EQU   *                                                        15150000
         USING IEDQSCB,RSCB                                             15200000
         USING IEDQPRF,RPRF                                             15250000
         ST    R14,AVTSAVE3             SAVE RETURN REGISTER            15300000
         LTR   RPRF,RPRF                BUFFER PASSED                   15350000
         BZ    NOBUFFER                 BRANCH NO                       15400000
         LA    R8,AVTBFRTB              BFR RETURN QCB ADDRESS @OY20501 15450086
         ST    R8,PRFQCBA-1             PUT POINTER IN BUFFER  @OY20501 15470086
         MVI   PRFNBUNT,ONE             SET UNIT COUNT         @OY20501 15490086
         MVI   PRFPRI,PRIBFRTB          SET POST PRIORITY      @OY20501 15510086
         LR    R1,RPRF                  BUFFER ADDR TO POST    @OY20501 15530086
         BAL   R14,DSPPOSTR             BRANCH TO POST BUFFER  @OY20501 15550086
NOBUFFER EQU   *                                                        15600000
         SR    R8,R8                    CLEAR WORK REGISTER             15650000
         IC    R8,LCBERBCT              GET REQUEST COUNT               15700000
         NC    LCBLSPCI,LCBLSPCI        FIRST OR PCI ERB POST           15750000
         BZ    FRSTPOST                 BRANCH INITIAL                  15800000
         OI    LCBERBCT+1,XXCTUSED      RESTRICT DISABLED COUNT         15850000
         CLI   LCBERBCT+1,XXCTUSED      DISABLED COUNT ADJUSTED         15900000
         BNE   MERGE                    BRANCH YES                      15950000
         OI    LCBERBST,LCBDLNKN        MAKE ERB POSTABLE               16000000
         NI    LCBERBCT+1,AVTEFF-XXCTUSED CLEAR FLAG                    16050000
         NC    LCBERBCT,LCBERBCT        COUNT CHANGED BY PCI            16100000
         BZ    DSPDISP                  BRANCH NO                       16150000
         TM    LCBERBST,LCBDLNKN        ERB POSTED BY PCI               16200000
         BNO   DSPDISP                  BRANCH YES                      16250000
         NI    LCBERBST,LCBDLNKF        MAKE ERB UNPOSTABLE             16300000
MERGE    EQU   *                                                        16350000
         IC    R8,LCBERBCT+1            GET DISABLED COUNT              16400000
         MVI   LCBERBCT+1,AVTEZERO      CLEAR DISABLED COUNT            16450000
         LA    R5,AVTEFF-XXCTUSED       SET REGISTER FOR AND            16500000
         NR    R8,R5                    CLEAR USED FLAG                 16550000
         SR    R5,R5                    CLEAR WORK REGISTER             16600000
         IC    R5,LCBERBCT              GET ENABLED COUNT               16650000
         AR    R8,R5                    GET TOTAL COUNT                 16700000
         STC   R8,LCBERBCT              AND STORE                       16750000
         EJECT                                                          16800000
FRSTPOST EQU   *                                                        16850000
         STH   R8,GMBFRS                SET TOTAL BUFFERS AND           16900000
         MH    R8,GMBFUNIT              NUMBER OF UNITS REQUESTED       16950000
         LA    R14,DSPDISP              LOAD NOMORE RETURN ADDRESS      17000000
         SR    R9,R9                    CLEAR COUNT REGISTER            17050000
         LA    RPRF,AVTBFREB-4          SET UNIT ADDRESS                17100000
         LH    R9,AVTAVFCT              NO. UNITS AVAILABLE    @OY20542 17150086
         NC    LCBLSPCI,LCBLSPCI        INITIAL OR PCI REQUEST          17500000
         BNZ   PCIALOC                  BRANCH PCI                      17550000
         CR    R9,R8                    ENOUGH UNITS AVAILABLE          17600000
         BL    NOMORE                   BRANCH NO                       17650000
         LH    R9,GMBFRS                SET NUMBER AND                  17700000
         B     REMOVE                   ALLOCATE BUFFERS                17750000
PCIALOC  EQU   *                                                        17800000
         SR    R8,R8                    CLEAR EVEN DIVIDE REGISTER      17850000
         LH    R1,GMBFUNIT              GET UNITS REQUIRED              17900000
         DR    R8,R1                    GET NUMBER OF COMPLETE          17950000
*                                       BUFFERS ALLOCATEABLE            18000000
         LTR   R9,R9                    ENOUGH FOR 1 BUFFER             18050000
         BZ    NOMORE                   BRANCH NO                       18100000
         LA    R14,REMOVE               SET NOMORE RETURN ADDRESS       18150000
         CH    R9,GMBFRS                ENOUGH UNITS FOR REQUEST        18200000
         BL    NOMORE                   BRANCH NO                       18250000
         LH    R9,GMBFRS                SET MAXIMUM REQUEST             18300000
         EJECT                                                          18350000
REMOVE   EQU   *                                                        18400000
         LH    R15,AVTAVFCT             LOAD AVAILABLE COUNT            18450000
         L     RPRF,AVTBFREB            GET FIRST UNIT TO BUILD         18500000
         STCM  RPRF,7,LCBERBCH          SAVE FIRST UNIT ADDRESS         18550000
PREFIX   EQU   *                                                        18600000
         SR    R1,R1                    CLEAR WORK REGISTER             18650000
         IC    R1,LCBERBCT              REDUCE                          18700000
         BCTR  R1,0                     ERB                             18750000
         STC   R1,LCBERBCT              COUNT                           18800000
         LH    R5,GMBFUNIT              GET UNITS PER BUFFER            18850000
         LR    R8,RPRF                  SAVE PREFIX REGISTER            18900000
         ST    RLCB,PRFLCB-1            INITIALIZE                      18950000
         XC    PRFSIZE,PRFSIZE          BUFFER                          19000000
         XC    PRFSRCE,PRFSRCE          PREFIX                          19050000
         XC    PRFCORE(PRFSHDR+4-PRFCORE),PRFCORE FIELDS                19100000
         MVI   PRFSTAT1,PRFNHDRN+PRFNLSTN+PRFTSMSG AND FLAGS            19150000
EXTRA    EQU   *                                                        19200000
         BCTR  R15,0                    REDUCE AVAILABLE COUNTER        19250000
         MVC   AVTBFREB+1(3),PRFLINK    REMOVE UNIT            @ZM48772 19300000
         MVC   PRFTIC+1(3),PRFLINK      SET TIC ADDRESS                 19350000
         MVI   PRFTIC,TICOPCD           AND COMMAND CODE                19400000
         XC    PRFLINK,PRFLINK          CLEAR LINK                      19450000
         ST    RPRF,AVTDOUBL+4          SAVE LAST UNIT ADDRESS          19500000
         L     RPRF,PRFTIC              GET NEXT UNIT                   19550000
         BCT   R5,EXTRA                 CONTINUE TO BUILD EXTRAS        19600000
         MVC   PRFNBUNT-IEDQPRF(,R8),GMBFUNIT+1 SET NUMBER OF UNITS     19650000
         ST    RPRF,PRFLINK-1-IEDQPRF(,R8) LINK BUFFERS                 19700000
         BCT   R9,PREFIX                BUILD NEXT PREFIX SEGMENT       19750000
         XC    PRFLINK-IEDQPRF(3,R8),PRFLINK-IEDQPRF(R8) CLEAR LINK     19800000
         STH   R15,AVTAVFCT             RESET AVAILABLE COUNT           19850000
         L     RPRF,AVTDOUBL+4          GET LAST UNIT ADDRESS           19900000
         MVC   PRFTIC,INVLDTIC          SET INVALID TIC                 19950000
         L     R14,AVTSAVE3             RESTORE RETURN REGISTER         20000000
         BR    R14                      RETURN                          20050000
         EJECT                                                          20100000
NOMORE   EQU   *                                                        20150000
         TM    LCBERBST,LCBDLNKN+LCBINQ ERB POSTABLE                    20200000
         BNZR  R14                      BRANCH NO                       20250000
         OI    LCBERBST,LCBINQ          SET ERB ENQUEUED                20300000
         MVI   LCBERBPY,PRIDSKBF        AND PRIORITY                    20350000
         LA    R1,LCBERB                SET ADDRESS ELEMENT TO          20400000
         LA    RQCB,AVTBFRTB            BE ENQUEUED AND CHAIN           20450000
         B     DSPPRIOR                 ENQUEUE ERB ON BUFFER           20500000
*                                       RETURN QCB AND RETURN TO        20550000
*                                       ADDRESS IN R14                  20600000
         EJECT                                                          20650000
MESSAGES EQU   *                                                        20700000
         USING TSB,RTSB                                                 20750000
         ST    R14,AVTSAVE3             SAVE RETURN REGISTER            20800000
         L     RSCB,LCBSCBA-1           LOAD SCB ADDRESS                20850000
         L     RQCB,SCBDESTQ-1          AND QCB ADDRESS                 20900000
         BAL   R14,TSBADDR              GET TSB-TJB ADDRESS             20950000
         TM    GMFLAG,GMENCON           INSERT ENDING CONTROL ONLY      21000000
         BO    EDITPREP                 BRANCH YES                      21050000
         NC    LCBLSPCI,LCBLSPCI        INITIAL ERB POST                21100000
         BNZ   GETTPUT                  BRANCH NO                       21150000
         MVI   LCBERBPY,PRIINTRQ        RESET INITIAL PRIORITY          21200000
         OI    GMFLAG,GMINIT            AND INITIAL ENTRY FOR EDIT      21250000
GETTPUT  EQU   *                                                        21300000
         USING TIOCBUF,R5                                               21350000
         QTIP  BAKER,(R13)              TSO MESSAGE TO TRAILER QUEUE    21400000
         L     R5,TSBOTBFP-1            LOAD TSBUFFER ADDRESS           21450000
         LTR   R15,R15                  ANY TPUT AVAILABLE              21500000
         BZ    PREEND                   BRANCH NONE                     21550000
         L     RSCB,LCBSCBA-1           LOAD SCB ADDRESS       @OZ30811 21560086
         NI    SCBSRCE-IEDQSCB(RSCB),X'3F' TURN OFF NOINC & BYP@OZ30811 21570086
         LA    R5,AVTEZERO(,R5)         CLEAR HIGH ORDER BYTE           21600000
         ST    R5,GMTSBUF               SAVE TSO BUFFER ADDRESS         21650000
         SR    R0,R0                    CLEAR WORK                      21700000
         SR    R15,R15                  REGISTERS                       21750000
         IC    R0,BUFFLNTH              GET DATA LENGTH                 21800000
QUESCAN  EQU   *                                                        21850000
         CLC   BUFFTRLR,AVTFZERO        END OF TRAILER QUEUE            21900000
         BE    SENDON                   BRANCH YES                      21950000
         L     R5,BUFFTRLR-1            GET NEXT BUFFER                 22000000
         LTR   R0,R0                    TEST ACCUMULATED LENGTH         22050000
         BNZ   SKIPSET                  BRANCH NOT ZERO                 22100000
         LA    R5,AVTEZERO(,R5)         CLEAR HIGH ORDER BYTE           22150000
         ST    R5,GMTSBUF               SET TRANSMIT BUFFER ADDRESS     22200000
SKIPSET  EQU   *                                                        22250000
         IC    R15,BUFFLNTH             GET CURRENT DATA LENGTH         22300000
         AR    R0,R15                   ADD TO ACCUMULATED COUNT        22350000
         B     QUESCAN                  CONTINUE QUEUE SCAN             22400000
         DROP  R5                                                       22450000
         EJECT                                                          22500000
SENDON   EQU   *                                                        22550000
         TM    TSBFLG3,TSBTJMSG         MESSAGE NONFLUSHABLE            22600000
         BO    EDITPREP                 BRANCH YES                      22650000
         TM    TSBFLG1,TSBOFLSH         CLEAR OUTPUT TRAILER QUEUE      22700000
         BNO   EDITPREP                 BRANCH NO                       22750000
         SR    R15,R15                  CLEAR RETURN REGISTER           22800000
         QTIP  CHARLIE,(R13)            CLEAR OUTPUT TRAILER QUEUE      22850000
         LA    R0,AVTBFRTB              LOAD BUFFER RETURN              22900000
         ST    R0,AVTDOUBL+4            ADDRESS                         22950000
         MVC   AVTDOUBL+4(3),AVTDOUBL+5 JUSTIFY                         23000000
         MVI   AVTDOUBL+7,PRIBFRTB      SET PRIORITY                    23050000
         BAL   R14,POSTALL              FREE ALL BUFFERS                23100000
         B     POSTLCB                  POST LCB TO ITSELF              23150000
         EJECT                                                          23200000
EOSCREEN EQU   *                                                        23250000
         TM    TSBFLG2,TSBBIPI          PARTIAL LINE                    23300000
         BNO   PREEND                   BRANCH NO                       23350000
         TM    TSBSTAT,TSBDSPLY         FLASHBACK MESSAGE               23400000
         BO    PREEND                   BRANCH YES                      23450000
         OI    QCBFLAG,QCBREAD          SET READ PRIORITY               23500000
         B     ENDCON                   START SENDING                   23550000
PREEND   EQU   *                                                        23600000
         CLC   TSBOBFP,AVTFZERO         MORE TSO MESSAGES               23650000
         BNE   ENDCON                   BRANCH YES                      23700000
         TM    TSBFLG2,TSBAUTON         AUTOPROMPT REQUESTED            23750000
         BZ    ENDCON                   BRANCH NO                       23800000
         TM    QCBTSOF1,QCBPARTO        REST OF MESSAGE COMING          23850000
         BO    ENDCON                   BRANCH YES                      23900000
         TM    TSBFLG3,TSBSPIT          TCLEARQ IN PROGRESS             23950000
         BO    ENDCON                   BRANCH YES                      24000000
         OI    SCBERR2,SCBALN           REQUEST AUTO PROMPTING          24050000
         SPACE 5                                                        24100000
ENDCON   EQU   *                                                        24150000
         USING IHADCB,RDCB                                              24200000
         CLI   LCBERBPY,PRIINTRQ        INITIAL OR PCI ERB              24250000
         BE    INITIALL                 BRANCH INITIAL                  24300000
         OI    GMFLAG,GMENCON           ORDER ENDING CONTROL            24350000
         B     EDITPREP                 INSERTION                       24400000
INITIALL EQU   *                                                        24450000
         TM    GMFLAG,GMINIT            FIRST PASS                      24500000
         BO    NOTPUTS                  BRANCH NO                       24550000
         L     RDCB,LCBDCBPT            LOAD DCB ADDRESS                24600000
         MVI   LCBERBCT+1,AVTEZERO      CLEAR REQUESTED COUNT           24650000
         OI    GMFLAG,GMENCON           ORDER ENDING CONTROL            24700000
         EJECT                                                          24750000
EDITPREP EQU   *                                                        24800000
         L     R15,TSI3270              LOAD ADDRESS IEDAYQ             24850000
         BALR  R14,R15                  AND GO EDIT DATA                24900000
         NI    GMFLAG,AVTEFF-GMINIT     RESET INITIAL FLAG              24950000
         OI    LCBERBST,LCBEOMSG        SET END OF MESSAGE              25000000
         TM    GMFLAG,GMENCIN           ENDING CONTROL INSERTED         25050000
         BO    SENDMSG                  BRANCH YES                      25100000
         NI    LCBERBST,AVTEFF-LCBEOMSG RESET END OF MESSAGE            25150000
         LTR   R15,R15                  END OF SCREEN REACHED           25200000
         BZ    EOSCREEN                 BRANCH YES                      25250000
         BP    GETTPUT                  BRANCH TO GET NEW TPUT          25300000
*                                       SINCE BUFFERS NOT FULL          25350000
*                                       IF BUFFERS FULL, SEND           25400000
         EJECT                                                          25450000
SENDMSG  EQU   *                                                        25500000
         USING IEDQPRF,RPRF                                             25550000
         L     RDCB,LCBDCBPT            LOAD DCB ADDRESS                25600000
         OI    LCBTSOB,LCBTSBUF         SET TSO TRANSMISSION            25650000
         TM    DCBDSORG,TRMLGB          NCP CONNECTED TERMINAL          25700000
         BNO   NOTLGB                   BRANCH NO                       25750000
         XC    AVTDOUBL+4(4),AVTDOUBL+4 RETURN                          25800000
         BAL   R14,POSTALL              UNFILLED BUFFERS                25850000
         CLI   LCBERBPY,PRIINTRQ        INITIAL ERB POST                25900000
         BNE   NCPPOST                  BRANCH NO                       25950000
         TM    DCBPCI,DYNMBFR           PCI ON SEND                     26000000
         BO    NCPPOST                  BRANCH YES                      26050000
         L     RPRF,GMCRBUF             GET FINAL BUFFER                26100000
         NI    PRFSTAT1,PRFNLSTF        SET BUFFER AS LAST              26150000
NCPPOST  EQU   *                                                        26200000
         L     R9,AVTSAVTP              GET SECONDARY AVT               26250000
         USING IEDNSVTD,R9                                              26300000
         L     R9,SAVTCNIR              LOAD OUTPUT DATA                26350000
         DROP  R9                       HANDLER QCB                     26400000
         MVI   LCBERBPY,PRIACTIV        SET POST PRIORITY               26450000
         ST    R9,LCBERB                STORE QCB ADDRESS               26500000
         LA    R1,LCBERB                SET ELEMENT ADDRESS             26550000
         OI    LCBERBST,LCBDLNKN        ERB POSTABLE                    26600000
         BAL   R14,DSPPOST              POST ERB               @G36XRYP 26650000
NOTLGB   EQU   *                                                        26700000
         L     RPRF,LCBERBCH-1          GET MESSAGE ADDRESS             26750000
         CLI   LCBERBPY,PRIINTRQ        INITIAL OR PCI POST             26800000
         BNE   PCIERB                   BRANCH PCI                      26850000
         XC    AVTDOUBL+4(4),AVTDOUBL+4 RETURN                          26900000
         BAL   R14,POSTALL              UNFILLED BUFFERS                26950000
         TM    DCBPCI,DYNMBFR           PCI ON SEND                     27000000
         BO    POSTERB                  BRANCH YES                      27050000
         L     RPRF,GMCRBUF             GET FINAL BUFFER                27100000
         NI    PRFSTAT1,PRFNLSTF        SET BUFFER AS LAST              27150000
POSTERB  EQU   *                                                        27200000
         LA    R9,AVTACTIB              GET ADDRESS ACTIVATE            27250000
         ST    R9,LCBERB                QCB                             27300000
         MVI   LCBERBPY,PRIACTIV        SET POST PRIORITY               27350000
         LA    R1,LCBERB                SET ELEMENT ADDRESS             27400000
         OI    LCBERBST,LCBDLNKN        ERB POSTABLE                    27450000
         BAL   R14,DSPPOST              POST ERB TO ACTIVATE   @G36XRYP 27500000
PCIERB   EQU   *                                                        27550000
         MVC   AVTDOUBL+4(3),DCBMH      LOAD QCB ADDRESS                27600000
         MVI   AVTDOUBL+7,PRIMHBFR      LOAD POST PRIORITY              27650000
         BAL   R14,POSTALL              POST ALL BUFFERS TO             27700000
*                                       THE STARTMH QCB AND             27750000
*                                       FREE UNUSED BUFFER UNITS        27800000
         XC    LCBERBCH,LCBERBCH        CLEAR ERBCHAIN                  27850000
         TM    LCBERBST,LCBEOMSG+LCBINQ IF EOM OR ERB ENQUEUED NO       27900000
         BNZ   DSPDISP                  NEED TO CHECK ERB COUNT         27950000
         BAL   R14,TERMMAIN             CLEAR EDIT                      28000000
         BAL   R14,SETGMAIN             WORK AREA                       28050000
         SR    RPRF,RPRF                CLEAR BUFFER BASE               28100000
         L     R14,AVTSAVE3             LOAD RETURN ADDRESS             28150000
         BR    R14                      RETURN                          28200000
         EJECT                                                          28250000
NOTPUTS  EQU   *                                                        28300000
         LA    R0,AVTBFRTB              LOAD BUFFER RETURN              28350000
         ST    R0,AVTDOUBL+4            QCB ADDRESS                     28400000
         MVC   AVTDOUBL+4(3),AVTDOUBL+5 JUSTIFY ADDRESS                 28450000
         MVI   AVTDOUBL+7,PRIBFRTB      AND PRIORITY                    28500000
         BAL   R14,POSTALL              RETURN BUFFERS                  28550000
         BAL   R14,TSBADDR              GET TSB ADDRESS                 28600000
         SR    R9,R9                    CLEAR RETURN REGISTER           28650000
         ST    R9,AVTDOUBL+4            CLEAR RETURN CODE      @OZ30295 28670086
         TM    TSBSTAT,TSBDISC          USER BEING LOGGED OFF           28700000
         BNO   BREAK                    BRANCH NO                       28750000
         TM    TSBFLG4,TSBOCAB          OUT OF CORE ABEND      @G36XRYP 28800000
         BZ    BREAK                    BRANCH NO              @OZ30295 28850086
         LA    R9,OCABMSK               SET OUTOFCORE MASK              28900000
         B     PASTLCB                  CHECK FOR CLEANUP               28950000
BREAK    EQU   *                                                        29300000
         TM    QCBTSOF2,QCBBUFQ         TSINPUT HOLDING BUFFERS         29350000
         BO    POSTLCB                  BRANCH YES                      29400000
         TM    TSBFLG3,TSBSPIT          TCLEARQ IN PROGRESS             29450000
         BO    POSTLCB                  BRANCH YES                      29500000
         TM    QCBTSOF1,QCBPARTO        MORE MESSAGES                   29550000
         BO    POSTLCB                  BRANCH YES                      29600000
         TM    TSBFLG2,TSBBRKIN         BREAKIN                         29650000
         BO    PASTLCB                  BRANCH YES                      29700000
POSTLCB  EQU   *                                                        29750000
         QTIP  TEN,(R13)                RESET QCBTPUT AND QCBWRBRK      29800000
*                                       POST THE LCB TO ITSELF          29850000
         ST    R15,AVTDOUBL+4           SAVE RETURN CODE                29900000
         BCTR  R9,0                     INDICATE QTIP 10                29950000
PASTLCB  EQU   *                                                        30000000
         TM    TSBSTAT,TSBDISC          USER BEING LOGGED OFF           30050000
         BNO   BREAKER                  BRANCH NO                       30100000
         QTIP  EASY,(R13)               CLEAR TSO CONTROL BLOCKS        30150000
         TM    LCBINSRC+2,DELAY         LCB ON TIME DELAY QUEUE         30200000
         BNO   PASTRLCB                 BRANCH NO                       30250000
         LR    R1,RLCB                  LOAD ADDRESS LCB                30300000
         L     R15,AVTHG02              TIME DELAY REMOVAL              30350000
         BALR  R14,R15                  REMOVE LCB                      30400000
         LR    R15,R3                   SAVE                            30450000
         LR    RPRF,RQCB                REGISTERS                       30500000
         LA    RQCB,LCBRSKEY            LOAD STCB ADDRESS               30550000
         LR    R1,RQCB                  LOAD STCB ADDRESS               30600000
         BAL   R14,DSPPRIOR             PUT RECEIVE SCHEDULER IN LCB    30650000
         LR    R3,R15                   RESTORE                         30700000
         LR    RQCB,RPRF                REGISTERS                       30750000
PASTRLCB EQU   *                                                        30800000
         NI    LCBTSOB,AVTEFF-LCBTSBUF-LCBSATRD-LCBCIRCD RESET          30850000
         MVI   LCBSENS0,AVTEZERO        LCB FIELDS                      30900000
         NI    QCBFLAG,AVTEFF-QCBREAD   RESET                           30950000
         NI    QCBDSFLG,AVTEFF-QCBALTMH QCB                             31000000
         MVI   QCBRETCT,AVTEZERO        FIELDS                          31050000
         MVI   QCBCARCT,AVTEZERO        TO END                          31100000
         XC    QCBTJID,QCBTJID          TSO                             31150000
         XC    QCBINSRC,QCBINSRC        SESSION                         31200000
BREAKER  EQU   *                                                        31250000
         L     R15,AVTDOUBL+4           RESTORE RETURN CODE             31300000
         LTR   R15,R15                  RETURN CODE ZERO                31350000
         BNZ   AUTOPRMT                 BRANCH NO                       31400000
         LTR   R9,R9                    QTIP POST LCB                   31450000
         BP    GOMSGGEN                 NO, SEND LOGOFF MESSAGE         31500000
         BZ    CHKBRKIN                 BRANCH TO CHECK BREAK           31550000
         SR    R0,R0                    CLEAR                           31600000
         ST    R0,SCBERRST              ALL                             31650000
         ST    R0,SCBDEOB               CONTROL                         31700000
         STH   R0,SCBEOB                BLOCKS                          31750000
         MVI   LCBSENS0,AVTEZERO        AND                             31800000
         ST    R0,LCBERBCH-1            FIELDS                          31850000
         XC    LCBLSPCI,LCBLSPCI        BEFORE                          31900000
         NI    LCBCHAIN,AVTEFF-LCBBFRSZ-LCBABRTN-LCBEXCP                31950000
         NI    LCBTSOB,AVTEFF-LCBTSBUF-LCBINHBN-LCBWRBRK                32000000
         NI    LCBSTAT2,LCBMSGNF        RETURNING                       32050000
         NI    LCBSTAT1,AVTEFF-LCBRCLLN TO                              32100000
         LA    R1,AVTINOUT              THE                             32150000
         STCM  R1,7,SCBMACR             DISPATCHER                      32200000
         LA    R1,AVTBFRTB              TERMINATING                     32250000
         STCM  R1,7,SCBDESTQ            THE SEND OPERATION              32300000
         B     DSPDISP                  BRANCH TO DISPATCHER            32350000
         EJECT                                                          32400000
CHKBRKIN EQU   *                                                        32450000
         QTIP  FOX,(R13)                TSO MESSAGE TO TRAILER QUEUE    32500000
         B     GETTPUT                  SEND REPROMPT                   32550000
         SPACE 5                                                        32600000
AUTOPRMT EQU   *                                                        32650000
         OI    SCBERR2,SCBALN           SET AUTO                        32700000
         LA    R9,AUTOMSK               LINE NUMBERING                  32750000
GOMSGGEN EQU   *                                                        32800000
         MVI   LCBSTAT1,LCBRECVN        SET FIELDS                      32850000
         LA    R1,AVTINOUT              TO                              32900000
         STCM  R1,7,SCBMACR             EXIT TO IEDAYM                  32950000
         LR    R8,R9                    TO OUTPUT                       33000000
         L     R12,TSIMSGEN             THE                             33050000
         SR    R1,R1                    REQUIRED                        33100000
         BR    R12                      TEXT                            33150000
         DROP  RTSB                                                     33200000
         EJECT                                                          33250000
CLEANUP  EQU   *                                                        33300000
         ST    R14,AVTSAVE3             SAVE RETURN REGISTER            33350000
         L     RTSI,AVTTSOPT            GET TSINPUT QCB ADDRESS         33400000
         ST    RQCB,AVTDOUBL            SAVE QCB AND                    33450000
         ST    R1,AVTDOUBL+4            ELEMENT ADDRESS                 33500000
         LA    RQCB,AVTEZERO(,RQCB)     CLEAR HIGH ORDER                33550000
         LA    R1,AVTEZERO(,R1)         FOR COMPARE                     33600000
         CR    RQCB,R1                  CPB CLEANUP QCB                 33650000
         BE    CPBCLNUP                 BRANCH CPB CLEANUP QCB          33700000
         LR    RPRF,R1                  SET BUFFER ADDRESS              33750000
         L     RLCB,PRFLCB-1            LCB                             33800000
         L     RSCB,LCBSCBA-1           SCB                             33850000
         L     RQCB,SCBDESTQ-1          AND QCB                         33900000
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN RECALLING OR RECEIVING        33950000
         BNZ   CPBCLNUP                 BRANCH YES                      34000000
         TM    QCBFLAG,QCBTSSES         TERMINAL IN TSO SESSION         34050000
         BNO   CPBCLNUP                 BRANCH NO                       34100000
         BAL   R14,TERMMAIN             GET DCT AND SET IN GMAIN        34150000
         TM    GMDEVCH+1,DCT3270        3270 TERMINAL          @G36XRYP 34200000
         BO    NEWCLEAN                 BRANCH YES                      34250000
         L     R3,TSIAYO02              LOAD IEDAYO02 ADDRESS           34300000
         L     R1,AVTDOUBL+4            RESTORE ELEMENT AND             34350000
         L     RQCB,AVTDOUBL            QCB ADDRESS                     34400000
         BAL   R14,DSPBYPAS             BYPASS TO IEDAYOO2     @G36XRYP 34450000
NEWCLEAN EQU   *                                                        34500000
         BAL   R14,SETGMAIN             INITIALIZE REST OF GMAIN        34550000
         NI    LCBERBST,AVTEFF-LCBINQ   MARK ERB NOT ENQUEUED           34600000
         TM    LCBERBST,LCBERROR        I/O ERROR                       34650000
         BO    RETURN                   BRANCH YES                      34700000
         TM    SCBERR3,SCBATTN          ATTENTION RECEIVED              34750000
         BO    RETURN                   BRANCH YES                      34800000
         L     R14,AVTSAVE3             RESTORE RETURN REGISTER         34850000
         TM    AVTBIT3,AVTTSAB          TSO ABENDING                    34900000
         BNOR  R14                      BRANCH NO                       34950000
         NC    LCBLSPCI,LCBLSPCI        INITIAL ERB POST                35000000
         BZ    RETURN                   BRANCH YES                      35050000
         OI    GMFLAG,GMENCON           SET FOR ENDING CONTROL          35100000
         BR    R14                      GO TO EDIT FOR ENDING CONTROL   35150000
RETURN   EQU   *                                                        35200000
         MVC   LCBERBQB,LCBRCQCB+1      SET RECALL QCB ADDRESS          35250000
         ST    RPRF,LCBERBLK-1          LINK BUFFER TO ERB              35300000
         MVI   LCBERBPY,PRIRCQCB        SET ERB PRIORITY                35350000
         LA    R1,AVTBFRTB              LOAD BUFFER RETURN QCB          35400000
         ST    R1,PRFQCBA-1             ADDRESS                         35450000
         MVI   PRFPRI,PRIBFRTB          SET POST PRIORITY               35500000
         XC    PRFLINK,PRFLINK          CLEAR LINK FOR POST             35550000
         LA    R1,LCBERB                LOAD ELEMENT ADDRESS            35600000
         BAL   R14,DSPCHAIN             POST ELEMENTS          @G36XRYP 35650000
CPBCLNUP EQU   *                                                        35700000
         L     R3,TSICPBC               GET CPB CLEANUP STCB            35750000
         L     R1,AVTDOUBL+4            RESTORE ELEMENT AND             35800000
         L     RQCB,AVTDOUBL            QCB ADDRESS                     35850000
         BAL   R14,DSPBYPAS             BYPASS TO CPB CLEANUP  @G36XRYP 35900000
         EJECT                                                          35950000
POSTALL  EQU   *                                                        36000000
         ST    R14,AVTSAVE3+4           SAVE RETURN ADDRESS             36050000
         ST    RQCB,AVTSAVE3+8          SAVE QCB AND                    36100000
         ST    RSCB,AVTSAVE3+12         SCB BASES                       36150000
         LA    R15,DSPPOSTR             SET DESTINATION FOR             36200000
         NC    AVTDOUBL+4(4),AVTDOUBL+4 RETURN OF UNFILLED BUFFERS      36250000
         BNZ   POSTMOST                 FOR ERB AND BUFFER              36300000
         LA    R15,COMEBACK             POSTS                           36350000
POSTMOST EQU   *                                                        36400000
         L     RPRF,LCBERBCH-1          GET FIRST BUFFER UNIT           36450000
NEWPREF  EQU   *                                                        36500000
         SR    R0,R0                    CLEAR COUNT REGISTER            36550000
         IC    R0,PRFNBUNT              GET BUFFER UNIT COUNT           36600000
         LR    R1,RPRF                  SAVE PREFIX ADDRESS             36650000
         MVC   PRFQCBA(4),AVTDOUBL+4    SET QCB ADDRESS AND PRIORITY    36700000
NEWUNIT  EQU   *                                                        36750000
         LR    R5,RPRF                  SAVE LAST UNIT ADDRESS          36800000
         L     RPRF,PRFTIC              GET NEXT                        36850000
         BCT   R0,NEWUNIT               UNIT                            36900000
         N     R5,FOXDOG                REMOVE TIC AND 02               36950000
         MVC   8(4,R5),INVLDTIC         SET INVALID TIC                 37000000
         N     RPRF,FOXDOG              REMOVE TIC AND 02               37050000
         BALR  R14,R15                  POST BUFFER OR BRANCH           37100000
COMEBACK EQU   *                                                        37150000
         LTR   RPRF,RPRF                END OF CHAIN                    37200000
         BZ    ALLBUF                   BRANCH YES                      37250000
         C     R5,GMCRUNT               REACH CURRENT BUFFER            37300000
         BNE   NEWPREF                  BRANCH NO                       37350000
         LA    R15,DSPPOSTR             SET DESTINATION TO POST         37400000
         LA    R0,AVTBFRTB              LOAD BUFFER RETURN              37450000
         ST    R0,AVTDOUBL+4            QCB ADDRESS                     37500000
         MVC   AVTDOUBL+4(3),AVTDOUBL+5 JUSTIFY ADDRESS                 37550000
         MVI   AVTDOUBL+7,PRIBFRTB      SET POST PRIORITY               37600000
         B     NEWPREF                  POST REST OF BUFFERS            37650000
ALLBUF   EQU   *                                                        37700000
         L     RQCB,AVTSAVE3+8          RELOAD QCB AND                  37750000
         L     RSCB,AVTSAVE3+12         SCB BASES                       37800000
         L     R14,AVTSAVE3+4           RESTORE RETURN ADDRESS          37850000
         BR    R14                      RETURN                          37900000
         EJECT                                                          37950000
PREGMAIN EQU   *                                                        38000000
         USING TSB,RTSB                                                 38050000
         USING IEDQSCB,RSCB                                             38100000
         USING IEDQTRM,R1                                               38150000
         USING IEDQTNTD,R15                                             38200000
         ST    R14,AVTSAVE3+4           SAVE RETURN REGISTER            38250000
         XC    TSIGMAIN(GMXTNT),TSIGMAIN CLEAR EDIT WORK AREA           38300000
         TM    AVTBIT3,AVTTSAB          TSO ABENDING                    38350000
         BO    ABGONE                   BRANCH YES                      38400000
         BAL   R14,TSBADDR              GET TSB ADDRESS                 38450000
         LH    R5,TSBASRCE              GET CONNECTED INDEX             38500000
         LR    R1,R5                    SET CONNECTED REGISTER          38550000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER BYTES          38600000
         L     R15,AVTRNMPT             LOAD TNT ADDRESS                38650000
         BALR  R14,R15                  GET TTE ADDRESS                 38700000
         B     CONNECT                  SET CONNECTED TERMINAL          38750000
ABGONE   EQU   *                                                        38800000
         L     R15,AVTRNMPT             LOAD TNT ADDRESS                38850000
         LH    R5,TNTLEN                GET LARGEST INDEX               38900000
         N     R5,AVTCLRHI              CLEAR HIGH ORDER BYTES          38950000
TTABLE   EQU   *                                                        39000000
         LR    R1,R5                    LOAD INDEX                      39050000
         BALR  R14,R15                  GET TTE ADDRESS                 39100000
         CLC   TRMDESTQ,SCBDESTQ        CORRECT TERMINAL                39150000
         BE    CONNECT                  BRANCH YES                      39200000
         BCT   R5,TTABLE                CONTINUE SEARCHING              39250000
CONNECT  EQU   *                                                        39300000
         STH   R5,LCBTTBIN              STORE CONNECTED                 39350000
         STH   R5,LCBTTCIN              INDEX                           39400000
         LA    R15,TRMPRFSZ             TTE PREFIX SIZE        @ZM47738 39406000
         LR    R14,R1                   COPY TTE ADDRESS       @ZM47738 39412000
         SLR   R14,R15                  POINT TO TTE PREFIX    @ZM47738 39418000
         USING IEDNTRM,R14              SET ADDRESSABILITY     @ZM47738 39424000
         L     R15,AVTSAVTP             GET SECONDARY AVT      @Z37XBYK 39426000
         USING IEDNSVTD,R15                                    @Z37XBYK 39428000
**********     COPY DCT ENTRY FOR THIS DEVICE                  @ZM47738 39430000
         IEDDCT REG=R5,FLD=GMDEVCH,LEN=6                       @ZM47738 39436000
         SPACE                                                          39442000
         L     R14,AVTSAVE3+4           RESTORE RETURN REGISTER         39800000
         BR    R14                      RETURN                          39850000
         DROP  R15                                             @Z37XBYK 39870000
         EJECT                                                          39900000
TERMMAIN EQU   *                                                        39950000
         ST    R14,AVTSAVE3+4           SAVE RETURN REGISTER            40000000
         XC    TSIGMAIN(GMXTNT),TSIGMAIN CLEAR EDIT WORK AREA           40050000
         LH    R1,LCBTTCIN              LOAD CONNECTED INDEX            40100000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER BYTES          40150000
         L     R15,AVTRNMPT             LOAD TNT ADDRESS                40200000
         BALR  R14,R15                  GET TTE ADDRESS                 40250000
         LA    R15,TRMPRFSZ             TTE PREFIX SIZE        @ZM47738 40258000
         LR    R14,R1                   COPY TTE ADDRESS       @ZM47738 40266000
         SLR   R14,R15                  TTE PREFIX             @ZM47738 40274000
         L     R15,AVTSAVTP             GET SECONDARY AVT      @Z37XBYK 40276000
         USING IEDNSVTD,R15                                    @Z37XBYK 40278000
**********     COPY DCT FOR THIS DEVICE                        @ZM47738 40282000
         IEDDCT REG=R5,FLD=GMDEVCH,LEN=6                       @ZM47738 40290000
         L     R14,AVTSAVE3+4           RESTORE RETURN ADDRESS          40650000
         BR    R14                      RETURN                          40700000
         DROP  R14                                             @ZM47738 40720000
         DROP  R15                                             @Z37XBYK 40730000
         EJECT                                                          40750000
SETGMAIN EQU   *                                                        40800000
         USING IHADCB,RDCB                                              40850000
         ST    R14,AVTSAVE3+4           SAVE RETURN ADDRESS             40900000
         TM    TRMDEVFL,TRMBUFSZ        BUFSIZE ON TERMINAL             40950000
         BO    USETERM                  BRANCH YES                      41000000
         L     RDCB,LCBDCBPT            LOAD DCB ADDRESS                41050000
         LH    R5,DCBBUFSI              GET BUFSIZE                     41100000
         STH   R5,GMBFSIZE              AND SAVE IN GMAIN               41150000
         B     CNTBFUNT                 COUNT UNITS                     41200000
USETERM  EQU   *                                                        41250000
         LA    R5,TRMOPNO+1             LOCATE                          41300000
         TM    TRMSTATE,TRMOPTFN        BUFSIZE                         41350000
         BNO   NOOPTION                 IN                              41400000
         SR    R5,R5                    TERMINAL                        41450000
         IC    R5,TRMOPNO               ENTRY DEVICE                    41500000
         LA    R5,TRMOPT+1(R5)          DEPENDENT FIELD                 41550000
NOOPTION EQU   *                                                        41600000
         MVC   GMBFSIZE(2),AVTEZERO(R5) SAVE BUFSIZE IN GMAIN           41650000
         LH    R5,GMBFSIZE              LOAD BUFSIZE                    41700000
CNTBFUNT EQU   *                                                        41750000
         SR    R15,R15                  CLEAR WORK REGISTER             41800000
COUNTON  EQU   *                                                        41850000
         LA    R15,1(,R15)              COUNT ONE UNIT                  41900000
         SH    R5,AVTKEYLE              REDUCE BY KEYLENGTH             41950000
         BP    COUNTON                  BUFFER > KEYLENGTH              42000000
         STH   R15,GMBFUNIT             SAVE UNITS PER BUFFER           42050000
         MVC   GMCARCT+1(1),QCBCARCT    SAVE CARRIAGE COUNT             42100000
         MVC   GMSATCT+1(1),QCBSATCT    AND LINE COUNT                  42150000
         BAL   R14,TSBADDR              GET TSB ADDRESS                 42200000
         SR    R5,R5                    CLEAR WORK REGISTER             42250000
         IC    R5,TSBLNSZ               GET LINE SIZE                   42300000
         LTR   R5,R5                    LINE SIZE SPECIFIED             42350000
         BNZ   SPCLNSZ                  BRANCH YES                      42400000
         LA    R5,40                    USE DEFAULT LINE SIZE           42450000
SPCLNSZ  EQU   *                                                        42500000
         STC   R5,GMLNSZ                SAVE LINE SIZE                  42550000
         IC    R5,TSBLNNO               NUMBER OF LINES                 42600000
         LTR   R5,R5                    SPECIFIED                       42650000
         BNZ   SPCLNNO                  BRANCH YES                      42700000
         LA    R5,12                    USE DEFAULT NUMBER OF LINES     42750000
SPCLNNO  EQU   *                                                        42800000
         STC   R5,GMLNNO                SAVE NUMBER OF LINES            42850000
         L     R14,AVTSAVE3+4           RESTORE RETURN ADDRESS          42900000
         BR    R14                      RETURN                          42950000
         DROP  RDCB                                                     43000000
         EJECT                                                          43100000
TSBADDR  EQU   *                                                        43150000
         USING CVT,R10                                                  43200000
         L     R10,CVTPTR               LOAD CVT ADDRESS                43250000
         L     RTSB,CVTASVT             GET ASVT ADDRESS       @G36XRYP 43300000
         DROP  RTSB                                            @G36XRYP 43350000
         USING ASVT,RTSB                ASVT ADDRESSABILITY    @G36XRYP 43400000
         LH    R15,QCBTJID              GET ASID               @G36XRYP 43450000
         BCTR  R15,0                    DECREMENT BY 1 FOR     @G36XRYP 43500000
*                                       ZERO ORIGIN            @G36XRYP 43550000
         SLL   R15,2                    MULTIPLY BY 4 FOR      @G36XRYP 43600000
*                                       INTO ASCB ADDR LIST    @G36XRYP 43650000
         LA    RTSB,ASVTENTY            GET ASCB LIST ADDRESS  @ZM47673 43700000
         L     RTSB,AVTEZERO(R15,RTSB)  GET ASCB ADDRESS       @ZM47673 43710000
         DROP  RTSB                                            @G36XRYP 43750000
         USING ASCB,RTSB                ASCB ADDRESSABILITY    @G36XRYP 43800000
         L     RTSB,ASCBTSB             GET TSB ADDRESS        @G36XRYP 43850000
         L     R15,CVTAQAVT             GET TCX ADDRESS        @G36XRYP 43900000
         USING IEDQTCX,R15              TCX ADDRESSABILITY     @G36XRYP 43950000
         L     R10,TCXRPT               GET TIOCRPT ADDRESS    @G36XRYP 44000000
         DROP  RTSB                                            @G36XRYP 44050000
         DROP  R15                                             @G36XRYP 44100000
         BR    R14                      RETURN TO CALLER                44150000
         EJECT                                                          44200000
PATCH    DC    30F'0'                   PATCH AREA             @OZ28765 44250000
FOXDOG   DC    X'00FFFFFD'              MASK TO AND OFF INVALID TIC     44300000
INVLDTIC DC    X'08000002'              INVALID TIC CCW                 44350000
AUTOMSK  DC    X'01088000',A(AUTOLNNO)  AUTOLINENO MASK                 44400000
ABNDMSK  DC    X'01088000',A(ABENDMSG)  ABEND MESSAGE MASK              44450000
OCABMSK  DC    X'01088000',A(OCABMSG)   OUT OF CORE ABEND MASK          44500000
RNAVMSK  DC    X'01088000',A(RNAVMSG)   REGION NOT AVAILABLE MASK       44550000
AUTOLNNO DC    X'01FF'                  AUTO LINE NUMBER                44600000
ABENDMSG DC    AL1(L'MABEND+1)          ABEND MESSAGE LENGTH            44650000
MABEND   DC    C'IKJ54001I SYSTEM FAILURE - ALL USERS TERMINATED'       44700000
         DC    X'15'                    NEW LINE                        44750000
OCABMSG  DC    AL1(L'MOCAB+1)                                           44800000
MOCAB    DC    C'IKJ54003I SYSTEM FAILURE - PLEASE LOGON AGAIN'         44850000
         DC    X'15'                    NEW LINE                        44900000
RNAVMSG  DC    AL1(L'MRNAV+1)           RNAV MESSAGE LENGTH             44950000
MRNAV    DC    C'IKJ54002I LOGON FAILED - RESOURCES NOT AVAILABLE NOW'  45000000
         DC    X'15'                    NEW LINE                        45050000
         EJECT                                                          45100000
         TAVTD                                                          45150000
         EJECT                                                          45200000
         TCCWD                                                          45250000
         EJECT                                                          45300000
         DCBD  DSORG=TX                                                 45350000
         EJECT                                                          45400000
         TDCTD                                                          45450000
         EJECT                                                          45500000
         TDISPD                                                         45550000
         EJECT                                                          45600000
         TLCBD                                                          45650000
         EJECT                                                          45700000
         TTNTD                                                          45750000
         EJECT                                                          45800000
         TTSID                                                          45850000
         EJECT                                                          45900000
         TPRFD                                                          45950000
         EJECT                                                          46000000
         TPRIOR                                                         46050000
         EJECT                                                          46100000
         TQCBD                                                          46150000
         EJECT                                                          46200000
         TSCBD                                                          46250000
         EJECT                                                          46300000
         TTCXD                                                          46350000
         EJECT                                                          46400000
         TTRMD                                                          46450000
         EJECT                                                          46500000
         CVT   DSECT=YES                                                46550000
         EJECT                                                          46600000
         IHAASCB                                                        46650000
         EJECT                                                          46700000
         IHAASVT                                                        46750000
         EJECT                                                          46800000
         IKJTIOCB                                                       46850000
         EJECT                                                          46900000
         IKJTIOCP                                                       46950000
         EJECT                                                          47000000
         IKJTSB                                                         47050000
         EJECT                                                          47060000
         TSIBD                                                 @ZM47738 47070000
         END                                                            47100000
