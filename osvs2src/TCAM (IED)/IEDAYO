         TITLE 'IEDAYO  -  TSO TIOC TSOUTPUT ROUTINE'                   00050000
IEDAYO   CSECT                                                          00100000
*                                                                       00150000
         ENTRY IEDAYO02                                                 00200000
*                                                                       00250000
*********************************************************************** 00300000
*        TCAM VERSION 10.0 CHANGES                             @G36XRYP 00350000
*A206500,899500,930500,963000,929500                           @G36XRYP 00360000
*C884500,891000,636000,636500                                  @G36XRYP 00370000
*D900000-903000,941500,945500,633500-634500                    @G36XRYP 00380000
*A216000,216500                                                @ZM45391 00390000
*A029500,066000,209500,213000,401000,749500,750000,925000      @Y17XAYP 00400000
*C141000,210000,213000,214500,235000,328000,663500,665500      @Y17XAYP 00450000
*C689500,727000-725000,730000                                           00500000
*D085500,663000,664000,665000,666000,111500-113000             @Y17XAYP 00550000
*D582000-582500                                                @OZ27272 00570000
*A903500                                                       @OZ32380 00570186
*                                                              @Y17XAYP 00600000
*        RA0034 CHANGES                                        @OY14092 00650000
*                                                              @OY14092 00700000
*                                                              @OY14092 00750000
*C694500                                                       @OY14092 00900000
*A831000                                                       @OY14089 00910000
*A207500                                                       @OY15030 00920000
*                                                                       00950000
*        VS2-017    PTF                                                 01000000
*0000466376,466616-466856                                      @YA13248 01050000
*0000474300-474600,477900-478300                               @YA11950 01100000
*0000478300                                                    @YA11722 01150000
*                                                                       01200000
*A780100-780200                                                 YA02104 01250000
*D596030-596110,596590-596630,596710-596990                     YM2814  01300000
*D669000                                                        YM2865  01350000
*                                                                     * 01400000
*          RELEASE 20 DELETIONS                                         01450000
*                                                                M3659  01500000
*                                                                M0271  01550000
*                                                                M1202  01600000
*0000                                                            TS1638 01650000
*                                                                TS1628 01700000
*                                                                M2655  01750000
*                                                                 M2701 01800000
*                                                                M3381  01850000
*                                                                M3546  01900000
*                                                                M4041  01950000
*                                                                 M4033 02000000
*                                                                M4694  02050000
*                                                                M4681  02100000
*                                                                 M4665 02150000
*                                                                 M1599 02200000
*                                                                 M5316 02250000
*                                                                 M5301 02300000
*                                                                 M6361 02350000
*          RELEASE 21 DELETIONS                                         02400000
*1332026000-026200,048000-049000,093100,101500-103700,104000-    S22029 02450000
*1332104600,200500-201500,203500-206000,207500,211000-265000,    S22029 02500000
*1332401500-402000,403000,405500-406000,407000,409500,412000-    S22029 02550000
*1332412500,441500,664300,690000-696000,740500-741500,756000,    S22029 02600000
*1332756200-756500,757500-758000,759000-760500,762000-764500,    S22029 02650000
*1332767000-768500,782000,902500                                 S22029 02700000
*1332210570-210920                                               M1193  02750000
*1332093100,594520-597000,610650-610670                          M0141  02800000
*1332093100,169400-169950,342000-342200,486200,669000            A44839 02850000
*1332                                                            A52381 02900000
*                        RELEASE 01 OF VS2 CHANGES              YA00526 02950000
*A513200-513420,516400-518060,529800-530280                     YA00526 03000000
*D516400-517600                                                 YA00526 03050000
*C530700                                                        YA00526 03100000
*                                                                       03150000
*        POST VS2-1.6 CHANGES                                           03200000
*0000093100,625500,625510                                      @YA11542 03250000
*D001200,003060,003240,176200-176700,176800,177700,186700       YA06038 03300000
*D346100,346400,346530,346890,675500,678100,873100,873400       YA06038 03350000
*C093100,475600                                                 YA06038 03400000
*0000787700                                                    @YA07902 03450000
*0000474010-474020,477710-477730                               @YA10025 03500000
*                                                                       03550000
************************************************************** @Y17XAYP 03600000
* MODULE NAME = IEDAYO (TCAM,TSO)                              @Y17XAYP 03650000
*                                                              @Y17XAYP 03700000
* DESCRIPTIVE NAME = TIME SHARING OUTPUT ROUTINE               @Y17XAYP 03750000
*                                                              @Y17XAYP 03800000
* COPYRIGHT = NONE                                             @Y17XAYP 03850000
*                                                              @Y17XAYP 03900000
* STATUS = VERSION 10.0                                        @G36XRYP 03950000
*                                                                       04000000
* FUNCTION -- THIS ROUTINE IS RESPONSIBLE FOR SUPERVISING THE           04050000
*    MOVEMENT OF DATA FROM TSO BUFFERS TO TCAM BUFFERS.  IT MUST        04100000
*    OBTAIN AND FILL TCAM BUFFERS AS REQUIRED BY THE DATA.  AFTER       04150000
*    THE DATA IS SUCCESSFULLY SENT, THIS ROUTINE IS RESPONSIBLE         04200000
*    FOR RETURNING THE TSO BUFFERS TO THE AVAILABLE BUFFER QUEUE.       04250000
*                                                                       04300000
* ENTRY POINTS --                                                       04350000
*         IEDAYO - ENTERED FOR ONE OF THE FOLLOWING PURPOSES            04400000
*    (1) AN INITIAL REQUEST FOR TCAM BUFFER(S).                         04450000
*    (2) THE FIRST REQUEST ON THIS MESSAGE FROM THE PCI ROUTINE         04500000
*    FOR TCAM BUFFER(S).                                                04550000
*    (3) A SUBSEQUENT REQUEST FROM THE PCI ROUTINE FOR A TCAM BUFFER.   04600000
*    (4) A REQUEST TO REBUILD AND RESEND THE LAST OUTPUT MESSAGE        04650000
*    BECAUSE AN ERROR HAS OCCURRED.                                     04700000
*    (5) A REQUEST TO FREE TSO AND TCAM BUFFERS BECAUSE THE             04750000
*    ASSOCIATED MESSAGE HAS BEEN SUCCESSFULLY SENT.                     04800000
*                                                                       04850000
*         IEDAYO02 - ENTERED WHEN A REQUEST FOR A TCAM BASIC UNIT       04900000
*    BY THIS MODULE HAS BEEN SATISFIED.                                 04950000
*                                                                       05000000
* INPUT --                                                              05050000
*         IEDAYO -                                                      05100000
*    REG. 1 - ADDR OF ERB (PURPOSES 1 THRU 4 ABOVE) OR TCAM             05150000
*             BUFFER (PURPOSE 5 ABOVE).                                 05200000
*    REG. 3  - ADDR OF STCB                                             05250000
*    REG. 7  - ADDR OF DISK I/O QCB                                     05300000
*    REG. 11 - ADDR OF TCAM DISPATCHER                                  05350000
*    REG. 13 - ADDR OF AVTSAVE2                                         05400000
*    REG. 15 - ENTRY POINT ADDRESS                                      05450000
*                                                                       05500000
*         IEDAYO02 -                                                    05550000
*    REG. 1  - ADDR OF BASIC UNIT OR QCB                                05600000
*    REG. 3  - ADDR OF STCB                                             05650000
*    REG. 7  - ADDR OF CPB CLEANUP QCB                                  05700000
*    REG. 11 - ADDR OF TCAM DISPATCHER                                  05750000
*    REG. 13 - ADDR OF AVTSAVE2                                         05800000
*    REG. 15 - ENTRY POINT ADDRESS                                      05850000
*                                                                       05900000
* OUTPUT - WHEN A REQUEST FOR TCAM BUFFERS HAS BEEN SATISFIED,          05950000
*    TCAM BUFFER(S) CONTAINING OUTPUT DATA ARE TPOSTED TO THE ACTIVATE  06000000
*    ROUTINE (FOR INITIAL REQUESTS) OR TO THE MESSAGE HANDLER           06050000
*    (PCI REQUESTS).                                                    06100000
*                                                                       06150000
* EXTERNAL REFERENCES --                                                06200000
*         IEDAYOO - THIS IS THE MODULE CONTAINING THE QTIP ROUTINES     06250000
*    FOR TSOUTPUT.  THESE ROUTINES PERFORM FUNCTIONS WHICH MUST BE      06300000
*    DONE WITH A ZERO PROTECTION KEY OR DISABLED FOR INTERRUPTS.        06350000
*         IEDQFA - WHEN IEDAYO GAINS CONTROL AND THE TERMINAL INVOLVED  06400000
*    IS NOT IN A TIME-SHARING SESSION, CONTROL IS PASSED TO IEDQFA.     06450000
*         IEDQFQ - WHEN IEDAYO GAINS CONTROL AT ENTRY IEDAYO02 AND THE  06500000
*    TERMINAL INVOLVED IS NOT IN A TIME-SHARING SESSION, CONTROL IS     06550000
*    PASSED TO IEDQFQ.                                                  06600000
*         MSGGEN - IEDAYO EXITS TO MSGGEN TO PUT OUT TS ABENDING        06650000
*    LOGOFF AND AUTOMATIC PROMPTING MESSAGES.                           06700000
*         IEDAYE - IEDAYO BRANCHES TO IEDAYE TO EDIT THE OUTPUT         06750000
*    DATA AND TO DO THE ACTUAL MOVE OF THE DATA FROM TS TO TCAM         06800000
*    BUFFERS.  IEDAYE RETURNS TO IEDAYO WHEN DONE.                      06850000
*                                                                       06900000
* EXITS,NORMAL -- (NOTE, 'DSP-----' LABELS REFER TO ENTRY POINTS        06950000
*    IN THE TCAM DISPATCHER, SEE TDISPD DSECT).                         07000000
*         MSGGEN - TO PUT OUT TS ABENDING OR AUTOMATIC LINE             07050000
*    NUMBERING PROMPT MESSAGES.                                         07100000
*         DSPBYPAS - WHEN THIS MODULE GAINS CONTROL AND THE TERMINAL    07150000
*    IS NOT IN A TIME SHARING SESSION.                                  07200000
*         DSPDISP - WHEN IEDAYO GAINS CONTROL WITH A PCI REQUEST FOR    07250000
*    BUFFERS AND A HARDWARE ATTENTION HAS OCCURRED.                     07300000
*         DSPDISP - WHEN THERE IS NO OUTPUT.                            07350000
*         DSPPOST - WHEN INITIAL REQUEST FOR BUFFERS SATISFIED,         07400000
*    (ERB TPOSTED TO ACTIVATE QCB).                                     07450000
*         DSPPOST - WHEN PCI REQUEST FOR BUFFER(S) SATISFIED,           07500000
*    (ERB TPOSTED TO DATA NIR GENERATOR QCB)                   @Y17XAYP 07550000
*         DSPPOST - WHEN TCAM OUTPUT BUFFERS HAVE BEEN EDITED  @Y17XAYP 07600000
*    (TCAM BUFFER(S) TPOSTED TO THE MESSAGE HANDLER).                   07650000
*         DSPPOST - WHEN MESSAGE SUCCESSFULLY SENT AND EMPTIED TS       07700000
*    BUFFER(S) FREED, (TCAM BUFFER TPOSTED TO BUFFER RETURN QCB).       07750000
*         DSPDISP - WHEN TCAM BASIC UNITS ARE NOT AVAILABLE AND         07800000
*    THE ERB IS PUT IN ELEMENT CHAIN OF BUFFER RETURN QCB.              07850000
*                                                                       07900000
* EXITS,ERROR --                                                        07950000
*         DSPCHAIN - WHEN BASIC UNIT IS TPOSTED TO IEDAYO02             08000000
*    AND LCBERROR IS ON, (ERB POSTED TO RECALL, BASIC UNITS             08050000
*    TPOSTED TO BUFFER RETURN).                                         08100000
*         DSPCHAIN - WHEN BASIC UNIT TPOSTED TO IEDAYO02 AND            08150000
*    SCBATTN ON, (BASIC UNITS TPOSTED TO BUFFER RETURN).                08200000
*                                                                       08250000
* TABLES/WORK AREAS -- SEE REMARKS ACCOMPANYING DATA DEFINITION         08300000
*    STATEMENTS.                                                        08350000
*                                                                       08400000
* ATTRIBUTES - REUSABLE, REFRESHABLE                                    08450000
*                                                                       08500000
* CHARACTER CODE DEPENDENCY -- EXECUTION CHARACTER SET MUST BE SAME     08550000
*    AS CHARACTER SET USED AT ASSEMBLY TIME.  IN ADDITION, THE EBCDIC   08600000
*    REPRESENTATION OF THE 'NL' CHARACTER (X'15') IS USED IN CONSTANTS  08650000
*    IN THE CONSTANT SECTION.  EACH SUCH CONSTANT IS REMARKED           08700000
*    'NEW LINE CHARACTER'.                                              08750000
*                                                                       08800000
* NOTES -- NONE                                                         08850000
*                                                                       08900000
*                                                                       08950000
*********************************************************************** 09000000
*                                                                       09050000
*   REGISTER EQUATES                                                    09100000
*                                                                       09150000
*********************************************************************** 09200000
*                                                                       09250000
R0       EQU   0                        PARAMETER REGISTER              09300000
R1       EQU   1                        PARAMETER REGISTER              09350000
R2       EQU   2                        WORK REGISTER                   09400000
RBTU     EQU   2                        BTU POINTER                     09450000
*                                       RESOURCE I.D. IN TRM TABLE      09500000
R3       EQU   3                        REGISTER 3                      09550000
RSCB     EQU   3                        SCB REGISTER                    09600000
RLCB     EQU   4                        LCB REGISTER                    09650000
R5       EQU   5                                                        09700000
RPREF    EQU   6                        BUFFER REGISTER                 09750000
R6       EQU   6                                                        09800000
RQCB     EQU   7                        QCB REGISTER                    09850000
RTSB     EQU   8                        TSB REG.                        09900000
R8       EQU   8                                                        09950000
RPQ      EQU   9                        PRIORITY DESTINATION QCB        10000000
R9       EQU   9                                                        10050000
RDCB     EQU   10                       DCB REGISTER                    10100000
R10      EQU   10                       WORK REGISTER                   10150000
R11      EQU   11                                                       10200000
RBASE    EQU   12                       BASE REGISTER                   10250000
R12      EQU   12                                                       10300000
RSAVE    EQU   13                       ADDR OF AVTSAVE2                10350000
R14      EQU   14                       RETURN ADDRESS REGISTER         10400000
R15      EQU   15                       ENTRY POINT AND RETURN CODE     10450000
*                                       REGISTER                        10500000
*                                                                       10550000
*********************************************************************** 10600000
*                                                                       10650000
*   STCB FOR TSOUTPUT                                                   10700000
*                                                                       10750000
         DC    AL1(DSPMCPL8),AL3(0),A(0)  STCB FIELDS            S22029 10800000
*                                                                       10850000
*********************************************************************** 10900000
*                                                                       10950000
*   MASKS,EQU AND DISPLACEMENT                                          11000000
*                                                                       11050000
*********************************************************************** 11100000
*                                                                       11150000
NULL     EQU   0                        '0'                             11200000
TICCCW   EQU   X'08'                    COMMAND CODE = TIC              11250000
ONE      EQU   1                        '1'                             11300000
E2       EQU   2                        '2'                             11350000
E3       EQU   3                        '3'                             11400000
E4       EQU   4                        '4'                             11450000
TRMBUFSZ EQU   X'80'                    INDICATES BFR SIZE SPECIFIED    11500000
TWOIDLE  EQU   X'F2'                    CARRIAGE COUNT FOR 2 IDLES      11550000
E41      EQU   41                       '41'                            11600000
XXCTUSED EQU   X'80'                    INDICATE DISABLED COUNT IN USE  11650000
QCBNLCR  EQU   X'30'                    CARRIAGE POSITION FLAGS         11700000
QTIP1ST  EQU   11                       FIRST QTIP ENTRY CODE           11750000
QTIP2ND  EQU   12                       SECOND QTIP ENTRY CODE          11800000
QTIP3RD  EQU   13                       THIRD QTIP ENTRY CODE           11850000
QTIP4TH  EQU   14                       FOURTH QTIP ENTRY CODE          11900000
QTIP5TH  EQU   15                       FIFTH QTIP ENTRY CODE           11950000
QTIP6TH  EQU   16                       SIXTH QTIP ENTRY CODE           12000000
NOT      EQU   X'FF'                                                    12050000
BTUINHBN EQU   X'10'                    MODE BIT FOR 3705               12100000
STMONITR EQU   X'02'                    MODE BIT FOR 3705       YS06327 12150000
DYNMBFFR EQU   X'10'                    PCI (DYNAMIC BUFFERING)         12200000
E48      EQU   48                       DISPLACEMENT OF DECIMAL 48      12250000
DOEOM    EQU   X'08'                    IN QCBRETCT TO TELL EDT SA61765 12300000
*                                       TO PROCESS END OF MSG           12350000
E1       EQU   1                        CONSTANT                YS6327  12400000
ELEVEN   EQU   11                       NUMBER OF BITS TO TEST          12450000
*                                                                       12500000
*********************************************************************** 12550000
*                                                                       12600000
*   INITIALIZE DSECT ADDRESSABILITY                                     12650000
*                                                                       12700000
*********************************************************************** 12750000
*                                                                       12800000
         USING AVTSAVE2,RSAVE           INITIALIZE AVT ADDRESSABILITY   12850000
         USING IEDQLCB,RLCB             INITIALIZE LCB                  12900000
         USING IEDQSCB,RSCB             INITIALIZE SCB                  12950000
         USING IEDQPRF,RPREF            INITIALIZE BUFFER PREFIX        13000000
         USING IEDQPQCB,RPQ             INITIALIZE PRIORITY QCB         13050000
         USING IEDQDISP,R11             INITIALIZE DISPATCHER           13100000
         USING IEDQQCB,RQCB             INITIALIZE QCB                  13150000
         USING IEDQSTCB,R15             STCB                            13200000
         USING TSB,RTSB                 INITIALIZE TSB                  13250000
*                                                                       13300000
*********************************************************************** 13350000
*                                                                       13400000
TSOUTPUT EQU   *                                                        13450000
*                                                                       13500000
*********************************************************************** 13550000
*                                                                       13600000
*   FIRST ENTRY POINT                                                   13650000
*                                                                       13700000
*        INPUT - REG.1  - ADDR OF BFFR OR ERB                           13750000
*                REG.3  - ADDR OF STCB                                  13800000
*                REG.7  - ADDR OF DISK I/O QCB                          13850000
*                REG.11 - ADDR OF DISPATCHER                            13900000
*                REG.13 - ADDR OF AVTSAVE2                              13950000
*                REG.15 - ENTRY POINT                                   14000000
*                                                                       14050000
*        ELEMENT IS BFFR                                                14100000
*              1 - PRI=PRIDKSRV - NORMAL END OF SEND OPERATION          14150000
*              2 - PRFERMGN ON - REQUEST TO REBUILD MESSAGE THAT HAD    14200000
*                  ERROR DURING SEND OPERATION                          14250000
*        ELEMENT IS ERB                                                 14300000
*              3 - PRI=PRIINTRQ - INITIAL REQUEST                       14350000
*              4 - PRI=PRIFSPCI - FIRST PCI                             14400000
*              5 - PRI=PRISBPCI - SUBSEQUENT PCI                        14450000
*                                                                       14500000
*********************************************************************** 14550000
*                                                                       14600000
         USING TSOUTPUT,RBASE           INITIALIZE BASE                 14650000
         LR    RBASE,R15                LOAD BASE ADDR                  14700000
*                                                                       14750000
IEDAYO   IEDHJN AYO000                                         @Y17XAYP 14800000
         LR    RPREF,R1                 LOAD ELEMENT ADDR               14850000
         LA    RPREF,NULL(RPREF)        CLEAR HI-ORDER BYTE             14900000
         TM    PRFTIC,TICCCW            IS THIS A BFR?           S22029 14950000
         BNO   ERBTOLCB                 NO. SETUP LCB FROM ERB.  S22029 15000000
         TM    PRFSTAT1,PRFTSMSG        IS THIS A TSO MESSAGE    S22029 15050000
         BNO   CPBINIT                  NO, GIVE CTL TO TCAM CPB S22029 15100000
*                                       INITIALIZATION ROUTINE          15150000
         L     RLCB,PRFLCB-1            SETUP LCB FROM BFR PRFX  S22029 15200000
         B     SETUP                    CONTINUE CTL BLK SETUP   S22029 15250000
ERBTOLCB EQU   *                                                 S22029 15300000
         LR    RLCB,RPREF               LOAD ERB ADDR IN LCB REG S22029 15350000
         LA    R2,LCBERB-IEDQLCB        PICKUP ERB TO LCB OFFSET S22029 15400000
         SR    RLCB,R2                  BACKUP TO LCB.           S22029 15450000
SETUP    EQU   *                                                 S22029 15500000
         L     RSCB,LCBSCBA-1           PICKUP SCB               S22029 15550000
********                                                                15600000
******** PICK UP THE DESTINATION QCB FOR THIS LINE                      15650000
********                                                                15700000
         LH    R2,LCBTTCIN              GET CONNECT INDEX        S22029 15750000
         LTR   R2,R2                    IS INDEX ZERO            S22029 15800000
         BZ    CPBINIT                  YES, BYPASS TO TCAM      S22029 15850000
         LR    R1,R2                    USE INDEX TO PICKUP      S22029 15900000
         L     R15,AVTRNMPT             TERMINAL TABLE ENTRY.    S22029 15950000
         BALR  R14,R15                                           S22029 16000000
         USING IEDQTRM,R1                                        S22029 16050000
         L     RQCB,TRMDESTQ-1          PICKUP DESTINATION QCB   S22029 16100000
         DROP  R1                                                S22029 16150000
         LR    R1,RPREF                 RESTORE INPUT ELEMENT    S22029 16200000
         TM    PRFTIC,TICCCW            TEST IF THIS IS A BFFR          16250000
         BNO   ERBCHECK                 NO,GOTO CHECK ERB               16300000
*                                                                       16350000
*********************************************************************** 16400000
*                                                                       16450000
BUFFER   EQU   *                                                        16500000
*                                                                       16550000
*********************************************************************** 16600000
*                                                                       16650000
*   A TCAM BUFFER HAS BEEN TPOSTED TO TSOUTPUT AFTER A MESSAGE          16700000
*   HAS BEEN SENT.                                                      16750000
*                                                                       16800000
         NC    QCBTJID,QCBTJID          IS TJID PRESENT                 16850000
         BZ    RETBFR                   NO, GO RETURN BUFFER            16900000
         TM    AVTBIT3,AVTTSAB          TEST IF TSO HAS ABENDED  A44839 16950000
         BO    RETBFR                   YES, GO RETURN BUFFERS   A44839 17000000
         BAL   R14,TSBADDR              GO GET TSB & TIOCRPT ADDRS      17050000
*                                                                       17100000
*********************************************************************** 17150000
*                                                                       17200000
BFFRTN   EQU   *                                                        17250000
         TM    PRFSTAT1,PRFERMGN        DID OUTPUT ERRORS OCCUR SA70323 17300000
         BNO   SUCCSEND                 NO, PROCESS NORMALLY    SA70323 17350000
         SPACE 2                                                        17400000
*********************************************************************** 17450000
*                                                                       17500000
*        ELEMENT IS BUFFER, PFRERMGN IS ON - ERROR DURING SEND          17550000
*        OPERATION.  CALL QTIP13 TO REBUILD MESSAGE.  SINCE WE          17600000
*        DON'T TURN OFF QCBTPUT, WE WILL GET CONTROL AGAIN TO           17650000
*        SEND OUT THIS REBUILT MESSAGE.                                 17700000
*********************************************************************** 17750000
         QTIP  QTIP3RD,(RSAVE)          CALL QTIP TO REBUILD    SA70323 17800000
         B     RETBFR                   GO RETURN TCAM BUFFER   SA70323 17850000
         SPACE 3                                                        17900000
SUCCSEND EQU   *                                                SA70323 17950000
*********************************************************************** 18000000
*                                                                       18050000
*   ELEMENT IS BFFR AND PRI=PRIDKSRV - NORMAL END OF SEND OPERATION     18100000
*        1 - RETURN TS BFFR TO FREE Q                                   18150000
*        2 - REMOVE WAIT CONDITION                                      18200000
*        3 - FREE TCAM BFFR                                             18250000
*                                                                       18300000
*********************************************************************** 18350000
*                                                                       18400000
*   ISSUE QTIP SVC TO FREE TSO BFR & REMOVE WAITS IF APPROPRIATE        18450000
*                                                                       18500000
         QTIP  QTIP2ND,(RSAVE)                                          18550000
         TM    TIOCFLG-TIOCRPT(R10),TIOCSYLW  IS SYSTEM IN LWAIT        18600000
         BNO   RETBFR                   NO, NO NEED TO LOCK KEYBOARD    18650000
         OI    QCBTSOF1,QCBNOBUF        LOCK USER'S KEYBOARD            18700000
*                                                                       18750000
*   TPOST TCAM BUFFER TO BUFFER RETURN                                  18800000
*                                                                       18850000
RETBFR   EQU   *                                                        18900000
         LR    R1,RPREF                 LOAD ELEMENT ADDR               18950000
         LA    R2,AVTBFRTB              LOAD ADDR OF BFR RETURN QCB     19000000
         MVI   PRFPRI,PRIBFRTB          SET TPOST PRIORITY = BFR RETURN 19050000
         B     POST                     GO SET UP TO GO TO DISPATCHER   19100000
*                                                                       19150000
*********************************************************************** 19200000
*                                                                       19250000
SESCLEAN EQU   *                                                        19300000
*                                                                       19350000
*********************************************************************** 19400000
*                                                                       19450000
*   THIS ROUTINE CLEANS UP TCAM CONTROL BLOCKS FOR LOGOFF,              19500000
*   AND TS ABENDING SITUATIONS.                                         19550000
*                                                                       19600000
*   IT USES REGISTERS 0,1,2,5,6,14,15                                   19650000
*                                                                       19700000
*********************************************************************** 19750000
*                                                                       19800000
         TM    LCBINSRC+2,QCBDELAY      IS LCB ON DELAY QUEUE           19850000
         BNO   PASTRLCB                 NO, DON'T REMOVE IT             19900000
         LR    R1,RLCB                  ADDR LCB TO BE REMOVED          19950000
         L     R15,AVTHG02              REMOVAL ROUTINE ADDR            20000000
         BALR  R14,R15                  GO REMOVE LCB                   20050000
*                                                                       20100000
         LR    R2,R3                    SAVE REGISTER CONTENTS          20150000
         LR    R6,RQCB                  SAVE REGISTER CONTENTS          20200000
*                                                                       20250000
         LA    RQCB,LCBRSKEY            LOAD STCB ADDR                  20300000
         LR    R1,RQCB                  LOAD STCB ADDR                  20350000
         BAL   R14,DSPPRIOR             PUT RECEIVE SCHEDULER           20400000
*                                       IN STCB CHAIN                   20450000
         LR    R3,R2                    RESTORE REGISTER CONTENTS       20500000
         LR    RQCB,R6                  RESTORE REGISTER CONTENTS       20550000
*                                                                       20600000
PASTRLCB EQU   *                                                        20650000
         TM    AYOSW2,AYODRPL           SHOULD LINE BE         @G36XRYP 20656000
*                                       DROPPED                @G36XRYP 20662000
         BZ    RESETLCB                 NO, DON'T DISCONNECT   @G36XRYP 20668000
         OI    LCBSTAT2,LCBNEGRP        REQUEST DISCONNECT     @G36XRYP 20674000
         MVI   LCBTSTSW,AVTEFF          REQUEST DISABLE/ENABLE @G36XRYP 20680000
         NI    LCBSTAT2,NOT-LCBRESP     TRM NEEDS NO RESPONSE  @G36XRYP 20686000
RESETLCB EQU   *                                               @G36XRYP 20692000
         NI    LCBTSOB,NOT-LCBTSBUF-LCBSATRD-LCBCIRCD  RESET FLAG       20700000
         MVI   LCBSENS0,NULL            RESET SENSE BYTE                20750000
         MVI   LCBTPCD+ELEVEN,AVTEZERO  CLEAR TP OP CODE       @OY15030 20770000
         XC    SCBERRST(SCBSRCE-SCBERRST),SCBERRST  RESET SCB           20800000
*                                                                       20850000
         NI    QCBFLAG,NOT-QCBREAD-QCBNOBRK   RESET BITS         S22029 20900000
*              QCBTSSES WILL BE TURNED OFF BY IEDAYZ             S22029 20950000
         NI    QCBDSFLG,NOT-QCBALTMH    RESET ALTERNATE MH PATH  S22029 21000000
         MVI   QCBRETCT,NULL            CLEAR ERROR RETRY COUNT         21050000
         MVI   QCBCARCT,NULL            CLEAR CARRIAGE COUNT            21100000
         XC    QCBTJID,QCBTJID          CLEAR TJID                      21150000
*                                                                       21200000
         LH    R1,AYOSRCE               GET TERMINAL INDEX       A44839 21250000
         L     R15,AVTRNMPT             LOAD ADDR OF TERM NAME ENTRY    21300000
*                                                                       21350000
         BALR  R14,R15                  GOTO TERM NAME ROUTINE          21400000
         LA    R15,TRMPRFSZ             GET TRM PREFIX SIZE    @Y17XAYP 21500000
         SR    R1,R15                   BACK UP TO TRM PREFIX  @Y17XAYP 21550000
         USING IEDNTRM,R1               ESTABLISH BASE         @Y17XAYP 21600000
         TM    TRMSTATE,TRMPREF         DOES PREFIX EXIST      @ZM45391 21603000
         BNO   NOPREFIX                 BR NO                  @ZM45391 21606000
         TM    TRMBYTE0,TRMSNA          IS IT SNA TERM         @ZM45391 21610000
         BO    NOPREFIX                 BR YES                 @ZM45391 21620000
         OI    TRMPRE,TRMCMODE          INDICATE DEVICE MODE   @Y17XAYP 21650000
*                                       FIELDS SHOULD BE RESET @Y17XAYP 21700000
NOPREFIX EQU   *                                               @ZM45391 21720000
         XC    QCBINSRC,QCBINSRC        CLEAR STATUS BYTES              21750000
*                                                                       21800000
         SR    R15,R15                  CLEAR REG.15                    21850000
         IC    R15,TRMCHCIN                                             21900000
         BCTR  R15,NULL                 DECREMENT BY '1'                21950000
         MH    R15,AVTDCTLN             MULTIPLY BY THE SIZE   @Y17XAYP 22000000
*                                       OF A DCT ENTRY         @Y17XAYP 22050000
         A     R15,AVTCSTCS             ADD BASE FOR DEVICE CHAR TABLE  22100000
*                                                                       22150000
         TM    DCTBYTE1-IEDDCT(R15),DCTBREAK  BREAK FEATURE    @Y17XAYP 22200000
         BO    NOBRK                    YES, DON'T SET NO-BREAK         22250000
*                                                                       22300000
         OI    QCBFLAG,QCBNOBRK         SET 'NO BREAK' ON               22350000
NOBRK    EQU   *                                                YS6327  22400000
*                                                                       22450000
*   IF THIS TERMINAL IS CONNECTED VIA A 3705, SET DEVICE MODE           22500000
*   BITS IN THE TTE.  THIS WILL RESET THE 3705'S DEVICE                 22550000
*   MODE INDICATORS TO MATCH THE SETTINGS IN THE TCAM DCT.              22600000
*                                                                       22650000
         TM    TRMDEVFL+1,TRMRNTRM      IS TERM ON A 3705       YS6327  22700000
         BNOR  R5                       NO, RETURN TO CALLER    YS6327  22750000
         TM    TRMSTATE,TRMOPTFN        ARE THERE ANY OPTN FLDS YS6327  22800000
         LA    R2,TRMOPNO               ASSUME NONE             YS6327  22850000
         BNO   NOPTION                  BRANCH ON NO OPTN FLDS  YS6327  22900000
         SR    R14,R14                  CLEAR REGISTER FOR IC   YS6327  22950000
         IC    R14,TRMOPNO              NUMBER OF OPTION FIELDS YS6327  23000000
         LA    R2,TRMOPT(R14)           SKIP OPTION FIELDS              23050000
NOPTION  EQU   *                                                YS6327  23100000
         LH    R14,TRMDEVFL             GET DEVICE DEP FLAGS    YS6327  23150000
         LA    R10,ELEVEN               SET FOR BIT SEARCH      YS6327  23200000
         SLL   R14,16                   SHIFT BITS TO HI ORDER  YS6327  23250000
*                                       TWO BYTES               YS6327  23300000
         DROP R1                                               @Y17XAYP 23350000
         SR    R1,R1                    CLEAR REGISTER          YS6327  23400000
SHIFT    EQU   *                                                YS6327  23450000
         LTR   R14,R14                  IS BIT PRESENT          YS6327  23500000
         BNM   CHKCOUNT                 BRANCH ON NO            YS6327  23550000
         LA    R1,E1(R1)                NUMBER OF BITS FOUND    YS6327  23600000
CHKCOUNT EQU   *                                                YS6327  23650000
         SLL   R14,1                    SHIFT TO CHECK NEXT BIT YS6327  23700000
         BCT   R10,SHIFT                HAVE ALL BITS BEEN CHKD YS6327  23750000
         LTR   R1,R1                    ANY DEV DEP FIELDS      YS6327  23800000
         BZ    SETMODE                  NO GO SET DEV MODE FLDS YS6327  23850000
         SR    R14,R14                  CLEAR REGISTER FOR IC   YS6327  23900000
SKIP     EQU   *                                                YS6327  23950000
         IC    R14,AVTEZERO(,R2)        GET DEV DEP FLD LENGTH  YS6327  24000000
         LA    R2,E1(R14,R2)            SKIP OVER FIELD         YS6327  24050000
         BCT   R1,SKIP                  SKIP TO NEXT FIELD      YS6327  24100000
SETMODE  EQU   *                                                YS6327  24150000
         LA    R2,E3(R2)                GET DEV DEP FOR SETMODE YS6327  24200000
         NI    E1(R2),NOT-STMONITR      TURN OFF MONITOR MODE   YS06327 24250000
         TM    DCTBYTE1-IEDDCT(R15),DCTINHIB   READ-INHIBITS   @Y17XAYP 24300000
         BNO   OFFINHBN                 NO, GO TURN BIT OFF     YS6327  24350000
         OI    E1(R2),BTUINHBN          INHIBIT T.O. MODE BIT   YS6327  24400000
         BR    R5                       RETURN TO SUBRTN CALLER         24450000
OFFINHBN EQU   *                                                        24500000
         NI    E1(R2),NOT-BTUINHBN      ALLOW TIMEOUTS                  24550000
         BR    R5                       RETURN TO SUBROUTINE CALLER     24600000
*                                                                       24650000
*********************************************************************** 24700000
*                                                                       24750000
ERBCHECK EQU   *                                                        24800000
*                                                                       24850000
*********************************************************************** 24900000
*                                                                       24950000
*   WHEN ERB IS POSTED                                                  25000000
*        1 - PRI=PRINTRQ - INITIAL REQUEST                              25050000
*        2 - PRI=PRIFSPCI - FIRST PCI                                   25100000
*        3 - LCBRCLLN/LCBSENDN - REBUILD OUTPUT BFFR                    25150000
*                                                                       25200000
*********************************************************************** 25250000
*                                                                       25300000
         TM    LCBSTAT1,LCBRCLLN        RECALLED BUFFER REQUEST SS22029 25350000
         BO    CPBINIT                  YES, GO RECALL BUFFER   SS22029 25400000
         L     RQCB,SCBDESTQ-1          NO, USE DESTINATION      S22029 25450000
*                                       TERMINAL'S QCB.                 25500000
*                                                                       25550000
         TM    QCBFLAG,QCBTSSES         TEST IF TSO IN SESSION          25600000
         BNO   CPBINIT                  NO, GIVE CTL TO TCAM CPB S22029 25650000
*                                       INITIALIZATION RTN              25700000
*                                                                       25750000
*   SET LCBDLNKN SWTCH OFF TO INDICATE THIS ERB IS BEING USED           25800000
*                                                                       25850000
         NI    LCBERBST,LCBDLNKF        SET DLINK SWITCH OF ERB OFF     25900000
         XC    LCBERBCH,LCBERBCH        CLEAR ERB CHAIN FIELD           25950000
         XC    AYOSWTCH(AYOWRKL),AYOSWTCH  CLEAR TSOUTPUT'S WORK AREA   26000000
         STH   R2,AYOSRCE               SAVE TERMINAL INDEX      S22029 26050000
*********************************************************************** 26100000
*                                                                       26150000
*   CHECK PRIORITY TO DETERMINE                                         26200000
*        1 - INITIAL REQUEST                                            26250000
*        2 - INITIAL PCI                                                26300000
*        3 - SUBSEQUENT PCI                                             26350000
*                                                                       26400000
*********************************************************************** 26450000
*                                                                       26500000
         CLI   LCBERBPY,PRIINTRQ        TEST IF INITIAL REQUEST         26550000
         BE    INTLRQST                 YES,GOTO HANDLE INITIAL REQUEST 26600000
*                                                                       26650000
*   IF NOT INITIAL REQUEST,CHECK IF LCBERROR IS ON                      26700000
*        YES - POST ERB TO ADDRESS IN LCBRCQCB                          26750000
*            - CHECK IF ATTENTION HAS BEEN HIT                          26800000
*                                                                       26850000
         TM    LCBERBST,LCBERROR        TEST IF ANY ERROR               26900000
         BNO   CHKATTN                  NO,GOTO CHECK ATTENTION         26950000
*                                                                       27000000
*   WHEN LCBERROR BIT IS ON                                             27050000
*        1.- ZERO LCBERBCH                                              27100000
*        2 - SET PRI=PRIRCQCB                                           27150000
*        3 - POST ERB TO ADDR IN LCBRCQCB                               27200000
*                                                                       27250000
         XC    LCBERBCH,LCBERBCH        ZERO ERB CHAIN FIELD            27300000
         LA    R1,LCBERB                LOAD ADDR OF ERB                27350000
         MVI   PRFPRI-IEDQPRF(R1),PRIRCQCB   SET PRI=PRIRCQCB           27400000
         L     R2,LCBRCQCB              LOAD ADDR IN LCBRCQCB           27450000
         B     POST                     GOTO TCAM/DSPPOST               27500000
*                                                                       27550000
CHKATTN  EQU   *                                                        27600000
         TM    SCBERR3,SCBATTN          TEST IF ATTENTION BEEN HIT      27650000
         BO    DISP                     YES, EXIT TO TCAM DISPATCHER    27700000
         CLI   LCBERBPY,PRIFSPCI        TEST IF INITIAL PCI             27750000
         BE    FIRSTPCI                 YES,GOTO PROCESS INITIAL PCI    27800000
*                                                                       27850000
*********************************************************************** 27900000
*                                                                       27950000
*   THIS IS SUBSEQUENT PCI                                              28000000
*                                                                       28050000
*               1 - BUILD ONE TCAM BFFR                                 28100000
*               2 - POST TO MH (PRI=PRIMHBFR)                           28150000
*               3 - IF ERB COUNT IS NOT '0',POST AVTDSIOB -PRI=PRISBPCI 28200000
*               4 - IF NO MSG TO SEND,SET END OF MSG AND POST TO MH     28250000
*                                                                       28300000
*                                                                       28350000
*********************************************************************** 28400000
*                                                                       28450000
         OI    AYOSWTCH,SUBPCI          SET SUBSEQUENT PCI BIT 'ON'     28500000
         B     CHKTSAB                  GO CHECK FOR TSO ABENDING       28550000
*                                                                       28600000
*********************************************************************** 28650000
*                                                                       28700000
FIRSTPCI EQU   *                                                        28750000
*                                                                       28800000
*********************************************************************** 28850000
*                                                                       28900000
*   THIS IS THE FIRST PCI REQUEST                                       28950000
*        1 - BUILD NO. OF TCAM BFFR REQUESTED IN ERB COUNT              29000000
*        2 - POST EACH BFFR TO MH (PRI=PRIMHBFR)                        29050000
*        3 - IF NO MSG TO SEND,SET END OF MSG AND POST TO MH            29100000
*                                                                       29150000
*********************************************************************** 29200000
*                                                                       29250000
         OI    AYOSWTCH,INTLPCI         SET INITIAL PCI REQUEST         29300000
         B     CHKTSAB                  GO CHECK FOR TSO ABENDING       29350000
*                                                                       29400000
*********************************************************************** 29450000
*                                                                       29500000
INTLRQST EQU   *                                                        29550000
*                                                                       29600000
*********************************************************************** 29650000
*                                                                       29700000
*   THIS IS AN INITIAL REQUEST FOR TCAM BUFFERS                         29750000
*                                                                       29800000
*********************************************************************** 29850000
*                                                                       29900000
         OI    AYOSWTCH,INTLRQ          SET THIS IS A INITIAL REQUEST   29950000
         MVI   LCBERBCT+1,NULL          CLEAR DISABLED COUNT            30000000
*                                                                       30050000
CHKTSAB  EQU   *                                                        30100000
*                                                                       30150000
         TM    AVTBIT3,AVTTSAB          TEST IF TSO HAS ABENDED         30200000
         BNO   GETADDRS                 NO, GET TSB, TIOCRPT ADDRS      30250000
         DROP  R15                                               A52381 30300000
         USING IEDQTNTD,R15             ADDRESSABILITY FOR TNT   A52381 30350000
         USING IEDQTRM,R1               ADDRESSABILITT FOR TRM   A52381 30400000
         L     R15,AVTRNMPT             GET TNT ADDRESS          A52381 30450000
         LH    R2,TNTLEN                HIGHEST TERMINAL INDEX   A52381 30500000
TTABLE   EQU   *                                                 A52381 30550000
         LR    R1,R2                    PUT INDEX IN REG 1       A52381 30600000
         BALR  R14,R15                  GO GET TTABLE ENTRY ADDR A52381 30650000
         CLC   TRMDESTQ,SCBDESTQ        ARE ADDRESSES THE SAME   A52381 30700000
         BE    RAYOSRCE                 YES, TERMINAL INDEX IS   A52381 30750000
*                                       CORRECT                  A52381 30800000
         BCT   R2,TTABLE                TRY WITH NEW INDEX VALUE A52381 30850000
         LH    R2,LCBTTCIN              GET INDEX FROM LCB       A52381 30900000
RAYOSRCE EQU   *                                                 A52381 30950000
         STH   R2,AYOSRCE               RESET TERMINAL INDEX     A52381 31000000
         DROP  R1                                                A52381 31050000
         DROP  R15                                               A52381 31100000
         TM    AYOSWTCH,INTLRQ          IS THIS AN INITIAL REQUEST      31150000
         BO    TSABEND                  YES,GOTO TSO ABEND RTN          31200000
         B     NOTINTL                  BRANCH TO SEND 1 IDLE CHARACTER 31250000
*                                                                       31300000
GETADDRS EQU   *                                                        31350000
*                                                                       31400000
         BAL   R14,TSBADDR              GET TSB,TIOCRPT ADDRS           31450000
*                                                                       31500000
         TM    TSBFLG2,TSBBRKIN         COULD THIS BE FLASHBACK REQUEST 31550000
         BZ    BUILDBFF                 NO, GO BUILD TCAM BFR           31600000
         TM    TSBSTAT,TSBDSPLY         IS THIS A FLASHBACK REQUEST?    31650000
         BZ    BUILDBFF                 NO, GO BUILD TCAM BFR           31700000
*                                                                       31750000
         TM    TSBFLG3,TSBSPIT          IS TCLEARQ IN PROGRESS          31800000
         BO    BUILDBFF                 YES, DON'T FLASHBACK            31850000
         CLC   TSBOTBFP,AVTFZERO        IS TRAILER QUEUE EMPTY          31900000
         BE    CHKBRKIN                 YES, GO SET UP TO FLASH BACK    31950000
*                                                                       32000000
*********************************************************************** 32050000
*                                                                       32100000
BUILDBFF EQU   *                                                        32150000
*                                                                       32200000
*********************************************************************** 32250000
*                                                                       32300000
*    BUILD TCAM BUFFER                                                  32350000
*                                                                       32400000
*********************************************************************** 32450000
*                                                                       32500000
*        NOTE -- THE TERM 'HEADER BASIC UNIT', AS USED IN COMMENTS      32550000
*        IN THIS LISTING, REFERS TO THE FIRST BASIC UNIT IN A BUFFER,   32600000
*        THAT IS, THE BASIC UNIT WHICH CONTAINS THE BUFFER PREFIX.      32650000
*                                                                       32700000
**********************************************************************  32750000
*                                                                       32800000
*   CALCULATE NO. OF BASIC UNITS PER BUFFER                             32850000
*                                                                       32900000
*********************************************************************** 32950000
*                                                                       33000000
         LH    R1,AYOSRCE               GET INDEX TO TERMINAL  @YA13248 33050000
*                                       TABLE                    A44839 33100000
         L     R15,AVTRNMPT             LOAD ADDR OF TERM. NAME TABLE   33150000
         BALR  R14,R15                  GO GET TTABLE ENTRY ADDR        33200000
*                                                                       33250000
*   TERM TABLE ENTRY ADDR IS IN R1,IF BUFFER SIZE IS SPECIFIED IN       33300000
*   TTABLE, PUT IT IN LCBERBQP+1.  IF NOT, USE DCBBFSZE                 33350000
*                                                                       33400000
         USING IEDQTRM,R1                                               33450000
         TM    TRMDEVFL,TRMBUFSZ        IS A BUFFER SIZE SPECIFIED      33500000
         BO    USETRM                   YES, USE TRM FIELD      YS6327  33550000
         TM    TRMSTATE,TRMPREF         IS THERE A PREFIX      @Y17XAYP 33600000
         BNO   USEDCB                   NO,GOTO USE DCB         YS6327  33650000
*                                                               YS6327  33700000
*   FOR 3705 LINE GROUPS, OBTAIN BUFFER SIZE FROM LGB           YS6327  33750000
*                                                               YS6327  33800000
         L     RDCB,LCBDCBPT            GET LGB ADDR            YS6327  33850000
         USING IEDNLGB,RDCB             LGB ADDRESSABLE         YS6327  33900000
         LH    R1,LGBBUFSI              GET BUFFER SIZE         YS6327  33950000
         STH   R1,LCBERBQB+ONE          SAVE IT IN THE ERB      YS6327  34000000
         DROP  RDCB                     LGB NOT ADDRESSABLE     YS6327  34050000
         SR    R10,R10                  CLEAR REG.              YS6327  34100000
         B     CNTBFUNT                 GO COUNT NO. OF UNITS   YS6327  34150000
*                                                                       34200000
*   OBTAIN BUFFER SIZE & NO. OF BASIC UNITS FROM TERMINAL TABLE         34250000
*                                                                       34300000
USETRM   EQU   *                                                        34350000
         USING TIOCBUF,R2                                               34400000
         SR    R10,R10                  ZERO R10                        34450000
         LA    R5,TRMOPNO+1             LOCATION BFFR SIZE OF NO OPTION 34500000
         TM    TRMSTATE,TRMOPTFN        TEST IF OPTION SPECIFIED        34550000
         BNO   NOOPTION                 NO,GOTO OBTAIN QCB FROM ERB     34600000
*                                                                       34650000
         LR    R5,R10                   ZERO R5                         34700000
         IC    R5,TRMOPNO               NO OF OPTION FIELDS             34750000
         LA    R5,TRMOPT+1(R5)          ADDR OF OPT FLD + 1 + NO. OF    34800000
*                                       OPT FLD = LOCATION OF BFR SIZE  34850000
         DROP  R1                                                       34900000
*                                                                       34950000
NOOPTION EQU   *                                                        35000000
*                                                                       35050000
         MVC   LCBERBQB+1(E2),NULL(R5)  SET SIZE OF BFR IN ERBQB+1      35100000
         LH    R1,LCBERBQB+1            LOAD SIZE OF BFFR               35150000
*                                                                       35200000
CNTBFUNT EQU   *                                                        35250000
*                                                                       35300000
         LA    R10,ONE(R10)             INCREMENT R10 BY '1'            35350000
         SH    R1,AVTKEYLE              SUBTRACT (B.U. - PREFIX)        35400000
         BP    CNTBFUNT                 IF THERE ARE REMAINING,REPEAT   35450000
         B     SIZEDONE                 END OF B.U. COUNT               35500000
*                                                                       35550000
USEDCB   EQU   *                                                        35600000
*                                                                       35650000
         USING IHADCB,RDCB                                              35700000
         L     RDCB,LCBDCBPT            LOAD DCB ADDR                   35750000
         LH    R1,DCBBUFSI              OBTAIN BUFFER SIZE              35800000
         STH   R1,LCBERBQB+1            STORE IT IN LCB                 35850000
         IC    R10,DCBUNTCT                                             35900000
*                                                                       35950000
SIZEDONE EQU   *                                                        36000000
*                                                                       36050000
         STC   R10,LCBERBQB             STORE NO. B.U. IN LCB           36100000
         MVI   LCBERBKY,AVTEZERO        SET PRIORITY KEY TO '0'         36150000
*                                                                       36200000
*        LCBERBQB+1 - SIZE OF BUFFER                                    36250000
*        LCBERBQB   - NO. OF B.U. PER BUFFER                            36300000
*                                                                       36350000
*********************************************************************** 36400000
*                                                                       36450000
CHAINBUF EQU   *                                                        36500000
*                                                                       36550000
*********************************************************************** 36600000
*                                                                       36650000
*   ISSUE QTIP SVC TO MOVE A TSO MESSAGE FROM THE OUTPUT HEADER         36700000
*   QUEUE TO THE OUTPUT TRAILER QUEUE UNLESS THERE IS ALREADY           36750000
*   SOMETHING ON THE TRAILER QUEUE.                                     36800000
*                                                                       36850000
         QTIP  QTIP1ST,(RSAVE)                                          36900000
*                                                                       36950000
         L     R2,TSBOTBFP-1            LOAD TS BFFR AADR               37000000
         LTR   R15,R15                  ANY DATA TO MOVE        SA70323 37050000
         BZ    NOOUTPUT                 NO, GO TO 'NO OUTPUT' ROUTINE   37100000
         ST    R2,AYOTSBFF              STORE TS MSSG ADDR              37150000
         SPACE 2                                                YS6327  37200000
WATSLEFT EQU   *                                                YS6327  37250000
*                                                               YS6327  37300000
         SR    R15,R15                  CLEAR FOR COMPARISON    YS6327  37350000
         CH    R15,AYOBULEN             IS THERE SPACE LEFT     YS6327  37400000
         BNZ   MOVEDATA                 YES, DON'T GET NEW BU   YS6327  37450000
*                                                               YS6327  37500000
GETBASIC EQU   *                                                        37550000
*                                                                       37600000
         NC    AVTBFREB+1(E3),AVTBFREB+1  ARE ANY B.U.'S AVAILABLE      37650000
         BZ    NOBFRS                   NO,GOTO CHAIN ERB TO BFF RTN    37700000
*                                       QCB                             37750000
*                                                                       37800000
*   WHEN B.U. IS AVAILABLE,GET ONE                                      37850000
*                                                                       37900000
         LH    R5,AVTAVFCT              LOAD NO. OF B.U. IN POOL        37950000
         BCTR  R5,NULL                  SUBTRACT '1'                    38000000
         STH   R5,AVTAVFCT              STORE NEW BUFFER NO.            38050000
         L     R5,AVTBFREB              LOAD ADDR OF AVAILABLE UNIT     38100000
         L     R1,PRFLINK-1-IEDQPRF(R5) LOAD ADDR OF NEXT B.U,          38150000
         ST    R1,AVTBFREB              STORE IT AS 1ST AVAILABLE       38200000
*                                                                       38250000
CHKCHAIN EQU   *                                                        38300000
*                                                                       38350000
*   CHECK IF THERE ARE ANY B.U. IN BUFFER CHAIN                         38400000
*      YES - TIC LAST B.U. TO THIS B.U.                                 38450000
*      NO  - START TO BUILD BUFFER PREFIX                               38500000
*                                                                       38550000
         XC    NULL(PREFL,R5),NULL(R5)  CLEAR B.U. PREFIX AREA          38600000
         L     R1,AYOLSTBU              GET ADDR OF LAST B.U. IN CHAIN  38650000
         LA    R5,NULL(R5)              RESET HI-ORDER BYTE             38700000
         ST    R5,AYOLSTBU              SAVE B.U. ADDR IN SCB           38750000
         NC    LCBERBCH,LCBERBCH        TEST IF ANY BUFFER IN CHAIN     38800000
         BZ    BUILDPRF                 NO,GOTO BUILD HEADER BUFFER     38850000
*                                                                       38900000
         L     R9,AYOHDRBU              GET ADDR OF LAST BFR PREFIX     38950000
         CLC   LCBERBQB(ONE),PRFNBUNT-IEDQPRF(R9)  TEST IF THIS BASIC   39000000
*                                       UNIT STARTS A NEW BUFFER        39050000
         BE    LINKBFR                  YES, GO LINK BFR INTO CHAIN     39100000
*                                                                       39150000
         ST    R5,PRFTIC-IEDQPRF(,R1)   TIC LAST B.U. TO THIS           39200000
         MVI   PRFTIC-IEDQPRF(R1),TICCCW  SET TIC COMMAND               39250000
         B     ADDBUCT                  GO UPDATE B.U. COUNT            39300000
*                                                                       39350000
LINKBFR  EQU   *                                                        39400000
*                                                                       39450000
*   WHEN THIS B.U. STARTS A NEW BUFFER,LINK THIS BUFFER TO THE BUFFER   39500000
*   CHAIN.                                                              39550000
*                                                                       39600000
         OI    PRFSTAT1-IEDQPRF(R5),PRFNHDRN+PRFNLSTN+PRFTSMSG   S22029 39650000
*                                       SET 'NOT HDR','NOT LAST'        39700000
*                                       , AND 'TS MESSAGE'              39750000
         ST    R5,PRFLINK-1-IEDQPRF(R9)  LINK LAST BFR TO THIS BFR      39800000
         B     INITPRF                  SET UP BFR PREFIX        S22029 39850000
*                                                                       39900000
BUILDPRF EQU   *                                                        39950000
*                                                                       40000000
         ST    R5,LCBERBCH-1            STOREB.U. ADDR IN ERB           40050000
         OI    PRFSTAT1-IEDQPRF(R5),PRFNLSTN+PRFTSMSG SET 'NOT   S22029 40100000
*                                       LAST' AND 'TS MESSAGE'          40150000
         TM    AYOSWTCH,INTLRQ          TEST IF INITIAL REQUEST         40200000
         BO    INITPRF                  YES, DON'T SET 'NOT HDR' S22029 40250000
*                                                                       40300000
         OI    PRFSTAT1-IEDQPRF(R5),PRFNHDRN SET 'NOT HDR' FOR          40350000
*                                       SUBSEQUENT REQUEST              40400000
*                                                                       40450000
INITPRF  EQU   *                                                 S22029 40500000
*                                                                       40550000
         LR    R9,R5                    LD ADDR OF LATEST BFR PREFIX    40600000
         LA    R9,NULL(R9)              RESET HI-ORDER BYTE             40650000
         ST    R9,AYOHDRBU                                              40700000
         TM    PRFSTAT1-IEDQPRF(R9),PRFNHDRN HEADER BFR          S22029 40750000
         BO    TXTSIZE                  NO, USE TEXT SIZE        S22029 40800000
         MVI   PRFSIZE+1-IEDQPRF(R9),AVTHDRSZ  UPDATE PRFX WITH  S22029 40850000
*                                       HEADER PREFIX SIZE              40900000
         MVC   PRFDEST-IEDQPRF(2,R9),LCBTTCIN SET UP DEST INDX @Y17XAYP 40950000
*                                                              @Y17XAYP 41000000
         B     INITPRF1                 CONTINUE PREFIX SETUP    S22029 41050000
TXTSIZE  EQU   *                                                 S22029 41100000
         MVI   PRFSIZE+1-IEDQPRF(R9),AVTTXTSZ  UPDATE PRFX WITH  S22029 41150000
*                                       TEXT PREFIX SIZE                41200000
INITPRF1 EQU   *                        CONTINUE UPDATING PREFIX S22029 41250000
         LA    RLCB,NULL(RLCB)          CLEAR HI-ORDER BYTE             41300000
         ST    RLCB,PRFLCB-1-IEDQPRF(R9)  STORE LCB ADDR INTO PREF      41350000
*                                                                       41400000
ADDBUCT  EQU   *                                                        41450000
*                                                                       41500000
         MVC   PRFTIC-IEDQPRF(,R5),INVLDTIC  SET INVALID TIC            41550000
         SR    R1,R1                    RESET R1                        41600000
         IC    R1,PRFNBUNT-IEDQPRF(R9)  INSERT NO OF B.U. IN BUFFER     41650000
         LA    R1,ONE(R1)               INCREMENT NO. OF B.U.           41700000
         STC   R1,PRFNBUNT-IEDQPRF(R9)  STORE UPDATED NO. OF B.U.       41750000
*                                                                       41800000
*********************************************************************** 41850000
*                                                                       41900000
MOVEDATA EQU   *                                                        41950000
*                                                                       42000000
*********************************************************************** 42050000
*                                                                       42100000
*   ENTRY TO OUTPUT EDIT ROUTINE                                        42150000
*                                                                       42200000
*   ENTRY--  REG.0 - HI-ORDER 2 BYTES                                   42250000
*                    SIZE OF FIELD TO WHICH DATA IS TO BE MOVED-INTO    42300000
*                                                                       42350000
*                  - LOW-ORDER 2 BYTES                                  42400000
*                    SIZE OF THE MSSG TO BE MOVED                       42450000
*                                                                       42500000
*            REG.1 - HI-ORDER BYTE                                      42550000
*                    BIT 0 - TSO MESSAGE                                42600000
*                    BIT 1 - CONTROL OPTION                             42650000
*                    BIT 2 - ASIS OPTION                                42700000
*                    BITS 1&2 TOGETHER - FULL SCREEN OPTION             42750000
*                                                                       42800000
*                  - LOW-ORDER 3 BYTES                                  42850000
*                    ADDR OF FIELD TO WHICH DATA IS TO BE MOVED INTO    42900000
*                                                                       42950000
*            REG.2 - ADDR OF MSSG TO BE MOVED                           43000000
*                     ZERO MEANS SEND IDLES ONLY UNLESS CARRIAGE        43050000
*                     COUNT EQUALS LINE SIZE, IN WHICH CASE             43100000
*                     RETURN CARRIAGE.                                  43150000
*                                                                       43200000
*                    WHEN QCBRETCT HAS X'08' ON, OUTPUT EDIT PERFORMS   43250000
*                     ONLY SPECIAL END OF MESSAGE PROCESSING.  IN THIS  43300000
*                     CASE, REG. 2 NEED ONLY BE NONZERO.                43350000
*                                                                       43400000
*            REG.3  - ADDR OF SCB                                       43450000
*            REG.4  - ADDR OF LCB                                       43500000
*            REG.8  - ADDR OF TSB                                       43550000
*            REG.11 - ADDR OF TCAM DISPATCHER                           43600000
*            REG.13 - ADDR OF AVT                                       43650000
*            REG.14 - RETURN ADDR                                       43700000
*            REG.15 - ENTRY ADDR                                        43750000
*                                                                       43800000
*********************************************************************** 43850000
*                                                                       43900000
         L     R1,AYONXTCH              GET PT TO NEXT SPACE            43950000
         LH    R0,AYOBULEN              GET LENGTH OF SPACE             44000000
         LTR   R0,R0                    ANY SPACE LEFT IN BU            44050000
         BNZ   SHIFTSIZ                 YES, SKIP SIZING CODE           44100000
         SPACE 1                                                        44150000
         L     R1,AYOLSTBU              LOAD ADDR OF CURRENT B.U.       44200000
         LA    R1,PRFSUNIT-IEDQPRF(R1)  NOW R1 POINTS TO 'TO-FIELD' TO  44250000
*                                       WHICH DATA MOVEMENT STARTS      44300000
*                                       UNLESS THIS IS A HDR B.U.       44350000
         LR    R0,R1                    SAVE START OF UNIT ADDR         44400000
         CLC   AYOHDRBU+1(E3),AYOLSTBU+1  TEST IF HDR B.U.              44450000
         BNE   GTBUSIZE                 NO, GO TO GET DATA LENGTH       44500000
*                                                                       44550000
         TM    PRFSTAT1-IEDQPRF(R9),PRFNHDRN HEADER PREFIX       S22029 44600000
         BO    TXTPRFX                  NO, ADJUST FOR TEXT PRF  S22029 44650000
         LA    R1,AVTHDRSZ(R1)          ADJUST FOR HEADER PRF    S22029 44700000
         B     GTBUSIZE                                          S22029 44750000
TXTPRFX  EQU   *                                                 S22029 44800000
         LA    R1,AVTTXTSZ(R1)          ADJUST FOR TEXT PRF      S22029 44850000
*                                                                       44900000
GTBUSIZE EQU   *                                                        44950000
*                                                                       45000000
         ST    R1,AYONXTCH              STORE STARTING POSITION         45050000
         AH    R0,AVTKEYLE              GET END OF B.U. ADDR(+1)        45100000
         SR    R0,R1                    OBTAIN AVAILABLE BYTES          45150000
         STH   R0,AYOBULEN              STORE AVAILABLE LENGTH          45200000
         SPACE 2                                                        45250000
SHIFTSIZ EQU   *                                                        45300000
         SLL   R0,16                    SHIFT TO-LENGTH TO HI-ORDER     45350000
*                                                                       45400000
         TM    AYOSWTCH,SENDNL          SHOULD ONLY IDLES BE SENT?      45450000
         BNZ   ENDOFBFF                 YES, GO TO END OF BFFR RTN      45500000
         TM    AYOSWTCH,CHAINEND        IS THIS END OF 3270 CHN SA61765 45550000
         BNO   NOTCHEND           NO, PROCESS NORMALLY          SA61765 45600000
         SPACE 2                                                SA61765 45650000
*   THIS IS THE END OF A 3270 CHAIN.  THERE IS NOTHING ON THE Q         45700000
*   SO WE MUST FAKE A TS BUFFER ADDRESS AND SKIP LENGTH CHECKING        45750000
         LA    R2,1                     ANY NONZERO VALUE IS OK SA61765 45800000
         ST    R2,AYOTSBFF              STORE 'ADDR' IN W.A.    SA61765 45850000
         OR    R0,R2                    LENGTH MUST BE NONZERO  SA61765 45900000
         B     ENDOFBFF                 GO SET BITS FOR EDIT    SA61765 45950000
         SPACE 2                                                SA61765 46000000
NOTCHEND EQU   *                                                SA61765 46050000
         L     R2,AYOTSBFF              LOAD ADDR OF CURRENT TSO BFFR   46100000
         IC    R0,BUFFLNTH-TIOCBUF(R2)  INSERT LENGTH OF TSO MSG        46150000
         SR    R15,R15                  RESET R15 TO '0'                46200000
*                                                                       46250000
TSTHDRBF EQU   *                                                        46300000
*                                                                       46350000
         CLC   BUFFTRLR,ZEROS           TEST IF ANY MORE IN CHAIN       46400000
         BE    ENDOFBFF                 NO, GOTO END OF BFF             46450000
*                                                                       46500000
         L     R2,BUFFTRLR-1-TIOCBUF(R2) LOAD NEXT BUFFER ADDR          46550000
*                                                                       46600000
*   UPDATE CURRENT TS BUFFER POINTER IF THIS TS BUFFER HAS              46650000
*   BEEN EMPTIED.                                                       46700000
*                                                                       46750000
         LR    R14,R0                   MOVE R0 FOR DESTRUCTIVE TEST    46800000
         N     R14,AVTCLRHI             IS THERE ANY DATA TO BE MOVED?  46850000
         BNZ   INSRTLNG                 YES,GOTO INSERT DATA LENGTH     46900000
         LA    R2,NULL(R2)              CLEAR HI-ORDER BYTE             46950000
         ST    R2,AYOTSBFF              UPDATE TS BFFR POINTER          47000000
*                                                                       47050000
INSRTLNG EQU   *                                                        47100000
*                                                                       47150000
         IC    R15,BUFFLNTH-TIOCBUF(R2) INSERT TEXT LENGTH              47200000
         AR    R0,R15                   ADD TEXT LENGTH TO TSO MSG LNTH 47250000
         B     TSTHDRBF                 GO BACK TO CHECK NEXT BUFFER    47300000
*                                                                       47350000
CLEARQ   EQU   *                                                        47400000
         BAL   R14,TSBADDR              GET TSB AND TIOCPT       TS1638 47450000
*                                       ADDR'S                   TS1638 47500000
         STM   R0,R1,AVTSAVE2+E48       SAVE REGS. ACROSS QTIP          47550000
         SR    R15,R15                  INDICATE Q FLUSH ALLOWED        47600000
         QTIP  QTIP2ND,(RSAVE)          CLEAR OUTPUT TRAILER QUEUE      47650000
*                                                                       47700000
         LM    R0,R1,AVTSAVE2+E48       RESTORE REGS. AFTER QTIP        47750000
         CLI   QCBCARCT,NULL            IS CARRIAGE AT LEFT MARGIN      47800000
         BE    TEST3270                 YES, NO NEED TO RETURN @YA13248 47850000
         MVC   QCBCARCT,TSBLNSZ         TELL OUTPUT EDIT...             47900000
         NI    QCBRETCT,NOT-QCBNLCR     ...TO RETURN CARRIAGE           47950000
TEST3270 TM    TSBSTAT,TSB3270          3270 TERMINAL?         @YA13248 48000000
         BNO   SENDIDLE                 NO, GO SEND IDLES      @YA13248 48050000
         SR    R9,R9                    YES, DON'T SEND IDLES  @YA13248 48100000
         B     POSTLCB                  FOR 2370.              @YA13248 48150000
*                                                                       48200000
ENDOFBFF EQU   *                                                        48250000
*                                                                       48300000
         L     R2,AYOTSBFF              LOAD ADDR OF CURRENT TS BUFFER  48350000
*                                                                       48400000
         LA    R1,NULL(R1)              CLEAR HI-ORDER BYTE             48450000
         O     R1,TSOMSGC               SET TSO MSG BIT 'ON'            48500000
*                                                                       48550000
         LR    R15,R0                   MOVE FIELD LENGTHS FOR TESTING  48600000
         N     R15,AVTCLRHI             IS THERE ANY OUTPUT MESSAGE?    48650000
         BZ    SENDIDLE                 NO, GO SEND IDLES ONLY          48700000
*                                                                       48750000
         TM    AYOSWTCH,SENDNL          TEST IF TO SEND ONLY IDLES      48800000
         BNO   CHCKEDIT                 NO, GO CHECK EDIT OPTION        48850000
*                                                                       48900000
SENDIDLE EQU   *                                                        48950000
         SR    R2,R2                    INDICATE SEND IDLES ONLY        49000000
*                                                                       49050000
         CLI   QCBCARCT,E41             ENOUGH IN CARRIAGE COUNT        49100000
         BH    PASTFLSH                 YES, DONT SET IT UP     YA06038 49150000
         MVI   QCBCARCT,TWOIDLE         SET CARRIAGE POSITION TO        49200000
*                                       CAUSE IDLES                     49250000
         B     PASTFLSH                 GO TO OUTPUT EDIT        A44839 49300000
*                                                                       49350000
CHCKEDIT EQU   *                                                        49400000
*                                                                       49450000
         TM    AYOSWTCH,CHAINEND        END OF 3270 MSG CHAIN   SA61765 49500000
         BO    PASTFLSH                 YES, SKIP CHECKS        SA61765 49550000
*                                                                       49600000
*        SET BITS IN REGISTER ACCORDING TO TPUT OPTION -                49650000
*        TSOASISC MEANS ASIS, TSOCNTLC MEANS CONTROL, BOTH MEANS        49700000
*        FULL SCREEN                                                    49750000
*                                                                       49800000
         TM    BUFFFL1,BUFFEDIT+BUFFCNTL TEST FOR BOTH, NEITHER SA60002 49850000
         BO    SETFULLS                 BOTH ON, FULL SCREEN    SA60002 49900000
         BZ    SETASIS                  NEITHER, MUST BE ASIS   SA60002 49950000
         SPACE 2                                                SA60002 50000000
*        MUST BE EDIT OR CONTROL                                SA60002 50050000
*                                                                       50100000
         TM    BUFFFL1,BUFFEDIT         CHECK FOR EDIT          SA60002 50150000
         BO    GOEDIT                   SET NO BITS FOR EDIT    SA60002 50200000
         O     R1,TSOCNTLC              SET CONTROL BIT         SA60002 50250000
         B     GOEDIT                   GO CALL EDIT RTN        SA60002 50300000
         SPACE 2                                                SA60002 50350000
SETASIS  EQU   *                                                SA60002 50400000
         O     R1,TSOASISC              SET ASIS BIT            SA60002 50450000
         B     GOEDIT                   GO CALL EDIT RTN        SA60002 50500000
         SPACE 2                                                SA60002 50550000
SETFULLS EQU   *                                                SA60002 50600000
         O     R1,TSOASISC              SET ASIS FOR FULLSCR,   SA60002 50650000
         O     R1,TSOCNTLC              AND ALSO SET CNTL       SA60002 50700000
*                                                                       50750000
GOEDIT   EQU   *                                                        50800000
*                                                                       50850000
         TM    TSBFLG3,TSBTJMSG         IS MESSAGE NON-FLUSHABLE?       50900000
         BO    PASTFLSH                 YES, SKIP FLUSH CHECK           50950000
         TM    TSBFLG1,TSBOFLSH         SHOULD OUTPUT TRAILER QUEUE     51000000
*                                       BE CLEARED?                     51050000
         BO    CLEARQ                   YES, DON'T SEND REST OF MSG     51100000
*                                                                       51150000
PASTFLSH EQU   *                                                        51200000
*          REG.2  - ADDR OF LAST TS BUFFER FROM WHICH DATA WAS MOVED    51250000
         L     R15,AVTTSOPT             LOAD ADDR OF TSINPUT QCB        51300000
         USING IEDQTSI,R15                                              51350000
         L     R15,TSIEDIT              LOAD ADDR OF EDIT ROUTINE       51400000
         TM    AYOSWTCH,INTLRQ          INITIAL REQUEST?        YM2865  51450000
         BNO   DONTINIT                 IF NOT, DON'T TOUCH     YM2865  51500000
*                                       LCBTTBIN (ERP'S USE IT) YM2865  51550000
         MVC   LCBTTBIN,AYOSRCE         SET INDEX TO TNT         A44839 51600000
DONTINIT EQU   *                                                YM2865  51650000
*                                                                       51700000
         BALR  R14,R15                  GOTO EDIT ROUTINE               51750000
*                                                                       51800000
         DROP  R15                                                      51850000
*                                                                       51900000
*********************************************************************** 51950000
*                                                                       52000000
*   RETURN FROM OUTPUT EDIT ROUTINE                                     52050000
*                                                                       52100000
*   EXIT - REG.0  - NO. OF CHARACTERS MOVED INTO TO-FIELD               52150000
*          REG.1  - LENGTH OF DATA MOVED FROM FROM-FIELD                52200000
*          REG.2  - ADDR OF LAST TS BUFFER FROM WHCICH DATA WAS MOVED   52250000
*          REG.15 - RETURN CODE                                         52300000
*                   X'00' - COMPLETE MSSG HAS BEEN MOVED                52350000
*                           (AND 3270 SCREEN IS FULL)                   52400000
*                   X'08' - COMPLETE MSG HAS BEEN MOVED, BUT            52450000
*                           SCREEN IS NOT FULL                          52500000
*                   X'0C' - ONLY PART OF MSSG HAS BEEN MOVED            52550000
*                           AND LINE (OR, FOR 3270, SCREEN)             52600000
*                           ONLY PARTLY FILLED.                         52650000
*                   X'10' - ONLY PART OF TS MSG MOVED BUT TERMINAL      52700000
*                           LINE (OR SCREEN) IS FULL.                   52750000
*                                                                       52800000
*********************************************************************** 52850000
*                                                                       52900000
         LA    R2,NULL(R2)              CLEAR HI-ORDER BYTE             52950000
         ST    R2,AYOTSBFF              STORE IT IN WORK AREA           53000000
*                                                                       53050000
         L     RPREF,AYOHDRBU           LOAD ADDR OF HDR B.U.           53100000
         LH    R14,AYOBULEN             GET PREV NO. AVAILABLE  YS6327  53150000
         SR    R14,R0                   SUBTRACT AMOUNT JUST    YS6327  53200000
*                                       MOVED                   YS6327  53250000
         STH   R14,AYOBULEN             STORE NEW AVAIL SPACE   YS6327  53300000
         L     R14,AYONXTCH             PREV. POINTER           YS6327  53350000
         AR    R14,R0                   ADD AMOUNT MOVED        YS6327  53400000
         ST    R14,AYONXTCH             STORE UPDATED POINTER   YS6327  53450000
         AH    R0,PRFSIZE               GET UPDATED DATA LENGTH YS6327  53500000
         STH   R0,PRFSIZE               STORE UPDATED LENGTH    YS6327  53550000
         DROP  R2                                               YS6327  53600000
*                                                                       53650000
*********************************************************************** 53700000
*                                                                       53750000
*   IF THIS LATEST BASIC UNIT IS THE LAST IN A TCAM BUFFER, DECREMENT   53800000
*   THE COUNT OF TCAM BUFFERS PERMITTED ON THIS REQUEST (LCBERBCT).     53850000
*   IF THE COUNT HAS BEEN EXHAUSTED, TCAM BUFFER BUILDING MUST STOP     53900000
*   FOR THIS REQUEST.                                                   53950000
*                                                                       54000000
*********************************************************************** 54050000
*                                                                       54100000
         LA    R14,AVTECD12             RETURN CODE COMPARISON VALUE    54150000
         LTR   R15,R15                  WAS RETURN CODE = X'00'?YA00526 54200000
         BZ    CANT                     YES, ALL IS OK, SENDMSG YA00526 54250000
         CR    R15,R14                  COMPARE RC WITH X'0C'   YA00526 54300000
         BH    CANT                     GREATER,(10=SCREEN FULL)YA00526 54350000
*                                                                       54400000
*   TEST IF A BUFFER HAS BEEN CONSTRUCTED                               54450000
*                                                                       54500000
         L     R9,AYOHDRBU              LOAD ADDR OF HDR B.U.           54550000
         CLC   AYOBULEN(2),ZEROS        IS CURRENT BU FULL?     YA00526 54600000
         BNE   OVER                     NO, DONT CHECK ERBCNT   YA00526 54650000
         CLC   LCBERBQB(ONE),PRFNBUNT-IEDQPRF(R9) LAST BU IN    YA00526 54700000
*                                                TCAM BUFFER?   YA00526 54750000
         BE    BFRBUILT                 YES, DECREMENT ERBCNT   YA00526 54800000
OVER     CR    R15,R14                  COMPARE RC WITH X'0C'   YA00526 54850000
         BE    GETBASIC                 EQUAL, GET ANOTHER BU   YA00526 54900000
         B     NEXTMSG                  NOTEQUAL (X'08') GET    YA00526 54950000
*                                       GET NEXT TS MESSAGE     YA00526 55000000
*                                                                       55050000
BFRBUILT EQU   *                                                        55100000
         SLR   R0,R0                    CLEAR FOR IC                    55150000
         IC    R0,LCBERBCT              INSERT ENABLED COUNT            55200000
         BCTR  R0,0                     DECREMENT                       55250000
         STC   R0,LCBERBCT              STORE UPDATED ENABLED COUNT     55300000
*                                                                       55350000
         LTR   R0,R0                    IS ENABLED COUNT EXHAUSTED?     55400000
         BNZ   CAN                      NO, BFR BUILDING MAY CONTINUE   55450000
*                                                                       55500000
*   NOTE.  WHEN THE HI-ORDER BIT IS ON IN THE DISABLED COUNT, THE       55550000
*   PCI APPENDAGE WILL UPDATE THE ENABLED COUNT RATHER THAN THE         55600000
*   DISABLED COUNT.                                                     55650000
*                                                                       55700000
         OI    LCBERBCT+1,XXCTUSED      SHOW DISABLED COUNT IN USE      55750000
         CLI   LCBERBCT+1,XXCTUSED      WAS DISABLED COUNT ZERO         55800000
         BNE   MERGCNTS                 NO, GO MERGE COUNTS             55850000
         OI    LCBERBST,LCBDLNKN        MAKE ERB POSTABLE               55900000
         NI    LCBERBCT+1,NOT-XXCTUSED  MAKE DISABLED COUNT USABLE      55950000
         NC    LCBERBCT,LCBERBCT        IS ERB COUNT STILL ZERO         56000000
         BZ    CANNOT                   YES, BFR BUILDING MUST CEASE    56050000
*                                                                       56100000
*   ARRIVAL AT THIS POINT MEANS AN INTERRUPTION OCCURRED DURING         56150000
*   EXECUTION OF THE PREVIOUS 7 INSTRUCTIONS.  LCBDLNKN IS TESTED       56200000
*   TO SEE WHEN THE INTERRUPTION OCCURRED.                              56250000
*   -----IF OFF, THIS MEANS THE INTERRUPT OCCURRED AFTER THE ERB        56300000
*        WAS MARKED POSTABLE.  THE PCI APPENDAGE HAS POSTED THE         56350000
*        ERB TO TSOUTPUT AGAIN.  BUFFER BUILDING SHOULD STOP FOR        56400000
*        THIS REQUEST.                                                  56450000
*   -----IF ON, PCI APPENDAGE COULDN'T POST THE ERB.  BUFFER BUILDING   56500000
*        MAY CONTINUE.  NOTE THAT THE ERB COUNTS NEEDN'T BE             56550000
*        MERGED SINCE THE PCI APPENDAGE UPDATED THE ENABLED COUNT.      56600000
*                                                                       56650000
         TM    LCBERBST,LCBDLNKN        HAS ERB BEEN REPOSTED           56700000
         BNO   CANNOT                   YES, CEASE BFR BUILDING         56750000
         NI    LCBERBST,LCBDLNKF        MAKE ERB NON-POSTABLE           56800000
         B     CAN                      MAY CONTINUE BFR BUILDING       56850000
*                                                                       56900000
*   MERGE DISABLED & ENABLED ERB COUNTS                                 56950000
*                                                                       57000000
MERGCNTS EQU   *                                                        57050000
         IC    R0,LCBERBCT+1            PICK UP DISABLED COUNT          57100000
         MVI   LCBERBCT+1,NULL          DISABLED COUNT NOW 0 & USABLE   57150000
         LA    R1,NOT-XXCTUSED          LOAD MASK TO RESTORE COUNT      57200000
         NR    R0,R1                    CLEAR IN USE BIT                57250000
         IC    R1,LCBERBCT              GET ANYTHING PUT IN ENABLED     57300000
*                                       CNT WHILE DISABLED COUNT        57350000
*                                       WAS IN USE                      57400000
         AR    R0,R1                    MERGE COUNTS                    57450000
         STC   R0,LCBERBCT              STORE MERGED COUNT              57500000
*                                                                       57550000
CAN      EQU   *                                                        57600000
*                                                               YA00526 57650000
*     AT THIS POINT, THE RETURN CODE FROM THE OUTPUT EDIT       YA00526 57700000
*     MUST HAVE BEEN EITHER                                     YA00526 57750000
*                         X'08' -- MEANING ANOTHER TSO MESSAGE  YA00526 57800000
*                                  SHOULD BE OBTAINED AND PACKEDYA00526 57850000
*                                  INTO THE TCAM BUFFERS        YA00526 57900000
*                         X'0C' -- MEANING ANOTHER BASIC UNIT   YA00526 57950000
*                                  IS NEEDED                    YA00526 58000000
*                                                               YA00526 58050000
         CR    R15,R14                  IS ANOTHER BASIC UNIT NEEDED    58100000
         BNE   NEXTMSG                  NO, GET ANOTHER TSO MSG YA00526 58150000
         B     GETBASIC                 NO, GO CONTINUE BFR BUILDING    58300000
*                                                                       58350000
CANT     EQU   *                                                        58400000
         OI    LCBERBST,LCBDLNKN        MAKE ERB 'POSTABLE'             58450000
CANNOT   EQU   *                                                        58500000
         CR    R15,R14                  BFR ALLOCATION ALL USED UP?     58550000
         BE    SENDMSG                  YES, GO SEND MESSAGE            58600000
*                                                                       58650000
*   SET END OF MESSAGE CONDITION FOR THE TCAM MESSAGE                   58700000
*                                                                       58750000
         NI    PRFSTAT1,PRFNLSTF        INDICATE BFR IS LAST            58800000
         OI    LCBERBST,LCBEOMSG        INDICATE END OF MESSAGE         58850000
         MVI   LCBERBCT+1,NULL          CLEAR DISABLED COUNT            58900000
*                                                                       58950000
         LTR   R15,R15                  WAS WHOLE TS MSG MOVED INTO     59000000
*                                       TCAM BUFFERS?                   59050000
         BNZ   SENDMSG                  NO, SKIP END OF MSG PROCESSING  59100000
*                                                                       59150000
*********************************************************************** 59200000
*                                                                       59250000
*   ONE COMPLETE TS MSG HAS BEEN MOVED INTO TCAM BUFFER                 59300000
*                                                                       59350000
*********************************************************************** 59400000
*                                                                       59450000
*   IF THIS MESSAGE IS A PARTIAL INPUT LINE CAUSED BY BREAK-IN, GIVE    59500000
*   PRIORITY TO INPUT ON THIS TERMINAL IN ORDER TO READ REST OF         59550000
*   INPUT MESSAGE.                                                      59600000
*                                                                       59650000
         TM    TSBFLG2,TSBBIPI          IS THIS A PARTIAL LINE?         59700000
         BNO   MOREBFF                  NO, GO CHK FOR MORE MSG'S       59750000
         TM    TSBSTAT,TSBDSPLY         IS THIS A FLASHBACK MSG         59800000
         BO    MOREBFF                  YES, GO CHK FOR MORE MSG'S      59850000
         OI    QCBFLAG,QCBREAD          GIVE READ PRIORITY ON TERM      59900000
         B     SENDMSG                  GO SEND MESSAGE                 59950000
*                                                                       60000000
MOREBFF  EQU   *                                                        60050000
*                                                                       60100000
         CLC   TSBOBFP,ZEROS            TEST IF ANY MORE TS MSG         60150000
         BNE   SENDMSG                  YES,GOTO SEND THIS TS MSG       60200000
*                                                                       60250000
         TM    TSBFLG2,TSBAUTON         IS AUTO PROMPTING REQUESTED?    60300000
         BZ    SENDMSG                  NO, GO SEND MESSAGE             60350000
*                                                                       60400000
         TM    QCBTSOF1,QCBPARTO        IS REST OF MSG YET TO    TS1638 60450000
*                                       COME                     TS1638 60500000
         BO    SENDMSG                  YES, DON'T AUTO PROMPT   TS1638 60550000
*                                       YET                      TS1638 60600000
*                                                                       60650000
         TM    TSBFLG3,TSBSPIT          IS TCLEARQ IN PROGRESS          60700000
         BO    SENDMSG                  YES, DON'T AUTO PROMPT          60750000
         OI    SCBERR2,SCBALN           REQUEST AUTO PROMPTING          60800000
*                                       BY MSGGEN                       60850000
         B     SENDMSG                  GO SEND MESSAGE                 60900000
*                                                                       60950000
*********************************************************************** 61000000
*                                                                       61050000
NEXTMSG  EQU   *                                                SA61765 61100000
*                                                                       61150000
*********************************************************************** 61200000
*                                                                       61250000
*   FOR 3270, OUTPUT EDIT HAS INDICATED THAT A COMPLETE TS MESSAGE      61300000
*    HAS BEEN PUT INTO TCAM BUFFERS, BUT THE SCREEN IS NOT FULL, SO     61350000
*    BRANCH BACK TO GET ANY MORE TS MESSAGES AND BLOCK THEM IN THE      61400000
*    TCAM BUFFERS.                                                      61450000
*                                                                       61500000
*********************************************************************** 61550000
         BAL   R14,TSBADDR              SET UP ADDRESSES FOR QTPSA61765 61600000
         OI    AYOSWTCH,MSGCHAIN        SHOW A CHAIN HAS BEGUN  SA61765 61650000
         B     CHAINBUF                 GO CHECK FOR MORE MSGS  SA61765 61700000
         SPACE 2                                                SA61765 61750000
*********************************************************************** 61800000
*                                                                       61850000
NOOUTPUT EQU   *                                                        61900000
*                                                                       61950000
*********************************************************************** 62000000
*                                                                       62050000
*   NO OUTPUT TO SEND                                                   62100000
*        1 - CHECK FOR END OF 3270 MESSAGE CHAIN AND HANDLE IF SO       62150000
*        2 - CHECK EXCEPTIONAL CONDITIONS AND HANDLE, OTHERWISE         62200000
*            POST LCB TO ITSELF                                         62250000
*        3 - INITIAL OR SUBSEQUENT PCI                                  62300000
*            COMPLETE REQUEST BY SENDING ONE IDLE CHARACTER             62350000
*                                                                       62400000
*********************************************************************** 62450000
*                                                                       62500000
         TM    AYOSWTCH,MSGCHAIN        WAS A 3270 CHAIN BEGUN  SA61765 62550000
         BNO   REALLYNO                 NO, GO DO NOOUTPUT      SA61765 62600000
         SPACE 2                                                SA61765 62650000
*********************************************************************** 62700000
*                                                                       62750000
         OI    QCBRETCT,DOEOM           SIGNAL EOM TO EDIT      SA61765 62800000
         OI    AYOSWTCH,CHAINEND        SIGNAL EOM TO TSOUTPUT  SA61765 62850000
         B     WATSLEFT                 USE CURRENT BU IF POSS  YS6327  62900000
         SPACE 2                                                SA61765 62950000
REALLYNO EQU   *                                                SA61765 63000000
         TM    AYOSWTCH,INTLRQ          IS THIS AN INITIAL REQUEST      63050000
         BNO   NOTINTL                  NO, SET UP TO SEND 1 IDLE       63100000
*                                                                       63150000
         SR    R9,R9                    CLEAR MSGGEN MASK REG    M0141  63200000
         TM    TSBSTAT,TSBDISC          USER BEING LOGGED OFF?          63250000
         BNO   CKBRK1                   NO, DON'T CK SPECIAL MSG M0141  63300000
*                                                                       63450000
*   TEST FOR SPECIAL MESSAGES TO BE SENT                                63500000
*                                                                       63550000
         TM    TSBFLG4,TSBOCAB          OUT-OF-CORE ABEND      @G36XRYP 63600000
         BZ    POSTLCB                  NO, POST LCB           @G36XRYP 63650000
         LA    R9,MSKOCAB               SET MSGGEN MASK          M0141  63700000
         B     PASTLCB                  GO CHECK FOR CLEANUP     M0141  63750000
*                                                                       64100000
CKBRK1   EQU   *                                                 M0141  64150000
         TM    QCBTSOF2,QCBBUFQ         IS TSINPUT HOLDING BFRS  M0141  64200000
         BO    POSTLCB                  YES, POST LCB            M0141  64250000
*                                                                       64300000
         TM    TSBFLG3,TSBSPIT          IS TCLEARQ IN PROGRESS   M0141  64350000
         BO    POSTLCB                  YES, DON'T WORRY BREAKIN M0141  64400000
*                                                                       64450000
         TM    QCBTSOF1,QCBPARTO        MORE MSGS TO COME        M0141  64500000
         BO    POSTLCB                  YES, DON'T PROMPT IN     M0141  64550000
*                                       MIDDLE OF MESSAGE               64600000
         TM    TSBFLG2,TSBBRKIN         DID BREAKIN OCCUR        M0141  64650000
         BO    PASTLCB                  YES, DON'T FREE LINE     M0141  64700000
*                                                                       64750000
POSTLCB  EQU   *                                                 M0141  64800000
*                                                                       64850000
*   ISSUE QTIP SVC TO RESET QCBTPUT AND QCBWRBRK, AND TPOST THE         64900000
*   LCB TO ITSELF, ALL WHILE DISABLED.                                  64950000
*                                                                       65000000
         QTIP  QTIP6TH,(RSAVE)                                   M0141  65050000
*                                                                       65100000
         STC   R15,AYORC                SAVE RETURN CODE        YM2814  65150000
         BCTR  R9,R0                    MAKE REG NEG, TO SHOW   YM2814  65200000
*                                       THAT QTIP WAS CALLED    YM2814  65250000
*                                                                       65300000
PASTLCB  EQU   *                                                 M0141  65350000
*                                                                       65400000
*   CLEAN UP TCAM AND TSO CONTROL BLOCKS IF REQUESTED                   65450000
*                                                                       65500000
         TM    TSBSTAT,TSBDISC          CLEANUP REQUESTED        M0141  65550000
         BNO   CKBRK2                   NO, GO SEE WHAT ELSE TO  M0141  65600000
*                                       DO                              65650000
         QTIP  QTIP4TH,(RSAVE)          CLEAN UP TSO CONTROL BLK M0141  65700000
*                                                                       65750000
         BAL   R5,SESCLEAN              CLEAN UP TCAM CNTRL BLKS M0141  65800000
CKBRK2   EQU   *                                                 M0141  65850000
         CLI   AYORC,NULL               WAS RETURN FROM OO ZERO YM2814  65900000
         BNE   AUTOPRMT                 NO, GO START AUTO PRMPT YM2814  65950000
         LTR   R9,R9                    DID WE CALL QTIP TO     YM2814  66000000
*                                       TPOST LCB, ETC.         YM2814  66050000
         BP    GOMSGGEN                 NO, THERE IS A LOGOFF   YM2814  66100000
*                                       MESSAGE TO SEND         YM2814  66150000
         BZ    CHKBRKIN                 NO CALL, NO MSG, CK BRK YM2814  66200000
*                                                                       66250000
*                                                                       66300000
*   THERE IS NO OUTPUT TO SEND SO CLEAN-UP TCAM STATUS INDICATORS       66350000
*   WHICH WERE SET UP FOR OUTPUT                                        66400000
*                                                                       66450000
CLEANOUT EQU   *                                                        66500000
         SR    R0,R0                    CLEAR REGISTER                  66550000
         ST    R0,SCBERRST              ZERO ERROR INDICATORS           66600000
         ST    R0,SCBDEOB               ZERO SCB STATUS                 66650000
         STH   R0,SCBEOB                ZERO SCB FIELD                  66700000
         MVI   LCBSENS0,NULL            ZERO SENSE BYTE                 66750000
         ST    R0,LCBERBCH-1            CLEAR ERB STATUS & CHAIN        66800000
         XC    LCBLSPCI,LCBLSPCI        LAST SERVICED PCI               66850000
         NI    LCBCHAIN,NOT-LCBBFRSZ-LCBABRTN-LCBEXCP                   66900000
         NI    LCBTSOB,NOT-LCBTSBUF-LCBINHBN-LCBWRBRK                   66950000
         NI    LCBSTAT2,LCBMSGNF        RESET MSGGEN BIT                67000000
         NI    LCBSTAT1,NOT-LCBRCLLN    RESET RECALL BIT                67050000
*                                                                       67100000
         LA    R1,X0100                 GET MASK ADDRESS                67150000
         STCM  R1,7,SCBMACR             STORE MASK ADDRESS     @Y17XAYP 67200000
         LA    R1,AVTBFRTB              GET ADDR OF BFR RET Q           67250000
         STCM  R1,7,SCBDESTQ            STORE BFR RET Q ADDR   @Y17XAYP 67300000
         B     DISP                     GO EXIT TO TCAM DISPATCHER      67350000
*                                                                       67400000
*********************************************************************** 67450000
*                                                                       67500000
TSABEND  EQU   *                                                        67550000
*                                                                       67600000
*********************************************************************** 67650000
*                                                                       67700000
*   TS HAS ABENDED                                                      67750000
*        -- CLEAN UP TCAM CONTROL BLOCKS                                67800000
*        -- SEND TS ABEND MESSAGE USING MSGGEN INTERFACE                67850000
*                                                                       67900000
         BAL   R5,SESCLEAN              GO CLEAN-UP TCAM BLOCKS         67950000
         LA    R9,ABNDMSK               PT TO PROPER MSGGEN MASK        68000000
         B     GOMSGGEN                 GO PUT OUT MESSAGE              68050000
*                                                                       68100000
*********************************************************************** 68150000
*                                                                       68200000
AUTOPRMT EQU   *                                                        68250000
*                                                                       68300000
*   USE MSGGEN INTERFACE TO SEND AUTO PROMPT SEQUENCE                   68350000
*                                                                       68400000
         OI    SCBERR2,SCBALN           ASK MSGGEN FOR AUTO LINE NO.    68450000
         LA    R9,AUTOMSK               PT TO PROPER MSGGEN MASK        68500000
*                                                                       68550000
*********************************************************************** 68600000
*                                                                       68650000
*   THIS ROUTINE IS AN INTERFACE TO GO TO MSGGEN TO SEND A MESSAGE      68700000
*                                                                       68750000
*        REGISTERS AT EXIT TO MSGGEN--                                  68800000
*          REG 1 = 0                                                    68850000
*          REG 3 = ADDR OF SCB                                          68900000
*          REG 4 = ADDR OF LCB                                          68950000
*          REG 8 = ADDR OF MSSGEN MASK                                  69000000
*          REG 9 = IC REG                                               69050000
*          REG 11= ADDR OF DISPATCHER                                   69100000
*          REG 12= ADDR IN TSIMSGEN                                     69150000
*          REG 13= ADDR OF AVTSAVE2                                     69200000
*                                                                       69250000
GOMSGGEN EQU   *                                                        69300000
*                                                                       69350000
         MVC   LCBTTCIN,AYOSRCE         MOVE IN TERMINAL INDEX          69400000
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN CLEAR STATUS          @OY14092 69450000
         OI    LCBSTAT1,LCBRECVN        SET RECEIVE STATE      @YA11542 69550000
         LA    R15,X0100                LOAD ADDR OF X0100              69600000
         STCM  R15,7,SCBMACR            STORE IT IN SCB        @Y17XAYP 69650000
         LR    R8,R9                    GET MSGGEN MASK POINTER         69700000
*                                                                       69750000
         L     R2,AVTTSOPT              LOAD ADDR OF TSI                69800000
         USING IEDQTSI,R2                                               69850000
         L     R12,TSIMSGEN             LOAD ADDR OF MSSGEN RTN         69900000
         SR    R1,R1                    SET R1=0                        69950000
         L     R11,AVTEA                LOAD DISPATCHER ADDR            70000000
         BR    R12                      GOTO MSSGEN ROUTINE             70050000
*                                                                       70100000
         DROP  R2                                                       70150000
*                                                                       70200000
*********************************************************************** 70250000
*                                                                       70300000
NOTINTL  EQU   *                                                        70350000
*                                                                       70400000
*********************************************************************** 70450000
*                                                                       70500000
*   THERE IS NO OUTPUT FOR INITIAL AND SUBSEQUENT PCI                   70550000
*        1 - TO TERMINATE SEND OPERATION,SET-UP TO SEND 1 IDLE          70600000
*        2 - THEN TREAT LIKE A NORMAL OPERATION                         70650000
*                                                                       70700000
*********************************************************************** 70750000
*                                                                       70800000
         XC    AYOTSBFF(E4),AYOTSBFF    RESET TS BUFFER POINTER         70850000
*                                                                       70900000
         OI    AYOSWTCH,SENDNL          SET TO SEND 1 DUMMY IDLE CHAR   70950000
         B     GETBASIC                 GOTO GET BASIC UNIT             71000000
*                                                                       71050000
*********************************************************************** 71100000
*                                                                       71150000
CHKBRKIN EQU   *                                                        71200000
*                                                                       71250000
*********************************************************************** 71300000
*                                                                       71350000
*   'TSBBRKIN' ON CAUSED ARRIVAL AT THIS POINT.  THIS MEANS ONE OF      71400000
*   THE FOLLOWING--                                                     71450000
*        --THE USER WAS INTERRUPTED BY A BREAK-IN MESSAGE WHILE         71500000
*          ENTERING INPUT AND NEEDS TO HAVE THAT INPUT SENT OUT TO HIM  71550000
*          TO PROMPT HIM TO COMPLETE HIS MESSAGE.                       71600000
*        --THE USER'S SCREEN FILLED UP AND WAS ERASED WHILE HE WAS      71650000
*          ENTERING INPUT, SO THE LAST PART OF HIS INPUT NEEDS TO BE    71700000
*          SENT TO REORIENT HIM.                                        71750000
*                                                                       71800000
*********************************************************************** 71850000
*                                                                       71900000
*  ISSUE QTIP CALL TO PUT MSG ON TRAILER QUEUE                          71950000
*                                                                       72000000
         QTIP  QTIP5TH,(RSAVE)          PUT PARTIAL MSG ON TRLR Q       72050000
*                                                                       72100000
         B     BUILDBFF                 GO SEND REPROMPT                72150000
*                                                                       72200000
*********************************************************************** 72250000
*                                                                       72300000
SENDMSG  EQU   *                                                        72350000
*                                                                       72400000
*********************************************************************** 72450000
*                                                                       72500000
*   ON AN INITIAL REQUEST TPOST THE ERB TO THE ACTIVATE ROUTINE.        72550000
*   ON A PCI REQUEST TPOST THE BUFFER TO THE MESSAGE HANDLER.           72600000
*   ADDITIONALLY, ON A SUBSEQUENT PCI REQUEST, TPOST ERB TO             72650000
*   TSOUTPUT IF LCBERBCT IS NOT EXHAUSTED.                              72700000
*                                                                       72750000
*********************************************************************** 72800000
*                                                                       72850000
         MVC   PRFLINK,ZEROS            CLEAR LINK FIELD                72900000
         L     R2,LCBERBCH-1            LOAD ADDR OF 1ST BFFR           72950000
*                                                                       73000000
         ST    RQCB,SCBSCSEG-1          STORE DESTINATION QCB ADDR      73050000
         OI    LCBTSOB,LCBTSBUF         SET THIS IS A TSBUF BIT         73100000
         L     RDCB,LCBDCBPT            LOAD DCB ADDR                   73150000
*                                                                       73200000
         LA    R1,LCBERB                LOAD ADDR OF ERB                73250000
         TM    AYOSWTCH,INTLRQ          TEST IF INTIAL REQUEST          73300000
         BNO   POSTMH                   NO ,POST TO MH                  73350000
*                                                                       73400000
*   WHEN IT IS INITIAL REQUEST                                          73450000
*        1 - IF DYNAMIC BFFRING IS NOT SPECIFIED,MAKE THIS AS END OF    73500000
*            TCAM MSG                                                   73550000
*        2 - POST ERB TO ACTIVATE (PRI=PRIACTIV)                        73600000
*                                                                       73650000
         MVC   LCBTTBIN(R2),AYOSRCE     SET INDEX TO TNT         YM2865 73700000
         TM    DCBPCI,DYNMBFFR          TEST IF DYNAMIC BFFRING SPEC.   73750000
         BO    DYNAMIC                  YES,DYNAMIC BFFRING SPECIFIED   73800000
*                                                                       73850000
*   WHEN DYNAMIC BFFRING IS NOT SPECIFIED - TREAT THIS MSG AS END OF    73900000
*        1 - TURN 'NOT LAST BFFR' BIT OFF              TCAM MSG         73950000
*        2 - SET LCBEOMSG 'ON'                                          74000000
*                                                                       74050000
         NI    PRFSTAT1,PRFNLSTF        RESET 'NOT LAST BFR' BIT        74100000
         OI    LCBERBST,LCBEOMSG        SET END OF MSG BIT              74150000
         MVI   LCBERBCT+1,NULL          CLEAR DISABLED COUNT            74200000
*                                                                       74250000
DYNAMIC  EQU   *                                                        74300000
*                                                                       74350000
*                                                                       74400000
*   WHEN INITIAL REQUEST - POST ERB TO ACTIVATE                         74450000
*                                                                       74500000
         LA    R2,AVTACTIB              LOAD ADDR OF ACTIVATE QCB       74550000
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @YM07794 74600000
         BNE   POSTERB                  BR NO                  @YM07794 74650000
         L     R2,AVTSAVTP              GET SAVT ADDR          @YM07794 74700000
         USING IEDNSVTD,R2              SAVT ADDRESSABILITY    @YM07794 74750000
         L     R2,SAVTCNIR              IEDNKA QCB ADDR        @YM07794 74800000
         DROP  R2                                              @YM07794 74850000
*                                                                       74900000
POSTERB  EQU   *                                                        74950000
         MVI   LCBERBPY,PRIACTIV        SET PRI=PRIACTIV                75000000
         B     POST                     GOTO DSPPOST                    75050000
*                                                                       75100000
POSTMH   EQU   *                                                        75150000
*                                                                       75200000
         XC    LCBERBCH,LCBERBCH        CLEAR LCB CHAIN FIELD           75250000
         LR    R1,RPREF                 LOAD BUFFER ADDR                75300000
         L     R2,LCBMHA-1              ASSUME PLCB AND GET    @Y17XAYP 75350000
*                                       MH ADDRESS             @Y17XAYP 75400000
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @Y17XAYP 75450000
         BE    SETPRI                   BR YES                 @Y17XAYP 75500000
         L     R2,DCBMH-1               LOAD MH QCB ADDR                75550000
SETPRI   EQU   *                                               @Y17XAYP 75600000
         MVI   PRFPRI,PRIMHBFR          SET PRIORITY                    75650000
*                                                                       75700000
         NC    LCBERBCT,LCBERBCT        IS ERB COUNT EXHAUSTED?         75750000
         BZ    POST                     YES, GO TPOST TO MH             75800000
*                                                                       75850000
         BAL   R14,POSTR                TPOST TO MH & COME BACK         75900000
         TM    LCBERBST,LCBEOMSG        IS IT END OF MSG                75950000
         BO    DISP                     YES, TSOUTPUT NEEDN'T REGAIN    76000000
*                                       CONTROL                         76050000
         L     RSCB,LCBSCBA-1           RESTORE RSCB AFTER DSPPOSTR     76100000
*                                                                       76150000
         TM    AYOSWTCH,SUBPCI          TEST IF SUBSEQUENT PCI          76200000
         BO    POSTAYO                  YES, GO TPOST TSOUTPUT          76250000
*                                                                       76300000
         L     RQCB,SCBDESTQ-1          RESTORE RQCB AFTER DSPPOSTR     76350000
         B     GETBASIC                 GO BUILD ANOTHER TCAM BFR       76400000
*                                                                       76450000
POSTAYO  EQU   *                                                        76500000
         LA    R2,AVTDSIOB              LOAD ADDR OF TSOUTPUT'S QCB     76550000
         LA    R1,LCBERB                LOAD ADDR OF ERB                76600000
         MVI   LCBERBPY,PRISBPCI        SET PRIORITY                    76650000
         B     POST                     GO TPOST ERB TO TSOUTPUT        76700000
*                                                                       76750000
*********************************************************************** 76800000
*                                                                       76850000
NOBFRS   EQU   *                                                        76900000
*                                                                       76950000
*********************************************************************** 77000000
*                                                                       77050000
*   IF TSOUTPUT RUNS OUT OF BASIC UNITS WHILE BUILDING TCAM BUFFERS,    77100000
*   IT PUTS THE ERB IN THE TOP OF THE ELEMENT CHAIN OF THE BUFFER       77150000
*   RETURN QCB TO WAIT FOR A BASIC UNIT TO BECOME AVAILABLE.  WHEN      77200000
*   ONE DOES, IT WILL BE TPOSTED TO TSOUTPUT AT ITS SECONDARY ENTRY     77250000
*   POINT, IEDAYO02.                                                    77300000
*                                                                       77350000
*********************************************************************** 77400000
*                                                                       77450000
         TM    LCBERBST,LCBINQ          TEST IF ERB ALREADY IN Q        77500000
         BO    CHCKBFF                  YES, DON'T PUT IN AGAIN         77550000
*                                                                       77600000
         OI    LCBERBST,LCBINQ          SHOW ERB ENQUEUED               77650000
         MVI   LCBERBPY,PRIDSKBF        SET PRI TO OBTAIN BFF FROM BFFR 77700000
*                                       RETURN                          77750000
*                                                                       77800000
         MVC   LCBERBLK(E3),AVTBFRTB+1  LINK ERB TO CURRENT FIRST ON Q  77850000
         LA    R1,LCBERB                LOAD ADDR OF THIS ERB           77900000
         ST    R1,AVTBFRTB              STORE IT INTO BFF RTN QCB       77950000
*                                                                       78000000
CHCKBFF  EQU   *                                                        78050000
*                                                                       78100000
DISP     EQU   *                                                        78150000
         L     R11,AVTEA                LOAD ADDR OF DISPATCHER         78200000
         B     DSPDISP                  EXIT TO TCAM DISPATCHER         78250000
*                                                                       78300000
*********************************************************************** 78350000
*                                                                       78400000
         CNOP  0,4                                                      78450000
*                                                                       78500000
*********************************************************************** 78550000
*                                                                       78600000
*********************************************************************** 78650000
*                                                                       78700000
IEDAYO02 EQU   *                                                        78750000
*                                                                       78800000
*********************************************************************** 78850000
*                                                                       78900000
*   STCB FOR SECOND ENTRY                                               78950000
*                                                                       79000000
         DC    AL1(DSPMCPL8),AL3(0),A(0)  STCB FIELDS            S22029 79050000
*                                                                       79100000
*********************************************************************** 79150000
*                                                                       79200000
*   SECOND ENTRY POINT                                                  79250000
*                                                                       79300000
*        INPUT - REG.1 - ADDR OF BASIC UNIT OR QCB                      79350000
*                REG.3 - ADDR OF STCB                                   79400000
*                REG.7 - ADDR OF CPB CLEAN-UP QCB                       79450000
*                REG.11 - ADDR OF DISPATCHER                            79500000
*                REG.13 - ADDR OF AVTSAVE2                              79550000
*                REG.15 - ENTRY ADDR                                    79600000
*                                                                       79650000
*        ELEMENT IS QCB - EXIT TO DSPBYPAS                              79700000
*                                                                       79750000
*        ELEMENT IS BASIC UNIT                                          79800000
*                A - IF LCBERROR IS 'ON' - POST THE BASIC UNIT AND      79850000
*                                          OTHER TCAM BUFFER TO BUFFER  79900000
*                                          RETURN.                      79950000
*                                  'OFF' - CONTINUE TO BUILD BUFFER     80000000
*                                                                       80050000
*        IF LCBTSBUF IS NOT 'ON' - EXIT TO DSPBYPAS                     80100000
*                                                                       80150000
*********************************************************************** 80200000
*                                                                       80250000
         USING *,R15                                                    80300000
         L     RBASE,BASE               INITIALIZE BASE                 80350000
         DROP  R15                                                      80400000
*                                                                       80450000
         LA    RQCB,0(RQCB)                                      S22029 80500000
         LA    R1,0(R1)                                          S22029 80550000
         LTR   R1,R1                    IS ELEMENT ADDRESS ZERO         80600000
         BZ    CPBCLNUP                 YES, GIVE CTL TO TCAM    S22029 80650000
*                                       CPB CLEANUP RTN                 80700000
         CLR   RQCB,R1                  IS ELEMENT CPB CLEANUP'S S22029 80750000
*                                       QCB                             80800000
         BNE   MUSTBEBU                 NO,MUST BE BASIC UNIT           80850000
*                                       WHEN CPB CLEANUP'S QCB          80900000
*                                       IS POSTED, EXIT TO CPB          80950000
*                                       CLEANUP                         81000000
*                                                                       81050000
*********************************************************************** 81100000
*                                                                       81150000
*   EXIT TO TCAM CPB CLEANUP/INIT ROUTINE                               81200000
*                                                                       81250000
*********************************************************************** 81300000
*                                                                       81350000
         DROP  R3                                                       81400000
         USING IEDQTSI,R3                                        S22029 81450000
CPBCLNUP EQU   *                                                 S22029 81500000
         L     R3,AVTTSOPT              PICKUP TSINPUT QCB       S22029 81550000
         L     R3,TSICPBC               PICKUP STCB ADDRESS OF   S22029 81600000
*                                       TCAM CPB CLEANUP RTN            81650000
         B     DSPBYPAS                 GO TO CPB CLEANUP        S22029 81700000
*                                                                       81750000
CPBINIT  EQU   *                                                 S22029 81800000
         L     R3,AVTTSOPT              PICKUP TSINPUT QCB       S22029 81850000
         L     R3,TSICPBI               PICKUP STCB ADDRESS OF   S22029 81900000
*                                       CPB INITIALIZATION RTN          81950000
         L     RQCB,0(,R1)              INSURE QCB POINTER OK   SS22029 82000000
         B     DSPBYPAS                 GO TO CPB INITIALIZATION S22029 82050000
*                                                                       82100000
*********************************************************************** 82150000
*                                                                       82200000
MUSTBEBU EQU   *                                                        82250000
*                                                                       82300000
*********************************************************************** 82350000
*                                                                       82400000
*                                                                       82450000
*   WHEN BASIC UNIT IS PASSED                                           82500000
*                                                                       82550000
*              1 - IF QCBTSSES IS 'OFF' - EXIT TO DSPBYPAS              82600000
*              2 - IF QCBTSSES IS 'ON'                                  82650000
*                   A - IF LCBERROR 'ON' - POST THE BASIC UNIT AND BFFR 82700000
*                                          IN CHAIN TO BFFR RETURN      82750000
*                   B - IF LCBERROR 'OFF'- CONTINUE TO BUILD BFFR       82800000
*                                                                       82850000
*********************************************************************** 82900000
*                                                                       82950000
         DROP  R3                                                       83000000
         USING IEDQSCB,R3                                               83050000
         LR    RPREF,R1                 LOAD ELEMENT ADDR               83100000
         L     RLCB,PRFLCB-1            LOAD ADDR OF LCB                83150000
         L     RSCB,LCBSCBA-1           LOAD SCB ADDR                   83200000
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN RECALLING OR RECVING  YA02104 83250000
         BNZ   CPBCLNUP                 YES, TREAT AS NON-TSO   YA02104 83300000
         L     RQCB,SCBDESTQ-1          LOAD QCB ADDR                   83350000
*                                                                       83400000
         TM    QCBFLAG,QCBTSSES         TEST IF TSO IN SESSION          83450000
         BNO   CPBCLNUP                 GO TO CPB CLEANUP        S22029 83500000
*                                                                       83550000
         LH    R14,AVTAVFCT             GET AVAILABLE COUNT    @YM09096 83560000
         BCTR  R14,0                    REDUCE                 @YM09096 83570000
         STH   R14,AVTAVFCT             RESTORE COUNT          @YM09096 83580000
         NI    LCBERBST,NOT-LCBINQ      ERB NO LONGER ENQUEUED          83600000
         TM    LCBERBST,LCBERROR        TEST IF ANY I/O ERROR OCCURRED  83650000
         BNO   BUGOTTEN                 NO,GOTO PROCESS THE BASIC UNIT  83700000
*                                                                       83750000
*   TPOST ERB TO RECALL, TPOST BASIC UNITS TO BUFFER RETURN.            83800000
*                                                                       83850000
         MVC   LCBERBQB,LCBRCQCB+1      GET RECALL QCB ADDR             83900000
         ST    RPREF,LCBERBLK-1         LINK ERB TO BASIC UNIT          83950000
         MVI   LCBERBPY,PRIDSPLB-1      SET RECALL PRIORITY    @YA07902 84000000
         LA    R1,LCBERB                POINT ELEMENT POINTER AT ERB    84050000
*                                                                       84100000
RETURNBU EQU   *                                                        84150000
         LA    R2,AVTBFRTB              GET ADDR OF BFR RETURN QCB      84200000
         ST    R2,PRFQCBA-1             PUT QCB ADDR IN ELEMENT         84250000
         MVI   PRFPRI,PRIBFRTB          SET PRIORITY                    84300000
*                                                                       84350000
         MVC   PRFLINK,LCBERBCH         LINK BFR CHAIN WITH B.U.        84400000
         NC    LCBERBCH,LCBERBCH        ANYTHING IN CHAIN               84450000
         BZ    CHAIN                    GO TPOST IF NOTHING IN CHAIN    84500000
*                                                                       84550000
         XC    LCBERBCH,LCBERBCH        CLEAR BFR CHAIN POINTER         84600000
*                                                                       84650000
RDYELEM  EQU   *                                                        84700000
         L     RPREF,PRFLINK-1          POINT AT NEXT BFR               84750000
         ST    R2,PRFQCBA-1             PUT QCB ADDR IN ELEM            84800000
         MVI   PRFPRI,PRIBFRTB          SET TPOST PRIORITY              84850000
*                                                                       84900000
         NC    PRFLINK,PRFLINK          LAST BFR IN CHAIN               84950000
         BZ    CHAIN                    YES, GO TPOST                   85000000
         B     RDYELEM                  CONTINUE MAKING ELEMENTS        85050000
*                                       READY TO TPOST                  85100000
*                                                                       85150000
*********************************************************************** 85200000
*                                                                       85250000
BUGOTTEN EQU   *                                                        85300000
*                                                                       85350000
*   IF ATTENTION HAS BEEN HIT, FREE ALL BASIC UNITS ASSOCIATED          85400000
*   WITH THIS REQUEST.                                                  85450000
*                                                                       85500000
         TM    SCBERR3,SCBATTN          TEST IF ATTN HIT                85550000
         BO    RETURNBU                 YES, GO RETURN ALL BASIC UNITS  85600000
*                                                                       85650000
         TM    AVTBIT3,AVTTSAB          TEST IF TSO HAS ABENDED  A44839 85700000
         BO    TESTRQST                 YES, CHECK FOR INIT      A44839 85750000
*                                       REQUEST                  A44839 85800000
         BAL   R14,TSBADDR              GOTO GET TSB ADDR               85850000
*                                                                       85900000
         LR    R5,RPREF                 POINT TO NEWEST BASIC UNIT      85950000
         B     CHKCHAIN                 GOTO BUILD TCAM BFFR RTN        86000000
*                                                                       86050000
*   WHEN TSO HAS ABENDED, IF IT IS AN INITIAL REQUEST, FREE ALL BASIC   86100000
*   UNITS, IF IT IS A PCI REQUEST, TERMINATE SEND OPERATION AND SET     86150000
*   UP TO SEND 1 IDLE                                                   86200000
*                                                                       86250000
TESTRQST EQU   *                                                 A44839 86300000
         TM    AYOSWTCH,INTLRQ          CHECK FOR INITIAL        A44839 86350000
*                                       REQUEST                  A44839 86400000
         BO    RETURNBU                 YES, RETURN ALL BASIC    A44839 86450000
*                                       UNITS                    A44839 86500000
         XC    AYOTSBFF(E4),AYOTSBFF    RESET TS BUFFER POINTER  A44839 86550000
         OI    AYOSWTCH,SENDNL          SET TO SEND 1 DUMMY IDLE A44839 86600000
*                                       CHAR                     A44839 86650000
         B     CHKCHAIN                 GOTO BUILD TCAM BFR RTN  A44839 86700000
*********************************************************************** 86750000
*                                                                       86800000
*                                                                       86850000
*********************************************************************** 86900000
*                                                                       86950000
POSTR    EQU   *                                                        87000000
*                                                                       87050000
*********************************************************************** 87100000
*                                                                       87150000
*   EXIT TO TCAM - DSPPOSTR (SEE TDISPD DSECT)                          87200000
*                                                                       87250000
*        AT RETURN REG.3 AND 7 MAY BE DESTROYED                         87300000
*                                                                       87350000
*********************************************************************** 87400000
*                                                                       87450000
         ST    R2,PRFQCBA-1-IEDQPRF(R1) STORE QCB ADDR                  87500000
         L     R11,AVTEA                LOAD ADDR OF DISPATCHER         87550000
         B     DSPPOSTR                 GOTO DISPATCHER TO POST AND RTN 87600000
*                                                                       87650000
*********************************************************************** 87700000
*                                                                       87750000
*                                                                       87800000
*********************************************************************** 87850000
*                                                                       87900000
POST     EQU   *                                                        87950000
*                                                                       88000000
*********************************************************************** 88050000
*                                                                       88100000
*   EXIT TO TCAM - DSPPOST (SEE TDISPD DSECT)                           88150000
*                                                                       88200000
*********************************************************************** 88250000
*                                                                       88300000
         ST    R2,PRFQCBA-1-IEDQPRF(R1) STORE QCB ADDR                  88350000
         L     R11,AVTEA                LOAD ADDR OF DISPATCHER         88400000
         BAL   R14,DSPPOST              GOTO TCAM DSPPOST      @G36XRYP 88450000
*                                                                       88500000
*********************************************************************** 88550000
*                                                                       88600000
CHAIN    EQU   *                                                        88650000
*                                                                       88700000
*********************************************************************** 88750000
*                                                                       88800000
*   EXIT TO TCAM - DSPCHAIN (SEE TDISPD DSECT)                          88850000
*                                                                       88900000
*********************************************************************** 88950000
*                                                                       89000000
         L     R11,AVTEA                LOAD ADDR OF DISPATCHER         89050000
         BAL   R14,DSPCHAIN             GOTO TCAM DSPCHAIN     @G36XRYP 89100000
*                                                                       89150000
*********************************************************************** 89200000
*                                                                       89250000
*                                                                       89300000
*********************************************************************** 89350000
*                                                                       89400000
TSBADDR  EQU   *                                                        89450000
*                                                                       89500000
*********************************************************************** 89550000
*                                                                       89600000
*   OBTAIN TSB ADDR IN RTSB & TIOCRPT ADDR IN R10                       89650000
*                                                                       89700000
*********************************************************************** 89750000
*                                                                       89800000
         L     R10,CVTPTR               LOAD CVT ADDR                   89850000
         DROP  R10                                                      89900000
         USING CVT,R10                                                  89950000
         L     R15,CVTASVT              GET ASVT ADDRESS       @G36XRYP 89953000
         USING ASVT,R15                 ASVT ADDRESSABILITY    @G36XRYP 89956000
         L     R10,CVTAQAVT             GET TCX ADDRESS        @G36XRYP 89959000
         DROP  R10                                             @G36XRYP 89962000
         USING IEDQTCX,R10              TCX ADDRESSABILITY     @G36XRYP 89965000
         L     R10,TCXRPT               GET TIOCRPT ADDRESS    @G36XRYP 89968000
         DROP  R10                                             @G36XRYP 89971000
         USING TIOCRPT,R10              RPT ADDRESSABILITY     @G26XRYP 89974000
         LH    RTSB,QCBTJID             GET ASID               @G36XRYP 89977000
         BCTR  RTSB,0                   DECREMENT ASID FOR     @G36XRYP 89980000
*                                       ZERO ORIGIN            @G36XRYP 89983000
         SLL   RTSB,2                   MULTIPLY BY 4          @G36XRYP 89986000
         L     RTSB,ASVTENTY-ASVT(RTSB,R15)  GET ASCB ADDR     @ZM46782 89989000
         L     RTSB,ASCBTSB-ASCB(RTSB)  GET TSB ADDRESS        @G36XRYP 89992000
         MVC   AYOSRCE,TSBASRCE         SAVE TERMINAL INDEX      M1193  90350000
         TM    TSBFLG4,TSBHLDL          HOLD LINE AFTER LOGOFF @OZ32380 90360086
         BOR   R14                      BRANCH YES             @OZ32380 90370086
         OI    AYOSW2,AYODRPL           DROP LINE              @OZ32380 90380086
         BR    R14                      RETURN TO CALLER                90400000
*                                                                       90450000
*********************************************************************** 90500000
*                                                                       90550000
*                                                                       90600000
*********************************************************************** 90650000
*                                                                       90700000
*   CONSTANTS                                                           90750000
*                                                                       90800000
*********************************************************************** 90850000
*                                                                       90900000
BASE     DC    A(TSOUTPUT)              BASE ADDR OF IEDAYO             90950000
*                                                                       91000000
*   MASKS TO SET INDICATORS FOR CALL TO IEDAYE (OUTPUT EDIT).           91050000
*                                                                       91100000
TSOMSGC  DC    X'80000000'              INDICATES A TSO MESSAGE         91150000
TSOASISC DC    X'20000000'              INDICATES ASIS OPTION           91200000
TSOCNTLC DC    X'40000000'              INDICATES CONTROL OPTION        91250000
*                                                                       91300000
*                                                                       91350000
ZEROS    DC    F'0'                     CONSTANT = '0'                  91400000
AYOPATCH DC    20F'0'                                            S22029 91450000
         DS    0F                                                       91500000
INVLDTIC DC    X'08000002'              INVALID TIC CCW                 91550000
*                                                                       91600000
AUTOMSK  DC    X'01088000',A(AUTOLNNO)  MSGGEN MASK FOR AUTO LINE NO.   91650000
ABNDMSK  DC    X'01088000',A(ABENDMSG)  MSGGEN MASK FOR ABEND MSG       91700000
MSKOCAB  DC    X'01088000',A(MSGOCAB)   MSGGEN MASK                     91750000
MSKRNAV  DC    X'01088000',A(MSGRNAV)   MSGGEN MASK                     91800000
*                                                                       91850000
X0100    DC    X'0100'                  MSGGEN INDICATOR                91900000
*                                                                       91950000
MSGOCAB  DC    AL1(L'MOCAB+1)           MESSAGE LENGTH                  92000000
MOCAB    DC    C'IKJ54003I SYSTEM FAILURE - PLEASE LOGON AGAIN'  MSG    92050000
         DC    X'15'                    NEW LINE CHARACTER              92100000
MSGRNAV  DC    AL1(L'MRNAV+1)           MESSAGE LENGTH                  92150000
MRNAV    DC    C'IKJ54002I LOGON FAILED - RESOURCES NOT NOW AVAILABLE'  92200000
         DC    X'15'                    NEW LINE CHARACTER              92250000
AUTOLNNO DC    X'01FF'                  AUTO LINE NO.                   92300000
ABENDMSG DC    AL1(L'MABEND+1)          MESSAGE LENGTH                  92350000
MABEND   DC    C'IKJ54001I SYSTEM FAILURE - ALL USERS TERMINATED' MSG   92400000
         DC    X'15'                    NEW LINE CHARACTER              92450000
*                                                                       92500000
*********************************************************************** 92550000
*                                                                       92600000
         EJECT                                                          92650000
         TAVTD                                                          92700000
         EJECT                                                          92750000
         IKJTIOCB                                                       92800000
         EJECT                                                          92850000
CVT      DSECT                                                          92900000
         CVT                                                            92950000
         EJECT                                                          92960000
         TTCXD                                                          92970000
         EJECT                                                          93000000
         DCBD  DSORG=TX                                                 93050000
         EJECT                                                          93060000
         IHAASCB                                                        93070000
         EJECT                                                          93080000
         IHAASVT                                                        93090000
         EJECT                                                          93100000
         TDCTD                                                          93150000
         EJECT                                                          93200000
         TDISPD                                                         93250000
         EJECT                                                  YS6327  93300000
         TLGBD                                                  YS6327  93350000
         EJECT                                                          93400000
         TLCBD                                                          93450000
         EJECT                                                          93500000
         TPRFD                                                          93550000
         EJECT                                                          93600000
         TPRIOR                                                         93650000
         EJECT                                                          93700000
         TQCBD                                                          93750000
         EJECT                                                          93800000
         TSCBD                                                          93850000
         EJECT                                                          93900000
         TSTCBD                                                         93950000
         EJECT                                                          94000000
         IKJTIOCP                                                       94050000
         EJECT                                                          94100000
         TTNTD                                                          94250000
         EJECT                                                          94300000
         TTRMD                                                          94350000
         EJECT                                                          94400000
         IKJTSB                                                         94450000
         EJECT                                                          94500000
         TTSID                                                          94650000
         EJECT                                                          94700000
*                                                                       94750000
*******************************************************************     94800000
*                                                                       94850000
*   TSOUTPUT'S WORK AREA                                                94900000
*                                                                       94950000
*******************************************************************     95000000
AYOWRKL  EQU   24                       LENGTH OF WORK AREA             95050000
AYOSWTCH EQU   SCBSRCE                  SWITCHES                        95100000
*                                                                       95150000
MSGCHAIN EQU   X'80'                    3270 MSG-CHAIN IN PROG. SA61765 95200000
STAUT    EQU   X'40'                    START AUTMOATIC PRMPTING M0141  95250000
CHAINEND EQU   X'20'                    3270 MSG-CHAIN ENDED    SA61765 95300000
SENDNL   EQU   X'10'                    SEND 'NL' AND 'EOT'             95350000
SUBPCI   EQU   X'08'                    SUBSEQUENT PCI REQUEST          95400000
INTLRQ   EQU   X'04'                    THIS IS INTIAL REQUEST          95450000
INTLPCI  EQU   X'02'                    INITIAL PCI REQUEST             95500000
*                                                                       95550000
AYORC    EQU   SCBSRCE+1                SAVE AREA FOR RETURN    YM2814  95600000
*                                       CODE                    YM2814  95650000
*                                                                       95700000
AYOBULEN EQU   SCBSRCE+2                NO. OF BYTES AVAILABLE  YS6327  95750000
*                                       IN CURRENT BASIC UNIT   YS6327  95800000
*                                                                       95850000
AYOTSBFF EQU   SCBSRCE+4                ADDR OF LAST TS BUFFER FROM     95900000
*                                       WHICH A DATA HAS BEEN MOVED     95950000
*                                                                       96000000
AYOHDRBU EQU   SCBSRCE+8                ADDR OF LAST HDR B.U. IN CHAIN  96050000
*                                                                       96100000
AYOLSTBU EQU   SCBSRCE+12               ADDR OF B.U. IN CHAIN           96150000
*                                                                       96200000
AYOSRCE  EQU   SCBSRCE+16               TERMINAL INDEX                  96250000
*                                                                       96300000
AYOSW2    EQU  SCBSRCE+18               SWITCHES               @G36XRYP 96310000
AYODRPL  EQU   X'80'                    DROP LINE AFTER LOGOFF @G36XRYP 96320000
*                                                                       96330000
AYONXTCH EQU   SCBSRCE+20               POINTER TO NEXT AVAIL   YS6327  96350000
*                                       BYTE IN CURRENT B.U.    YS6327  96400000
*                                                                       96450000
PREFL    EQU   PRFSHDR-IEDQPRF          LENGTH OF BUFFER PREFIX  S22029 96500000
*                                                                       96550000
*********************************************************************** 96600000
*                                                                       96650000
         END                                                            96700000
