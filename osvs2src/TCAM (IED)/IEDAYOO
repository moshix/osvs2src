         TITLE 'IEDAYOO - TSOUTPUT QTIP ROUTINES'                       00100020
IEDAYOO  CSECT                                                          00150002
*                                                                       00170002
*        VS2  3.0  SU                                                   00172037
*0000003600,491510,491520,516988                     UZ04353   @ZA10219 00173037
*0000003600,628523                                   UZ04353   @ZA10218 00173437
*0000072500,087000,268200-269110,270910-270950       UZ03998   @ZA08015 00173837
*0000280810-281700,509410-509460,519310                        @ZA08015 00174337
*0000627800-627800,628501-628527  QTIP 10 FIX                  @ZA07610 00174637
*0000193280                                                    @ZA05465 00174937
*0000054000,104002-104083                                      @ZA02242 00175237
*0000464100-464200                                             @ZA02256 00175537
*                                                                       00176037
*         RELEASE 3, VS/2, ACTIVITY                                     00180002
*   FOR APAR ZA00968, SEE ALSO SA70323.                         ZA00968 00190002
*A091500-092532                                                 ZA00968 00190402
*C003600                                                        ZA01350 00192002
*A612402,612406                                                 ZA01350 00200002
*D001600                                                        ZA01350 00200102
*         RELEASE 2, VS/2, ACTIVITY                                     00200302
*                                       02/19/73                VS00022 00200402
*                                       05/08/73                SJ00088 00200502
*                                       05/14/73                VS01090 00201902
*                                                                       00206002
*         RELEASE 1, VS/2, DELETIONS                            *       00207402
*D090200-090600,091100-091500,094500                             YM2814 00208802
*          RELEASE 21.8 CHANGES                                         00210902
*A002837-002845,079500-080000,698520-698540                     SA70323 00211002
*C028500-028550,084000-096920,104000-104030,439000-444500       SA70323 00211102
*C461000-464996,465000-496000,513000-516997                     SA70323 00211802
*D002342-002345,002634-002652,002837,013500-014500,104035-104080SA70323 00213802
*                                                                S22028 00215802
*                                                                S22029 00217802
*        STATUS  VS2  3.0   SU                                          00218237
*                                                                       00219800
* FUNCTION -- THIS CSECT IS A COLLECTION OF ROUTINES USED BY TSOUTPUT   00220700
*    (IEDAYO), OR SYSTEM-INITIATED CANCEL                               00221602
*    TO PERFORM FUNCTIONS WHICH MUST BE PERFORMED                       00222502
*    WHILE LOCKED.                                                      00224002
*                                                                       00224300
* ENTRY POINTS --                                                       00225200
*         QTIP0110 - MOVES A TSO MESSAGE FROM THE OUTPUT HEADER         00227000
*    QUEUE TO THE OUTPUT TRAILER QUEUE.                                 00227900
*         QTIP0120 - REMOVES FROM THE OUTPUT TRAILER QUEUE TS           00228800
*    BUFFERS FROM WHICH ALL DATA HAS BEEN SUCCESSFULLY SENT TO          00229700
*    THE TERMINAL.  IF THE NUMBER OF BUFFERS FREED PERMITS ANY          00230600
*    WAIT CONDITIONS TO BE REMOVED, THEY ARE REMOVED.                   00231500
*    QCBTPUT/QCBWRBRK ARE RESET UNLESS THERE ARE MORE MESSAGES TO BE    00232602
*    SENT.                                                              00234002
*         QTIP0130 - REFORMATS A TS MESSAGE TO ITS ORIGINAL FORMAT,     00235402
*    SO A MESSAGE IN ERROR MAY BE RESENT.                               00236802
*         QTIP0140 - CLEANS UP TSO CONTROL BLOCKS FOR LOGOFF AND        00238202
*    HANGUP SITUATIONS.                                                 00239602
*         QTIP0150 - MAKES A DISPLAY TERMINAL FLASHBACK MESSAGE OR      00241002
*    AN INPUT MESSAGE INTERRUPTED BY A BREAK-IN TPUT, RESIDING ON       00242402
*    THE INPUT QUEUE, RESIDE ALSO ON THE OUTPUT TRAILER QUEUE.          00243802
*         QTIP0160 - RESETS QCBTPUT/QCBWRBRK, DETECTS START AUTO        00245202
*    PROMPT REQUEST, AND TPOSTS LCB TO ITSELF.                          00246602
*         QTIP0240 - ENTERED FROM SYSTEM-INITIATED CANCEL ROUTINE       00248002
*    TO CHECK FOR AND REMOVE ASID OWAIT.                                00249402
*                                                                       00250802
*    THE CALLING SEQUENCE IS THE SAME FOR ALL ENTRY POINTS.             00252202
*    FOR ANY ENTRY POINT, QTIP0XX0, WHERE XX REPRESENTS THE DECIMAL     00253602
*    ENTRY NUMBER, THE CALLING SEQUENCE IS AS FOLLOWS:                  00255002
*        LA    0,XX          LOAD QTIP ENTRY NUMBER                     00256402
*        LA    1,SAVEAREA    POINT REG. 1 TO 12 WORD PARAMETER AREA     00257802
*        STM   2,13,0(1)     STORE REGISTERS IN PARAMETER AREA          00259202
*        SVC   101           ISSUE QTIP SVC                             00260602
*                                                                       00262002
* INPUT --                                                              00263402
*         QTIP0110 -                                                    00264802
*    REG. 7 - ADDRESS OF DESTINATION QCB                        ZA00968 00265202
*    REG. 8 - TSB ADDRESS                                               00266202
*    REG. 13 - ADDRESS OF AVTSAVE2                                      00267602
*         QTIP0120 -                                                    00269002
*    REG.  8 - ADDRESS OF TSB                                           00270402
*    REG. 10 - ADDRESS OF TIOCRPT                                       00271802
*    REG. 13 - ADDRESS OF AVTSAVE2                                      00273202
*    REG. 15 - ZERO MEANS QUEUE FLUSH ALLOWED                           00274602
*         QTIP0130 -                                                    00276002
*    REG. 7 - ADDRESS OF DESTINATION QCB                        ZA00968 00276402
*    REG. 8 - ADDRESS OF TSB                                            00277402
*    REG. 13 - ADDRESS OF AVTSAVE2                                      00278802
*         QTIP0140 -                                                    00280202
*    REG.  7 - ADDRESS OF DESTINATION QCB                               00281602
*    REG.  8 - ADDRESS OF TSB                                           00283002
*         QTIP0150 -                                                    00284402
*    REG. 8 - ADDRESS OF TSB                                            00285802
*         QTIP0160 -                                                    00287202
*    REG.  4 - ADDRESS OF LCB                                           00288602
*    REG.  7 - ADDRESS OF DESTINATION QCB                               00290002
*    REG.  8 - ADDRESS OF TSB                                           00291402
*    REG. 13 - ADDRESS OF AVTSAVE2                                      00292802
*         QTIP0170 -                                                    00294202
*    REG. 2 - ADDR OF TS BUFFER                                         00295602
*    REG. 15 - AMOUNT OF DATA MOVED FROM THIS BUFFER                    00297002
*         QTIP0240 -                                                    00298402
*    REG.  5 - ASID                                                     00299802
*                                                                       00301202
*    FOR ALL ENTRY POINTS REGISTER 12 IS THE BASE REGISTER AND          00302602
*    CONTAINS THE ADDRESS OF QTIP0110.                                  00304002
*                                                                       00305402
* OUTPUT --                                                             00306802
*         QTIP0110 - RETURN CODE IN REGISTER 15 -               SA70323 00308602
*    X'00' - NOTHING TO SEND                                    SA70323 00309002
*    X'04' - SOMETHING TO SEND                                  SA70323 00309402
*         QTIP0120 - NONE                                               00309602
*         QTIP0130 - NONE                                               00315202
*         QTIP0140 - NONE                                               00315602
*         QTIP0150 - NONE                                               00316602
*         QTIP0160 - RETURN CODE IN REGISTER 15 -                       00318002
*    X'00' - AUTO PROMPT STARTING NOT REQUESTED                         00319402
*    X'04' - START OF AUTO PROMPTING REQUESTED                          00320802
*         QTIP0170 - NONE.                                              00322202
*         QTIP0240 - NONE                                               00323602
*                                                                       00325002
* EXTERNAL REFERENCES -                                                 00326402
*         QTIP0030 - THIS IS A QTIP ROUTINE IN CSECT IEDAYAA            00327802
*    USED TO CLEAR ALL TS BUFFER QUEUES.                                00329202
*         QTIP0280 - THIS IS A QTIP ROUTINE IN CSECT IEDAYII            00330602
*    USED TO CLEAN UP LWAIT CONDITIONS.                                 00332002
*                                                                       00333402
* EXITS, NORMAL --                                                      00334802
*         QTIP0140 - EXITS TO QTIP0030 IN CSECT IEDAYAA                 00336202
*                                                                       00337602
*    ALL OTHER ENTRIES RETURN TO THE CALLER BY BRANCHING TO THE         00339002
*    ADDRESS IN REGISTER 14.                                            00340402
*                                                                       00341802
* EXITS,ERROR -- NONE                                                   00343202
*                                                                       00344602
* TABLES/WORK AREAS -- SEE REMARKS ACCOMPANYING DATA DEFINITION         00346002
*    STATEMENTS.                                                        00347402
*                                                                       00348802
* ATTRIBUTES -- REENTRANT, REUSABLE, PRIVILEGED, LOCKED, REFRESHABLE    00350202
*                                                                       00351602
* CHARACTER CODE DEPENDENCY -- NONE                                     00353002
*                                                                       00354402
* NOTES -- NONE                                                         00355802
*                                                                       00357202
         DC    C'IEDAYOO'               MODULE I.D.                     00358602
         DC    X'6125'                  DATE -  05/04/76       @ZA10219 00360037
         DC    C'5752SC1T3'             COMP ID                         00380037
         DS    0H                                                       00400020
*                                                                       00500020
*********************************************************************** 00600020
*                                                                       00700020
*   QTIP ENTRIES FOR TSOUTPUT (IEDAYO)                                  00800020
*                                                                       00900020
*********************************************************************** 01000020
*                                                                       01100020
         ENTRY QTIP0110                                                 01200020
         ENTRY QTIP0120                                                 01300020
         ENTRY QTIP0130                                                 01400020
         ENTRY QTIP0140                                                 01500020
         ENTRY QTIP0150                                                 01600020
         ENTRY QTIP0160                                                 01700020
*                                                                       02000020
*********************************************************************** 02100020
*                                                                       02110020
*   QTIP ENTRY FOR CANCEL                                               02120002
*                                                                       02130020
**********************************************************************  02140020
*                                                                       02150020
         ENTRY QTIP0240                                                 02160020
*                                                                       02164021
**********************************************************************  02168021
*                                                                       02172021
*   COMMON ROUTINE ENTRIES                                              02176021
*                                                                       02180021
**********************************************************************  02184021
*                                                                       02188021
         ENTRY IEDAYQIO                 IWAIT/OWAIT REMOVAL     YS02019 02192002
         ENTRY IEDAYQSO                 SYSTEM OWAIT REMOVAL    YS02019 02196002
*                                                                       02200020
**********************************************************************  02206020
*                                                                       02212020
*   EXTRN'S FOR EXTERNAL REFERENCES                                     02218020
*                                                                       02224020
**********************************************************************  02230020
*                                                                       02236020
         EXTRN QTIP0000                 BASE FOR ATTENTION      YS02019 02242002
         EXTRN QTIP0030                 ATTENTION ENTRY         YS02019 02248002
         EXTRN QTIP0050                 TSINPUT BASE            YS02019 02250002
         EXTRN QTIP0280                 TSINPUT ENTRY           YS02019 02252002
         EXTRN IEDAYTPQ                 TPOSTING ROUTINE        YS02019 02253002
         EXTRN IEDAYQBR                 BUFFER RETURN ROUTINE   YS02019 02253202
*                                                                       02254020
**********************************************************************  02260020
*                                                                       02266020
*   REGISTER EQUATES                                                    02272020
*                                                                       02278020
**********************************************************************  02284020
*                                                                       02300020
R0       EQU   0                        REGISTER 0                      02400020
R1       EQU   1                        REGISTER 1                      02500020
R2       EQU   2                        TSO BUFFER REGISTER             02600020
R3       EQU   3                        WORK REGISTER                   02700002
RSCB     EQU   3                        SCB REGISTER                    02800020
R4       EQU   4                        WORK REGISTER                   02900002
R5       EQU   5                        WORK REGISTER                   02950002
RASCB    EQU   5                        ASCB REGISTER           YS02019 03000002
R6       EQU   6                        WORK REGISTER                   03100002
R7       EQU   7                        WORK REGISTER                   03200002
RTSB     EQU   8                        TSB REGISTER                    03300020
R8       EQU   8                        WORK REGISTER                   03400002
R9       EQU   9                        WORK REGISTER                   03500002
RTIOC    EQU   10                       TIOCRPT REGISTER                03600020
R10      EQU   10                       WORK REGISTER                   03700002
R11      EQU   11                       WORK REGISTER                   03800002
RBASE    EQU   12                       BASE REGISTER                   03900020
R12      EQU   12                       WORK REGISTER                   04000002
RAVT     EQU   13                       ADDR OF AVT                     04100020
R13      EQU   13                       WORK REGISTER                   04200002
R14      EQU   14                       REGISTER 14                     04300020
R15      EQU   15                       REGISTER 15                     04400020
*                                                                    *  04500020
**********************************************************************  04600020
*                                                                       04700020
NULL     EQU   0                        CONSTANT '0'                    04800020
NOT      EQU   X'FF'                    NOT                             05000020
SBA      EQU   X'11'                    SBA CHAR                 S22028 05050002
E1       EQU   1                        DECIMAL ONE             YS02019 05100002
E2       EQU   2                        DECIMAL TWO             YS02019 05150002
E16      EQU   16                       DECIMAL 16                      05300020
E32      EQU   X'32'                    DECIMAL 32             @ZA02242 05400037
RTNCD04  EQU   4                        RETURN CODE = X'04'             05600020
ONE      EQU   1                        DECIMAL ONE                     05670020
THREE    EQU   3                        DECIMAL THREE            S22028 05720002
SIX      EQU   6                        DECIMAL SIX              S22028 05730002
E31      EQU   31                       DECIMAL THIRTY-ONE              05750020
REGLEN   EQU   4                        REGISTER LENGTH IN BYTES A42911 05770021
TIMES4   EQU   2                        SHIFT VALUE FOR TIMES 4 YS02019 05780002
*                                                                       05800020
**********************************************************************  05900020
*                                                                       06000020
         USING *,RBASE                  ESTABLISH BASE                  06100020
         USING IEDQSCB,RSCB             ESTABLISH SCB                   06200020
         USING TSB,RTSB                 ESTABLISH TSB                   06300020
         USING TIOCRPT,RTIOC            ESTABLISH TIOC                  06400020
         USING TIOCBUF,R2               ESTABLISH BUFFER                06500020
         USING IEDQDISP,R11             MAKE DISPATCHER ADDRESSABLE     06560020
         USING AVTSAVE2,RAVT                                            06580020
         USING IEDQQCB,R7               ESTABLISH DEST QCB      ZA00968 06590002
*                                                                       06600020
*********************************************************************** 06700020
*                                                                       06800020
QTIP0110 EQU   *                                                        06900020
*                                                                       07000020
*********************************************************************** 07100020
*                                                                       07300020
*        IF TRAILER QUEUE IS EMPTY MOVE A MESSAGE FROM THE HEADER       07500020
*        QUEUE TO THE TRAILER QUEUE.                                    07600020
*                                                                       07700020
*********************************************************************** 07900020
         SR    R15,R15                  SET RETURN CODE TO ZERO SA70323 07950002
         SR    R9,R9                    ZERO PT TO TRLR Q       SA70323 08000002
*                                                                       08300020
*   SCAN THE TRAILER QUEUE FOR ANY UNMOVED DATA                 SA70323 08400002
*                                                                       08500020
         L     R2,TSBOTBFP-1            GET ANCHOR FOR TRAILER  SA70323 08700002
         LA    R2,NULL(,R2)             CLEAR HIGH ORDER BITS   SA70323 08750002
         LTR   R2,R2                    TRAILER QUEUE EMPTY?    SA70323 08800002
         BZ    CKHEADER                 YES, GO CHECK HEADER    SA70323 08850002
         SPACE 2                                                        08900002
CKLENGTH EQU   *                                                SA70323 08950002
         LR    R9,R2                    SAVE PTR TO CURRENT BFR SA70323 08952002
         CLI   BUFFLNTH,NULL            ANY DATA IN THIS BFR    SA70323 08960002
         BNE   RET10                    YES, GO HANDLE IT       SA70323 08970002
         L     R2,BUFFTRLR-1            POINT TO NEXT BUFFER    SA70323 08980002
         LA    R2,NULL(,R2)             CLEAR HIGH BYTE         SA70323 08990002
         LTR   R2,R2                    IS THIS END OF CHAIN    SA70323 08992002
         BNZ   CKLENGTH                 NO, CHECK NEXT BUFFER   SA70323 08994002
*                                                                       08994402
*   AT THIS POINT, WE KNOW THERE IS NO UNMOVED DATA ON THE      SA70323 08994802
*   TRAILER QUEUE.  REGISTER 9 POINTS TO THE LAST               SA70323 08995202
*   BUFFER ON THE QUEUE.                                        SA70323 08995602
         SPACE 3                                                SA70323 08996002
CKHEADER EQU   *                                                SA70323 08998002
         NC    TSBOBFP,TSBOBFP          TEST IF ANY BFFR IN HEADER Q    09000020
         BCR   8,R14                    RETURN TO CALLER IF NOT SA70323 09100002
*                                                                       09150002
*   IF A REPROMPT MESSAGE IS ON THE TRAILER QUEUE, DON'T CHAIN          09160002
*   ANYTHING TO IT, BECAUSE BUFFERS ON THE TRAILER QUEUE ARE            09170002
*   NOT FREED IF THEY WERE PUT THERE DURING A REPROMPT.                 09180002
         TM    TSBFLG2,TSBBIPI          REPROMPT IN PROGRESS?   ZA00968 09190002
         BZ    NOREPRMT                 NO PROCESS Q'S NORMALLY ZA00968 09192002
         TM    TSBFLG2,TSBBRKIN         DOES BIPI REALLY MEAN   ZA00968 09194002
*                                       A PROMPT IS OUTSTANDING ZA00968 09196002
*                                       (RATHER THAN 'IN PROGRESS')?    09198002
         BZR   R14                      BIPI REALLY MEANS IT -  ZA00968 09198402
*                                       SO, RETURN              ZA00968 09198802
NOREPRMT EQU   *                                                ZA00968 09199202
*                                                                       09200020
*   DELINK A TSO BFFR FROM HEADER Q AND LINK IT TO TRAILER Q            09300020
*                                                                       09400020
         L     R2,TSBOBFP-1             LOAD 1ST BFFR ADDR              09500020
         LTR   R9,R9                    WAS THERE A TRLR QUEUE  SA70323 09600002
         BZ    NOTRAILR                 NO                      SA70323 09650002
         MVC   BUFFTRLR-TIOCBUF(3,R9),TSBOBFP                   SA70323 09660002
*                                       ADD NEW MESSAGE TO TRLR SA70323 09662002
         B     GOTITIN                  DONE ADDING             SA70323 09670002
NOTRAILR EQU   *                                                SA70323 09680002
         MVC   TSBOTBFP,TSBOBFP         MAKE NEW MESSAGE FIRST  SA70323 09690002
GOTITIN  EQU   *                                                SA70323 09692002
         MVC   TSBOBFP,BUFFHEAD         MOVE NEXT HEADER TO THE TOP     09700020
*                                                                       09800020
         NI    TSBFLG3,NOT-TSBTJMSG     ASSUME MSG NOT TJID TPUT        09900020
         TM    BUFFFL2,BUFFTJID         IS THIS A TJID MESSAGE          10000020
         BNO   RET10                    NO,GOTO SET UP TO RETURN        10100020
         OI    TSBFLG3,TSBTJMSG         SHOW MSG IS TJID TPUT           10200020
*                                                                       10300020
RET10    EQU   *                                                        10400020
*                                                                       10400137
*  DON'T PERMIT THE DUMMY TPUT'S ISSUSED BY                    @ZA02242 10400237
*  TCLEAR Q AND STBREAK (FOR SYNCHRONIZATION                   @ZA02242 10400337
*  PURPOSES) TO APPEAR ON A DISPLAY SCREEN                     @ZA02242 10400437
*                                                                       10401837
         TM    TSBFLG3,TSBSPIT          TEST TCLEARQ OR        @ZA02242 10402237
*                                       STBREAK                @ZA02242 10402337
         BNO   NOTDUM                   NO,NOTDUM TPUT         @ZA02242 10402637
         TM    TSBSTAT,TSBDSPLY         IS TERM DISPLAY TYPE   @ZA02242 10403237
         BNO   NOTDUM                   NO,DON'T INTERC TPUT   @ZA02242 10403337
         TM    BUFFFL1,BUFFCNTL          DUM ARE CTRL TPUT'S   @ZA02242 10403437
         BNO   NOTDUM                   BR IF NOT DUM          @ZA02242 10404337
         CLI   BUFFLNTH,ONE             IS TPUT 1 BYTE         @ZA02242 10406337
         BNE   NOTDUM                   BR IF NOT 1 BYTE       @ZA02242 10406437
         CLI   BUFFHDAT,E32             IS TPUT IDLE           @ZA02242 10406837
         BNE   NOTDUM                   BR IF NOT IDLE         @ZA02242 10407237
         L     R15,CVTPTR               GET CVT ADDR           @ZA02242 10407337
         L     R15,CVTAQAVT-CVT(R15)    GET TCX ADDR           @ZA02242 10407437
         L     RTIOC,TCXRPT-TCXAVT(R15) GET TIOC ADDR          @ZA02242 10407637
         MVI   BUFFLNTH,NULL            MAKE BUFFER 'FREEABLE' @ZA02242 10407837
         B     QTIP0120                 GO FREE TS BUFFER      @ZA02242 10408237
NOTDUM   EQU   *                                               @ZA02242 10408337
*                                                                       10408637
*   MUST SAVE QCBSATCT AND CARCT IN CASE MSG MUST BE REBUILT.           10408937
*                                                                       10409237
         IC    R15,QCBSATCT                                             10409537
         SLL   R15,8                    ONE BYTE                        10410037
         IC    R15,QCBCARCT                                             10411037
         STH   R15,BUFFWORK             SAVE IN BUFFER                  10412537
         DROP  R7                                               SA70323 10414037
         LA    R15,RTNCD04              INDICATE SOMETHING TO   SA70323 10415537
*                                       SEND                    SA70323 10417037
*                                                                       10418537
*   CHECK FOR AN OUTSTANDING REPROMPT.  IF FOUND, SET INDICATORS        10420020
*   TO REPROMPT AGAIN AFTER THIS NEW OUTPUT.                            10430020
*                                                                       10440020
         TM    TSBFLG2,TSBBIPI+TSBBRKIN IS A REPROMPT OUTSTANDING       10450020
         BNO   SETUPRET                 NO, GO SET UP TO RETURN         10460020
         NI    TSBFLG2,NOT-TSBBIPI      CLEAR INDICATOR                 10470020
*                                                                       10480020
SETUPRET EQU   *                                                        10490020
         NI    TSBFLG2,NOT-TSBSTAUT     AUTO PROMPT REQUEST WILL BE     10500020
*                                       HANDLED ALONG WITH OUTPUT       10600020
         BR    R14                      RETURN TO CALLER                10700020
*                                                                       12700020
*********************************************************************** 12800020
*                                                                       12900020
QTIP0120 EQU   *                                                        13000020
*                                                                       13100020
*********************************************************************** 13200020
*                                                                       13300020
*   THIS ENTRY FREES TS BUFFERS AND REMOVES WAITS IF APPROPRIATE        13400020
*                                                                       13700020
*********************************************************************** 13800020
*                                                                       13900020
         LR    R11,R15                  SAVE Q FLUSH SWITCH             14000020
         SR    R15,R15                  SET SW - NO BFR FREED           14100020
         LA    RTSB,0(,RTSB)            CLEAR FOR WAIT REMOVAL SUBR     14350020
         SR    R1,R1                                            YS02019 14400002
         IC    R1,TSBNOBF               INSERT NO. OF OUTPUT    YS02019 14500002
*                                       BFFR                    YS02019 14550002
*                                                                       14800020
LOOP03   EQU   *                                                        14900020
*                                                                       15000020
         L     R2,TSBOTBFP-1            LOAD ADDR OF 1ST OUTPUT BFFR    15100020
*                                                                       15200020
BRKINLOP EQU   *                                                        15300020
*                                                                       15400020
         LA    R2,NULL(R2)              CLEAR HI-ORDER BYTES            15500020
         LTR   R2,R2                    TEST IF ANY MORE BFFR           15600020
         BZ    UPDATE1                  NO,GOTO UPDATE COUNTS           15700020
*                                                                       15800020
         SR    R4,R4                    CLEAR R4                        16000020
         IC    R4,BUFFLNTH              INSERT DATA LENGTH              17100020
         LTR   R4,R4                    IS BUFFER EMPTY?                17200020
         BNZ   PUTNULL                  NO, GO CHK FOR QUEUE FLUSH      17300020
*                                                                       17400020
*        ARRIVAL AT THIS POINT MEANS ALL DATA IN BFR HAS BEEN SENT      17500020
*                                                                       17600020
         NI    BUFFFL1,NOT-BUFFIHOT     TURN OFF FLAG          @ZA08015 17620037
         MVC   TSBOTBFP,BUFFTRLR        POINT TO NEXT BFR               17650020
         TM    TSBFLG2,TSBBIPI          IS THIS BFR PART OF A PARTIAL   17700020
*                                       INPUT MSG CAUSED BY BREAK-IN    17800020
         BNO   BFRFREED                 NO, GO INDICATE BFR FREED       17900020
*                                                                       18000020
         TM    BUFFFL1,BUFFHDR          IS THIS A HEADER BFR            18020020
         BZ    NOTHDRBF                 NO, GO GET PROPER OFFSET        18040020
         LA    R3,BUFFHDLN              GET OFFSET FOR HDR BFR          18060020
         B     STOREOFF                 GO RESTORE ORIGINAL OFFSET      18080020
*                                                                       18100020
NOTHDRBF EQU   *                                                        18120020
         LA    R3,BUFFTRLN              GET OFFSET FOR TRAILER BFR      18140020
*                                                                       18160020
STOREOFF EQU   *                                                        18180020
         IC    R4,BUFFOFST              GET CURRENT OFFSET              18200020
         STC   R3,BUFFOFST              RESTORE ORIGINAL OFFSET         18220020
         SR    R4,R3                    GET ORIGINAL LENGTH             18240020
         STC   R4,BUFFLNTH              RESTORE ORIGINAL LENGTH         18260020
*                                                                       18400020
         NC    BUFFTRLR,BUFFTRLR        MORE BFRS IN THIS MSG           18500020
         BZ    PROMPTED                 NO, GO REMOVE FROM TRAILER Q    18600020
         L     R2,BUFFTRLR-1            YES, POINT TO NEXT BFR          18700020
         B     BRKINLOP                 GO CHECK NEXT BFR EMPTY         18800020
*                                                                       18900020
PROMPTED EQU   *                                                        19000020
*                                                                       19100020
         TM    TSBSTAT,TSBDSPLY         WAS IT REALLY A FLASHBACK MSG?  19309020
         BNO   PROMOUT                  NO, SKIP 2260 CODE              19318020
*                                                                       19327020
         NI    BUFFFL2,NOT-BUFFFRAG     TURN OFF BUFFFRAG      @ZA05465 19336037
         TM    TSBFLG4,TSBIWAIT         IS USER IN IWAIT        YS02019 19345002
         BZ    RSTBIPI                  NO, SKIP WAIT REMOVAL           19354020
         BAL   R4,RSTOWAIT              GO REMOVE IWAIT                 19363020
*                                                                       19372020
RSTBIPI  EQU   *                                                        19381020
         NI    TSBFLG2,NOT-TSBBIPI      RESET BREAK-IN/FLASHBACK SW     19390020
         B     SETTPUT                  GO SET TPUT BIT                 19440020
*                                                                       19450020
PROMOUT  EQU   *                                                        19460020
         OI    TSBFLG2,TSBBRKIN         INDICATE REPROMPT OUTSTANDING   19470020
         B     SETTPUT2                 GO CHK FOR MORE MSGS            19480020
*                                                                       19500020
BFRFREED EQU   *                                                        19600020
*                                                                       19700020
         L     R15,QBRADDR              ADDR OF BFR RETURN RTN  YS02019 19750002
         BALR  R0,R15                   GO RETURN BUFFER        YS02019 19800002
         BCTR  R1,NULL                  DECREMENT OUTPUT BFFR   YS02019 21000002
*                                       COUNT                   YS02019 21050002
         B     LOOP03                   GOTO CHECK NEXT BUFFER          21200020
*                                                                       21300020
PUTNULL  EQU   *                                                        21400020
*                                                                       21420020
         TM    TSBFLG2,TSBBIPI          IS THIS BFR ON INPUT Q ALSO?    21422020
         BO    UPDATE1                  YES, SKIP FLUSH CHECK           21424020
         TM    TSBFLG3,TSBTJMSG         IS THIS MESSAGE NON-FLUSHABLE?  21426020
         BO    UPDATE1                  YES, SKIP FLUSH CHECK           21432020
         TM    TSBFLG1,TSBOFLSH         SHOULD OUTPUT TRAILER QUEUE     21440020
*                                       BE CLEARED?                     21460020
         BNO   UPDATE1                  NO, GO UPDATE COUNT             21470020
         LTR   R11,R11                  IS Q FLUSHHING OK               21472020
         BNZ   UPDATE2                  NO, FLUSH LATER WHEN            21474020
*                                       CARRIAGE CAN BE RETURNED        21476020
         MVC   TSBOTBFP,BUFFTRLR        POINT TO NEXT BUFFER            21480020
         B     BFRFREED                 GO FREE BUFFER                  21490020
*                                                                       21500020
UPDATE1  EQU   *                                                        23200020
*                                                                       23300020
         NI    TSBFLG1,NOT-TSBOFLSH     INDICATE QUEUE FLUSH CHECKED    23400020
*                                       AND HANDLED IF NECESSARY        23500020
UPDATE2  EQU   *                                                        23550020
         STC   R1,TSBNOBF               UPDATE NO. OF OUTPUT    YS02019 23600002
*                                       BFFR                    YS02019 23650002
         LTR   R15,R15                  HAVE ANY BUFFERS BEEN FREED?    23800020
         BZ    SETTPUT                  NO, GO SET QCBTPUT              23900020
*                                                                       24100020
*   THIS SECTION CHECKS FOR AN OWAIT CONDITION CAUSED BY A TPUT WITH    24120020
*   HOLD OPTION OR TPUT RUNNING OUT OF BUFFERS WHILE PUTTING A          24140020
*   MESSAGE ON THE OUTPUT QUEUE.  THIS CONDITION WILL BE REMOVED IF     24160020
*   CONDITIONS ALLOW.                                                   24180020
*                                                                       24300020
         TM    TSBFLG4,TSBOWAIT         TEST IF USER IN OWAIT   YS02019 24600002
         BNO   CHKTSBS                  NO, GO CHECK FOR WAITING TSB'S  24700020
*                                                                       24800020
         TM    TSBFLG4,TSBHOLD          TEST IF TASK IS IN      YS02019 24900002
*                                       HOLD-OWAIT              YS02019 24950002
         BNO   CHKBFFNO                 NO,GOTO CHECK BFFR NO.          25000020
*                                                                       25100020
*   WHEN HOLD-OWAIT,CHECK IF HOLD OPTION MSG HAS BEEN SENT              25200020
*        YES - REMOVE OWAIT                                             25300020
*        NO  - KEEP OWAIT CONDITION                                     25400020
*                                                                       25500020
         CLI   TSBNOBF,NULL             IS ALL OF MSG SENT              25700020
         BNE   CHKTSBS                  NO, GO CHK FOR WAITING TSB'S    25900020
*                                                                       26100020
         NI    TSBFLG4,NOT-TSBHOLD      RESET HOLD OWAIT BIT    YS02019 26200002
         BAL   R4,RSTOWAIT              GO REMOVE OWAIT                 26260020
         B     CHKTSBS                  GO CHK FOR WAITING TSB'S        26320020
*                                                                       26400020
CHKBFFNO EQU   *                                                        26500020
*                                                                       26600020
*   SEE IF NUMBER OF BUFFERS FREED ALLOWS REMOVAL FROM OWAIT            26700020
*                                                                       26800020
         CH    R1,TIOCOWTH              USER STILL HOGGING BFRS YS02019 26880002
         BH    CHKTSBS                  YES, DON'T REMOVE OWAIT         26960020
         LA    R4,CHKTSBS               OPEN CLOSED SUBROUTINE  YS02019 27060002
*                                                                       27120020
**********************************************************************  27150020
*                                                                       27200020
RSTOWAIT EQU   *                                                        27300020
*                                                                       27400020
**********************************************************************  27420020
*                                                                       27440020
*   THIS ROUTINE REMOVES A USER FROM IWAIT OR OWAIT                     27444020
*        --TSBBIPI ON - REMOVE FROM IWAIT                               27448020
*        --TSBBIPI OFF - REMOVE FROM OWAIT                              27452020
*   REGISTER USAGE (OTHERS NOT ALTERED)                                 27455121
*        15-2  WORK REGISTERS                                           27455202
*        4     RETURN ADDR                                              27455321
*        8     TSB ADDR                                                 27455521
*        12    BASE ADDR                                                27455621
*   ENTERED AND EXITED IN TCAM'S KEY                                    27455702
*                                                                       27456020
**********************************************************************  27460020
*                                                                       27464020
IEDAYQIO EQU   *                                                YS02019 27466002
         LR    R2,R13                   SAVE REG. CONTENTS      YS02019 27467002
         TM    TSBFLG2,TSBBIPI          SHOULD IWAIT BE REMOVED         27468020
         BZ    RESETO1                  NO, REMOVE OWAIT                27472020
         TM    TSBFLG4,TSBIWAIT         IS USER IN IWAIT        YS02019 27472202
         BZR   R4                       NO, RETURN TO CALLER    YS02019 27472402
         L     R13,MSKIWAIT             SET TO REMOVE IWAIT     YS02019 27472602
         NI    TSBFLG4,NOT-TSBIWAIT     RESET INDICATOR         YS02019 27473002
         B     CHKINCOR                 GO SET UP FOR STATUS    YS02019 27474002
*                                                                       27484020
RESETO1  EQU   *                                                        27488020
         TM    TSBFLG4,TSBOWAIT         IS USER IN OWAIT?       YS02019 27492002
         BCR   14,R4                    NO, RETURN TO SUBRTN CALLER     27496020
         NI    TSBFLG4,NOT-TSBOWAIT     RESET OWAIT BIT OFF     YS02019 27500002
         L     R13,MSKOWAIT             SET TO REMOVE OWAIT     YS02019 27550002
*                                                                       28000020
*   INTERFACE TO STATUS                                                 28004002
*        REG. 00 - BYTES 0-1 - ASID                                     28008002
*                  BYTES 2-3 - STATUS ENTRY CODE (8)                    28012002
*        REG. 01 - X'80000000' (REQUESTS RESETTING)                     28016002
*        REG. 13 - TCB NONDISPATCHABILITY BIT MASK                      28020002
*        REG. 14 - RETURN ADDR                                          28024002
*        REG. 15 - ENTRY POINT ADDR                                     28028002
*                                                                       28032002
*        CMS AND LOCAL LOCKS HELD ON ENTRY AND UPON RETURN.             28036002
*        REGISTERS 2-12 AND 14 SHOULD REMAIN UNCHANGED BY STATUS.       28040002
*                                                                       28044002
CHKINCOR EQU   *                                                        28050020
         LM    R0,R1,STATREGS           LOAD PARM.S FOR STATUS  YS02019 28053002
         L     R15,TSBASCBA             GET ASCB ADDR           YS02019 28056002
         ICM   R0,B'1100',ASCBASID-ASCB(R15)  GET ASID          YS02019 28059002
         L     R15,CVTPTR               GET CVT ADDR            YS02019 28062002
         L     R15,CVTABEND-CVT(,R15)   GET SCVT ADDR           YS02019 28065002
         USING SCVTSECT,R15             SCVT ADDRESSABLE        YS02019 28068002
         L     R15,SCVTSTAT             GET EPA OF STATUS       YS02019 28071002
         LR    RBASE,R14                SAVE RETURN ADDR        YS02019 28073002
         MODESET EXTKEY=SUPR            GET SUPR KEY FOR STATUS YS02019 28073402
         BALR  R14,R15                  GO TO STATUS            YS02019 28074002
         USING *,R14                    USE R14 AS BASE         YS02019 28074402
         MODESET EXTKEY=TCAM            GET TCAM'S KEY          YS02019 28076002
         L     R15,AYOOBASE             GET ORIGINAL BASE       YS02019 28080002
         LR    R14,RBASE                RESTORE RETURN ADDR     YS02019 28083002
         DROP  R14                      R14 NO LONGER IS BASE   YS02019 28086002
         LR    RBASE,R15                RESTORE ORIGINAL BASE   YS02019 28089002
         LR    R13,R2                   RESTORE REG. CONTENTS   YS02019 28092002
         BR    R4                       RETURN TO CALLER        YS02019 28095002
*                                                                       33850020
*********************************************************************** 33900020
*                                                                       34000020
CHKTSBS  EQU   *                                                        34050020
*                                                                       34100020
*   THIS ROUTINE REMOVES WAIT CONDITIONS OF TSB'S                       34150020
*        (1)   OWAIT CAUSED BY NO BUFFERS TO HOLD ANY OF TPUT MESSAGE   34200020
*        (2)   OS WAIT CAUSED BY TPUT/TJID FOR WHICH THERE WERE         34250020
*              NOT ENOUGH BUFFERS.                                      34300020
*                                                                       34400020
         LA    R1,CHKLWAIT              OPEN CLOSED SUBROUTINE   S21008 34400221
*                                                                       34400421
*   REGISTER USAGE IN CLOSED SUBROUTINE (OTHERS NOT ALTERED)            34400621
*        1     RETURN ADDR                                              34400821
*        2-7   WORK REGISTERS                                           34401021
*        8     TSB ADDR                                                 34401221
*        10    TIOCRPT ADDR                                             34401621
*        12    BASE ADDR                                                34402021
*        13    ADDR OF 5 WORD SAVE AREA                                 34402221
*        15    WORK REGISTER                                            34402421
*                                                                       34402502
*   ENTERED AND EXITED IN TCAM'S KEY.                                   34406102
*                                                                       34410402
IEDAYQSO EQU   *                                                YS02019 34414002
         TM    TSBFLG1,TSBTJOW          DOES TJID TPUT NEED BFR'S       34417602
         BNO   OTHTSBS                  NO, GO CHK OTHER TSB'S          34421202
*                                                                       34424802
         CLC   TSBNOBF,TIOCOWTH+1       IS OWAIT REMOVABLE              34428402
         BH    OTHTSBS                  NO, DON'T REMOVE                34432002
         BAL   R4,POSTECB               GO REMOVE                       34435602
         NI    TSBFLG1,NOT-TSBTJOW                                      34439202
*                                                                       34442802
OTHTSBS  EQU   *                                                        34446402
         TM    TIOCFLG,TIOCTJBF+TIOCNOBF  ARE ANY TSB'S WAITING?        34450020
         BCR   8,R1                     NO, RETURN               S21008 34500021
         LR    R5,RTSB                  SAVE ORIGINAL TSB ADDR  YS02019 34550002
*                                                                       34600020
*   SET POINTERS FOR A SCAN OF TSB'S                                    34650020
*                                                                       34700020
         SR    R6,R6                    CLEAR                   YS02019 34750002
         IC    R6,TIOCTSBS              GET TSB SIZE            YS02019 34800002
         LR    R7,R6                    COPY TSB SIZE           YS02019 34850002
         L     R8,TIOCTSB-E1            START OF TSB TABLE      YS02019 34950002
         MH    R7,TIOCNTSB              LENGTH OF TSB TABLE     YS02019 35000002
         LA    R8,NULL(,R8)             CLEAR BYTE 0            YS02019 35050002
         AR    R7,R8                    ONE BEYOND LAST TSB     YS02019 35060002
         SR    R7,R6                    GET ADDR OF LAST TSB    YS02019 35070002
*                                                                       35100020
SCANLOOP EQU   *                                                        35150020
         TM    TSBSTAT,TSBINUSE         IS THIS TSB IN USE      YS02019 35160002
         BZ    SCANTEST                 NO, GO CK LOOP LIMITS   YS02019 35180002
*                                                                       35200002
         TM    TSBFLG1,TSBTJBF          IS THIS TSB IN OS WAIT?         35400020
         BZ    CHKNOBUF                 NO, GO CHK FOR OWAIT            35450020
         NI    TSBFLG1,NOT-TSBTJBF      SHOW WAIT REMOVED               35500020
         BAL   R4,POSTECB               GO POST ECB TO REMOVE WAIT      35550020
         B     SCANTEST                 GO TO SCAN LOOP TEST            35600020
*                                                                       35650020
CHKNOBUF EQU   *                                                        35700020
         TM    TSBSTAT,TSBNOBUF         COULD USER BE IN OWAIT?         35750020
         BZ    SCANTEST                 NO, GO TO SCAN LOOP TEST        35800020
         TM    TSBFLG4,TSBOWAIT         IS OWAIT ALREADY        YS02019 35850002
*                                       REMOVED?                YS02019 35870002
         BZ    SCANTEST                 YES, GO TO SCAN LOOP TEST       35900020
         STM   R14,R1,0(R13)            SAVE REG.S ACROSS SUBRTN S21008 35920021
         BAL   R4,RSTOWAIT              GO REMOVE OWAIT                 35950020
         LM    R14,R1,0(R13)            RESTORE REGISTERS        S21008 35970021
         NI    TSBSTAT,NOT-TSBNOBUF     SHOW OWAIT REMOVED              36000020
*                                                                       36050020
SCANTEST EQU   *                                                        36100020
         BXLE  R8,R6,SCANLOOP           SCAN LOOP TEST          YS02019 36150002
         NI    TIOCFLG,NOT-(TIOCTJBF+TIOCNOBF) RESET NO BFRS BITS       36170020
         LR    RTSB,R5                  ESTABLISH ORIGINAL ADDR YS02019 36180002
         BR    R1                       RETURN TO CALLER         M0104  36220021
*                                                                       36250020
**********************************************************************  36300020
*                                                                       36350020
CHKLWAIT EQU   *                                                        36400020
*                                                                       36450020
*   THIS ROUTINE CHECKS FOR SYSTEM LWAIT CONDITION AND IF PRESENT       36500020
*   WHETHER IT CAN BE REMOVED.  IF SO, TSINPUT IS TPOSTED TO REMOVE     36550020
*   THE CONDITION.                                                      36600020
*                                                                       36650020
         TM    TIOCFLG,TIOCSYLW         SYSTEM-WIDE LWAIT?              36700020
         BZ    SETTPUT                  NO, GO SET QCBTPUT              36750020
*                                                                       36800020
         L     R1,AVTTSOPT              LOAD ADDR OF TSINPUT QCB        36850020
         USING IEDQTSI,R1                                               36900020
*                                                                       36950020
         NC    TSIBUFQ,TSIBUFQ          IS TSINPUT HOLDING TCAM BFR'S?  37000020
         BNZ   POSTTSI                  YES, GO TPOST TSINPUT           37050020
         CLC   TIOCUSLW,TIOCNFBF        SHOULD SYSTEM LWAIT BE REMOVED  37100020
         BH    SETTPUT                  NO, DON'T POST TSINPUT          37150020
*                                                                       37200020
POSTTSI  EQU   *                                                        37250020
         TM    TSIFLAG,TSIPOST          HAS TSINPUT ALREADY BEEN POSTED 37300020
         BO    SETTPUT                  YES, GO SET QCBTPUT             37350020
*                                                                       37400020
*   TPOST TSINPUT TO ITSELF                                             37420000
*                                                                       37450000
         ST    R1,TSIELCHN-1            PUT QCB ADDR IN RECB            37500000
         MVI   TSIFLAG,TSIPOST          SHOW TSINPUT POSTED             37504000
         MVI   TSIPRI,PRIBFRTB          SET TPOST PRIORITY              37508000
         L     R11,AVTEA                LOAD ADDR OF TCAM DISPATCHER    37512000
         LR    R6,R14                   SAVE RETURN ADDRESS             37516000
         BAL   R14,DSPPOSTR             GO TPOST AND RETURN             37520000
         LR    R14,R6                   RESTORE RETURN ADDRESS          37524000
         DROP  R1                       ADDRESSABILITY ENDS     YS02019 37800002
*                                                                       37850020
**********************************************************************  37900020
*                                                                       37950020
SETTPUT  EQU   *                                                        38000020
*                                                                       38050020
*   IF THERE ARE MORE MESSAGES TO SEND, THIS ROUTINE LEAVES THE QCBTPUT 38100020
*   BIT ON INDICATING TO THE TCAM SEND SCHEDULER THAT TSOUTPUT SHOULD   38150020
*   BE TPOSTED AGAIN.                                                   38200020
*                                                                       38250020
         LR    R2,R14                   SAVE REGISTER CONTENTS  YS02019 38251602
         L     R15,AVTRNMPT             EPA OF TRM LOOKUP RTN   YS02019 38254002
         LH    R1,TSBASRCE              GET TERMINAL INDEX      YS02019 38255002
         BALR  R14,R15                  GO GET TRM ADDR         YS02019 38258002
         L     R7,TRMDESTQ-E1-IEDQTRM(,R1)  GET QCB ADDR        YS02019 38259002
         LR    R14,R2                   RESTORE REG. CONTENTS   YS02019 38260002
*                                                                       38261002
         TM    QCBTSOF1-IEDQQCB(R7),QCBPARTO  OUTPUT SPLIT BY   YS02019 38262002
*                                       OWAIT                   YS02019 38263002
         BNO   CHKBRKIN                 NO, GO CHK FOR BREAK-IN YS02019 38264002
*                                                                       38266002
         CLI   TSBNOBF,NULL             IS PARTIAL OUTPUT ALL   YS02019 38268002
*                                       SENT                    YS02019 38270002
         BE    GIVUPCTL                 YES, GIVE UP CONTROL    YS02019 38272002
*                                                                       38274002
CHKBRKIN EQU   *                                                YS02019 38278002
         TM    TSBFLG2,TSBBRKIN         DOES A PARTIAL INPUT    YS02019 38282002
*                                       LINE DUE                YS02019 38284002
*                                       TO BREAK-IN NEED TO BE PUT OUT  38286002
         BO    GOBACK11                 YES, LEAVE QCBTPUT ON   YS02019 38288002
*                                                                       38290002
SETTPUT2 EQU   *                                                YS02019 38295002
         NC    TSBOBFP,TSBOBFP          IS OUTPUT HEADER QUEUE EMPTY?   38300020
         BNZ   GOBACK11                 NO, GO RETURN                   38350020
         NC    TSBOTBFP,TSBOTBFP        IS OUTPUT TRAILER QUEUE EMPTY?  38400020
         BNZ   GOBACK11                 NO, GO RETURN                   38450020
*                                                                       38650020
         TM    TSBFLG1,TSBIFLSH         IS INPUT FLUSH IN        A45625 38655021
*                                       PROGRESS                 A45625 38660021
         BZ    CHKABEND                 NO, CHECK ABEND          A45625 38665021
         NI    TSBFLG1,NOT-TSBIFLSH     TURN OFF INPUT FLUSH     A45625 38670021
*                                       FLAG                     A45625 38675021
         NI    TSBFLG3,NOT-TSBSPIT      ALLOW PROMPTING          YM2814 38677000
         NI    TSBFLG2,NOT-(TSBBIPI+TSBBRKIN) TURN OFF BREAKIN-  A45625 38680021
*                                       FLASHBACK FLAGS                 38685021
CHKABEND EQU   *                                                 A45625 38690021
         TM    AVTBIT3,AVTTSAB          DOES ABEND MSG NEED SENDING?    38700020
         BO    GOBACK11                 YES, LEAVE QCBTPUT ON           38750020
*                                                                       38800020
         TM    TSBSTAT,TSBDISC          DOES LOGOFF MSG NEED SENDING?   38850020
         BO    GOBACK11                 YES, LEAVE QCBTPUT ON           38900020
*                                                                       39100020
         TM    TSBFLG2,TSBSTAUT         AUTO PROMPT MSG REQUESTED?      39150020
         BO    GOBACK11                 YES, LEAVE QCBTPUT ON           39200020
*                                                                       39250020
         LR    R2,R14                   SAVE REGISTER CONTENTS  YS02019 39300002
         L     R15,AVTRNMPT             EPA OF TRM LOOKUP RTN   YS02019 39301002
         LH    R1,TSBASRCE              GET TERMINAL INDEX      YS02019 39302002
         BALR  R14,R15                  GO GET TRM ADDR         YS02019 39303002
         L     R7,TRMDESTQ-E1-IEDQTRM(,R1)  GET QCB ADDR        YS02019 39304002
         LR    R14,R2                   RESTORE REG. CONTENTS   YS02019 39305002
*                                                                       39310020
GIVUPCTL EQU   *                                                        39320020
         NI    TSBFLG3,NOT-TSBTPUT      SHOW TSOUTPUT IS DONE   YS02019 39325002
         TM    QCBFLAG-IEDQQCB(R7),QCBTSSES  TSO SESSION                39330020
         BCR   14,R14                   NO, RETURN TO CALLER            39340020
         NI    QCBTSOF1-IEDQQCB(R7),NOT-QCBTPUT-QCBWRBRK                39350020
*                                                                       39400020
GOBACK11 EQU   *                                                        39450020
         BR    R14                      RETURN TO CALLER                39500020
*                                                                       39800020
*********************************************************************** 39900020
*                                                                       40000020
POSTECB  EQU   *                                                        40100020
*                                                                       40200020
*********************************************************************** 40300020
*                                                                       40400020
*   POST THE TSBECB                                                     40500020
*                                                                       40600020
*   ENTRY TO POST                                                       40700020
*        R10 - COMPLETION CODE                                          40800020
*        R11 - ECB ADDRESS AND HIGH ORDER BIT 'ON' - INDICATES          40900021
*              INTERPARTITION POST                                      41000021
*        R13 - ASCB ADDR                                                41200002
*        R14 - RETURN ADDR                                              41300020
*        R15 - CVT0PT01                                                 41400020
*                                                                       41500020
*********************************************************************** 41600020
*                                                                       41700020
         L     R3,CVTPTR                LOAD CVT ADDR                   41800020
         USING CVT,R3                                                   41900020
         L     R15,CVT0PT01             GET ADDR OF POST ROUTINE        42000020
         LR    R2,R13                   LOAD SAVE AREA ADDRESS          42120020
         STM   R10,R14,0(R13)           SAVE REGISTERS                  42180020
         SR    R10,R10                  ZERO COMPLETION CODE    YS02019 42240002
         LA    R11,TSBECB               LOAD ECB ADDR                   42400020
         O     R11,HIGHON               TURN ON HIGH-ORDER BIT   S21A12 42600021
         LA    R12,CVTBRET              NO ERROR RETURN RTN     YS02019 42700002
         LH    R13,TSBWTJID             LOAD TJID OF ORIGINATING TPUT   42900020
         L     R14,CVTASVT              ADDR OF ASVT            YS02019 42950002
         SLL   R13,E2                   MULTIPLY BY 4           YS02019 43000002
         L     R13,ASVTENTY-L'ASVTENTY-ASVT(R13,R14)  GET ASCB  YS02019 43050002
         MODESET EXTKEY=SUPR            GET SUPR KEY FOR POST   YS02019 43100002
         BALR  R14,R15                  GOTO POST ROUTINE               43300020
*                                                                       43400020
         MODESET EXTKEY=TCAM            GET TCAM'S KEY          YS02019 43450002
         LM    R10,R14,0(R2)            RESTORE REGISTERS               43500020
         BR    R4                       RETURN TO SUBROUTINE CALLER     43800020
         DROP  R3                       DROP AS CVT BASE        YS02019 43850002
         SPACE 3                                                SA70323 43900002
QTIP0130 EQU   *                                                        44500020
*                                                                       44600020
*********************************************************************** 44700020
*                                                                       44800020
*        THIS QTIP IS ENTERED WHEN THERE WAS AN OUTPUT I/O ERROR AND    45100020
*        THE TSO MSG HAS TO BE RE-BUILT AND RE-SENT                     45200020
*                                                                       45300020
*        MAKE ALL THE BUFFERS AS POSTED TO TSOUTPUT INITIALLY           45400020
*                                                                       45500020
*********************************************************************** 45600020
*                                                                       45700020
         USING TIOCBUF,R2                                               45900020
         USING IEDQQCB,R7               DESTINATION QCB         ZA00968 45950002
*                                                                       46000020
         SR    R4,R4                    CLEAR FOR IC USE                46100020
         SR    R1,R1                    CLEAR FOR FIRST HDR PTR SA70323 46150002
         SR    R5,R5                    PREVIOUS HDR PTR        SA70323 46250002
         SR    R6,R6                    PREVIOUS TRLR PTR       SA70323 46300002
         L     R2,TSBOTBFP-1            PT TO 1ST BFR ON QUEUE          46400020
         NC    TSBOTBFP,TSBOTBFP        IS TRAILER Q EMPTY     @ZA02256 46410037
         BZ    GOBACK11                 YES, GO BACK TO CALLER @ZA02256 46420037
*                                                                       46450002
*   RESTORE QCBCARCT AND SATCT TO PREVIOUS VALUES, SINCE MESSAGE        46460002
*   WASN'T SENT.                                                        46470002
*                                                                       46480002
         LH    R9,BUFFWORK              GET SAVED VALUE         SA70323 46490002
         STC   R9,QCBCARCT              RESTORE CARCT           SA70323 46492002
         SRL   R9,8                     ONE BYTE                SA70323 46494002
         STC   R9,QCBSATCT              RESTORE LINE COUNT      SA70323 46496002
         DROP  R7                                               SA70323 46496402
         SPACE 3                                                SA70323 46498002
*                                                                       46498402
*   START CHECKING THE BUFFERS ON THE OUTPUT TRAILER QUEUE      SA70323 46498802
*                                                                       46499202
NEXTBUFR EQU   *                                                SA70323 46499602
         TM    BUFFFL1,BUFFHDR          IS THIS A HDR BFR       SA70323 46500002
         BNO   NOTHDRB                  NO, UPDATE COUNT, ETC.  SA70323 46550002
         SPACE 3                                                        46650002
*                                                                       46700002
*   THIS IS A HEADER BUFFER.  RECHAIN THE QUEUE SO THE LAST             46750002
*   HEADER POINTS TO THIS ONE, AND THE LAST TRAILER POINTS TO           46800002
*   ZERO.                                                               46850002
*                                                                       46900002
         LTR   R5,R5                    ANY PREVIOUS HEADER     SA70323 46950002
         BZ    FIRSTHDR                 NO, THIS IS FIRST HDR   SA70323 47000002
         IC    R4,BUFFFL2-TIOCBUF(,R5) SAVE OLD FLAG            SA70323 47100002
         ST    R2,BUFFHEAD-1-TIOCBUF(,R5) ST NEW HDR PT         SA70323 47150002
         STC   R4,BUFFFL2-TIOCBUF(,R5)  RESTORE FLAG            SA70323 47200002
         B     MAKEPREV                 GO MAKE CURR BFR LAST   SA70323 47250002
         SPACE 2                                                SA70323 47300002
FIRSTHDR EQU   *                                                        47350002
         LR    R1,R2                    MAKE THIS FIRST HDR     SA70323 47360002
MAKEPREV EQU   *                                                        47400002
         LR    R5,R2                    SHOW THIS IS MOST       SA70323 47450002
*                                       RECENT HEADER BUFFER    SA70323 47500002
         LTR   R6,R6                    WAS THERE A PREV TRLR   SA70323 47550002
         BZ    DONTCLR                  NO, NO PTR TO RESET     SA70323 47600002
         MVC   BUFFTRLR-TIOCBUF(3,R6),ZEROS ZERO TRLR PT        SA70323 47610002
*                                       IN PREVIOUS BUFFER      SA70323 47620002
DONTCLR  EQU   *                                                        47650002
         LA    R3,BUFFHDLN              GET HDR PREFIX SIZE     SA70323 47700002
RESETLEN EQU   *                                                        47750002
         IC    R4,BUFFOFST              GET CURRENT OFFSET      SA70323 47800002
         CR    R3,R4                    THIS BFR BEEN TOUCHED?  SA70323 47850002
         BE    VIRGIN                   NO, NOTHING TO UPDATE   SA70323 47900002
         STC   R3,BUFFOFST              RESTORE ORIG OFFSET     SA70323 47950002
         SR    R4,R3                    GET LENGTH MOVED        SA70323 48000002
         IC    R3,BUFFLNTH              GET OLD LENGTH          SA70323 48050002
         AR    R3,R4                    ADD PREV MOVED TO IT    SA70323 48100002
         STC   R3,BUFFLNTH              STORE NEW LENGTH        SA70323 48150002
         B     VIRGIN                   BUFFER LIKE NEW AGAIN   SA70323 48200002
         SPACE 3                                                        48250002
*                                                                       48300002
*   THIS IS NOT A HEADER BUFFER.  ONLY OFFSET AND LENGTH NEED BE        48350002
*   ADJUSTED.                                                           48400002
*                                                                       48450002
NOTHDRB  EQU   *                                                        48500002
         LA    R3,BUFFTRLN              GET TRAILER PREF SIZE   SA70323 48550002
         B     RESETLEN                 GO RESET OFFSET AND LEN SA70323 48600002
VIRGIN   EQU   *                                                        48700002
*                                                                       48750002
*   THE BUFFER HAS BEEN RESTORED TO ITS ORIGINAL CONDITION.             48800002
*   NOW WE BUMP THE POINTERS TO THE NEXT BUFFER                         48850002
*                                                                       48900002
         LR    R6,R2                    CURR BFR NOW PREVIOUS   SA70323 48950002
         L     R2,BUFFTRLR-1            POINT TO NEXT BFR       SA70323 49000002
         LA    R2,0(,R2)                CLEAR HI ORDER BITS     SA70323 49050002
         LTR   R2,R2                    IS THERE ANOTHER BFR    SA70323 49100002
         BNZ   NEXTBUFR                 YES, GO FIX IT UP       SA70323 49150002
         TM    TSBFLG2,TSBBIPI          ERROR ON REPROMPT MSG? @ZA10219 49160037
         BO    NOTHDR                   YES, DONT MAKE IT HDR  @ZA10219 49170037
         SPACE 3                                                        49200002
*                                                                       49250002
*  WE HAVE REACHED THE END OF THE TRAILER QUEUE.  R5 POINTS TO THE      49300002
*   LAST HEADER BUFFER, R1 POINTS TO THE FIRST HEADER BUFFER.           49350002
*  NOW ANY HEADER BUFFERS WILL BE PUT AT THE HEAD OF THE HEADER         49400002
*   QUEUE, AND ANY LEFT-OVER TRAILERS WILL REMAIN ON                    49450002
*   THE TRAILER QUEUE.                                                  49500002
         LTR   R5,R5                    ANY HEADERS FOUND       SA70323 49550002
         BZR   R14                      NO, ALL DONE            SA70323 49600002
         MVC   BUFFHEAD-TIOCBUF(3,R5),TSBOBFP POINT LAST HEADER SA70323 49650002
*                                       IN NEW CHAIN TO FIRST   SA70323 49700002
*                                       HEADER IN OLD CHAIN     SA70323 49800002
         IC    R4,TSBOBFP-1             SAVE FLAGS              SA70323 51600002
         ST    R1,TSBOBFP-1             MAKE FIRST HDR IN       SA70323 51650002
*                                       NEW CHAIN HEAD OF       SA70323 51660002
*                                       HEADER QUEUE            SA70323 51670002
         STC   R4,TSBOBFP-1             RESTORE FLAG            SA70323 51680002
*   IF FIRST BFR ON TRLR Q WAS HDR, TRLR QUEUE IS EMPTY                 51690002
         LA    R1,0(,R1)                CLEAR HIGH ORDER BYTE   SA70323 51692002
         L     R2,TSBOTBFP-1            POINT TO TRLR Q         SA70323 51694002
         LA    R2,0(,R2)                CLEAR HIGH ORDER BYTE   SA70323 51696002
         CR    R1,R2                    SAME?                   SA70323 51698002
         BNER  R14                      NO, DONE                SA70323 51698402
         MVC   TSBOTBFP,ZEROS           CLEAR POINTER           SA70323 51698802
         SPACE 1                                                        51698937
NOTHDR   EQU   *                                               @ZA10219 51699037
         BR    R14                      RETURN                  SA70323 51699202
         SPACE 3                                                SA70323 51699602
QTIP0140 EQU   *                                                        51699702
*                                                                       51700020
*********************************************************************** 51800020
*                                                                       51900020
*   THIS QTIP ENTRY CLEANS UP TSO CONTROL BLOCKS FOR LOGOFF             52100020
*   AND HANGUP SITUATIONS                                               52300020
*                                                                       52500020
*********************************************************************** 52600020
*                                                                       52700020
*   REGISTERS AT ENTRY--                                                52730020
*                                                                       52760020
*        R8 -  ADDRESS OF TSB                                           52880020
*                                                                       52940020
         TM    TSBFLG4,TSBHUNG          IS THIS A HANG-UP       YS02019 53020002
*                                       SITUATION               YS02019 53030002
         BO    PASTCALL                 YES, DON'T CALL QTIP 28         53040020
*                                                                       53060020
*   SET UP AND GO TO QTIP 28 IN IEDAYII TO CLEAN UP LWAIT               53080020
*                                                                       53100020
         LR    R9,RTSB                  LOAD TSB ADDRESS                53120020
         LR    R2,R12                   SAVE BASE ADDRESS               53140020
         L     R15,QT28ADDR             GET ENTRY ADDR OF RTN           53160020
         L     R12,QT28BASE             GET BASE ADDR OF RTN    YS02019 53180002
         LR    R6,R14                   SAVE RETURN ADDR                53200020
         BALR  R14,R15                  GO CLEAN UP LWAIT               53220020
         LR    R12,R2                   RESTORE BASE ADDRESS            53240020
*                                                                       53249020
*   POST LOGOFF/TERMINATION                                             53249602
*                                                                       53250220
         LA    R11,TSBLECB              GET ECB ADDR            YS02019 53251402
         LR    R2,R12                   SAVE BASE ADDR                  53252020
         SR    R10,R10                  ZERO COMPLETION CODE            53253220
         O     R11,HIGHON               CROSS-MEMORY REQUEST    YS02019 53253402
         L     R15,CVTPTR               GET CVT ADDR            YS02019 53253802
         USING CVT,R15                  CVT ADDRESSABLE         YS02019 53254102
         L     R13,CVTMSER              ADDR OF BASEA           YS02019 53254502
         L     R13,BAASCB-BASE(R13)     ASCB OF MASTR SCHED     YS02019 53254902
         LA    R12,CVTBRET              NO ERROR RETURN ROUTINE YS02019 53264002
         L     R15,CVT0PT01             ENTRY POINT TO POST     YS02019 53268002
         DROP  R15                      AS CVT BASE             YS02019 53272002
         MODESET EXTKEY=SUPR            GET SUPR KEY FOR POST   YS02019 53276002
         BALR  R14,R15                  GO POST LOGOFF          YS02019 53280002
         MODESET EXTKEY=TCAM            GET TCAM'S KEY          YS02019 53284002
         LR    R12,R2                   RESTORE BASE ADDR       YS02019 53288002
         USING QTIP0110,R12             MODULE ADDRESSABLE      YS02019 53290002
         LR    R14,R6                   RESTORE RETURN ADDR     YS02019 53292002
*                                                                       53296002
PASTCALL EQU   *                                                        53300020
         L     RTIOC,CVTPTR             GET CVT ADDR            YS02019 53302002
         L     RTIOC,CVTAQAVT-CVT(,RTIOC)  GET ADDR OF TCX      YS02019 53304002
         L     RTIOC,TCXRPT-IEDQTCX(,RTIOC) GET TIOCRPT ADDR    YS02019 53306002
         TM    TSBECB,AVTE80            IS ECB WAITED ON                53310020
         BNO   CLEANTSB                 NO, NO NEED TO POST             53320020
         LA    R13,TIOCSAVE             GET SAVE AREA ADDR              53328020
         BAL   R4,POSTECB               GO POST WAITING ECB             53330020
*                                                                       53340020
CLEANTSB EQU   *                                                        53350020
         L     RASCB,TSBASCBA           GET ASCB ADDR           YS02019 53360002
         USING ASCB,RASCB               ASCB ADDRESSABLE        YS02019 53370002
*                                                                       53400020
*   CLEAN UP TSB                                                        53500020
*                                                                       53600020
         SR    R0,R0                    ZERO REGISTER                   53670020
         STC   R0,TSBSTAT               CLEAR STATUS BYTE       YS02019 53740002
*                                       (IEDAY8 WILL CLR TSBASCB)       53790002
         STC   R0,TSBFLG3               CLEAR FLAG              YS02019 53810002
         STH   R0,TSBASRCE              CLEAR TERMINAL INDEX            53880020
         STC   R0,TSBFLG1               CLEAR 1ST FLAG BYTE             53950020
         STC   R0,TSBLNSZ               CLEAR LINE SIZE                 54020020
         STC   R0,TSBFLG2               CLEAR 2ND FLAG BYTE             54090020
*                                                                       54200020
*   CLEAN UP ASCB                                                       54300002
*                                                                       54400020
         MODESET EXTKEY=SUPR            GET KEY OF ASCB         YS02019 54450002
         ST    R0,ASCBTSB               CLEAR TSB POINTER       YS02019 54500002
         MODESET EXTKEY=TCAM            GET TCAM'S KEY          YS02019 54550002
*                                                                       54900020
*   INITIALIZE REGISTERS FOR QUEUE CLEARING ROUTINE                     55000020
*                                                                       55100020
         LH    R2,ASCBASID              LOAD ASID VALUE         YS02019 55200002
         LR    R6,RTSB                  LOAD TSB ADDR                   55300020
*                                                                       55400020
*   GO TO QTIP 3 IN IEDAYAA TO CLEAR ALL TSO BUFFER QUEUES              55500020
*                                                                       55600020
         L     R15,CLRQADDR             GET ADDR OF Q CLEARING RTN      55700020
         L     R12,CLRQBASE             GET BASE ADDR OF RTN            55800020
         BR    R15                      GO TO Q CLEARING RTN            55900020
         DROP  RASCB                    AS ASCB BASE            YS02019 56300002
*                                                                       56700020
*                                                                       56800020
*********************************************************************** 56900020
*                                                                       57000020
QTIP0150 EQU   *                                                        57100020
*                                                                       57200020
*********************************************************************** 57300020
*                                                                       57400020
*   THIS QTIP ENTRY MAKES A PARTIAL INPUT MESSAGE OR 2260 FLASHBACK     57430020
*   MESSAGE, RESIDING ON THE INPUT QUEUE, RESIDE ALSO ON THE OUTPUT     57460020
*   TRAILER QUEUE.  AFTER THE MESSAGE HAS BEEN SENT TO THE TERMINAL     57490020
*   QTIP0120 WILL GET CONTROL AND REMOVE THE MESSAGE FROM THE TRAILER   57520020
*   QUEUE.                                                              57550020
*                                                                       57600020
*********************************************************************** 57700020
*                                                                       57800020
         DROP  R2                                                       58100020
         USING TIOCBUF,R2               ESTABLISH BASE FOR BUFFER       58200020
*                                                                       58300020
         NI    TSBFLG2,NOT-TSBBRKIN     RESET BREAK-IN OCCURED MSG      58400020
*                                                                       58500020
         NC    TSBIBFP,TSBIBFP          TEST IF ANY INPUT MSG IN Q      58600020
         BCR   8,R14                    RETURN IF EMPTY                 58700020
*                                                                       58800020
         L     R2,TSBIBFP-1             LOAD ADDR OF TS INPUT BUFFER    58900020
*                                                                       59000020
REPEAT2  EQU   *                                                        59100020
*                                                                       59200020
         NC    BUFFHEAD,BUFFHEAD        TEST IF ANY BUFFER IN CHAIN     59300020
         BZ    CHKPART                  NO,GOTO CHECK PARTIAL LINE      59400020
*                                                                       59500020
         L     R2,BUFFHEAD-1            LOAD NEXT BUFFER ADDR           59600020
         B     REPEAT2                  GOTO CHECK NEXT BUFFER          59700020
*                                                                       59800020
CHKPART  EQU   *                                                        59900020
*                                                                       60000020
         TM    TSBSTAT,TSBDSPLY         IS THIS A FLASHBACK MSG?        60030020
         BO    PROCPART                 YES, SKIP TEST                  60060020
         TM    BUFFFL2,BUFFPART         TEST IF PARTIAL MSG IN BUFFER   60100020
         BCR   14,R14                   RETURN IF NOT                   60200020
*                                                                       60300020
PROCPART EQU   *                                                        60400020
*                                                                       60500020
         STCM  R2,7,TSBOTBFP            PUT BFR ADDR IN TRAILER Q       60540000
         LR    R6,R2                    SAVE BUFFER ADDRESS    @ZA08015 61000037
         SPACE 1                                               @ZA08015 61000137
SETIHOT  EQU   *                                               @ZA08015 61000237
         OI    BUFFFL1,BUFFIHOT         TURN ON FLAG           @ZA08015 61000337
         L     R2,BUFFTRLR-1            GET NEXT TRAILER       @ZA08015 61000437
         LA    R2,0(,R2)                CLEAR HIGH BYTE        @ZA08015 61000537
         LTR   R2,R2                    ANY MORE TRAILERS?     @ZA08015 61000637
         BNZ   SETIHOT                  FLAG THEM TOO          @ZA08015 61000737
         LR    R2,R6                    RESTORE BUFFER ADDRESS @ZA08015 61000837
         TM    TSBSTAT,TSBDSPLY         2260 FLASHBACK REQUEST?         61001020
         BZ    SETBIPI                  NO, GO SET TSBBIPI              61002020
*                                                                       61003020
         SR    R6,R6                    CLEAR REGISTER                  61004020
         SR    R7,R7                    CLEAR REGISTER                  61005020
*                                                                       61006020
*   GET LENGTH OF INPUT MESSAGE                                         61007020
*                                                                       61008020
GETLEN   EQU   *                                                        61009020
         IC    R6,BUFFLNTH              LOAD DATA LENGTH                61010020
         TM    BUFFFL1,BUFFHDR          IS THIS A HEADER BFR     S22028 61010402
         BZ    ADDMSGLN                 BRANCH IF NO             S22028 61010802
         TM    BUFFFL2,BUFF3270         DOES IT HAVE 3270        S22028 61010902
*                                       CONTROL CHARACTERS       S22028 61012402
         BZ    ADDMSGLN                 BRANCH IF NO             S22028 61016002
         LA    R0,THREE                 ASSUME 3 CONTROL CHARS   S22028 61017402
         CR    R6,R0                    IS DATA LENGTH IN THIS   S22028 61017602
*                                       BFR LESS THAN 3          S22028 61017702
         BNL   CHKSBA                   NO, CHECK SBA CHAR       S22028 61017802
         LA    R0,ONE                   THERE IS 1 CONTROL CHAR  S22028 61017902
         B     ADJUST                   GO TO ADJUST MSG LENGTH  S22028 61018402
CHKSBA   EQU   *                                                 S22028 61018802
         CLI   BUFFHDLN+THREE(R2),SBA   IS THE 4TH CHAR SBA      S22028 61019202
         BNE   ADJUST                   BRANCH IF NOT            S22028 61019302
         LA    R0,SIX                   THERE ARE 6 CNTRL CHARS  S22028 61019402
ADJUST   EQU   *                                                 S22028 61019702
         SR    R6,R0                    SUBTRACT LENGTH OF 3270  S22028 61020102
*                                       CONTROL CHARACTERS       S22028 61020202
         STC   R6,BUFFLNTH              ADJUST DATA LENGTH       S22028 61020602
         SR    R3,R3                    CLEAR REGISTER           S22028 61021102
         IC    R3,BUFFOFST              GET OFFSET TO DATA       S22028 61021202
         AR    R3,R0                    SKIP OVER CONTROL CHARS  S22028 61021302
         STC   R3,BUFFOFST              ADJUST OFFSET TO DATA    S22028 61021402
ADDMSGLN EQU   *                                                 S22028 61021902
         AR    R7,R6                    ADD TO MESSAGE LENGTH           61022002
         OI    BUFFFL1,BUFFEDIT         FLASHBACK IN EDIT MODE          61022202
         NC    BUFFTRLR,BUFFTRLR        ANY MORE BUFFERS                61022602
         BZ    GOTLEN                   NO, MESSAGE LENGTH GOTTEN       61023002
         L     R2,BUFFTRLR-1            POINT TO NEXT BFR               61023502
         B     GETLEN                   GO ADD TO MSG LENGTH            61025002
GOTLEN   EQU   *                                                        61026502
         OI    BUFFFL1,BUFFNLCR         LET EDIT RTN ALLOW NL           61028002
*                                                                       61029502
*   IF MESSAGE IS LESS THAN TWO LINES FLASHBACK WHOLE MESSAGE           61031002
*                                                                       61032502
         IC    R6,TSBLNSZ               GET LINE SIZE                   61034002
         LA    R5,0(R6,R6)              GET TWICE LINE SIZE             61035502
         CR    R7,R5                    IS MESSAGE LT 2 LINES?          61037002
         BL    SETBIPI                  YES, WHOLE MSG WILL BE FLASHED  61038502
*                                                                       61040002
*   PARE LINES OFF THE FRONT OF THE MESSAGE UNTIL THE                   61041502
*   MESSAGE IS LESS THAN TWO LINES LONG                                 61043002
*                                                                       61044502
         SR    R3,R3                    CLEAR REGISTER                  61046002
         SR    R4,R4                    CLEAR REGISTER                  61047502
         LR    R9,R6                    LOAD LINE SIZE                  61049002
*                                                                       61050502
NEXTBUFF EQU   *                                                        61052002
         L     R2,TSBOTBFP-1            POINT TO 1ST ON TRAILER QUEUE   61053502
         LA    R2,0(,R2)                ISOLATE BFR ADDRESS             61055002
         LTR   R2,R2                    ANY MORE BFRS ON TRAILER Q?     61056502
         BZ    SETBIPI                  NO, GO SET TSBBIPI              61058002
*                                                                       61059502
         IC    R3,BUFFOFST              LOAD OFFSET TO DATA             61061002
         IC    R4,BUFFLNTH              LOAD LENGTH OF DATA             61071002
*                                                                       61105002
COMPARE  EQU   *                                                        61124802
         CR    R4,R9                    IS BFR LNG GT LINE SIZE         61144602
         BH    BFRHIGH                  YES, GO UPDATE OFFSET           61164402
         SR    R9,R4                    DECR LINE SIZE BY BFR LNG       61184202
         SR    R7,R4                    DECR MSG LNG BY BFR LNG         61204002
         NI    BUFFFL1,NOT-BUFFIHOT     TURN OFF FLAG,BOTH Q'S @ZA08015 61213037
         MVC   TSBOTBFP,BUFFTRLR        DROP THIS BFR OFF OF TRAILER Q  61223802
*                                                                       61225802
*   IF THIS IS A 3270 HEADER BUFFER, RESTORE BUFFOFST AND BUFFLNTH      61227802
*   TO INCLUDE THE CONTROL CHARACTERS                                   61229802
*                                                                       61231802
         TM    BUFFFL1,BUFFHDR          IS THIS A HEADER BFR     S22028 61233802
         BNO   NEXTBUFF                 BRANCH IF NO             S22028 61235802
         TM    BUFFFL2,BUFF3270         CHECK FOR 3270           S22028 61237802
         BNO   NEXTBUFF                 NO, GET NEXT BFR         S22028 61239802
         SR    R3,R3                    CLEAR REGISTER          ZA01350 61240202
         IC    R3,BUFFOFST              LOAD OFFSET TO DATA     ZA01350 61240602
         LA    R4,BUFFHDLN              GET HEADER OFFSET        S22028 61241802
         STC   R4,BUFFOFST              RESTORE ORIGINAL OFFSET  S22028 61242202
         SR    R3,R4                    GET THE DIFFERENCE       S22028 61242602
         IC    R4,BUFFLNTH              GET CURRENT DATA LENGTH  S22028 61243002
         AR    R3,R4                    GET ORIGINAL DATA LENGTH S22028 61243402
         STC   R3,BUFFLNTH              RESTORE ORIGINAL LENGTH  S22028 61243502
         B     NEXTBUFF                 GO GET NEXT BUFFER              61243602
*                                                                       61263402
BFRHIGH  EQU   *                                                        61283202
         AR    R3,R9                    BUMP OFFSET BY LINE SIZE        61303002
         SR    R4,R9                    DECR BFR LNG BY LINE SIZE       61322802
         SR    R7,R9                    DECR MSG LNG BY LINE SIZE       61342602
*                                                                       61362402
         CR    R7,R5                    IS MSG LNG NOW LT 2 LINES?      61382202
         BL    REPBFR                   YES, GO STORE LNG & OFFSET      61402002
         LR    R9,R6                    LOAD UNADJUSTED LINE SIZE       61421802
         B     COMPARE                  GO COMPARE AGAINST BFR LNG      61441602
*                                                                       61461402
REPBFR   EQU   *                                                        61481202
         STC   R3,BUFFOFST              STORE UPDATED OFFSET            61501002
         STC   R4,BUFFLNTH              STORE UPDATED DATA LENGTH       61520802
*                                                                       61540602
SETBIPI  EQU   *                                                        61560402
         OI    TSBFLG2,TSBBIPI          SET PARTIAL LINE IN PROCESS     61580202
         BR    R14                      RETURN TO CALLER                61600020
*                                                                       62100020
*********************************************************************** 62200020
*                                                                       62300020
QTIP0160 EQU   *                                                        62400020
*                                                                       62500020
*********************************************************************** 62600020
*                                                                       62700020
*                                                                       62705020
*   THIS ENTRY RESETS QCBTPUT/QCBWRBRK AND TPOSTS THE LCB TO ITSELF     62710020
*                                                                       62715020
*   REGISTERS AT ENTRY --                                               62720020
*        REG. 4 - LCB ADDR                                              62725020
*        REG. 7 - QCB ADDR                                              62730020
*        REG. 8 - TSB ADDR                                              62735020
*        REG.13 - ADDR OF AVTSAVE2                                      62740020
*                                                                       62745020
*   RETURN CODE IN REG. 15 --                                           62750020
*        0 - NO AUTO PROMPT REQUESTED                                   62755020
*        4 - AUTO PROMPT REQUESTED                                      62760020
*                                                                       62765020
         SR    R15,R15                  ASSUME NO AUTO PROMPT           62770020
         CLI   TSBNOBF,NULL             ARE THERE ANY MORE MSGS         62775020
         BNZ   TESTQS                   YES, CK REALLY ANY DATA@ZA07610 62780037
TCQISS   EQU   *                                               @ZA07610 62780137
         TM    TSBFLG1,TSBIFLSH         WAS TCLEARQ INPUT ISSUED YM2814 62780200
         BNO   PASTCI                   NO, DON'T RESET FLAGS    YM2814 62780400
         NI    TSBFLG1,NOT-TSBIFLSH     NO MORE FLUSHING         YM2814 62780600
         NI    TSBFLG2,NOT-TSBBIPI-TSBBRKIN  NOTHING TO REPROMPT YM2814 62781000
         NI    TSBFLG3,NOT-TSBSPIT      PERMIT FUTURE REPROMPTS  YM2814 62784000
*                                                                       62787000
PASTCI   EQU   *                                                        62790000
         NI    TSBFLG3,NOT-TSBTPUT      SHOW TSOUTPUT IS DONE   YS02019 62791002
         TM    QCBFLAG-IEDQQCB(R7),QCBTSSES  TSO SESSION                62792000
         BNO   POSTLCB                  NO, GO TPOST LCB                62795000
         NI    QCBTSOF1-IEDQQCB(R7),NOT-QCBTPUT-QCBWRBRK                62800000
*                                                                       62805000
RET15    EQU   *                                                        62810000
         TM    TSBSTAT,TSBDISC          DISCONNECT REQUESTED    YM2814  62815000
         BO    POSTLCB                  YES, DON'T CHECK PROMPT YM2814  62820000
         TM    TSBFLG2,TSBSTAUT         AUTO PROMPTING REQUESTED?       62825000
         BNO   POSTLCB                  NO, GO POST LCB TO ITSELF       62830000
         NI    TSBFLG2,NOT-TSBSTAUT     RESET PROMPT REQUEST BIT        62835000
         LA    R15,RTNCD04              INDICATE AUTO PROMPT REQUESTED  62840000
         BR    R14                      RETURN TO CALLER                62845000
*                                                                       62850000
TESTQS   EQU   *                                               @ZA07610 62850137
         NC    TSBOBFP,TSBOBFP          OUTPUT HEADER QUEUE    @ZA07610 62850237
*                                       EMPTY                  @ZA07610 62850337
         BNZ   COHQBKI                  NO, CHECK IF BREAKIN   @ZA07610 62850437
         NC    TSBOTBFP,TSBOTBFP        TRAILER BUFFER QUEUE   @ZA07610 62850537
*                                       EMPTY                  @ZA07610 62850637
         BZ    MNULICT                  YES, SHOULDN'T HAPPEN  @ZA07610 62850737
*                                       CLEAR CT FIELD         @ZA07610 62850837
         L     R2,TSBOTBFP-1            GET FIRST TR BFR       @ZA07610 62850937
ANYDINB  EQU   *                                               @ZA07610 62851037
         CLI   BUFFLNTH,NULL            ANY DATA IN THIS BFR   @ZA07610 62851137
         BNE   RET15                    YES, LEAVE QCBTPUT ON  @ZA07610 62851237
         L     R2,BUFFTRLR-1            POINT TO NEXT BFR      @ZA07610 62851337
         LA    R2,NULL(,R2)             CLEAR HIGH BYTE        @ZA07610 62851437
         LTR   R2,R2                    IS THIS END OF CHAIN   @ZA07610 62851537
         BNZ   ANYDINB                  NO, SEE IF ANY DATA    @ZA07610 62851637
*                                       IN BUFFER              @ZA07610 62851737
         B     TCQISS                   YES, TURN QCBTPUT OFF  @ZA07610 62851837
COHQBKI  TM    TSBFLG2,TSBBIPI          REPROMPT IN PROGRESS ? @ZA07610 62851937
         BZ    RET15                    NO, LEAVE QCBTPUT ON   @ZA07610 62852037
         TM    TSBFLG2,TSBBRKIN         DOES BIPI REALLY MEAN  @ZA07610 62852137
*                                       A PROMPT IS OUTSTANDING@ZA07610 62852237
         BNZ   RET15                    NO, LEAVE QCBTPUT ON   @ZA10218 62852337
         B     TCQISS                   YES, TURN QCBTPUT OFF  @ZA07610 62852437
*                                                              @ZA07610 62852537
MNULICT  MVI   TSBNOBF,NULL             MOVE ZERO INTO CT FIELD@ZA07610 62852637
         B     TCQISS                   TURN OFF QCBTPUT       @ZA07610 62852737
POSTLCB  EQU   *                                                        62855000
         LR    R1,R4                    LCB IS ELEMENT                  62860000
         LR    R2,R4                    LCB IS QCB TOO                  62865000
         ICM   R1,8,TPPRILCB            INSERT TPOST PRIORITY           62870000
         LA    R13,0(,R13)              REQUEST NO TIME DELAY CHK       62875000
         L     R15,TPQADDR              ADDR OF IKJGGTPQ                62880000
         BALR  R0,R15                   GO TPOST LCB TO SELF            62885000
         SR    R15,R15                  SET RETURN CODE                 62890000
         BR    R14                      RETURN TO CALLER                62895000
*                                                                       66300020
*********************************************************************** 66800020
*                                                                       66830020
QTIP0240 EQU   *                                                        66860020
*                                                                       66900020
*********************************************************************** 68200020
*                                                                       68203020
*   THIS QTIP ENTRY REMOVES ASID OWAIT.                                 68206002
*   IT IS USED BY THE CANCEL FUNCTION                                   68209002
*                                                                       68212020
*   THE ASID IS EXPECTED IN REG. 5.  REGS. 2-14 WILL BE PRESERVED.      68215002
*                                                                       68218020
**********************************************************************  68221020
*                                                                       68224020
         L     R15,CVTPTR               GET CVT ADDR            YS02019 68226002
         USING CVT,R15                  MAKE CVT ADDRESSABLE    YS02019 68228002
         L     R1,CVTAQAVT              GET TCX ADDR            YS02019 68230002
         DROP  RTIOC                                             A42911 68234521
         L     R1,TCXRPT-IEDQTCX(,R1)   ADDRESS OF TIOCRPT      YS02019 68235002
         USING TIOCRPT,R1                                        A42911 68235502
         LR    R0,R12                   SAVE BASE REGISTER      YS02019 68235602
         L     R12,TIOCSAVE             RESTORE CALLER'S REG 12 VS01090 68235902
         STM   R2,R14,TIOCSAVE+R5*REGLEN SAVE REGISTER CONTENTS YS02019 68236002
         LR    R12,R0                   RESTORE BASE REGISTER   YS02019 68236102
         L     R9,CVTASVT               GET ADDR OF ASVT        YS02019 68236202
         USING ASVT,R9                  ASVT NOW ADDRESSABLE    YS02019 68236502
         LA    R13,TIOCSAVE             5-WORD SAVE AREA FOR    YS02019 68237502
         DROP  R15,R1                    POSTECB SUBROUTINE     YS02019 68238002
*                                                                       68242020
         SLL   RASCB,E2                 GET OFFSET IN ASVT      YS02019 68251802
         L     RASCB,ASVTENTY-L'ASVTENTY(RASCB)  GET ASCB ADDR  YS02019 68260002
         USING ASCB,RASCB               ASCB NOW ADDRESSABLE    YS02019 68263002
         L     RTSB,ASCBTSB             GET TSB ADDR            YS02019 68272002
*                                                                       68272302
         OI    TSBFLG4,TSBCANC          INDICATE TSB CANCELED   YS02019 68272602
         TM    TSBFLG1,TSBTJOW          IS ASID TPUT WAITING    YS02019 68273002
         BNO   RETURN24                 NO, GO SET UP TO RETURN  A42911 68276021
         BAL   R4,POSTECB               GO POST THE TJID TPUT    A42911 68279021
*                                       WAITING FOR BUFFERS             68282021
RETURN24 EQU   *                                                 A42911 68285021
         LM    R2,R14,R5*REGLEN(R13)    RESTORE REGISTER        YS02019 68288002
         DROP  R9,RASCB                 ADDRESSABILITY ENDS     YS02019 68289002
         LR    R15,R12                  SAVE SIC'S REG 12 SO    VS01090 68291002
*                                       QTIP EPILOG WON'T       VS01090 68293402
         BR    R14                      RETURN                   A42911 68294021
*                                                                       68300020
*********************************************************************** 68400020
*                                                                       68500020
*   CONSTANTS                                                           68600020
*                                                                       68700020
*********************************************************************** 68800020
*                                                                       68900020
CLRQADDR DC    A(QTIP0030)              ADDR OF QUEUE CLEARING QTIP     69100020
CLRQBASE DC    A(QTIP0000)              BASE ADDR OF Q CLEARING QTIP    69300020
*                                                                       69500020
QT28ADDR DC    A(QTIP0280)              ADDRESS OF QTIP 28 ROUTINE      69570020
QT28BASE DC    A(QTIP0050)              BASE ADDR OF QTIP 28 RTN        69640020
*                                                                       69710020
STATREGS DC    A(8)                     .REGISTERS 0 AND 1      YS02019 69720002
STATREG1 DC    X'80000000'              .FOR STATUS             YS02019 69730002
HIGHON   EQU   STATREG1                 FOR INTERREGION POST REQYS02019 69732002
         ORG   HIGHON+1                 LOW-ORDER USED AS ZEROS SA70323 69734002
ZEROS    DS    CL3                      HERE THEY ARE           SA70323 69736002
MSKIWAIT DC    AL1(0,0,TCBIWAIT,0)      MASK FOR STATUS         YS02019 69740002
MSKOWAIT DC    AL1(0,0,TCBOWAIT,0)      MASK FOR STATUS         YS02019 69750002
*                                                                       69760002
QBRADDR  DC    A(IEDAYQBR)              ADDR OF BFR RETURN RTN  YS02019 69770002
AYOOBASE DC    A(QTIP0110)              BASE ADDR OF IEDAYOO    YS02019 69852002
TPQADDR  DC    A(IEDAYTPQ)              TPOSTING ROUTINE        YS02019 69854002
PATCHREA DC    20F'0'                   PATCH AREA               Y01018 69857037
TSIPRIOR DC    AL1(PRIBFRTB)            TPOST PRIORITY FOR TSI   Y01018 69878000
TPPRILCB DC    AL1(PRILNFRE)            TPOST PRIORITY FOR LCB   Y01018 69885000
         EJECT                                                          70240002
         IHAASCB                                                        70280002
         EJECT                                                          70320002
         IHAASVT                                                        70360002
         EJECT                                                          70409020
         TAVTD                                                          70509020
         EJECT                                                          70609020
         IKJTIOCB                                                       70709020
         EJECT                                                          70809020
CVT      DSECT                                                          70909020
         CVT                                                            71009020
         EJECT                                                          71109020
         TDISPD                                                         71209020
         EJECT                                                          71309020
         TLCBD                                                          71409020
         EJECT                                                          71509020
         TPRIOR                                                         71609020
         EJECT                                                          71709020
         TQCBD                                                          71809020
         EJECT                                                          71909020
         TSCBD                                                          72009020
         EJECT                                                          72029021
         IHASCVT                                                        72093000
         EJECT                                                          72109020
         IKJTCB                                                         72209020
         EJECT                                                          72239002
         TTCXD                                                          72269002
         EJECT                                                          72309020
         IKJTIOCP                                                       72409020
         EJECT                                                          72459002
         TTRMD                                                          72509002
         EJECT                                                          72909020
         IKJTSB                                                         73009020
         EJECT                                                          73109020
         TTSID                                                          73409020
         EJECT                                                          73459002
         IEEBASEA                                                       73509002
         END                                                            74800020
