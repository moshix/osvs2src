         TITLE 'IEDAYQT - QTIP (TIOC EXTENDED ROUTER SVC)'              00200002
* **************************************************************        00250002
*                                                                       00300002
*01* MODULE-NAME = IEDAYQT                                              00350002
*                                                                       00360002
*01* DESCRIPTIVE-NAME = QTIP (TIOC EXTENDED ROUTER SVC)                 00370002
*                                                                       00380002
*01* COPYRIGHT = NONE                                                   00390002
*                                                                       00392002
*01* STATUS = 01                                                        00394003
*              VS2    037   ACTIVITY                                  * 00394403
*                                                              @ZA14774 00394503
*  A 107000,109000                                              ZA14774 00394603
*  A 354600,355200                                              ZA10285 00394703
********    VS2-3.0 DELETIONS, CHANGES AND ADDITIONS                    00394803
*C753600,753800,753900,753920,085500                            ZA00611 00395203
*                                                                       00396002
*01* FUNCTION = ROUTES QTIP REQUESTS TO THE APPROPRIATE ROUTINE.        00398002
*               THIS MODULE ALSO CONTAINS CERTAIN COMMON                00398402
*               SUBROUTINES USED BY THE VARIOUS QTIP ROUTINES.          00398802
*                                                                       00399202
*01* NOTES =                                                            00399602
*                                                                       00399702
*02*   DEPENDENCIES = N/A                                               00399802
*                                                                       00399902
*02*   RESTRICTIONS = THE QTIP SVC WILL ACT AS A NOP WHEN ISSUED        00416602
*                     IN A NON-SYSTEM KEY, OR WHEN TIME SHARING         00426602
*                     IS NOT ACTIVE.                                    00427002
*                                                                       00427402
*02*   REGISTER-CONVENTIONS = SEE REGISTER EQUATES                      00428602
*                                                                       00430602
*02*   PATCH-LABEL = PATCH                                              00432602
*                                                                       00433002
*01* MODULE-TYPE = ASSEMBLER LANGUAGE CSECT                             00433102
*                                                                       00433202
*02*   PROCESSOR = SEE LISTING                                          00438802
*                                                                       00440802
*02*   MODULE-SIZE = SEE EXTERNAL SYMBOL DICTIONARY TYPE SD ID 01       00442802
*                                                                       00443202
*02*   ATTRIBUTES = REENTRANT, REFRESHABLE, SUPERVISOR STATE            00443602
*                                                                       00444102
*01* ENTRY-POINTS = IEDAYQT, IEDAYQT1, IEDAYTPQ, IEDAYQBA, IEDAYQBR     00444202
*                                                                       00444302
*02*   PURPOSE =                                                        00483202
*                                                                       00493202
*        (IEDAYQT AND IEDAYQT1)                                         00495202
*        VALIDATE CALLING PARAMETERS (EXPLICIT AND IMPLICIT)            00497202
*        AND PASS CONTROL TO APPROPRIATE FUNCTIONAL CSECT.              00499202
*                                                                       00501202
*        (IEDAYTPQ)                                                     00501602
*        TPOST THE SPECIFIED ELEMENT TO THE SPECIFIED QCB.              00502002
*                                                                       00502402
*        (IEDAYQBA)                                                     00502802
*        GET A TIOC BUFFER FROM ONE OF THE FREE LISTS.                  00502902
*                                                                       00503002
*        (IEDAYQBR)                                                     00503102
*        RETURN A TIOC BUFFER TO THE PROPER FREE LIST.                  00506402
*                                                                       00508402
*02*   LINKAGE =                                                        00509902
*                                                                       00513202
*        IEDAYQT - ENTERED BECAUSE SVC 101 ISSUED.                      00513602
*        IEDAYQT1 - ENTERED VIA BALR 14,15                              00514002
*        IEDAYTPQ - ENTERED VIA BALR 0,15                               00514402
*        IEDAYQBA - ENTERED VIA BALR 0,15                               00514802
*        IEDAYQBR - ENTERED VIA BALR 0,15                               00514902
*                                                                       00515002
*01* INPUT =                                                            00515202
*                                                                       00517202
*        (IEDAYQT)                                                      00519202
*        SVC MUST BE ISSUED IN SUPERVISOR KEY (0-7).                    00521202
*        REGISTER 00 CONTAINS THE ENTRY CODE.                           00521302
*        REGISTER 01 CONTAINS 0 OR THE ADDRESS OF A 12 WORD SAVE AREA.  00521402
*        REGISTER 03 CONTAINS CVT ADDRESS                               00521502
*        REGISTER 04 CONTAINS TCB ADDRESS                               00521602
*        REGISTER 05 CONTAINS RB ADDRESS                                00521702
*        REGISTER 14 CONTAINS SUPERVISOR RETURN ADDRESS                 00521802
*                                                                       00521902
*        (IEDAYQT1)                                                     00524502
*        MUST BE CALLED IN SUPERVISOR STATE (ANY KEY).                  00526502
*        REGISTER 00 CONTAINS THE ENTRY CODE                            00526902
*        REGISTER 14 CONTAINS RETURN ADDRESS                            00527002
*        REGISTER 15 CONTAINS ENTRY POINT ADDRESS                       00527102
*                                                                       00527202
*        (IEDAYTPQ, IEDAYQBA, IEDAYQBR)                                 00530102
*        SEE COMMENTS IN FRONT OF SUBROUTINES THEMSELVES.               00534802
*                                                                       00538102
*01* OUTPUT =                                                           00541002
*                                                                       00541402
*        (IEDAYQT)                                                      00541602
*        INVOKES SPECIFIED QTIP ROUTINE IN TCAM'S KEY.                  00543602
*        REGISTER 00 AND 01 CONTAIN ADDRESS OF QTIP ROUTINE.            00544002
*        REGISTERS 2-11 AND 13 ARE RESTORED FROM SAVE AREA IF PASSED    00544402
*        REGISTER 12 CONTAINS BASE ADDRESS OF QTIP ROUTINE.             00544802
*        REGISTER 14 CONTAINS SUPERVISOR RETURN ADDRESS                 00544902
*        REGISTER 15 CONTAINS SAME CONTENTS AS WHEN SVC ISSUED.         00545002
*                                                                       00545502
*        (IEDAYQT1)                                                     00545902
*        INVOKES SPECIFIED QTIP ROUTINE IN TCAM'S KEY.                  00546302
*        REGISTERS 0, 1, 12 SAME AS WITH IEDAYQT.                       00546402
*        REGISTERS 2-13 AND 15 SAME AS ENTRY.                           00546702
*        REGISTER 14 CONTAINS ADDRESS OF BRANCH ENTRY EPILOG            00547102
*                    (IN IEDAYQT)                                       00547202
*        AFTER THE QTIP ROUTINE EXITS, THE BRANCH ENTRY EPILOG          00547302
*        RESTORES THE CALLER'S ORIGINAL KEY.                            00547402
*        ALL REGISTERS EXCEPT 12 AND 14 ARE AS WHEN THE QTIP ROUTINE    00548202
*        EXITED.  12 IS CLOBBERED.  14 CONTAINS USERS RETURN ADDRESS.   00550402
*                                                                       00550502
*        (IEDAYTPQ, IEDAYQBA, IEDAYQBR)                                 00550602
*        SEE COMMENTS IN FRONT OF SUBROUTINES THEMSELVES.               00550702
*                                                                       00550802
*01* EXIT-NORMAL =                                                      00551202
*                                                                       00552002
*        (IEDAYQT)                                                      00552402
*        INVOKES SPECIFIED QTIP ROUTINE.                                00552502
*                                                                       00553202
*        (IEDQYQT1)                                                     00553402
*        INVOKES SPECIFIED QTIP ROUTINE, THEN RETURNS TO CALLER.        00553602
*                                                                       00553702
*        (IEDAYTPQ, IEDAYQBA, IEDAYQBR)                                 00553802
*        RETURN TO CALLER'S RETURN ADDRESS.                             00554202
*                                                                       00554602
*01* EXIT-ERROR =                                                       00555102
*                                                                       00555202
*        (IEDAYQT, IEDAYQT1) - BR 14                                    00555302
*                                                                       00555402
*        (IEDAYTPQ, IEDAYQBR, IEDAYQBA) - NONE                          00556202
*                                                                       00557902
*01* EXTERNAL-REFERENCES -                                              00558702
*                                                                       00559502
*02*   ROUTINES = POST (IEA0PT01), AND THE QTIP ROUTINES                00560302
*                                                                       00561102
*02*   DATA-AREAS = NA                                                  00567502
*                                                                       00577902
*02*   CONTROL-BLOCKS = SEE MAPPING MACROS AT END OF LISTING            00578302
*                                                                       00581902
*01* TABLES = QTIP ROUTINE ADDRESSES (SEE LABEL 'TABLE').               00583902
*                                                                       00584302
*01* MACROS = MODESET                                                   00584702
*                                                                       00585102
*01* CHANGE-ACTIVITY -  SJ00088 05/07/73                                00585502
*                       VS01090 05/14/73                                00587502
*                       VS01373 06/16/73                                00587902
*                       ZA00611 08/22/74                                00588303
*                                                                       00589102
******************************************************************      00591102
         EJECT                                                          00591502
IEDAYQT  CSECT                                                          00592802
*                                                                       00600002
*   REGISTER EQUATES                                                    00800002
*                                                                       01000002
R0       EQU   0                        INTERFACE REGISTER              01200002
RCODE    EQU   0                        ENTRY CODE                      01400002
RWRK0    EQU   0                        WORK REGISTER                   01600002
RPARM    EQU   1                        PARAMETER REGISTER              01800002
RELEM    EQU   1                        RECB POINTER                    02000002
R2       EQU   2                        INTERFACE REGISTER              02200002
RQCB     EQU   2                        QCB POINTER                     02400002
R3       EQU   3                        CVT POINTER                     02450002
RTCB     EQU   4                        TCB POINTER                     02600002
RRB      EQU   5                        RB POINTER                      02800002
RRPT     EQU   6                        TIOCRPT POINTER                 02850002
RWK9     EQU   9                        WORK REGISTER                   02900002
R10      EQU   10                       INTERFACE REGISTER              03000002
RWK10    EQU   10                       INTERFACE REGISTER              03200002
RWK11    EQU   11                       INTERFACE REGISTER              03400002
R12      EQU   12                       INTERFACE REGISTER              03600002
RBASE    EQU   12                       BASE REGISTER                   03800002
RTCX     EQU   12                       TCX POINTER                     04000002
R13      EQU   13                       INTERFACE REGISTER              04200002
RLINK    EQU   14                       LINK REGISTER                   04400002
R15      EQU   15                       INTERFACE REGISTER              04600002
*                                                                       04800002
*   MASKS AND DISPLACEMENTS                                             05000002
*                                                                       05200002
PKEYDISP EQU   1                        OFFSET OF PROTECTION            05400002
*                                       KEY IN PSW                      05600002
USERKEY  EQU   X'80'                    MASK FOR KEYS 8-15              05800002
E0       EQU   0                        NULL                            06000002
E24      EQU   24                       DECIMAL 24                      06200002
E1       EQU   1                        DECIMAL 1                       06400002
TBLSHIFT EQU   2                        SHIFT VALUE TO MULTIPLY         06600002
*                                       BY TABLE ENTRY LENGTH           06800002
E8       EQU   8                        DECIMAL 7                       07000002
E7       EQU   7                        DECIMAL 8                       07200002
EPGSHIFT EQU   12                       SHIFT VALUE FOR PAGE NO.        07400002
R13DISP  EQU   X'2C'                    R13 DISPL. IN PARM AREA         07450002
*                                                                       07600002
**********************************************************************  07650002
*                                                                       07700002
*              VALIDITY CHECK FOR SVC CALLER                            07800002
*                                                                       07810002
**********************************************************************  07850002
*                                                                       08000002
         BALR  RBASE,RWRK0              GET BASE ADDRESS                08200002
         USING *,RBASE                  BASE REG                        08400002
         B     SVCBASE                  BRANCH AROUND MODULE ID         08450002
         DC    C'IEDAYQT '              MODULE I.D.                     08500002
         DC    X'4234'                  DATE - 08/22/74         ZA00611 08550003
SVCBASE  EQU   *                                                        08600002
         USING RBSECT,RRB               RB PASSED BY FLIH               09200002
         TM    RBOPSW+PKEYDISP,USERKEY  WAS SVC ISSUED BY SYSTEM        09400002
         BOR   RLINK                    NO, EXIT                        09600002
         DROP  RRB                      RB NOT ADDRESSABLE              09610002
         SPACE 3                                                        09650002
*                                                                       09700002
**********************************************************************  09710002
*                                                                       09720002
*        SET UP FUNCTION RECOVERY ROUTINE FOR QTIP SVC                  09750002
*                                                                       09760002
**********************************************************************  09762002
*                                                                       09764002
         LA    RWK9,QTIPFRR             GET FRR EXIT RTN ADDRESS        09766002
         SETFRR A,FRRAD=(9),WRKREGS=(10,11) SET UP FRR                  09770002
         SPACE 3                                                        09780002
*                                                                       09790002
**********************************************************************  09790402
*                                                                       09790802
*              SAVE RETURN ADDRESS IN TIOCQRET                          09792002
*                                                                       09794002
**********************************************************************  09794102
*                                                                       09794202
         MODESET EXTKEY=TCAM            GET INTO TCAM'S KEY             09794402
         L     RRPT,CVTAQAVT-CVT(,R3)   ADDRESS OF TCX                  09796002
         L     RRPT,TCXRPT-IEDQTCX(,RRPT)  ADDRESS OF TIOCRPT           09798002
         USING TIOCRPT,RRPT             TIOCRPT ADDRESSABLE             09798402
         ST    RLINK,TIOCQRET           SAVE RETURN ADDRESS             09798802
         MVI   TIOCQTKY,E0              CHANGE BACK TO KEY 0 BEFORE     09809002
*                                       RETURNING TO SUPERVISOR         09819002
         DROP  RRPT                     TIOCRPT NOT ADDRESSABLE         09819402
         SPACE 3                                                        09829602
*                                                                       09839802
**********************************************************************  09850002
*                                                                       09900002
*   RESTORE REGISTERS 2-13 FROM THE CALLER-SUPPLIED PARAMETER AREA      10000002
*                                                                       10200002
**********************************************************************  10250002
*                                                                       10300002
         LTR   RPARM,RPARM              ANY PARAMETERS PASSED           10400002
         BZ    ROUTING                  NO, DON'T RESTORE               10600002
         MODESET EXTKEY=SUPR                                    ZA14774 10700003
         LM    R2,RWK11,E0(RPARM)       RESTORE REG.S                   10800002
         L     R13,R13DISP(,RPARM)      RESTORE REG. 13                 10810002
         MODESET EXTKEY=TCAM                                    ZA14774 10900003
ROUTING  EQU   *                                                        10992002
         BAL   RLINK,ROUTER             GO CALCULATE DESTINATION        11000002
         DROP  RBASE                    MODULE NOT ADDRESSABLE          11010002
         SPACE 3                                                        11020002
*                                                                       11050002
**********************************************************************  11060002
*                                                                       11070002
*              SVC ENTRY EPILOG                                         11100002
*                                                                       11150002
**********************************************************************  11152002
*                                                                       11154002
         USING *,RLINK                  SET UP BASE FOR MODULE          11154402
         MODESET EXTKEY=SUPR            CHANGE INTO SUPERVISOR KEY      11154802
         SETFRR D,WRKREGS=(1,12)        CANCEL THE FRR                  11156002
         B     BREPILOG                 GO TO BRANCH ENTRY EPILOG       11206002
         DROP  RLINK                    DROP MODULE BASE                11256002
         SPACE 5                                                        11292002
*                                                                       11800002
**********************************************************************  11850002
*                                                                       11900002
*              BRANCH ENTRY POINT TO QTIP                               12000002
*                                                                       12200002
**********************************************************************  12250002
*                                                                       12300002
IEDAYQT1 EQU   *                                                        12400002
         ENTRY IEDAYQT1                 ENTRY POINT                     12600002
         SPACE 3                                                        12650002
         L     RPARM,CVTPTR             GET CVT ADDR                    12800002
         L     RPARM,CVTAQAVT-CVT(,RPARM)  GET TCX ADDR                 13000002
         L     RPARM,TCXRPT-IEDQTCX(,RPARM) GET TIOCRPT ADDR            13200002
         USING TIOCRPT,RPARM            TIOCRPT ADDRESSABLE             13400002
         MODESET EXTKEY=TCAM,WORKREG=15, GET TCAM'S KEY AND            -13600002
               SAVEKEY=TIOCQTKY          SAVE CALLER'S KEY              13800002
         L     R15,TIOCQTIP             RELOAD BRANCH ENTRY     YM01373 13850002
         ST    RLINK,TIOCQRET           SAVE RETURN ADDR                14000002
         ST    RBASE,TIOCSAVE           SAVE REGISTER 12                14050002
         DROP  RPARM                    NO LONGER TIOCRPT BASE          14200002
         BALR  RBASE,RWRK0              SET BASE REGISTER               14400002
         USING *,RBASE                  MODULE ADDRESSABILITY           14600002
         BAL   RLINK,ROUTER             SET RETURN ADDR AND             14800002
*                                       GO INVOKE QTIP ROUTINE          15000002
         DROP  RBASE                    END OF ADDRESSABILITY           15200002
         SPACE 3                                                        15250002
*                                                                       15400002
**********************************************************************  15450002
*                                                                       15500002
*              BRANCH ENTRY EPILOG                                      15600002
*                                                                       15800002
**********************************************************************  15850002
*                                                                       15900002
BREPILOG EQU   *                                                        15950002
         L     RBASE,CVTPTR             GET CVT ADDR                    16000002
         L     RBASE,CVTAQAVT-CVT(,RBASE)   GET TCX ADDR                16200002
         L     RBASE,TCXRPT-IEDQTCX(,RBASE) GET TIOCRPT ADDR            16400002
         USING TIOCRPT,RBASE            TIOCRPT ADDRESSABLE             16600002
         L     RLINK,TIOCQRET           RESTORE RETURN ADDR             16800002
         MODESET KEYADDR=TIOCQTKY,      RESTORE CALLER'S KEY           -17000002
               WORKREG=12                                               17200002
         LR    RBASE,R15                RESTORE REG 12 FOR SIC  VS01090 17210002
         DROP  RBASE                    RPT ADDRESSABILITY ENDS         17250002
QTIPEXIT EQU   *                        RETURN TO CALLER (OR SVC EPILOG 17400002
         BR    RLINK                    IN CASE OF INVALID ENTRY)       17410002
         SPACE 3                                                        17450002
*                                                                       17460002
**********************************************************************  17500002
*                                                                       17600002
*   ROUTE THIS REQUEST TO THE APPROPRIATE QTIP ROUTINE                  17800002
*                                                                       18000002
**********************************************************************  18050002
*                                                                       18100002
ROUTER   EQU   *                                                        18200002
         BALR  RBASE,RWRK0              GET ADDRESSABILITY              18400002
         USING *,RBASE                  MODULE ADDRESSABILITY           18600002
         LTR   RPARM,RCODE              IS ENTRY CODE POSITIVE          18800002
         BMR   RLINK                    NO, EXIT                        19000002
         C     RCODE,TBLIMIT            IS ENTRY CODE INVALID           19200002
         BHR   RLINK                    YES, EXIT                       19400002
         SLL   RPARM,TBLSHIFT           GET OFFSET INTO TABLE           19800002
         L     RCODE,TABLE(RPARM)       LOAD ENTRY POINT                20000002
         LR    RPARM,RCODE              GET NO. OF BASE ENTRY           20200002
         SRL   RPARM,E24                RIGHT ADJUST ENTRY NO.          20400002
         SLL   RPARM,TBLSHIFT           GET OFFSET OF BASE ADDR         20600002
         L     RBASE,TABLE(RPARM)       GET BASE ADDR                   20800002
         DROP  RBASE                    MODULE NOT ADDRESSABLE          21000002
         LR    RPARM,RCODE              PREPARE TO BRANCH               21200002
         BR    RPARM                    BR TO QTIP ROUTINE              21400002
         SPACE 3                                                        21450002
*                                                                       21600002
**********************************************************************  21650002
*                                                                       21700002
*   ENTRY POINT AND BASE ADDRESS TABLE FOR QTIP ROUTINES                21800002
*                                                                       22000002
*        BYTE 0 OF EACH ENTRY CONTAINS THE NUMBER OF THE TABLE          22050002
*        ENTRY CONTAINING THE BASE ADDRESS FOR THAT MODULE.             22100002
*                                                                       22150002
**********************************************************************  22160002
*                                                                       22170002
TABLE    DS    0A                                                       22200002
         DC    AL1(00),VL3(QTIP0000)    ATTENTION (IEDAYAA BASE)        22400002
         DC    AL1(23),VL3(QTIP0010)    LOGOFF RECONNECT (IEDAY88 BASE) 22600002
         DC    AL1(00),AL3(QTIPEXIT)    RESERVED                        22800002
         DC    AL1(00),VL3(QTIP0030)    ATTENTION                       23000002
         DC    AL1(04),VL3(QTIP0040)    HANGUP    (IEDAYHH BASE)        23200002
         DC    AL1(05),VL3(QTIP0050)    TSINPUT   (IEDAYII BASE)        23400002
         DC    AL1(05),VL3(QTIP0060)    TSINPUT                         23600002
         DC    AL1(05),VL3(QTIP0070)    TSINPUT                         23800002
         DC    AL1(05),VL3(QTIP0080)    TSINPUT                         24000002
         DC    AL1(05),VL3(QTIP0090)    TSINPUT                         24200002
         DC    AL1(10),VL3(QTIP0100)    LOGON     (IEDAYLL BASE)        24400002
         DC    AL1(11),VL3(QTIP0110)    TSOUTPUT  (IEDAYOO BASE)        24600002
         DC    AL1(11),VL3(QTIP0120)    TSOUTPUT                        24800002
         DC    AL1(11),VL3(QTIP0130)    TSOUTPUT                        25000002
         DC    AL1(11),VL3(QTIP0140)    TSOUTPUT                        25200002
         DC    AL1(11),VL3(QTIP0150)    TSOUTPUT                        25400002
         DC    AL1(11),VL3(QTIP0160)    TSOUTPUT                        25600002
         DC    AL1(00),AL3(QTIPEXIT)    RESERVED                        25800002
         DC    AL1(18),VL3(QTIP0180)    TGET/TPUT (IEDAYGP BASE)        26000002
         DC    AL1(18),VL3(QTIP0190)    TGET/TPUT                       26200002
         DC    AL1(00),AL3(QTIPEXIT)    RESERVED                        26400002
         DC    AL1(00),VL3(QTIP0210)    TCLEARQ                         26600002
         DC    AL1(00),VL3(QTIP0220)    TCLEARQ                         26800002
         DC    AL1(23),VL3(QTIP0230)    TERMINT'N (IEDAY88 BASE)        27000002
         DC    AL1(11),VL3(QTIP0240)    CANCEL                          27200002
         DC    AL1(00),AL3(QTIPEXIT)    RESERVED                        27400002
         DC    AL1(00),AL3(QTIPEXIT)    RESERVED                        27600002
         DC    AL1(23),VL3(QTIP0270)    LOGOFF DISCONNECT(IEDAY88 BASE) 27800002
         DC    AL1(05),VL3(QTIP0280)    TSINPUT                         28000002
         DC    AL1(18),VL3(QTIP0290)    TGET/TPUT                       28200002
TBLIMIT  DC    A((*-TABLE)/4-1)         HIGHEST ENTRY IN TABLE          28400002
         EJECT                                                          28600002
*                                                                       28800002
**********************************************************************  29000002
*                                                                       29200002
*   TPOSTING SUBROUTINE OF QTIP                                         29400002
*                                                                       29600002
**********************************************************************  29800002
*                                                                       30000002
*   REGISTERS AT ENTRY--                                                30200002
*        00 -- RETURN ADDRESS                                           30400002
*        01 -- ADDR OF ELEMENT TO BE TPOSTED (PRIORITY IN BYTE 0).      30600002
*              IF ZERO, MEANS SIMPLY TPOST TSB IF NOT ALREADY TPOSTED.  30800002
*        02 -- TARGET QCB ADDR IF REG. 1 IS NOT ZERO.                   31000002
*              TSB ADDR IF REG. 1=0.                                    31200002
*        13 -- ADDR OF 6 WORD SAVE AREA                                 31400002
*        15 -- ENTRY POINT                                              31600002
*                                                                       31800002
*   REGISTERS 2-14 ARE PRESERVED ACROSS THE CALL                        32000002
*                                                                       32050002
*   CALLER SHOULD BE IN TCAM'S KEY                                      32100002
*                                                                       32200002
IEDAYTPQ EQU   *                                                        32400002
         ENTRY IEDAYTPQ                 ENTRY POINT                     32600002
         USING *,R15                    ROUTINE ADDRESSABLE             32800002
         STM   RWK10,R15,E0(R13)        SAVE REGISTERS                  33000002
         L     RTCX,CVTPTR              GET CVT ADDR                    33200002
         L     RTCX,CVTAQAVT-CVT(,RTCX) GET TCX ADDR                    33400002
         USING IEDQTCX,RTCX             TCX ADDRESSABLE                 33600002
*                                                                       33800002
*   SET UP TO TPOST THE TSB TO IEDAYP                                   34000002
*                                                                       34200002
         LTR   RELEM,RELEM              TPOST OF TSB REQUESTED          34400002
         BNZ   TPOST                    NO, GO TPOST ELEM PASSED        34600002
         USING TSB,RQCB                 TSB ADDRESSABLE                 34800002
         TM    TSBTPFLG,TSBPOSTO        IS TSB ALREADY TPOSTED          35000002
         BO    TPQEXIT                  YES, EXIT                       35200002
*                                                                       35400002
         TM    TSBLECB,X'40'      HAS TSB BEEN POSTED?          ZA10285 35460003
         BO    TPQEXIT            YES, EXIT                     ZA10285 35520003
         L     RWK10,TSBTPOST           GET CURRENT SETTINGS            35600002
RESWAP   EQU   *                                                        35800002
         LR    RWK11,RWK10              COPY                            36000002
         O     RWK11,MSKPOSTO           SET TSBPOSTO                    36200002
         CS    RWK10,RWK11,TSBTPOST     FLAG TSB AS TPOSTED             36400002
         BNE   RESWAP                   RETRY UNTIL SUCCESSFUL          36600002
*                                                                       36800002
         LTR   RWK10,RWK10              WAS TSB ALREADY TPOSTED         37000002
         BM    TPQEXIT                  YES, EXIT                       37200002
*                                                                       37400002
         LA    RELEM,TSBRCB             WILL TPOST RCB IN TSB           37600002
         DROP  RQCB                     TSB NOT ADDRESSABLE             37800002
         L     RQCB,TCXTSI              GET ADDR OF TSI                 38000002
         O     RELEM,MSKPRI             INSERT TPOST PRIORITY           38200002
         LA    RQCB,TSITSAP-TSINPUT(,RQCB)  GET ADDR OF 'QCB'           38400002
*                                       FOR IEDAYP                      38600002
*                                                                       38800002
*   TPOST AN ELEMENT TO A QCB                                           39000002
*                                                                       39200002
TPOST    EQU   *                                                        39400002
         USING IEDQRECB,RELEM           ELEMENT IS ADDRESSABLE          39600002
         STCM  RQCB,E7,RECBQCBA         PUT QCB ADDR IN ELEM            39800002
         L     RWK10,TCXREADY           GET CURRENT 1ST ON LIST         40000002
ADDAGAIN EQU   *                                                        40200002
         ST    RWK10,RECBLINK-E1        LINK NEW ELEM TO OLD            40400002
         STCM  RELEM,E8,RECBPRI         SET TPOST PRIORITY              40600002
         CS    RWK10,RELEM,TCXREADY     ADD NEW ELEM TO LIST            40800002
         BNE   ADDAGAIN                 RETRY UNTIL SUCCESSFUL          41000002
         DROP  RELEM                    ELEM ADDRESSABILITY ENDS        41200002
*                                                                       41400002
*   POST TCAM                                                           41600002
*                                                                       41800002
         LR    RELEM,R13                HOLD SAVE AREA ADDR             42000002
         L     RWK11,TCXAVT             GET AVT ADDR                    42200002
         SR    RWK10,RWK10              ZERO COMPLETION CODE            42400002
         LA    RWK11,AVTOSECB-IEDQAVTD(,RWK11)  GET ADDR OF ECB         42600002
         O     RWK11,MSKXMPST           SET XMPOST FLAG                 42800002
         DROP  R15                      DROP BASE REG                   43000002
         MODESET EXTKEY=SUPR            CHANGE INTO SUPERVISOR'S KEY    43050002
         L     R15,CVTPTR               GET CVT ADDR                    43200002
         USING CVT,R15                  CVT ADDRESSABLE                 43400002
         L     R13,TCXASCB              GET TCAM'S ASCB ADDR            43600002
         LA    R12,CVTBRET              NO ERROR RETURN                 43800002
         L     R15,CVT0PT01             GET EPA FOR POST                44000002
         BALR  RLINK,R15                GO POST TCAM                    44200002
         MODESET EXTKEY=TCAM            GET TCAM'S KEY                  44250002
         DROP  R15                      CVT ADDR ENDS                   44400002
         LR    R13,RELEM                RESTORE SAVE AREA ADDR          44600002
*                                                                       44800002
*   RESTORE REGISTERS AND RETURN TO CALLER                              45000002
*                                                                       45200002
TPQEXIT  EQU   *                                                        45400002
         LM    RWK10,RLINK,E0(R13)      RESTORE                         45600002
         LR    R15,RWRK0                GET RETURN ADDR                 45800002
         BR    R15                      RETURN                          46000002
         EJECT                                                          46200002
*                                                                       46400002
**********************************************************************  46600002
*                                                                       46800002
*    TIOC BUFFER ALLOCATION SUBROUTINE                                  47000002
*                                                                       47200002
**********************************************************************  47400002
*                                                                       47600002
*   INPUT--                                                             47800002
*        REG. 00 - RETURN ADDR                                          48000002
*        REG. 10 - TIOCRPT ADDR (ONLY)                                  48200002
*        REG. 15 - ENTRY POINT ADDR                                     48400002
*   OUTPUT--                                                            48600002
*        REG. 02 - ADDR OF ALLOCATED BUFFER                             48800002
*        TIOCNFBF WILL BE DECREMENTED.                                  49000002
*                                                                       49200002
*   REGISTERS 2 & 15 WILL BE ALTERED BY THIS ROUTINE.                   49400002
*                                                                       49600002
*   FOR PERFORMANCE OPTIMIZATION, THIS ROUTINE ASSUMES ITS              49800002
*   CALLER HAS DETERMINED THAT A BUFFER IS AVAILABLE.                   50000002
*                                                                       50200002
IEDAYQBA EQU   *                                                        50400002
         ENTRY IEDAYQBA                 BUFFER ALLOCATION               50600002
         USING *,R15                    ROUTINE ADDRESSABLE             50800002
         USING TIOCRPT,R10              PASSED AS PARAMETER             51000002
*                                                                       51200002
*   UPDATE THE FREE BUFFER COUNT                                        51400002
*                                                                       51600002
         LH    R2,TIOCNFBF              GET COUNT                       51800002
         BCTR  R2,E0                    DECREMENT                       52000002
         STH   R2,TIOCNFBF              STORE UPDATED COUNT             52200002
*                                                                       52400002
*   FIND FIRST AVAILABLE BUFFER                                         52600002
*                                                                       52800002
         LA    R10,TIOCFBFL             GET ADDR OF 1ST LIST            53000002
         DROP  R10                      TIOCRPT NOT ADDRESSABLE         53200002
BALOOP   EQU   *                                                        53400002
         L     R2,E0(,R10)              GET ADDR OF 1ST ELEM            53600002
         LTR   R2,R2                    IS LIST EMPTY                   53800002
         BP    BFRFOUND                 NO, GO ALLOCATE BFR             54000002
         LA    R10,L'TIOCFBFL(,R10)     GET ADDR OF NEXT LIST           54200002
         B     BALOOP                   GO CHECK IT                     54400002
*                                                                       54600002
*   REMOVE ALLOCATED BUFFER FROM FREE LIST & RETURN                     54800002
*                                                                       55000002
BFRFOUND EQU   *                                                        55200002
         DROP  R15                      DROP BASE REGISTER              55400002
         L     R15,BUFFTRLR-E1-TIOCBUF(,R2)  ADDR OF NEXT ELEM          55600002
         ST    R15,E0(,R10)             MAKE IT FIRST ELEM              55800002
         L     R10,CVTPTR               GET CVT ADDR                    56000002
         L     R10,CVTAQAVT-CVT(,R10)   GET TCX ADDR                    56200002
         LR    R15,R0                   GET RETURN ADDR                 56400002
         L     R10,TCXRPT-IEDQTCX(,R10) GET TIOCRPT ADDR                56600002
         BR    R15                      RETURN                          56800002
         EJECT                                                          57000002
*                                                                       57200002
**********************************************************************  57400002
*                                                                       57600002
*   TIOC BUFFER RETURN SUBROUTINE                                       57800002
*                                                                       58000002
**********************************************************************  58200002
*                                                                       58400002
*   INPUT--                                                             58600002
*        REG. 00 - RETURN ADDR                                          58800002
*        REG. 02 - ADDR OF BUFFER BEING RETURNED                        59000002
*        REG. 10 - TIOCRPT ADDR                                         59200002
*        REG. 15 - ENTRY POINT ADDR                                     59400002
*                                                                       59600002
*   OUTPUT--                                                            59800002
*        TIOCNFBF WILL BE INCREMENTED                                   60000002
*                                                                       60200002
*   REGISTER 15 WILL BE ALTERED BY THIS ROUTINE                         60400002
*   THE HIGH-ORDER BYTE OF REGISTERS 2 & 10 MAY BE ALTERED.             60600002
*                                                                       60800002
IEDAYQBR EQU   *                                                        61000002
         ENTRY IEDAYQBR                 BUFFER RETURN                   61200002
         USING TIOCRPT,R10              TIOCRPT ADDRESSABLE             61400002
*                                                                       61600002
*   UPDATE FREE BUFFER COUNT                                            61800002
*                                                                       62000002
         LH    R15,TIOCNFBF             GET COUNT                       62200002
         LA    R15,E1(,R15)             INCREMENT                       62400002
         STH   R15,TIOCNFBF             STORE UPDATED COUNT             62600002
         LA    R2,E0(,R2)               CLEAR BYTE ZERO                 62800002
*                                                                       63000002
*   DETERMINE WHICH LIST THIS BUFFER SHOULD BE ADDED TO                 63200002
*                                                                       63400002
         LA    R10,TIOCFBFL             GET ADDR OF FIRST LIST          63600002
         DROP  R10                      AS TIOCRPT BASE                 63800002
BRLOOP   EQU   *                                                        64000002
         L     R15,E0(,R10)             GET BUFFER ADDR                 64200002
         LPR   R15,R15                  INSURE POSITIVE VALUE           64400002
*                                       (AN EMPTY LIST POINTER          64600002
*                                       CONTAINS THE COMPLEMENTED       64800002
*                                       ADDR OF THE BFR PAGE)           65000002
         SRL   R15,EPGSHIFT             ISOLATE PAGE NO.                65200002
         SLL   R15,EPGSHIFT             GET ADDRESS OF PAGE             65400002
*                                       CONTAINING THE BUFFERS          65600002
*                                       ON THIS LIST                    65800002
         XR    R15,R2                   .SEE IF RETURNING               66000002
         SRL   R15,EPGSHIFT             .BUFFER BELONGS                 66200002
         LTR   R15,R15                  .ON THIS LIST                   66400002
         BALR  R15,E0                   SET BASE ADDR                   66600002
         USING *,R15                    USE R15 AS BASE REG             66800002
QBRBASE  EQU   *                        TEMPORARY BASE                  67000002
         BZ    LSTFOUND                 BR IF BFR GOES ON THIS LIST     67200002
         LA    R10,L'TIOCFBFL(,R10)     POINT AT NEXT LIST              67400002
         S     R15,QBRDISP              GET BRANCH ADDR                 67600002
         DROP  R15                      ADDRESSABILITY CHANGED          67800002
         BR    R15                      GO CHECK NEXT LIST              68000002
QBRDISP  DC    A(QBRBASE-BRLOOP)        DISPLACEMENT TO BR ADDR         68200002
*                                                                       68400002
*   ADD BUFFER TO LIST & RETURN                                         68600002
*                                                                       68800002
LSTFOUND EQU   *                                                        69000002
         L     R15,E0(,R10)             GET ADDR OF 1ST ELEMENT         69200002
         ST    R15,BUFFTRLR-E1-TIOCBUF(,R2)  LINK NEW BFR TO OLD        69400002
         ST    R2,E0(,R10)              PUT NEW BFR AS 1ST              69600002
*                                                                       69800002
         L     R10,CVTPTR               GET CVT ADDRESS                 70000002
         L     R10,CVTAQAVT-CVT(,R10)   GET ADDR OF TCX                 70200002
         LR    R15,R0                   GET RETURN ADDR                 70400002
         L     R10,TCXRPT-IEDQTCX(,R10) GET ADDR OF TIOCRPT             70600002
         BR    R15                      RETURN                          70800002
         DROP  RTCX                     TCX NOT ADDRESSABLE             70802002
         EJECT                                                          70810002
*                                                                       70850002
**********************************************************************  70900002
*                                                                       70950002
*                      QTIP FRR EXIT ROUTINE                            70960002
*                                                                       70962002
*        THIS ROUTINE GETS CONTROL WHEN ABNORMAL SITUATION OCCURS       70964002
*        DURING THE PROCESS OF SVC 101.  IT REQUESTS THE RTM TO -       70968002
*                                                                       70968802
*        * DUMP THE TIOCRPT AND TSB TABLE                               70969202
*        * WRITE THE SDWA WORKAREA TO SYS1.LOGREC SO THE REGISTERS AT   70969602
*          TIME OF ERROR CAN BE EXAMINED                                70969702
*        * RELEASE THE CMS AND LOCAL LOCKS                              70969802
*        * CONTINUE WITH TERMINATION                                    70969902
*                                                                       70970002
*        REGISTERS AT ENTRY -                                           70972002
*                                                                       70974002
*        REGISTER  1 - SDWA                                             70976002
*        REGISTER 14 - RETURN ADDRESS                                   70978002
*        REGISTER 15 - ENTRY ADDRESS                                    70978402
*                                                                       70978802
**********************************************************************  70980002
*                                                                       70990002
QTIPFRR  EQU   *                                                        70990402
         USING *,RBASE                  ROUTINE ADDRESSABLE             70990502
         LR    RBASE,R15                LOAD BASE REGISTER              70990802
         USING SDWA,RPARM               SDWA (RTCA) ADDRESSABLE         70994002
*                                                                       70994402
*   CALCULATE THE STORAGE OF TIOCRPT AND TSB TABLE TO DUMP              70994802
*                                                                       70995202
         L     R3,CVTPTR                GET CVT ADDRESS                 70996002
         USING CVT,R3                   CVT ADDRESSABLE                 70998002
         L     RRPT,CVTAQAVT            GET TCX ADDRESS                 70998402
         L     RRPT,TCXRPT-IEDQTCX(,RRPT)    GET TIOCRPT ADDRESS        70999202
         USING TIOCRPT,RRPT             TIOCRPT ADDRESSABLE             70999602
         SR    RWK10,RWK10              CLEAR WORK REGISTER             70999702
         IC    RWK10,TIOCTSBS           GET TSB SIZE                    70999802
         LH    RWK11,TIOCNTSB           GET NUMBER OF TSB'S             70999902
         MR    RWK10,RWK10              REG 11 HAS TSB TABLE SIZE       71049902
         BCTR  RWK11,R0                 1 LESS THAN TSB TABLE SIZE      71051902
         L     RWK10,TIOCTSB-E1         GET BEGINNING OF TSB TABLE      71059902
         LA    RWK10,E0(,RWK10)         CLEAR HIGH ORDER BYTE           71061902
         AR    RWK10,RWK11              GET ENDING ADDRESS OF TSB TABLE 71069902
*                                                                       71070002
*   SET UP THE LIST FOR RTM TO TAKE A SNAP DUMP                         71070102
*                                                                       71070202
         MVC   SDWAVLST(ENDLIST-SNAPLIST),SNAPLIST   MOVE LIST TO WA    71072302
         LA    RWK11,STARTADD           GET ADDR OF SNAP SHOT LIST      71075202
         ST    RWK11,SNAPSHOT           PUT IT IN WORK AREA             71077302
         ST    RRPT,STARTADD            RPT IS THE STARTING ADDRESS     71079402
         O     RWK10,HIGHON             LAST PARM INDICATOR             71081502
         ST    RWK10,ENDADD             END OF TSB TABLE IS ENDING ADDR 71083602
         LR    RWK9,RLINK               SAVE RETURN ADDRESS TO RTM      71085702
         SPACE 1                                                        71087802
         SETRP DUMP=YES,DUMPOPT=SDWAVLST,RECORD=YES,RECPARM=IDLIST,    X71089902
               RC=0,FRELOCK=(CMS,LOCAL)                                 71091902
         SPACE 1                                                        71092302
         BR    RWK9                     GO BACK TO RTM                  71116302
         DROP  R3,RRPT                  DROP REGISTERS                  71127502
         SPACE 4                                                        71138702
SNAPLIST SNAP  STORAGE=(0,0),MF=L       LIST FORM FOR SNAP MACRO        71188702
ENDLIST  EQU   *                        END OF SNAP LIST                71238702
         SPACE 4                                                        71259902
*                                                                       71299902
*   CONSTANTS                                                           71400002
*                                                                       71600002
         DS    0F                       ALIGNMENT                       71800002
MSKPOSTO DC    AL1(TSBPOSTO,0,0,0)      TSB POST OUTSTANDING            72000002
MSKXMPST EQU   MSKPOSTO                 CROSS-MEMORY POST               72200002
MSKPRI   DC    AL1(PRIDESTQ,0,0,0)      TPOST PRIORITY                  72400002
HIGHON   DC    X'80000000'              USED TO SET HIGH ORDER BIT ON   72450002
IDLIST   DC    CL8'IEDAYQT'             MICROFICHE NAME                 72500002
         DC    CL8'IEDAYQT'             CSECT NAME                      72550002
         DC    CL8'IEDAYQT'             FRR ID                          72560002
PATCH    DC    9F'0'                    PATCH AREA                      72600002
         EJECT                                                          72800002
         IHAASCB                                                        72850002
         EJECT                                                          72900002
         IHAASXB                                                        72950002
         EJECT                                                          72960002
         TAVTD                                                          73000002
         EJECT                                                          73200002
         IKJTIOCB                                                       73400002
         EJECT                                                          73600002
CVT      DSECT                                                          73800002
         CVT                                                            74000002
         EJECT                                                          74200002
         IHAFRRS                                                        74250002
         EJECT                                                          74300002
         TPRIOR                                                         74400002
         EJECT                                                          74600002
         IHAPSA                                                         74650002
         EJECT                                                          74700002
         IKJRB                                                          74800002
         EJECT                                                          75000002
         TRECBD                                                         75200002
         EJECT                                                          75250002
         IHASDWA                                                        75300002
         SPACE 1                                                        75350002
SDWAVLST EQU   SDWAVRA                  USE FIRST PORTION OF    ZA00611 75360003
*                                       RECORDING AREA AS LIST FOR SNAP 75370002
SNAPSHOT EQU   SDWAVRA+16               ADDR OF SNAP-SHOT LIST  ZA00611 75380003
STARTADD EQU   SDWAVRA+20               BEGINNING ADDR FOR SNAP ZA00611 75390003
ENDADD   EQU   SDWAVRA+24               ENDING ADDRESS FOR SNAP ZA00611 75392003
         EJECT                                                          75400002
         IKJTCB                                                         75600002
         EJECT                                                          75800002
         TTCXD                                                          76000002
         EJECT                                                          76200002
         IKJTIOCP                                                       76400002
         EJECT                                                          76600002
         IKJTSB                                                         76800002
         EJECT                                                          77000002
         TTSID                                                          77200002
         EJECT                                                          77250002
         IHAWSAVT                                                       77300002
         END                                                            77400002
