QAA1     TITLE '''IEDQAA'' -- STARTMH SUBTASK, TCAM-TSO MIXED' @Y17XAMF 00003000
IEDQAA   CSECT                                                          00006000
**A-000000-999999                                              @X31X8M0 00010000
******************** MICROFICHE FLAGS *********************** SUPT CODE 00040000
**C862984                                                        Y01004 00080000
**A419000,430000,443000,447000,747000-XXXXXX,748000-XXXXXX       S99528 00160000
**A807000-XXXXXX                                                 S99528 00164000
**C694000                                                        S99528 00168000
**D687400-687460,708000-708300,710000-710500,714000-721000       S99528 00172000
**D753000-754000                                                 S99528 00176000
**A533500,897020-XXXXXX                                          S22029 00180000
**C427000,510000-510500,511000-511500,528000,618360,813000       S22029 00184000
**C824100,824500                                                 S22029 00188000
**D508000,531000,618030-618330,618390,816000,831000-860000       S22029 00192000
**A689000                                                        A44861 00196000
**C483000                                                        A44861 00202000
**A824000                                                         M6673 00202100
**A862000                                                        S21101 00202200
**C483000                                                         M6673 00202300
**C483000,839000                                                 A44907 00202400
**D841000                                                        A44907 00202500
**A858100                                                        A44907 00202600
**A441000,590070,618333,618400,630300,632000,687100,862980,      S22025 00202700
**A872200,926200                                                 S22025 00202800
**C556000,569000,610000,617000,632000,636000-644000,687000,      S22025 00202900
**C690000-691500,694000,697000-700000,706000,709000-710500,      S22025 00203000
**C714000-717000,721000,769000-775000                            S22025 00203100
**D578000-583000,662800-665000,718000-719000,725000-743000,      S22025 00203200
**D760000-766000,786000-787000,788000-805000,862500-862960,892000S22025 00203300
**A467000,680000,822000                                         SA52512 00203400
**C630600,872000                                                SA52512 00203500
**A872000                                                       SA56222 00203600
**C822000                                                       SA56222 00203700
**A868000,906000                                                SA54959 00203800
**C630600                                                       SA54959 00203900
**A565000,932000                                                SA52971 00204000
**C538000-541000                                                SA52971 00204100
**D543000-554000,562000-563000                                  SA52971 00204200
**C882000,887000-888000,895000,897520,902000                     A59509 00204300
**D886000,897580,897740                                          A59509 00204400
**A897940-897960                                                 A59509 00204500
**D862982,862994                                                SA59169 00204600
**A464000,642000,861000,863000,897200,936000                     S22024 00205000
**A467700-467900,758100-758800,807040-807880                     S22024 00205100
**C211000,710400,871000                                          S22024 00205200
**C824700                                                       SA61771 00205300
**A618354                                                       SA62383 00205400
**A467600,566000                                                SA60343 00205500
**747800,747880                                                 SA63640 00205600
**D747200,747240                                                SA63640 00205700
**A467000,907100                                                 Y05330 00205800
**C467000,565600,585000,590770,626000,674000,758000,807180,      Y05330 00205900
**C807450,807660,897600,906620                                   Y05330 00206000
**D451000-453000,453700-454000,459000-461000,508000,521000,      Y05330 00206100
**D526000,586000-588000,627000-628000,675000-677000,723000,      Y05330 00206200
**D750000,752000,807210-807240,807480-807510,811000,863500,      Y05330 00206300
**D897640,906640                                                 Y05330 00206400
**D683000-684000                                                 Y06330 00206500
*A807000                                                       @SA68025 00207000
*C807090                                                       @SA68025 00214000
*D807780-809000                                                @SA68025 00222000
**D537000-555000                                                SA66605 00230000
**A606000                                                       SA66605 00240000
**C693000,694000                                               @SA74025 00267000
**C704500,706000                                               @SA74025 00268000
**A776000                                                      @SA74025 00269000
**D868500                                                      @SA74879 00270000
*C618450                                                       @SA75454 00271000
*A868000                                                       @YA10671 00272000
*C867000                                                       @SA75471 00273000
**A507000                                                        X03039 00276000
**C009600,211600,453600,495000,512070-512910,909500            @Z30X8MJ 00279000
**C824800                                                      @ZA04049 00288000
*A565000                                                       @OS76313 00288600
*A467900,512770                                                @YA12287 00289200
*C512630                                                       @YA12287 00289800
*A906400,906520,912000                                         @OY12280 00290400
*A697000                                                       @OY12671 00291000
*A642000,912000                                                @OY13651 00291300
*C007000,009200,009600,011000,134000-135000                    @Y17XAMF 00291600
*A015000,027000,054000,068000,085000,096000,104000,118000      @Y17XAMF 00292200
*A133000,186000,189000,194000,411000,413000,427500,506000      @Y17XAMF 00292800
*A507400,908000,912000,912300,936600                           @Y17XAMF 00293400
*C876200-876400                                                @Y17XAMF 00293700
*A897100,897450                                                @OY15001 00293800
*A8718500,986400                                               @YA13265 00293900
*A889050                                                       @OZ24601 00294010
*A889055                                                       @OX14795 00294110
*A871900                                                       @OY15569 00294210
*A870950                                                       @OY18039 00294382
*********************************************************************** 00296910
         EJECT                                                          00297000
*********************************************************************** 00300000
*TITLE  'IEDQAA'  STARTMH SUBTASK FOR TCAM AND TSO MH'S        @Y17XAMF 00400000
*                                                                     * 00640000
*  MODULE NAME = IEDQAA                                               * 00740000
*                                                                     * 00880000
*  DESCRIPTIVE NAME= STARTMH SUBTASK                           @Y17XAMF 00900000
*                                                                     * 00920000
*  COPYRIGHT = 'NONE'                                                 * 00930000
*                                                                     * 00940000
*  STATUS = CHANGE LEVEL 10                                    @Y17XAMF 00950000
*                                                                     * 00960000
*FUNCTION -- THE STARTMH SUBTASK PERFORMS INITIALIZATION FUNC- @Y17XAMF 00980000
*   TIONS FOR A BUFFER BEFORE SENDING IT THROUGH A TCAM OR TSO MES-   * 01040000
*   SAGE HANDLER.  THE EXACT FUNCTIONS VARY, DEPENDING UPON WHETHER   * 01280000
*   THE MESSAGE SOURCE IA A SNA LU, WHETHER                    @Y17XAMF 01300000
*   THE BUFFER IS A HEADER OR A TEXT BUFFER, AND WHETHER IT IS TO BE  * 01320000
*   PROCESSED BY THE INCOMING OR OUTGOING SIDE OF THE MH.             * 01440000
*                                                              @Y17XAMF 01442000
*      IF THE MESSAGE SOURCE OR DESTINATION IS THE SSCP        @Y17XAMF 01444000
*   MINIMAL PROCESSING  IS PERFORMED; ENTRY IS MADE DIRECTLY TO@Y17XAMF 01446000
*   THE PROPER MH SUBGROUP.                                    @Y17XAMF 01448000
*                                                              @Y17XAMF 01450000
*      THE FOLLOWING PROCESSING IS PERFORMED EXCLUSIVELY FOR   @Y17XAMF 01452000
*   MESSAGES INPUT FROM SNA LU'S:                              @Y17XAMF 01454000
*                                                              @Y17XAMF 01456000
*      -'RESPONSE REQUIRED' IS SET ON FOC(FIRST OF CHAIN):     @Y17XAMF 01458000
*        LCBRESP IS SET;                                       @Y17XAMF 01460000
*                                                              @Y17XAMF 01462000
*      - DEFAULT ROUTING IS ESTABLISHED: FOR LU*S IN SESSION   @Y17XAMF 01464000
*        WITH A TPROCESS ENTRY HAVING LU=YES MESSAGES WILL     @Y17XAMF 01466000
*        BE SENT THE TPROCESS QUEUE IF NO FORWARD IS ISSUED;   @Y17XAMF 01468000
*                                                              @Y17XAMF 01470000
*      - DFC COMMAND COMPATIBILITY MODE CHECKS ARE MADE TO     @Y17XAMF 01472000
*        SCREEN OUT COMMANDS NOT SUPPORTED BY THE MH;          @Y17XAMF 01474000
*                                                              @Y17XAMF 01476000
*      - IF CANCEL IS NOT SUPPORTED IN THE MH THE CANCEL       @Y17XAMF 01478000
*        RU IS HANDLED BY THE CHAIN MANAGER IN IEDRQIN         @Y17XAMF 01480000
*                                                              @Y17XAMF 01482000
*      THIS ROUTINE CHECKS FOR A RECALLED BUFFER. IF IT IS RE- @Y17XAMF 01484000
*   CALLED, NO INITIALIZATION FUNCTIONS ARE PERFORMED, AND ONLY THE   * 01503000
*   CHECK FOR TRANSLATION IS MADE.  IF THE BUFFER IS OUTGOING, AND    * 01760000
*   THE DESTINATION TERMINAL IS IN LOCK MODE, THE LCB COUNT OF OUT-   * 01840000
*   STANDING LOCK RESPONSES IS INCREMENTED, AND THE PREFIX LOCK BIT   * 01920000
*   IS SET OFF.  IF THE BUFFER, INCOMING OR OUTGOING, IS A TSO BUFFER,* 02080000
*   THE LCB RESERVE COUNT IS INITIALIZED TO ZERO.  THEN THIS ROUTINE  * 02160000
*   CHECKS TO SEE IF THE BUFFER IS HEADER OR TEXT.  FOR ALL HEADER    * 02240000
*   BUFFERS, THE SCB MULTIPLE BUFFER HEADER ENTRY IS SET TO ZERO.     * 02320000
*   NEXT, THIS ROUTINE CHECKS TO SEE IF THE BUFFER IS TO BE PROCESSED * 02480000
*   BY AN INCOMING OR OUTGOING MH.  PROCESSING IS THEN TAILORED FOR   * 02560000
*   EACH OF THE FOUR SITUATIONS.                                      * 02640000
*                                                              @Y17XAMF 02680000
*      FOR AN INCOMING HEADER BUFFER, THE PREFIX SOURCE FIELD IS      * 02720000
*   INITIALIZED FROM THE CURRENT TERMINAL INDEX IN THE LCB, AND THE   * 02880000
*   SCB PRIORITY AND CUTOFF COUNT ARE SET TO ZERO.  IF IT IS A TSO    * 02960000
*   BUFFER, THIS ROUTINE BRANCHES TO THE EXIT ROUTINE.  IF NOT, THE   * 03040000
*   PREFIX SCAN POINTER IS SET TO POINT TO THE LAST BYTE OF THE PRE-  * 03120000
*   FIX, OR TO THE LAST RESERVE CHARACTER, IF SPECIFIED.  IF THE      * 03280000
*   MESSAGE SOURCE WAS AN APPLICATION PROGRAM, THIS ROUTINE NOW       * 03360000
*   BRANCHES TO THE EXIT ROUTINE.  OTHERWISE, IT CHECKS TO SEE IF AN  * 03440000
*   EOA SEQUENCE WAS DEFINED IN THE SPECIAL CHARACTERS TABLE.  IF IT  * 03520000
*   WAS, IT LINKS TO THE SKIP FORWARD AND SCAN ROUTINE TO SEE IF THE  * 03680000
*   EOA SEQUENCE IS IN THE BUFFER.  IF IT IS, THE SCAN POINTER IS SET * 03760000
*   TO POINT BEYOND IT.  FOR 1030'S AND REMOTE 2260'S, THE SCAN       * 03840000
*   POINTER IS ALSO MOVED BEYOND THE ADDRESSING CHARACTER, WHICH FOL- * 03920000
*   LOWS THE EOA SEQUENCE FOR THESE DEVICES.  AT THIS POINT, IF THE   * 04080000
*   TERMINAL IS IN LOCK MODE, THIS ROUTINE BRANCHES TO THE EXIT ROU-  * 04160000
*   TINE.  OTHERWISE, THIS ROUTINE CHECKS TO SEE IF THE BUFFER CON-   * 04240000
*   TAINS AN ON-LINE TEST MESSAGE.  FOR BINARY SYNCHRONOUS LINES, A   * 04320000
*   BIT IN THE LCB IS CHECKED; FOR START/STOP LINES, THIS ROUTINE     * 04480000
*   LINKS TO THE SKIP FORWARD AND SCAN ROUTINE TO SEE IF AN ON-LINE   * 04560000
*   TEST SEQUENCE IS IN THE BUFFER.  IF THE BUFFER CONTAINS AN ON-    * 04640000
*   LINE TEST MESSAGE, BUT ON-LINE TEST IS NOT IN THE SYSTEM, THIS    * 04720000
*   ROUTINE SETS A BIT IN THE ERROR WORD AND BRANCHES TO THE EXIT     * 04880000
*   ROUTINE.  IF ON-LINE TEST IS IN THE SYSTEM, THIS ROUTINE SETS ON- * 04960000
*   LINE TEST PRIORITY IN THE BUFFER PREFIX AND EXITS TO THE DIS-     * 05040000
*   PATCHER POST FUNCTION TO POST THE BUFFER TO THE ON-LINE TEST QCB. * 05120000
*   IF THE BUFFER DOES NOT CONTAIN AN ON-LINE TEST MESSAGE, THIS      * 05280000
*   ROUTINE BRANCHES TO THE EXIT ROUTINE.                             * 05360000
*                                                              @Y17XAMF 05400000
*      FOR AN INCOMING TEXT BUFFER, THE PREFIX SOURCE FIELD IS INI-   * 05440000
*   TIALIZED AS FOR AN INCOMING HEADER BUFFER.  IF THE MH TO RECEIVE  * 05520000
*   THE BUFFER IS A TSO MH, THIS ROUTINE CHECKS TO SEE IF THE DES-    * 05680000
*   TINATION IS THE TSINPUT QCB.  IF IT IS, THIS ROUTINE BRANCHES     * 05760000
*   TO THE ROUTINE TO CHECK FOR TRANSLATION.  IF IT IS NOT, THIS      * 05840000
*   ROUTINE CHECKS FOR A LOGON EXIT.  IF A LOGON EXIT IS NOT PRESENT, * 05920000
*   IT ALSO BRANCHES TO THE TRANSLATION CHECK.  IF A LOGON EXIT IS    * 06080000
*   PRESENT, A NEW QCB AND MH ARE ESTABLISHED, AND THIS ROUTINE       * 06160000
*   BRANCHES TO THE NEW MH.  IF THE MH TO RECEIVE THE BUFFER IS NOT A * 06240000
*   TSO MH, THE LCB RESERVE COUNT IS INITIALIZED FROM THE COUNT       * 06320000
*   SPECIFIED IN THE DCB, AND THE SCAN POINTER IS SET TO POINT TO THE * 06480000
*   LAST BYTE OF THE TEXT PREFIX, OR TO THE LAST RESERVE CHARACTER,   * 06560000
*   IF SPECIFIED.  THEN THIS ROUTINE BRANCHES TO THE TRANSLATION      * 06640000
*   CHECK.                                                            * 06720000
*                                                              @Y17XAMF 06800000
*      FOR AN OUTGOING HEADER BUFFER, AN IMMEDIATE BRANCH TO THE EXIT * 06880000
*   ROUTINE IS TAKEN IF IT IS A TSO BUFFER.  OTHERWISE, A CHECK IS    * 06960000
*   MADE FOR A LOGON EXIT.  IF ONE IS PRESENT, THIS ROUTINE SETS UP   * 07040000
*   AND BRANCHES TO THE NEW MH, AS DESCRIBED ABOVE.  IF NO LOGON EXIT * 07120000
*   IS PRESENT, THIS ROUTINE PERFORMS FEFO UPDATING.  NORMALLY, THE   * 07280000
*   FEFO POINTER IN THE DESTINATION (PRIORITY) QCB IS UPDATED FROM    * 07360000
*   THE SCB FEFO POINTER, AND THE 'CURRENTLY SENDING' FLAG IN THE     * 07440000
*   MASTER QCB IS SET OFF.  HOWEVER, THERE ARE THREE SITUATIONS IN    * 07520000
*   WHICH THIS IS NOT DONE: (1) IF THE DESTINATION TERMINAL IS IN     * 07680000
*   LOCK MODE WITH AN APPLICATION PROGRAM, NO FEFO UPDATING CAN TAKE  * 07760000
*   PLACE UNTIL IT IS UNLOCKED.  (2) IF THE LINE IS IN INITIATE MODE, * 07840000
*   NO FEFO UPDATING CAN TAKE PLACE UNTIL THE LAST BUFFER OF THE INI- * 07920000
*   TIATE MESSAGE HAS BEEN PROCESSED THROUGH THE MH.  (3) IF A TEXT   * 08080000
*   TRANSFER ERROR GENERATED A ZERO LENGTH BUFFER, NO FEFO UPDATING   * 08160000
*   TAKES PLACE BECAUSE THE BUFFER WILL NOT BE SENT TO THE DESTINA-   * 08240000
*   TION.  IF THE DESTINATION TERMINAL IS IN BOTH LOCK AND EXTENDED   * 08320000
*   LOCK MODE, BOTH LOCK BITS IN THE SCB ARE SET OFF.                 * 08480000
*                                                              @Y17XAMF 08500000
*      AFTER ANY FEFO UPDATING IS COMPLETE, THE LCB RESERVE COUNT IS  * 08520000
*   SET TO ZERO FOR ZERO LENGTH BUFFERS, OR TO THE VALUE IN THE SCAN  * 08640000
*   POINTER FOR NON-ZERO LENGTH BUFFERS.  THE SCAN POINTER IS THEN    * 08720000
*   SET TO POINT TO THE LAST BYTE OF THE HEADER PREFIX, OR TO THE     * 08880000
*   LAST RESERVE CHARACTER, IF SPECIFIED.  IN ADDITION, FOR NON-ZERO  * 08960000
*   LENGTH BUFFERS, THIS ROUTINE LINKS TO THE TERMNAME TABLE CODE TO  * 09040000
*   GET THE TERMINAL ENTRY, SAVES THE CURRENT OUTPUT SEQUENCE NUMBER  * 09120000
*   IN THE SCB, AND INCREMENTS THE OUTPUT SEQUENCE NUMBER IN THE      * 09280000
*   TERMINAL ENTRY.  IF THE MAXIMUM OUTPUT SEQUENCE NUMBER IS EX-     * 09360000
*   CEEDED, IT IS RESET TO ONE.  FINALLY, THIS ROUTINE BRANCHES TO    * 09440000
*   THE EXIT ROUTINE.                                                 * 09520000
*                                                              @Y17XAMF 09600000
*      FOR AN OUTGOING TEXT BUFFER, AN IMMEDIATE BRANCH TO THE TRANS- * 09680000
*   LATION CHECK IS TAKEN IF IT IS A TSO BUFFER.  OTHERWISE A CHECK   * 09760000
*   IS MADE FOR A LOGON EXIT.  IF ONE IS PRESENT, THIS ROUTINE SETS   * 09840000
*   UP AND BRANCHES TO THE NEW MH, AS DESCRIBED ABOVE.  IF NO LOGON   * 09920000
*   EXIT IS PRESENT, THIS ROUTINE INITIALIZES THE LCB RESERVE COUNT   * 10080000
*   TO ZERO, SETS THE SCAN POINTER TO POINT TO THE LAST BYTE OF THE   * 10160000
*   TEXT PREFIX, AND BRANCHES TO THE TRANSLATION CHECK, WHICH IS DE-  * 10240000
*   SCRIBED NEXT.                                                     * 10320000
*                                                              @Y17XAMF 10400000
*      THE TSO STARTMH SUBTASK HANDLES BUFFER TRANSLATION FOR THE     * 10480000
*   FOLLOWING TYPES OF BUFFERS: (1) INCOMING TEXT BUFFERS DIRECTED TO * 10560000
*   A NON-TSO MH, (2) INCOMING TEXT BUFFERS DIRECTED TO A TSO MH WITH-* 10640000
*   OUT A LOGON EXIT, (3) OUTGOING TCAM (NON-TSO) HEADER BUFFERS, AND * 10720000
*   (4) ALL RECALLED BUFFERS.  THE TRANSLATION CHECK FIRST CHECKS FOR * 10880000
*   A ZERO LENGTH BUFFER.  A ZERO LENGTH BUFFER IS NOT TRANSLATED.    * 10960000
*   NEXT IT CHECKS THE SCB TO SEE IF TRANSLATION WAS REQUESTED.  IF   * 11040000
*   NOT, THE BUFFER IS NOT TRANSLATED.  IF IT WAS, THIS ROUTINE LINKS * 11120000
*   TO THE TRANSLATE BUFFER ROUTINE, VIA THE USER INTERFACE, TO TRANS-* 11280000
*   LATE THE BUFFER.  IF THE SCB MULTIPLE BUFFER HEADER ENTRY IS ZERO,* 11360000
*   THIS ROUTINE BRANCHES TO THE EXIT ROUTINE.  IF NOT, THE PRESENCE  * 11440000
*   OF A MULTIPLE BUFFER HEADER IS INDICATED BY SETTING A NEGATIVE    * 11520000
*   VALUE IN REGISTER 0, AND THE ADDRESS OF THE USER INTERFACE IS     * 11680000
*   LOADED INTO REGISTER 15, BEFORE BRANCHING TO THE EXIT ROUTINE.    * 11760000
*                                                              @Y17XAMF 11800000
*      THE EXIT ROUTINE OF THIS SUBTASK GETS THE ADDRESS OF THE FIRST * 11840000
*   INSTRUCTION IN THE MH AND SETS AN INCREMENT OF 4096 IN REGISTER 2 * 11920000
*   FOR MULTIPLE BASE REGISTER SUPPORT.  IF A MULTIPLE BUFFER HEADER  * 12080000
*   IS PRESENT, A CONDITION CODE OF 4 IS SET IN THE PSW.  OTHERWISE,  * 12160000
*   A CONDITION CODE OF EITHER 1 OR 8 IS SET IN THE PSW, DEPENDING ON * 12240000
*   WHETHER THE LINE IS SENDING OR RECEIVING, RESPECTIVELY.  THESE    * 12320000
*   CONDITION CODES WILL BE TESTED BY THE CODE GENERATED BY THE       * 12480000
*   STARTMH MACRO INSTRUCTION.  FINALLY, THIS ROUTINE EXITS TO THE    * 12560000
*   FIRST EXECUTABLE INSTRUCTION OF THE MH.                           * 12640000
*                                                                     * 12720000
*ENTRY POINT -- IEDQAA01 - TO PERFORM INITIALIZATION FOR A BUFFER     * 12880000
*   BEFORE SENDING IT THROUGH A TCAM OR TSO MESSAGE HANDLER           * 12960000
*   CALLING SEQUENCE          L    R15,STCBLINK-1                     * 13040000
*                             BR   R15                                * 13120000
*                                                                     * 13280000
*INPUT -- IEDQAA IS CALLED BY THE DISPATCHER WHEN A BUFFER     @Y17XAMF 13290000
*   IS TPOSTED TO THE STARTMH QCB.                             @Y17XAMF 13300000
*   AT ENTRY, THE FOLLOWING REGISTERS ARE SET.                        * 13320000
*   R1 HAS THE BUFFER ADDRESS, WHICH THIS ROUTINE SAVES IN THE AVT    * 13680000
*   R7 HAS THE ADDRESS OF THE STARTMH QCB                             * 13760000
*   R11 HAS THE DISPATCHER ADDRESS                                    * 13840000
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   * 13920000
*   R15 HAS THE ENTRY POINT ADDRESS                                   * 14080000
*                                                                     * 14160000
*OUTPUT -- ON LINKING TO THE SKIP FORWARD AND SCAN ROUTINE (IEDQAI),  * 14240000
*   VIA THE USER INTERFACE, THE FOLLOWING REGISTERS ARE SET.          * 14320000
*   R1 HAS THE ADDRESS OF THE PARAMETER LIST, WHICH INCLUDES THE OFF- * 14480000
*   SET OF THE EOA SEQUENCE OR ON-LINE TEST SEQUENCE IN THE SPECIAL   * 14560000
*   CHARACTERS TABLE.                                                 * 14640000
*   R8 HAS THE ADDRESS OF THE SPECIAL CHARACTERS TABLE                * 14720000
*   R14 HAS THE RETURN ADDRESS IN IEDAYR                              * 14880000
*   R15 HAS THE ENTRY POINT ADDRESS IN IEDQUI                         * 14960000
*                                                                     * 15040000
*   ON LINKING TO THE TRANSLATE BUFFER ROUTINE (IEDQAW), VIA THE USER * 15120000
*   INTERFACE, THE FOLLOWING REGISTERS ARE SET.                       * 15280000
*   R1 HAS THE ADDRESS OF THE TRANSLATE PARAMETER LIST FROM THE SCB   * 15360000
*   R14 HAS THE RETURN ADDRESS IN IEDQAA                       @Y17XAMF 15440000
*   R15 HAS THE ENTRY POINT ADDRESS IN IEDQUI                         * 15520000
*                                                                     * 15680000
*   ON EXIT TO THE DISPATCHER POST FUNCTION, THE ELEMENT KEY IN THE   * 15760000
*   PREFIX IS SET TO INDICATE EITHER A BISYNC OR A START/STOP LINE,   * 15840000
*   THE DESTINATION QCB FIELD IN THE SCB CONTAINS THE ADDRESS OF THE  * 15920000
*   ON-LINE TEST QCB, THE LINE STATUS IS SET TO STOPPED, AND REGISTER * 16080000
*   1 CONTAINS THE ADDRESS OF THE BUFFER TO BE POSTED.                * 16160000
*                                                                     * 16240000
*   ON EXIT TO AN MH SPECIFIED AS A LOGON EXIT, THE FOLLOWING REGIS-  * 16320000
*   TERS ARE SET.                                                     * 16480000
*   R3 HAS THE SCB ADDRESS                                            * 16560000
*   R4 HAS THE LCB ADDRESS                                            * 16640000
*   R6 HAS THE BUFFER ADDRESS                                         * 16720000
*   R7 HAS THE ADDRESS OF THE NEW QCB                                 * 16880000
*   R15 HAS THE ENTRY POINT ADDRESS IN THE NEW MH                     * 16960000
*                                                                     * 17040000
*   ON EXIT TO THE MH TO PROCESS THE BUFFER, A CONDITION CODE OF 1,   * 17120000
*   4, OR 8 IS SET IN THE PSW, AND THE FOLLOWING REGISTERS ARE SET.   * 17280000
*   R0 HAS A NEGATIVE VALUE, IF A MULTIPLE BUFFER HEADER IS PRESENT,  * 17360000
*   OR ZERO                                                           * 17440000
*   R2 HAS AN INCREMENT OF 4096                                       * 17520000
*   R3 HAS THE SCB ADDRESS                                            * 17680000
*   R4 HAS THE LCB ADDRESS                                            * 17760000
*   R6 HAS THE BUFFER ADDRESS                                         * 17840000
*   R12 HAS THE ENTRY POINT ADDRESS IN THE MH                         * 17920000
*                                                                     * 18080000
*EXTERNAL ROUTINES -- IEDQAI - TO SCAN FOR AN EOA SEQUENCE OR ON-LINE * 18160000
*   TEST SEQUENCE IN THE BUFFER                                       * 18240000
*   IEDQTNT - TO GET THE TERMINAL ENTRY FOR THE DESTINATION OF AN     * 18320000
*   OUTGOING HEADER BUFFER                                            * 18480000
*   IEDQAW - TO TRANSLATE THE BUFFER                                  * 18560000
*                                                                     * 18640000
*EXITS-NORMAL -- TO THE MH SPECIFIED IN THE STARTMH QCB               * 18720000
*   TO THE MH SPECIFIED AS THE LOGON EXIT IN THE STARTMH QCB          * 18880000
*   TO THE DISPATCHER POST FUNCTION                                   * 18890000
*   TO THE SSCP MH.                                            @Y17XAMF 18900000
*                                                                     * 18920000
*EXITS-ERROR -- NONE                                                  * 19120000
*                                                                     * 19280000
*TABLES/WORKAREAS -- AVT, LCB, SCB, DCB, DEB, UCB, QCB, BUFFER PREFIX,* 19360000
*   TERMINAL ENTRY, SCT, TPRIOR, ERB, SIB, TSNSD               @Y17XAMF 19400000
*                                                                     * 19440000
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, ENABLED, RESIDENT,     * 19680000
*   PROBLEM PROGRAM MODE.                                             * 19760000
*                                                                     * 19840000
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 19920000
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET. * 20080000
*                                                                     * 20160000
*********************************************************************** 20240000
         EJECT                                                          20320000
********* REGISTER EQUATES *********                                    40640000
         SPACE                                                          40720000
R0       EQU   0                        WORK REGISTER                   40880000
         SPACE                                                          40960000
R1       EQU   1                        PARAMETER LIST                  41040000
RTRM     EQU   1                        TTE ADDRESS            @Y17XAMF 41080000
         SPACE                                                          41120000
RWORK2   EQU   2                        WORK REGISTER                   41280000
RPREF    EQU   2                        NEG HEADER PREFIX ADDR @Y17XAMF 41300000
         SPACE                                                          41320000
RSCB     EQU   3                        SCB ADDRESS                     41440000
         SPACE                                                          41520000
RLCB     EQU   4                        LCB ADDRESS                     41680000
         SPACE                                                          41760000
RUCB5    EQU   5                        ADDRESS OF UCB                  41840000
RWORK5   EQU   5                        WORK REGISTER            S99528 41920000
         SPACE                                                          42000000
RPREFIX  EQU   6                        BUFFER ADDRESS                  42080000
         SPACE                                                          42160000
RQCB7    EQU   7                        ADDRESS OF STARTMH QCB          42240000
         SPACE                                                          42320000
RSCT8    EQU   8                        SPECIAL CHARS TABLE ADDRESS     42480000
RSAVT    EQU   8                        SAVT ADDRESS                    42500000
         SPACE                                                          42520000
R9       EQU   9                        WORK REGISTER               TSO 42640000
RTQCB    EQU   9                        ADDR. OF TERMINAL'S QCB. S22029 42720000
RSIB     EQU   9                        SIB ADDRESS            @Y17XAMF 42740000
         SPACE                                                          42760000
RRET10   EQU   10                       F.E. RETURN REGISTER            42880000
RDCB     EQU   10                       DCB ADDRESS                     42960000
RERB     EQU   10                       ERB ADDRESS              S99528 43040000
         SPACE                                                          43080000
RDISP    EQU   11                       DISPATCHER ADDRESS              43120000
         SPACE                                                          43280000
RBASE    EQU   12                       BASE OF ROUTINE                 43360000
         SPACE                                                          43440000
R13      EQU   13                       SAVE AREA                       43520000
         SPACE                                                          43680000
R14      EQU   14                       RETURN ADDRESS                  43760000
         SPACE                                                          43840000
R15      EQU   15                       ENTRY POINT                     43920000
         SPACE                                                          44080000
RAVT     EQU   9                                                 S22025 44120000
********* OTHER EQUATES *********                                       44160000
         SPACE                                                          44240000
ZERO     EQU   0                        CONSTANT DISPLACEMENT    S99528 44320000
ONE      EQU   1                        BYTE OFFSET                     44400000
TWO      EQU   2                        MOVE LENGTH FOR AN OFFSET       44480000
THREE    EQU   3                        MOVE LENGTH FOR AN ADDRESS      44560000
FOUR     EQU   4                        WORK OFFSET                     44640000
FIVE     EQU   5                        CONSTANT DISPLACEMENT    S99528 44720000
CVTOFF   EQU   16                       OFFSET TO CVT            S22025 44740000
         SPACE                                                          44760000
SCTEOA   EQU   1                        OFFSET TO EOA OFFSET            44880000
SCTOLT   EQU   13                       OFFSET TO OLT OFFSET            44960000
BSOLTLEN EQU   2                        LNG OF BISYNC OLT STRING        45040000
SSTOTLEN EQU   14                       OFFSET TO OLT STRING   @Z30X8MJ 45360000
POSTPEND EQU   X'D0'                    POST PENDING FLAGS              45440000
         SPACE                                                          45520000
PARMLEN  EQU   8                        LENGTH OF STARTMH PARM LIST     45680000
         SPACE                                                          45760000
TPDEVICE EQU   X'40'                    DEVICE CLASS = TP               45840000
IBM1030  EQU   X'21'                    DEVICE TYPE = IBM 1030          46240000
IBM2260R EQU   X'81'                    DEVICE TYPE = IBM 2260R         46320000
LGB      EQU   X'80'                    LINE GROUP BLOCK - 3705  S22024 46400000
         SPACE                                                          46480000
LMDSTCB  EQU   X'0A'                    LMD FLAG                 S22025 46520000
         SPACE                                                          46560000
MINUS    EQU   4                        CONDITION CODE: NEGATIVE        46600000
HLF      EQU   3                        MASK FOR ICM HALF WORD   Y05330 46640000
AD       EQU   7                        MASK FOR ICM/STCM ADDRESSY05330 46680000
SEVEN    EQU   7                        CONDITION CODE          SA52512 46720000
ALL      EQU   15                       MASK FOR ICM/STCM      @Y17XAMF 46727000
SCTEOT   EQU   20                       EOT INDEX OFFSET IN SCT SA52512 46734000
LASTNOFF EQU   X'04'                    FLAG SET BY RP WHEN     SA60343 46762000
*                                       SETTING A ZARO FEFO PRT SA60343 46765000
RNKEY    EQU   X'14'                    PRFKEY SETTING FOR TOTE  S22024 46769000
*                                         INDICATING MULTIPLE    S22024 46776000
*                                         BUFFER FROM 3705       S22024 46783000
C3270    EQU   X'04'                    3270 TERMINAL          @YA12287 49783000
CNOIDLES EQU   X'02'                    2260 TERMINAL          @YA12287 52783000
CLOCAL   EQU   X'02'                    LOCAL TERMINAL         @YA12287 55783000
CSWST1   EQU   3                        OFFSET TO CSW STATUS   @OY12280 86740000
ADDR     EQU   7                        MASK FOR STCM AND ICM  @Y17XAMF 86745000
UNEX     EQU   X'01'                    MASK FOR UNIT EXCEPTION@OY12280 86750000
STMHTSFG EQU   X'01'                    INDICATES TSO MH       @YM09043 86752000
         EJECT                                                          86755000
         DC    AL1(DSPMCPL2)            STCB                            86760000
         DC    AL1(0)                                                   86765000
         SPACE                                                          86770000
         USING IEDQAA01,R15                                             86775000
         USING AVTSAVE2,R13                                             86780000
         SPACE                                                          86785000
IEDQAA01 EQU   *                                                        86790000
IEDQAA   IEDHJN STARTMH .               MODULE ID AND DATE       S22025 86795000
         TM    AVTAFE30,AVTEFF          IS DUMP REQUESTED               86800000
         BZ    SETBASE                  NO, GO SET NEW BASE             86805000
         SPACE                                                          86810000
         L     RWORK2,AVTAFE30          YES, GET ROUTINE ADDRESS        86815000
         BALR  RRET10,RWORK2            LINK TO IT                      86820000
         SPACE                                                          86825000
SETBASE  EQU   *                                                        86830000
         DROP  R15                                                      86835000
         LR    RBASE,R15                GET MODULE BASE ADDR   @Z30X8MJ 86840000
         USING IEDQAA01,RBASE                                           86845000
         ST    R1,AVTADBUF              SET BUFFER ADDRESS              86850000
         LR    RPREFIX,R1               SAVE BUFFER ADDRESS             86855000
         USING IEDQPRF,RPREFIX                                          86860000
         L     RLCB,PRFLCB-1            LCB ADDRESS                     86865000
         USING IEDQLCB,RLCB             ESTABLISH ADDRESSABILITY        86870000
         L     RSCB,LCBSCBA-1           SCB ADDRESS                     86875000
         USING IEDQSCB,RSCB             ESTABLISH ADDRESSABILITY        86880000
         L     RDCB,LCBDCBPT            GET DCB ADDRESS FROM LCB        86885000
         USING IHADCB,RDCB                                              86890000
         USING IEDQDISP,RDISP                                  @Y17XAMF 86895000
         SPACE                                                          86900000
         LR    RPREF,RPREFIX            GET ADDRESSABILITY     @Y17XAMF 86905000
         SH    RPREF,PREFIX             TO NEGATIVE PREFIX     @Y17XAMF 86910000
         USING IEDPF1,RPREF                                    @Y17XAMF 86915000
         TM    STMHFLG0-STMHUBXT(RQCB7),STMHTSFG TSO MH?       @YM09043 86915200
         BZ    NOTSMH                   BRANCH IF NOT          @YM09043 86915400
         TM    LCBSTAT1,LCBRECVN        LINE RECEIVING         @YM09043 86915600
         BZ    NOTSMH                   NO, BRANCH             @YM09043 86915800
         LH    R1,LCBTTCIN              GET SOURCE TERM INDEX  @YM09043 86916000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF  @YM09043 86916200
         BZ    NOTSMH                   BRANCH IF ZERO INDEX   @YM09043 86916400
         L     R15,AVTRNMPT             TERMNAME CODE ADDRESS  @YM09043 86916600
         BALR  R14,R15                  GET TERM ENTRY ADDRESS @YM09043 86916800
         L     R1,TRMDESTQ-1-IEDQTRM(R1) GET QCB ADDRESS       @YM09043 86917000
         TM    QCBTSOF1-IEDQQCB(R1),QCBDELAY QCB ON TIME DELAY @YM09043 86917200
         BZ    NOTSMH                   NO, SKIP REMOVAL       @YM09043 86917400
         L     R15,AVTHG02              TIME DELAY REMOVAL     @YM09043 86917600
         BALR  R14,R15                  LINK TO REMOVE QCB     @YM09043 86917800
         TM    QCBFLAG-IEDQQCB(R1),QCBTSSES TSO SESSION?       @YM09043 86918200
         BO    NOTSMH                   BRANCH IF YES          @YM09043 86918400
         XC    QCBLKRRN-IEDQQCB(,R1),QCBLKRRN-IEDQQCB(R1)      @YM09043 86918600
*                                        CLEAR CARCT AND TJID  @YM09043 86918800
         MVC   QCBSLINK-IEDQQCB(THREE,R1),QCBSTCHN-IEDQQCB(R1) @YM09100 86919000
*                                        RESET SCHEDULER LINK  @YM09100 86919200
         LA    R14,QCBSTVTO-IEDQQCB(,R1) SEND SCHED VTO ADDR   @YM09100 86919400
         STCM  R14,AD,QCBSTCHN-IEDQQCB(R1) RESET SCHEDULER     @YM09100 86919600
NOTSMH   EQU   *                                               @YM09043 86919800
         CLI   LCBFLAG1,LCBPLCB         IS THIS A PLCB         @Y17XAMF 86920000
         BNE   CHKSEND                  BRANCH IF NO           @Y17XAMF 86925000
         STCM  RPREFIX,AD,LCBLSPCI      SET LCBLSPCI BUFFER    @YM08547 86927000
         TM    LCBSTAT5,LCBLUNIT        SNA RESOURCE           @Y17XAMF 86930000
         BZ    CLRPRFX                  BRANCH IF NO           @Y17XAMF 86935000
         L     RSAVT,AVTSAVTP           GET SAVT ADDR          @Y17XAMF 86940000
         USING IEDNSVTD,RSAVT                                  @Y17XAMF 86945000
         BAL   R14,PROCSSCP             PROCESS SSCP LOGIC     @Y17XAMF 86950000
         LTR   R15,R15                  SSCP SESSION           @Y17XAMF 86955000
         BNZ   EXIT                     BRANCH IF YES          @Y17XAMF 86960000
         BAL   R14,PROCSNA              PROCESS SNA LOGIC      @Y17XAMF 86965000
         LTR   R15,R15                  POST REQURIED          @Y17XAMF 86970000
         BZ    CHKSEND                  BRANCH IF NO           @Y17XAMF 86975000
         LR    R1,RPREFIX               SET POST REG           @Y17XAMF 86980000
         BAL   R14,DSPPOST              EXIT TO POST           @Y17XAMF 86985000
         EJECT                                                          86990000
CLRPRFX  EQU   *                                                        86995000
         TM    LCBSTAT1,LCBSENDN        SENDING                @Y17XAMF 87000000
         BZ    TSCHK                    BRANCH IF NO           @Y17XAMF 87005000
         CLI   PRFPRI,PRIMHBFR-1        ERROR BUFFER           @Y17XAMF 87010000
         BE    TSOCHK                   BRANCH IF YES          @Y17XAMF 87015000
         XC    PRF1RH(PRF1LEN),PRF1RH   CLEAR TOTAL PREFIX     @Y17XAMF 87020000
         DROP  RSAVT                                           @Y17XAMF 87025000
         DROP  RPREF                                           @Y17XAMF 87030000
CHKSEND  EQU   *                                               @Y17XAMF 87035000
         TM    LCBSTATE,LCBSENDN        SEND OPERATION           S22029 87040000
         BZ    TSCHK                    NO BRANCH                S22029 87045000
TSOCHK   EQU   *                                               @Y17XAMF 87050000
         L     R15,SCBDESTQ-1           GET DEST QCB ADDRESS     S22029 87055000
         TM    QCBFLAG-IEDQQCB(R15),QCBPROC IS THIS A PROCESS ENTS22029 87060000
         BO    TSO1                     YES, BRANCH              S22029 87065000
TSCHK    EQU   *                                                 S22029 87070000
         SR    R15,R15                  CLEAR REGISTER           S22029 87075000
         TM    LCBTSOB,LCBTSBUF         IS A TIME-SHARING        S22029 87080000
*                                       TERMINAL ON THIS LINE    S22029 87085000
         BZ    TSO1                     NO. CONTINUE MH FLOW     S22029 87090000
         OI    PRFSTAT1,PRFTSMSG        FLAG TIME-SHARING MSG    S22029 87095000
         SR    RWORK2,RWORK2            CLEAR SCAN REGISTER    @OY18039 87095682
         LA    RWORK2,AVTTXTSZ(,RWORK2) REGISTER               @OY18039 87096282
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER          @OY18039 87096882
         BO    TEXTUNIT                 BRANCH TEXT BUFFER     @OY18039 87097482
         LA    RWORK2,AVTHDRSZ-AVTTXTSZ(,RWORK2) INCREASE AGAIN@OY18039 87098082
TEXTUNIT EQU   *                                               @OY18039 87098682
         STH   RWORK2,PRFSCAN           SET SCAN POINTER       @OY18039 87099282
         SPACE                                                          87100000
         LH    R1,LCBTTCIN              GET TERMINAL OFFSET    @Z30X8MJ 87105000
         N     R1,AVTCLRHI              CLEAR HI-ORDER BYTE    @Z30X8MJ 87110000
         L     R15,AVTRNMPT             GET ADDR OF TNT ROUTINE@Z30X8MJ 87115000
         BALR  R14,R15                  BRANCH TO TNT LOOKUP   @Z30X8MJ 87120000
         USING IEDQTRM,R1               SET UP ADDRESSIBILITY  @Z30X8MJ 87125000
         TM    TRMSTATE,TRMPREF         IS THIS A 3705 TERMINAL@Z30X8MJ 87130000
         BNO   ERCHECK                  BRANCH NO              @YA12287 87135000
         TM    LCBSTATE,LCBSENDN        SEND OPERATION?        @Z30X8MJ 87140000
         BNO   TSO1                     NO, BRANCH             @Z30X8MJ 87145000
         B     TSOISIZE                 CLEAR IDLES COUNT      @YA12287 87150000
ERCHECK  EQU   *                                               @YA12287 87155000
         TM    LCBSTAT1,LCBSENDN        SENDING                @YA12287 87160000
         BNO   TSOISIZE                 BRANCH NO              @YA12287 87165000
         CLI   PRFPRI,PRIMHBFR-1        ERROR BUFFER           @YA12287 87170000
         BNE   TSOISIZE                 BRANCH NO              @YA12287 87175000
         TM    SCBERR3,SCBATTN+SCBSATTN ATTENTION INTERRUPT    @YA12287 87180000
         BNZ   TSOISIZE                 BRANCH YES             @YA12287 87185000
         L     R9,TRMDESTQ-1            QCB ADDRESS            @YA13265 87185200
         USING CVT,RWORK2                                      @YA13265 87185400
         L     RWORK2,CVTOFF            ADDRESS OF CVT         @YA13265 87185600
         L     RWORK2,CVTASVT           GET ASVT ADDRESS       @ZM46751 87185800
         DROP  RWORK2                                          @YA13265 87186000
         LA    RWORK2,ASVTENTY-ASVT(RWORK2) ASCB LIST ADDRESS  @ZM46751 87186100
         LH    R15,QCBTJID-IEDQQCB(R9)  GET ASID               @ZM46751 87186200
         BCTR  R15,0                    MAKE ZERO ORIGIN       @ZM46751 87186300
         SLL   R15,2                    GET OFFSET INTO LIST   @ZM46751 87186400
         L     RWORK2,AVTEZERO(R15,RWORK2) ASCB ADDRESS        @ZM46751 87186500
         L     RWORK2,ASCBTSB-ASCB(RWORK2) GET TSB ADDRESS     @ZM46751 87186600
         USING TSB,RWORK2               SET ADDRESSABILITY     @ZM46751 87186700
         TM    TSBFLG4,TSBHUNG          TERMINAL HAS HUNG UP   @ZM46751 87186800
         BO    TSOISIZE                 YES                    @ZM46751 87186900
         TM    TSBSTAT,TSBDISC          TERMINAL HAS LOGGED OFF@ZM46751 87188200
         BO    TSOISIZE                 YES                    @ZM46751 87188300
         TM    QCBTSOF1-IEDQQCB(R9),QCBDISC USER BEING         @OZ15624 87188600
         BO    TSOISIZE                 LOGGED OFF             @OZ15624 87188800
         DROP RWORK2                                           @YA13265 87189000
         OI    PRFSTAT1,PRFERMGN        SET ERROR FOR TSO      @YA12287 87190000
         NI    QCBTSOF1-IEDQQCB(R9),X'FF'-QCBSATRD             OY155693 87191010
*                                       RESET SIM ATTN READ    @ZM47773 87192000
         SR    R15,R15                  CLEAR INDEX REGISTER   @YA12287 87195000
         IC    R15,TRMCHCIN             GET DCT INDEX          @YA12287 87200000
         BCTR  R15,0                    REDUCE FOR MULTIPLY    @YA12287 87205000
         MH    R15,AVTDCTLN             MULTIPLY FOR ADDRESS   @Y176027 87210000
         A     R15,AVTCSTCS             GET ADDRESS DCT        @YA12287 87215000
         TM    1(R15),C3270             3270 DEVICE            @YA12287 87220000
         BO    TSOISIZE                 BRANCH YES             @YA12287 87225000
         TM    3(R15),CNOIDLES          2260 DEVICE            @YA12287 87230000
         BO    TSOISIZE                 BRANCH YES             @YA12287 87235000
         TM    2(R15),CLOCAL            LOCAL DEVICE           @YA12287 87240000
         BO    TSOISIZE                 BRANCH YES             @YA12287 87245000
         L     R15,TRMDESTQ-1           GET QCB ADDRESS        @YA12287 87250000
         MVI   QCBCARCT-IEDQQCB(R15),AVTEFF SET FOR CARRIAGE   @YA12287 87255000
*                                       RETURN BEFORE RETRY    @YA12287 87260000
TSOISIZE EQU   *                                               @Z30X8MJ 87265000
         SR    R15,R15                  CLEAR REGISTER 15      @Z30X8MJ 87270000
         STC   R15,LCBISZE              ZERO OUT IDLES COUNT        TSO 87275000
         TM    TRMSTATE,TRMPREF         NCP RESOURCE           @YM06159 87275600
         BNO   TSO1                     BR NO                  @YM06159 87276200
         TM    LCBSTAT5,LCBLUNIT        LOGICAL UNIT           @YM06159 87276800
         BNO   TSO1                     BR NO                  @YM06159 87277400
         SH    R1,TPREFIX               BACK UP TO TTE PREFIX  @YM06159 87278000
         USING IEDNTRM,R1               TTE PREFIX BASE        @YM06159 87278600
*                                       CHECK FOR SNA 3270     @YM06159 87279200
*                                       COMPATIBLE             @YM06159 87280000
         IEDDCT REG=R15,FLD=AVTPARM3,LEN=4                     @YM06159 87280600
         DROP  R1                                              @YM06159 87281200
         TM    DCTBYTE1-IEDDCT(R15),DCT3270 SNA 3270 COMPAT.   @YM06159 87281800
         BNO   TSO1                     BR NO                  @YM06159 87282400
         IC    R15,LCBISZE              GET IDLE COUNT         @YM06159 87283000
         LA    R15,1(,R15)              BUMP PAST ESCAPE CHAR  @YM06159 87283600
         STC   R15,LCBISZE              RESET LCBISZE          @YM06159 87284200
TSO1     EQU   *                                                    TSO 87285000
         SR    R15,R15                  CLEAR REGISTER           S22029 87290000
         TM    PRFSTAT1,PRFNHDRN        TEST IF HEADER OR TEXT          87295000
         BO    TEXT                     TEXT,  GO PROCESS               87300000
*                                       HEADER,  FALL THROUGH           87305000
         SPACE                                                          87310000
         TM    LCBSTATE,LCBSENDN        TEST IF SEND OR RECEIVE         87315000
         BNO   HDRRCV                   RECEIVE, GO PROCESS             87320000
*                                       SEND, FALL THROUGH              87325000
         EJECT                                                          87330000
         TM    PRFSTAT1,PRFTSMSG .      IS IT A TS MESSAGE       S22029 87335000
         BO    EXIT                     BRANCH ON YES TO EXIT       TSO 87340000
         SPACE                                                          87345000
         SPACE                                                          87350000
         TM    PRFSTAT1,PRFCNCLN        IS THIS A RECALLED BUFFER       87355000
         BO    COMPIDLS                 YES, DON'T UPDATE FEFO          87360000
         SPACE                                                          87365000
         SR    R0,R0 .                  CLEAR FOR INSERT         S22025 87370000
         IC    R0,SCBPRI                GET INDEX TO PRIORITY QCB       87375000
         LA    R1,QCBPSIZE              GET SIZE OF PRIORITY QCB        87380000
         MR    R0,R0                    MULTIPLY TO GET OFFSET          87385000
         L     RWORK2,SCBDESTQ-1        GET ADDRESS OF MASTER QCB       87390000
         USING IEDQQCB,RWORK2                                           87395000
         LA    R1,QCBMSIZE(RWORK2,R1)   GET ADDR OF PRIORITY QCB        87400000
         USING IEDQPQCB,R1                                              87405000
         CLC   SCBSCHDR,QCBLKRRN        QUEUED ADDR = LOCK MSG @OS76313 87410000
         BNE   NORRN                    BRANCH NO              @OS76313 87415000
         XC    QCBLKRRN,QCBLKRRN        CLEAR LOCK MSG ADDR    @OS76313 87420000
NORRN    EQU   *                                               @OS76313 87425000
         LA    RWORK2,SCBSCHDR          ASSUME FEFO ADDR IN SCB SA52971 87430000
         TM    SCBSCHDR+L'SCBSCHDR-1,CPBQTYPE CORE COPY OF DISK SA52971 87435000
*                                         BACKUP                SA52971 87440000
         BNZ   MOVEFEFO                 NO, GOT IT              SA52971 87445000
         L     RWORK2,SCBSCHDR-1        POINT TO QUEUED HEADER  SA52971 87450000
         LA    RWORK2,PRFCRCD-IEDQPRF(,RWORK2) POINT TO DISK ADRSA52971 87455000
MOVEFEFO EQU   *                                                SA52971 87460000
         CLC   AVTEZERO(3,RWORK2),QCBFFEFO IS IT TOP ON QUEUE   SA52971 87465000
         BNE   COMPIDLS                 NO, DON'T RESET         SA52971 87470000
         ICM   RWORK2,AD,QCBINTFF       IS QUEUE HELD            Y05330 87475000
         BNZ   JUSTPVF                  YES, DON'T UPDATE PFEFO SA52971 87480000
         MVC   QCBPFEFO(3),QCBPREVF     SHUFFLE TO LAST SRVCD   SA52971 87485000
*                                         MESSAGE               SA52971 87490000
         MVC   QCBPREVF(3),QCBFFEFO     KEEP POINTER TO THIS MSGSA52971 87495000
JUSTPVF  EQU   *                                                SA52971 87500000
         MVC   QCBFFEFO(THREE),SCBFEFO  UPDATE FEFO POINTER             87505000
         TM    QCBFFEFO+L'QCBFFEFO-1,CPBQTYPE                   SA60343 87510000
*              ARE THE FLAGS FOR DISK QUEUEING ON               SA60343 87515000
         BNZ   COMPIDLS                 BR IS NOT SET           SA60343 87520000
         NI    QCBFFEFO+L'QCBFFEFO-1,X'FF'-LASTNOFF             SA60343 87525000
*              RESET THE 'DO NOT UPDATE' FLAG SET BY RP FOR     SA60343 87530000
*              FA WHEN REMOVING THE LAST FEFO MESSAGE           SA60343 87535000
         DROP  RWORK2                                            S22029 87540000
         SPACE                                                          87545000
COMPIDLS EQU   *                                                        87550000
         SR    RWORK2,RWORK2 .           SET IDLES CNT TO ZERO   S22025 87555000
         CH    RWORK2,PRFSIZE           ZERO-LENGTH BUFFER              87560000
         BE    STORIDLS                 YES, LEAVE IDLES CT ZERO        87565000
         SPACE                                                          87570000
         IC    RWORK2,PRFSCAN+1   NO, GET IDLES CT FROM BFR             87575000
         SPACE                                                          87580000
STORIDLS EQU   *                                                        87585000
         STC   RWORK2,LCBISZE           INITIALIZE LCB RESERVE CT       87590000
         LA    RWORK2,AVTHDRSZ(,RWORK2) ADD SIZE OF HEADER PREFIX       87595000
         SPACE                                                          87600000
         BAL   R14,TNTSUB               LOCATE TERMINAL ENTRY    Y05330 87605000
         SPACE                                                          87610000
         USING IEDQTRM,R1                                               87615000
         TM    TRMSTATE,TRMPROC         INSURE THAT TTE ENTRY  @Y17XAMF 87615400
         BNO   NODATE                    IS A TPROCESS ENTRY   @Y17XAMF 87615800
         TM    TRMSTATE,TRMLOG                                 @Y17XAMF 87616200
         BO    NODATE                                          @Y17XAMF 87616600
         LA    R0,TRMTPIN               LOAD MASK FOR IEDQTL   @Y17XAMF 87617000
         L     R15,AVTDDFT              GET ADDR TO IEDQTL     @Y17XAMF 87617400
         BALR  R14,R15                  GO GET TPROCESS DEV DEP FIELD   87617800
*                                                              @Y17XAMF 87618200
         TM    PROFLAG-IEDPROC(R15),PRODATE IS DATE=YES SPECIFIED       87618600
*                                                              @Y17XAMF 87619000
         BNO   NODATE                   IF NOT, BRANCH         @Y17XAMF 87619400
         LA    RWORK2,PARMLEN(RWORK2)   BUMP SCAN FOR DATE/TIME  S22025 87645000
NODATE   EQU   *                                                 S22025 87650000
         STH   RWORK2,PRFSCAN           INITIALIZE SCAN          S22025 87655000
         TM    PRFSTAT1,PRFCNCLN        RECALLED                 S22025 87660000
         BO    EXIT                     YES, DON'T UPDATE SEQ OUTS22025 87665000
         ICM   RWORK2,HLF,SCBOSEQ       SEQ OUT UPDATED          Y05330 87670000
         BNZ   EXIT                     BRANCH IF YES            S22025 87675000
         LH    RWORK2,TRMOUTSQ          GET OUTPUT SEQUENCE NUMBER      87680000
         STH   RWORK2,SCBOSEQ           PASS IN SCB                     87685000
         LA    RWORK2,ONE(,RWORK2)      INCREMENT BY ONE                87690000
         CH    RWORK2,CONMAX            IS MAXIMUM COUNT EXCEEDED       87695000
         BNH   UPCOUNT                  NO, PUT BACK UPDATED COUNT      87700000
         SPACE                                                          87705000
         LA    RWORK2,ONE               NO, RESET COUNT TO ONE          87710000
         SPACE                                                          87715000
UPCOUNT  EQU   *                                                        87720000
         STH   RWORK2,TRMOUTSQ          STORE IT BACK                   87725000
         B     EXIT                     RETURN TO MH                    87730000
         EJECT                                                          87735000
HDRRCV   EQU   *                                                        87740000
         TM    PRFSTAT1,PRFCNCLN        IS THIS A RECALLED BUFFER       87745000
         BO    TESTRAN                  YES, GO TRANSLATE & EXIT        87750000
         SPACE                                                          87755000
         SPACE                                                          87760000
         LH    RWORK2,LCBTTCIN          INITIALIZE ORIGIN FIELD         87765000
         STH   RWORK2,PRFSRCE             IN PREFIX FROM LCB            87770000
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PLCB         @Y17XAMF 87775000
         BNE   NOTNCP                   BRANCH IF NO           @Y17XAMF 87780000
         MVC   LCBISZE,PRFISIZE         SET UP RESERVE COUNT   @Y17XAMF 87785000
NOTNCP   EQU   *                                               @Y17XAMF 87790000
         SR    RWORK2,RWORK2 .          CLEAR FOR INSERT         S22025 87795000
         IC    RWORK2,LCBISZE           PICK UP RESERVE CT FROM LCB     87800000
         TM    SCBQTYPE,SCBBFMM .       IS THIS MID-OF-MSG       S22025 87805000
         BNO   NOTLMD .                 NO, CONTINUE AS HEADER   S22025 87810000
         MVC   SCBDEOB+1(3),AVTADBUF+1  SET DEOB FOR THE CASE OF S22025 87815000
*                                         A DE-BLOCKED HEADER    S22025 87820000
         NI    SCBQTYPE,X'FF'-SCBBFMM . TURN OFF MID-OF-MSG      S22025 87825000
         OI    PRFSTAT1,PRFNHDRN .      SET AS TEXT BUFFER       S22025 87830000
         OI    PRFTIC,PRFBFMM .         SET AS HDR CHGD TO TEXT  S22025 87835000
         LA    RWORK2,AVTHDRSZ-AVTTXTSZ(,RWORK2)   ADD TO ISIZE  S22025 87840000
         B     REALTEXT .               BRANCH TO TREAT AS TEXT  S22025 87845000
         SPACE 1                                                 S22025 87850000
NOTLMD   EQU   *                                                 S22025 87855000
         TM    PRFSTAT1,PRFITCPN        TEMPORARY END OF MSG    SA62383 87860000
         BNO   SKIPMM                   BRANCH IF NO            SA62383 87865000
         OI    SCBQTYPE,SCBBFMM         SET MIDDLE OF MESSAGE   SA62383 87870000
SKIPMM   EQU   *                                                SA62383 87875000
         LA    RWORK2,AVTHDRSZ(,RWORK2) ADD LNG OF HDR PREFIX           87880000
         ST    R15,SCBPRI .             CLEAR SCB PRIORITY       S22025 87885000
         CH    RWORK2,PRFSIZE           IS THERE DATA IN BUFFER?        87890000
         BL    SETSCPTR                 YES,GO SET SCAN PTR    @SA75454 87895000
         SPACE                                                          87900000
         STH   R15,PRFSIZE              NO, SET SIZE TO ZERO            87905000
         SPACE                                                          87910000
SETSCPTR EQU   *                                                        87915000
         TM    PRFSTAT1,PRFTSMSG .     IS IT A TS MESSAGE        S22029 87920000
         BO    EXIT                     BRANCH ON YES TO EXIT           87925000
         SPACE                                                          87930000
         STH   RWORK2,PRFSCAN           INITIALIZE PREFIX SCAN PTR      87935000
         STH   R15,PRFISEQ              INITIALIZE SEQ IN TO ZERO       87940000
         ICM   RSCT8,AD,DCBSCTAD        SPECIAL CHAR TBL         Y05330 87945000
         BZ    EXIT                     NO, SOURCE IS APPLICATION       87950000
*                                         PROGRAM,  RETURN TO MH        87955000
         CH    R15,PRFSIZE .             IS THIS A ZERO BUFFER   S22025 87960000
         BE    EOTCODE .                BRANCH IF YES           SA54959 87965000
EOTCODE1 EQU   *                                                SA54959 87970000
         SPACE                                                          87975000
         L     R1,LCBSTCBA-1 .          LOAD ADDRESS OF STCB     S22025 87980000
         CLI   0(R1),LMDSTCB .          IS IT LMD STCB           S22025 87985000
         BE    EXIT .                   YES, RETURN              S22025 87990000
         SPACE                                                          87995000
         LR     R1,RWORK2 .             SET PARAMETER FOR SCAN   S22025 88000000
         L     RAVT,AVTBASE             @AVT                   @Y17XANQ 88002000
         L     RAVT,CVTOFF              GET ADDRESS OF CVT       S22025 88005000
         L     RAVT,AVTCVTPT(,RAVT)     FIND POINTER TO AVT      S22025 88010000
         L     RAVT,AVTEZERO(,RAVT)     GET ADDRESS OF AVT       S22025 88015000
         CLI   SCTEOA(RSCT8),AVTEZERO   IS AN EOA SEQ DEFINED           88020000
         BE    TESTLOCK                 NO, PROCEED                     88025000
         SPACE                                                          88030000
         TM    LCBTSOB,LCB2741N         IS SOURCE AN IBM 2741           88035000
         BO    TESTLOCK                 YES, NO EOA, BRANCH             88040000
         SPACE                                                          88045000
         LA     R15,SCTEOA .            GET EOA SEQUENCE OFFSET  S22025 88050000
         BAL   R14,LINKAL .             SCAN FOR EOA CHARACTER   S22025 88055000
         SPACE 1                                                 S22025 88060000
*   ON RETURN -- PRFDATOF WILL BE INCREMENTED IF EOA SEQUENCE    S22025 88065000
*            IS IN BUFFER                                        S22025 88070000
         SPACE 1                                                 S22025 88075000
         LR    R1,R0 .                  GET UPDATED SCAN OFFSET  S22025 88080000
         SR    RWORK5,RWORK5            ZERO REGISTER          @OY13651 88080500
         IC    RWORK5,LCBISZE           GET IDLE COUNT         @OY13651 88081000
         LA    R15,AVTHDRSZ(RWORK5,R15) GET BUFFER SIZE        @OY13651 88081500
         CH    R15,PRFSIZE              EOA ONLY BYTE IN BUF?  @OY13651 88082000
         BNE   NEOAONLY                 NO-CONTINUE            @OY13651 88082500
         SR    R15,R15                  SET UP TO CLEAR PRFSIZE@OY13651 88083000
         B     EOTCODE3                 CONT WITH 0-LNGTH BFR  @OY13651 88083500
NEOAONLY EQU   *                                               @OY13651 88084000
         TM    DCBDSORG,LGB             IS BLOCK A DCB OR LGB    S22024 88085000
         BO    TESTLOCK                 BRANCH IF LGB            S22024 88090000
         L     RUCB5,DCBDEBAD           GET ADDRESS OF DEB FROM DCB     88095000
         USING DEBNMSUB,RUCB5                                           88100000
         L     RUCB5,DEBUCBAD           GET ADDRESS OF UCB FROM DEB     88105000
         USING UCBOB,RUCB5                                              88110000
         CLI   UCBTBYT3,TPDEVICE        IS THIS A TP DEVICE             88115000
         BNE   TESTLOCK                 NO, GO TEST FOR LOCK            88120000
         SPACE                                                          88125000
         IC    R15,UCBTBYT1             PICK UP MODEL BYTE              88130000
         STC   R15,AVTDOUBL             SET IT IN AVT WORK AREA         88135000
         MVZ   AVTDOUBL(ONE),UCBTBYT4   OVERLAY IT WITH ADAP BYTE       88140000
         CLI   AVTDOUBL,IBM1030         IS DEVICE AN IBM 1030           88145000
         BE    BUMPXTRA                 YES, BUMP SCAN ONE MORE         88150000
         SPACE                                                          88155000
         CLI   AVTDOUBL,IBM2260R        IS DEVICE IBM 2260 REMOTE       88160000
         BNE   TESTLOCK                 NO, GO TEST FOR LOCK            88165000
         SPACE                                                          88170000
BUMPXTRA EQU   *                                                        88175000
         LA    R1,ONE(,R1) .            UPDATE SCAN OFFSET       S22025 88180000
TESTLOCK EQU   *                                                        88185000
         TM    SCBSTATE,SCBLCK1N        TERMINAL IN LOCK MODE           88190000
         BNO   NOLOCK                  NO, BRANCH                       88195000
         SPACE                                                          88200000
         NI    LCBMSGFM,AVTEFF-LCBOLT   MAKE SURE OLT BIT IS OFF        88205000
         OI    PRFSTAT1,PRFLOCK         SET PREFIX LOCK BIT             88210000
         MVC   PRFDEST,LCBINSRC         GET INDEX IN TERMNAME TABLE     88215000
         MVI   LCBINSRC+2,POSTPEND      SET POST PENDING FLAGS          88220000
         BAL   R14,TNTSUB               LOCATE TERMINAL ENTRY    Y05330 88225000
         SPACE                                                          88230000
         MVC   SCBDESTQ,TRMDESTQ        SET DEST QCB ADDRESS            88235000
         B     EXIT                     EXIT TO MH              S22025  88240000
         SPACE                                                          88245000
LOCKTEST EQU   *                                                SA52512 88250000
         TM    SCBSTATE,SCBLCK1N .      LOCK MODE               SA52512 88255000
         BNO   EXIT .                   NO, BRANCH              SA52512 88260000
         MVI   PRFSIZE+ONE,PRFSHDR+ONE-PRFSUNIT SET PRFSIZE     SA52512 88265000
         BAL   R14,EOTADDR              COMPUTE EOT ADDRESS     SA52512 88270000
         MVC   PRFSHDR(ONE),ONE(R1)     INSERT EOT IN BUFFER    SA52512 88275000
         MVI   LCBISZE,AVTEZERO .       CLEAR IDLES COUNT       SA52512 88280000
         B     TESTLOCK .               FINISH INQUIRY HANDLING SA52512 88285000
EOTADDR  EQU   *                                                SA52512 88290000
         L     RSCT8,DCBSCTAD-1         SPEC CHAR TABLE         SA52512 88295000
         SR    R1,R1                    CLEAR INDEX REGISTER    SA52512 88300000
         IC    R1,SCTEOT(RSCT8)         GET EOT INDEX           SA52512 88305000
         LA    R1,AVTEZERO(R1,RSCT8)    EOT ENTRY ADDRESS       SA52512 88310000
         CLI   AVTEZERO(R1),TWO         ETX/EOT                 SA52512 88315000
         BCR   SEVEN,R14                NO, RETURN              SA52512 88320000
         LA    R1,ONE(,R1)              BUMP PAST ETX           SA52512 88325000
         BR    R14                      RETURN                  SA52512 88330000
         SPACE                                                          88335000
NOLOCK   EQU   *                                                        88340000
         SPACE                                                          88345000
         TM    LCBMSGFM,LCBOLT .        IS THIS OLT MESSAGE    @YM07683 88346000
         BO    LINKERST .               YES, CHECK TOTE ACTIVE @YM07683 88347000
         TM    LCBSTAT2,LCBSYNC         IS THIS BISYNC LINE             88350000
         BNO   TOTESS .                 NO, CHECK FOR TOTE STRINGS22025 88355000
         B     EXIT                     NO OLT, GET OUT                 88362000
         SPACE 1                                                 S22025 88380000
         SPACE                                                          88385000
TOTESS   EQU   *                                                        88390000
         CLI   SCTOLT(RSCT8),AVTEZERO   OLT SEQ SPECIFIED        A44861 88395000
         BE    EXIT                     BRANCH IF NO             S22025 88400000
         LA    R15,SCTOLT .             GET OLT SEQUENCE OFFSET  S22025 88405000
         BAL   R14,LINKAL .             LINK TO SCAN             S22025 88410000
         SPACE 1                                                 S22025 88415000
         LR     R1,R0 .                 GET OFFSET RETURNED      S22025 88420000
         SPACE                                                          88425000
         LPR   RWORK2,RWORK2            ADDRESS OF OLT SEQ     @SA74025 88430000
         CLM   R15,ONE,0(RWORK2)        WAS FULL SEQ FOUND     @Y17XANQ 88432000
         BE    LINKERST                 YES,HOW ABOUT OLT      @SA74025 88450000
         SPACE                                                          88455000
         TM    LCBTSOB,LCB2741N         IS IT IBM 2741                  88460000
         BNO   EXIT .                   NO, NOT OLT, EXIT TO MH  S22025 88465000
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PLCB?        @OY12671 88470000
         BE    EXIT                     YES,NO SECOND STRING   @OY12671 88475000
         SPACE 1                                                 S22025 88480000
         LA    RWORK2,SSTOTLEN(,RWORK2) POINT TO 2D OLT STRING   S22025 88485000
         BAL   R14,LINKAL2 .            SCAN FOR 2D TOTE STRING  S22025 88490000
         SPACE                                                          88495000
         LPR   RWORK2,RWORK2            ADDRESS OF OLT SEQ     @SA74025 88500000
         CLM   R15,ONE,0(RWORK2)        WAS FULL SEQ FOUND     @Y17XANQ 88502000
         BNE   EXIT                     NO OLT,GET OUT         @SA74025 88520000
         SPACE                                                          88525000
LINKERST EQU   *                                                 S22025 88530000
         CLI   AVTOLTST,AVTEZERO .      IS ON-LINE TEST IN SYSTEMS22025 88535000
         BE    OLTERROR .               NO, SET ERROR BIT        S22025 88540000
         TM    PRFSTAT1,PRFNLSTN  IS MESSAGE CONTAINED IN ONE    S99528 88545000
*                                   BUFFER?                      S99528 88550000
         BZ    SETOTT                   BRANCH YES BUFFER      @Y17XANQ 88555000
         OI    LCBMSGFM,LCBOLT          INSURE TOTE FLAG SET   @Y17XANQ 88557000
         SPACE                                                          88605000
SETOTT   EQU   *                                                        88610000
         LA    RWORK2,AVTOLTQB          GET ADDRESS OF OLT QCB          88725000
*                               QUEUE POINTER                    S99528 88730000
         MVI   PRFPRI,PRIONLT           SET ON-LINE TEST PRIORITY       88735000
         MVI   PRFKEY,FOUR              SET PRFKEY             @Y17XANQ 88800000
         STCM  RWORK2,AD,PRFQCBA        QCB @ TO ELEMENT       @Y17XANQ 88801000
         LR    R1,RPREFIX               BUFFER=ELEMENT         @Y17XANQ 88802000
         BAL   R14,DSPPOST              TPOST BFR TO TOTE      @Y17XANQ 88803000
         SPACE                                                          88805000
OLTERROR EQU   *                                                        88810000
         OI    SCBERR2,SCBOLTR          SET OLT ERROR BIT IN SCB        88815000
         B     EXIT .                   EXIT TO MH               S22025 88820000
         SPACE 2                                                 S22025 88825000
LINKAL   EQU   *                                                 S22025 88830000
         SR    RWORK2,RWORK2 .          CLEAR FOR INSERT         S22025 88835000
         IC    RWORK2,AVTEZERO(R15,RSCT8)  PICK UP SEQ OFFSET    S22025 88840000
         LA    RWORK2,0(RWORK2,RSCT8) . GET ADDR OF STRING       S22025 88845000
LINKAL2  EQU   *                                                 S22025 88850000
         LR    R0,RWORK2 .              SET FOR SCAN ROUTING     S22025 88855000
         LNR   RWORK2,RWORK2            DO NOT SKIP BLANKS     @SA74025 88860000
         L     R15,AVTAL                LOAD SCAN ROUTINE ADDR   S22025 88865000
         BR    R15 .                                             S22025 88870000
         EJECT                                                          88875000
TEXT     EQU   *                                                        88880000
         TM    LCBSTATE,LCBSENDN       SEND OR RECEIVE         @SA68025 88885000
         BO    TXTSEND                  SEND, NOT TOTE REQUEST @SA68025 88890000
         TM    LCBMSGFM,LCBOLT          IS THIS AN ONLINE TEST   S22024 88895000
*                                         TEXT BUFFER            S22024 88900000
         BNO   TXTRCV                   RECEIVES               @Y17XANQ 88905000
         TM    PRFSTAT1,PRFTSMSG        IS THIS A TSO MSG?     @OZ24601 88905110
         BNO   NOOLT                    NO                     @OZ24601 88905210
         NI    LCBMSGFM,AVTEFF-LCBOLT  TURN OFF ONLINE TEST BIT@OZ24601 88905310
         B     TXTRCV                   CONTINUE               @OZ24601 88905410
NOOLT    EQU   *                                               @OZ24601 88905510
         CLI   AVTOLTST,AVTEZERO        TOTE IN SYSTEM         @OX14795 88905610
         BNE   YESTOTE                  YES,CONTINUE           @0X14795 88905710
         TM    PRFSTAT1,PRFNLSTN        LAST                   @0X14795 88905810
         BO    TXTRCV                   NO,TREAT AS NORMAL     @OX14795 88905910
         NI    LCBMSGFM,AVTEFF-LCBOLT   TURN OFF OLT BIT       @OX14795 88906010
         B     TXTRCV                                          @OX14795 88906110
YESTOTE  EQU   *                        TOTE IN SYSTEM         @OX14795 88906210
         LA    RWORK2,AVTBFRTB          GET ADDRESS OF BUFFER    S22024 88910000
*                                         RETURN QCB             S22024 88915000
         STCM  RWORK2,AD,SCBDESTQ       SET QCB ADDRESS          Y05330 88920000
         MVI   PRFPRI,PRIBFRTB          PUT IN PRIORITY          S22024 88925000
         TM    PRFSTAT1,PRFNLSTN        IS THIS THE LAST BUFFER? S22024 88930000
         BO    BUFRET                   NO, GO POST BUFFER TO    S22024 88935000
*                                         BUFFER RETURN          S22024 88940000
         NI    LCBMSGFM,AVTEFF-LCBOLT   TURN OFF ONLINE TEST BIT S22024 88945000
         LA    RWORK2,AVTINOUT          GET ADDR OF DUMMY IN/OUT S22024 88950000
         STCM  RWORK2,AD,SCBMACR        SET DUMMY END            Y05330 88955000
         L     RWORK2,AVTMSGS-ONE       GET VCON TABLE ADDRESS   S22024 88960000
         L     RWORK2,AVTEZERO(RWORK2)  GET ADDRESS OF BD'S QCB  S22024 88965000
         MVI   PRFPRI,PRIDSPLB          SET LOW PRIORITY         S22024 88970000
BUFRET   EQU   *                                                 S22024 88975000
         STCM  RWORK2,AD,PRFQCBA        QCB ADDRESS TO ELEMENT   Y05330 88980000
         LR    R1,RPREFIX               PUT ADDR OF BUFFER IN R1 S22024 88985000
         BAL   R14,DSPPOST              EXIT TO POST BUFFER TO @Y17XAMF 88990000
*                                         QCB                    S22024 88995000
TXTSEND  EQU   *                                                        89000000
         SPACE                                                          89005000
         TM    PRFSTAT1,PRFTSMSG .      IS IT A TS MESSAGE       S22029 89010000
         BO    TESTRAN                  YES, GO TRANS AND EXIT      TSO 89015000
         SPACE                                                          89020000
         SPACE                                                          89025000
         MVI   LCBISZE,AVTEZERO         SET IDLES COUNT TO ZERO         89030000
         LA    RWORK2,AVTTXTSZ          GET SIZE OF TEXT PREFIX         89035000
         STH   RWORK2,PRFSCAN           INITIALIZE SCAN POINTER         89040000
         CH    R15,PRFSIZE              IS THIS A ZERO BFR      SA56222 89045000
         BE    EXIT                     IF 0 EXIT               SA56222 89050000
         B     TESTRAN1                 IF NOT 0 CONTINUE       SA56222 89055000
         SPACE                                                          89060000
CHKLOCK  EQU   *                                                SA52512 89065000
         TM    SCBSTATE,SCBLCK1N .      LOCK MODE               SA52512 89070000
         BNO   EXIT .                   NO, BRANCH              SA52512 89075000
         MVI   PRFSIZE+ONE,PRFSTXT+ONE-PRFSUNIT SET PRFSIZE     SA52512 89080000
         BAL   R14,EOTADDR              COMPUTE EOT ADDRESS     SA52512 89085000
         MVC   PRFSTXT(ONE),ONE(R1)     INSERT EOT IN BUFFER    SA52512 89090000
         MVI   LCBISZE,AVTEZERO .       CLEAR IDLES COUNT       SA52512 89095000
         B     EXIT .                   END TEXT PROCESSING     SA52512 89100000
         SPACE                                                          89105000
TXTRCV   EQU   *                                                        89110000
         TM    LCBMSGFM,LCBOLT          IS THIS A TOTE REQUEST @Y17XANQ 89111000
         BO    SETOTT                   BRANCH YES             @Y17XANQ 89112000
         LH    R0,LCBTTCIN              INITIALIZE ORIGIN FIELD SA61771 89115000
         STH   R0,PRFSRCE                 IN PREFIX FROM LCB    SA61771 89120000
         SR    RWORK2,RWORK2            (CLEAR FOR INSERT)              89125000
         IC    RWORK2,DCBRESER+1        PICK UP NO. RESERVE CHARS       89130000
         TM    PRFSTAT1,PRFTSMSG .      IS IT A TS MESSAGE       S22029 89135000
         BNO   TSTEXIT                  NO, GO CHECK LOGON EXIT   M6673 89140000
         TM    DCBDSORG,AVTE80          IS THIS 3705 LGB         Y06327 89145000
         BNO   NOT3705                  BRANCH ON NO             Y06327 89150000
         STC   RWORK2,LCBISZE           SET NUMBER OF IDLES      Y06327 89155000
NOT3705  EQU   *                                                 Y06327 89160000
         SR    RWORK2,RWORK2            CLEAR WORK REGISTER       M6673 89165000
         IC    RWORK2,LCBISZE           GET NUMBER OF IDLES       M6673 89170000
         LA    RWORK2,AVTTXTSZ(,RWORK2) ADD TEST PREFIX LENGTH   S22029 89175000
         CH    RWORK2,PRFSIZE           CHECK BUFFER DATA LENGTH  M6673 89180000
         BNE   TESTRAN                  BR IF NOT EMPTY         SA61771 89185000
         B     EOTCODE3                 HANDLE ZERO LENGTH BFR @ZA04049 89190000
TSTEXIT  EQU   *                                                  M6673 89195000
         SPACE                                                          89200000
         TM    PRFSTAT1,PRFCNCLN        IS THIS A RECALLED BUFFER       89205000
         BO    TESTRAN                  YES, DON'T CHANGE SCAN          89210000
         SPACE                                                          89215000
REALTEXT EQU   *                                                 S21101 89220000
         TM    PRFSTAT1,PRFITCPN        TEMP END OF MSG          Y01004 89225000
         BZ    NOTEOM                   BRANCH NO                S22025 89230000
*                                                                S22025 89235000
         OI    SCBQTYPE,SCBBFMM         INDICATE MIDDLE  OF MSG  S22025 89240000
NOTEOM   EQU   *                                                 S22025 89245000
         STC   RWORK2,LCBISZE           SET COUNT IN LCB                89250000
         LA    RWORK2,AVTTXTSZ(,RWORK2) ADD SIZE OF TEXT PREFIX         89255000
         STH   RWORK2,PRFSCAN           INITIALIZE SCAN PTR             89260000
         CH    RWORK2,PRFSIZE                                           89265000
         BL    TESTRAN                                         @SA75471 89270000
         XC    PRFSIZE(2),PRFSIZE                                       89275000
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER             @YA10671 89280000
         BNO   EOTCODE3                 BRANCH YES             @YA10671 89285000
         SPACE                                                          89290000
TESTRAN  EQU   *                                                        89295000
         CLC   AVTFZERO(TWO),PRFSIZE    ZERO LENGTH BUFFER ?     S22024 89300000
         BE    CHKLOCK .                YES, BRANCH             SA52512 89305000
TESTRAN1 EQU   *                                                SA56222 89310000
         TM    LCBSTATE,LCBSENDN .      IS LINE SENDING          S22025 89315000
         BNO   EXIT .                   IF RECEIVING, INHDR      S22025 89320000
*                                         WILL MAKE TESTS        S22025 89325000
         SPACE                                                          89330000
         TM    SCBSTATE,SCBCODE         IS TRANSLATION REQUESTED        89335000
         BNO   TESTMBH                  NO, GO TEST FOR MBH             89340000
         SPACE                                                          89345000
         L     R1,SCBTRANS-1            YES, GET CODE PARM LIST         89350000
         L     R15,AVTUI                GET USER INTERFACE ADDRESS      89355000
         BALR  R14,R15                  LINK TO TRANSLATE BUFFER        89360000
         SPACE                                                          89365000
TESTMBH  EQU   *                                                        89370000
         L     RWORK2,SCBMBHEN-1        GET MBH PARM LIST ADDR   A59509 89375000
         CLC   AVTINOUT,AVTEZERO(RWORK2) DOES IT POINT TO '0100' A59509 89380000
         BE    EXIT                     IT DOES, NO MBH, EXIT           89385000
         SPACE                                                          89390000
         LNR   RWORK5,RWORK2            SET NEG REGISTER AS FLAG A59509 89395000
         BCT   RWORK2,MBHEXIT           DECR TO CLEAR FLAG BIT   A59509 89400000
*                                         AND EXIT TO RE-ENTER RTN      89405000
         EJECT                                                          89410000
         SPACE                                                          89415000
EXIT     EQU   *                                                        89420000
         SR    RWORK5,RWORK5            ZERO FLAG REG - NO MBH   A59509 89425000
         SPACE                                                          89430000
MBHEXIT  EQU   *                                                        89435000
         CLC   ONE(THREE,RQCB7),AVTFZERO ALTMH PRESENT           S22029 89440000
         BE    NOALTMH .                NO CONTINUE              S22029 89445000
         USING IEDQQCB,RTQCB                                     S22029 89450000
         SR    RTQCB,RTQCB                                       S22029 89455000
         CLI   LCBFLAG1,AVTEZERO        IS THIS 3705 PLCB        S22024 89460000
         BE    NOTDIAL                  BRANCH ON YES            S22024 89465000
         TM    LCBSTAT2,LCBDIAL .      IS IT A DIAL LINE         S22029 89470000
         BZ    NOTDIAL .                NO  BRANCH               S22029 89475000
         LH    R1,LCBLNENT .            OFFSET TO LINE ENTRY     S22029 89480000
         B     TERMENT .                TO GET TERM ENTRY        S22029 89485000
NOTDIAL  EQU   * .                                               S22029 89490000
         LH    R1,LCBTTCIN .            INDEX TO CURRENT TERM    S22029 89495000
TERMENT  EQU   * .                                               S22029 89500000
         N     R1,AVTCLRHI              CLEAR HIGH AND TEST      A59509 89505000
         BZ    NOALTMH                  NO.CANNOT LOCATE ALTMH   S22029 89510000
         L     R15,AVTRNMPT .           ADDRESS OF TERMNAME TBL  S22029 89515000
         BALR  R14,R15 .                GET TERMINAL ENTRY       S22029 89520000
         USING IEDQTRM,R1 .                                      S22029 89525000
         L     RTQCB,TRMDESTQ-1         GET DESTINATION ADDRESS  S22029 89530000
         TM    QCBDSFLG,QCBALTMH .      ALTERNATE MH             S22029 89535000
         BZ    NOALTMH .                NO CONTINUE              S22029 89540000
         L     RQCB7,AVTEZERO(,RQCB7)   GET ALTMH                S22029 89545000
NOALTMH  EQU   * .                                               S22029 89550000
         LR    R1,RWORK2                SET MBH PARAMETER IN     A59509 89555000
*                                        CORRECT REG FOR EXIT    A59509 89560000
         L     R15,AVTUI                GET USER INTERFACE ADDR  A59509 89565000
         LH    RWORK2,CONBASE           SET INCR VALUE IF MULT BASE     89570000
         SR    RBASE,RBASE              (CLEAR FOR INSERT)              89575000
         IC    RBASE,PARMLEN(,RQCB7)    PICK UP LNG OF PARM LIST        89580000
         LA    RBASE,AVTEZERO(RQCB7,RBASE) GET 1ST INSTRUCTION ADDR     89585000
         LTR   RWORK5,RWORK5            MBH RE-ENTRY NEEDED      A59509 89590000
         BCR   MINUS,RBASE              YES, PASS MINUS TO MH           89595000
         SPACE                                                          89600000
         TM    LCBSTAT1,LCBSENDN        NO, TEST IF SENDING             89605000
         BR    RBASE                    ENTER MH, SELECT IN OR OUT      89610000
         EJECT                                                          89615000
EOTCODE  EQU   *                                                SA54959 89620000
         TM    SCBERR4,SCBTXTTN .       TEXT TRANSFER ERROR     SA54959 89625000
         BNO   LOCKTEST .               BRANCH IF NO            SA54959 89630000
EOTCODE3 EQU   *                                                SA54959 89635000
         STH   R15,PRFSIZE .            SET ZERO LENGTH         SA54959 89640000
         L     R15,DCBSCTAD-1 .         SPECIAL CHAR TABLE      SA54959 89645000
         SR    R1,R1 .                  CLEAR INDEX REGISTER    SA54959 89650000
         MVI   LCBISZE,AVTEZERO .       CLEAR IDLES COUNT       SA54959 89655000
         IC    R1,SCTEOT(R15) .         GET EOT INDEX           SA54959 89660000
         LA    R1,AVTEZERO(R1,R15) .    EOT ENTRY ADDRESS       SA54959 89665000
         CLI   AVTEZERO(R1),TWO .       ETX/EOT                 SA54959 89670000
         BNE   EOTCODE2 .               BRANCH IF NO            SA54959 89675000
         LA    R1,ONE(,R1) .            BUMP PAST ETX           SA54959 89680000
EOTCODE2 EQU   *                                                SA54959 89685000
         SR    R15,R15 .                CLEAR WORK REGISTER     SA54959 89690000
         TM    PRFSTAT1,PRFNHDRN .      HEADER BUFFER           SA54959 89695000
         BNO   EOTCODE4 .               BRANCH IF YES           SA54959 89700000
         MVC   PRFSTXT(ONE),ONE(R1) .   INSERT EOT IN BFR       SA54959 89705000
         MVI   PRFSIZE+ONE,PRFSTXT+ONE-PRFSUNIT SET PRFSIZE     SA54959 89710000
         TM    SCBERR4,SCBTXTTN+SCBSLCTN+SCBCONNN              @OY15001 89710700
*                            TEXT,SELECTION OR CONNECT ERROR?  @OY15001 89711400
         BNZ   ERROR1                   YES SET UNIT EXCEPTION @OY15001 89712100
         TM    SCBERR1,SCBCUTFN         CUTOFF EXECUTED        @OY15001 89712800
         BNO   TESTRAN                  NO, CONTINUE           @OY15001 89713500
ERROR1   EQU   *                                               @OY15001 89714200
         OI    LCBCSW+CSWST1,UNEX       SET EOT RECEIVED       @OY12280 89715000
         B     TESTRAN .                CONTINUE PROCESSING     SA54959 89720000
EOTCODE4 EQU   *                                                SA54959 89725000
         TM    SCBSTATE,SCBLCK1N .      LOCK MODE               SA54959 89730000
         BNO   EOTCODE5 .               BRANCH IF NO            SA54959 89735000
         MVC   PRFSHDR(ONE),ONE(R1) .   INSERT EOT IN BFR       SA54959 89740000
         MVI   PRFSIZE+ONE,PRFSHDR+ONE-PRFSUNIT SET PRFSIZE     SA54959 89745000
         TM    SCBERR4,SCBTXTTN+SCBSLCTN+SCBCONNN              @OY15001 89745700
*                            TEXT,SELECTION OR CONNECT ERROR?  @OY15001 89746400
         BNZ   ERROR2                   YES,SET UNIT EXCEPTION @OY15001 89747100
         TM    SCBERR1,SCBCUTFN         CUTOFF EXECUTED        @OY15001 89747800
         BNO   EOTCODE1                 CONTINUE PROCESSING    @OY15001 89748500
ERROR2   EQU   *                                               @OY15001 89749200
         OI    LCBCSW+CSWST1,UNEX       SET EOT RECEIVED       @OY12280 89750000
         B     EOTCODE1 .               CONTINUE PROCESSING     SA54959 89755000
EOTCODE5 EQU   *                                                SA54959 89760000
         XC    SCBMRFSD(4),SCBMRFSD .   CLEAR MULTI ROUTE       SA54959 89765000
         LA    R1,AVTBFRTB .            BUFFER RETURN QUEUE     SA54959 89770000
         STCM  R1,AD,SCBDESTQ           BUFFER RETURN QCB        Y05330 89775000
         B     EXIT .                   SCRAM                   SA54959 89780000
         SPACE                                                          89785000
TNTSUB   EQU   *                                                 Y05330 89790000
         LH    R1,PRFDEST               DESTINATION OFFSET       Y05330 89795000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF    Y05330 89800000
TNTSUB1  EQU   *                                                 Y05330 89805000
         L     R15,AVTRNMPT             ADDRESS OF TNT           Y05330 89810000
         BR    R15                      LINK TO TNT              Y05330 89815000
         EJECT                                                          89820000
***************************************************************@Y17XAMF 89825000
*        SNA SSCP PROCESSING                                  *@Y17XAMF 89830000
***************************************************************@Y17XAMF 89835000
         SPACE 3                                                        89840000
         USING IEDNSVTD,RSAVT                                  @Y17XAMF 89845000
PROCSSCP EQU   *                                                        89850000
         SR    R15,R15                  SET NOT SSCP RETURN    @Y17XAMF 89855000
         CLC   PRFSRCE,SAVTSCPT         SOURCE THE SSCP        @Y17XAMF 89860000
         BE    PRSSCP                   BRANCH IF YES          @Y17XAMF 89865000
         CLC   PRFDEST,SAVTSCPT         DEST THE SSCP          @Y17XAMF 89870000
         BNE   SSCPRET                  BRANCH IF NO           @Y17XAMF 89875000
PRSSCP   EQU   *                                               @Y17XAMF 89880000
         SR    R1,R1                    CLEAR REG ONE          @Y17XAMF 89885000
         IC    R1,PRFISIZE              GET RESERVE COUNT      @Y17XAMF 89890000
         STC   R1,LCBISZE               SET LCB RESERVE COUNT  @Y17XAMF 89895000
         LA    R1,AVTHDRSZ(R1)          ADD HEADER SIZE        @Y17XAMF 89900000
         STH   R1,PRFSCAN               SET THE SCAN POINTER   @Y17XAMF 89905000
         LA    R1,AVTINOUT              END-OF-PARM-LIST ADDR  @YM05706 89906000
         STCM  R1,AD,SCBMACR            INITIALIZE MACRO PTR   @YM05706 89907000
         OI    SCBQTYPE,SCBNORCL        PREVENT RECALLS        @Y17XAMF 89910000
         TM    LCBSTAT1,LCBSENDN        SENDING?               @Y17XAMF 89915000
         BO    SETTWO                   BRANCH IF SO           @Y17XAMF 89920000
         OI    LCBSTAT2,LCBRESP         SET RESPONSE RQRD      @Y17XAMF 89925000
SETTWO   EQU   *                                               @Y17XAMF 89930000
         LA    R15,TWO                  SET SSCP EXECUTED      @Y17XAMF 89935000
SSCPRET  EQU   *                                               @Y17XAMF 89940000
         BR    R14                      RETURN                 @Y17XAMF 89945000
         EJECT                                                          89950000
***************************************************************@Y17XAMF 89955000
*        SNA LU PROCESSING                                    *@Y17XAMF 89960000
***************************************************************@Y17XAMF 89965000
         SPACE 3                                                        89970000
PROCSNA  EQU   *                                               @Y17XAMF 89975000
         ST    R14,SAV14                SAVE RETURN REG        @Y17XAMF 89980000
         USING IEDPF1,RPREF                                    @Y17XAMF 89985000
         TM    LCBSTAT1,LCBSENDN        SENDING                @Y17XAMF 89990000
         BZ    CKFMDATA                 BRANCH IF NO           @Y17XAMF 89995000
         CLI   PRFPRI,PRIMHBFR-1        ERROR RESPONSE BUFFER  @Y17XAMF 90000000
         BE    SNARET                   BRANCH IF YES          @Y17XAMF 90005000
         XC    PRF1RH(PRF1LEN),PRF1RH   CLEAR TOTAL PREFIX     @Y17XAMF 90010000
         B     SNARET                   BRANCH TO RETURN       @Y17XAMF 90015000
         DROP  RPREF                                           @Y17XAMF 90020000
CKFMDATA EQU   *                                               @Y17XAMF 90025000
         USING IEDRH,RPREF                                     @Y17XAMF 90030000
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER          @YM08571 90030400
         BO    DONTSET                  BRANCH IF NOT HEADER   @YM08571 90030800
         TM    PRF1FLG1-IEDPF1(RPREF),PRF1LOGD  IS THIS BUFFER @YM08571 90031200
*                                       DATA FROM THE LOGON?   @YM08571 90031600
         BO    DONTSET                  BRANCH IF SO           @YM08571 90032000
         OI    LCBSTAT2,LCBRESP         SET RESPONSE RQRD      @YM08571 90032400
DONTSET  EQU   *                                               @YM08571 90032800
         TM    TRHBYTE0,TRHSC           FM DATA?               @YM08571 90033200
         BNZ   CHKDFC                   BRANCH IF NO           @YM08571 90033600
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER          @YM08571 90034000
         BO    SNARET                   BRANCH IF NOT HEADER   @ZM47696 90034400
         LH    R1,PRFSRCE               GET SOURCE             @Y17XAMF 90065000
         N     R1,AVTCLRHI              CLEAR HI-ORDER BYTES   @Y17XAMF 90070000
         L     R15,AVTRNMPT             LOAD TNT ADDR          @Y17XAMF 90075000
         BALR  R14,R15                  CALL TNT ROUTINE       @Y17XAMF 90080000
         SH    RTRM,TPREFIX             ADDR NEG PREFIX        @Y17XAMF 90085000
         USING IEDNTRM,RTRM                                    @Y17XAMF 90090000
         SR    RSIB,RSIB                CLEAR SIB REG          @Y17XAMF 90095000
         ICM   RSIB,ADDR,TRMSIBPT       GET THE FIRST SIB      @Y17XAMF 90100000
         USING IEDSIBD,RSIB                                    @Y17XAMF 90105000
         BZ    SNARET                   BRANCH IF NO SIB       @Y17XAMF 90110000
CHKSIB   EQU   *                                               @Y17XAMF 90115000
         CLC   PRFDEST,SIBINDEX         CORRECT SIB            @Y17XAMF 90120000
         BNE   SNARET                   BRANCH IF NO           @Y17XAMF 90125000
         CLC   SIBINDEX,SAVTMHDX        INBOARD LU A TPROCESS  @Y17XAMF 90130000
         BNL   SNARET                   BRANCH IF NO           @YM06113 90135000
         DROP RTRM                                             @Y17XAMF 90140000
         LH    R1,SIBINDEX              GET TNT INDEX OF TPQ   @Y17XAMF 90145000
         N     R1,AVTCLRHI              CLEAR HI-ORDER BYTES   @Y17XAMF 90150000
         L     R15,AVTRNMPT             LOAD TNT ROUTINE ADDR  @Y17XAMF 90155000
         BALR  R14,R15                  CALL TNT ROUTINE       @Y17XAMF 90160000
         USING IEDQTRM,RTRM                                    @Y17XAMF 90165000
         MVC   SCBDESTQ,TRMDESTQ        SET DEST QUEUE ADDR    @Y17XAMF 90170000
         TM    AVTBIT3,AVTRECVN+AVTRFULN                       @Y17XAMF 90175000
*                                       ANY NO RECEIVE CONDX   @Y17XAMF 90180000
         BZ    SNARET                   BRANCH IF NO           @Y17XAMF 90185000
         DROP  RSIB                                            @Y17XAMF 90190000
         L     RTQCB,TRMDESTQ-1         LOAD QCB ADDR          @Y17XAMF 90195000
         USING IEDQQCB,RTQCB                                   @Y17XAMF 90200000
         TM    QCBDSFLG,QCBNREUS        NON-REUS QUEUEING      @Y17XAMF 90205000
         BO    SNARET                   BRANCH IF YES          @Y17XAMF 90210000
         TM    AVTBIT3,AVTRFULN         REUS QUEUE FULL        @Y17XAMF 90215000
         BZ    CHKCORE                  BRANCH IF NO           @Y17XAMF 90220000
         TM    QCBDSFLG,QCBREUS         REUS QUEUEING          @Y17XAMF 90225000
         BO    NOROUTE                  BRANCH IF YES          @Y17XAMF 90230000
CHKCORE  EQU   *                                               @Y17XAMF 90235000
         TM    AVTBIT3,AVTRECVN         CORE QUEUE FULL        @Y17XAMF 90240000
         BZ    SNARET                   BRANCH IF NO           @Y17XAMF 90245000
         TM    QCBDSFLG,QCBREUS+QCBNREUS                       @Y17XAMF 90250000
*                                       ANY DISK QUEUEING      @Y17XAMF 90255000
         BNZ   SNARET                   BRANCH IF YES          @Y17XAMF 90260000
NOROUTE  EQU   *                                               @Y17XAMF 90265000
         OI    SCBERR2,SCBFRWDN         INDIC FWD ERROR        @YM06894 90266000
         OI    SCBERR3,SCBTHRSN         INDIC THRESH ERR       @YM06894 90267000
         LA    R15,AVTBFRTB             LOAD ADDR OF BUFF RET  @Y17XAMF 90270000
         STCM  R15,ADDR,SCBDESTQ        RESET ROUTING TO BF RT @Y17XAMF 90275000
         DROP  RTQCB                                           @Y17XAMF 90280000
         LH    R1,AVTDLQX               GET DLQ TTCIN          @YM06894 90280600
         LTR   R1,R1                    IS THERE A DLQ?        @YM06894 90281200
         BZ    SNARET                   NO                     @YM06894 90281800
         L     R15,AVTRNMPT             GET TTE CONVERT PTR    @YM06894 90282400
         BALR  R14,R15                  GO CONVERT TO TTE ADDR @YM06894 90283000
         USING IEDQTRM,RTRM             ESTAB. ADDRESSABILITY  @YM06894 90283600
         MVC   SCBDESTQ,TRMDESTQ        SET DLQ AS DEST QCB    @YM06894 90284200
         B     SNARET                   BRANCH TO RETURN       @Y17XAMF 90285000
************************************************************** @Y17XAMF 90290000
*        DFC PROCESSING                                      * @Y17XAMF 90295000
************************************************************** @Y17XAMF 90300000
CHKDFC   EQU   *                                               @Y17XAMF 90305000
         TM    TRHBYTE0,TRHDFC          DFC     COMMAND        @Y17XAMF 90310000
         BZ    SNARET                   BRANCH IF NO           @Y17XAMF 90315000
         TM    TRHBYTE0,TRHSC           SC COMMAND             @Y17XAMF 90320000
         BO    SNARET                   BRANCH IF YES          @Y17XAMF 90325000
         LR    R9,RQCB7                 SET STATRMH QCB REG    @Y17XAMF 90335000
         SH    R9,SPREFIX               SET TO STARTMH QCB     @Y17XAMF 90340000
*                                       NEG PREFIX             @Y17XAMF 90345000
         TM    STMHFLG0-IEDNSTMH(R9),STMHDFC DFC SUPPORT       @Y17XAMF 90350000
         BZ    CHKPART                  BRANCH IF NO           @Y17XAMF 90355000
         CLC   LCBLUSNS,NOTSUPP         SUPPORTED COMMAND      @Y17XAMF 90360000
         BNE   SNARET                   BRANCH IF YES          @Y17XAMF 90365000
         BAL   R14,SETBD                CALL IEDQBD POST SET   @Y17XAMF 90370000
         B     POSTRET                  BRANCH TO RETURN       @Y17XAMF 90375000
CHKPART EQU    *                                               @Y17XAMF 90380000
         TM    STMHFLG0-IEDNSTMH(R9),STMHDFCP  PARTIAL DFCF    @Y17XAMF 90385000
         BO    PROCPART                 BRANCH IF YES          @Y17XAMF 90390000
         BAL   R14,SETBD                CALL IEDQBD POST ROUT  @Y17XAMF 90395000
         B     POSTRET                  BRANCH TO RETURN       @Y17XAMF 90400000
PROCPART EQU   *                                               @Y17XAMF 90405000
         SR    R9,R9                    CLEAR REG NINE         @Y17XAMF 90410000
         IC    R9,PRFISIZE              GET RESERVE COUNT      @Y17XAMF 90415000
         LA    R9,AVTHDRSZ+AVTUMALN(R9) ADD HEADER SIZE        @Y17XAMF 90420000
         AR    R9,RPREFIX               POINT TO FIRST CHAR    @Y17XAMF 90425000
         TM    TRHBYTE0,TRHSDI          EXCEPTION REQUEST      @Y17XAMF 90430000
         BZ    NOTEXR                   BRANCH IF NO           @Y17XAMF 90435000
         LA    R9,L'SNSSYSTM+L'SNSUSER(R9) POINT TO FIRST CHAR @Y17XAMF 90440000
NOTEXR   EQU   *                                               @Y17XAMF 90445000
         CLI   0(R9),CD1SIG             SIGNAL DFC CMD         @Y17XAMF 90450000
         BE    SNARET                   BRANCH IF YES          @Y17XAMF 90455000
         CLI   0(R9),CD1RTR             RTR DFC CMD            @Y17XAMF 90460000
         BE    SNARET                   BRANCH IF YES          @Y17XAMF 90465000
         CLI   0(R9),CD1LSTAT           LUSTAT DFC CMD         @Y17XAMF 90470000
         BE    SNARET                   BRANCH IF YES          @Y17XAMF 90475000
         BAL   R14,SETBD                CALL IEDQBD POST ROUT  @Y17XAMF 90480000
         B     POSTRET                  BRANCH TO RETURN       @Y17XAMF 90485000
SNARET   EQU   *                                               @Y17XAMF 90490000
         SR    R15,R15                  SET NO POST RETURN     @Y17XAMF 90495000
POSTRET  EQU   *                                               @Y17XAMF 90500000
         L     R14,SAV14                RESET RETURN REG       @Y17XAMF 90505000
         BR    R14                      RETURN                 @Y17XAMF 90510000
         SPACE 3                                                        90515000
SETBD    EQU   *                                               @Y17XAMF 90520000
         MVC   LCBISZE,PRFISIZE         SET # IDLES            @YM07011 90522000
         L     R15,AVTMSGS-1            LOAD VCON LIST ADDR    @Y17XAMF 90525000
         L     R15,AVTEZERO(R15)        LOAD IEDQBD ADDR       @Y17XAMF 90530000
         STCM  R15,ADDR,PRFQCBA         SET QCB ADDR           @Y17XAMF 90535000
         MVI   PRFPRI,PRIDSPLB          SET IEDQBD PRIORITY    @Y17XAMF 90540000
         BR    R14                      RETURN                 @Y17XAMF 90545000
         DROP  RPREF                                           @Y17XAMF 90550000
         DROP  RSAVT                                           @Y17XAMF 90555000
         EJECT                                                          90560000
         SPACE 3                                                 Y05330 90565000
********* CONSTANTS *********                                           90570000
         SPACE                                                          90575000
SAV14    DS    F                        REGISTER SAVE          @Y17XAMF 90580000
         DS    0H                       FOLLOWING FIELDS MUST  @Y17XAMF 90585000
*                                        BE ON HALFWORD BDY    @Y17XAMF 90590000
PREFIX   DC    AL2(PRF1LEN)             LENGTH OF BUFFER PREFIX@Y17XAMF 90595000
TPREFIX  DC    AL2(TRMPRFSZ)            LENGTH OF TERMINAL PREF@Y17XAMF 90600000
SPREFIX  DC    AL2(STMHNLEN)            LENGTH OF STARTMH PREF @Y17XAMF 90605000
CONMAX   DC    H'9999'                  MAXIMUM SEQUENCE NUMBER         90610000
CONBASE  DC    H'4096'                  INCREMENT VALUE FOR             90615000
*                                         MULTIPLE BASE REGISTERS       90620000
NOTSUPP  DC    X'10030000'              FUNCTION NOT SUPPORTED @Y17XAMF 90625000
         EJECT                                                          91280000
********* DSECTS *********                                              91360000
         SPACE                                                          91440000
         TAVTD                                                          91520000
         EJECT                                                          91680000
         DCBD  DSORG=TX                                                 91760000
         EJECT                                                          91840000
         TDCTD                                                 @YM06159 91860000
         EJECT                                                 @YM06159 91880000
         TDEBD                                                          91920000
         EJECT                                                          92080000
         TDISPD                                                         92160000
         EJECT                                                          92240000
         TLCBD                                                          92320000
         EJECT                                                          92480000
         TPRFD                                                          92560000
         EJECT                                                          92640000
         TPRIOR                                                         92720000
         EJECT                                                          92770000
         TPROCD                                                         92820000
         EJECT                                                          92880000
         TQCBD                                                          92960000
         EJECT                                                          93040000
         TSCBD                                                          93120000
CPBQTYPE EQU   X'03'                    RRN QUEUING MEDIA FLAGS SA52971 93200000
         EJECT                                                          93280000
         TTRMD                                                          93360000
         EJECT                                                          93440000
         IEFUCBOB                                                       93520000
         EJECT                                                          93610000
         TLGBD ,                                                 S22024 93640000
         EJECT                                                 @Y17XAMF 94140000
         TCD1D                                                 @Y17XAMF 94640000
         EJECT                                                 @Y17XAMF 95140000
         TRHD                                                  @Y17XAMF 95640000
         EJECT                                                 @Y17XAMF 96140000
         TSIBD                                                 @Y17XAMF 96640000
         EJECT                                                 @Y17XAMF 97140000
         TSTMHND                                               @Y17XAMF 97640000
         EJECT                                                          98140000
         TSNSD                                                 @Y17XAMF 98640000
         EJECT                                                          98690000
         CVT    DSECT=YES                                               98740000
         EJECT                                                          98790000
         IKJTSCVT                                                       98840000
         EJECT                                                          98890000
         IHAASVT                                               @ZM46751 98940000
         EJECT                                                          98940200
         IHAASCB                                               @ZM46751 98940400
         EJECT                                                          98990000
         IKJTSB LIST=YES                                                99040000
         END                                                            99140000
