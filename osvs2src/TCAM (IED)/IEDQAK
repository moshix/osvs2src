AK01     TITLE '''IEDQAK'' - LINE CONTROL INSERTION ROUTINE'            00100022
IEDQAK   CSECT                                                          00110022
         SPACE 3                                                        00120022
*CHANGE-ACTIVITY = AS FOLLOWS:                                          00130022
******************** MICROFICHE FLAGS *********************** SUPT CODE 00140022
*                                                                       00150022
*A383490                                                         S21903 00200022
*D337000,339210,342570-343300                                    S22026 00200122
*C339140,342220-342520,343060-343260                             S22026 00200222
*A322300-322700,339180-339220,339430-339460,340970-341000        S22026 00200322
*A342860-342900,343500-343860,370100-370900,371500               S22026 00200422
*A442100-442600,444500,660500                                    S22026 00200522
*A257500,263500,269500,301000-301960,323200-323600,324500        S22025 00200622
*A333630-333930,334500,339422-339426,339930-339950,343220-343382 S22025 00200722
*A343500-343680,378300-378600,382009-384300,386300-386600,387500 S22025 00200822
*A389300-389600,408300-408600,419050-420900,510500,513500        S22025 00200922
*A514300-514600,517500,542500,556100-556800,622200-622600,657400 S22025 00201022
*A660100-664800,671780-671828                                    S22025 00201122
*C002016-002532,002720,002880,308000,338000,397000,446000,474000 S22025 00201222
*C485000-486000,660200                                           S22025 00201322
*D002584-002608,002652-002712,002724-002792,002884-002900        S22025 00201422
*D336000-337000,420000,657000,661000-664000                      S22025 00201522
*D333100-333600,656090-656900                                   SA58444 00201622
*A495000                                                        SA60007 00201722
*D380100-380500,495000-495900                                   SA60007 00201822
*A380050-380900,490500                                          SA64787 00201954
*C495000-500000,503000,507000-508000                            SA64787 00202054
*A420800,420850                                                 SA67120 00202105
*D513500,517500,542500                                         @SA64367 00202256
*A652000                                                       @SA62342 00202381
*A338600                                                       @SA74020 00203309
*C343298                                                       @SA74051 00204309
*C343298,A420740,D420820                                       @SA74884 00205309
*A343302,C343310,D343316-343320,C343322,C343330                @SA74884 00206309
*D652100-652700                                                @OX12569 00207300
*C356000                                                       @Y17XAMG 00208300
*$01=OZ42071  JTC2202  79.11.15  726652                            @01A 00209227
*$21=OZ55118  JTC2412  81.10.22  460025: LOST MSG AND WAIT         @21A 00210127
* $R1=ZM30946 JTC2412  82.03.04  613706: RESERVES FROM LCBISZE     @R1A 00210527
*********************************************************************** 00211012
* $MOD(IEDQAK) COMP(M@) PROD(TCAM):                                @01A 00211212
*                                                                     * 00211422
*  DESCRIPTIVE NAME = LINE CONTROL INSERTION ROUTINE                  * 00211622
*                                                                     * 00211822
*  COPYRIGHT = 'NONE'                                                 * 00212022
*                                                                     * 00212222
*  STATUS:  CHANGE LEVEL 5                                            * 00212454
*                                                                     * 00212622
*  FUNCTION:  THIS MODULE PERFORMS THREE FUNCTIONS                    * 00212822
*                                                                     * 00213822
*   1. FOR INPUT OPERATIONS ONLY, THIS ROUTINE DELETES A CHARAC- S22025 00214822
*      TER STRING WHEN IT APPEARS AT A GIVEN INTERVAL IN A       S22025 00215822
*      MESSAGE.  THIS ROUTINE LINKS TO IEDQAL TO SCAN FOR THE    S22025 00216822
*      CHARACTER STRING AT FIXED INTERVALS.  IF THE CHARACTER    S22025 00217822
*      STRING IS FOUND, THIS ROUTINE LINKS TO IEDQAF TO DELETE   S22025 00218822
*      THE STRING BY CONTRACTING DATA.  IF THE STRING APPEARS TO S22025 00219822
*      CROSS BUFFER BOUNDARIES, THIS ROUTINE COPIES THE PART OF  S22025 00220822
*      THE STRING FOUND FROM THE CURRENT BUFFER TO A NEW ONE.    S22025 00221822
*      THE CURRENT BUFFER IS SHORTENED TO EXCLUDE THE PARTIAL    S22025 00222822
*      STRING AND THE NEW BUFFER IS PUT ON A HOLD QUEUE.  THE    S22025 00223822
*      PARTIAL STRING REMAINS ON THE HOLD QUEUE UNTIL A SUBSE-   S22025 00224822
*      QUENT BUFFER IS RECEIVED FOR THE CURRENT MESSAGE.  THE    S22025 00225822
*      PARTIAL STRING IS INSERTED INTO THE BEGINNING OF THE      S22025 00226822
*      SUBSEQUENT BUFFER BY IEDQBN.                              S22025 00227822
*   2. FOR OUTPUT OPERATIONS ONLY, THIS ROUTINE OPTIONALLY IN-   S22025 00228822
*      SERTS LINE CONTROL CHARACTERS AT FIXED INTERVALS.  IF THE S22025 00229822
*      DESTINATION IS A BISYNC DEVICE, A 'STX' IS INSERTED       S22025 00230822
*      IN THE BEGINNING OF THE MESSAGE.  IF THE DESTINATION IS A S22025 00231822
*      NON-BYSYNC DEVICE WITH AN EOA SEQUENCE, IT IS INSERTED    S22025 00232822
*      IN THE BEGINNING OF THE MESSAGE.  FOR ALL DESTINATIONS,   S22025 00233822
*      AN EOT SEQUENCE IS ADDED TO THE END OF THE MESSAGE.  END- S22025 00234822
*      OF-BLOCK SEQUENCES AND SUBBLOCK DELIMITERS ARE OPTIONALLY S22025 00235822
*      INSERTED AT FIXED INTERVALS AS SPECIFIED BY THE USER.     S22025 00236822
*   3. OR, FOR OUTPUT ONLY, THIS ROUTINE REFORMATS OUTGOING      S22025 00237822
*      MESSAGES INTO VARIABLE LENGTH BLOCKS.  STX,EOA,AND EOT    S22025 00238822
*      SEQUENCES ARE INSERTED AS DESCRIBED ABOVE.  FOR VARIABLE  S22025 00239822
*      LENGTH REBLOCKING, THE USER SPECIFIES THE NUMBER OF SUB-  S22025 00240822
*      BLOCKS HE DESIRES PER BLOCK.  THIS ROUTINE SCANS THE      S22025 00241822
*      MESSAGE FOR SUBBLOCK DELIMITERS AND INSERTS END-OF-BLOCK  S22025 00242822
*      SEQUENCES APPROPRIATELY.  THIS FUNCTION REQUIRES THAT     S22025 00243822
*      SUBBLOCK DELIMITERS ALREADY BE IN THE MESSAGE DATA.       S22025 00244822
*                                                                     * 00253620
*ENTRY POINTS --                                                      * 00254020
*       'IEDQAK01' TO INSERT LINE CONTROL IN AN OUTGOING BUFFER.      * 00254420
*   CALLING SEQUENCE FROM USER INTERFACE IS:                          * 00254820
*                                                                     * 00255220
*        L     R12,AVTMSGS-1            GET ADDR OF VCON TABLE        * 00255620
*        IC    R15,AVTEZERO(,R1)        GET INDEX TO ROUTINE ADDR     * 00256020
*        L     R12,AVTEZERO(R12,R15)    GET ROUTINE ADDRESS           * 00256420
*        BR    R12                      EXIT TO ROUTINE               * 00256820
*                                                                     * 00257220
*INPUT --                                                             * 00257620
*   REGISTER 1 - THE ADDRESS OF A MACRO-GENERATED PARAMETER LIST.     * 00258020
*                                                                     * 00261220
*   REGISTER 3 - THE ADDRESS OF THE SCB.                              * 00261620
*                                                                     * 00262020
*   REGISTER 4 - THE ADDRESS OF THE LCB.                              * 00262420
*                                                                     * 00262820
*   REGISTER 9 - THE ADDRESS OF THE AVT.                              * 00263220
*                                                                     * 00263620
*   REGISTER 12 - ENTRY POINT ADDRESS AND BASE REGISTER FOR THIS      * 00264020
*   ROUTINE.                                                          * 00264420
*                                                                     * 00264820
*                                                                     * 00271620
*OUTPUT -- NONE                                                  S22025 00272022
*                                                                     * 00279620
*EXTERNAL REFERENCES --                                               * 00280020
*   'IEDQAF' - INSERT DATA ROUTINE.                                   * 00280420
*   'IEDQAO' - UNIT REQUEST INTERFACE                            S22025 00280922
*   'IEDQA4' - INMSG/OUTMSG ROUTINE                              S22025 00281422
*   'IEDQUI' - USER INTERFACE ROUTINE                            S22025 00281922
*   'IEDQAL' - SCAN AT OFFSET ROUTINE                            S22025 00282422
*   'IEDQBN' - ATTACH DATA ROUTINE                               S22025 00282922
*   'IEDQAX' - SCAN ROUTINE                                      S22025 00283422
*   AVT - ADDRESS VECTOR TABLE                                   S22025 00283922
*   BUFFER CURRENTLY BEING PROCESSED                             S22025 00284422
*   LCB - LINE CONTROL BLOCK                                     S22025 00284922
*   SCB - STATION CONTROL BLOCK                                  S22025 00285422
*   DCB - DATA CONTROL BLOCK                                     S22025 00285922
*   SCT - SPECIAL CHARACTERS TABLE                               S22025 00286422
*                                                                     * 00287220
*EXITS,  NORMAL --                                                    * 00287620
*   RETURN TO THE MESSAGE HANDLER FOR FURTHER PROCESSING.        S22025 00288022
*                                                                     * 00290420
*EXITS,  ERROR -- N/A.                                                * 00290820
*                                                                     * 00291220
*TABLES/WORK AREAS -- N/A.                                            * 00291620
*                                                                     * 00292020
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, ENABLED, RESIDENT,     * 00292420
*   PROBLEM PROGRAM MODE.                                             * 00292820
*                                                                     * 00293220
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON AN        * 00293620
*   INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET.            * 00294020
*                                                                     * 00294420
*********************************************************************** 00294820
         EJECT                                                          24900020
         SPACE                                                          25000020
********* REGISTER EQUATES **********                                   25100020
         SPACE                                                          25200020
R0       EQU   0                        WORK REGISTER                   25300020
         SPACE                                                          25400020
R1       EQU   1                        PARAMETER LIST ADDRESS          25500020
         SPACE                                                          25600020
RWORK2   EQU   2                        WORK REGISTER                   25700020
RCOUNT   EQU   2                                                 S22025 25750022
         SPACE                                                          25800020
RSCB3    EQU   3                        SCB ADDRESS                     25900020
         SPACE                                                          26000020
RLCB4    EQU   4                        LCB ADDRESS                     26100020
         SPACE                                                          26200020
RDATAD   EQU   5                        DATA OFFSET REGISTER            26300020
RSCAN    EQU   5                        SCAN PTR ADDR            S22025 26350022
         SPACE                                                          26400020
RPREFIX  EQU   6                        BUFFER ADDRESS                  26500020
         SPACE                                                          26600020
RSCT7    EQU   7                        SCT ADDRESS                     26700020
         SPACE                                                          26800020
RLIM8    EQU   8                        SHIFT LIMIT REGISTER            26900020
RICR     EQU   8                                                 S22025 26950022
         SPACE                                                          27000020
RAVT9    EQU   9                        AVT ADDRESS                     27100020
         SPACE                                                          27200020
RWORK10  EQU   10                       WORK REGISTER                   27300020
         SPACE                                                          27400020
RSIZE    EQU   11                       SIZE REGISTER                   27500020
         SPACE                                                          27600020
RBASE    EQU   12                       BASE REGISTER                   27700020
         SPACE                                                          27800020
R13      EQU   13                       SAVE AREA ADDRESS               27900020
R14      EQU   14                       TCAM RETURN REGISTER            28000020
R15      EQU   15                       TCAM BRANCH REGISTER            28100020
         SPACE                                                          28200020
********* OTHER EQUATES **********                                      28300020
         SPACE                                                          28400020
PARMAF   EQU   2                        INSERT DATA ROUTINE INDEX       28500020
         SPACE                                                          28700020
INSOFF   EQU   4                        PREFIX INSERT OFFSET            28800020
DATOFF   EQU   6                        PREFIX DATA OFFSET              28900020
         SPACE                                                          29000020
SCTEOA   EQU   1                        SCT INDEX BYTE TO EOA           29100020
SCTPAD   EQU   3                       SCT INDEX TO IDLE CHAR    S99528 29150022
SCTEOB   EQU   18                       SCT INDEX BYTE TO EOB           29200020
SCTITB   EQU   19                       SCT INDEX BYTE TO ITB           29300020
SCTEOT   EQU   20                       SCT INDEX BYTE TO EOT           29400020
         SPACE                                                          29500020
INDEXA4  EQU   4                        INMSG/OUTMSG ROUTINE INDEX      29600020
         SPACE                                                          29700020
ONE      EQU   1                        INCREMENT VALUE OF ONE          29800020
TWO      EQU   2                        LENGTH OF A HALFWORD            29900020
THREE    EQU   3                        OFFSET INTO DEV CHAR ENTRY      30000020
FOUR     EQU   4                        OFFSET IN SAVE AREA      S22025 30100022
INDEXBN  EQU   4                        INDEX TO IEDQBN          S22025 30108022
BSIZE    EQU   2                        OFFSET TO BLOCKSIZE      S22025 30116022
CHAR     EQU   12                                                S22025 30124022
CHARL    EQU   12                                                S22025 30132022
PARMSTAT EQU   5                                                 S22025 30140022
OPTFLD   EQU   1                                                 S22025 30148022
AEOFF    EQU   12                                                S22025 30156022
TWFOUR   EQU   24                                                S22025 30164022
FIVE     EQU   5                                                 S22025 30172022
NINE     EQU   9                                                 S22025 30180022
EIGHT    EQU   8                                                 S22025 30188022
MVOFF    EQU   16                                                S22025 30192022
CONTR    EQU   X'20'                    DATA CONTRACTION         S22025 30194022
BFREDIT  EQU   X'40'                    DATA MOVEMENT FLAG       S22025 30195022
LEN      EQU   19                                                S22025 30196022
         SPACE                                                          30200020
ZERO     EQU   8                        CONDITION CODE: ZEROES          30300020
NOTPOS   EQU   13                       CONDITION CODE: NOT PLUS        30400020
EQUAL    EQU   8                        CONDITION CODE: EQUAL           30450020
         SPACE                                                          30500020
FLAG2760 EQU   X'01'                    IBM 2760 DEVICE FLAG            30600020
FLAG226R EQU   X'02'                    IBM 2260 REMOTE DEVICE FLAG     30700020
INSRTCHK EQU   X'80'                    MASK USED TO CHECK IF    S22025 30760022
*                                       ANY INSERTS DONE         S22025 30820022
         SPACE                                                          30900020
REG1OFF  EQU   X'18'                    OFFSET TO R1 IN SAVE AREA       31000020
EXTCHAR  EQU   X'03'                   EXT LINE CONTROL CHAR     S99528 31030022
STXCHAR  EQU   X'02'                    STX LINE CONTROL CHAR    S99528 31060022
         EJECT                                                          31100020
         USING IEDQAK01,RBASE                                           31200020
         USING IEDQAVTD,RAVT9                                           31300020
         USING IEDQLCB,RLCB4                                            31400020
         USING IEDQPRF,RPREFIX                                          31500020
         USING IEDQSCB,RSCB3                                            31600020
         SPACE                                                          31700020
IEDQAK01 EQU   *                                                        31800020
IEDQAK   IEDHJN LCINSERT                                         S22025 31900022
         TM    SCBQTYPE,SCBCONC         SCB FOR A CONCENTRATOR   S22026 32230022
         BZ    NOCONC                   NO,GOAHEAD               S22026 32240022
         L     RSCB3,LCBSCBDA-1         YES GET CONCENTRATOR SCB S22026 32250022
         OI    SCBQTYPE,SCBCONC         SET TEMP FLAG IN CONC SCBS22026 32260022
NOCONC   EQU   *                                                 S22026 32270022
         TM    SCBSTATE,SCBMGFMN        IS LC INSERTION REQUESTED       32300020
         BO    OUTPUT                   YES                      S22025 32320022
         SPACE 2                                                        32340022
         TM    LCBSTAT1,LCBRECVN        MSGFORM ON INPUT         S22025 32360022
         BNO   EXIT2                    NO, EXIT IMMEDIATELY            32400020
OUTPUT   EQU   *                                                 S22025 32450022
         SPACE                                                          32500020
         LH    RSIZE,PRFSIZE            PICK UP BUFFER SIZE             32600020
         N     RSIZE,AVTCLRHI           IS THIS A ZERO-LNG BUFFER       32700020
         BNZ   INITIALZ                 NO, PROCEED                     32800020
         SPACE                                                          32900020
         STH   RSIZE,SCBEOBAC           YES, CLEAR SCB FIELD            33000020
         B     EXIT2                      AND EXIT IMMEDIATELY          33100020
         SPACE                                                          33200020
INITIALZ EQU   *                                                        33300020
         TM    LCBSTAT1,LCBRECVN        MSGFORM ON INPUT         S22025 33363022
         BNO   INITIAL3                 NO                       S22025 33366022
         LR    RWORK2,R1                SAVE AK'S PARMLIST       S22025 33372022
         LA    R1,INDEXBN(,R1)          BUMP TO BN'S LIST        S22025 33375022
         L     R15,AVTUI                GET INTERFACE ROUTINE    S22025 33378022
         BALR  R14,R15                  SCAN QUEUE FOR LEFTOVER  S22025 33381022
         L     RPREFIX,AVTADBUF         RESTORE ORIGINAL BUFFER  S22025 33382022
         LH    R15,PARMAF(,R1)          GET AF/AO                S22025 33384022
         LR    R1,RWORK2                RESTORE AK'S PARM LIST   S22025 33387022
         MVC   PRFKEY(TWO),SCBEOBAC     SAVE DLIST COUNT         S22025 33387722
         MVC   SCBEOBAC(TWO),SCBEOBSZ   GET ACCUM COUNT          S22025 33388422
         MVC   SCBEOBSZ(TWO),BSIZE(R1)  GET BLOCK SIZE           S22025 33389122
         B     INITIAL4                 SAVE AF/AO IN AVT        S22025 33390022
*                                                                       33391022
INITIAL3 EQU   *                                                 S22025 33393022
         LH    R15,PARMAF(,R1)          GET IEDQAF/IEDQAO INDICES       33400020
INITIAL4 EQU   *                                                 S22025 33450022
         STH   R15,AVTPARM+2            SAVE THEM IN AVT PARM LIST      33500020
         OI    INSOFF(RPREFIX),INSRTCHK INITIALIZE FIELD TO SHOW S22025 33600022
*                                       NO INSERTS DONE YET      S22025 33700022
         L     RSCT7,LCBDCBPT           GET ADDRESS OF DCB              33820020
         USING IHADCB,RSCT7                                             33840020
         L     RSCT7,DCBSCTAD-1         GET SCT ADDRESS FROM DCB        33860020
         LA    RSCT7,AVTEZERO(RSCT7)    CLR THE HI-ORDER BITS  @SA74020 33870009
         LTR   RSCT7,RSCT7              EXIT IMMED. IF MSG IS  @SA74020 33880009
         BZ    EXIT2                    FOR AN APPLICATION PGM @SA74020 33890009
         SPACE                                                          33900020
TESTRCL  EQU   *                                                        33907020
         TM    PRFSTAT1,PRFNHDRN+PRFCNCLN                        S22026 33914022
*                                       TEXT OR RECALLED         S22026 33918022
         BZ    TESTSTX                  BRANCH IF NO             S22026 33922022
         SPACE                                                          33928020
         TM    PRFSTAT1,PRFCNCLN        IS IT RECALLED                  33935020
         BNO   TESTLC                   NO, GO INSERT LINE CONTROL      33942020
         LH    R0,SCBEOB                GET EOB OFFSET           S22025 33942222
         TM    LCBSTAT1,LCBRECVN        RECEIVING                S22025 33942422
         BO    SETAC                    YES, GO DELETE           S22025 33942622
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 33943022
         BO    NEWBACS                  BRANCH IF YES            S22026 33944022
         TM    PRFSTAT1,PRFNHDRN        TEXT BUFFER              S22026 33945022
         BZ    TESTSTX                  BRANCH IF NO             S22026 33946022
         SPACE                                                          33949020
NEWBACS  EQU   *                                                        33956020
         SPACE 2                                              T  S22025 33960022
         LA    RWORK2,SCTEOB            REQUEST EOB ADDRESS             33963020
         SR    R15,R15                  SET CONDITION CODE = 8          33970020
         BAL   R14,GETSCTAD             LINK TO GET EOB ADDRESS         33977020
         SPACE                                                          33984020
         IC    R15,AVTEZERO(,RWORK2)    PICK UP LENGTH OF EOB           33991020
         NC    SCBEOBSZ(2),SCBEOBSZ     BLOCK SIZE SPECIFIED     S22025 33993022
         BZ    SCNLOOP                  NO, MUST BE ON COUNT     S22025 33995022
         LH    R1,SCBEOBSZ              LOAD INTERVAL                   33998020
         N     R1,AVTCLRHI                BETWEEN EOBS                  34005020
         LA    RWORK2,AVTEZERO(R1,R15)  GET BLOCK LENGTH IF NO ITBS     34012020
         SPACE                                                          34019020
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED         34026020
         BE    BLOCKNUM                 NO, GO FIGURE NO. OF BLOCKS     34033020
         SPACE                                                          34040020
         SR    R0,R0                    (CLEAR FOR DIVIDE)              34047020
         LR    R14,R0                   (CLEAR FOR INSERT)              34054020
         IC    R14,SCBITBSZ             SET ITB INTERVAL AS DIVISOR     34061020
         DR    R0,R14                   GET NO. OF ITBS                 34068020
         BCTR  R1,AVTEZERO                IN EACH BLOCK                 34075020
         AR    RWORK2,R1                GET BLOCK LENGTH WITH ITBS      34082020
         SPACE                                                          34089020
BLOCKNUM EQU   *                                                        34096020
         LH    R0,SCBEOB                OFFSET TO DATA           S22026 34097022
         AH    R0,SCBEOBAC              COMPUTE EOB OFFSET       S22026 34098022
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 34099022
         BO    CHKITB                   BRANCH IF YES            S22026 34100022
         LH    R0,SCBEOB                LOAD OFFSET                     34103020
         N     R0,AVTCLRHI                LAST GOOD EOB                 34110020
         LA    R1,AVTTXTSZ              GET SIZE OF PREFIX              34140020
         SR    R0,R1                    COMPUTE DATA LENGTH             34180020
         BCTR  R0,AVTEZERO                BEFORE LAST GOOD EOB          34187020
         LR    R1,R0                    RELOAD FOR DIVIDE               34194020
         SR    R0,R0                    (CLEAR FOR DIVIDE)              34201020
         DR    R0,RWORK2                COMPUTE NO. BLOCKS BEFORE       34208020
*                                         LAST GOOD EOB                 34215020
CHKITB   EQU   *                                                 S22026 34222022
         LR    R15,R0                   SAVE EOB OFFSET          S22026 34232022
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED  S22026 34242022
         BE    SETEOBAC                 BRANCH IF NO             S22026 34252022
         LR    R1,R0                    RELOAD FOR DIVIDE               34278020
         SR    R0,R0                    (CLEAR FOR DIVIDE)              34285020
         IC    R0,SCBITBAC              ITB OFFSET               S22026 34286022
         AH    R0,SCBEOB                COMPUTE ITB OFFSET       S22026 34287022
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 34288022
         BO    SETITBAC                 BRANCH IF YES            S22026 34289022
         SR    R0,R0                    ZERO REG                 S22026 34290022
         LA    R14,ONE(,R14)            GET SUBBLOCK LENGTH             34292020
         DR    R0,R14                   COMPUTE NO. SUBBLOCKS           34299020
         SR    R15,R1                   COMPUTE EOB OFFSET       S22026 34306022
SETITBAC EQU   *                                                 S22026 34308022
         STC   R0,SCBITBAC              SET ITB OFFSET           S22026 34310022
         STH   R0,PRFITBAC              SET ITB OFFSET           S22026 34312022
SETEOBAC EQU   *                                                 S22026 34314022
         STH   R15,SCBEOBAC             SET EOB OFFSET           S22026 34316022
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 34318022
         BO    TESTSTX                  BRANCH IF YES            S22026 34320022
         B     TESTLC                   INSERT LINE CONTROL      S22025 34322022
SCNLOOP  EQU   *                        SCAN BUFFER              S22025 34322922
         SR    RCOUNT,RCOUNT            CLEAR                    S22025 34323822
         IC    RCOUNT,LCBISZE           GET NUMBER OF RESERVES   S22025 34324722
         LA    RCOUNT,AVTTXTSZ+1(,RCOUNT)     ADD PREFIX     S   S22025 34325622
         STH    RCOUNT,DATOFF(,RPREFIX) SET INITIAL OFFSET       S22025 34326522
         LR    RDATAD,R15               SAVE LENGTH OF EOB       S22025 34327622
         BCTR  RDATAD,R0                GET NUMBER OF ADDITIONAL S22025 34327822
*                                       BYTES PER EOB            S22025 34328022
         SR    RCOUNT,RCOUNT            CLEAR FOR COUNT          S22025 34328222
         SR    RICR,RICR                CLEAR FOR INCREMENT      S22025 34328422
         SR    RSIZE,RSIZE              CLEAR FOR MAX COUNT      S22025 34328622
         STC   RCOUNT,SCBBCTR           RESET ACCUM COUNT        S22025 34328822
         IC    RSIZE,SCBBLKCT           GET MAX NUMBER OF        S22025 34329022
*                                       SUBBLOCKS PER BLOCK      S22025 34329222
ASCAN    EQU   *                                                 S22025 34329422
         BAL   RWORK10,LINKAXM          GO TO SCAN               S22025 34329622
         LR    R1,R0                    GET OFFSET               S22025 34329722
         LA    R1,1(R1)                 INCREMENT OFFSET       @SA74884 34329809
         STH   R1,DATOFF(,RPREFIX)      SET IN BUFFER            S22025 34329922
         LTR   R15,R15                  ANY CHARS FOUND          S22025 34330022
         BZ    SETLAST                  NO                       S22025 34330122
         LA    RCOUNT,ONE(,RCOUNT)      BUMP COUNTER             S22025 34330222
         AR    R0,RICR                  ADD LENGTH-1 OF EOB    @SA74884 34330309
         CH    R0,SCBEOB                WAS THERE A PREVIOUS EOB S22025 34330422
         BE    SETCTR                   YES,BEGIN INSERTION    @SA74884 34330609
         CR    RCOUNT,RSIZE             MAX COUNT FOR BLOCK      S22025 34330822
         BNE   ASCAN                    NO,LOOK FOR NEXT       @SA74884 34331009
         AR    RICR,RDATAD              ADD NUMBER OF EXTRA BYTESS22025 34331222
         SR    RCOUNT,RCOUNT            RESET COUNTER            S22025 34331422
         B     ASCAN                    LOOK FOR NEXT          @SA74884 34332209
SETCTR   EQU   *                                                 S22025 34332422
         SR    RSIZE,RCOUNT             YES, GET ACCUM CT        S22025 34332622
         STC   RSIZE,SCBBCTR            SAVE COUNT               S22025 34332822
         B     LCOFFSET                 GO GET OFFSETS         @SA74884 34333009
SETLAST  EQU   *                                                        34333222
         LH    RSIZE,PRFSIZE            GET TOTAL SIZE           S22025 34333422
         N     RSIZE,AVTCLRHI           CLEAR HALF               S22025 34333622
         B     LAST                     NO INSERT NEEDED         S22025 34333822
         EJECT                                                          34334020
TESTSTX  EQU   *                                                        34341020
         TM    SCBQTYPE,SCBCONC         CONCENTRATOR SCB         S22026 34342022
         BZ    CHKBYSNC                 BRANCH IF NO             S22026 34343022
         TM    SCBSTAT1,SCBCBGN         CONCENTRATED MSG BEGIN   S22026 34344022
         BZ    TESTLC                   NO DO NOT INSERT EOA     S22026 34345022
CHKBYSNC EQU   *                                                 S22026 34346022
         TM    LCBSTAT1,LCBRECVN        INPUT                    S22025 34350022
         BNO   CHKEOA                   NO,CHECK FOR STX OR EOA  S22025 34359022
         MVC   SCBEOBAC(2),BSIZE(R1)    SET OFFSET FOR FIRST SCANS22025 34368022
         B     STX                      GO INSERT STX                   34377022
CHKEOA   EQU   *                                                        34386022
         TM    LCBSTAT2,LCBSYNC         IS DESTINATION BISYNC           34400020
         BO    STX                      YES, INSERT STX                 34500020
         SPACE                                                          34600020
         LH    R1,LCBTTCIN              GET DESTINATION KEY             34700020
         N     R1,AVTCLRHI                                              34800020
         L     R15,AVTRNMPT             GET ADDR OF TNT CODE            34900020
         BALR  R14,R15                  LINK TO GET TERM ENTRY ADDR     35000020
         SPACE                                                          35100020
         USING IEDQTRM,R1                                               35200020
         SR    R15,R15                  PICK UP DEVICE                  35300020
         IC    R15,TRMCHCIN               CHARS TABLE INDEX             35400020
         BCTR  R15,AVTEZERO             MAKE IT A TRUE INDEX            35500020
         MH    R15,AVTDCTLN             MULTIPLY BY DCT LEN    @Y17XAMG 35600000
         A     R15,AVTCSTCS             GET ADDRESS OF OUR ENTRY        35700020
         TM    THREE(R15),FLAG226R      IS DESTINATION 2260 REMOTE      35800020
         BO    STX                      YES, INSERT EOA                 35900020
         SPACE                                                          36000020
         TM    THREE(R15),FLAG2760      IS DESTINATION A 2760           36100020
         BNO   TESTLC                   NO, DON'T INSERT EOA            36200020
         SPACE                                                          36300020
         TM    LCBSTAT2,LCBRESP         YES, IS IT TETE-A-TETE          36400020
         BNO   TESTLC                   NO, DON'T INSERT EOA            36500020
         SPACE                                                          36600020
STX      EQU   *                                                        36700020
         SR    RWORK2,RWORK2                                            36800020
         IC    RWORK2,LCBISZE           PICK UP RESERVE CHAR COUNT      36900020
         LA    RWORK2,AVTHDRSZ+1(,RWORK2) ADD PREFIX SIZE + 1           37000020
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 37003022
         BZ    STINSOFF                 BRANCH IF NO             S22026 37006022
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER            S22026 37010022
         BZ    USEHDR                   BRANCH IF YES            S22026 37020022
         LA    RWORK2,AVTTXTSZ+ONE      SET TXT OFFSET           S22026 37030022
USEHDR   EQU   *                                                 S22026 37040022
         TM    PRFSTAT1,PRFCNCLN        RECALLED                 S22026 37050022
         BZ    STINSOFF                 BRANCH IF NO             S22026 37060022
         LH    RWORK2,SCBEOB            DATA OFFSET              S22026 37070022
         LA    RWORK2,ONE(RWORK2)       ADD ONE                  S22026 37080022
STINSOFF EQU   *                                                 S22026 37090022
         ST    RWORK2,INSOFF(,RPREFIX)  SET AS INSERT OFFSET            37100020
         BO    STXLINK                  BRANCH IF RECALLED       S22026 37150022
*                                       CONCENTRATOR BUFFER      S22026 37170022
         SPACE                                                          37200020
         SR    R0,R0                                                    37300020
         CH    R0,SCBEOBSZ              ANY ETBS OR ITBS TO INSERT      37400020
         BE    STXLINK                  NO, DON'T SET OFFSETS           37500020
         SPACE                                                          37600020
         BAL   R14,LCOFFST2             LINK TO SET INITIAL OFFSETS     37700020
*                                         INITIAL ETB/ITB OFFSETS       37800020
         SPACE                                                          37900020
STXLINK  EQU   *                                                        38000020
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER?          SA64787 38005054
         BO    STXLINK1                 NO, BRANCH              SA64787 38010054
         SR    R15,R15                  CLEAR REGISTER 15       SA64787 38015054
         IC    R15,LCBISZE              GET NUMBER OF IDLE CHARSSA64787 38020054
         LA    R15,PRFSHDR(R15)         GET ADDRESS OF FIRST    SA64787 38025054
*                                         DATA BYTE             SA64787 38030054
         LA    RWORK2,SCTEOA            PICK UP STX ADDRESS     SA64787 38035054
         IC    RWORK2,AVTEZERO(RWORK2,RSCT7) GET INDEX TO STX   SA64787 38040054
         LA    RWORK2,AVTEZERO(RWORK2,RSCT7) GET ADDR OF STX    SA64787 38045054
         CLC   AVTEZERO(ONE,R15),AVTEZERO(RWORK2)  IS FIRST     SA64787 38050054
*                                                    BYTE A STX?SA64787 38055054
         BNE   STXLINK1                 NO, BRANCH              SA64787 38060054
         LA    RWORK2,SCTPAD            GET ADDR OF PAD CHAR    SA64787 38065054
         IC    RWORK2,AVTEZERO(RWORK2,RSCT7) GET INDEX TO PAD   SA64787 38070054
         LA    RWORK2,AVTEZERO(RWORK2,RSCT7) GET ADDR OF PAD    SA64787 38075054
         MVC   AVTEZERO(ONE,R15),AVTEZERO(RWORK2)  OVERLAY STX  SA64787 38080054
*                                                    WITH PAD   SA64787 38085054
STXLINK1 EQU   *                                                SA64787 38090054
         LA    RWORK2,SCTEOA            REQUEST STX ADDRESS             38100020
         B     MAINLOOP                 ENTER MAIN LOOP                 38200020
GOTCHAR  EQU   *                                                 S22025 38200922
         L     R15,CHAR(,R1)            GET ADDR OF CHARACTERS   S22025 38201822
         LA    R15,0(,R15)              CLEAR HIGH               S22025 38202722
         SR    R0,R0                                             S22025 38203622
         IC    R0,CHARL(,R1)            GET LENGTH OF CHARACTERS S22025 38204522
         B     SETUP                    GO SETUP                 S22025 38205422
NOINSRT  EQU   *                                                 S22025 38206322
         BCTR  RDATAD,R0                BACK UP ONE              S22025 38207222
         STH   RDATAD,SCBEOBAC          SET OFFSET               S22025 38208122
         TM    PARMSTAT(R1),OPTFLD      CHARS IN OPT FIELD       S22025 38209022
         BNO   GOTCHAR                  NO                       S22025 38209922
         LA    R1,AEOFF(,R1)            GET AE PARAMETER LIST    S22025 38210822
         L     R15,AVTUI                GET INTERFACE RTN        S22025 38211722
         BALR  R14,R15                  LOCATE OPTION            S22025 38212622
         LTR   R15,R15                  OPTION FIELD FOUND       S22025 38213522
         BZ    ERRLAST                  NO                       S22025 38214422
         SR    R0,R0                    CLEAR                    S22025 38215322
         IC    R0,0(,R1)                GET LENGTH               S22025 38216222
SETUP    EQU   *                                                 S22025 38217122
         STH   R0,TWO(,RPREFIX)         SAVE LENGTH              S22025 38218022
         STH   R0,PRFXTRA+1             INDICATE DELETE LENGTH   S22025 38218422
         SLL   R0,TWFOUR                PUT IN HIGH BYTE         S22025 38218922
         LR    RSIZE,R0                 SAVE COUNT               S22025 38219822
         LR    RDATAD,R15               SAVE DATA ADDR           S22025 38220722
         LH    R1,SCBEOBAC              GET CURRENT OFFSET       S22025 38221622
SC1      EQU   *                                                 S22025 38222522
         N     R1,AVTCLRHI              CLEAR                    S22025 38223422
         CH    R1,PRFSIZE               OUT OF BUFFER            S22025 38224322
         BNL   BUFOUT                   YES                      S22025 38225222
         AR    R1,RSIZE                 PUT OFFSET WITH COUNT    S22025 38226122
         LR    R0,RDATAD                GET DATA ADDRESS         S22025 38227022
         LNR   RWORK2,RDATAD                                     S22025 38227922
         L     R15,AVTAL                SCAN ROUTINE             S22025 38228822
         BALR  R14,R15                  SCAN BUFFER              S22025 38229722
         LTR   R15,R15                  CHARS FOUND              S22025 38230622
         BNZ   FOUND                    YES                      S22025 38231522
SC2      EQU   *                                                 S22025 38232422
         LH    R1,SCBEOBAC              NO,GET CURRENT OFFSET    S22025 38233322
         AH    R1,SCBEOBSZ              ADD INTERVAL             S22025 38234222
         STH   R1,SCBEOBAC              NO, SET NEW OFFSET       S22025 38235122
         B     SC1                      SCAN AGAIN               S22025 38236022
BUFOUT   EQU   *                                                 S22025 38236922
         SH    R1,PRFSIZE               GET LEFTOVER             S22025 38237822
NOMORE   EQU   *                                                 S22025 38240522
         STH   R1,SCBEOBSZ              SAVE OFFSET              S22025 38242922
         MVC   SCBEOBAC(TWO),PRFKEY     RESTORE DLIST COUNT      S22025 38243522
         L     R15,AVTUI                GET INTERFACE            S22025 38244122
         B     FOUR(R15)                RETURN                   S22025 38245022
FOUND    EQU   *                                                 S22025 38245922
         CH    R15,TWO(,RPREFIX)        ALL CHARS FOUND          S22025 38246822
         BL    PART                     NO                       S22025 38247722
         LR    RLIM8,R0                 LOAD DATA OFFSET         S22025 38248622
         LA    RLIM8,1(,RLIM8)          BUMP OFFSET BY ONE       S22025 38249522
         STH   RLIM8,DATOFF(,RPREFIX)   STORE IT                 S22025 38250422
         STH   R15,INSOFF(,RPREFIX)     SET INSERT OFFSET        S22025 38251322
         MVI   PRFXTRA,CONTR            INDICATE DATA CONTRACTIONS22025 38251722
         LH    RLIM8,PRFSIZE            GET TOTAL SIZE           S22025 38252222
         N     RLIM8,AVTCLRHI           CLEAR                    S22025 38253122
         SR    RLIM8,R0                 GET SIZE BEYOND CHARS    S22025 38254022
         CR    RLIM8,RLIM8              SET CONDITION CODE       S22025 38254922
         BAL   R14,LINKAF               GO SHIFT DATA            S22025 38255822
         OI    PRFTQBCK+TWO,BFREDIT     INDICATE DATA MOVEMENT   S22025 38256222
         LH    RLIM8,PRFSIZE            GET OLD SIZE             S22025 38256722
         SH    RLIM8,TWO(,RPREFIX)      ADJUST FOR DELETE        S22025 38257622
         STH   RLIM8,PRFSIZE            SET NEW SIZE             S22025 38258522
         B     SC2                      GET CURRENT OFFSET       S22025 38259422
*                                                                       38259822
PART     EQU   *                                                 S22025 38260322
         TM    PRFSTAT1,PRFNLSTN        LAST BUFFER              S22025 38261222
         BNO   SC2                      YES, GET OUT             S22025 38262122
         LH    RLIM8,PRFSIZE            GET SIZE                 S22025 38263022
         N     RLIM8,AVTCLRHI           CLEAR HALF               S22025 38263922
         SR    RLIM8,R15                SUBTRACT LENGTH OF CHARS S22025 38264822
         CLC   AVTADBUF+1(3),SCBDEOB+1  LAST GOOD EOB BUFFER     S22025 38264922
         BNE   NONEOB                   NO, IGNORE EOB OFFSET    S22025 38265022
         SPACE 1                                                 S22025 38265122
         CH    RLIM8,SCBEOB             EOB IN DATA TO HOLD      S22025 38265222
         BNH   SC2                      YES, GET OUT             S22025 38265322
         SPACE 1                                                 S22025 38265422
NONEOB   EQU   *                                                 S22025 38265522
         STH   R15,SCBEOBAC             SAVE COUNT               S22025 38265722
         LA    RLIM8,ONE(,RLIM8)        BUMP FOR AO              S22025 38266722
         ST    RLIM8,INSOFF(,RPREFIX)   SET OFFSETS              S22025 38268422
         SR    RLIM8,RLIM8              SET CONDITION CODE       S22025 38269322
         IC    R15,AVTPARM+3            GET AO INDEX             S22025 38270522
         LA    R15,ONE(,R15)            INDICATE DIRECT RETURN          38270822
         STC   R15,AVTPARM3             MAKE SURE NEW UNIT GOTTENS22025 38271122
         BAL   R14,LKAORET              GO TO AO AND RETURN      S22025 38271422
         LTR   R15,R15                  OUT OF UNITS             S22025 38272022
         BNZ   ERREXIT                  YES, ERROR               S22025 38272922
         BAL   R14,FINALSIZ             GET FINAL SIZE           S22025 38273822
         LR    RDATAD,RPREFIX           GET FIRST UNIT           S22025 38276522
NEXTUNIT EQU   *                                                 S22025 38277422
         L     RDATAD,PRFTIC-IEDQPRF(,RDATAD) GET NEXT           S22025 38278322
         CH    RSIZE,AVTKEYLE           DATA END IN THIS UNIT    S22025 38279222
         BL    THISUNIT                 YES                      S22025 38280122
         SH    RSIZE,AVTKEYLE           GO TO NEXT UNIT          S22025 38281022
         B     NEXTUNIT                 NEXT                     S22025 38281922
*                                                                       38282322
THISUNIT EQU   *                                                 S22025 38282822
         L     R1,PRFLCB-1             GET LCB ADDR              S22025 38283722
*                                                                1 @R1D 38284727
         SR    RLIM8,RLIM8             CLEAR                     S22025 38285722
         IC    RLIM8,LCBISZE-IEDQLCB(R1) GET NO. OF RESERVES       @R1C 38286727
         LA    RLIM8,AVTTXTSZ(,RLIM8)  ADD PREFIX SIZE           S22025 38287722
         CR    RLIM8,RSIZE              SPACE AVAILABLE          S22025 38288722
         BH    GETUNIT                 NO, GET ANOTHER UNIT      S22025 38289722
         IC    R1,PRFNBUNT             YES, GET TOTAL NO. UNITS  S22025 38290722
         BCTR  R1,R0                   ADJUST FOR EXTRA UNIT     S22025 38291722
         LA    R15,ONE                 SET NO. UNITS FOR HOLD    S22025 38292722
         B     BLDPRF                  SET UP PREFIX FOR HOLD Q  S22025 38293722
GETUNIT  EQU   *                                                 S22025 38294722
         SR    R0,R0                    CLEAR                    S22025 38295722
         STH   R0,INSOFF(,RPREFIX)     SET SPACE AVAILABLE TO 0  S22025 38296722
         BAL   R14,LINK                GO GET ANOTHER UNIT       S22025 38297722
         LTR   R15,R15                 UNIT AVAILABLE            S22025 38298722
         BNZ   ERREXIT                 NO,ERROR                  S22025 38299722
         LH    R15,PRFSIZE              GET SIZE PLUS NEW UNIT   S22025 38300722
         N     R15,AVTCLRHI            CLEAR                     S22025 38301722
         SH    R15,AVTKEYLE            GET CORRECT SIZE          S22025 38302722
         STH   R15,PRFSIZE             STORE                     S22025 38303722
         SR    R1,R1                   CLEAR                     S22025 38304722
         IC    R1,PRFNBUNT             GET NO.UNITS TOTAL        S22025 38305722
         SH    R1,AVTHA2               ADJUST FOR TWO NEW ONES   S22025 38306722
         AH    RSIZE,AVTKEYLE          ADJUST DATA OFFSET        S22025 38307722
         LH    R15,AVTHA2              SET NUMBER OF UNITS GOTTENS22025 38308722
BLDPRF   EQU   *                                                 S22025 38309722
         ST    RSCB3,AVTUMALN(,RDATAD) PUT SCB ADDR IN NEW BUF   S22025 38310722
         STC   R1,PRFNBUNT             SET NO. UNITS IN OLD BUF  S22025 38311722
         MVC   MVOFF(LEN,RDATAD),MVOFF(RPREFIX) MOVE PREFIX FLDS S22025 38312722
         L     RWORK2,AVTADBUF          SAVE POINTER OF ORIGINAL S22025 38313722
         ST    RDATAD,AVTADBUF          SET FOR NEW              S22025 38314722
         LR    RPREFIX,RDATAD          SET BASE TO NEW BUFFER    S22025 38315722
         STC   R15,PRFNBUNT            SET NO. UNITS IN NEW BUF  S22025 38316722
         LA    R15,ONE(,RSIZE)         GET DATA OFFSET PLUS 1    S22025 38317722
         STH   R15,DATOFF(,RPREFIX)    SET OFFSET FOR AF         S22025 38318722
         AH    RSIZE,SCBEOBAC          ADD CHAR LEN TO OFFSET    S22025 38319722
         STH   RSIZE,PRFSIZE           SET AS SIZE IN NEW BUF    S22025 38320722
         BCTR  R15,R0                  SUBTRACT ONE FROM OFFSET  S22025 38321722
         SR    R15,RLIM8               ADJUST FOR PREFIX,RESERVS S22025 38322722
         STH   R15,INSOFF(,RPREFIX)    SET SPACE AVAILABLE IN NEWS22025 38323722
         OI    PRFSTAT1,PRFNHDRN       INSURE TEXT BUFFER        S22025 38324722
         OI    PRFTQBCK+TWO,BFREDIT     INDICATE DATA MOVEMENT   S22025 38325222
         STH   RLIM8,PRFSCAN           SET SCAN PAST PRF,RESERVS S22025 38325722
         LH    RLIM8,SCBEOBAC          GET LENGTH OF CHAR STRING S22025 38326722
         CR    RLIM8,RLIM8             SET CONDITION CODE        S22025 38327722
         BAL   R14,LINKAF              CLOSE UP NEW BUFFER       S22025 38328722
         LH    RLIM8,PRFSIZE           GET SIZE + AVAIL. SPACE   S22025 38329722
         SH    RLIM8,INSOFF(,RPREFIX)  SUBTRACT SPACE AVAILABLE  S22025 38330722
         STH   RLIM8,PRFSIZE           STORE CORRECT SIZE        S22025 38331722
         LH    R14,AVTHA2              GET TIC ADDR FOR LAST UNITS22025 38332722
         SR    R15,R15                 CLEAR                     S22025 38333722
         IC    R15,PRFNBUNT            GET NO. UNITS IN NEW BUF  S22025 38334722
         CR    R15,R14                 TWO UNITS GOTTEN     BUF  S22025 38335722
         BL    ONEUNIT                 NO, FIRST UNIT IS LAST    S22025 38336722
         L     RDATAD,PRFTIC           POINT TO NEXT UNIT        S22025 38337722
ONEUNIT  EQU   *                                                 S22025 38338722
         ST    R14,PRFTIC-IEDQPRF(,RDATAD) PUT IN INVALID TIC ADDR22025 38339722
         MVI   PRFTIC-IEDQPRF(RDATAD),EIGHT SET TIC FLAG         S22025 38340722
         LR    RDATAD,RPREFIX          POINT TO FIRST UNIT       S22025 38341722
         LR    RPREFIX,RWORK2           GET ORIGINAL BUF         S22025 38342722
         ST    RPREFIX,AVTADBUF         RESET TO OLD             S22025 38343722
         L     R1,FOUR(,R13)            GET PREV SAVE            S22025 38344722
         L    R1,REG1OFF(,R1)          GET AK'S PARMLIST         S22025 38345722
         MVC   FIVE(3,RDATAD),NINE(R1)  LINK QUEUED TO NEW       S22025 38346722
         ST   RDATAD,EIGHT(,R1)         PUT NEW ON QUEUE         S22025 38347722
         SR    R1,R1                    SET OFFSET FOR NEXT      S22025 38348322
         B     NOMORE                   GET OUT                  S22025 38348922
*                                                                       38349022
         EJECT                                                          38349722
SETAC    EQU   *                                                 S22025 38400022
         STH   R0,SCBEOBAC             NO,SET INITIAL OFFSET     S22025 38430022
TESTLC   EQU   *                                                        38460022
         SR    R0,R0                                                    38500020
         CH    R0,SCBEOBSZ              ANY LC CHARACTERS TO INSERT     38600020
         BNE   NOCT                     CANNOT BE BLOCK ON CNT @SA74884 38630009
         CH    R0,SCBEOBAC              IS IT ON COUNT           S22025 38660022
         BE    LAST                     NO,GO TO END PROCESSING@SA74884 38700009
NOCT     EQU   *                                                 S22025 38750022
         SPACE                                                          38800020
         BAL   R14,LCOFFSET             LINK TO SET INITIAL OFFSETS     38900020
         SPACE                                                          39000020
TESTLC2  EQU   *                                                        39050020
         BAL   R14,LCSELECT             GET 1ST LC CHAR TO INSERT       39100020
         SPACE                                                          39200020
         ST    RDATAD,INSOFF(,RPREFIX)  YES, SET INSERT OFFSET          39600020
*********************************************************************** 39650022
*                        ENTER   MAIN   LOOP                     S22025 39700022
*********************************************************************** 39750022
         EJECT                                                          39800020
MAINLOOP EQU   *                                                        39900020
         NR    RWORK2,RWORK2            SET COND CODE = 8 OR 4 @SA74884 40000009
         BAL   R14,GETSCTAD             GO INSERT IT                    40100020
         SPACE                                                          40200020
         LTR   R15,R15                  HAVE WE RUN OUT OF UNITS        40220020
         BNZ   ERREXIT                  YES, EXIT IMMEDIATELY           40240020
         SPACE                                                          40260020
         LH    RDATAD,DATOFF(,RPREFIX)  GET CURRENT DATA OFFSET         40300020
         N     RDATAD,AVTCLRHI                                          40400020
         LH    RSIZE,PRFSIZE            GET TOTAL DATA LENGTH           40500020
         N     RSIZE,AVTCLRHI                                           40600020
         LA    RSIZE,ONE(,RSIZE)        POINT BEYOND LAST BYTE          40700020
         SR    RSIZE,RDATAD             SUBTRACT TO GET RESIDUAL CT     40800020
         CH    R15,SCBEOBSZ             BLOCK ON COUNT           S22025 40830022
         BE    COMPEOB                  NO                       S22025 40860022
         SPACE                                                          40900020
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED         41000020
         BE    COMPEOB                  NO, GO PICK UP EOB EXTENT       41100020
         SPACE                                                          41200020
         SR    RDATAD,RDATAD                                            41300020
         IC    RDATAD,SCBITBSZ          PICK UP ITB INTERVAL            41400020
         B     TESTNEXT                 GO SEE IF ANOTHER WILL FIT      41500020
         SPACE                                                          41600020
COMPEOB  EQU   *                                                        41700020
         LH    RDATAD,SCBEOBSZ          GET EOB INTERVAL                41800020
         N     RDATAD,AVTCLRHI                                          41900020
         BNZ   TESTNEXT                 YES, CHECK AVAIL SPACE   S22025 41905022
         CH    RDATAD,SCBEOBAC          ACCUM COUNT ZERO         S22025 41910022
         BE    CLOSEUP                  GO TO END PROCESSING     S22025 41915022
         SPACE 2                                                 S22025 41920022
SCANRTN  EQU   *                                                 S22025 41925022
HERE     EQU   *                                                 S22025 41935022
         SPACE 2                                                 S22025 41945022
         LH    RSIZE,PRFSIZE            GET TOTAL DATA LENGTH    S22025 41950022
         N     RSIZE,AVTCLRHI                                    S22025 41955022
         LA    RSIZE,ONE(,RSIZE)        BUMP PAST END OF BUFFER  S22025 41957022
         SH    RSIZE,DATOFF(,RPREFIX)   GET UNMOVED LENGTH       S22025 41960022
         CLC   DATOFF(2,RPREFIX),PRFSIZE  OUT OF BUFFER          S22025 41961022
         BH    LAST                     YES, GET OUT             S22025 41962022
         BAL   RWORK10,LINKAXM          SCAN FOR CHARS           S22025 41963022
         LTR   R15,R15                  CHARACTER FOUND          S22025 41965022
         BZ    CLOSEUP                  DIDN'T FIND ENDCHAR      S22025 41970022
         IC    RDATAD,SCBBCTR           GET COUNTER              S22025 41975022
         LA    RDATAD,ONE(,RDATAD)      BUMP ONE                 S22025 41980022
         STC   RDATAD,SCBBCTR           RESTORE COUNTER          S22025 41985022
         AR    R15,R0                   GET OFFSET OF NEXT       S22025 41990022
         LR    RWORK2,R15               SAVE DATA OFFSET         S22025 41995022
         LR    RLIM8,R15                SET LENGTH               S22025 42000022
         SH    RLIM8,DATOFF(,RPREFIX)   GET LENGTH               S22025 42005022
         CR    RLIM8,RLIM8              SET CONDITION CODE       S22025 42010022
         BAL   R14,LINKAF               SHIFT ONE SUBBLOCK       S22025 42015022
         STH   RWORK2,DATOFF(,RPREFIX)  SET NEW OFFSET           S22025 42020022
         CLC   SCBBLKCT(1),SCBBCTR      HAS COUNT REACHED MAX    S22025 42025022
         BH    HERE                     NO,GET TOTAL LENGTH    @SA74884 42030009
         LH    RWORK2,INSOFF(,RPREFIX)  GET INSERT OFFSET        S22025 42035022
         LA    RWORK2,ONE(,RWORK2)      ADJUST FOR EOB           S22025 42040022
         STH   RWORK2,INSOFF(,RPREFIX)  STORE NEW OFFSET         S22025 42045022
         LA    RWORK2,SCTEOB            GET EOB OFFSET           S22025 42050022
         MVI   SCBBCTR,AVTEZERO         SET CTR BACK TO ZERO     S22025 42055022
         B     MAINLOOP                 GO TO INSERTING LOOP     S22025 42060022
LINKAXM  EQU   *                                                 S22025 42065022
         LA    R1,SCBCRLEN              GET PARAMETER LIST       S22025 42070022
         LH    R0,DATOFF(,RPREFIX)      LOAD DATA OFFSET         S22025 42072022
         N     R0,AVTCLRHI              CLEAR TOP HALF OF REG    S22025 42074022
         LR    RSCB3,RWORK2             SAVE COUNT OR BLOCK    @SA74884 42074509
         BCTR  R0,R0                    SUBTRACT ONE             S22025 42075022
         LNR   RWORK2,R0                INSURE R2 NEGATIVE       S22025 42076022
         L     R15,AVTAX                LOAD SCAN ROUT ADDR      S22025 42080022
         BALR  R14,R15                  LINK TO SCAN             S22025 42085022
         LR    RWORK2,RSCB3             RESTORE COUNT OR BLOCK  SA67120 42086005
         L     RSCB3,LCBSCBA-1          RESTORE SCB ADDRESS     SA67120 42087005
         BR    RWORK10                  RETURN                   S22025 42090022
         SPACE                                                          42100020
TESTNEXT EQU   *                                                        42200020
         CR    RDATAD,RSIZE             WILL ANOTHER LC CHAR FIT        42300020
         BNL   CLOSEUP                  NO, SHIFT TO END OF DATA        42400020
         SPACE                                                          42500020
         LR    RLIM8,RDATAD             YES, SHIFT TO NEXT LC CHAR      42600020
         CR    RLIM8,RLIM8              SET CONDITION CODE = 8          42700020
         BAL   R14,LINKAF               GO SHIFT DATA                   42800020
         SPACE                                                          42900020
         LH    RSIZE,PRFSIZE            RESET TRUE                      42930020
         N     RSIZE,AVTCLRHI             BUFFER SIZE                   42960020
         BAL   R14,LCSELECT             GET NEXT LC CHAR TO INSERT      43000020
         SPACE                                                          43100020
         B     MAINLOOP                 REENTER TO INSERT NEXT LC       43200020
         SPACE 3                                                        43300020
CLOSEUP  EQU   *                                                        43400020
         LR    RLIM8,RSIZE              SHIFT TO END OF DATA            43500020
         CR    RLIM8,RLIM8              SET CONDITION CODE = 8          43600020
         BAL   R14,LINKAF               GO SHIFT DATA                   43700020
         SPACE                                                          43800020
*        B     LAST                     ENTER END PROCESSING            43900020
         EJECT                                                          44000020
LAST     EQU   *                                                        44100020
         SR    R0,R0                                                    44200020
         TM    SCBQTYPE,SCBCONC         SCB FOR A CONCENTRATOR   S22026 44210022
         BZ    CKLAST                   BRANCH IF NO             S22026 44220022
         TM    SCBSTAT1,SCBCEND         CONCENTRATED END OF MSG  S22026 44230022
         BO    LASTBFR                  YES,GO PROCESS           S22026 44240022
         B     CKINSERT                 BRANCH TO SKIP CHK       S22026 44250022
CKLAST   EQU   *                                                 S22026 44260022
         TM    PRFSTAT1,PRFNLSTN        IS THIS LAST BUFFER             44300020
         BNO   LASTBFR                  YES, GO PROCESS                 44400020
CKINSERT EQU   *                                                 S22026 44450022
         SPACE                                                          44500020
         TM    INSOFF(RPREFIX),INSRTCHK ANY INSERTS DONE         S22025 44600022
         BO    TESTUPAC                 NO, SIZE IS UNCHANGED           44700020
         SPACE                                                          44800020
         CR    RPREFIX,RPREFIX          SET CONDITION CODE = 8          44900020
         BAL   R14,FINALSIZ             YES, COMPUTE FINAL SIZE         45000020
         SPACE                                                          45100020
TESTUPAC EQU   *                                                        45200020
         CH    R0,SCBEOBSZ              ARE EOBS BEING INSERTED         45300020
         BE    EXIT                     NO, EXIT                        45400020
         SPACE                                                          45500020
         LA    RSIZE,ONE(,RSIZE)        POINT BEYOND END OF DATA        45600020
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED         45700020
         BE    UPEOBAC                  NO, GO UPDATE EOBAC             45800020
         SPACE                                                          45900020
         LH    RDATAD,PRFITBAC          YES, GET OFFSET TO NEXT ITB     46000020
         N     RDATAD,AVTCLRHI                                          46100020
         SR    RDATAD,RSIZE             SUBTRACT AND SET INITIAL        46200020
         STC   RDATAD,SCBITBAC            ITB OFFSET FOR NEXT BFR       46300020
         SPACE                                                          46400020
UPEOBAC  EQU   *                                                        46500020
         LH    RDATAD,SCBEOBAC          GET OFFSET TO NEXT EOB          46600020
         N     RDATAD,AVTCLRHI                                          46700020
         SR    RDATAD,RSIZE             SUBTRACT AND SET INITIAL        46800020
         STH   RDATAD,SCBEOBAC            EOB OFFSET FOR NEXT BFR       46900020
         B     EXIT                     EXIT                            47000020
         EJECT                                                          47100020
LASTBFR  EQU   *                                                        47200020
         TM    INSOFF(RPREFIX),INSRTCHK ANY INSERTS DONE         S22025 47300022
         BZ    TESTEOT                  YES, INSERT OFFSETS ARE SET     47500020
         SPACE                                                          47600020
         LA    RSIZE,ONE(,RSIZE)        POINT BEYOND LAST BYTE          47700020
         ST    RSIZE,INSOFF(,RPREFIX)   SET AS INSERT OFFSET            47800020
         SPACE                                                          47900020
TESTEOT  EQU   *                                                        48000020
         LH    RDATAD,DATOFF(,RPREFIX)  PICK UP DATA OFFSET             48100020
         N     RDATAD,AVTCLRHI                                          48200020
         SH    RDATAD,INSOFF(,RPREFIX)  POINT TO INSERT POINT           48300020
         BCTR  RDATAD,AVTEZERO          POINT TO LAST BYTE              48400020
         LR    RWORK2,RPREFIX           LOAD PREFIX ADDR         S22025 48500022
         BAL   R14,ENTERLOP             GET ADDR OF SCAN POINTER S22025 48600022
         SPACE                                                          48700020
         LA    RWORK2,SCTEOT            REQUEST EOT ADDRESS             48800020
         SR    R15,R15                  SET CONDITION CODE              48900020
         BAL   R14,GETSCTAD             GO GET IT                       49000020
         SR    R15,R15                  CLEAR REGISTER 15       SA64788 49050054
         SPACE                                                          49100020
         CLI   0(RWORK2),TWO           IS SCT ENTRY LENGTH 2 (ETX-EOT)  49200020
         BNE   COMPEOT                 NO, POINTING TO EOT, GO ON       49300020
         SPACE                                                          49400020
         CLC   AVTEZERO(ONE,RDATAD),TWO(RWORK2) IS LAST DATA    SA64787 49500054
*                                                 BYTE AN EOT?  SA64787 49530054
         BNE   COMPEOT                  NO, BRANCH              SA64787 49560054
         LA    R15,ONE                  SET NUMBER OF BYTES TO  SA64787 49590054
*                                         BE DELETED TO 1       SA64787 49620054
         BCTR  RDATAD,AVTEZERO          GET ADDR OF NEXT-TO-LASTSA64787 49650054
*                                         DATA BYTE             SA64787 49680054
COMPEOT  EQU   *                                                SA64787 49710054
         CLC   AVTEZERO(ONE,RDATAD),ONE(RWORK2) IS LAST BYTE AN SA64787 49740054
*                                                 EOT OR NEXT   SA64787 49770054
*                                                 TO LAST BYTE  SA64787 49800054
*                                                 AN ETX?       SA64787 49830054
         BNE   CHKSIZE                  NO, GO ADJUST PRFSIZE   SA64787 49860054
         LA    R15,ONE(R15)             ADD 1 TO NUMBER OF      SA64787 49890054
*                                         BYTES TO BE DELETED   SA64787 49920054
         BCTR  RDATAD,0                 DECREMENT                  @01A 49950012
* AT THIS POINT ONE OF 3 CONDITIONS EXISTS, EITHER:                @21A 49952127
* 1-A ONE-BYTE EOT IS TO BE INSERTED AND THE LAST BYTE OF          @21A 49954227
*   DATA WAS AN EOT AND NOW R15=1 OR                               @21A 49956327
* 2-A TWO-BYTE EOT WILL BE INSERTED(ETX/EOT) AND THE LAST          @21A 49958427
*   TWO BYTES OF DATA WERE ETX/EOT AND NOW R15=2 OR                @21A 49960527
* 3-A TWO-BYTE EOT WILL BE INSERTED AND THE LAST BYTE OF           @21A 49962627
*   DATA WAS ETX AND NOW R15=1.                                    @21A 49964727
         B     BRANCH          GO SHORTEN BY COUNT IN R15          @21A 49966827
CHKSIZE  EQU   *                                                SA64787 49969412
         SPACE                                                          49988812
* AT THIS POINT, IF A ONE-BYTE EOT IS TO BE INSERTED, R15=0        @21A 49991527
* AND THERE IS NO NEED  TO CHECK FOR EOB. IF A TWO-BYTE            @21A 49994227
* EOT IS TO BE INSERTED, WE MUST INSURE THAT THE ETX WILL          @21A 49996927
* OVERLAY ANY EOB AT THE END OF THE DATA.                          @21A 49999627
         CLI   0(RWORK2),ONE   IS EOT ONE BYTE                     @21A 50002327
         BE    BRANCH          YES, BRANCH TO END                  @21A 50005027
         LA    RWORK2,SCTEOB            OFFSET TO INDEX            @01A 50008212
         SR    R14,R14                  CLEAR REGISTER             @01A 50027612
         BAL   R14,GETSCTAD             GET SCT ADDR               @01A 50047012
         SR    R14,R14                  CLEAR                      @01A 50066412
         IC    R14,AVTEZERO(,RWORK2)    PICK EOB LENGTH            @01A 50085812
         BCTR  R14,0                    DECREMENT LENGTH           @01A 50105212
         EX    R14,COMPEOT              EOB                        @01A 50124612
         BE    INC                      BRANCH, YES                @01A 50144012
         CLI   0(RWORK2),TWO   STX PRECEDE EOB?                    @21C 50163427
         BNE   BRANCH                   BRANCH, NO                 @01A 50182812
         CLC   AVTEZERO(ONE,RDATAD),ONE(RWORK2) LAST BYTE EOB      @01A 50202212
         BNE   BRANCH                   BRANCH, NO                 @01A 50221612
INC      LA    R15,ONE(R15)             INCREMENT NUMBER           @01A 50241012
BRANCH   EQU   *                                                   @01A 50260412
         LH    RWORK2,DATOFF(,RPREFIX)  DECREMENT DATA OFFSET      @01C 50279812
         SR    RWORK2,R15                 TO OVERLAY EOT AND/OR SA64787 50300054
*                                         ETX                   SA64787 50350054
         STH   RWORK2,DATOFF(,RPREFIX)    CURRENTLY IN THE BUFFER       50400020
         SPACE                                                          50500020
         LH    RWORK2,PRFSIZE           DECREMENT DATA SIZE             50600020
         SR    RWORK2,R15                 TO COMPENSATE FOR     SA64787 50700054
         STH   RWORK2,PRFSIZE           OVERLAID EOT AND/OR ETX SA64787 50800054
         EJECT                                                          50900020
TESTBSC  EQU   *                                                        51000020
         SR    R0,R0                    CLEAR                    S22025 51050022
         TM    LCBSTAT2,LCBSYNC         IS DESTINATION BISYNC           51100020
         BO    SETEOT                   YES, GO INSERT EOT              51200020
         SPACE                                                          51300020
         CH    R0,SCBEOBSZ              ARE EOBS BEING INSERTED         51400020
         BNE   SETEOBT                  YES,SET PARAMETERS       S22025 51430022
         CH    R0,SCBEOBAC              BLOCK ON COUNT           S22025 51460022
         BE    SETEOT                   NO, GO INSERT EOT               51500020
         SPACE                                                          51600020
SETEOBT  EQU   *                                                        51700020
         LA    RWORK2,SCTEOB            REQUEST EOB ADDRESS             51800020
         SR    R15,R15                  SET CONDITION CODE              51900020
         BAL   R14,GETSCTAD             GO GET IT                       52000020
         SPACE                                                          52100020
         IC    R15,AVTEZERO(,RWORK2)    PICK UP EOB LENGTH              52200020
         BCTR  R15,AVTEZERO             (DECREMENT FOR EXECUTE)         52300020
         EX    R15,MOVEX                MOVE EOB TO AVT WORK AREA       52400020
         LA    RWORK10,ONE(,R15)        RESET & HOLD EOB LENGTH         52500020
         SPACE                                                          52600020
         LA    RWORK2,SCTEOT            REQUEST EOT ADDRESS             52700020
         SR    R15,R15                  SET CONDITION CODE              52800020
         BAL   R14,GETSCTAD             GO GET IT                       52900020
         SPACE                                                          53000020
         IC    R15,AVTEZERO(,RWORK2)    PICK UP EOT LENGTH              53100020
         BCTR  R15,AVTEZERO             (DECREMENT FOR EXECUTE)         53200020
         AR    RAVT9,RWORK10            BUMP AVT BASE BY EOB LENGTH     53300020
         EX    R15,MOVEX                MOVE EOT TO AVT WORK AREA       53400020
         SR    RAVT9,RWORK10            CORRECT AVT BASE                53500020
         SPACE                                                          53600020
         LA    R15,ONE(RWORK10,R15)     GET LNG OF EOB + LNG OF EOT     53700020
         LA    RWORK2,AVTDOUBL          GET ADDR OF EOB + EOT           53800020
         LTR   RWORK2,RWORK2            SET CONDITION CODE              53900020
         BAL   R14,LINKAOBT             GO INSERT IT AND EXIT           54000020
         SPACE                                                          54100020
SETEOT   EQU   *                                                        54200020
         LA    RWORK2,SCTEOT            REQUEST EOT ADDRESS             54300020
         LTR   RWORK2,RWORK2            SET CONDITION CODE = 2          54400020
         BAL   R14,GETSCTAD             INSERT EOT AND EXIT             54500020
         EJECT                                                          54600020
LCOFFSET EQU   *                                                        54700020
         SR    RWORK2,RWORK2                                            54800020
         IC    RWORK2,LCBISZE           PICK UP RESERVE CHAR COUNT      54900020
         LA    RWORK2,AVTTXTSZ+1(,RWORK2) ADD LNGTH OF TEXT PREFIX      55000020
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER         55100020
         BO    LCOFFST2                 NO, PRE-DATA SIZE IS GOOD       55200020
         SPACE                                                          55300020
         LA    RWORK2,AVTHDRSZ-AVTTXTSZ(,RWORK2) YES, ADD EXTRA         55400020
         SPACE                                                          55500020
LCOFFST2 EQU   *                                                        55600020
         SR    RDATAD,RDATAD            CLEAR                    S22025 55610022
         CH    RDATAD,SCBEOBSZ          BLOCK LENGTH SPECIFIED   S22025 55620022
         BNE   LCOFFST3                 NO                       S22025 55630022
         CH    RDATAD,SCBEOBAC          BLOCK ON COUNT           S22025 55640022
         BE    LCOFFST3                 GET EOB OFFSET           S22025 55650022
         ST    RWORK2,INSOFF(,RPREFIX)  SET INITIAL OFFSET       S22025 55660022
         B     SCANRTN                  SCAN FOR CHARACTERS      S22025 55670022
*                                                                       55675022
LCOFFST3 EQU   *                                                 S22025 55680022
         LH    RDATAD,SCBEOBAC          PICK UP EOB OFFSET IN DATA      55700020
         LA    RDATAD,AVTEZERO(RWORK2,RDATAD) ADD PRE-DATA SIZE         55800020
         STH   RDATAD,SCBEOBAC          STORE BACK OFFSET INTO UNIT     55900020
         SPACE 1                                                 S22025 55920022
         TM    LCBSTAT1,LCBRECVN        INPUT                    S22025 55940022
         BO    NOINSRT                  YES, BRANCH              S22025 55960022
         SPACE                                                          56000020
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED         56100020
         BCR   ZERO,R14                 NO, RETURN TO CALLER            56200020
         SPACE                                                          56300020
         SR    RDATAD,RDATAD                                            56400020
         IC    RDATAD,SCBITBAC          PICK UP ITB OFFSET IN DATA      56500020
         AR    RDATAD,RWORK2            ADD PRE-DATA SIZE               56600020
         STH   RDATAD,PRFITBAC          STORE OFFSET INTO UNIT          56700020
         BR    R14                      RETURN TO CALLER                56800020
         EJECT                                                          56900020
LCSELECT EQU   *                                                        57000020
         CLI   SCBITBSZ,AVTEZERO        ARE ITBS BEING INSERTED         57100020
         BALR  R15,AVTEZERO             (SAVE CONDITION CODE)           57400020
         BE    SETEOB                   NO, NO ITB, GO SET EOB          57500020
         SPACE                                                          57600020
         CLC   PRFITBAC(TWO),SCBEOBAC   IS NEXT LC CHAR AN ITB          57700020
         BL    SETITB                   YES, GO SET ITB                 57800020
         SPACE                                                          57900020
SETEOB   EQU   *                                                        58000020
         LH    RDATAD,SCBEOBAC          PICK UP EOB OFFSET              58100020
         N     RDATAD,AVTCLRHI                                          58200020
         LA    RWORK2,SCTEOB            SET SCT INDEX TO EOB            58300020
         CR    RDATAD,RSIZE             WILL EOB FIT IN THIS BUFFER     58330020
         BH    LAST                     NO, GO TO END PROCESSING        58360020
         SPACE                                                          58400020
         LH    RWORK10,SCBEOBSZ         PICK UP EOB EXTENT              58500020
         LA    RWORK10,AVTEZERO(RWORK10,RDATAD) GET NEXT EOB OFFSET     58600020
         STH   RWORK10,SCBEOBAC         SET IT BACK IN SCB              58700020
         SPACE                                                          58800020
         SPM   R15                      ARE ITBS BEING INSERTED         58900020
         BCR   EQUAL,R14                NO, RETURN                      59000020
         SPACE                                                          59100020
UPITBAC  EQU   *                                                        59200020
         SR    RWORK10,RWORK10                                          59300020
         IC    RWORK10,SCBITBSZ         PICK UP ITB EXTENT              59400020
         LA    RWORK10,AVTEZERO(RWORK10,RDATAD) GET NEXT ITB OFFSET     59500020
         STH   RWORK10,PRFITBAC         SET IT BACK IN PREFIX           59600020
         BR    R14                      RETURN                          59700020
         SPACE                                                          59800020
SETITB   EQU   *                                                        59900020
         LH    RDATAD,PRFITBAC          PICK UP ITB OFFSET              60000020
         N     RDATAD,AVTCLRHI                                          60100020
         LA    RWORK2,SCTITB            SET SCT INDEX TO ITB            60200020
         CR    RDATAD,RSIZE             WILL ITB FIT IN THIS BUFFER     60220020
         BH    LAST                     NO, GO TO END PROCESSING        60240020
         SPACE                                                          60260020
         B     UPITBAC                  YES, GO SET NEXT ITB OFFSET     60330020
         EJECT                                                          60400020
GETSCTAD EQU   *                                                        60500020
         IC    RWORK2,AVTEZERO(RWORK2,RSCT7) PICK UP INDEX TO ITEM      60900020
         LA    RWORK2,AVTEZERO(RWORK2,RSCT7) PICK UP ADDR OF ITEM       61000020
         BCR   ZERO,R14                 RETURN IF ZERO CONDITION        61100020
         SPACE                                                          61200020
LINKAO   EQU   *                                                        61300020
         SR    R15,R15                  CLEAR FOR INSERT                61400020
         IC    R15,AVTEZERO(,RWORK2)    PICK UP INSERT DATA LENGTH      61500020
         LA    RWORK2,ONE(,RWORK2)      GET INSERT DATA ADDRESS         61600020
         SPACE                                                          61700020
*                                                                       61800022
LINKAOBT EQU   *                        SPECIAL ENTRY FOR EOB & EOT     61850022
         ST    RWORK2,AVTPARM3          SET ADDRESS IN PARM LIST        61900020
         STC   R15,AVTPARM3             SET LENGTH IN PARM LIST         62000020
         SPM   R14                      IS EOT BEING INS5RTED           62100020
         BP    LINKAOET                 YES, LEAVE AC FIELDS ALONE      62200020
         SR    R1,R1                    CLEAR                    S22025 62220022
         CH    R1,SCBEOBSZ              BLOCK LENGTH SPECIFIED   S22025 62240022
         BE    LINKAOET                 NO, BLOCK ON COUNT       S22025 62260022
         SPACE                                                          62300020
         LH    R1,PRFITBAC              INCREMENT ITB                   62400020
         LA    R1,AVTEZERO(R15,R1)        OFFSET BY                     62500020
         STH   R1,PRFITBAC                INSERT LENGTH                 62600020
         SPACE                                                          62700020
         LH    R1,SCBEOBAC              INCREMENT EOB                   62800020
         LA    R1,AVTEZERO(R15,R1)        OFFSET BY                     62900020
         STH   R1,SCBEOBAC                INSERT LENGTH                 63000020
         SPACE                                                          63100020
LINKAOET EQU   *                                                        63200020
         IC    R15,AVTPARM+3            PICK UP IEDQAO INDEX            63300020
LKAORET  EQU   *                                                        63350022
         STC   R15,AVTPARM              SET INDEX IN PARM LIST          63400020
         MVI   AVTPARM+1,AVTEZERO       INDICATE DATA TYPE= CHARS       63500020
         SPACE                                                          63600020
LINK     EQU   *                                                        63700020
         LA    R1,AVTPARM               POINT TO SUBRTN'S PARM LIST     63800020
         L     R15,AVTUI                GET USER INTERFACE ADDRESS      63900020
         SPM   R14                      TEST PASSED CONDITION CODE      64000020
         BCR   NOTPOS,R15               NOT POSITIVE, LINK AND          64100020
*                                         RETURN TO CALLER              64200020
         BALR  R14,R15                  POSITIVE, LINK AND              64300020
*                                         RETURN HERE                   64400020
         LTR   R15,R15                  HAVE WE RUN OUT OF UNITS        64410020
         BNZ   ERREXIT                  YES, GO HANDLE IT               64500020
         SPACE                                                          64590020
FINALSIZ EQU   *                                                        64680020
         LH    RSIZE,DATOFF(,RPREFIX)   GET FINAL DATA OFFSET           64800020
         N     RSIZE,AVTCLRHI                                           64900020
         SH    RSIZE,INSOFF(,RPREFIX)   GET FINAL DATA SIZE             65000020
         BCTR  RSIZE,AVTEZERO           POINT TO LAST BYTE OF DATA      65100020
         STH   RSIZE,PRFSIZE            SET IN BUFFER                   65200020
         SPM   R14                      TEST PASSED CONDITION CODE      65300020
         BCR   ZERO,R14                 IF ZERO, RETURN TO CALLER       65400020
         SPACE                                                          65500020
EXIT     EQU   *                                                        65600020
         L     R13,FOUR(,R13)           PT TO CALLED SAVE AREA   S22025 65740022
         L     R1,REG1OFF(,R13)         LOAD PARAMETER LIST ADDR        65800020
         SPACE                                                          65900020
EXIT2    EQU   *                                                        66000020
         L     RSCB3,LCBSCBA-1          RESTORE SCB ADDR         S22026 66010022
         TM    LCBSTAT1,LCBRECVN        INPUT                    S22025 66020022
         BO    EXIT3                    YES                             66040022
         SR    R15,R15                  CLEAR REGISTER           S22025 66070022
         IC    R15,ONE(,R1)             GET LENGTH OF PARM LIST  S22025 66140022
         LA    R1,AVTEZERO(R15,R1)      POINT TO NEXT PARAMETER  S22025 66210022
         LA    R13,AVTSAVE2             INITIALIZE SAVE AREA     S22025 66280022
         L     R15,AVTUI                GET ADDR OF INTERFACE    S22025 66350022
         BR    R15                         MODULE AND BRANCH     S22025 66420022
EXIT3    EQU   *                                                        66440022
         L     R15,AVTUI                GET INTERFACE                   66460022
         B     FOUR(R15)                RETURN                          66480022
         SPACE 3                                                        66500020
LINKAF   EQU   *                                                        66600020
         IC    R15,AVTPARM+2            PICK UP IEDQAF INDEX            66700020
         LA    R15,ONE(,R15)            REQUEST SHIFT-DATA FUNCTION     66800020
         STC   R15,AVTPARM              SET INDEX IN PARM LIST          66900020
         B     LINK                     GO PERFORM LINK                 67000020
         SPACE 3                                                        67100020
ERREXIT  EQU   *                                                        67106020
         OI    SCBERR1,SCBNOBFN         SET 'INSUFF BUFFERS' BIT        67112020
         TM    SCBQTYPE,SCBCONC         CONCENTRATOR             S22026 67112822
         BZ    NOTCONCZ                 BRANCH IF NO             S22026 67113622
         TM    SCBSTAT1,SCBCEND         CONC MSG END             S22026 67114422
         BO    ERRLAST                  BRANCH IF YES            S22026 67115222
         B     NOTCONCY                 SKIP EOM BUF CHECK       S22026 67116022
NOTCONCZ EQU   *                                                 S22026 67116822
         TM    PRFSTAT1,PRFNLSTN        IS THIS LAST BUFFER             67118020
         BNO   ERRLAST                  YES, GO CLEAR SCB FIELD         67124020
NOTCONCY EQU   *                                                 S22026 67127022
         SPACE                                                          67130020
         MVC   SCBEOBAC,SCBEOBSZ        NO, SET INITIAL OFFSETS FOR     67136020
         MVC   SCBITBAC,SCBITBSZ          NEXT BFR AS IF FIRST BFR      67142020
         B     EXIT                     EXIT                            67148020
         SPACE                                                          67154020
ERRLAST  EQU   *                                                        67160020
         SR    R15,R15                  CLEAR SCB FIELD                 67166020
         STH   R15,SCBEOBAC               TO ZEROES                     67172020
         B     EXIT                     EXIT                            67178020
ADDRLOOP EQU   *                                                 S22025 67178622
         L     RWORK2,PRFTIC-IEDQPRF(,RWORK2) POINT TO NEXT UNIT S22025 67179222
         SH    RSCAN,AVTKEYLE           SUBT NO OF BYTES PASSED  S22025 67179822
ENTERLOP EQU   *                                                 S22025 67180422
         CH    RSCAN,AVTKEYLE           IS ITEM IN THIS UNIT     S22025 67181022
         BH    ADDRLOOP                 NO, TEST NEXT UNIT       S22025 67181622
         LA    RSCAN,AVTUMALN-1(RSCAN,RWORK2) YES, UNIT ADDR     S22025 67182222
         BR    R14                      RETURN TO CALLER         S22025 67182822
         SPACE 3                                                        67184020
********* EXECUTED INSTRUCTION **********                               67200020
         SPACE                                                          67300020
MOVEX    MVC   AVTDOUBL(ONE),ONE(RWORK2) BUILD EOB/EOT STRING           67400020
*                                                                       67430022
REG2SAVE DS    F                       USED TO SAVE REGISTER 2   S99528 67460022
         EJECT                                                          67500020
********* DSECTS **********                                             67600020
         SPACE                                                          67700020
         TAVTD                                                          67800020
         EJECT                                                          67900020
         DCBD DSORG=TX                                                  68000020
         EJECT                                                          68100020
         TLCBD                                                          68200020
         EJECT                                                          68300020
         TPRFD                                                          68400020
         SPACE                                                          68500020
PRFITBAC EQU   PRFSCAN                  OFFSET TO NEXT ITB              68600020
         EJECT                                                          68700020
         TPRIOR                                                         68800020
         EJECT                                                          68900020
         TSCBD                                                          69000020
         EJECT                                                          69100020
         TTRMD                                                          69200020
         SPACE                                                          69300020
         END                                                            69400020
