         SPACE 3                   *                                    00005000
AU02     TITLE '''IEDQAU'' -- CUTOFF ROUTINE AND SUBTASK'   *           00010000
         SPACE 3                     *                                  00015000
IEDQAU   CSECT                          *                               00020000
         SPACE 3                         *                              00025000
******************** MICROFICHE FLAGS ************************SUPT CODE 00030000
*A000000-999999                                  *             @X31X8M0 00035000
*C008400                                        *                X02004 00040000
*C684000                                     *                   X01004 00050000
*A288000,292000,730000,732000                                    S22029 00300122
*C008000-008020                                                  S22029 00300222
*D140000-148000,716000-728000,736000                             S22029 00300322
*A089000-092000,108800-111200,438000,456800-463200,502000        S22025 00300422
*C056000,136000,200000,216000,220000,308000,356000,364000-376000 S22025 00300522
*C388000,400000,412000,424000,448000,454000                      S22025 00300622
*D092000,436000-440000,788000-796000                             S22025 00300722
*A028000,108000,164000,168000,188000,208000,228000,884000        A49213 00300822
*C208000,220000,788000                                           A49213 00300922
*A468000,468100                                                  S21903 00301022
*C476000,488000,492000                                           S21903 00301122
*A168000,252000                                                 SA56206 00301222
*D276000                                                        SA56206 00301322
*A320100-322700,842000,996600-887200                             S22024 00301422
*C008080,540000,656000,664000                                    S22024 00301522
*A136000                                                        SA61096 00401505
*C008010-008016                                                 SA61096 00501505
*D289000-290000                                                 SA61096 00601505
*A091000,108000,110000                                           X03039 00641507
*D320100-322700,841000-843000,886400-887600,898000,950000        X03039 00711507
*C448000-452000                                                @OS77010 00713500
*A452000                                                       @OS77010 00715500
*A648000                                                       @ZA04008 00751509
*C449000                                                       @OY15455 00761500
*A321680                                                       @OY20385 00761686
*A110800,044000,084000,009110,009270,320000                    @Y17XAMF 00771500
*****    ************************************************************** 00800000
**                                                                    * 00800200
**TITLE:  IEDQAU - CUTOFF ROUTINE AND SUBTASK                         * 00800400
**                                                                    * 00800600
** MODULE NAME = IEDQAU                                               * 00801000
**                                                                    * 00801200
** DESCRIPTIVE NAME = CUTOFF ROUTINE AND SUBTASK                      * 00801400
**                                                                    * 00801600
** COPYRIGHT = 'NONE'                                                 * 00801800
**                                                                    * 00801900
** STATUS:  CHANGE LEVEL 10                                    @Y17XAMF 00802000
**                                                                    * 00802200
**FUNCTION -- CUTS OFF A MESSAGE BEING RECEIVED FROM A NON-SNA        * 00802400
**  DEVICE AFTER RECEIPT OF A                                  @Y17XAMF 00802600
**  USER-SPECIFIED MAXIMUM NUMBER OF BYTES OR ON DETECTION OF         * 00804000
**  IDENTICAL CHARACTERS IN THE BUFFER.                               * 00804700
**  CUTOFF ROUTINE:                                                   * 00805400
**  UPON ENTRY,  THE ROUTINE DETERMINES IF THE CUTOFF FLAG IN  @Y17XAMF 00806100
*   THE SCB (SCBCUTFN) IS SET.  ON INITIAL ENTRY,  IT IS NOT.  IF     * 00808022
*   THE BUFFER IS A ZERO-LENGTH BUFFER,  CONTROL RETURNS TO THE       * 00809022
*   CALLER IMMEDIATELY.                                               * 00810022
*                                                                     * 00811022
*   THE ROUTINE DETERMINES IF ALL THE CHARACTERS IN THE FIRST UNIT    * 00812022
*   OF THE BUFFER ARE IDENTICAL.  IF SO,  THE CUTOFF FUNCTION IS      * 00813022
*   INITIATED.                                                        * 00814022
*                                                                     * 00815022
*   IF NOT,  THE CUTOFF COUNT FIELD IN THE SCB (SCBBKFCT) IS INCRE-   * 00816022
*   MENTED BY THE DATA SIZE OF THE CURRENT BUFFER (PRFSIZE).  IF      * 00817022
*   THE RESULT IS NOT GREATER THAN THE USER-SPECIFIED MAXIMUM,        * 00818022
*   RETURN IS MADE TO THE CALLER.  IF IT IS,  THE CUTOFF FUNCTION     * 00819022
**  IS INITIATED.                                                     * 00819500
**                                                                    * 00820000
**  TO INITIATE THE CUTOFF FUNCTION,  THE CUTOFF FLAG IS SET,  @Y17XAMF 00820500
**                                                             @Y17XAMF 00821000
**  IF THE CUTOFF RESOURCE IS A PRE-SNA 3705 DEVICE A FID0     @Y17XAMF 00821500
**  PIU IS BUILT AND TPOSTED TO IDDSAO.  THE BUFFER FOR THIS   @Y17XAMF 00822000
**  PIU IS OBTAINED THRU THE BUFFER STEAL ROUTINE(AVTSTEAL).   @Y17XAMF 00822500
**  THE SCB CUTOFF FLAG REMAINS ON IF NO BUFFERS ARE AVAILABLE.@Y17XAMF 00823000
**  IF THE DEVICE IS SNA, NO CUTOFF FUNCTION IS PERFORMED.     @Y17XAMF 00823500
**                                                             @Y17XAMF 00824000
**  IF THE CUTOFF RESOURCE IS AN EP DEVICE, THE LCB ERROR FLAG @Y17XAMF 00824500
**  IN THE LCB IS SET AND THE ADDRESS OF THE CUTOFF QCB IS     @Y17XAMF 00825000
**  SET IN THE LCB. RETURN IS MADE TO THE CALLER.              @Y17XAMF 00825500
*   IF THE CUTOFF ROUTINE IS ENTERED AFTER THE CUTOFF FUNCTION IS     * 00826022
*   INITIATED,  THE ROUTINE DETECTS THIS BY EXAMINING THE CUTOFF      * 00827022
*   FLAG AND FINDING IT ON.  IF THE LCB QCB FIELD (LCBQCBA) IS ZERO   * 00828022
*   THE FUNCTION IS COMPLETE AND RETURN IS MADE TO THE CALLER.  IF    * 00829022
*   THE FIELD IS NOT ZERO,  THE ROUTINE DETERMINES IF THIS BUFFER     * 00830022
*   IS FLAGGED AS THE LAST BUFFER OF THE MESSAGE.  IF  SO,  THE LCB   * 00831022
*   ERROR FLAG IS TURNED OFF.  RETURN IS MADE TO THE CALLER.          * 00832022
*                                                                     * 00833022
*   CUTOFF SUBTASK:                                                   * 00834022
*   THE SUBTASK DETERMINES INITIAL ENTRY BY DETECTING A CHANNEL       * 00835022
*   PROGRAM CHECK CONDITION.  THE UCB IS EXAMINED TO DETERMINE WHAT   * 00836022
*   CHANNEL PROGRAM IS TO BE SET UP.  FOR TELETYPE TERMINALS,  A      * 00837022
*   WRITE BREAK IS SET UP.  FOR IBM 2260 TERMINALS,  IT IS A WRITE    * 00838022
*   BREAK AND READ SKIP.  FOR ALL OTHER IBM TERMINALS,  IT IS A       * 00839022
*   READ SKIP.  THE SUBTASK PERFORMS AN EXCPVR ON THE CHANNEL PROGRAM * 00840004
*   AND EXITS TO THE DISPATCHER AT THE LABEL DSPDISP.                 * 00841022
*                                                                     * 00842022
*   SUBSEQUENT ENTRY TO THE SUBTASK IS DETECTED BY THE ABSENCE OF     * 00843022
*   A CHANNEL PROGRAM CHECK CONDITION.  THE ADDRESS OF THE FIRST      * 00844022
*   BUFFER RECEIVED AFTER INITIATION OF THE CUTOFF IS ACCESSED FROM   * 00845022
*   THE LCB.  THIS BUFFER IS FLAGGED AS THE LAST BUFFER OF THE        * 00846022
*   MESSAGE AND ITS DATA SIZE IS SET TO ONE.  EXIT IS MADE BY         * 00847022
*   POSTING THE BUFFER TO THE STARTMH QCB.                            * 00848022
*                                                                     * 00849022
*ENTRY POINTS --                                                      * 00850022
*       'IEDQAU' TO TEST FOR IDENTICAL CHARACTERS,  INCREMENT AND     * 00851022
*   TEST THE CUTOFF COUNT AND INITIATE THE CUTOFF FUNCTION WHEN       * 00852022
*   NEEDED.  CALLING SEQUENCE FROM USER INTERFACE IS:                 * 00853022
*                                                                     * 00854022
*        L     R12,AVTMSGS-1            GET ADDR OF VCON TABLE        * 00855022
*        IC    R15,AVTEZERO(,R1)        GET INDEX TO ROUTINE ADDR     * 00856022
*        L     R12,AVTEZERO(R12,R15)    GET ROUTINE ADDRESS           * 00857022
*        BR    R12                      EXIT TO ROUTINE               * 00858022
*                                                                     * 00859022
*       'CUTFFQCB' + 12 TO EXECUTE THE CUTOFF CHANNEL PROGRAM AND     * 00860022
*   TO POST THE FINAL BUFFER TO MH AFTER THE CHANNEL PROGRAM          * 00861022
*   COMPLETES.  THE SUBTASK IS ENTERED AS A RESULT OF THE LINE END    * 00862022
*   APPENDAGE'S POSTING THE LCB TO THE CUTOFF QCB.                    * 00863022
*                                                                     * 00864022
*INPUT,  CUTOFF ROUTINE --                                            * 00865022
*   REGISTER 1 -- THE ADDRESS OF A MACRO-GENERATED PARAMETER LIST.    * 00866022
*   PARAMETER LIST FORMAT IS:                                         * 00867022
*                                                                     * 00868022
*        *********************************                            * 00869022
*        * INDEX * PARM  *   REQUESTED   *                            * 00870022
*        *  FOR  *  LIST *    CUTOFF     *                            * 00871022
*        *   AU  * LNGTH *     LENGTH    *                            * 00872022
*        *********************************                            * 00873022
*                                                                     * 00874022
*   REGISTER 3 -  ADDRESS OF THE SCB                                  * 00875022
*                                                                     * 00876022
*   REGISTER 4 -  ADDRESS OF THE LCB                                  * 00877022
*                                                                     * 00878022
*   REGISTER 6 -  ADDRESS OF THE CURRENT BUFFER                       * 00879022
*                                                                     * 00880022
*   REGISTER 12 - ENTRY POINT ADDRESS AND BASE FOR THE ROUTINE        * 00881022
*                                                                     * 00882022
*   REGISTER 13 - ADDRESS OF THE SAVE AREA FOR THE ROUTINE AND BASE   * 00883022
*   FOR AVT ADDRESSABILITY                                            * 00884022
*                                                                     * 00885022
*OUTPUT, CUTOFF ROUTINE --                                            * 00885500
*   SCB CUTOFF COUNT FIELD (SCBBKFCT) - WHEN ENTERED WITH THE SCB     * 00887022
*   CUTOFF BIT OFF, CONTAINS THE ACCUMULATED DATA COUNT FOR ALL       * 00888022
*   BUFFERS UP TO AND INCLUDING THE CURRENT BUFFER.                   * 00889022
*                                                                     * 00890022
*   SCB CUTOFF BIT (SCBCUTFN) - WHEN ENTERED WITH THE BIT OFF,  IT    * 00891022
*   IS LEFT OFF ON EXIT WHEN THE REQUESTED COUNT IS NOT EXCEEDED      * 00892022
*   AND IDENTICAL  CHARACTERS ARE NOT FOUND,  AND IT IS TURNED ON     * 00893022
*   WHEN THE COUNT IS EXCEEDED OR IDENTICAL CHARACTERS ARE FOUND.     * 00894022
*                                                                     * 00895022
*   LCB QCB FIELD (LCBQCBA) - WHEN A CUTOFF CONDITION IS DETECTED,    * 00896022
*   SET TO THE ADDRESS OF THE CUTOFF QCB.                             * 00897022
*                                                                     * 00898022
*   LCB ERROR BIT (LCBERROR) - WHEN ENTERED WITH THE CUTOFF BIT       * 00899022
*   OFF,  THIS BIT IS TURNED ON IF A CUTOFF CONDITION IS DETECTED.    * 00900022
*   WHEN ENTERED WITH THE CUTOFF BIT ON,  THIS BIT IS TURNED OFF IF   * 00901022
*   THE LCB QCB FIELD IS NOT ZEROES BUT THE BUFFER IS FLAGGED AS A    * 00902022
*   LAST BUFFER.                                                      * 00903022
*                                                                     * 00904022
*INPUT,  CUTOFF SUBTASK --                                            * 00905022
*   REGISTER 1 - THE ADDRESS OF THE LCB                               * 00906022
*                                                                     * 00907022
*   REGISTER 7 - THE ADDRESS OF THE CUTOFF QCB,  USED AS THE BASE     * 00908022
*   FOR THE SUBTASK                                                   * 00909022
*                                                                     * 00910022
*   REGISTER 11 - THE ADDRESS OF THE DISPATCHER                       * 00911022
*                                                                     * 00912022
*   REGISTER 13 - THE ADDRESS OF THE SAVE AREA FOR THE SUBTASK AND    * 00913022
*   BASE FOR AVT ADDRESSABILITY                                       * 00914022
*                                                                     * 00915022
*   LCB CHANNEL STATUS WORD (LCBCSW) - INDICATES CHANNEL PROGRAM      * 00916022
*   CHECK ON FIRST DISPATCH,  NOT ON SECOND DISPATCH                  * 00917022
*                                                                     * 00918022
*OUTPUT,                                                       @Y17XAMF 00918100
*   IF CUTOFF DEVICE IS 3705 PRE-SNA A RESET IMMEDIATE IS SENT @Y17XAXF 00918200
*   TO IEDSAO.                                                 @Y17XAMF 00918300
*                                                              @Y17XAMF 00918400
*   CUTOFF SUBTASK:                                            @Y17XAMF 00918500
*   LCB CHANNEL PROGRAM AREA (LCBCPA) + 16 - CONTAINS THE CCWS        * 00922022
*   EXECUTED TO PERFORM THE CUTOFF FUNCTION                           * 00923022
*                                                                     * 00924022
*   LCB QCB FIELD (LCBQCBA) - AFTER SECOND DISPATCH,  CLEARED TO      * 00925022
*   ZEROES                                                            * 00926022
*                                                              @Y17XAMF 00926200
*   RETURN CODES.                                              @Y17XAMF 00926400
*   R15 = 0  CUTOFF FUNCTION EXECUTED CORRECTLY.               @Y17XAMF 00926600
*         4  NO BUFFER AVAILABLE FOR BUILDING RESET IMMEDIATE  @Y17XAMF 00926800
*                                                                     * 00927022
*EXTERNAL REFERENCES --                                               * 00928022
*                                                                     * 00929022
*   AVT - ADDRESS VECTOR TABLE                                        * 00930022
*                                                                     * 00931022
*   BUFFER CURRENTLY BEING PROCESSED                                  * 00932022
*                                                                     * 00933022
*   LCB - LINE CONTROL BLOCK                                          * 00934022
*                                                                     * 00935022
*   SCB - STATION CONTROL BLOCK                                       * 00936022
*                                                                     * 00937022
*   DCB - DATA CONTROL BLOCK                                          * 00938022
*                                                                     * 00939022
*   DEB - DATA EXTENT BLOCK                                           * 00940022
*                                                                     * 00941022
*   UCB - UNIT CONTROL BLOCK                                          * 00942022
*                                                                     * 00943022
*EXITS,  NORMAL,  CUTOFF ROUTINE -- DATA LENGTH HAS NOT REACHED THE   * 00944022
*   CUTOFF LIMIT AND IDENTICAL CHARACTERS ARE NOT FOUND IN THE        * 00945022
*   BUFFER.  SCBBKFCT IS INCREMENTED BY THE DATA SIZE IN THIS         * 00946022
*   BUFFER.                                                           * 00947022
*                                                                     * 00948022
*   DATA LENGTH HAS REACHED THE CUTOFF LIMIT,  OR IDENTICAL CHARAC-   * 00949022
*   TERS ARE FOUND IN THE BUFFER.  THE SCB CUTOFF BIT IS TURNED ON.   * 00950022
*   THE ADDRESS OF THE CUTOFF QCB IS SET INTO THE LCB.  THE LCB       * 00951022
*   ERROR FLAG IS TURNED ON.                                          * 00952022
*                                                                     * 00953022
*   A BUFFER FLAGGED AS THE LAST BUFFER IS BEING PROCESSED AND THE    * 00954022
*   CUTOFF FLAG IS ON.  IF THE LCB QCB FIELD IS NOT ZEROES,  THE      * 00955022
*   LCB ERROR BIT IS TURNED OFF.                                      * 00956022
*                                                                     * 00957022
*EXITS,  NORMAL,  CUTOFF SUBTASK --                                   * 00958022
*   A CUTOFF CONDITION HAS BEEN DETECTED.  THE LCB CHANNEL PROGRAM    * 00959022
*   AREA CONTAINS THE CCWS EXECUTED TO PERFORM THE CUTOFF FUNCTION.   * 00960022
*   THE LCB ERROR BIT IS TURNED OFF.                                  * 00961022
*                                                                     * 00962022
*   A CUTOFF FUNCTION HAS BEEN PERFORMED.  THE LCB QCB FIELD IS       * 00963022
*   CLEARED TO ZERO.  THE FIRST BUFFER RECEIVED AFTER INITIATION      * 00964022
*   OF THE CUTOFF FUNCTION IS POSTED TO THE STARTMH QCB FLAGGED AS    * 00965022
*   THE LAST BUFFER AND WITH A SIZE OF ONE.                           * 00966022
*                                                                     * 00967022
*EXITS,  ERROR - N/A                                                  * 00968022
*                                                                     * 00969022
*TABLES/WORK AREAS --                                                 * 00970022
*   MODEL CCWS NEEDED TO PERFORM EACH OF THE POSSIBLE CUTOFF          * 00971022
*   PROCEDURES                                                        * 00972022
*                                                                     * 00973022
*ATTRIBUTES -- SERIALLY REUSABLE,  REFRESHABLE,  ENABLED,             * 00974022
*   RESIDENT,  PROBLEM PROGRAM MODE.                                  * 00975022
*                                                                     * 00976022
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON AN        * 00977022
*   INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET.            * 00978022
*                                                                     * 00979022
*********************************************************************** 00980022
         EJECT                                                          01600022
********* REGISTER EQUATES *********                                    01601022
         SPACE                                                          01602022
R0       EQU   0                        WORK REGISTER                   02000020
R1       EQU   1                        PARAMETER LIST ADDRESS          02400020
RCCW2    EQU   2                        ADDRESS OF CCW                  02800020
R2       EQU   2                        WORK REG                 A49213 03000022
RSCB3    EQU   3                        SCB ADDRESS                     03200020
R4       EQU   4                        LCB ADDRESS                     03600020
R5       EQU   5                        LAST DATA BYTE ADDRESS          04000020
RPREFIX  EQU   6                        BUFFER ADDRESS                  04400020
RSAVT    EQU   7                        SAVT ADDRESS           @Y17XAMF 04600000
R7       EQU   7                        CUTOFF QCB ADDRESS              04800020
R8       EQU   8                        DATA SIZE                       05200020
RAVT     EQU   9                        ADDRESS OF AVT           S22025 05600022
R10      EQU   10                       REG 10                   S22024 06000022
RDCB10   EQU   10                       DCB ADDRESS                     06400020
R11      EQU   11                       DISPATCHER ADDRESS              06800020
R12      EQU   12                       BASE REGISTER                   07200020
R13      EQU   13                       SAVE AREA ADDR & AVT BASE       07600020
R14      EQU   14                       RETURN REGISTER                 08000020
R15      EQU   15                       LINK REGISTER                   08400020
         EJECT                                                          08800020
NUMUNT   EQU   1                        NUMBER OF UNITS        @Y17XAMF 08830000
NUMBUF   EQU   1                        NUMBER OF BUFFERS      @Y17XAMF 08860000
FOUR     EQU   4                        VALUE 4                  S22024 08900022
SEVEN    EQU   7                        VALUE 7                  S22024 09000022
EIGHT    EQU   8                        VALUE 8                  S22024 09100022
         SPACE 2                                                        09130007
         USING IEDQAVTD,RAVT                                     S22025 09200022
         USING IEDQLCB,R4                                               09600020
         USING IEDQPRF,RPREFIX                                          10000020
         USING IEDQSCB,RSCB3                                            10400020
         USING IEDQAU,R12                                               10800020
         SPACE 2                                                        10900007
IEDQAU   IEDHJN ENTER                                            S22025 11000022
         LR    R8,R1                    SAVE PARM LIST ADDR      X03039 11010007
         LH    R1,LCBTTCIN              TNT INDEX                X03039 11020007
         N     R1,AVTCLRHI              CLEAR HI HALF            X03039 11030007
         BZ    RESTPARM                 IF ZERO THEN NOT VTAM TRMX03039 11040007
*                                                                X03039 11050007
         L     R15,AVTRNMPT             TNT CODE                 X03039 11060007
         BALR  R14,R15                  GET TERMINAL ADDRESS     X03039 11070007
*                                                                X03039 11080007
         SR    R15,R15                  INITIALIZE RETURN CODE @Y17XAMF 11081000
         SH    R1,TPREFIX               CALCULATE ADDRESS OF   @Y17XAMF 11082000
         USING IEDNTRM,R1                TTE PREFIX            @Y17XAMF 11083000
         TM    TRMSTATE,TRMPREF         IS RESOURCE EP         @Y17XAMF 11084000
         BNO   RESTPARM                 YES, BRANCH            @Y17XAMF 11085000
         TM    TRMBYTE0,TRMSNA          IS RESOURCE SNA        @Y17XAMF 11086000
         BO    EXIT                     YES, BRANCH            @Y17XAMF 11087000
         DROP  R1                       YES, BRANCH            @Y17XAMF 11088000
RESTPARM EQU   *                                                 X03039 11130007
         LR    R1,R8                    RESTORE PARM LIST ADDR   X03039 11140007
         SPACE                                                          11200020
         TM    SCBERR1,SCBCUTFN         IS CUTOFF FLAG SET              11600020
         BO    CKEND                    CHECK IF END OF MESSAGE         12000020
         SPACE                                                          12400020
         LH    R8,PRFSIZE               GET TOTAL DATA COUNT            12800020
         N     R8,AVTCLRHI                                              13200020
         BZ    TEST                     EXIT IF ZERO-LENGTH BUFF S22025 13600022
         TM    PRFSTAT1,PRFTSMSG       THIS TSO MSG             SA61096 14100005
         BO    TSOM                    USE CURRENT DATA COUNT   SA61096 14600005
               SPACE                                                    15200020
         LH    R5,AVTKEYLE              UNIT SIZE - 12                  15600020
         LR    R7,R5                    COPY                            16000020
         LA    R0,PRFSTXT+2-PRFNBUNT    TEXT PREFIX SIZE                16400020
         CH    R8,AVTKEYLE              IS DATA SIZE > KEYLNGTH  A49213 16440022
         BNL   USEKEY                   YES, USE KEYLENGTH FOR   A49213 16480022
*                                       COMPARE                  A49213 16520022
         LR    R5,R8                    USE DATA SIZE FOR COMPRE A49213 16560022
USEKEY   EQU   *                                                 A49213 16600022
         SR    R2,R2                    CLEAR REG                A49213 16640022
         IC    R2,LCBISZE               INSERT # OF RESERVE CHAR A49213 16680022
         AR    R0,R2                    INCREMENT BY # RES CHARS A49213 16720022
         SR    R5,R0                    CALCULATE COUNT COR CLC         16800020
         BM    NOMTCH                   ONLY 1 CHAR-SKIP COMPAR SA56206 16810022
         LR    R11,RPREFIX              LOAD BUFFER ADDR         A49213 16830022
         AR    R11,R0                   INCREMENT BY LENGTH OF   A49213 16860022
*                                       PREFIX+2+ # OF RESERVE   A49213 16890022
*                                       CHARACTERS               A49213 16920022
         LA    R11,10(R11)              INCREMENT BY LENGTH OF   A49213 16950022
*                                       UNIT CTRL AREA (MINUS    A49213 16980022
*                                       THE 2 ADDITIONAL BYTES   A49213 17010022
*                                       IN REG 0) TO POINT TO    A49213 17040022
*                                       BEGINNING OF TEXT        A49213 17070022
         LR    R15,R11                  SAVE PTR TO 1ST CHAR     A49213 17100022
         EX    R5,CLCX                  CHECK FOR IDENTICAL CHARS       17200020
         BNE   NOMTCH                   BRANCH NOT IDENTICAL            17600020
*                                                                       18000020
         SR    R5,R5                    CLEAR                           18400020
         IC    R5,PRFNBUNT              NUMBER OF UNITS IN BUFFER       18800020
         LR    R10,R7                   SAVE UNITSIZE            A49213 18860022
         LR    R2,R8                    GET TOTAL DATA SIZE      A49213 18920022
         SR    R2,R10                   DECREMENT TOTAL BY LNGTH A49213 18980022
*                                       OF 1ST UNIT ALREADY      A49213 19040022
*                                       CHECKED.                 A49213 19100022
         BCTR  R7,0                     DECTEMENT FOR EXECUTED          19200020
         BCTR  R7,0                     COMPARE                         19600020
         LR    R11,RPREFIX              SET BUFFER ADDRESS       S22025 20000022
CKNB     EQU   *                                                        20400020
         BCT   R5,AROUND                LAST UNIT?               A49213 20600022
         B     SETCUT                   YES,GO SET FLAG          A49213 20800022
AROUND   EQU   *                                                 A49213 21000022
*                                                                       21200020
         L     R11,PRFTIC-IEDQPRF(R11)  NEXT UNIT ADDRESS        S22025 21600022
         CLC   ZERO(ONE,R15),PRFSUNIT-IEDQPRF(R11) SAME CHAR     A49213 22000022
*                                       AS FIRST UNIT?           A49213 22400022
         BNE   NOMTCH                   BRANCH NOT IDENTICAL            22800020
         SR    R2,R10                   DECREMENT BY UNIT SIZE   A49213 22850022
         BNM   CONTINUE                 IF NOT NEGATIVE, DATA >  A49213 22900022
*                                       UNIT SIZE, CONTINUE.     A49213 22950022
         AR    R7,R2                    ADD NEGATIVE R2 TO R7 TO A49213 23000022
*                                       OBTAIN REMAINING DATA    A49213 23050022
*                                       LENGTH.                  A49213 23100022
CONTINUE EQU   *                                                 A49213 23150022
         EX    R7,CLCUNT                COMPARE                         23200020
         BE    CKNB                     BRACH EQUAL - CHECK NEXT UNIT   23600020
*                                                                       24000020
NOMTCH   EQU   *                                                        24400020
         L     RDCB10,LCBDCBPT          DCB ADDRESS                     24800020
         USING IHADCB,RDCB10                                            25200020
         SR    R5,R5                    CLEAR IF OVER 255       SA56206 25400022
         IC    R5,DCBRESER+1            TEST RESERVE COUNT              25600020
         LA    R5,AVTTXTSZ(R5)          ADD TEXT PREFIX SIZE            26000020
         TM    PRFSTAT1,PRFNHDRN        TEXT PREFIX ?                   26400020
         BO    TEXT                     BRANCH YES                      26800020
*                                                                       27200020
         IC    R5,DCBRESER              HEADER RESERVE COUNT            28000020
         LA    R5,AVTHDRSZ(R5)          ADD HEADER PREFIX SIZE          28400020
TEXT     EQU   *                                                        28800020
         SR    R8,R5                    DATA COUNT                      29200020
TSOM     EQU   *                                                 S22029 29400022
         AL    R8,SCBBKFCT-1            ADD TO ACCUMULATED COUNT        29600020
         ST    R8,SCBBKFCT-1              ACCUMULATED                   30000020
         CLC   2(2,R1),SCBBKFCT+1       COMPARE TO CUTOFF VALUE         30400020
         BH    TEST                     BRANCH LIMIT NOT REACHED S22025 30800022
*                                                                       31200020
SETCUT   EQU   *                                                        31600020
         OI    SCBERR1,SCBCUTFN         SET ON CUTOFF FLAG IN SCB       32000020
         CLI   LCBFLAG1,AVTEZERO        IF IT A PLCB           @Y17XAMF 32006000
         BNE   NOTPLCB                  NO, BRANCH             @Y17XAMF 32012000
         LA    R0,NUMUNT                GET A BUFFER WITH      @Y17XAMF 32018000
         LA    R1,NUMBUF                 ONE UNIT VIA THE      @Y17XAMF 32024000
         L     R15,AVTSTEAL              BUFFER STEAL          @Y17XAMF 32030000
         BALR  R14,R15                   ROUTINE               @Y17XAMF 32036000
         LTR   R15,R15                  WAS BUFFER OBTAINED    @Y17XAMF 32042000
         BNZ   BLDRESET                 YES, BRANCH            @Y17XAMF 32048000
         LA    R15,FOUR                 SET RETURN CODE        @Y17XAMF 32054000
         B     EXIT                     EXIT ROUTINE           @Y17XAMF 32060000
         EJECT                                                 @Y17XAMF 32066000
***************************************************************@Y17XAMF 32072000
*        BUILD RESET IMMEDIATE FOR IEDSAO                      @Y17XAMF 32078000
***************************************************************@Y17XAMF 32084000
BLDRESET DS    0H                                              @Y17XAMF 32090000
         SH    R15,PREFIX               CALCULATE ADDR OF      @Y17XAMF 32096000
         USING IEDPF2,R15                BUFFER PREFIX         @Y17XAMF 32102000
         XC    IEDPF2(PRF2LEN),IEDPF2   INITIALIZE THE PREFIX  @Y17XAMF 32108000
         OI    PRF2FLG2,PRF2TNTI         WITH TNT INDICATORS   @Y17XAMF 32114000
         DROP  R15                                             @Y17XAMF 32120000
         SPACE 1                                               @Y17XAMF 32126000
         DROP  RPREFIX                                         @Y17XAMF 32132000
         AH    R15,PREFIX               GET ADDR TO HEADER OF  @Y17XAMF 32138000
         LR    R1,R15                    BUFFER AND SAVE FOR   @Y17XAMF 32144000
         USING IEDQPRF,R15               TPOSTING BUFFER       @Y17XAMF 32150000
         L     RSAVT,AVTSAVTP           GET ADDRESSABILITY TO  @Y17XAMF 32156000
         USING IEDNSVTD,RSAVT            SAVT                  @Y17XAMF 32162000
         MVC   PRFQCBA(L'PRFQCBA),SAVTSAO+ONE WILL TPOST TO SAO@Y17XAMF 32168000
         MVI   PRFPRI,PRIOUTQ           SET PRIORITY           @OY20385 32171086
         MVI   PRFPIUO,ONE              PIU FOLLOWS PRFPIUO    @Y17XAMF 32174000
         LA    R15,PRFPIUO+ONE          GET ADDRESSABILITY TO  @Y17XAMF 32180000
*                                        TH                    @Y17XAMF 32186000
         SPACE 1                                               @Y17XAMF 32192000
         DROP  R15                                             @Y17XAMF 32198000
         USING IEDQPRF,RPREFIX                                 @Y17XAMF 32204000
         USING IEDTH,R15                                       @Y17XAMF 32210000
         MVI   TTHBYTE0,TTH0BYT0        INITIALIZE FOR         @Y17XAMF 32216000
         MVI   TTHBYTE1,TTH0BYT1         FID0 PIU              @Y17XAMF 32222000
         MVC   TTHDAF(L'TTHDAF),PRFSRCE MOVE TTCIN OF SOURCE   @Y17XAMF 32228000
         MVC   TTHOAF(L'TTHOAF),SAVTTCPU MOVE TCAM PU TTCIN    @Y17XAMF 32234000
         XC    TTHTAG(L'TTHTAG),TTHTAG  ZERO TAG FIELD         @Y17XAMF 32240000
         MVC   TTHDCF(L'TTHDCF),DCFVAL  INDICATE LENGTH OF DATA@Y17XAMF 32246000
         DROP  R15                                             @Y17XAMF 32252000
         SPACE 1                                               @Y17XAMF 32258000
         USING IEDPIU0,R15                                     @Y17XAMF 32264000
         MVC   PIU0RH(L'PIU0RH),TRHFID0 INITIALIZE FOR         @Y17XAMF 32270000
         MVI   PIU0PAD,PIU0PAD0          FID0 PIU              @Y17XAMF 32276000
         DROP R15                                              @Y17XAMF 32282000
         SPACE 1                                               @Y17XAMF 32288000
         LA    R15,PIU0LEN(,R15)        CALCULATE ADDR OF BDU  @Y17XAMF 32294000
         USING IEDBDU,R15                                      @Y17XAMF 32300000
         MVI   BDUCMND,CD0CTRL          IS A CONTROL COMMAND   @Y17XAMF 32306000
         MVI   BDUMODIF,CD0CRI          IS A RESET IMMEDIATE   @Y17XAMF 32312000
         XC    BDUFNFLG(L'BDUFNFLG+L'BDUBDUFG+L'BDUSYRSP+L'BDUEXRSP),BD*32318000
               UFNFLG                   NO FLAGS ARE SET       @Y17XAMF 32324000
         DROP  R15                                             @Y17XAMF 32330000
         SPACE 1                                               @Y17XAMF 32336000
         L     R11,AVTEA                GET DISPATCHER ADDR    @Y17XAMF 32342000
         USING IEDQDISP,R11                                    @Y17XAMF 32348000
         LR    R0,R13                   CURRENT SAVE AREA ADDR @YM06908 32350000
         LA    R13,AVTSAVE2             DSPPOSTR'S AVT POINTER @YM06908 32352000
         BAL   R14,DSPPOSTR             TPOST THE RESET IMMED  @Y17XAMF 32354000
         LR    R13,R0                   RESTORE SAVE AREA ADDR @YM06908 32357000
         DROP  R11                                             @YM06908 32360000
         B     EXIT                                            @Y17XAMF 32366000
         EJECT                                                 @Y17XAMF 32372000
NOTPLCB  DS    0H                                              @Y17XAMF 32378000
         LA    R7,CUTFFQCB              ADDRESS OF CUTOFF QCB           32400020
         ST    R7,LCBQCBA-1             PUT CUTOFF QCB ADDR IN LCB      32800020
CKEND    EQU   *                                                        33200020
         SR    R15,R15                  INITIALIZE RETURN CODE @Y17XAMF 33400000
         TM    LCBERBST,LCBDLNKN        IS ERB POSTABLE                 33600020
         BO    SETNO                    BRANCH YES - SET NOT            34000020
*                                                                       34400020
         LA    R10,LCBERB               ERB ADDRESS                     34800020
         LA    R5,2                     SET FOR BCT                     35200020
         LA    R11,AVTBFRTB-4           BUFFER RETURN QUEUE      S22025 35600022
NEXT     EQU   *                                                        36000020
         LR    R7,R11                   SAVE LAST ELEMENT ADDR   S22025 36400022
         L     R11,4(,R7)               NEXT ELEMENT             S22025 36800022
         LA    R11,0(,R11)              CLEAR HIGH ORDER BYTE    S22025 37200022
         CLR   R11,R10                  IS ERB IN THIS QUEUE?    S22025 37600022
         BE    REMOVE                   BRANCH YES - REMOVE             38000020
*                                                                       38400020
         C     R11,AVTDELAD             IS THIS DUMMY END ELEMENTS22025 38800022
         BNE   NEXT                     BRANCH NO - CONTINUE SCAN       39200020
*                                                                       39600020
         LA    R11,AVTREADY-4           SEARCH READY QUEUE       S22025 40000022
         BCT   R5,NEXT                  SCAN READY QUEUE ONCE           40400020
*                                                                       40800020
         B     TEST                     EXIT IF IN NEITHER QUEUE S22025 41200022
*                                       WAIT                            41600020
REMOVE   EQU   *                                                        42000020
         MVC   5(3,R7),5(R11)           REMOVE ERB FROM QUEUE    S22025 42400022
SETNO    EQU   *                                                        42800020
         NI    LCBERBST,LCBDLNKF        SET ERB UN-POSTABLE             43200020
TEST     EQU   *                                                 S22025 43800022
         TM    PRFSTAT1,PRFNLSTN        IS BUFFER MARKED LAST           44400020
         BNO   TSTCUTOF                 YES CHECK CUTTOFF      @OS77010 44800000
         TM    PRFSTAT1,PRFITCPN        TEMPORARY END OF MSG   @OY15455 44900000
         BNO   EXIT                     NO, RETURN             @OS77010 45000000
TSTCUTOF EQU   *                                               @OS77010 45100000
         TM    SCBERR1,SCBCUTFN         WAS CUTOFF EXECUTED             45300020
         BC    EIGHT,EXIT               BRANCH TO EXIT IF NO     S22025 45400022
*                                                                       45500020
         OI    LCBERBST,LCBDLNKN        SET ERB POSTABLE                45600020
EXIT     EQU   *                                                 S22025 45680022
         L     R12,AVTUI                GET RETURN INTERFACE ADDRS22025 45760022
         B     FOUR(R12)                BRANCH TO RETURN ROUTINE S22025 45840022
         SPACE 1                                                 S22025 45920022
********* EXECUTED INSTRUCTIONS *********                        S22025 46000022
         SPACE 1                                                 S22025 46080022
CLCX     CLC   ZERO(ZERO,R11),ONE(R11)  COMPARE                  S22024 46160022
         SPACE 1                                                 S22025 46240022
CLCUNT   CLC   PRFNBUNT-IEDQPRF+1(1,R11),PRFNBUNT-IEDQPRF(R11)   S22024 46320022
         SPACE                                                          46400020
         EJECT                                                          46800020
*THIS CODE SETS UP THE CUTOFF QCB                                S21903 46810022
         SPACE 1                                                 S21903 46820022
         DS    0F                                                       47200020
         ORG   *-8                      SETUP FOR CUTOFF QCB     S21903 47600022
CUTFFQCB EQU   *                        START OF CUTOFF QCB             48000020
         ORG                                                            48400020
         DC    AL1(DSPMCPL4)            QCB MCPL FIELD           S21903 48800022
         DC    AL3(*-1)                 QCB POINTER FIELD        S21903 49200022
         USING CUTFFQCB,R7                                              49600020
         USING IEDQDISP,R11                                             50000020
         USING AVTSAVE2,R13                                      S22025 50200022
         SPACE                                                          50400020
         LR    R4,R1                    LCB ADDRESS TO R4               50800020
         L     RDCB10,LCBDCBPT          GET DCB ADDR FROM LCB           51200020
         USING IHADCB,RDCB10                                            51600020
         TM    LCBCSW+4,CHPGM           CHANNEL PROGRAM CHECK           52000020
         BZ    POSTBFR                  BRANCH NO - CUTOFF COMPLETE     52400020
*                                                                       52800020
         NI    LCBERBST,X'FF'-LCBERROR  RESET ERROR FLAG                53200020
         L     RDCB10,DCBDEBAD          GET DEB ADDR FROM DCB           53600020
         USING DEBNMSUB,RDCB10          DEB ADDRESSABILITY       S22024 54000022
         L     RDCB10,DEBUCBAD          UCB ADDRESS                     54400020
         LA    RCCW2,CCWLIST            POINT TO WRITE BREAK            54800020
         LA    R15,CCWLEN-1             MOVE ONE CCW                    55200020
         IC    R0,UCBTBYT4-UCBOB(RDCB10)    PICK UP UNIT TYPE           55600020
         STC   R0,AVTDOUBL              STORE IN AVT                    56000020
         NI    AVTDOUBL,ADAPMASK        CLEAR LOW-ORDER NIBBLE          56400020
         CLI   AVTDOUBL,TTAI            IS IT TELEGRAPH ADAPTER I       56800020
         BE    SETCCWAD                 YES, GO DO WRITE BREAK          57200020
         SPACE                                                          57600020
         LA    RCCW2,CCWLEN(,RCCW2)     POINT TO READ SKIP              59200020
         CLI   AVTDOUBL,IBMAIII         IS IT IBM ADAPTER III           59600020
         BNE   SETCCWAD                 NO, GO DO READ SKIP             60000020
         SPACE                                                          60400020
         IC    R0,UCBTBYT1-UCBOB(RDCB10)  MODEL BYTE                    60800020
         STC   R0,AVTDOUBL              STORE IN AVT                    61200020
         NI    AVTDOUBL,MODLMASK        CLEAR HIGH-ORDER NIBBLE         61600020
         CLI   AVTDOUBL,MODEL1          IS IT MODEL 1                   62000020
         BNE   SETCCWAD                 NO, GO DO READ SKIP             62400020
         SPACE                                                          62800020
         LA    RCCW2,CCWLEN(,RCCW2)     POINT TO SPECIAL 2260 CCWS      63200020
         LA    R15,CCWLEN(,R15)         MOVE TWO CCW'S                  63600020
         SPACE                                                          64000020
SETCCWAD EQU   *                                                        64400020
         EX    R15,MVCX                 MOVE CCW TO LCB                 64800020
         STCM  R13,7,LCBCPA+17          SET DUMMY DATA ADDR    @ZA04008 65000009
         LA    RCCW2,LCBCPA+16          POINT TO WHERE MOVED            65200020
         IC    R0,LCBSTART-1            SAVE HI-BYTE             S22024 65600022
         ST    RCCW2,LCBSTART-1         POINT LCB TO CCW(S)             66000020
         STC   R0,LCBSTART-1            STORE HI-BYTE BACK       S22024 66400022
         LA    R1,LCBFLAG1              POINT R1 TO IOB                 66800020
         LA    R0,TPOP                  PICK UP TP OP CODES             67200020
         STH   R0,LCBTPCD+2             SET UP LCB                      67600020
         SPACE                                                          68000020
         EXCPVR (1),SUBSYS                                       X01004 68400004
         SPACE                                                          68800020
         B     DSPDISP                  RETURN TO DISPATCHER            69200020
         EJECT                                                          69600020
POSTBFR  EQU   *                                                        70000020
         USING IHADCB,RDCB10                                            70200020
         OI    LCBERBST,LCBDLNKN        SET ERB POSTABLE                70400020
         L     R1,LCBLSPCI-1            ADDRESS OF FIRST BUFFER         71200020
         SR    R5,R5                                                    73000020
         TM    PRFSTAT1-IEDQPRF(R1),PRFTSMSG  THIS TS MSG        S22029 73060022
         BO    TSO0500                  SKIP RESERVE COUNT       S22029 73120022
         IC    R5,DCBRESER+1            TEXT RESERVE COUNT              73200020
TSO0500  EQU   *                                                 S22029 73300022
         LA    R5,AVTTXTSZ+1(R5)        SET = ONE DATA BYTE             73400020
         STH   R5,PRFSIZE-IEDQPRF(R1)   DO NOT TRANSLATE ENTIRE BFR     74000020
         NI    PRFSTAT1-IEDQPRF(R1),X'FF'-PRFNLSTN  NOT LAST OFF        74800020
         L     R0,DCBMH-1               ADDRESS OF STARTMH              75600020
         CLI   LCBFLAG1,LCBPLCB         PSEUDO LCB             @YM06085 75680000
         BNE   GOTMH                    BR NO, HAVE QCB        @YM06085 75760000
         L     R0,LCBMHA-1              GET PROPER MH QCB      @YM06085 75840000
GOTMH    EQU   *                                               @YM06085 75920000
         ST    R0,PRFQCBA-IEDQPRF-1(R1)  SET QCB ADDRESS                76000020
         MVI   PRFPRI-IEDQPRF(R1),PRIMHBFR   SET PRIORITY               76400020
         BAL   R14,DSPPOST              EXIT TO DISPATCHER     @Y17XAMX 76800000
*                                                                       77200020
         SPACE                                                          77600020
********* EXECUTED INSTRUCTIONS *********                               78000020
         SPACE                                                          78400020
         SPACE                                                          80000020
MVCX     MVC   LCBCPA+16(0),0(RCCW2)    MOVE                     S22024 80400022
         SPACE                                                          80800020
********* MODEL CCWS *********                                          81200020
         SPACE                                                          81600020
CCWLIST  CCW   13,CCWLIST,X'00',30      WRITE BREAK                     82000020
         SPACE                                                          82400020
         CCW   2,CCWLIST,X'10',65535    READ SKIP                       82800020
         SPACE                                                          83200020
         CCW   66,CCWLIST,X'70',960     SPECIAL 2848 READ SKIP          83600020
         CCW   65,CCWLIST,X'00',1000    SPECIAL 2848 BREAK              84000020
         EJECT                                                          84400020
********* OTHER EQUATES *********                                       84800020
         SPACE                                                          85200020
CHPGM    EQU   X'20'                    FLAG                     S22024 85600022
TPOP     EQU   X'0202'                  FLAGS                    S22024 86000022
ADAPMASK EQU   X'F0'                    LOW-ORDER NIBBLE CLEAR MASK     86400020
TTAI     EQU   X'40'                    TELEGRAPH ADAPTER TYPE I        86800020
TTAII    EQU   X'50'                    TELEGRAPH ADAPTER TYPE II       87200020
IBMAIII  EQU   X'80'                    IBM ADAPTER TYPE III            87600020
MODLMASK EQU   X'0F'                    HI-ORDER NIBBLE CLEAR MASK      88000020
MODEL1   EQU   X'01'                    MODEL 1 FLAG                    88400020
ZERO     EQU   0                        VALUE 0                  S22024 88600022
         SPACE                                                          88800020
TPOPCUTF EQU   0                        CUTOFF CLEANUP TP OP CODE       89200020
ONE      EQU   1                        INCREMENT VALUE OF 1            89600020
CCWLEN   EQU   8                        LENGTH OF ONE CCW               90000020
REG2OFF  EQU   28                       OFFSET TO REG2 IN SAVE AREA     90400020
DCFVAL   DC    AL2(TRH1LEN+BDULEN+L'PIU0PAD) DATA CNT FLD VAL  @Y17XAMF 90450000
TRHFID0  DC    X'0B8000'                FID0 RH VALUE          @Y17XAMF 90500000
TPREFIX  DS    0H                                              @Y17XAMF 90550000
         DC    AL2(TRMPRFSZ)            LEN OF TTE PREFIX      @Y17XAMF 90600000
PREFIX   DS    0H                                              @Y17XAMF 90650000
         DC    AL2(PRF2LEN)             LEN OF BUFFER PREFIX   @Y17XAMF 90700000
********** DSECTS ********                                              90800020
         SPACE                                                          91200020
         TAVTD                                                          91600020
         EJECT                                                          91660000
         TBDUD                                                          91720000
         EJECT                                                          91780000
         TCD0D                                                          91840000
         EJECT                                                          91900000
         DCBD  DSORG=TX                                                 92000020
         TDEBD                                                          92400020
         EJECT                                                          92500007
         TQCBD                                                          92600007
         EJECT                                                          92700007
         TDISPD                                                         92800020
         TLCBD                                                          93200020
         EJECT                                                          93300000
         TPIU0D                                                         93400000
         EJECT                                                          93500000
         TPRFD                                                          93600020
         TPRIOR                                                         94000020
         TSCBD                                                          94400020
         IEFUCBOB                                                       94800020
         TTRMD ,                                                 S22024 94900022
         EJECT                                                          94960000
         TRHD                                                           95020000
         EJECT                                                          95080000
         TTHD                                                           95140000
         END                                                            95200020
