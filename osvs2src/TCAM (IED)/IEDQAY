AY01     TITLE '''IEDQAY'' -- SCREEN ROUTINE'                           00200000
IEDQAY   CSECT                                                          00400000
         SPACE 3                                                        00600000
*CHANGE ACTIVITY = AS FOLLOWS:                                          00800000
*************** MICROFICHE FLAGS **************************** SUPT CODE 01000000
*A255000,301000                                                  S22025 01206000
*C468000,474000                                                  S22025 01206100
*D301000-305000                                                  S22025 01206200
*A336000                                                         A49230 01206300
*C302000-303000                                                  A49230 01206400
*D342000                                                         A49230 01206500
*A262000,396000,446000                                           A42385 01206600
*C303000                                                         A42385 01206700
*A612000                                                         A50185 01206800
*C303000,642000                                                  A50185 01206900
*D615000                                                        SA57324 01207000
*A642100,654100                                                 SA57324 01207100
*A301000                                                        SA59983 01207200
*A636000                                                        SA61048 01207300
*A301000                                                        SA66920 01210354
*D180700                                                       @OY14057 01210610
*A886000                                                       @OY14057 01210910
*A309100,306120,307060,809000                                  @Y17XAMG 01211310
*C306120,306180,306240,307040                                  @Y17XAMG 01212310
*A306080,                                                      @Y17XAMO 01213010
*C306100,310480                                                @Y17XAMO 01213710
         SPACE 3                                                        01214400
*********************************************************************** 01215020
*                                                                     * 01220000
*TITLE: IEDQAY - SCREEN ROUTINE                                       * 01220500
*                                                                     * 01221000
*MODULE NAME = IEDQAY                                                 * 01221500
*                                                                     * 01222000
*DESCRIPTIVE NAME = SCREEN ROUTINE                                    * 01222500
*                                                                     * 01223000
*COPYRIGHT = 'NONE'                                                   * 01223500
*                                                                     * 01224000
*STATUS -- CHANGE LEVEL 10                                       X03039 01224510
*                                                                     * 01225020
*FUNCTION -- INITIALIZES THE SYSTEM FOR PERFORMANCE OF A SCREEN       * 01230020
*   COMMAND MODIFICATION ON THIS DESTINATION.                         * 01235020
*                                                                     * 01240020
*   ON ENTRY,  THE ROUTINE ACCESSES THE UCB AND DETERMINES IF THE     * 01245020
*   DESTINATION IS AN IBM 2260 LOCAL OR REMOTE.  IF LOCAL,  THE       * 01250020
*   ROUTINE USES AN INDEX BYTE PASSED IN THE PARAMETER LIST TO        * 01255020
*   SELECT THE FUNCTION BYTE REQUESTED FROM AN INTERNALLY-DEFINED     * 01260020
*   TABLE.  THIS FUNCTION BYTE IS SET IN THE KEY FIELD OF THE         * 01265020
*   BUFFER AND THE SCREEN REQUEST BIT IN THE LCB (LCBSCRNN) IS SET.   * 01270020
*   RETURN IS MADE TO THE CALLER WITH THE NEW FUNCTION BYTE IN        * 01275020
*   REGISTER 15.                                                      * 01280020
*                                                                     * 01285020
*   IF REMOTE,  THE ROUTINE VERIFIES THAT THE DESTINATION IS A        * 01290020
*   SCREEN DEVICE.  IF IT IS NOT,  RETURN IS MADE TO THE CALLER       * 01295020
*   WITH ZEROES IN REGISTER 15.  IF IT IS,  A LINK IS MADE TO THE     * 01300020
*   TNT CODE (AVTRNMPT) TO GET THE ADDRESS OF THE DESTINATION'S       * 01305020
*   TERMINAL TABLE ENTRY.  THE DEVICE DEPENDENT AREA IS FOUND IN      * 01310020
*   THE ENTRY.  THE CURRENT SETTING OF THE FUNCTION BYTE IS SET IN    * 01315020
*   REGISTER 15.  IF A CHANGE OF FUNCTION IS REQUESTED,  THE NEW      * 01320020
*   FUNCTION BYTE IS SELECTED AND REPLACES THE CURRENT FUNCTION       * 01325020
*   BYTE IN THE TERMINAL TABLE ENTRY.  RETURN IS MADE TO THE          * 01330020
*   CALLER.                                                           * 01335020
*                                                                     * 01340020
*ENTRY POINT --                                                       * 01345020
*       'IEDQAY01' TO INITIALIZE FOR MODIFYING A SCREEN COMMAND.      * 01350020
*   CALLING SEQUENCE FROM USER INTERFACE IS:                          * 01355020
*                                                                     * 01360020
*                                                                     * 01365020
*        L     R12,AVTMSGS-1            GET ADDR OF VCON TABLE        * 01370020
*        IC    R15,AVTEZERO(,R1)        GET INDEX TO ROUTINE ADDR     * 01375020
*        L     R12,AVTEZERO(R12,R15)    GET ROUTINE ADDRESS           * 01380020
*        BR    R12                      EXIT TO ROUTINE               * 01385020
*                                                                     * 01390020
*INPUT --                                                             * 01395020
*   REGISTER 1 - THE ADDRESS OF A MACRO-GENERATED PARAMETER LIST.     * 01400020
*   PARAMETER LIST FORMAT IS:                                         * 01405020
*                                                                     * 01410020
*        *****************    REQUEST CODES:                          * 01415020
*        * INDEX *REQUEST*      X'00' - WRITE AT DISPLAY CURSOR       * 01420020
*        *  TO   * CODE  *      X'01' - WRITE AT LINE ADDRESS         * 01425020
*        *   AY  *       *      X'02' - WRITE ERASE                   * 01430020
*        *****************                                            * 01435020
*                                                                     * 01440020
*        AY INDEX BYTE: X'01' ON - COMMAND CHANGE REQUESTED           * 01445020
*                       X'01' OFF - RETURN CURRENT SETTING ONLY       * 01450020
*                                                                     * 01455020
*   REGISTER 4 - ADDRESS OF THE LCB                                   * 01460020
*                                                                     * 01465020
*   REGISTER 6 - ADDRESS OF CURRENT BUFFER                            * 01470020
*                                                                     * 01475020
*   REGISTER 9 - ADDRESS OF THE AVT                                   * 01480020
*                                                                     * 01485020
*   REGISTER 12 - ENTRY POINT ADDRESS AND BASE FOR THIS ROUTINE.      * 01490020
*                                                                     * 01495020
*OUTPUT --                                                            * 01500020
*   REGISTER 15 - CURRENT FUNCTION BYTE IF THE FUNCTION IS PER-       * 01505020
*   FORMED.  ZEROES IF THE FUNCTION IS NOT PERFORMED.                 * 01510020
*                                                                     * 01515020
*   PREFIX KEY FIELD (PRFKEY) - FOR LOCAL TERMINALS WHEN A COMMAND    * 01520020
*   CHANGE IS REQUESTED,  CONTAINS THE FUNCTION BYTE FOR THE          * 01525020
*   COMMAND REQUESTED.                                                * 01530020
*                                                                     * 01535020
*   TERMINAL TABLE ENTRY - FOR REMOTE TERMINALS WHEN A COMMAND        * 01540020
*   CHANGE IS REQUESTED,  THE FUNCTION BYTE IS CHANGED AS SPECIFIED   * 01545020
*                                                                     * 01550020
*EXTERNAL REFERENCES --                                               * 01555020
*   AVTRNMPT - TERMINAL NAME TABLE CODE                               * 01560020
*                                                                     * 01565020
*   AVT - ADDRESS VECTOR TABLE                                        * 01580020
*                                                                     * 01585020
*   BUFFER CURRENTLY BEING PROCESSED                                  * 01590020
*                                                                     * 01595020
*   LCB - LINE CONTROL BLOCK                                          * 01600020
*                                                                     * 01605020
*   DCB - DATA CONTROL BLOCK                                          * 01610020
*                                                                     * 01615020
*   DEB - DATA EVENT BLOCK                                            * 01620020
*                                                                     * 01625020
*   UCB - UNIT CONTROL BLOCK                                          * 01630020
*                                                                     * 01635020
*   TERMINAL TABLE ENTRY FOR THE DESTINATION                          * 01640020
*                                                                     * 01645020
*EXITS,  NORMAL --                                                    * 01650020
*   THE REQUESTED COMMAND CHANGE IS INITIALIZED.  REGISTER 15 CON-    * 01655020
*   TAINS THE CURRENT SETTING OF THE COMMAND.                         * 01660020
*                                                                     * 01665020
*   NO COMMAND CHANGE IS REQUESTED.  REGISTER 15 CONTAINS THE         * 01670020
*   CURRENT SETTING OF THE COMMAND.                                   * 01675020
*                                                                     * 01680020
*EXITS,  ERROR --                                                     * 01685020
*   THE DESTINATION TERMINAL IS NOT A SCREEN DEVICE.  REGISTER 15     * 01690020
*   CONTAINS ZERO.                                                    * 01695020
*                                                                     * 01700020
*TABLES/WORK AREAS --                                                 * 01705020
*   A TABLE OF COMMAND CODES FOR LOCAL SCREEN DEVICE                  * 01710020
*   A TABLE OF COMMAND CODES FOR REMOTE SCREEN DEVICE                 * 01715020
*                                                                     * 01720020
*ATTRIBUTES -- SERIALLY REUSABLE,  REFRESHABLE,  ENABLED,             * 01725020
*   RESIDENT,  PROBLEM PROGRAM MODE.                                  * 01730020
*                                                                     * 01735020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON AN        * 01740020
*   INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET.            * 01745020
*                                                                     * 01750020
*********************************************************************** 01755020
         EJECT                                                          01760020
********* REGISTER EQUATES *********                                    01800020
         SPACE                                                          02400020
R0       EQU   0                        WORK REGISTER                   03000020
         SPACE                                                          03600020
R1       EQU   1                        PARAM REG & WORK REG            04200020
         SPACE                                                          04800020
RWORK2   EQU   2                        WORK REGISTER                   05400020
         SPACE                                                          06000020
RLCB4    EQU   4                        LCB ADDRESS                     06600020
         SPACE                                                          07200020
RWORK5   EQU   5                        WORK REGISTER                   07800020
         SPACE                                                          08400020
RPREFIX  EQU   6                        BUFFER ADDRESS                  09000020
         SPACE                                                          09600020
RUCB7    EQU   7                        UCB ADDRESS                     10200020
RWORK7   EQU   7                                                 S99228 10500022
         SPACE                                                          10800020
RPARM8   EQU   8                        PARAMETER LIST ADDRESS          11400020
         SPACE                                                          12000020
RAVT9    EQU   9                        ADDRESS OF AVT                  12600020
         SPACE                                                          13200020
RBASE    EQU   12                       BASE REGISTER                   13800020
         SPACE                                                          14400020
R13      EQU   13                       AVT BASE                        15000020
R14      EQU   14                       RETURN REG & WORK REG           15600020
R15      EQU   15                       LINK REG & WORK REG             16200020
         SPACE                                                          16800020
********* OTHER EQUATES *********                                       17400020
         SPACE                                                          18000020
LEAUCMD  EQU   X'0F'                    LOCAL EAU COMMAND        S99228 18030022
LWRECMD  EQU   X'05'                    LOCAL WRE COMMAND        S99228 18060022
ZERO     EQU   0                                                 S99228 18090022
EIGHT    EQU   8                                                 S99228 18120022
TWELVE   EQU   12                                                S99228 18130022
D16      EQU   16                                                S99228 18150022
D20      EQU   20                                                S99228 18180022
X20      EQU   X'20'                                             S99228 18210022
TWO      EQU   2                                                 S99228 18300022
HDRSZE   EQU   X'1E'                    SIZE OF TCAM HEADER      S99228 18330022
PREFSZE  EQU   X'0C'                    SIZE OF PREFIX           S99228 18360022
EQUAL    EQU   8                                                 S99228 18390022
ESC      EQU   X'27'                    ESCAPE CHARACTER         S99228 18420022
ENDCHAR  EQU   X'FF'                    END OF TBLE CHAR         S99228 18510022
ADAPMASK EQU   X'F0'                    LOW-ORDER NIBBLE CLEAR MASK     18600020
IBMAIII  EQU   X'80'                    IBM ADAPTER TYPE III            19200020
MODLMASK EQU   X'0F'                    HI-ORDER NIBBLE CLEAR MASK      19800020
MODEL1   EQU   X'01'                    MODEL 1 FLAG                    20400020
         SPACE                                                          21000020
GRAPHICS EQU   X'10'                    DEVICE CLASS, UCB               21600020
         SPACE                                                          22200020
PARMSET  EQU   1                        REQUEST CODE IN PARM LIST       22800020
DOITFLAG EQU   X'01'                    FUNCTION REQUEST FLAG           23400020
         SPACE                                                          24000020
ONE      EQU   1                        INCREMENT VALUE OF ONE          24600020
THREE    EQU   3                        LENGTH OF ADDRESSING CHARS      25200020
FOUR     EQU   4                        OFFSET USED ON RETURN    S22025 25500022
SEVEN    EQU   7                        SHIFT FACTOR OF SEVEN BITS      25800020
LINEADD  EQU   X'01'                    WRITE LINE ADDRESS MASK IN      25900020
*                                         PARAMETER LIST                26000020
CMDERASE EQU   X'07'                    COMMAND CODE FOR ERASE          26100020
CMDLNADD EQU   X'05'                    COMMAND CODE LINE ADDRESS       26200020
NRESTORE EQU   X'10'                    WRITE W/O KEYBOARD RSTR  A42385 26300022
         EJECT                                                          26400020
         USING IEDQAVTD,RAVT9                                           27000020
         USING IEDQLCB,RLCB4                                            27600020
         USING IEDQPRF,RPREFIX                                          28200020
         USING IEDQAY01,RBASE                                           28800020
         SPACE                                                          29400020
IEDQAY01 EQU   *                                                        30000020
IEDQAY   IEDHJN SCREEN                  MODULE ID                S22025 30100022
         SR    RPARM8,RPARM8            CLEAR WORK REGISTER     SA66920 30120054
         CH    RPARM8,PRFSIZE           ZERO LENGTH BUFFER ?    SA66920 30140054
         BE    EXIT                     BRANCH YES- LEAVE       SA66920 30160054
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER           SA59983 30200000
         BO    EXIT                     BRANCH IF NO            SA59983 30300000
         LR    RPARM8,R1                SAVE PARAMETER LIST ADDRESS     30600020
         LH    R1,LCBTTCIN              CURRENT TERMINAL INDEX   S99228 30602022
         N     R1,AVTCLRHI              CLEAR HI-ORDER 2 BYTES   S99228 30604022
         L     R15,AVTRNMPT             ADDRESS TERMINAL TABLE   S99228 30606022
         BALR  R14,R15                  GET TERM ENTRY ADDRESS   S99228 30608022
         LA    R14,TRMPRFSZ             GET PREFIX SIZE        @Y17XAMO 30608610
         SR    R1,R14                   BACK UP TO PREFIX      @Y17XAMO 30609210
         USING IEDNTRM,R1               SET UP ADDRESSABILITY  @Y17XAMO 30610010
         IEDDCT REG=RWORK7,FLD=DCTWKARA FETCH DCT ENTRY        @Y17XAMG 30611010
         USING IEDDCT,RWORK7                                   @Y17XAMG 30612010
         SR    R15,R15                  INIT RETURN CODE REG     S99228 30622022
         TM    DCTBYTE1,DCT3270         3270 DEVICE            @Y17XAMG 30624010
         BO    CKBADOP                  YES-BRANCH               S99228 30626022
         USING SCRNPARM,RPARM8                                   S99228 30628022
         CLI   SCRNREQ,EAU              EAU REQUEST FOR 2260     S99228 30630022
         BNE   CONT2260                 NO-CONTINUE 2260 PROCESS S99228 30632022
BADREQ   DS    0H                                                S99228 30634022
         LA    R15,FOUR                 EAU INVALID EXCEPT FOR   S99228 30636022
*                                       3270                     S99228 30638022
         B     EXIT                     EXIT                     S99228 30640022
CKBADOP  DS    0H                       CHECK FOR VALID 3270     S99228 30642022
*                                       OPERATION                S99228 30644022
         LA    R1,SCRNREQ               ADDRESS OF SCREEN        S99228 30646022
*                                       REQUEST CODE             S99228 30648022
         SR    RWORK2,RWORK2            INDICATE SEARCH FOR      S99228 30650022
*                                       REQUEST CODE             S99228 30652022
         BAL   R14,TBLSRCH              GO SEARCH FOR REQUEST    S99228 30654022
*                                       CODE IN COMMAND TABLE    S99228 30656022
         LTR   RWORK2,RWORK2            REQUEST CODE FOUND       S99228 30658022
         BZ    BADONE                   NO-BRANCH                S99228 30660022
         SR    R0,R0                                             S99228 30662022
         IC    R0,TWO(RWORK2)           GET LOCAL COMMAND CODE   S99228 30664022
*                                       FROM TABLE- TO BE USED   S99228 30666022
*                                       LATER                    S99228 30668022
*    CHECK FOR NO OPERANDS AT ALL- THIS IS INVALID FOR 3270      S99228 30670022
         TM    SCRNNDX,REQFLAG          ANY REQUEST SPECIFIED    S99228 30672022
         BO    GO3270                   YES-BRANCH               S99228 30674022
         TM    SCRNFLGS,RETRIEVE        RETRIEVE=YES SPECIFIED   S99228 30676022
         BO    GO3270                   YES-BRANCH               S99228 30678022
BADONE   DS    0H                                                S99228 30680022
         LA    R15,FOUR                 INVALID COMMAND FOR 3270 S99228 30682022
         B     EXIT                     EXIT                     S99228 30684022
*****************************************************************S99228 30686022
*                                                                S99228 30688022
*                                                                S99228 30690022
*        3270 SCREEN PROCESSING                                  S99228 30692022
*                                                                S99228 30694022
*                                                                S99228 30696022
*****************************************************************S99228 30698022
GO3270   DS    0H                       PROCESS 3270 SCREEN      S99228 30700022
*                                       REQUESTS                 S99228 30702022
         TM    DCTBYTE2,DCTLOCAL        LOCAL 3270             @Y17XAMG 30704010
         BO    LOC3270                  YES-BRANCH               S99228 30706022
         DROP  RWORK7                                          @Y17XAMG 30707010
*****************************************************************S99228 30708022
*                                                                S99228 30710022
*        REMOTE 3270 PROCESSING                                  S99228 30712022
*                                                                S99228 30714022
*****************************************************************S99228 30716022
         TM    SCRNFLGS,RETRIEVE        RETRIEVE=YES SPECIFIED   S99228 30718022
         BNO   ESCPSRCH                 NO-BRANCH                S99228 30720022
*****************************************************************S99228 30722022
*        RETRIEVE=YES                                            S99228 30724022
*****************************************************************S99228 30726022
         TM    SCRNNDX,REQFLAG          REQUEST SPECIFIED        S99228 30728022
         BO    ESCPSRCH                 YES-BRANCH               S99228 30730022
         LA    R15,FOUR                 CANNOT HAVE ONLY         S99228 30732022
*                                       RETRIEVE=YES             S99228 30734022
         B     EXIT                     EXIT                     S99228 30736022
*****************************************************************S99228 30738022
*        RETRIEVE=NO (OR NOT SPECIFIED)                          S99228 30740022
*****************************************************************S99228 30742022
ESCPSRCH DS    0H                                                S99228 30744022
         BAL   R14,ESCFIND              FIND ESCAPE CHAR         S99228 30746022
         LTR   R1,R1                    ESCAPE CHAR FOUND        S99228 30748022
         BZ    NOESC                    NO-BRANCH                S99228 30750022
         LA    RWORK7,ONE(R1)           ADDRESS OF WHERE COMMAND S99228 30752022
*                                       CODE WILL BE PUT(RIGHT   S99228 30754022
*                                       AFTER ESCAPE CHAR IN     S99228 30756022
*                                       BUFFER UNIT)             S99228 30758022
         LA    R1,SCRNREQ               ADDRESS OF REQUEST CODE  S99228 30760022
         SR    RWORK2,RWORK2            INDICATE SEARCH FOR REQ  S99228 30762022
         BAL   R14,TBLSRCH              SEARCH COMMAND TABLE     S99228 30764022
         MVC   ZERO(ONE,RWORK7),ONE(RWORK2) PUT COMMAND CODE     S99228 30766022
*                                       INTO BUFFER UNIT         S99228 30768022
         B     EXIT                     EXIT                     S99228 30770022
NOESC    DS    0H                                                S99228 30772022
         LA    R15,EIGHT                ESCAPE CHAR NOT FOUND    S99228 30774022
         B     EXIT                     EXIT                     S99228 30776022
*****************************************************************S99228 30778022
*                                                                S99228 30780022
*        LOCAL 3270                                              S99228 30782022
*                                                                S99228 30784022
*****************************************************************S99228 30786022
LOC3270  DS    0H                                                S99228 30788022
         TM    SCRNFLGS,RETRIEVE        RETRIEVE=YES             S99228 30790022
         BO    GETCMD                   YES-BRANCH               S99228 30792022
*****************************************************************S99228 30794022
*        RETRIEVE=NO (OR NOT SPECIFIED)                          S99228 30796022
*****************************************************************S99228 30798022
         LR    R1,R0                    SCREEN REQUEST(CONVERTED S99228 30800022
*                                       TO LOCAL COMMAND CODE)   S99228 30802022
         BAL   R14,CCWSETUP             GO SET UP CCW            S99228 30804022
         B     EXIT                     EXIT                     S99228 30806022
*****************************************************************S99228 30808022
*        RETRIEVE=YES                                            S99228 30810022
*****************************************************************S99228 30812022
GETCMD   DS    0H                                                S99228 30814022
         BAL   R14,ESCFIND              LOCATE ESCAPE CHAR       S99228 30816022
         LTR   R1,R1                    ESCAPE CHAR FOUND        S99228 30818022
         BZ    BADCMD                   NO-BRANCH                S99228 30820022
         LA    R1,ONE(R1)               1ST CHAR AFTER ESCAPE IS S99228 30822022
*                                       REMOTE COMMAND CODE      S99228 30824022
         LA    RWORK2,ONE               INDICATE SEARCH FOR      S99228 30826022
*                                       REMOTE COMMAND CODE      S99228 30828022
         BAL   R14,TBLSRCH              SEARCH COMMAND TABLE     S99228 30830022
         LTR   RWORK2,RWORK2            COMMAND CODE FOUND       S99228 30832022
         BZ    BADCMD                   NO-BRANCH                S99228 30834022
*                                                                S99228 30836022
*        VALID COMMAND IN DATA STREAM                            S99228 30838022
*                                                                S99228 30840022
         SR    R1,R1                                             S99228 30842022
         IC    R1,ONE(RWORK2)           GET LOCAL COMMAND CODE   S99228 30844022
*                                       FROM TABLE               S99228 30846022
         BAL   R14,CCWSETUP             GO SET UP CHANNEL PROGRAMS99228 30848022
         B     EXIT                     EXIT                     S99228 30850022
*                                                                S99228 30852022
*        INVALID COMMAND OR COMMAND NOT FOUND IN DATA STREAM     S99228 30854022
*                                                                S99228 30856022
BADCMD   DS    0H                                                S99228 30858022
         TM    SCRNNDX,REQFLAG          ANY REQUESTS SPECIFIED   S99228 30860022
         BO    DEFAULT                  YES-BRANCH               S99228 30862022
         LA    R15,EIGHT                INVALID DATA STREAM      S99228 30864022
*                                       CONTENT                  S99228 30866022
         B     EXIT                     EXIT                     S99228 30868022
DEFAULT  DS    0H                                                S99228 30870022
         LR    R1,R0                    USE REQUEST SPECIFIED    S99228 30872022
*                                       ON SCREEN MACRO          S99228 30874022
*                                       (CONVERTED TO LOCAL      S99228 30876022
*                                       COMMAND CODE)            S99228 30878022
         BAL   R14,CCWSETUP             SET UP CHANNEL PROGRAM   S99228 30880022
         LA    R15,TWELVE               DEFAULT USED RETURN CODE S99228 30881022
         B     EXIT                     EXIT                     S99228 30882022
*****************************************************************S99228 30884022
*                                                                S99228 30886022
*        ESCFIND- SEARCHES FOR AN ESCAPE CHARACTER IN THE BUFFER S99228 30888022
*        INPUT- NONE REQUIRED                                    S99228 30890022
*        OUTPUT- R1 CONTAINS ADDRESS OF ESCAPE CHARACTER         S99228 30892022
*                OR 0 IF ESCAPE CHAR NOT FOUND                   S99228 30894022
*                                                                S99228 30896022
*****************************************************************S99228 30898022
ESCFIND  DS    0H                                                S99228 30900022
         SR    RWORK2,RWORK2                                     S99228 30902022
         IC    RWORK2,LCBISZE           NUMBER OF IDLES          S99228 30904022
         LA    R1,PREFSZE+HDRSZE(RWORK2,RPREFIX)   ADDRESS OF    S99228 30906022
*                                       BEGINNING OF DATA IN     S99228 30908022
*                                       1ST UNIT OF BUFFER       S99228 30910022
         CLI   LCBFLAG1,0               PLCB?                  @Y17XAMG 30910110
         BNE   NOTPLCB                  BRANCH IF NOT          @Y17XAMG 30910210
         TM    LCBSTAT5,LCBLUNIT        LU?                    @Y17XAMG 30910310
         BZ    NOTPLCB                  BRANCH IF NOT          @Y17XAMG 30910410
*                                       ITS AN LU, THEREFORE   @Y17XAMG 30910510
*                                       NO EXCAPE CHARACTER    @Y17XAMG 30910610
         BCTR  R1,0                     SET UP TO USER FIRST   @Y17XAMG 30910710
*                                       DATA CHAR AS COMMAND   @Y17XAMG 30910810
         BR    R14                      RETURN TO CALLER       @Y17XAMG 30910910
NOTPLCB  EQU   *                                               @Y17XAMG 30911010
         LH    RWORK5,PRFSIZE           SIZE OF DATA             S99228 30912022
         LA    RWORK2,HDRSZE(RWORK5)    ADD TCAM HDR SIZE TO     S99228 30914022
*                                       SIZE OF DATA IN ENTIRE   S99228 30916022
*                                       BUFFER(INCLUDES IDLES)   S99228 30918022
         CH    RWORK2,AVTKEYLE          DOES DATA FILL 1ST UNIT  S99228 30920022
         BL    NOTFULL                  NO-BRANCH                S99228 30922022
         LH    RWORK2,AVTKEYLE          KEY LENGTH               S99228 30924022
         LA    RWORK5,PREFSZE(RPREFIX,RWORK2)   ADDRESS OF END   S99228 30926022
*                                       OF 1ST UNIT              S99228 30928022
         B     SUBONE                   BEGIN SEARCH FOR ESCAPE  S99228 30930022
*                                       CHARACTER                S99228 30932022
NOTFULL  DS    0H                                                S99228 30934022
         LA    RWORK5,PREFSZE+HDRSZE(RPREFIX,RWORK5)  ADDRESS    S99228 30936022
*                                       OF END OF DATA IN        S99228 30938022
*                                       1ST UNIT                 S99228 30940022
SUBONE   DS    0H                                                S99228 30942022
         BCTR  RWORK5,R0                SUBTRACT ONE BECAUSE     S99228 30944022
*                                       ESCAPE IS INVALID AS     S99228 30946022
*                                       LAST CHAR IN DATA        S99228 30948022
ESCLOOP  DS    0H                                                S99228 30950022
         CR    R1,RWORK5                ARE WE AT END OF THE     S99228 30952022
*                                       DATA(OR END OF THE 1ST   S99228 30954022
*                                       UNIT) MINIS ONE          S99228 30956022
         BL    ESCCOMP                  YES-BRANCH               S99228 30958022
         SR    R1,R1                    ESCAPE NOT FOUND OR NOT  S99228 30960022
*                                       ENOUGH ROOM FOR NEW      S99228 30962022
*                                       OPERATION CODE           S99228 30964022
         BR    R14                      RETURN                   S99228 30966022
ESCCOMP  DS    0H                                                S99228 30968022
         CLI   ZERO(R1),ESC             ESCAPE CHAR              S99228 30970022
         BCR   EQUAL,R14                YES-RETURN               S99228 30972022
         LA    R1,ONE(R1)               INCREMENT SCANNER        S99228 30974022
         B     ESCLOOP                  CONTINUE LOOP            S99228 30976022
*****************************************************************S99228 30978022
*                                                                S99228 30980022
*        CCWSETUP- THIS SUBROUTINE SETS UP OR BUILDS CHANNEL     S99228 30982022
*          PROGRAMS. THE FOLLOWING REPRESENTS WHAT IS DONE FOR   S99228 30984022
*          EACH COMMAND CODE(OP CODE).                           S99228 30986022
*                                                                S99228 30988022
*            EAU-                                                X03039 30990010
*             NON-VTAM - EAU CHANNEL PROGRAM IS BUILT IN THE LCB X03039 30990910
*                                                                X03039 30991810
*             VTAM - THE EAU OP CODE IS SAVED IN PRFOPCDE AND    X03039 30992710
*             LCBSCRNN IS TURNED ON. IEDIAF WILL USE THIS TO     X03039 30993610
*             BUILD THE LOGICAL CHANNEL PROGRAM.                 X03039 30994510
*                                                                X03039 30995410
*            WRE-THE WRE OP CODE IS SAVED IN PRFOPCDE AND        X03039 30996310
*            LCBSCRNN IS TURNED ON. EITHER IEDQGA (NON-VTAM) OR  X03039 30997210
*            IEDIAF (VTAM) USES THIS TO BUILD THE WRE CHANNEL    X03039 30998110
*            PROGRAM.                                            X03039 30999010
*                                                                S99228 31000022
*            WDC-NOTHING IS DONE FOR THE WDC COMMAND BECAUSE THE S99228 31002022
*            CHANNEL PROGRAM WILL DEFAULT TO WDC IN IEDQGA       X03039 31004010
*            (NON-VTAM) OR IEDIAF (VTAM).                        X03039 31005010
*                                                                S99228 31006022
*        INPUT- R1 CONTAINS THE LOCAL COMMAND CODE               S99228 31008022
*                                                                S99228 31010022
*****************************************************************S99228 31012022
CCWSETUP DS    0H                                                S99228 31014022
         LA    RWORK5,LEAUCMD                                    S99228 31016022
         CR    RWORK5,R1                EAU REQUEST              S99228 31018022
         BNE   CKLOCWRE                 NO-BRANCH                S99228 31020022
         CLI   LCBFLAG1,AVTEZERO        VTAM PLCB                X03039 31020510
         BE    SETCODE                  BR YES                   X03039 31021010
*                                                                X03039 31021510
         STC   R1,LCBCPA+D16            PUT EAU COMMAND INTO     S99228 31022022
*                                       INITIAL CHANNEL PRGRAM   S99228 31024022
*                                       (WILL OVERLAY SELECT CMD)S99228 31026022
         LA    R0,X20                                            S99228 31028022
         STC   R0,LCBCPA+D20            DO NOT CHAIN EAU(3270    S99228 31030022
*                                       HARDWARE RESTRICTION)    S99228 31032022
         MVI   LCBTPCD+TWO,TPEAU        PUT TP OP CODE IN LCB    S99228 31033022
         B     ENDCCWSU                 ALL DONE                 S99228 31034022
CKLOCWRE DS    0H                                                S99228 31036022
         LA    RWORK5,LWRECMD                                    S99228 31038022
         CR    RWORK5,R1                WRE REQUEST              S99228 31040022
         BNE   ENDCCWSU                 NO-BRANCH-  DEFAULT TO   S99228 31042022
*                                       WDC(ALREADY BUILT IN     S99228 31044022
*                                       CHANNEL PROGRAM)         S99228 31046022
SETCODE  EQU   *                                                 X03039 31047010
         STC   R1,PRFOPCDE              PUT OP CODE IN BUFFER  @Y17XAMO 31048010
         OI    LCBCHAIN,LCBSCRNN        TURN ON BIT TO TELL      S99228 31050022
*                                       IEDQGD THAT THE OP CODE  S99228 31052022
*                                       IS IN THE BUFFER         S99228 31054022
ENDCCWSU DS    0H                                                S99228 31056022
         BR    R14                      RETURN TO CALLER         S99228 31058022
*****************************************************************S99228 31060022
*                                                                S99228 31062022
*        TBLSRCH- THIS SUBROUTINE SEARCHES FOR A SPECIFIED CHAR  S99228 31064022
*              IN THE COMMAND TABLE                              S99228 31066022
*                                                                S99228 31068022
*        CMDTBL - COMMAND TABLE                                  S99228 31070022
*              EACH ENTRY CONSIST OF 3 BYTES                     S99228 31072022
*                 1ST - SCREEN PARM LIST REQUEST CODE            S99228 31074022
*                 2ND - REMOTE COMMAND CODE                      S99228 31076022
*                 3RD - LOCAL COMMAND CODE                       S99228 31078022
*        A X'FF'  IN THE BYTE FOLLOWING THE LAST ENTRY INDICATES S99228 31080022
*        THE END OF THE TABLE                                    S99228 31082022
*                                                                S99228 31084022
*        INPUT                                                   S99228 31086022
*              R1- ADDRESS OF SEARCH ARGUMENT                    S99228 31088022
*              RWORK2- 0  SEARCH ARG IS A SCREEN PARMLIST        S99228 31090022
*                         REQUEST CODE                           S99228 31092022
*                      1  SEARCH ARG IS A REMOTE COMMAND CODE    S99228 31094022
*                                                                S99228 31096022
*        OUTPUT                                                  S99228 31098022
*              R1- ADDRESS OF SEARCH ARGUMENT CHARACTER          S99228 31100022
*              RWORK2- ADDRESS OF FOUND CHARACTER OR             S99228 31102022
*                      ZERO- IF NOT FOUND                        S99228 31104022
*                                                                S99228 31106022
*****************************************************************S99228 31108022
TBLSRCH  DS    0H                                                S99228 31110022
         LA    RWORK5,CMDTBL            ADDRESS OF COMMAND TBL   S99228 31112022
LOOP     DS    0H                                                S99228 31114022
         CLI   ZERO(RWORK5),ENDCHAR     END OF TABLE             S99228 31116022
         BE    NOTFOUND                 YES- BRANCH              S99228 31118022
         LTR   RWORK2,RWORK2            SEARCH FOR REQUEST CODE? S99228 31120022
         BZ    SRCHREQ                  YES-BRANCH               S99228 31122022
*        SEARCH FOR REMOTE COMMAND CODE                          S99228 31124022
         CLC   ZERO(ONE,R1),ONE(RWORK5) FOUND                    S99228 31126022
         BNE   CONTINUE                 NO- BRANCH               S99228 31128022
         LA    RWORK2,ONE(RWORK5)       ADDRESS OF FOUND CHAR    S99228 31130022
         BR    R14                      RETURN                   S99228 31132022
*        SEARCH FOR REQUEST CODE                                 S99228 31134022
SRCHREQ  DS    0H                                                S99228 31136022
         CLC   ZERO(ONE,R1),ZERO(RWORK5)  FOUND                  S99228 31138022
         BNE   CONTINUE                 NO- BRANCH               S99228 31140022
         LR    RWORK2,RWORK5            ADDRESS OF FOUND CHAR    S99228 31142022
         BR    R14                      RETURN                   S99228 31144022
CONTINUE DS    0H                                                S99228 31146022
         LA    RWORK5,THREE(RWORK5)     INCREMENT TO NEXT        S99228 31148022
         B     LOOP                     CONTINUE SEARCH          S99228 31150022
NOTFOUND DS    0H                                                S99228 31152022
         SR    RWORK2,RWORK2            INDICATE CHAR NOT FOUND  S99228 31154022
         BR    R14                      RETURN                   S99228 31156022
*****************************************************************S99228 31158022
*                                                                S99228 31160022
*                                                                S99228 31162022
*        SCREEN 2260 PROCESSING                                  S99228 31164022
*                                                                S99228 31166022
*                                                                S99228 31168022
*****************************************************************S99228 31170022
CONT2260 DS    0H                                                S99228 31172022
         SPACE                                                          31200020
         L     RUCB7,LCBDCBPT           GET DCB ADDRESS FROM LCB        31800020
         USING IHADCB,RUCB7                                             32400020
         L     RUCB7,DCBDEBAD           GET DEB ADDRESS FROM DCB        33000020
         USING DEBNMSUB,RUCB7                                           33600020
         SR    R14,R14                  CLEAR INDEX REG          A49230 34200022
         SPACE 1                                                 A49230 34250022
TRYNEXT  EQU   *                                                 A49230 34300022
         L     R15,DEBUCBAD(R14)        GET UCB ADDRESS          A49230 34350022
         LA    R15,0(R15)               CLEAR HI-ORDER BYTE      A49230 34400022
         LTR   R15,R15                  DD DUMMY                 A49230 34450022
         BNZ   GOTUCB                   BRANCH IF NOT            A49230 34500022
         LA    R14,4(R14)               ELSE INCREMENT INDEX     A49230 34550022
         B     TRYNEXT                  AND CONTINUE SEARCH      A49230 34600022
         SPACE 1                                                 A49230 34650022
GOTUCB   EQU   *                                                 A49230 34700022
         LR    RUCB7,R15                COPY VALID UCB ADDRESS   A49230 34750022
         USING IEDQUCB,RUCB7                                            34800020
         SPACE                                                          35400020
         CLI   UCBTBYT3,GRAPHICS        IS IT GRAPHICS (2260 LOCAL)     36000020
         BNE   REMOTE                   NO, REMOTE, GO PROCESS          36600020
         SPACE                                                          37200020
LOCAL    EQU   *                                                        37800020
         LA    R15,CCWWRITE             ASSUME NO CHANGE                38400020
         TM    AVTEZERO(RPARM8),DOITFLAG IS CHANGE REQUESTED            39000020
         BNO   EXIT                     NO, RETURN NOW                  39600020
         IC    RWORK2,PARMSET(RPARM8)   SAVE OPERATION BYTE      A42385 39800022
         NI    PARMSET(RPARM8),AVTEFF-NRESTORE CLEAR MOD 22 FLAG A42385 40000022
         SPACE                                                          40200020
         CLI   PARMSET(RPARM8),LINEADD  SELECT REQUESTED WRITE          40400020
         BL    SETTIC                   IT IS WDC, BRANCH               40600020
         BE    WLA                      IT IS WRITE AT LINE             40800020
*                                         ADDRESS, BRANCH               41000020
         SPACE                                                          41200020
*        ***** NEITHER, IT IS WRITE ERASE *****                         41400020
         SPACE                                                          41600020
         STC   R15,PRFOPCDE             MAKE BFR OP CODE A WRITE        41800020
         LA    R15,CMDERASE             GET ERASE OP CODE IN REG        42000020
         STC   R15,LCBCPA+16            SET LCB OP CODE TO ERASE        42200020
         B     SETBIT                   SET BIT & TIC & RETURN          42400020
         SPACE                                                          42600020
WLA      EQU   *                                                        42800020
         LA    R15,CMDLNADD             GET WLA OP CODE IN REG          43000020
         STC   R15,PRFOPCDE             SET IT IN BUFFER                43200020
         SPACE                                                          43400020
SETBIT   EQU   *                                                        43600020
         OI    LCBCHAIN,LCBSCRNN        TELL GD OP CODE IN BUFFER       43800020
         SPACE                                                          44000020
SETTIC   EQU   *                                                        44200020
         ST    RPREFIX,LCBCPA+24        SET TIC ADDRESS                 44400020
         MVI   LCBCPA+24,CCWTIC           AND OP CODE IN LCB            44600020
         STC   RWORK2,PARMSET(RPARM8)   RESTORE OPERATION BYTE   A42385 44800022
         TM    PARMSET(RPARM8),NRESTORE WRITE W/O KEYBOARD RSTR  A42385 45000022
         BZ    EXIT                     BRANCH IF NO             A42385 45200022
         OI    PRFOPCDE,NRESTORE        SET NO KEYBOARD RESTORE  A42385 45400022
         SPACE                                                          45600020
EXIT     EQU   *                                                        46200020
         L     RBASE,AVTUI              GET RET INTERFACE ADDR   S22025 46800022
         B     FOUR(RBASE)              BRANCH TO RETURN ROUTINE S22025 47400022
         EJECT                                                          48000020
REMOTE   EQU   *                                                        48600020
         SR    R15,R15                  SET ZERO RETURN CODE            48900020
         IC    R0,UCBTBYT4              PICK UP UNIT TYPE               49200020
         STC   R0,AVTDOUBL              STORE IN AVT                    49800020
         NI    AVTDOUBL,ADAPMASK        CLEAR LOW-ORDER NIBBLE          50400020
         CLI   AVTDOUBL,IBMAIII         IS IT IBM ADAPTER III           51000020
         BNE   EXIT                     NO, NOT SCREEN DEVICE,          51400020
*                                       EXIT WITH ZERO RETURN CODE      51800020
         SPACE                                                          52200020
         IC    R0,UCBTBYT1              PICK UP IOS/MODEL BYTE          52800020
         STC   R0,AVTDOUBL              STORE IN AVT                    53400020
         NI    AVTDOUBL,MODLMASK        CLEAR HIGH-ORDER NIBBLE         54000020
         CLI   AVTDOUBL,MODEL1          IS IT MODEL 1                   54600020
         BNE   EXIT                     NO, NOT SCREEN DEVICE,          55000020
*                                         EXIT WITH ZERO RETURN CODE    55400020
         SPACE                                                          55800020
         LH    R1,PRFDEST               GET DESTINATION KEY             56400020
         N     R1,AVTCLRHI                                              57000020
         L     R15,AVTRNMPT             GET ADDRESS OF TNT CODE         57600020
         BALR  R14,R15                  LINK TO GET TERM ENTRY ADDR     58200020
         SPACE                                                          58800020
         USING IEDQTRM,R1                                               59400020
         SR    R0,R0                                                    60000020
         LR    RWORK2,R0                                                60300020
         IC    R0,TRMDEVFL              PICK UP DEV DEP FLAGS           60600020
         TM    TRMSTATE,TRMOPTFN        TEST IF ANY OPTION FIELDS       61200020
         BZ    NOOPT                    NO, BRANCH                      61800020
         SPACE                                                          62400020
         IC    RWORK2,TRMOPNO           YES, GET NUMBER OF THEM         63600020
         LA    R1,TRMOPT                BUMP FIXED ENTRY LENGTH SA61048 63900000
         AR    R1,RWORK2                BUMP PAST OPTION OFFSETS A50185 64200022
         B     CKBUFSZ                  SEE IF BUFSIZE SPCEIFIEDSA57324 64210000
         SPACE                                                          64800020
NOOPT    EQU   *                                                        65400020
         LA    R1,TRMOPNO               BUMP TO POSS BUFSIZE    A57324  65410000
CKBUFSZ  EQU   *                                                A57324  65420000
         SRA   R0,SEVEN                 IS BUFSIZE SPECIFIED            66000020
         BZ    NOBFSIZE                 NO, BRANCH                      66600020
         SPACE                                                          67200020
         IC    RWORK2,AVTEZERO(,R1)     YES, GET LENGTH OF FIELD        67800020
         LA    R1,ONE(R1,RWORK2)        BUMP PAST BUFSIZE FIELD         68400020
         SPACE                                                          69000020
NOBFSIZE EQU   *                                                        69600020
         LR    R15,RWORK2               (CLEAR FOR INSERT)              70200020
         IC    R15,THREE(,R1)           PICK UP CURRENT SETTING         70800020
         SPACE                                                          71400020
         TM    AVTEZERO(RPARM8),DOITFLAG IS CHANGE REQUESTED            72000020
         BZ    EXIT                     NO, RETURN NOW                  72600020
         SPACE                                                          73200020
         IC    RWORK2,PARMSET(,RPARM8)  PICK UP SELECT BYTE             73800020
         IC    RWORK2,REMOTSND(RWORK2)  PICK UP FUNCTION BYTE           74400020
         STC   RWORK2,THREE(,R1)        CHANGE TERMINAL TABLE ENTRY     75000020
         B     EXIT                     RETURN                          75600020
         SPACE                                                          76200020
********* FUNCTION BYTE TABLES *********                                76800020
         SPACE                                                          77400020
LOCALSND DC    X'010507'                LOCAL OP CODES                  78000020
REMOTSND DC    X'A0B0E0'                REMOTE OP CODES                 78600020
*                 | | |                                                 79200020
*               WDC | WRE                                               79800020
*                  WLA                                                  80400020
*****************************************************************S99228 80420022
*                                                                S99228 80440022
*        COMMAND TABLE                                           S99228 80460022
*              EACH ENTRY CONSIST OF 3 BYTES                     S99228 80480022
*                 1ST - SCREEN PARM LIST REQUEST CODE            S99228 80500022
*                 2ND - REMOTE COMMAND CODE                      S99228 80520022
*                 3RD - LOCAL COMMAND CODE                       S99228 80540022
*        A X'FF'  IN THE BYTE FOLLOWING THE LAST ENTRY INDICATES S99228 80560022
*        THE END OF THE TABLE                                    S99228 80580022
*                                                                S99228 80600022
*****************************************************************S99228 80620022
CMDTBL   DS    0H                                                S99228 80640022
PARMWDC  DC    X'00'                    WDC REQUEST CODE         S99228 80660022
REMWDC   DC    X'F1'                    REMOTER WDC COMMAND CODE S99228 80680022
LOCWDC   DC    X'01'                    LOCAL WDC COMMAND CODE   S99228 80700022
*                                                                S99228 80720022
PARMWRE  DC    X'02'                    WRE REQUEST CODE         S99228 80740022
REMWRE   DC    X'F5'                    REMOTE WRE COMMAND CODE  S99228 80760022
LOCWRE   DC    X'05'                    LOCAL WRE COMMAND CODE   S99228 80780022
*                                                                S99228 80800022
PARMEAU  DC    X'03'                    EAU REQUEST CODE         S99228 80820022
REMEAU   DC    X'6F'                    REMOTE EAU COMMAND CODE  S99228 80840022
LOCEAU   DC    X'0F'                    LOCAL EAU COMMAND CODE   S99228 80860022
*                                                                S99228 80880022
ENDTBL   DC    X'FF'                    END OF TBL INDICATOR     S99228 80900022
DCTWKARA DS    CL4                      DCT WORK AREA          @Y17XAMG 80950010
         EJECT                                                          81000020
********* DSECTS *********                                              81600020
         SPACE                                                          82200020
*        SCREEN PARAMETER LIST                                   S99228 82230022
SCRNPARM DSECT                                                   S99228 82260022
SCRNNDX  DS    XL1                      INDEX BYTE               S99228 82290022
REQFLAG  EQU   X'01'                    ON-MEANS REQUEST IS      S99228 82320022
*                                       SPECIFIED,OFF - MEANS    S99228 82350022
*                                       REQUEST NOT SPECIFIED    S99228 82380022
SCRNREQ  DS    XL1                      REQUEST                  S99228 82410022
WDC      EQU   X'00'                    WRITE DISPLAY CURSOR     S99228 82440022
*                                       OR NO OPERANDS SPECIFIED S99228 82470022
WRE      EQU   X'02'                    ERASE/WRITE              S99228 82500022
EAU      EQU   X'03'                    ERASE ALL UNPROTECTED    S99228 82530022
SCRNFLGS DS    XL1                      FLAG BYTE                S99228 82560022
RETRIEVE EQU   X'80'                    ON-RETRIEVE=YES SPECIFIEDS99228 82590022
*        END SCREEN PARM LIST                                    S99228 82620022
         EJECT                                                          82650022
         TAVTD                                                          82800020
         EJECT                                                          83000020
         TCCWD                                                          83200020
         EJECT                                                          83400020
         DCBD  DSORG=TQ                                                 84000020
         EJECT                                                          84600020
         TDCTD                                                          84800010
         EJECT                                                          85000010
         TDEBD                                                          85200020
         EJECT                                                          85800020
         TLCBD                                                          86400020
         EJECT                                                          87000020
         TPRFD                                                          87600020
         EJECT                                                          88200020
         TSIBD                                                          88400010
         EJECT                                                          88600010
         TTPD                                                  @OY14057 88660010
         EJECT                                                          88720010
         TTRMD                                                          88800020
         EJECT                                                          89400020
IEDQUCB  DSECT                                                          90000020
         IEFUCBOB                                                       90600020
         SPACE                                                          91200020
         END                                                            91800020
