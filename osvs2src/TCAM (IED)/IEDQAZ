AZ01     TITLE '''IEDQAZ'' - REDIRECT ROUTINE'                          00000700
IEDQAZ   CSECT                                                          00001400
         SPACE 3                                                        00002100
*  CHANGE ACTIVITY AS FOLLOWS:                                          00002800
******************** MICROFICHE FLAGS *********************** SUPT CODE 00003500
*A506000                                                         A42407 00004200
*C477600                                                         A42407 00004900
*C477600,509000                                                  A51765 00005600
*C824000                                                         A52511 00006300
*A828000,930000                                                  A52511 00007000
*C700000-704000                                                 SA55948 00007700
*     CLEAN-UP                                                   S21903 00008400
*C556000                                                        SA62385 00009100
*A 490000,692000                                                SA63999 00009800
*C 700000,703000                                                SA63999 00010500
*A SAME CHANGE FOR 63999                                        OY00468 00011200
*C761800                                                       @Y17XAMG 00011900
*A426000,476800,908000,930000,944000                           @OY12678 00012600
*D507000,924000                                                @OY12678 00013300
*A479440                                                       @OY13640 00014000
*A477320                                                       @OY13658 00014700
*C929400-029600                                                @OY13658 00015400
*A001827,002905,002996                                         @OS77932 00015700
*A001260,001813,002499,002548,003668,003808                    @X30X5MT 00015800
*D001267,002555-002632                                         @X30X5MT 00015900
*A002289,002296                                                @OY19052 00016000
*C003486                                                       @OZ32858 00016100
* $01=OZ41420  JTC2202  79.11.07 047252:                           @01A 00016212
* $02=OZ42825  JTC2202  79.11.13 047252:                           @02A 00016412
* $11=OZ45358  ETC2302  80.04.11 723465:                           @11A 00016526
* $21=OZ54443  ETC2402  81.08.17 460025: LINK FAILURES             @21A 00016727
* $22=OZ58484  ETC2402  81.12.30 251428: TESTING PRFERMGN WRONG    @22A 00016827
* $R1=ZM30946  JTC2412  82.03.04 613706: RESERVES FROM LCBISZE     @R1A 00016927
         SPACE 3                                                   @21A 00017027
*******************************************************************@21A 00017127
*                                                                     * 00017500
*  TITLE: IEDQAZ - REDIRECT ROUTINE                                   * 00018200
*                                                                     * 00018900
*  $MOD(IEDQAZ) COMP(M@) PROD(TCAM):                               @01A 00019612
*                                                                     * 00020300
*  DESCRIPTIVE NAME = REDIRECT / ERRORMSG ROUTINE                     * 00021000
*                                                                     * 00021700
*  COPYRIGHT = 'NONE'                                                 * 00022400
*                                                                     * 00023100
*  STATUS = VERSION 10.0                                       @Y17XANQ 00023800
*                                                                     * 00024500
*FUNCTION --                                                          * 00025200
*   REDIRECTS A MESSAGE TO THE DESTINATION SPECIFIED BY THE USER.     * 00025900
*                                                                     * 00026600
*   IF THE REDIRECT DESTINATION IS IN AN OPTION FIELD,  THE ROUTINE   * 00027300
*   LINKS TO THE LOCATE OPTION ROUTINE (IEDQAE) TO GET THE ADDRESS    * 00028000
*   OF THE OPTION FIELD.  IF THE FIELD IS NOT FOUND,  THE ERROR       * 00028700
*   HANDLING EXIT IS TAKEN.                                           * 00029400
*                                                                     * 00030100
*   IF THE FIELD IS FOUND,  PARAMETERS ARE BUILT FOR,  AND A LINK     * 00030800
*   TAKEN TO,  THE BINARY SEARCH ROUTINE (IEDQA1).  THIS IS ALSO      * 00031500
*   THE PROCEDURE TAKEN WHEN THE REDIRECT DESTINATION NAME IS         * 00032200
*   EXPLICITLY SPECIFIED BY THE MACRO.  ON RETURN,  IF THE NAME IS    * 00032900
*   NOT FOUND IN THE TERMINAL NAME TABLE,  THE ERROR HANDLING EXIT    * 00033600
*   IS TAKEN.                                                         * 00034300
*                                                                     * 00035000
*   IF THE NAME IS FOUND,  THE DESTINATION KEY RETURNED BY BINARY     * 00035700
*   SEARCH IS PASSED TO THE LOOK UP DESTINATION ROUTINE (IEDQAV).     * 00036400
*   THIS IS ALSO THE PROCEDURE TAKEN WHEN THE REDIRECT DESTINATION    * 00037100
*   IS THE ORIGIN OR THE ORIGINAL DESTINATION,  IN WHICH CASE THE     * 00037800
*   KEY PASSED IS ACCESSED FROM THE PREFIX FIELD PRFSRCE (ORIGIN)     * 00038500
*   OR PRFDEST (ORIGINAL DESTINATION).  ON RETURN,  IF THE DESTINA-   * 00039200
*   TION IS A TSO TERMINAL,  THE ERROR HANDLING EXIT IS TAKEN.        * 00039900
*                                                                     * 00040600
*   IF IT IS NOT,  THE MESSAGE IS POSTED TO THE DESTINATION VIA AN    * 00041300
*   EXIT TO THE DISPATCHER AT THE LABEL DSPCHAIN.                     * 00042000
*                                                                     * 00042700
*    ERRORMSG MACRO FUNCTION USES THE REDIRECT ROUTINE TO             * 00043400
*   DETERMINE THE ERROR MESSAGE DESTINATION.  WHEN THIS IS THE CASE   * 00044100
*   THE REDIRECT ROUTINE DOES NOT POST THE MESSAGE.  INSTEAD THE      * 00044800
*   FIELD SCBMACR IN THE SCB IS SET TO THE ADDRESS OF THE ERROR       * 00045500
*   MESSAGE PARAMETER LIST AND EXIT IS MADE TO THE ERROR MESSAGE    . * 00046200
*   ROUTINE..                                                         * 00046900
*                                                              @Y17XAMF 00047600
*   IF IEDAZ IS CALLED FOR AN ERRORMSG WITH HEADER=NO AND THIS IS THE * 00048300
*   FIRST MACRO IN THE MSG GROUP, THE ROUTINE MUST WAIT FOR EOM IN-   * 00049000
*   DICATION BY POSTING AN ERB.  UPON REGAINING CONTROL, SCBDESTQ IS  * 00049700
*   STORED IN LCBSTART WHICH IS RESTORED BY IEDQT.  BUFFER STEAL IS   * 00050400
*   THEN CALLED FOR A BUFFER INTO WHICH THE MESSAGE IS PLACE.         * 00051100
*   IF NO BUFFER IS AVAILABLE AN ERB IS POSTED TO IEDQGA TO OBTAIN    * 00051800
*   A BUFFER.  THE PREFIX IS THEN INITIALIZED APPROPRIATELY AND IT IS * 00052500
*   POSTED TO IEDQBD FOR THE IEDQAT PROCESSING.                @Y17XAMF 00053200
*                                                                     * 00053900
*   ERROR HANDLING EXIT (TESTDEAD) --                                 * 00054600
*   IF A DEAD-LETTER QUEUE IS SPECIFIED,  ITS KEY IS ACCESSED AND     * 00055300
*   PASSED TO IEDQAV AND THE MESSAGE IS POSTED THERE.  IF NONE IS     * 00056000
*   SPECIFIED,  THE MESSAGE IS NOT REDIRECTED AND EXIT IS MADE TO     * 00056700
*   BUFFER DISPOSITION VIA THE DISPATCHER AT THE LABEL DSPCHAIN.      * 00057400
*                                                                     * 00058100
*ENTRY POINTS --                                                      * 00058800
*       'IEDQAZ01' TO REDIRECT A MESSAGE TO AN ADDITIONAL DESTINA-    * 00059500
*   TION.  THE ROUTINE IS ENTERED BY A BRANCH FROM BUFFER             * 00060200
*   DISPOSITION (IEDQBD).                                             * 00060900
*                                                                     * 00061600
*INPUT --                                                             * 00062300
*   REGISTER 1 - ADDRESS OF AN ADDITIONAL ELEMENT TO BE POSTED        * 00063000
*                                                                     * 00063700
*   REGISTER 3 - ADDRESS OF THE SCB                                   * 00064400
*                                                                     * 00065100
*   REGISTER 6 - ADDRESS OF THE BUFFER                                * 00065800
*                                                                     * 00066500
*   REGISTER 8 - ADDRESS OF A MACRO-GENERATED PARAMETER LIST.         * 00067200
*   PARAMETER LIST FORMAT IS:                                         * 00067900
*                                                                     * 00068600
*        *********************************                            * 00069300
*        *       * PARAM * NO OF *       *                            * 00070000
*        * INDEX * LIST  * BFRS  *       *                            * 00070700
*        *       * LNGTH *       *       *                            * 00071400
*        *************************       *                            * 00072100
*        *                               *                            * 00072800
*        *          ERROR MASK           *                            * 00073500
*        *                               *                            * 00074200
*        *********************************                            * 00074900
*        *       *     VARIABLE DATA     *                            * 00075600
*        *STATUS *      (SEE BELOW)      *                            * 00076300
*        *       *                       *                            * 00077000
*        *********************************                            * 00077700
*        * INDEX * PARAM * INDEX * INDEX *                            * 00078400
*        *  TO   * LIST  *  TO   *  TO   *                            * 00079100
*        *   AT  * LNGTH *   AF  *   AO  *                            * 00079800
*        *********************************                            * 00080500
*        *       *                       *                            * 00081200
*        *       *  ADDRESS OF MESSAGE   *                            * 00081900
*        *       *                       *                            * 00082600
*        *********************************                            * 00083300
*        *          ADDRESS OF           *                            * 00084000
*        *       USER EXIT ROUTINE       *                            * 00084700
*        *           (OPTIONAL)          *                            * 00085400
*        *********************************                            * 00086100
*                                                                     * 00086800
*        VARIABLE DATA:                                               * 00087500
*                                                                     * 00088200
*        *********************************                            * 00088900
*        *       *                       * TO BE SENT                 * 00089600
*        *  'S'  *     UNUSED (ZERO)     *   TO SOURCE                * 00090300
*        *       *                       *                            * 00091000
*        *********************************                            * 00091700
*                                                                     * 00092400
*        *********************************                            * 00093100
*        *       *                       * TO BE SENT                 * 00093800
*        *  'D'  *     UNUSED (ZERO)     *   TO DESTINATION           * 00094500
*        *       *                       *   SPECIFIED IN PREFIX      * 00095200
*        *********************************                            * 00095900
*                                                                     * 00096600
*        *********************************                            * 00097300
*        *       * INDEX *  OPT  *  RTN  * TO BE SENT                 * 00098000
*        *  'O'  *  TO   * FIELD *  REG  *   TO DESTINATION           * 00098700
*        *       *   AE  * OFFST * OFFST *   SPECIFIED IN OPTION FL   * 00099400
*        *********************************                            * 00100100
*                                                                     * 00100800
*        *********************************                            * 00101500
*        *       *                       * TO BE SENT                 * 00102200
*        *  'N'  *    ADDRESS OF NAME    *   TO DESTINATION           * 00102900
*        *       *                       *   SPECIFIED BY NAME        * 00103600
*        *********************************                            * 00104300
*                                                              @Y17XANQ 00105000
*        *********************************                     @Y17XANQ 00105700
*        *       *                       *                     @Y17XANQ 00106400
*        *  'T'  *   ADDRESS OF 'TOTE'   *  TO BE SENT TO TOTE @Y17XANQ 00107100
*        *       *                       *                     @Y17XANQ 00107800
*        *********************************                     @Y17XANQ 00108500
*                                                                     * 00109200
*   REGISTER 12 - ENTRY POINT ADDRESS AND BASE REGISTER FOR THIS      * 00109900
*   SUBTASK.                                                          * 00110600
*                                                                     * 00111300
*   REGISTER 13 - ADDRESS OF THE SAVE AREA AND BASE FOR AVT           * 00112000
*   ADDRESSABILITY                                                    * 00112700
*                                                                     * 00113400
*OUTPUT --                                                            * 00114100
*   IF A VALID DESTINATION IS FOUND,  THE KEY FOR THE DESTINATION     * 00114800
*   IS SET IN THE PREFIX (PRFDEST).  THE DESTINATION QCB ADDRESS IS   * 00115500
*   SET IN THE BUFFER (PRFQCBA) AND THE ADDRESS OF THE ADDITIONAL     * 00116200
*   ELEMENT IS SET IN THE BUFFER (PRFLINK).  IF A VALID DESTINATION   * 00116900
*   IS NOT FOUND,  THE ADDRESS OF THE DEAD-LETTER QCB OR,  IF THERE   * 00117600
*   IS NO DEAD-LETTER QUEUE,  THE ADDRESS OF THE BUFFER DISPOSITION   * 00118300
*   QCB IS SET IN THE BUFFER (PRFQCBA).                               * 00119000
*                                                                     * 00119700
*EXTERNAL REFERENCES --                                               * 00120400
*                                                                     * 00121100
*   AVT - ADDRESS VECTOR TABLE                                        * 00121800
*                                                                     * 00122500
*   RECALLED HEADER BUFFER                                            * 00123200
*                                                                     * 00123900
*   SCB - STATION CONTROL BLOCK                                       * 00124600
*                                                                     * 00125300
*EXITS,  NORMAL --                                                      00126000
*   THE EXIT ADDRESS IN THE REDIRECT MACRO IS TESTED FOR AN    @XM05843 00126100
*   EXIT ROUTINE. A ZERO INDICATES NO EXIT WAS SPECIFIED. AN   @XM05843 00126200
*   ADDRESS CAUSES A BRANCH TO THE EXIT ROUTINE TO TAKE PLACE. @XM05843 00126300
*   ON RETURN FORM THE EXIT ROUTINE REGISTER 15 SPECIFIES WHAT @XM05843 00126700
*   IS TO BE DONE WITH THE CURRENT MESSAGE.  A RETURN CODE OF  @XM05843 00126800
*   ZERO PROCESSES THE MESSAGE NORMALLY, A RETURN CODE OF FOUR @XM05843 00126900
*   DOESN'T REDIRECT THIS MESSAGE, A RETURN CODE OF EIGHT      @XM05843 00127000
*   REDIRECTS THE MESSAGE TO THE DISTINATION POINTED TO IN     @XM05843 00127100
*   REGISTER ONE.                                              @XM05843 00127200
*   A VALID DESTINATION HAS BEEN FOUND.  THE BUFFER IS POSTED TO      * 00127400
*   THE DESTINATION.                                                  * 00127700
*                                                                     * 00128100
*EXITS, ERROR --                                                      * 00128800
*   NO VALID DESTINATION HAS BEEN FOUND.  A DEAD-LETTER QUEUE IS      * 00129500
*   SPECIFIED.  THE BUFFER IS POSTED TO THE DEAD-LETTER QUEUE.        * 00130200
*                                                                     * 00130900
*   NO VALID DESTINATION HAS BEEN FOUND.  NO DEAD-LETTER QUEUE IS     * 00131600
*   SPECIFIED.  THE BUFFER IS POSTED TO BUFFER DISPOSITION.           * 00132300
*                                                                     * 00133000
*TABLES/WORK AREAS: N/A                                               * 00133700
*                                                                     * 00134400
*ATTRIBUTES -- SERIALLY REUSEABLE, REENTERANT,ENABLED,RESIDENT,       * 00135100
*   PROBLEM PROGRAM MODE.                                             * 00135800
*                                                                     * 00136500
*NOTE -- THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL        * 00137200
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS             * 00137900
*   EQUIVALENT TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS      * 00138600
*   BEEN ARRANGED SO THAT REDEFINITION OF ''CHARACTER'' CONSTANTS,    * 00139300
*   BY REASSEMBLY, WILL RESULT IN A CORRECT MODULE FOR THE NEW        * 00140000
*   DEFINITIONS.                                                      * 00140700
*                                                                     * 00141400
*********************************************************************** 00142100
         EJECT                                                          00142800
********* REGISTER EQUATES *********                                    00143500
         SPACE                                                          00144200
R0       EQU   0                        WORK REGISTER                   00144900
         SPACE                                                          00145600
R1       EQU   1                        PARAMETER LIST REGISTER         00146300
         SPACE                                                          00147000
RWORK2   EQU   2                        WORK REGISTER                   00147700
         SPACE                                                          00148400
RSCB3    EQU   3                        SCB ADDRESS                     00149100
         SPACE                                                          00149800
RLCB4    EQU   4                        LCB ADDRESS                     00150500
         SPACE                                                          00151200
RPREFIX  EQU   6                        ADDRESS OF BUFFER               00151900
         SPACE                                                          00152600
RELEM7   EQU   7                        ADDRESS OF ELEMENT              00153300
         SPACE                                                          00154000
RPARM8   EQU   8                        PARAMETER LIST ADDR             00154700
*                                         ON INITIAL ENTRY              00155400
         SPACE                                                          00156100
RGO9     EQU   9                        LINK REG AFTER DEST FOUND       00156800
         SPACE                                                          00157500
RDISP    EQU   11                       ADDRESS OF DISPATCHER           00158200
         SPACE                                                          00158900
RBASE    EQU   12                       BASE REGISTER                   00159600
         SPACE                                                          00160300
R13      EQU   13                       SAVE AREA ADDRESS               00161000
R14      EQU   14                       RETURN REGISTER                 00161700
R15      EQU   15                       BRANCH REGISTER AND             00162400
*                                         RETURN CODE REGISTER          00163100
         EJECT                                                          00163800
********* OTHER EQUATES *********                                       00164500
         SPACE                                                          00165200
CHARS    EQU   C'S'                     SOURCE                          00165900
CHARD    EQU   C'D'                     ORIGINAL DESTINATION            00166600
CHARN    EQU   C'N'                     NAME                            00167300
CHART    EQU   C'T'                     TOTE INDICATOR         @Y17XANQ 00168000
         SPACE                                                          00168700
PARMAZ   EQU   0                        INDEX OF IEDQAZ                 00169400
PARMSTAT EQU   2                        STATUS BYTE                     00170100
PARMDTYP EQU   0                        DESTINATION TYPE CODE           00170800
PARMNAME EQU   1                        ADDRESS OF NAME                 00171500
PARMAE   EQU   1                        INDEX OF IEDQAE                 00172200
PARMOPT  EQU   2                        OPTION FIELD OFFSET             00172900
PARMAT   EQU   4                        IEDQAT PARAMETER LIST           00173600
         SPACE                                                          00174300
ONE      EQU   1                        INCREMENT FACTOR OF ONE         00175000
FOUR     EQU   4                        LENGTH OF A FULLWORD            00175700
         SPACE                                                          00176400
UNCOFLAG EQU   X'01'                    UNCONDITIONAL FLAG              00177100
ERMSFLAG EQU   X'01'                    ERROR MESSAGE FLAG              00177800
INDEXA1  EQU   X'08'                    INDEX OF IEDQA1                 00178500
INDEXAV  EQU   X'10'                    INDEX OF IEDQAV                 00179200
RECALL   EQU   X'02'                    RECALL REQUIRED        @0Y12678 00179900
OPTIC    EQU   X'08'                    TOC OPCODE             @0Y12678 00180600
THIRTWO  EQU   32                       SHIFT LENGTH           @0Y12678 00181300
EIGHT    EQU   8                        OFFSET OF EIGHT            @01A 00181412
REGOFF   EQU   12                       OFFSET INTO SAVE AREA  @XM05843 00181500
REG2OFF  EQU   28                       OFFSET TO REG2 SAVE        @01A 00181612
TWO      EQU   2                        CONSTANT EQUATE        @XM05843 00181700
SEVEN    EQU   7                        MASK FOR ICM/STCM      @0Y12678 00182000
HDRNO    EQU   X'01'                    HEADER=NO FLAG         @0Y14053 00182700
NUMASK   EQU   X'F0'                    MASK FOR HEX COUNT     @OS77932 00182900
FOXONE   EQU   X'F1'                    HEX ONE                @OS77932 00183100
         SPACE                                                          00183400
         SPACE                                                          00184100
         EJECT                                                          00184800
         USING AVTSAVE2,R13                                      S22025 00185500
         USING IEDQSCB,RSCB3                                            00186200
         USING IEDQPRF,RPREFIX                                          00186900
         USING IEDQAZ,RBASE                                             00187600
         USING IHADCB,RGO9                                     @0Y12678 00188300
         USING IEDQDISP,RDISP                                  @0Y12678 00189000
         USING IEDQLCB,RLCB4                                   @0Y12678 00189700
         SPACE                                                          00190400
IEDQAZ01 EQU   *                                                        00191100
IEDQAZ   IEDHJN REDIRECT                ID AND DATE              S22025 00191800
*********************************************************************** 00192500
*                                                             @OY12678* 00193200
*  WHEN HEADER=NO IS CODED ON THE ERRORMSG MACRO, THIS SECTION@OY12678* 00193900
*  OF CODE WILL GO TO THE BUFFER POOL AND OBTAIN A BUFFER.    @OY12678* 00194600
*  THE ERROR MESSAGE TEXT WILL BE PLACED INTO THIS BUFFER     @OY12678* 00195300
*  INSTEAD OF REUSING THE RECALLED HEADER.                    @OY12678* 00196000
*                                                             @OY12678* 00196700
*********************************************************************** 00197400
         TM    PARMSTAT(RPARM8),ERMSFLAG ERROR MESSAGE         @0Y12678 00198100
         BNO   RECYES                   BRANCH NO              @OY12678 00198800
         NI    LCBSTART+2,X'FF'-HDRNO   INSURE FLAG OFF        @OY14053 00199500
         TM    0(RPARM8),RECALL         RECALL REQUIRED        @OY12678 00200200
         BO    RECYES                   BRANCH YES             @Y17XANQ 00200900
         MVC   LCBSTART,SCBDESTQ        SAVE DESTINATION       @OY14053 00201600
         OI    LCBSTART+2,HDRNO         SET HEADER=NO          @OY14053 00202300
         LTR   RELEM7,R1                POST LIST ELEMENTS     @Y17XANQ 00203000
         BNZ   ERBTOAZ                  POST ERB TO WAI        @Y17XANQ 00203700
NOLIST   EQU   *                                                        00204400
         LR    RPREFIX,RPARM8           SAVE PARM LIST POINTER @OY12678 00205100
         L     RGO9,LCBDCBPT            GET DCB ADDRESS        @OY12678 00205800
         TM    PARMAZ(RPARM8),UNCOFLAG  TEST IF UNCONDITIONAL  @OY12678 00206500
         LA    RPARM8,FOUR(,RPARM8)     BUMP TO SECOND WORD    @OY12678 00207200
         BO    NOMASK                   YES, NOW AT DEST TYPE  @OY12678 00207900
         LA    RPARM8,FOUR(,RPARM8)     NO, BUMP ANOTHER WORD  @OY12678 00208600
NOMASK   EQU   *                                               @OY12678 00209300
         SR    RELEM7,RELEM7            CLEAR REGISTER         @OY12678 00210000
         IC    RELEM7,8(,RPARM8)        GET LENGTH OF MESSAGE  @OY12678 00210700
         LR    RPARM8,RPREFIX           RESTORE PARM LIST PTR  @OY12678 00211400
         SR    RPREFIX,RPREFIX          CLEAR REGISTER         @OY12678 00212100
         IC    RPREFIX,LCBISZE          RESERVES COUNT             @R1C 00212827
         LA    RPREFIX,AVTHDRSZ(RPREFIX,RELEM7)  TOTAL LENGTH  @OY12678 00213500
         SRDA  RPREFIX,THIRTWO          SHIFT VALUE INTO REG 7 @OY12678 00214200
         SR    RWORK2,RWORK2            CLEAR REGISTER         @OY12678 00214900
         LH    RWORK2,AVTKEYLE          KEY LENGTH             @OY12678 00215600
         DR    RPREFIX,RWORK2           FIND NUMBER OF UNITS   @OY12678 00216300
         LA    R0,ONE(,RELEM7)          ADD ONE TO UNIT COUNT  @Y17XANQ 00217000
         STC   R0,LCBRBCT2              STORE UNIT COUNT       @Y17XANQ 00217700
         LA    R1,ONE                   REQUEST ONE BUFFER     @Y17XANQ 00218400
         L     R15,AVTSTEAL             BUFFFER STEAL ROUTINE  @Y17XANQ 00219100
         BALR  R14,R15                    STEAL BUFFERS        @Y17XANQ 00219800
         SPACE 1                                               @Y17XANQ 00220500
         SR    R1,R1                    CLEAR LIST REG         @YM06112 00220800
         LTR   RPREFIX,R15              WAS STEAL SUCCESSFUL   @Y17XANQ 00221200
         BZ    GOERB                      NO-POST ERB          @Y17XANQ 00221900
         SPACE 1                                               @Y17XANQ 00222600
         STCM  RLCB4,SEVEN,PRFLCB       GET FIRST UNIT         @YM06112 00223300
         XC    PRFSTAT1(PRFSHDR+4-PRFCORE),PRFSTAT1                @02C 00224012
*                                       CLEAR PREFIX FIELDS    @OY12678 00224700
BUFHERE  EQU   *                                               @OY12678 00225400
         IC    RELEM7,LCBISZE           GET RESERVES               @R1A 00226127
         STC   RELEM7,PRFISIZE          STORE FOR IEDQAT       @OY12678 00226800
         LA    RELEM7,30(,RELEM7)       INCREASE BY PREFIX SIZE@OY12678 00227500
         STC   RELEM7,PRFSCAN           SET SCAN POINTER       @OY12678 00228200
         STH   RELEM7,PRFSIZE           SIZE = SCAN OFFSET     @OY12678 00228427
         TM    LCBSTAT1,LCBRECVN        RECEIVING?                 @22A 00228627
         BO    NOTERMSG                 YES, BYPASS ERRORMSG       @22A 00228827
         L     RELEM7,LCBLSPCI-ONE      PICK UP RECALLED BUFFER@OY19052 00229000
         TM    PRFSTAT1-IEDQPRF(RELEM7),PRFERMGN               @OY19052 00229100
*                                       ERROR MSG IN THIS BFR  @OY19052 00229200
         BO    SETERMSG                                        @OY19052 00229300
NOTERMSG EQU   *                        NOT ERRORMSG FOR ERR       @22A 00229427
         MVI   PRFSTAT1,AVTEZERO        HEADER LAST            @OY12678 00229600
         B     BLDPREFX                                        @OY19052 00229700
SETERMSG EQU   *                                               @OY19052 00229800
         MVI   PRFSTAT1,PRFERMGN        INDIC ERROR MSG IN BFR @OY19052 00229900
BLDPREFX EQU   *                                               @OY19052 00230000
         XC    PRFSRCE,PRFSRCE          ASSUME SENDING         @OY12678 00230300
         MVC   PRFDEST,LCBTTCIN         AND SET DESTINATION    @OY12678 00231000
         TM    LCBSTAT1,LCBSENDN        SENDING                @OY12678 00231700
         BO    RECYES                   BRANCH YES             @OY12678 00232400
         MVC   PRFSRCE,LCBTTCIN         SET DESTINATION FOR    @OY12678 00233100
         XC    PRFDEST,PRFDEST          RECEIVING              @OY12678 00233800
RECYES   EQU   *                                               @OY12678 00234500
         ST    RPREFIX,AVTADBUF         REINITIALIZE AVT BFR ADDR       00235200
         LR    RELEM7,R1                SAVE ELEMENT ADDRESS            00235900
         MVI   SCBPRI,AVTEZERO          CLEAR SCB PRIORITY              00236600
         NI    PRFSTAT1,PRFCNCLF        MAKE SURE CANCEL BIT IS OFF     00237300
         SPACE 1                                                OX00468 00238000
         MVC   AVTDOUBL+4(FOUR),0(RPARM8)  SAVE ENTRY FLAGS     SA63999 00238700
         TM    PRFSTAT1,PRFERMGN        IF ERRMSG,NOREDIRECT   @Y17XANQ 00239400
         BO    POSTDISP                      OR ERRMSG         @Y17XANQ 00240100
         TM    PARMSTAT(RPARM8),ERMSFLAG IS ERROR MSG REQUESTED         00240800
         LA    RGO9,ERRMSG              ANTICIPATE ERROR MSG            00241500
         BO    SETPARM                  YES, BRANCH                     00242200
         SPACE                                                          00242900
         LA    RGO9,SETQCB              NO, SET LINK TO POST            00243600
         L     RLCB4,PRFLCB-1           GET ADDRESS OF LCB              00244300
         USING IEDQLCB,RLCB4                                            00245000
         TM    LCBSTAT1,LCBINITN+LCBSENDN INIT MODE ON SEND SIDE        00245700
         BNO   SETPARM                  BR NOT SEND INITIATE     A51765 00246400
         TM    SCBERR4,SCBSLCTN+SCBTXTTN  LINE ERROR             A51765 00247100
         BNZ   POSTDISP                 YES,DON'T REDIRECT,POST  A51765 00247800
*                                         TO BFR DISP INSTEAD           00248500
         SPACE                                                          00249200
SETPARM  EQU   *                                                        00249900
         LR    R1,RPARM8                SAVE PARM LIST PTR     @XM05843 00250200
         TM    PARMAZ(RPARM8),UNCOFLAG  TEST IF UNCONDITIONAL           00250600
         LA    RPARM8,FOUR(,RPARM8)     BUMP TO SECOND WORD             00251300
         BO    TESTSRCE                 YES, NOW AT DEST TYPE FIELD     00252000
         SPACE                                                          00252700
         LA    RPARM8,FOUR(,RPARM8)     NO, MUST BUMP ANOTHER WORD      00253400
         SPACE                                                          00254100
TESTSRCE EQU   *                                                        00254800
         LA    RWORK2,ERRMSG            SEE IF HERE FOR ERRMSG @XM05843 00254900
         CR    RWORK2,RGO9              ERRMSG ENTRY           @XM05843 00255000
         BE    RETZERO                  YES, BRNCH AROUND EXIT @XM05843 00255100
         TM    TWO(R1),TWO              EXIT SPECIFIED         @XM05843 00255500
         BZ    RETZERO                  NO, CONTINUE           @XM05843 00255700
         SR    RWORK2,RWORK2            CLEAR FOR LOCATE       @XM05843 00255900
         IC    RWORK2,ONE(R1)           GET LENGTH OF PARMLIST @XM05843 00256200
         SRL   RWORK2,TWO               DROP TWO LOW BITS      @XM05843 00256400
         SLL   RWORK2,TWO               REALIGN                @XM05843 00256600
         S     RWORK2,COMPRET4          SET LENGTH TO EXIT ADDR@XM05843 00256900
         LA    RWORK2,AVTEZERO(RWORK2,R1) LOAD ADDR OF EXIT RTN@XM05843 00257100
         ICM   R15,SEVEN,ONE(RWORK2)    LOAD ADDR EXIT         @XM05843 00257300
         BZ    RETZERO                  NO, RET CODE OF ZERO   @XM05843 00257600
         LR    R0,RSCB3                 LOAD SCB ADDR          @XM05843 00257700
         LR    R1,RPREFIX               LOAD BUFFER ADD        @XM05843 00257800
         STM   RWORK2,RBASE,AVTSAVE2+REG2OFF    SAVE REGS          @01C 00257912
         LR    RPREFIX,R13                 SAVE CURRENT ADDR       @01A 00258012
         LA    R13,USERSAVE                USER SAVE AREA ADDR     @01A 00258112
         ST    RPREFIX,FOUR(,R13)          SAVE CURRENT ADDR       @01A 00258212
         ST    R13,EIGHT(,RPREFIX)         SAVE NEXT SAVE ADDR     @01A 00258312
         BALR  R14,R15                  BRANCH TO EXIT ROUTINE @XM05843 00258512
         L     R13,FOUR(,R13)           BACK TO PREVIOUS           @01A 00258612
         LM    RWORK2,RBASE,AVTSAVE2+REG2OFF    RESTORE REGS       @01C 00258812
         C     R15,COMPRET0             COMPARE REG15 TO ZERO  @XM05843 00259212
*                                       TO DETERMINE RET CODE  @XM05843 00259312
         BE    RETZERO                  RET CODE WAS ZERO      @XM05843 00259412
*                                       PROCESS NORMALLY       @XM05843 00259512
         C     R15,COMPRET4             RETURN CODE = 4?       @XM05843 00259612
         BE    POSTDISP                 RETURN CODE DOESN'T    @XM05843 00259700
*                                       REDIRECT               @XM05843 00259900
         C     R15,COMPRET8             RETURN CODE = 8?       @XM05843 00260100
         BNE   RETZERO                  NO, PROCESS NORMALLY   @XM05843 00260400
*                                       RET CODE OF 8 REDIRECTS@XM05843 00260500
*                                       MSG TO TERMINAL        @XM05843 00260600
*                                       ADDRESSED IN REG1      @XM05843 00260700
         LR    R15,R1                   LOAD REG TO WHERE MSG  @XM05843 00261100
*                                       IS TO BE REDIRECTED    @XM05843 00261300
         L     RWORK2,AVTRNMPT          TERM TABLE ADDR        @XM05843 00261500
         IC    RWORK2,TNTENLEN-IEDQTNTD(RWORK2) GET TERMNME LEN@XM05843 00261800
         B     LINKA1                   GO QUE MSG TO          @XM05843 00261900
*                                       SPECIFIC TERMINAL      @XM05843 00262000
RETZERO  CLI   PARMDTYP(RPARM8),CHARS   SEND TO ORIGIN         @XM05843 00262100
         LH    R1,PRFSRCE               YES, PICK UP ORIGIN KEY         00262200
         BNE   TESTDEST                 BRANCH IF NONZERO       SA62385 00262300
         MVC   PRFDEST,PRFSRCE          SET UP DEST             SA62385 00262500
         B     LINKRET                  SET FOR REDIRECT        SA62385 00262600
         SPACE                                                          00262700
         SPACE                                                          00262800
TESTDEST EQU   *                                                        00262900
         CLI   PARMDTYP(RPARM8),CHARD   SEND TO ORIGINAL DEST           00263000
         BNE   TESTNAME                 NO, PROCEED                     00263100
         SPACE                                                          00263200
         LH    R1,PRFDEST               YES, PICK UP DEST KEY           00263500
         SPACE                                                          00263900
LINKRET  EQU   *                                                        00264600
         N     R1,AVTCLRHI              IS KEY ZEROES                   00265300
         BZ    TESTDEAD                 YES, GO TEST FOR DLQ            00266000
         SPACE                                                          00266700
         B     LINKAV                   NO, GO LINK TO IEDQAV           00267400
         SPACE                                                          00268100
TESTNAME EQU   *                                                        00268800
         CLI   PARMDTYP(RPARM8),CHARN   SEND TO DEST NAMED              00269500
         BNE   TESTOTE                  NO, CHECK TOTE         @Y17XANQ 00270200
         SPACE                                                          00270900
         L     RWORK2,PARMNAME-1(,RPARM8) YES, GET ADDRESS OF NAME      00271600
         LA    R15,ONE(,RWORK2)         BUMP PAST LENGTH BYTE           00272300
         IC    RWORK2,AVTEZERO(,RWORK2) PICK UP LENGTH BYTE             00273000
         B     LINKA1                   GO LINK TO BINARY SEARCH        00273700
         SPACE                                                          00274400
TESTOTE  EQU   *                                               @Y17XANQ 00275100
         CLI   PARMDTYP(RPARM8),CHART   SEND TO TOTE           @Y17XANQ 00275800
         BNE   PROCOPT                    NO, MUST BE IN OPT   @Y17XANQ 00276500
         SPACE 1                                               @Y17XANQ 00277200
         LA    R1,AVTOLTQB              TOTE QCB ADDRESS       @Y17XANQ 00277900
         STCM  R1,SEVEN,SCBDESTQ          TO THE SCB           @Y17XANQ 00278600
         BR    RGO9                     GO TO POST             @Y17XAMF 00279300
         SPACE 1                                                        00280000
PROCOPT  EQU   *                                                        00280700
         LH    RWORK2,PARMOPT(,RPARM8)  PICK UP AE PARM LIST DATA       00281400
         STH   RWORK2,AVTDOUBL+2        SET IN PARM LIST                00282100
         IC    RWORK2,PARMAE(,RPARM8)   PICK UP IEDQAE OFFSET           00282800
         STC   RWORK2,AVTDOUBL          SET IN PARM LIST                00283500
         LA    R1,AVTDOUBL              POINT TO PARM LIST              00284200
         MVI   AVTDOUBL+1,FOUR                                 @YM07359 00284500
         L     R15,AVTUI                GET USER INETRFACE ADDR         00284900
         BALR  R14,R15                  LINK TO LOCATE OPTION FIELD     00285600
         SPACE                                                          00286300
         LTR   R15,R15                  IS OPTION FIELD FOUND           00287000
         BZ    TESTDEAD                 NO, GO TEST IF DLQ              00287700
         SPACE 1                                                OY00468 00288400
         TM    AVTDOUBL+6,ERMSFLAG      ERRORMSG REQUESTED ?    SA63999 00289800
         BNO   NERRMSG                  BRANCH IF NOT ERRORMSG  SA63999 00290500
         TM    0(R15),NUMASK            DECIMAL LENGTH SPEC    @OS77932 00290600
         BZ    GETLNGTH                 BRANCH YES             @OS77932 00290700
         SPACE                                                          00290800
         CLI   0(R15),FOXONE            HEX LENGTH GT ZERO     @OS77932 00290900
         BL    NERRMSG                  NO LENGTH SPECIFIED    @OS77932 00291000
GETLNGTH EQU   *                                               @OS77932 00291100
         IC    RWORK2,0(,R15)           LOAD LENGTH             SA63999 00291900
         N     RWORK2,NUMB              ACCESS LENGTH          @Y17XANQ 00292600
         LA    R15,ONE(,R15)            LOAD ADDRESS            SA63999 00293300
         B     LINKA1                                                   00294000
         SPACE 1                                                SA63999 00294700
NERRMSG  EQU   *                                                        00295400
         IC    RWORK2,AVTEZERO(,R1)     GET LENGTH              SA63999 00296100
         LA    RWORK2,ONE(,RWORK2)      LOAD PAST LENGTH        SA63999 00296800
         SPACE 3                                                 S21903 00297500
LINKA1   EQU   *                                                        00298200
         ST    R15,AVTDOUBL+4           SET ADDR OF CHAR STRING         00298900
         STC   RWORK2,AVTDOUBL+3          & COUNT IN PARM LIST          00299600
         CLI   AVTDOUBL+3,0             IS LENGTH ZERO         @OS77932 00299800
         BE    TESTDEAD                 YES, CHECK DEAD LTR Q  @OS77932 00300000
         MVI   AVTDOUBL+2,AVTEZERO      ZERO HIGH LENGTH BYTE           00300300
         MVI   AVTDOUBL,INDEXA1+ONE     SET BINARY SEARCH INDEX         00301000
         LA    R1,AVTDOUBL              POINT TO PARM LIST              00301700
         L     R15,AVTUI                GET USER INETRAFCE ADDR         00302400
         BALR  R14,R15                  LINK TO BINARY SEARCH           00303100
         SPACE                                                          00303800
         LTR   R1,R15                   IS NAME FOUND IN TNT            00304500
         BZ    TESTDEAD                 NO, GO TEST FOR DLQ             00305200
         SPACE                                                          00305900
LINKAV   EQU   *                                                        00306600
         MVC   PRFQCBA,SCBDESTQ         SAVE QCB ADDR              @11a 00306826
         L     R15,AVTMSGS-1            GET ADDR OF LOOKUP ROUTINE      00307300
         L     R15,INDEXAV(,R15)          FROM MH VCON TABLE            00308000
         LR    RWORK2,R13               SAVE ADDR OF AVTSAVE2           00308700
         LA    R13,AVTSAVE3             POINT TO AVTSAVE3               00309400
         BALR  R14,R15                  LINK TO LOOKUP ROUTINE          00310100
         SPACE                                                          00310800
         LR    R13,RWORK2               RESET ADDR OF AVTSAVE2          00311500
         LTR   R15,R15                  TEST IF TSO TERMINAL            00312200
         BNZ   TESTDEAD                 ERROR, BRANCH              @11A 00312926
         L     R14,AVTPARM              GET TTE ADDRESS            @11A 00313026
         TM    TRMSTATE-IEDQTRM(R14),TRMLIST                       @11A 00313126
         BZR   RGO9                     NOT A LIST,BRANCH          @11A 00313226
         L     R14,SCBDESTQ-1           GET QCB                    @11A 00313326
         CLC   FOUR(2,R14),IEDQBC       DLIST                      @11A 00313426
         BNER  RGO9                     NO, CLIST ALLOWED          @11A 00313526
         MVC   SCBDESTQ,PRFQCBA         RESTORE ORIGINAL QCB       @11A 00314226
         SPACE                                                          00314426
TESTDEAD EQU   *                                                        00314826
         LH    R1,AVTDLQX               PICK UP DEAD-LETTER Q KEY       00315000
         N     R1,AVTCLRHI              IS THERE A DEAD-LETTER Q        00315700
         BNZ   LINKAV                   YES, GO LINK TO LOOKUP          00316400
         SPACE                                                          00317100
POSTDISP EQU   *                                                        00317800
         NI    LCBSTAT1,LCBRCLLF        RESET RCLLN FOR IEDQBD @YM07401 00318100
         LA    RWORK2,AVTBFRTB          ADDRESS OF BUF RETURN  @Y17XANQ 00318500
         B     MOVEQCB                  GO POST BUFFER                  00319200
         SPACE                                                          00319900
ERRMSG   EQU   *                                                        00320600
         LR    R1,RELEM7                RESET ELEMENT ADDRESS           00321300
         LA    RPARM8,PARMAT(,RPARM8)   BUMP TO IEDQAT PARM LIST        00322000
         STCM  RPARM8,SEVEN,SCBMACR     SET IN SCB             @Y17XANQ 00322700
         SLR   R15,R15                  CLEAR                  @YM08381 00323000
         IC    R15,AVTEZERO(,RPARM8)    PICK UP IEDQAT OFFSET           00323400
         L     RBASE,AVTMSGS-1          GET MH VCON TABLE ADDRESS       00324100
         L     RBASE,AVTEZERO(R15,RBASE) GET IEDQAT ADDRESS             00324800
         BR    RBASE                    EXIT TO IEDQAT                  00325500
         SPACE                                                          00326200
SETQCB   EQU   *                                                        00326900
         L     RWORK2,SCBDESTQ-1        SET DEST QCB ADDRESS            00327600
         SPACE                                                          00328300
MOVEQCB  EQU   *                                                        00329000
         LA    RGO9,PRIDESTQ            PRIORITY               @Y17XANQ 00329700
         LR    R1,RPREFIX               BUFFER TO BE POSTED    @Y17XANQ 00330400
         TM    LCBSTAT1,LCBRCLLN        TEST FOR RECALL BIT    @YM07309 00330600
         BO    POSTBUF                  IF RECALL POST BUFFER  @YM07309 00330800
         BAL   R14,POSTSUB              ADD TO POST LIST       @Y17XANQ 00331100
         SPACE 1                                               @Y17XANQ 00331800
         LR    RELEM7,R1                NEW POST LIST          @Y17XANQ 00332500
         L     RWORK2,AVTMSGS-1         MH VCON LIST           @Y17XANQ 00333200
         L     RWORK2,0(,RWORK2)        ADDRESS OF IEDQBD      @Y17XANQ 00333900
         LA    RGO9,PRIRCQCB            PRIORITY FOR POST      @Y17XANQ 00334600
POSTERB  EQU   *                                               @Y17XANQ 00335300
         LA    R1,LCBERB                ELEMENT IS ERB         @Y17XANQ 00336000
POSTBUF  L     RDISP,AVTEA              GET ADDR OF DISPATCHER @YM07309 00336700
         USING IEDQDISP,RDISP                                           00337400
         LA    R14,DSPCHAIN             EXIT TO DISPATCHER     @Y17XANQ 00338100
POSTSUB  EQU   *                                               @Y17XANQ 00338800
         STCM  RWORK2,SEVEN,ONE(R1)     QCB @ TO ELEMENT       @Y17XANQ 00339500
         ST    RELEM7,FOUR(,R1)         LINK IN POST LIST      @Y17XANQ 00340200
         STC   RGO9,FOUR(,R1)           PRIORITY               @Y17XANQ 00340900
         BALR  R14,R14                  EXIT/RETURN            @Y17XAMX 00341600
         SPACE 1                                               @Y17XANQ 00342300
ERBTOAZ  EQU   *                                               @Y17XANQ 00343000
         LA    RWORK2,AZQCB             QCB ADDRESS            @Y17XANQ 00343700
         LA    RGO9,PRIBFRTB            PRIORITY               @Y17XANQ 00344400
         B     POSTERB                  POST ERB               @Y17XANQ 00345100
GOERB    EQU   *                                               @Y17XANQ 00345800
         MVI   LCBERBCT,ONE             REQUEST ONE BUFFER     @OY12678 00346500
         OI    LCBERBST,LCBPRCPG        SET RETURN FLAG        @OY12678 00347200
         NI    LCBERBST,AVTEFF-LCBERROR  RESET LCBERROR            @21A 00347527
         LA    RGO9,AZQCB               SET ADDRESS OF QCB TO  @OY12678 00347900
         STCM  RGO9,SEVEN,LCBCMDSV+1    RECEIVE ERB            @OZ32858 00348600
         LR    RELEM7,R1                POST LIST              @Y17XANQ 00349300
         LA    RWORK2,AVTBFREB          BUFFER REQUEST         @Y17XANQ 00350000
         LA    RGO9,PRIINTRQ            POST PRIORITY          @Y17XANQ 00350700
         B     POSTERB                  REQUEST BUFFER         @Y17XANQ 00351400
         DS    0F                                              @Y17XANQ 00352100
         ORG   *-8                                             @Y17XANQ 00352800
AZQCB    EQU   *                        ERB RETURN QCB         @Y17XANQ 00353500
         ORG                                                            00354200
ASTCB    DC    AL1(DSPMCPL4)            STCB                   @OY12678 00354900
         DC    AL3(*-1)                                        @OY12678 00355600
         USING *,R15                                           @OY12678 00356300
         L     RBASE,ADRAZ              LOAD BASE REGISTER     @OY12678 00357000
         SH    R1,ERBLCB                BACK UP TO LCB         @OY12678 00357700
         LR    RLCB4,R1                 SET LCB BASE           @OY12678 00358400
         L     RGO9,LCBDCBPT            SET DCB BASE           @OY13658 00359100
         L     RSCB3,LCBSCBA-1          SET SCB BASE           @OY13658 00359800
         SR    R1,R1                    CLEAR POST LIST ADDR   @OY13658 00360500
         L     RPARM8,SCBMACR-1         SET PARM LIST ADDR     @OY13658 00361200
         TM    LCBERBST,LCBPRCPG        RETURN FROM POST DELAY @OY13658 00361900
         BNO   NOLIST                   YES, CONTINUE POST     @OY13658 00362600
         NI    LCBERBST,AVTEFF-LCBPRCPG RESET POST FLAG        @OY13658 00363300
         SR    RELEM7,RELEM7            CLEAR UNIT COUNT REG   @OY13658 00364000
*                                       ADDRESS                @OY12678 00364700
         L     RPREFIX,LCBERBCH-1       GET BUFFER ADDRESS     @OY12678 00365400
         B     BUFHERE                  INITIALIZE BUFFER      @OY12678 00366100
ERBLCB   DC    AL2(LCBERB-IEDQLCB)      ERB OFFSET             @OY12678 00366800
ADRAZ    DC    A(IEDQAZ01)              BEGINNING OF IEDQAZ    @OY12678 00367500
COMPRET0 DC    F'0'                     RET CODE ZERO           X30X5MT 00368200
COMPRET4 DC    F'4'                     RET CODE FOUR           X30X5MT 00368900
COMPRET8 DC    F'8'                     RET CODE EIGHT          X30X5MT 00369600
NUMB     DC    X'0000000F'              MASK FOR PRPM          @Y17XANQ 00370300
IEDQBC   DC    C'BC'                                               @11A 00370426
         DS    0F                                                  @01A 00370512
USERSAVE DC    18X'00000000'            USEREXIT SAVE AREA         @01A 00370712
         EJECT                                                          00371000
********* DSECTS *********                                              00371700
         DCBD  DSORG=TX                                                 00372400
         SPACE                                                          00373100
         TAVTD ,                                                 S22025 00373800
         EJECT                                                          00374500
         TDISPD                                                         00375200
         EJECT                                                          00375900
         TLCBD                                                          00376600
         EJECT                                                          00377300
         TPRFD                                                          00378000
         EJECT                                                          00378700
         TPRIOR                                                         00379400
         EJECT                                                          00380100
         TSCBD                                                          00380800
         TTNTD                                                 @XM05843 00381100
         TTRMD                                                 @SA72461 00381500
         SPACE                                                          00382200
         END                                                            00382900
