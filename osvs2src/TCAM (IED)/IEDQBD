BD01     TITLE '''IEDQBD'' - BUFFER DISPOSITION SUBTASK'                00100005
         SPACE 2                                                        00103005
IEDQBD   CSECT                                                          00106005
*A-000000-999999                                               @Z37X9MG 00107000
         SPACE 3                                                        00109005
******************** MICROFICHE FLAGS *********************** SUPT CODE 00112005
*A317900                                                         A51786 00115005
*C317200-317320                                                  A51786 00118005
*A175500,444500,492500                                           X01004 00121005
*C097600,131000,140800,175000,207000,215000,242940,259800,259940,X01004 00124005
*C376400,387000,440000,444000,448000,454000,459000,462000-464000,X01004 00127005
*C470000                                                         X01004 00130005
*D098300,132000-133000,176600,204000-205000,216000-217000,       X01004 00133005
*D259970-259980,376600-376800,441000,442000,449000-451000        X01004 00136005
*C452000                                                         X02004 00139005
*D259990                                                         X02004 00142005
*A360000,369200,371000,491000                                    S99228 00200522
*A105000,242000,259000,379000                                    S21101 00200622
*D381000                                                         S21101 00200722
*C098300,140800,383000                                           S21101 00200822
*C036000,100000,141000,225300,383000,488000-490000               S22025 00200922
*D384000-385000                                                  S22025 00201022
*A258000,380000,386000,437000,441000                             S22025 00201122
*A177600,209000                                                  A42363 00201222
*C0983000                                                        A42363 00201322
*A003500,176250-176260,226607-226691,233800-237000               S22026 00201422
*A372000                                                        SA52971 00201522
*C137000-137600,226250-226295                                   SA52971 00201622
*D260000-262000                                                 SA52971 00201722
*C098300                                                          M0891 00201822
*D259970-259980                                                   M0891 00201922
*C301000                                                         S21903 00202022
*A378000                                                        SA57687 00202122
*C181000,192000,194000,195000                                   SA59170 00202222
*A196000                                                        SA59170 00202322
*A364900,503100                                                 SA59976 00202422
*A379600                                                        SA61764 00202555
*C379500                                                        SA61764 00202655
*C141600                                                        SA66621 00202755
*A364905-364915,503050                                           S22024 00202855
*C097600-098300                                                  S22024 00202955
*A317900,319000                                                 SA67078 00203055
*A380100-380500                                                  Y06327 00203155
*A321100                                                        SA66605 00203255
* A388400                                                       OY00539 00203355
*A 365000                                                       OY03908 00203455
*A107200,308000,388600                                           X03039 00203507
*C008000,388480-388490                                           X03039 00203607
*A190000,388750,489000,503260                                  @X50X9IL 00203709
*A365100                                                       @SA62375 00203809
*C356000                                                       @SA73549 00203909
*A141400                                                       @OX11952 00204081
*A365100,365112,503260                                         @OS76699 00204191
*C141320                                                       @OS76997 00204291
*C380600                                                       @YA10449 00209200
*A034000,057000,059000,064000,127000,190600,226900,242000      @Y17XAMG 00214200
*A317000                                                       @Y17XAMG 00224200
*C388500,008000,388500                                         @Y17XAMG 00234200
*D388650-388710                                                @Y17XAMG 00264200
*C225800-225900                                                @OX13506 00266200
*A137600,D226270-226280                                        @OX12557 00268200
*A354000                                                       @YM04622 00274200
*C141340,317400,365380                                         @YM04622 00280200
*D141320,141360,356000-359000,365360,365400,388000-388520      @YM04622 00286200
*D388750-388800                                                @YM04622 00292200
*C107560,107620                                                @YM07396 00295200
*D380100-380500                                                @OY08751 00297200
*C365006-365012                                                @OS78326 00298200
*A141460,141520                                                @OZ25938 00298382
* DUMMY APAR                                                   @OZ27328 00298482
         SPACE 3                                                        00300022
         ENTRY IEDQBD01                                                 00350022
         ENTRY IEDQBD02                                          S22026 00351022
*********************************************************************** 00400020
*TITLE -- 'IEDQBD' BUFFER DISPOSITION SUBTASK                         * 00500020
*                                                                     * 00600020
*  MODULE NAME = IEDQBD                                                 00610022
*                                                                       00620022
*  DESCRIPTIVE NAME = BUFFER DISPOSITION                                00630022
*                                                                       00640022
*  COPYRIGHT = NONE                                                     00650022
*                                                                     * 00700020
*STATUS -- CHANGE LEVEL 10                                     @Y17XAMG 00800000
*                                                                     * 00900020
*FUNCTION -- THIS SUBTASK GAINS CONTROL WHEN THE LAST SEGMENT OF A    * 01000020
*  MESSAGE HAS BEEN RECEIVED OR SENT AND PROCESSED BY THE MESSAGE     * 01100020
*  HANDLER UP TO BUT NOT INCLUDING THE INMSG/OUTMSG SUBGROUP.  IT     * 01200020
*  ALSO RECEIVES CONTROL WHEN THE END OF A POLLING LIST HAS BEEN      * 01300020
*  REACHED, AND WHEN THE LAST BUFFER OF A BLOCK HAS BEEN RECEIVED     * 01400020
*  OR SENT TO A BUFFERRED TERMINAL.  UNUSED BUFFERS ARE RETURNED TO   * 01500020
*  THE BUFFER RETURN QUEUE AND THE INMSG/OUTMSG MACROS ARE EXECUTED.  * 01600020
*  THIS SUBTASK CHECKS THE PARAMETER LIST FOR EACH MACRO IN THE       * 01700020
*  INMSG/OUTMSG SUBGROUP CHECKING THE ERROR WORD AGAINST THE MASK     * 01800020
*  SPECIFIED , IF EXECUTION OF THE FUNCTION IS CONDITIONAL.  IF THE   * 01900020
*  ROUTINE REPRESENTED BY THE PARAMETER LIST REQUIRES A RECALLED      * 02000020
*  HEADER, THE ERB IS TPOSTED TO THE DISK I/O QCB TO PERFORM A RECALL * 02100020
*  THIS RECALLED HEADER IS RETURNED TO IEDQBD VIA A TPOST AND PASSED  * 02200020
*  TO THE ROUTINE.  EACH ROUTINE THAT RECEIVES CONTROL, PERFORMS ITS  * 02300020
*  FUNCTION AND EXITS BY TPOSTING THE RECALLED HEADER (IF ONE WAS     * 02400020
*  PASSED TO IT) OR THE ERB BACK TO IEDQBD TO CONTINUE EXECUTION      * 02500020
*  OF THE NACRO INSTRUCTIONS.  IN THE CASE OF RECALLED HEADERS, AFTER * 02600020
*  THE RECALLED HEADER IS TPOSTED BY THE MACRO ROUTINE, IT IS         * 02700020
*  RETURNED TO IEDQBD BY IEDQFA.  WHEN THE INEND/OUTEND EXPANSION IS  * 02800020
*  DETECTED, A CHECK IS MADE FOR DISTRIBUTION LIST, MULTIPLE          * 02900020
*  ROUTING AN CHECKPOINT REQUEST.  IF ANY OF THESE FUNCTIONS HAVE     * 03000020
*  BEEN REQUESTED,  THE APPROPRIATE SUBTASK RECEIVES CONTROL VIA A    * 03100020
*  TPOST.  FOR OUTPUT MESSAGES, THE MESSAGE JUST SENT IS THEN MARKED  * 03200020
*  SERVICED.  FOR BOTH SEND AND RECEIVE, THE LCB IS THEN TPOSTED TO   * 03300020
*  ITSELF.                                                            * 03400020
*                                                                     * 03410000
*  FOR MESSAGES INPUT FROM A SNA LU(OUTBOARD) BUFFER DISPOS-   @Y17XAMG 03420000
*  ITION LINKS TO IEDQRS TO GENERATE A DEFAULT RESPONSE IF     @Y17XAMG 03430000
*  A RESPONSE WAS NOT SENT DURING USER (SSCP/TOTE) MH          @Y17XAMG 03440000
*  PROCESSING. THIS IS DONE IF LCBRESP IS SET INDICATING A     @Y17XAMG 03450000
*  RESPONSE IS REQUIRED. ALSO, IF A RESONSE TO A CANCEL RU     @Y17XAMG 03460000
*  IS REQUIRED (LCBCANXT^=0) LINKAGE IS MADE TO IEDQRS TO      @Y17XAMG 03470000
*  RESPOND.                                                    @Y17XAMG 03480000
*                                                                     * 03500020
*ENTRY POINTS -- IEDQBD01,IEDQBD02                              S22025  03600022
*                                                                     * 03700020
*   CALLING SEQUENCE -                                                * 03800020
*                  L     R1,ELMAD                                     * 03900020
*                  L     R15,QCBSTCHN-1                               * 04000020
*                  LA    R15,4(R14)                                   * 04100020
*                  BR    R15                                          * 04200020
*                                                                     * 04300020
*INPUT -- ENTRY IS ALWAYS FROM THE TCAM DISPATCHER                    * 04400020
*         PARAMETERS ARE PASSED IMPLICITLY IN REGISTERS AS FOLLOWS:   * 04500020
*                  R1    ADDRESS OF THE PASSED ELEMENT -              * 04600020
*                        BUFFER,  ERB,  OR LCB                        * 04700020
*                  R11   BASE FOR TCAM DISPATCHER                     * 04800020
*                  R13   ADDRESS OF AVTSAVE2                          * 04900020
*                  R15   BASE FOR THIS ROUTINE                        * 05000020
*                                                                     * 05100020
*OUTPUT --  THE LCB IS TPOSTED TO ITSELF, FOR SEND OPERATIONS,        * 05200020
*  THE MESSAGE IS MARKED SERVICED,  FOR RECEIVE - THE END OF MESSAGE  * 05300020
*  SEGMENT IS TPOSTED TO THE DESTINATION QUEUE,  AND THE INMSG/OUTMSG * 05400020
*  SUBGROUP IS EXECUTED.                                              * 05500020
*                                                                     * 05600020
*EXTERNAL ROUTINES -- IEDQTNT(TNT INDEX CONVERSION ROUTINE            * 05700000
*                     IEDQRS(RESPONSE GENERATOR)               @Y17XAMG 05750000
*                                                                     * 05800020
*EXITS - NORMAL -- THE TCAM DISPATCHER AT ENTRY POINT DSPCHAIN        * 05900020
*                  MH FUNCTION ROUTINES VIA A BRANCH           @Y17XAMG 05950000
*                                                                     * 06000020
*EXITS-ERROR -- NONE                                                  * 06100020
*                                                                     * 06200020
*TABLES/WORKAREAS --                                                  * 06300020
*    DSECTS USED - TAVTD, TDISPD, TSCBD, TLCBD, TPRFD, TQCBD   @Y17XAMG 06400000
*                  TPRIOR, TTRMD, DCBD                         @Y17XAMG 06450000
*                                                                     * 06500020
*ATTRIBUTES -- REUSEABLE, REFRESHABLE, ENABLED, RESIDENT, PROBLEM     * 06600020
*              PROGRAM MODE.                                          * 06700020
*                                                                     * 06800020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 06900020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET  * 07000020
*                                                                     * 07100020
*********************************************************************** 07200020
*                                                                       07300020
*            REGISTERS                                                  07400020
*                                                                       07500020
R0       EQU   0                        REG 0                    S22024 07600022
R1       EQU   1                        PASSED ELEMENT           S22024 07700022
R2       EQU   2                        REG 2                    S22024 07800022
RSCB     EQU   3                        REG 3                    S22024 07900022
RLCB     EQU   4                        REG 4                    S22024 08000022
R5       EQU   5                        REG 5                    S22024 08100022
RPREFIX  EQU   6                        REG 6                    S22024 08200022
RQCB     EQU   7                        LAST DISPATCHED QCB      S22024 08300022
R8       EQU   8                        REG 8                    S22024 08400022
R9       EQU   9                        REG 9                    S22024 08500022
R10      EQU   10                       REG 10                   S22024 08600022
R11      EQU   11                       ADDRESS OF DISPATCHER    S22024 08700022
R12      EQU   12                       REG 12                   S22024 08800022
R13      EQU   13                       DISPR DAVE AREA (AVTSAVE2S22024 08900022
R14      EQU   14                       REG 14                   S22024 09000022
R15      EQU   15                       SUBTASK ENTRY POINT             09100020
         USING IEDQSCB,RSCB                                             09200020
         USING IEDQLCB,RLCB                                             09300020
         USING IEDQDISP,R11                                             09400020
         USING AVTSAVE2,R13                                             09500020
         USING IEDQPRF,RPREFIX                                          09600020
         EJECT                                                          09700020
IEDQBD   IEDHJN ,                       SET NAME AND DATE        S22024 09760022
         DC    AL1(DSPMCPL4)            SUBTASK ENTRY CODE (VTO)        09900020
         DC    AL3(*-1)                 STCB ADDRESS             S22025 10000022
         EJECT                                                          10100020
IEDQBD01 EQU   *                                                        10200020
         USING *,R15                                                    10300020
         SR    R0,R0                    CLEAR FOR ZEROING FIELDS        10400020
         LA    RQCB,0(RQCB)             INSURE POSITIVE REGISTER        10500020
         MVC   AVTDOUBL(1),LCBPRI-IEDQLCB(R1) SAVE POST PRIORITY S21101 10550020
         CLI   LCBPRI-IEDQLCB(R1),PRIFSPCI-1 LCB FOR CLEANUP            10600020
         BNE   CKBFR                    BRANCH NO CHECK ERB             10660020
*                                                                       10720020
*                                       VTAM PLCB                X03039 10726007
         CLI   LCBFLAG1-IEDQLCB(R1),PLCB                         X03039 10732007
         BNE   NOTAPLCB                 BR NO                  @Y17XAMG 10738000
*                                                                X03039 10744007
*                                       INDICATE NO BFRS TO FREE X03039 10750007
         TM    LCBSTAT1-IEDQLCB(R1),LCBRCLLN                   @YM07396 10756000
         BO    BD02BR                   GO CLEAN UP PLCB       @YM07396 10762000
*                                                                X03039 10768007
NOTAPLCB EQU   *                                               @Y17XAMG 10774000
         L     R1,LCBLSPCI-IEDQLCB-1(R1)  PICK UP FIRST BUFFER @        10780020
CKBFR    EQU   *                                                        10840020
         LR    RPREFIX,R1               ASSUME ELEMENT IS A BUFFER      10900020
         LR    R1,R0                    INDICATE END OF POST LIST       11000020
         LR    R9,R0                    CLEAR FOR IC                    11100020
*                                                                       11200020
         TM    PRFTIC,X08               PASSED ELEMENT A BUFFER         11300020
         BZ    CKERB                      BRANCH NO                     11400020
*                                                                       11500020
         L     RLCB,PRFLCB-1            SOURCE/DESTINATION LCB          11600020
         L     RSCB,LCBSCBA-1           SCB ADDRESS                     11700020
         L     R8,SCBMACR-1             FIRST/NEXT  INMSG/OUTMSG MACRO  11800020
         TM    LCBSTAT1,LCBRCLLN        LCB SET TO RECALL               11900020
         BO    CONTIN                     BRANCH YES, EXECUTE MACRO     12000020
*                                                                       12100020
         LR    R5,RPREFIX               SET TO POST BUFFER              12200020
         IC    R9,PRFNBUNT              NUMBER OF UNITS/BUFFER          12300020
NUNIT    EQU   *                                                        12400020
         L     RPREFIX,PRFTIC           NEXT BUFFER(UNIT) ADDRESS       12500020
         BCT   R9,NUNIT                 BRANCH UNTIL BUFFER FOUND       12600020
*                                                                       12700020
         TM    LCBSTAT1,LCBSENDN        SEND OPERATION                  12744000
         BZ    RECEIVE                    BRANCH NO                     12745000
*                                                                       12746000
         STCM  R5,AD,LCBLSPCI           SAVE LAST BUFFER ADDRESS X01004 12747000
         MVC   PRFRCB-IEDQPRF(3,R5),SCBDESTQ  SAVE FOR FA               12748000
*** THE PRIORITY LEVEL MUST BE MAINTAINED ACCROSS RECALLS FOR   SA52971 12749000
*   MARKING SERVICED                                            SA52971 12750000
         MVC   PRFTQBCK-IEDQPRF(1,R5),SCBPRI SET THE PRI LEVEL  SA52971 12751000
         MVC   PRFTQBCK+1-IEDQPRF(2,R5),SCBOSEQ SET SEQUENCE   @OX12557 12751200
*                                         OUT FOR TERMINALS    @OX12557 12751400
*                                         (NON-CONC)           @OX12557 12751600
         LA    R12,RSTMDL               SET EXIT ADDRESS                12752000
         TM    LCBERBST,LCBERROR        TEXT ERROR ENCOUNTERED          12753000
         BZ    NOERR                   BRANCH NO                        12754000
*                                                                       12755000
         NI    SCBQTYPE,X'FF'-SCBBFMM  RESET MIDDLE OF MESSAGE          12756000
         B     ERBWAIT                 GO SEE IF SHOULD WAIT ON ERB     12757000
         SPACE 1                                                        12758000
NOERR    EQU   *                                                        12759000
         TM    PRFSTAT1-IEDQPRF(R5),PRFITCPN  LOGICAL END OF MSG X01004 12760000
         BZ    RSTMDL                   BRANCH-NO                S22025 14100022
*                                                                       14120020
         OI    LCBERBST,LCBERROR       SIMULATE ERROR                   14126020
         STCM  RQCB,7,LCBRCQCB+1        QCB ADDRESS            @YM04622 14129000
         LR    RPREFIX,R5               RESET BUFFER ADDRESS            14140020
         SR    R12,R12                  CLEAR FOR STORE        @OX11952 14146081
         TM    SCBQTYPE,SCBBBFTM+SCBBFMM MIDDLE OF MSG ?       @OZ25938 14147082
         BO    NOCLR                    DO NOT CLEAR IF SENDING         14148082
*                                       AND IN MIDDLE OF MSG   @OZ25938 14149082
         ST    R12,SCBMRFSD             CLEAR MULTIROUTE FIELDS@OX11952 14152081
NOCLR    EQU   *                        BYPASS CLEARING        @OZ25938 14156082
         LA    R12,BBNOFRE              SET EXIT ADDRESS        SA66621 14160005
ERBWAIT  EQU   *                                                        14180020
*                                                                       14200020
         BAL   R10,BUFPST               FREE ANY BIFFERS AFTER          14300020
*                                       ERROR EOM BUFFER - IF ANY       14400020
*                                                                       14500020
         TM    LCBERBST,LCBDLNKN+LCBEOMSG IS ERB AVAILABLE              14600020
         BNZ   ADDLABEL                 WAIT FOR ERB           @Y17XAIX 14700000
         BAL   R14,DSPCHAIN                                    @Y17XAIX 14750000
*                                                                       14800020
ADDLABEL BR    R12                       EXIT                  @Y17XAIX 15200000
POSTERB  EQU   *                                                        15700020
         LPR   R2,RQCB                  QCB ADDRESS                     15800020
         LA    R5,LCBERB                ERB ADDRESS                     15900020
         LA    R9,PRIEDISP              PRIORITY                        16000020
         B     EXIT                     ADD TO POST LIST AND EXIT       16100020
*                                       TO DISPATCHER                   16200020
*                                                                       16300020
CONTIN   EQU   *                                                        16400020
         NI    LCBSTAT1,X'FF'-LCBRCLLN  RECALL FLAG OFF                 16500020
         L     RPREFIX,LCBERBCH-1       ADDRESS OF RECALLED BUFFER      16600020
         B     REMBUF                   FREE THE RECALLED UNIT(S)       16700020
*                                                                       16800020
CKERB    EQU   *                                                        16900020
*                                       ACCESS LCB BY SUBTRACTING       17000020
         LR    RLCB,RPREFIX             TO LCB REGISTER                 17100020
         SH    RLCB,ERBLCB                SIZE OF LCB PRIOR TO ECB      17200020
         L     RSCB,LCBSCBA-1           SCB ADDRESS                     17300020
         L     R8,SCBMACR-1             NEXT/LAST MACRO EXECUTED        17400020
         SR    RPREFIX,RPREFIX                                   X01004 17500005
         ICM   RPREFIX,AD,LCBERBCH      RECALLED-HEADER ADDR     X01004 17550005
         TM    LCBSTAT1,LCBRCLLN        LCBSTATE SET TO RECALL          17600020
         BO    CONTINUE                 BRANCH YES                      17603020
*                                                                       17606020
         TM    SCBQTYPE,SCBBBFTM+SCBBFMM  BFRD MIDDLE OF MSG            17618020
         BNO   RSTMDL                   BRANCH NO                       17621020
*                                                                       17624020
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 17625022
         BO    BDCLUP                   BRANCH IF YES            S22026 17626022
         B     LOGEOM                   BRANCH SEND LOGICAL END OF      17627020
*                                       MESSAGE FOR BUFFERRED TERMS     17630020
*                                                                       17633020
CONTINUE EQU   *                                                        17636020
*                                                                       17640020
         LTR   RPREFIX,RPREFIX          WAS RECALL SUCCESSFUL           17680020
         BNZ   NORCALL                  BRANCH YES                      17700020
*                                                                       17720020
*                    IGNORE MACRO - CHECK NEXT                          17740020
         OI    SCBERR3,SCBLOSTN         SET MESSAGE LOST                17760020
         OI    SCBHBFNO,SCBNORCL         THE PREVIOUS RECALL DID A42363 17770000
*                                          NOT GET A BUFFER      A42363 17780000
*                                                                       17800020
RSTMDL   EQU   *                                                        17830020
         NI    SCBQTYPE,X'FF'-SCBBFMM   RESET MIDDLE OF MESSAGE BIT     17860020
FNDMAC   EQU   *                                                        17900020
         IC    R9,1(R8)                 LENGTH OF PARAMETER LIST        18000020
         CLI   1(R8),X02                ANY LOGICAL BITS ON     SA59170 18100022
         BE    ADDLGTH                  NO, DONT CLEAR          SA59170 18150022
         N     R9,CLEARL2               CLEAR LOW ORDER BITS    SA59170 18200022
ADDLGTH  EQU   *                                                SA59170 18250022
         AR    R8,R9                    ADD LENGTH TO ACCESS NEXT LIST  18300020
         TM    0(R8),X01                EXECUTION CONDITIONAL           18400020
         BO    CKRCALL                    BRANCH NO                     18500020
*                                                                       18600020
         OC    SCBERR2,AVTSYSER         SET SYSTEM ERROR BITS           18700020
         L     R10,SCBERRST             ERROR WORD                      18800020
         ST    R10,LCBCSWSV-1           STORE FOR COMPARE               18900020
         MVC   LCBCSWSV+3(1),LCBSENS0   MOVE SENSE BYTE                 19000020
*                                                              @X50X9IL 19002009
*              CHECK WHETHER MESSAGE ERROR RECORD DATA NEEDS   @X50X9IL 19004009
*              TO BE MODIFIED BEFORE BEING TESTED (APPLICABLE  @X50X9IL 19006009
*              FOR SNA LOGICAL UNITS ONLY).  THE EFFECT OF     @X50X9IL 19008009
*              THIS MODIFICATION IS AS FOLLOWS:                @X50X9IL 19010009
*                                                              @X50X9IL 19012009
*              IF THE SNA MINOR SENSE BYTE IN THE ERROR MASK   @X50X9IL 19014009
*              IS CODED AS '00'X THE SNA MAJOR SENSE BITS ARE  @X50X9IL 19016009
*              INTERPRETED IN A GENERAL WAY (TEST FOR ALL TYPES@X50X9IL 19018009
*              OF ERRORS WITHIN A GENERAL CLASS, IGNORING THE  @X50X9IL 19020009
*              SNA MINOR SENSE VALUE).  NO MODIFICATION IS     @X50X9IL 19022009
*              DONE IN THIS CASE.                              @X50X9IL 19024009
*                                                              @X50X9IL 19026009
*              IF THE SNA MINOR SENSE BYTE IN THE ERROR MASK   @X50X9IL 19028009
*              IS CODED AS A NON-ZERO VALUE THEN THE SNA       @X50X9IL 19030009
*              SENSE BITS ARE INTERPRETED IN A SPECIFIC WAY    @X50X9IL 19032009
*              (TEST FOR ONLY THE ERROR WITH THIS EXACT SNA    @X50X9IL 19034009
*              MAJOR AND MINOR SENSE).  IF THE ACTUAL SNA      @X50X9IL 19036009
*              ERROR DATA MATCHES THE SNA ERRORS SPECIFIED ON  @X50X9IL 19038009
*              THE ERROR MASK, NO MODIFICATION TAKES PLACE.    @X50X9IL 19040009
*              IF THEY DO NOT MATCH, BOTH THE SNA MAJOR AND    @X50X9IL 19042009
*              MINOR SENSE DATA IN THE MESSAGE ERROR RECORD    @X50X9IL 19044009
*              ARE CLEARED TO ZERO BEFORE TESTING AGAINST      @X50X9IL 19046009
*              THE FULL ERROR MASK.                            @X50X9IL 19048009
*                                                              @X50X9IL 19050009
         USING MASKD,R8                 SET ERROR MASK BASE    @X50X9IL 19052009
         CLI   LCBFLAG1,PLCB            IS THIS A PLCB?        @X50X9IL 19054009
         BNE   TESTMASK                 BRANCH IF NO           @X50X9IL 19056009
         TM    LCBSTAT5,LCBLUNIT        SNA LOGICAL UNIT?      @X50X9IL 19058009
         BZ    TESTMASK                 BRANCH IF NO           @X50X9IL 19060009
         MVC   LCBCSWSV+3(1),LCBLUSNS+1 MOVE SNA MINOR SENSE   @Y17XAMG 19060500
*                                       INTO 5TH ERROR BYTE    @Y17XAMG 19061000
*                                       POSITION.              @Y17XAMG 19061500
         CLI   MASKLAST,X00             LAST BYTE OF MASK = 0? @X50X9IL 19062009
         BE    TESTMASK                 BRANCH IF YES          @X50X9IL 19064009
*              R10 CONTAINS THE 1ST 4 MSG ERROR RECORD BYTES   @X50X9IL 19066009
         N     R10,SNAMAJOR             ANY SNA MAJOR SENSE?   @X50X9IL 19068009
         BZ    ZEROLAST                 BRANCH IF NO           @X50X9IL 19070009
         MVC   AVTSAVE3(4),MASK4        MOVE 1ST 4 BYTES OF    @X50X9IL 19072009
*                                       ERROR MASK TO FULLWORD @X50X9IL 19074009
         N     R10,AVTSAVE3             IS THE SAME SNA MAJOR  @X50X9IL 19076009
*                                       SENSE BIT IN ERR MASK? @X50X9IL 19078009
         BZ    ZEROLAST                 BRANCH IF NO           @X50X9IL 19080009
         CLC   LCBCSWSV+3(1),MASKLAST   ARE LAST BYTES EQUAL?  @X50X9IL 19082009
         BE    TESTMASK                 BRANCH IF YES          @X50X9IL 19084009
         X     R10,LCBCSWSV-1           TURN OFF SNA MAJOR SNS @X50X9IL 19086009
         ST    R10,LCBCSWSV-1           ...IN MSG ERROR RCD    @X50X9IL 19088009
*                                                              @X50X9IL 19090009
ZEROLAST EQU   *                                               @X50X9IL 19092009
         MVI   LCBCSWSV+3,X00           ZERO SNA MINOR SENSE   @X50X9IL 19094009
*                                       IN MSG ERROR RECORD    @X50X9IL 19096009
TESTMASK EQU   *                                               @X50X9IL 19098009
         NC    LCBCSWSV-1(5),3(R8)      CHECK MASK AGAINST ERROR BYTES  19100020
         BNZ   CHECKAND                 GO CHECK AND FNCTION    SA59170 19200022
         TM    1(R8),X02                IS NAND FUNCTION REQSTD SA59170 19220022
         BO    CKRCALL                  IF YES, BRANCH          SA59170 19240022
         B     FNDMAC                   NO,ACCESS NEXT MACRO    SA59170 19260022
*                                                                       19300020
CHECKAND EQU   *                                                SA59170 19350022
         TM    1(R8),1                  IS AND FUNCTION REQUESTED       19400020
         BO    COMPARE                  BRANCH IF YES           SA59170 19500022
         TM    1(R8),X02                IS NAND FUNCTION REQSTD SA59170 19520022
         BO    FNDMAC                   IF YES, BYPASS MACRO    SA59170 19540022
         B     CKRCALL                  NO, OR IS REQUESTED     SA59170 19560022
*                                                                       19600020
COMPARE  EQU   *                                                SA59170 19650022
         CLC   LCBCSWSV-1(5),3(R8)      WAS AND SUCCESSFUL              19700020
         BNE   FNDMAC                   BRANCH NO, ACCESS NEXT MACRO    19800020
*                                                                       19900020
CKRCALL  EQU   *                                                        20000020
         TM    0(R8),X02                RECALLED HEADER NEEDED          20100020
         BZ    SETNXT                     BRANCH NO                     20200020
*                                                                       20300020
         LA    R2,AVTBFRTB              ADDRESS OF BUFFER RETURNN       20600020
         CLM   R2,AD,SCBDESTQ           IS DESTINATION BUFR RTN  X01004 20700005
         BE    FNDMAC                   BRANCH YES - BYPASS THIS MACRO  20800020
*                                                                       20900020
         TM    SCBHBFNO,SCBNORCL         HAS A PREVIOUS RECALL   A42363 20920000
*                                          FAILED TO GET A BFR   A42363 20940000
         BO    FNDMAC                    BR YES TO CONTINUE PROC.A42363 20960000
         LTR   R2,RQCB                  CAN RECALL BE DONE              21000020
         BM    POSTERB                  BRANCH NO - WAIT UNTIL HEADER   21100020
*                                       HAS BEEN POSTED TO DESTINATION  21200020
*                                                                       21300020
SETNXT   EQU   *                                                        21400020
         STCM  R8,AD,SCBMACR            SAVE LIST ADDRESS        X01004 21500005
         BNZ   BBRCALL                  RECALL HEADER                   21800020
         XC    LCBERBCH,LCBERBCH        CLEAR ERBCH FOR NEXT   @YM07367 21850000
*                                       INMSG/OUTMSG MACRO     @YM07367 21870000
NORCALL  EQU   *                                                        21900020
         L     R12,AVTMSGS-1            ACCESS MH MACRO ROUTINE ADDRS.  22000020
         IC    R9,0(R8)                 INDEX TO ROUTINE VCON           22100020
         N     R9,CLEARL2               CLEAR LOW ORDER 2 BITS          22200020
         L     R12,0(R9,R12)            SETUP BASE FOR MH ROUTINE       22300020
         BCR   7,R12                      BRANCH TO ROUTINE             22400020
*                                       IF ZERO, THIS IS IN/OUTEND      22500020
*                                                                       22510020
         TM    LCBSTAT1,LCBSENDN        SEND STATE                      22520020
         BZ    BDCLUP                   BRANCH NO - CHECK FOR    S22025 22530022
*                                       IEDQNX                   S22025 22535022
*                                                                       22540020
*                  SET MESSAGE SERVICED                                 22550020
         L     R5,LCBLSPCI-1            ADDRESS OF EOM SEGMENT          22560020
         N     R5,CLEARL2               WAS HOLD EXECUTED               22570020
         BNZ   MARKSRV                  NO, GO MARK MSG SRVCD  @OX13506 22571000
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN LOCK MODE            @OX13506 22572000
         BZ    BDCLUP                   NO,GO CLEAN UP         @OX13506 22573000
         XI    LCBSTAT1,LCBSENDN+LCBRECVN SET TO RETRANSMIT    @OX13506 22574000
         XC    SCBMRFSD(3),SCBMRFSD     CLEAR MULTIPLE ROUTE   @OX13506 22575000
         B     BDCLUP                   GO CLEAN UP            @OX13506 22576000
MARKSRV  EQU   *                                               @OX13506 22577000
*                                                                       22600020
         MVC   SCBDESTQ,PRFRCB-IEDQPRF(R5)  RESTORE DESTQ FOR FA        22610020
         BAL   R9,SVQTYP                SAVE Q TYPE                     22620020
*** THIS CODE WILL SET THE SEQUENCE OUT AND FEFO FOR TERMINALS  SA52971 22625022
*   SO THAT IEDQFA WILL NOT HAVE TO DISTINGUISH BETWEEN         SA52971 22625522
*   APPLICATION PROGRAMS AND NON-CONCENTRATOR TERMINALS TO FIND SA52971 22626022
*   THE FEFO POINTER TO WRITE WHEN MADKING SERVICED             SA52971 22626522
         MVC   PRFSRCE-IEDQPRF(3,R5),SCBFEFO SET NEW FEFO       SA52971 22628522
*                                         POINTER FOR TERMINALS SA52971 22629022
*                                         (NON-CONC)            SA52971 22629522
*                                                                       22630020
         NI    PRFSTAT1-IEDQPRF(R5),PRFNLSTF  INSURE LAST SEGMENT       22640020
         LA    R2,AVTDSIOB              DISK I/O QUEUE ADDRESS          22650020
         LA    R9,PRIDKSRV              PRIORITY                        22660020
         BAL   R14,POSTSUB              INSERT IN LIST                  22670020
*                                                                       22680020
BDCLUP   EQU   *                                                        22690020
         CLI   LCBFLAG1,PLCB            IS THIS A PLCB         @YM06129 22690100
         BNE   NORESP                   NO                     @YM06129 22690200
         TM    LCBSTAT5,LCBLUNIT        IS THIS AN LU?         @Y17XAMG 22690500
         BZ    NORESP                   BRANCH IF NOT          @Y17XAMG 22691000
         TM    LCBSTAT2,LCBRESP         DEFAULT RESPONSE       @Y17XAMG 22691500
*                                       REQUIRED?              @Y17XAMG 22692000
         BO    RESPOND                  BRANCH IF SO           @Y17XAMG 22692500
         TM    LCBCANFG,LCBCANXT        CANCEL RESP REQUIRED?  @Y17XAMG 22693000
         BZ    NORESP                   BRANCH IF NOT          @Y17XAMG 22693500
RESPOND  EQU   *                                               @Y17XAMG 22694000
         SLR   R0,R0                    INDICATE IEDQBD ENTRY  @Y17XAMG 22694500
*                                       TO RESPONSE FUNCTION   @Y17XAMG 22695000
         SLR   R9,R9                    INDICATE NON-MACRO CALL@Y17XAMG 22695500
         L     R12,AVTSAVTP             SAVT ADDRESS           @Y17XAMG 22696000
         L     R12,SAVTQRS-IEDNSVTD(R12) IEDQRS ENTRY ADDRESS  @Y17XAMG 22696500
         BALR  R14,R12                  GENERATE DEFAULT OR    @Y17XAMG 22697000
*                                       CANCEL RESPONSE        @Y17XAMG 22697500
NORESP   EQU   *                                               @Y17XAMG 22698000
         OI    LCBSTAT1,LCBRCLLN        SET FLAG FOR CLEANUP TO         22700020
*                                       INDICATE BUFFERS FRED           22800020
         LA    R2,IEDQBD02              ADDRESS OF CLEANUP SUBTASK      22900020
         LR    R5,RLCB                  SET TO POST LCB TO CLEANUP      23000020
         LA    R9,PRIDESTQ-1            PRIORITY FOR POST - MUST BE     23100020
*                                       LOWER THAN THAT USED TO POST    23200020
*                                       EOM SEGMENT TO DESTINATION      23300020
         TM    SCBQTYPE,SCBCONC         CONC                     S22026 23380022
         BNO   NOTCONC                  BRANCH IF NO             S22026 23460022
         L     R2,LCBQCBA-1             SET POST REG             S22026 23540022
         LA    R9,PRIRLCB               CONC POST PRI            S22026 23620022
NOTCONC  EQU   *                                                 S22026 23700022
         B     EXIT                     ADD TO POST LIST AND EXIT       23800020
         SPACE                                                          23850000
RECEIVE  EQU   *                        PROCESS RECEIVE EOM    @YM07396 24000000
         LA    R9,PRIDESTQ              SET UP PRIORITY        @YM07396 24200000
         CLI   AVTDOUBL,PRIFSPCI-1      LCB/PLCB E7 POST       @YM07396 24250000
         BE    BUFRET                   BRANCH YES CLEAN UP BFR@YM07396 24251000
         SPACE                                                          24252000
         CLI   LCBFLAG1,PLCB            IS THIS PLCB           @YM07396 24254000
         BNE   NOTLUNIT                 BRANCH NO              @YM07396 24255000
         TM    LCBSTAT5,LCBLUNIT        IS THIS A SNA LU       @YM07396 24256000
         BZ    CKSSCP                   BRANCH NO              @YM07396 24257000
         TM    LCBSTAT2,LCBRESP         RSP ALREADY SENT       @YM07705 24257300
         BNO   CKSSCP                   BRANCH YES             @YM07705 24257600
         TM    LCBRSPFG,LCBRSRH         RSP ALREADY GENERATED  @YM07705 24258000
         BO    CKSSCP                   BRANCH YES             @YM07396 24259000
         LA    R10,PRF1LEN              LENGTH OF NEG. PREFIX  @YM07396 24260000
         LNR   R10,R10                  SET UP FOR ADD         @YM07396 24261000
         AR    R10,R5                   R5 NOW POINTS TO PREFIX@YM07396 24262000
         USING IEDPF1,R10                                      @YM07396 24263000
         MVC   LCBRHSV,PRF1RH           SAVE RH IN PLCB        @YM07396 24264000
         MVC   LCBTHSQ,PRF1SQID         SAVE TH SEQ. NO.       @YM07396 24265000
         TM    PRF1FLG1,PRFIEXPI        EXPEDITED RU           @YM07396 24266000
         BZ    CKSSCP                   BRANCH NO              @YM07396 24267000
         OI    LCBRSPFG,LCBEXPI         INDICATE EXPEDITED     @YM07396 24268000
         DROP  R10                                             @YM07396 24269000
CKSSCP   EQU   *                                               @YM07396 24270000
         TM    SCBDESTQ+2,1             DEST= SSCP             @YM07396 24271000
         BZ    NOTLUNIT                 BRANCH NO              @YM07396 24272000
         NI    SCBDESTQ+2,X'FE'         RESET SSCP INDICATOR   @YM07396 24273000
         LA    R9,PRISSBUF              SSCP PRIORITY          @YM07396 24274000
NOTLUNIT EQU   *                                               @YM07396 24275000
         L     R2,SCBDESTQ-1            DESTINATION QCB ADDR   @YM07702 24284000
         TM    PRFSTAT1-IEDQPRF(R5),PRFITCPN  LOGICAL END OF MSG X01004 24294005
         BZ    NOLOGEOM                 BRANCH IF NO             S21101 24296020
         SPACE 1                                                 S21101 24298020
*        THE FOLLOWING CODE CHECKS FOR A ZERO LENGTH BUFFER      S21101 24298420
* POSTED TO A QUEUE.    BUFFER ORIGINALLY HAD ONLY EOT AND WAS   S21101 24298820
* REMOVED BY LINEEND.  PRFSIZE REFLECTS IDLES+ PREFIX SIZE.      S21101 24299220
* IEDQAA TEST FOR THIS CONDITION AND CLEARS PRFSIZE.             S21101 24299620
         SR    R10,R10                  CLEAR WORK REGISTER      S21101 24299720
         CH    R10,PRFSIZE-IEDQPRF(R5)  NO DATA IN BUFFER        S21101 24299820
         BNE   NOLOGEOM                 BRANCH IF NO             S21101 24299920
         SPACE 1                                                 S21101 24333220
BUFRET   EQU   *                                                 S21101 24343220
         LA    R2,AVTBFRTB              POST BUFFER TO BUFF RETRNS21101 24353220
NOLOGEOM EQU   *                                                 S21101 24363220
         BAL   R14,POSTSUB              ADD TO POST LIST                24366720
*                                                                       24400020
         LA    R10,LCBERB               ERB ADDRESS                     24500020
         TM    LCBERBST,LCBDLNKN        IS DLINK SWITCH SET             24600020
         BO    CKHDR                    BRANCH NOT IN CHAIN             24700020
*                                                                       24800020
         LA    R9,AVTBFRTB-4            BUFFER RETURN QCB               24900020
*                                                                       25000020
NEXT     EQU   *                                                        25100020
         LR    R12,R9                   SET TO PICK UP NEXT ELEMENT     25200020
         L     R9,4(0,R12)              FIRST/NEXT ELEMENT IN CHAIN     25300020
         LA    R9,0(0,R9)               CLEAR HIGH ORDER                25400020
         CLR   R9,R10                   IS THIS ELEMENT THE ERB         25500020
         BNE   NEXT                     BRANCH NO                       25600020
*                                                                       25700020
         MVC   5(3,R12),5(R9)           REMOVE ERB FROM CHAIN           25800020
         OI    LCBERBST,LCBDLNKN        TURN ON DELINK SWITCH    S22025 25850022
CKHDR    EQU   *                                                        25900020
         LA    R10,BDCLUP               ASSUME MIDDLE OF MSG     S21101 25950020
         CLI   AVTDOUBL,PRIFSPCI-1      CLEANUP OPERATION ONLY   S21101 25960020
         BE    BUFPST                   BRANCH YES               S21101 25970020
         TM    PRFSTAT1-IEDQPRF(R5),PRFITCPN  LOGICAL END OF MSG X01004 25980005
         BZ    EOM                      BRANCH IF NO             S21101 25990020
         SPACE 1                                                 S21101 25992020
         NI    PRFSTAT1-IEDQPRF(R5),X'FF'-PRFITCPN RESET LOG EOM X01004 25994005
         B     BUFPST                   POST OTHER BUFFERS       S21101 25996021
EOM      EQU   *                                                 S21101 25996521
         NI    SCBQTYPE,X'FF'-SCBBFMM   SET TO REAL EOM          S21101 25998521
         LNR   RQCB,RQCB                PREVENT RECALL UNTILL POST      26300020
*                                                                       26400020
REMBUF   EQU   *                                                        26800020
         LA    R10,FNDMAC               SET RETURN ADDRESS              26900020
*                                                                       27000020
BUFPST   EQU   *                                                        27100020
         LR    R5,RPREFIX               SAVE @ OF FIRST UNIT            27200020
FREEBFR  EQU   *                                                        27300020
         SR    R9,R9                    CLEAR FOR BCT                   27400020
BYPUNT   EQU   *                                                        27500020
         C     R9,MAXFREE               COUNT REG = MAXIMUM             27600020
         BE    CKEND                    BRANCH YES                      27700020
*                                                                       27800020
         EX    RPREFIX,BBTM             END OF BUFFER CHAIN             27900020
         BNZ   CKEND                    BRANCH YES                      28000020
*                                                                       28100020
         L     RPREFIX,PRFTIC           NEXT BUFFER/UNIT                28200020
         BCT   R9,BYPUNT                COUNT UNITS                     28300020
*                                                                       28400020
CKEND    EQU   *                                                        28500020
         LPR   R9,R9                    MAKE COUNT POSITIVE             28600020
         BCR   8,R10                    EXIT IF ZERO UNITS              28700020
*                                                                       28800020
         STC   R9,PRFNBUNT-IEDQPRF(R5)  NUMBER OF UNITS TO BE FREED     28900020
         LA    R2,AVTBFRTB              ADDRESS OF BUFFER RETURN QCB    29000020
         LA    R9,PRIBFRTB              PRIORITY OF RETURNED BUFFER>    29100020
         BAL   R14,POSTSUB              ADD BUFFER TO POST LIST         29200020
         LR    R5,RPREFIX              SET NEXT BUFFER ADDRESS          29300020
         CLI   PRFNBUNT-IEDQPRF(R1),XFF  LAST BUFFER HAVE 255 UNITS     29400020
         BE    FREEBFR                  BRANCH YES - CONTINUE           29500020
*                                                                       29600020
         BR    R10                      RETURN TO CALLER                29700020
*                                                                       29800020
         EJECT                                                          29900020
         DS    0F                                                       30000020
         ORG   *-8                      SET UP FOR QCB           S21903 30100022
         USING *,RQCB                                                   30200020
IEDQBD02 EQU   *                                                        30300020
         ORG                                                            30400020
         DC    AL1(DSPMCPL4)            SUBTASK ENTRY CODE (VTO)        30500020
         DC    AL3(*-1)                 STCB ADDRESS                    30600020
         L     R15,BASE                 SET ADDRESSABILITY FOR CSECT    30700020
         DROP  RQCB                                                     30800020
BD02BR   EQU   *                        BR ENTRY TO BD02         X03039 31000007
         SR    R0,R0                    CLEAR FOR ZEROING FIELDS        31200020
         LA    R9,X01                   PREVENT 0 REG FOR LOCK TEST     31300020
         LR    RLCB,R1                  ELEMENT IS AN LCB               31400020
         USING IEDQLCB,RLCB                                             31500020
         L     RSCB,LCBSCBA-1           SCB ADDRESS            @YM07350 31600000
         USING IEDQSCB,RSCB                                             31700020
         CLI   LCBFLAG1,PLCB            IS THIS A PLCB         @YM06129 31701000
         BNE   NOTLU                    NO                     @YM06129 31702000
         TM    LCBSTAT5,LCBLUNIT        LU?                    @Y17XAMG 31703000
         BZ    NOTLU                    BRANCH IF NOT          @Y17XAMG 31706000
         XC    LCBRHSV(LCBRSPFG-LCBRHSV+1),LCBRHSV CLEAR RSP   @Y17XAMG 31709000
*                                       AREA IN PLCB           @Y17XAMG 31712000
NOTLU    EQU   *                                               @Y17XAMG 31715000
         TM    LCBCHAIN,LCBERMSG        ERP MSG WAITING        @YM04622 31720000
         BZ    NOPAWR                   BRANCH NO              @YM04622 31730000
         ICM   R12,AD,AVTNX+X01         ADDRESS OF OPERATOR    @YM04622 31740000
*                                       AWARENESS ROUTINE      @YM04622 31750000
         BCR   7,R12                    BRANCH YES - EXIT TO IEDQNX     31760020
*                                                                       31780020
NOPAWR   EQU   *                                                 A51786 31790022
         SR    R1,R1                    END OF POST LIST        SA67078 31795054
         TM    SCBQTYPE,SCBBBFTM+SCBBFMM  MIDDLE OF MESSAGE ?           31800020
         BO    TSTFRE                   YES, NO MULTIPLE ROUTE  SA67078 31900054
         TM    LCBSTAT1,LCBRECVN        IS LCB RECEIVING        SA67078 31970054
         BO    CKMLT                    YES, CHECK MULTI-ROUTE  SA67078 32040054
         ST    R1,SCBMRFSD              CLEAR MULTI-ROUTE FIELD SA67078 32110054
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN   IF MESSAGE LOCK     SA66605 32130055
         BNO   TSTFRE                        TURN OFF LOCK      SA66605 32150055
         NI    SCBSTATE,X'FF'-(SCBLCK1N+SCBMSGLN)  AFTER SEND   SA66605 32170055
         B     TSTFRE                   CHECK IF BUFFERS FREED          32200020
*                                                                       32300020
CKMLT    EQU   *                                                        32400020
*                                        AND DLIST FLAGS                32460054
         L     R1,SCBMRFSD              MULTIPLE ROUTE AND DLIST        32500020
*                                       INDICATOR                       32600020
         LTR   R2,R1                    IS MULTIPLE ROUTING SET         32700020
         BNZ   BBMLT                      BRANCH YES                    32800020
TSTFRE   EQU   *                                                        32900020
         TM    LCBSTAT1,LCBRCLLN        HAVE BUFFERS BEEN FREED YET     33000020
         BO    BBNOFRE                    BRANCH YES                    33100020
*                                                                       33200020
         L     RPREFIX,LCBLSPCI-1       FIRST BUFFER TO BE FREED        33300020
         BAL   R10,BUFPST               FREE UNUSED BUFFERS             33400020
*                                                                       33500020
BBNOFRE  EQU   *                                                        33600020
         TM    SCBQTYPE,SCBBBFTM+SCBBFMM  MIDDLE OF MESSAGE FOR A       33700020
*                                       BUFFERRED TERMINAL              33800020
         BO    BFMDL                    BRANCH YES                      33900020
*                                                                       34000020
         TM    SCBSTATE,SCBCKPT         CHECKPOINT REQUESTED            34100020
         BNZ   BBCKPT                   BRANCH YES                      34200020
*                                                                       34300020
         ST    R0,SCBERRST              CLEAR ERROR WORD                34400020
         MVI   LCBSENS0,AVTEZERO        RESET 5TH ERROR BYTE-IOS        35200020
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @YM09045 35260000
         BE    PUTLCB                   BR YES                 @YM09045 35320000
         CLI   LCBRSKEY,APLCB           APP PROG PUT LCB?        S99228 35400022
         BE    PUTLCB                   BYPASS GEN POLL        @YM04622 35500000
         SR    R5,R5                    CLEAR INDEX REGISTER     S99228 36070022
         L     R2,LCBDCBPT              LOAD DCB ADDR            S99228 36140022
         IC    R5,DCBEIOBX-IHADCB(R0,R2)   INSERT LCB LENGTH     S99228 36210022
         SH    R5,AVTHA4                REDUCE LENGTH BY 8       S99228 36280022
         SH    R5,AVTHA4                BYTES TO POINT TO LCB EXTS99228 36350022
         LA    R5,X00(R5,RLCB)          SET ADDR LCB EXTENSION   S99228 36420022
         USING IEDQLCBX,R5                                       S99228 36490022
         TM    LCBSTAT1,LCBSENDN        SENDING                 SA59976 36492022
         BO    NOMSGLMT                 YES, NOTEST FOR MSGLMT  SA59976 36494022
         L     R10,LCBSTCBA-1           FIRST STCB IN CHAIN     SA59976 36496022
         CLI   0(R10),DSPMCPL8          THIS LMD STCB           SA59976 36498022
         BE    NOMSGLMT                 YES, NOMSGLINIT         SA59976 36500022
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN LOCK MODE OR EXTENDED         36500600
*                                       LOCK MODE              @OS78326 36500800
         BM    NOMSGLMT                 BRANCH, IF LOCK EXTEND @OS78326 36501200
         TM    SCBBSCFM,SCBMLMTN        MSGLIMIT REACHED        SA59976 36502022
         BNO   NOMSGLMT                 BR NO                   SA59976 36504022
         NI    SCBBSCFM,SCBMLMTF        RESET MSGLMT FLAG       SA59976 36506022
         TM    LCBXFLAG,LCBGPCTV        GEN.POLL IN PROGRESS    SA59976 36508022
         BO    NOMSGLMT                 YES, NO INVL CHANGE     SA59976 36510022
         TM    LCBDCT1,C3270            3270 TERMINAL?         @OS76699 36510191
         BNO   NOT3270R                 BRANCH NO              @OS76699 36510291
         TM    LCBDCT2,CLOCAL           IS IT A LOCAL?         @OS76699 36510391
         BO    NOT3270R                 BRANCH YES             @OS76699 36510491
         CLC   LCBINVPT,LCBERADR        WAS POLL FOR SOH MSG   @SA62375 36510609
         BNE   NOMSGLMT                 YES, DON'T UPDATE      @SA62375 36511209
NOT3270R EQU   *                                               @OS76699 36511691
         SR    R10,R10                  CLEAR                   SA59976 36512022
         IC    R10,LCBUCBX              REL. LINE NO.           SA59976 36514022
         SLL   R10,TWO                  SHIFT FOR OFFSET        SA59976 36516022
         L     R2,DCBINVLI-IHADCB(R10,R2) INVLIST PTR           SA59976 36518022
         SR    R10,R10                  CLEAR                   SA59976 36520022
         IC    R10,WIDTH(,R2)           WIDTH OF ENTRY          SA59976 36522022
         L     R2,LCBINVPT-1            CURRENT ENTRY PTR       SA59976 36524022
         CLI   0(R2),FE                 END OF LIST             SA59976 36526022
         BE    NOMSGLMT                 YES, NO UPDATE          SA59976 36528022
         CLI   ONE(R2),FE               END OF BSC LIST         SA59976 36530022
         BE    NOMSGLMT                 YES, NO UPDATE          SA59976 36532022
         LA    R10,0(R10,R2)            BUMP TO NEXT ENTRY      SA59976 36534022
         STCM  R10,7,LCBINVPT           SET NEW ENTRY          @YM04622 36540000
NOMSGLMT EQU   *                                                SA59976 36542022
*                                                                S99228 36560022
*        ASSUME GENERAL POLL IN PROGRESS                         S99228 36630022
*                                                                S99228 36700022
         NI    LCBXFLAG,LCBSRSTP        RESET SRC DETERM INDIC   S99228 36770022
PUTLCB   EQU   *                                                 S99228 36830022
         TM    SCBSTATE,SCBLCK1N        LOCK REQUESTED                  36900020
         BZ    NOTLOCK                  BRANCH NOT LOCK MODE            36920020
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @YM09045 36923000
         BE    PUTSLCB                  BR YES                 @YM09045 36926000
         CLI   LCBRSKEY,APLCB           APP PROG PUT LCB?        S99228 36929022
         BE    PUTSLCB                  BRANCH YES               S99228 36930022
*                                                                S99228 36932022
         NI    LCBXFLAG,LCBGPSTP        STOP GENERAL POLL        S99228 36936022
PUTSLCB  EQU   *                                                 S99228 36938022
*                                                                       36940020
         NI    LCBINSRC+2,X'FF'-X80     CLEAR POST FLAG                 36960020
         BZ    NOTLOCK                  BRANCH IF LCB CAN BE POSTED     36980020
*                                       RESPONSE HAS BEEN PUT           37000020
*                                                                       37020020
         LNR   R9,R9                    PREVENT LCB POST                37040020
NOTLOCK  EQU   *                                                        37100020
         DROP  R5                                                S99228 37150022
         MVI   SCBHBFNO,X00             CLEAR RECALL INDICATOR          37200020
         XC    SCBSCHDR(3),SCBSCHDR     CLEAR HDR PTR AS HM03   SA52971 37260022
*                                         FLAG                  SA52971 37320022
         NI    SCBSTATE,SCBLCK1N+SCBMSGLN  RESET SCBSTATE               37400020
         LA    R2,AVTBFRTB              BUFFER RETURN QUEUE             37620020
         STCM  R2,AD,SCBDESTQ           SET DESTINATION          X01004 37640005
         ST    R0,SCBDEOB               CLEAR DEOB                      37700020
         STH   R0,SCBEOB                CLEAR                           37800020
         MVI   SCBPRI,AVTEZERO          CLEAR PRIORITY BYTE     SA57687 37850022
         NI    SCBQTYPE,X0F             CLEAR QTYPE FLAGS               37900020
         NI    SCBBSCFM,AVTEFF-SCBTRNSP-SCBNONTR-SCBDATEN       SA61764 37950022
*                                       RESET BSC BITS          SA61764 37960022
BFMDL    EQU   *                                                        38000020
         NI    LCBTSOB,X'FF'-LCBTSBUF-LCBINHBN-LCBWRBRK-LCBPREP         38060000
*                                       SET TSO BITS OFF       @YA10449 38090000
LOGEOM   EQU   *                                                 S22025 38120022
         NI    LCBSTAT2,LCBMSGNF        RESET MSGEN BIT                 38200020
         NI    LCBCHAIN,X'FF'-LCBBFRSZ-LCBABRTN-LCBEXCP-LCBNORTY-LCBERMS38300022
               SG                         RESET CHAIN FLAGS      S22025 38400022
         ST    R0,LCBERBCH-1            CLEAR ERB STATE AND CHAIN       38600020
         OI    LCBERBST,LCBDLNKN        TURN ON DELINK SWITCH    S22025 38650022
         STCM  R0,AD,LCBLSPCI           CLEAR LAST SERVICED PCI  X01004 38700005
         STCM  R0,AD,LCBSTART           CLEAR LCBSTART WHICH   @YM07035 38720000
*                                       IS THE SAME FIELD AS   @YM07035 38740000
*                                       LCBPAKCH               @YM07035 38760000
         NI    LCBSTAT1,X'FF'-LCBRCLLN  RESET RECALL BIT                38800020
         NI    LCBCSW+3,AVTEFF-UNEX     RESET UNIT EXCEPTION     S22024 38860022
         LTR   R9,R9                    CAN LCB BE POSTED               38920020
         BNM   ADDLABL        BRANCH NO - LCB WILL BE POSTED   @Y17XAIX 38940000
*                                       WHEN PUT RESPONSE HAS BEEN      38960020
*                                       QUEUED                          38980020
         BAL   R14,DSPCHAIN                                    @Y17XAIX 38990000
ADDLABL  LA    R9,PRILNFRE       PRIORITY FOR FREEING A LINE   @Y17XAIX 39000000
         LR    R2,RLCB                  POST LCB                        39100020
         LR    R5,RLCB                    TO ITSELF                     39300020
*                                                                       39400020
EXIT     EQU   *                                                        39500020
         LA    R14,DSPCHAIN             ADDRESS OF DISPATCHER           39600020
*              FALL THRU TO ADD ELEMENT TO POST LIST                    39700020
*              AND EXIT TO THE DISPATCHER                               39800020
         SPACE 2                                                        39900020
POSTSUB  EQU   *                                                        40000020
         ST    R2,0(R5)                 QCB ADDRESS TO RECB             40100020
         ST    R1,4(R5)                 LINK ELEMENTS                   40200020
         STC   R9,4(R5)                 STORE PRIORITY                  40300020
         LR    R1,R5                    NEW LAST ELEMENT                40400020
         BALR  R14,R14                  RETURN TO CALLER       @Y17XAIX 40500000
*                                                                       40600020
BBCKPT   EQU   *                                                        40700020
         LA    R5,LCBERB                POST ERB TO CHECKPOINT          40750020
         LA    R9,PRICKPLN              PRIORITY                        40800020
         LA    R2,AVTCKPTB              CHECKPOINT QCB                  40900020
         B     EXIT                     CHAIN ELEMENTS                  41000020
*                                                                       41100020
BBMLT    EQU   *                                                        41200020
         SRA   R2,X16                   IS MULTIPLE ROUTING REQUESTED   41300020
         BZ    BBDLST                   BRANCH IF ONLY A DLIST          41400020
         L     R8,SCBMRFPL-1            FORWARD PARAMETER LIST          41500020
         IC    R9,3(R8)                 OFFSET TO MULTIPLE ROUTE        41600020
         L     R2,AVTMSGS-1             ADDRESS OF VCON LIST            41700020
         L     R2,X00(R2,R9)            ADDRESS OF MULTI-ROUTE QCB      41800020
         ST    R2,SCBBKFCT-1            SET TO RETURN TO MULTIPLE       41900020
*                                       ROUTE SUBTASK                   42000020
BBDLST   EQU   *                                                        42100020
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF WORD      42200020
         BZ    BBRCALL                  RECALL BUFFER                   42300020
*                                       WHICH WILL BE PASSED TO         42400020
*                                       MULTIPLE ROUTE SUBTASK          42500020
         L     R15,AVTRNMPT             ADDRESS OF TNT CODE             42600020
         BALR  R14,R15                  LINK TO TNT                     42700020
*                                                                       42800020
         USING *,R14                                                    42900020
         L     R15,BASE                 RESET ADDRESSABILITY            43000020
         DROP  R14                                                      43100020
         ST    R1,LCBLINK-1             ENTRY ADDRESS                   43200020
         LA    R9,2                     SET DLPTR TO PICK UP            43300020
         STH   R9,SCBDLPTR                SECOND ENTRY IN LIST          43400020
         L     R2,TRMDESTQ-IEDQTRM-1(R1)  ADDRESS OF IEDQBC             43500020
         SR    R1,R1                    INDICATE END OF POST LIST       43600020
BBRCALL  EQU   *                                                        43700020
          MVC   LCBCPA+4(3),SCBTRANS     SAVE SCB TRANS ADDR     S22025 43720022
*                                        ACROSS RECALL RESTORED  S22025 43740022
*                                       IN IEDQAS                S22025 43760022
         BAL   R9,SVQTYP                SAVE Q TYPE                     43800020
*                                                                       43900020
         MVI   SCBPRI,X00               CLEAR PRIOITY QCB POINTER       43950020
         STCM  R2,AD,LCBRCQCB+1         SET RETURN FOR RECALL    X01004 44000005
         MVC   LCBCPA(4),SCBDEOB        SAVE DEOB ACROSS RECALL  S22025 44130022
*                                       FOR HOLD WITH MIDBATCH   S22025 44160022
         OI    LCBCHAIN,LCBBFRSZ        RECALL ORIGINAL BUFFER SIZE     44300020
         SR    R2,R2                                             X01004 44400005
         ICM   R2,AD,SCBCCHDR           ASSUME CORE RECALL       X01004 44450005
         TM    SCBHBFNO,SCBNREUS+SCBREUS  IS THERE DISK BACKUP          44500020
         BZ    CORE                     BRANCH NO - USE CORE ADDRESS    44600020
*                                                                       44700020
         ICM   R2,AD,SCBTRANS           ORIG RECALLED HDR ADDR   X01004 44800005
         BNZ   OKCORE                   BRANCH IF NOT 1ST RECALL X02004 45200005
*                                                                       45300020
         ICM   R2,AD,SCBDCHDR           CURRENT RECORD ADDRESS   X01004 45400005
CORE     EQU   *                                                        45500020
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING                 45600020
         BZ    OKCORE                   BRANCH NO                       45700020
*                                                                       45800020
         ICM   R2,AD,SCBSCHDR           SEND SIDE RE"ALL ADDRESS X01004 45900005
OKCORE   EQU   *                                                        46000020
         ST    R2,SCBDEOB               SET RECALL ADDRESS              46100020
         SR    R2,R2                                             X01004 46200005
         STCM  R2,AD,SCBXTRA            CLEAR FOR FA             X01004 46300005
         STCM  R2,AD,SCBNTXT            CLEAR FOR FA             X01004 46400005
         NI    SCBQTYPE,X0F             CLEAR QTYPE FOR EACH RECALL     46500020
         OI    LCBSTAT1,LCBRCLLN        SET LCB TO RECALL STATE         46600020
         MVI   LCBERBST,X00             CLEAR ERB STATUS                46700020
         LA    R0,D256                  RECALL 1 BUFFER                 46800020
         STH   R0,LCBERBCT              SET ERB COUNT = 1               46900020
         STCM  R2,AD,LCBERBCH           CLEAR FOR RECALL         X01004 47000005
         LA    R2,AVTDSIOB              DISK I/O QCB                    47100020
         LA    R5,LCBERB                ELEMENT TO BE POSTED            47200020
         LA    R9,PRIRECAL              RECALLED BUFFER PRIORITY        47300020
         B     EXIT                     ADD TO POST LIST AND EXIT       47400020
*                                                                       47500020
SVQTYP   EQU   *                                                        47600020
         TM    SCBHBFNO,XF0             HAS QTYPE BEEN SAVED            47700020
         BCR   7,R9                     RETURN                          47800020
*                                                                       47900020
         XC    SCBTRANS,SCBTRANS        CLEAR FOR FA                    48000020
         MVI   SCBHBFNO,X00             CLEAR RESIDUAL COUTER           48100020
         MVZ   SCBHBFNO(1),SCBQTYPE     SET UP FOR POSSIBLE RECALL      48200020
         NI    SCBQTYPE,X0F             CLEAR HIGH ORDER HALH           48300020
         BR    R9                       RETURN                          48400020
         EJECT                                                          48500020
BBTM     TM    BBTHREE,0                EXECUTED TM                     48600020
BASE     DC    A(IEDQBD01)              FOR CSECT ADDRESSABILITY        48700020
CLEARL2  DC    X'00FFFFFC'              MASK FOR 'ANDING'        S22025 48800022
MAXFREE  DC    F'-255'                  MAXIMUM UNIT COUNT       S22025 48900022
*                                                              @X50X9IL 48907009
*              THE FOLLOWING FIELD IS A MASK USED TO CHECK THE @X50X9IL 48914009
*              MESSAGE ERROR RECORD FOR THE PRESENCE OF ANY OF @X50X9IL 48921009
*              THE SNA MAJOR SENSE BITS                        @X50X9IL 48928009
*                   BIT 13 - REQUEST REJECT                    @X50X9IL 48935009
*                   BIT 21 - FUNCTION INTERPRETER ERROR        @X50X9IL 48942009
*                   BIT 23 - PATH ERROR                        @X50X9IL 48949009
*                   BIT 29 - CPM ERROR                         @X50X9IL 48956009
*                   BIT 30 - STATE ERROR                       @X50X9IL 48963009
         DS    0F                                              @X50X9IL 48970009
SNAMAJOR DC    X'00040506'                                     @X50X9IL 48977009
*                                                              @X50X9IL 48984009
ERBLCB   DC    AL2(LCBERB-IEDQLCB)      OFFSET OF ERB IN THE LCB S22025 49000022
BBTHREE  DC    AL1(3)                   INITIALIZE TO 3 FOR TM   S22025 49100022
ONE      EQU   1                        CONSTANT EQUATE         SA59976 49120022
TWO      EQU   2                        TWO                      S22024 49150022
X00      EQU   0                        ZERO                     S22024 49230022
AD       EQU   7                        MASK FOR ICM AND STCM    X01004 49270005
X01      EQU   X'01'                    HEX 01                   S22024 49310022
X02      EQU   X'02'                    HEX 02                   S22024 49390022
SNS      EQU   X'04'                    HEX 04                   S22024 49470022
X08      EQU   X'08'                    HEX 08                   S22024 49550022
X0F      EQU   X'0F'                    HEX 0F                   S22024 49630022
XFF      EQU   X'FF'                    HEX FF                   S22024 49710022
SKPFL    EQU   X'10'                    HEX 10                   S22024 49790022
X16      EQU   16                       SIXTEEN                  S22024 49870022
X80      EQU   X'80'                    HEX 80                   S22024 49950022
D256     EQU   256                      TWO56                    S22024 50030022
XF0      EQU   X'F0'                    HEX F0                   S22024 50110022
UNEX     EQU   X'01'                    UNIT EXCEPTION           S22024 50190022
PLCB     EQU   X'00'                    3705 PLCB                S22024 50305022
APLCB    EQU   X'12'                    APP PROG PUT LCB         S99228 50310022
WIDTH    EQU   2                        OFFSET IN INVITATION    SA59976 50314022
*                                        LIST CONTROL WORD TO   SA59976 50318022
*                                        WIDTH OF EACH ENTRY    SA59976 50322022
FE       EQU   X'FE'                    END OF LIST INDICATOR   SA59976 50326022
C3270    EQU   X'04'                    3270 TERMINAL          @OS76699 50326191
CLOCAL   EQU   X'02'                    LOCAL TERMINAL         @OS76699 50326291
         SPACE 2                                               @X50X9IL 50326509
MASKD    DSECT                          DSECT FOR ERROR MASK   @X50X9IL 50327009
         DS    CL3                      PARAMETER LIST FIELDS  @X50X9IL 50327509
MASK     DS    0CL5                     ERROR MASK             @X50X9IL 50328009
MASK4    DS    CL4                      1ST 4 BYTES OF MASK    @X50X9IL 50328509
MASKLAST DS    CL1                      LAST BYTE OF MASK      @X50X9IL 50329009
         EJECT                                                          50329509
         SPACE 2                                                        50330022
         DCBD  DSORG=TX                                          S99228 50360022
         TTRMD                                                          50400020
         TPRIOR                                                         50500020
         TQCBD                                                          50600020
         TPRFD                                                          50700020
         TLCBD                                                          50800020
         TSCBD                                                          50900020
         TDISPD                                                         51000020
         TAVTD                                                          51100020
         END                                                            51200020
