BE01     TITLE '''IEDQBE'' - LOCK ROUTINE'                              00900020
IEDQBE   CSECT                                                          01800020
*C603000-625000                                                  S22026 01900022
*C297000,315000,634000,643000,693000,720000,743000,799000,812300 S22025 02100022
*C822300-826300                                                  S22025 02300022
*A594000                                                         S22025 02500022
*C611000                                                        SA57681 02600021
*A804720-804760,805950                                           S22024 02600122
*A799100,9000000                                               @SA71652 02600256
*A510000,806700                                                @OX12487 02600310
*A808100,840300                                                @OX13486 02630310
*C798980                                                       @OY13294 02660310
*A808200                                                       @OZ11170 02670310
*********************************************************************** 02700020
*TITLE -- 'IEDQBE' LOCK TERMINAL ROUTINE                              * 03600020
*                                                                     * 04500020
*                                                                     * 05400020
*STATUS -- CHANGE LEVEL 5                                        S22024 06300022
*                                                                     * 07200020
*FUNCTION -- THIS ROUTINE LOCKS THE CURRENTLY CONNECTED TERMINAL TO   * 08100020
*   THE DESTINATION IF THE DESTINATION IS A PROCESS ENTRY. EXTENDED   * 09000020
*   LOCK IS SET IF REQUESTED BY THE LOCK MACRO.                       * 09900020
*                                                                     * 10800020
*ENTRY POINT -- IEDQBE                                                * 11700020
*                                                                     * 12600020
*   CALLING SEQUENCE -                                                * 13500020
*                  L     R12,AVTMSGS-1                                * 14400020
*                  IC    RX,INDEX                                     * 15300020
*                  L     R12,0(RX,R12)                                * 16200020
*                  BR    R12                                          * 17100020
*                                                                     * 18000020
*INPUT -- ENTRY IS ALWAYS FROM 'IEDQUI' USER INITERFACE ROUTINE       * 18900020
*         PARAMETERS ARE PASSED IMPLICITLY IN REGISTERS AS FOLLOWS:   * 19800020
*                  R1    PARAMETER LIST GENERATED BY LOCK MACRO       * 20700020
*                  R3    ADDRESS OF STATION CONTROL BLOCK (SCB)       * 21600020
*                  R4    ADDRESS OF LINE CONTROL BLOCK (LCB)          * 22500020
*                  R9    AVT ADDRESS                                  * 23400020
*                  R12   BASE FOR THIS ROUTINE                        * 24300020
*                                                                     * 25200020
*OUTPUT -- THE LOCK BIT(S) IN THE SCB IS(ARE) SET.                    * 26100020
*                                                                     * 27000020
*EXTERNAL ROUTINES -- NONE                                            * 27900020
*                                                                     * 28800020
*EXITS-NORMAL -- 'IEDQUI+4' WITH R15 = 0                         S22025 29700022
*                                                                     * 30600020
*EXITS-ERROR -- 'IEDQUI+4' WITH R15 = 4 OR 8                     S22025 31500022
*                                                                     * 32400020
*TABLES/WORKAREAS --                                                  * 33300020
*DSECTS USED -- AVT,LCB,QCB,SCB                                       * 34200020
*                                                                     * 35100020
*ATTRIBUTES -- REENTRANT, REFRESHABLE, ENABLED, RESIDENT, PROBLEM     * 36000020
*              PROGRAM MODE.                                          * 36900020
*                                                                     * 37800020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 38700020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET  * 39600020
*                                                                     * 40500020
*********************************************************************** 41400020
*                                                                       42300020
*        REGISTERS                                                      43200020
*                                                                       44100020
R1       EQU   1                        ENTRY PARAMETER LIST            45000020
R2       EQU   2                        WORK REGISTER                   45900020
RSCB     EQU   3                        SCB ADDRESS                     46800020
RLCB     EQU   4                        LCB ADDRESS                     47700020
R5       EQU   5                        WORK REGISTER                   48600020
RPREFIX  EQU   6                        REG6                     S22024 49500022
R8       EQU   8                        ENTRY PARAMETER LIST            49900020
R9       EQU   9                        AVT ADDRESS                     50400020
R10      EQU   10                       WORK REGISTER                   50800020
R12      EQU   12                       BASE REGISTER                   51000020
R13      EQU   13                       SAVE AREA              @OX12487 51100010
R14      EQU   14                       RETURN ADDRESS                  51300020
R15      EQU   15                       RETURN CODE                     52200020
FOUR     EQU   4                        RETURN OFFSET            S22025 52600022
         EJECT                                                          53100020
         USING IEDQAVTD,R9                                              54000020
         USING IEDQPRF,RPREFIX                                          54900020
         USING IEDQSCB,RSCB                                             55800020
         USING IEDQLCB,RLCB                                             56700020
         USING *,R12                                                    57100020
         SPACE 3                                                        57600020
         LA    R15,AVTECD4              SET FOR BAD RETURN              58500020
IEDQBE  IEDHJN IEDQBE01                                                 59400022
         LR    R2,R1                    SAVE REG                 S22026 60300022
         LH    R1,LCBTTCIN              GET SOURCE TERM INDEX    S22026 60500022
         N     R1,AVTCLRHI              CLEAR HI-ORDER BYTES     S22026 60700022
         LTR   R1,R1                    SOURCE FOUND             S22026 60900022
         BZ    RETURN                   BRANCH IF NO            SA57681 61100021
         L     R15,AVTRNMPT             TNT CODE                 S22026 61300022
         BALR  R14,R15                  LINK TO IT               S22026 61500022
         LA    R15,AVTECD4              RESTORE REG              S22026 61700022
         TM    TRMDEVFL+1-IEDQTRM(R1),TRMCONC                    S22026 61900022
*                                       SOURCE A CONC            S22026 62100022
         BO    RETURN                   BRANCH IF YES            S22026 62300022
         LR    R1,R2                    RESTORE REG              S22026 62500022
*                                                                       63000020
         CLI   LCBRSKEY,BFRD            IS SOURCE A BUFFERRED TERMI     63200020
         BZ    RETURN                   YES, RETURN TO CALLER    S22025 63400022
*                                                                       63600020
         AR    R15,R15                  SET RETURN CODE = 8             63900020
         OC    PRFSIZE,PRFSIZE          ZERO LENGTH BUFFER              64100020
         BZ    RETURN                   YES, RETURN TO CALLER    S22025 64300022
*                                                                       64500020
         L     R2,SCBDESTQ-1            DESTINATION QCB                 64800020
         USING IEDQQCB,R2                                               65700020
         LA    R2,X0(,R2)               CLEAR HIGH ORDER BYTE           66600020
         LA    R5,AVTBFRTB              ADDRESS OF BUFFER RETURN QCB    67500020
         CLR   R2,R5                    IS THAT THE DESTINATION         68400020
         BE    RETURN                   YES, RETURN TO CALLER    S22025 69300022
*                                                                       70200020
         TM    QCBFLAG,QCBPROC          IS QCB FOR A PROCESSING PGM     71100020
         BZ    RETURN                   YES, RETURN TO CALLER    S22025 72000022
*                                                                       72900020
         LA    R15,AVTECD12             SET BAD RETURN                  74180020
        TM    SCBSTATE,SCBLCK1N+SCBMSGLN  ALREADY LOCKED                74200020
         BNZ   RETURN                   YES, RETURN TO CALLER    S22025 74300022
*                                                                       74400020
         L     R15,AVTRNMPT             TNT ROUTINE ADDRESS             75400020
         LH    R2,PRFDEST               ASSUME HEADER BUFFER            76400020
         LR    R8,R1                    SAVE ADDRESS OF PARAMETER       77400020
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER         79240020
         BZ    NOSRCH                   HEADER - NO SEARCH NECESSARY    79290020
*                                                                       79340020
         SR    R2,R2                    CLEAR TO SCAN TERMINAL TABLE    79400020
SEARCH   EQU   *                                                        79460020
         LA    R2,X1(,R2)               FIRST/NEXT TNT OFFSET           79520020
NOSRCH   EQU   *                                                        79540020
         LR    R1,R2                    PASS PARAMETER TO TNT           79560020
         BALR  R14,R15                  EXECUTE TNT TO FIND TERMINAL    79600020
*                                       ENTRY + QCB                     79640020
*                                                                       79680020
         CLC   SCBDESTQ,X1(R1)          IS THIS THE ENTRY               79720020
         BNE   SEARCH                   NOT EQUAL - CONTINUE            79760020
*                                                                       79800020
         USING IEDQTRM,R1                                               79886020
         LA    R15,8                    SET UP RETURN CODE              79892020
         OC    TRMSTAT+1(2),TRMSTAT+1   IS PROCESS Q OPEN      @OY13294 79898010
         BZ    RETURN                   YES, RETURN TO CALLER    S22025 79904022
*                                                                       79910020
         L     R5,TRMSTAT               GET PEWA ADDRESS       @SA71652 79912056
         TM    PEWAFLG-IEDQPEWA(R5),PEWASTOP PROCESS ENTRY     @SA71652 79914056
*                                         DISABLED             @SA71652 79916056
         BO    RETURN                   BR YES, SKIP LOCK      @SA71652 79918056
         STC   R2,LCBINSRC+1            LOW ORDER BYTE OF OFFSET        79920020
         SRL   R2,8                     SHIFT OVER ONE BYTE             79960020
         STC   R2,LCBINSRC              SET HIGH ORDER BYTE             80000020
         OI    SCBSTATE,SCBLCK1N+SCBMSGLN   SET MESSAGE LOCK            80020020
         OI    PRFSTAT1,PRFLOCK         SET LOCK BIT IN BUFFER          80030020
         MVI   LCBINSRC+2,XD0           SET POST PENDING FLAGS          80430020
         L     R2,LCBDCBPT              DCB ADDRESS                     80440020
         USING IHADCB,R2                                                80450020
         LA    RLCB,LCBFLAG1            BUMP TO IOB ADDRESS             80460020
         USING LCBFLAG1,RLCB                                            80470020
         TM    DCBDSORG,AVTE80          IS THIS AN LGB           S22024 80472022
         LA    R5,X1                    INDICATE RLN ONE         S22024 80474022
         BO    TRMQ3705                 IF SO, TAKE OFF          S22024 80476022
         SR    R1,R1                    CLEAR FOR IC                    80480020
         LR    R5,R1                    CLEAR FOR COUNTER               80490020
         IC    R1,DCBEIOBX              SIZE OF AN LCB                  80500020
         L     R10,DCBIOBAD             ADDRESS OF 1ST IOB-LCB SIZE     80510020
LCBLOOP  EQU   *                                                        80520020
         BCTR  R5,0                     BUMP COUNTER BY ONR             80530020
         LA    R10,0(R1,R10)            POINT TO FIRST/NEXT IOB +       80540020
*                                       CLEAR HIGH ORDER BYTE           80550020
         CLR   R10,RLCB                 IS THIS THE SOURCE LCB          80560020
         BNE   LCBLOOP                  BRANCH NO - CONTINUE SEARCH     80570020
*                                                                       80580020
         LPR   R5,R5                    MAKE COUNT POSITIVE             80590020
TRMQ3705 EQU   *                                                 S22024 80595022
         LH    R1,LCBTTCIN              SOURCE TERMINAL INDEX           80600020
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF           80610020
         L     R15,AVTRNMPT             TERMINAL NAME TABLE             80620020
         BALR  R14,R15                  LINK TO TNT                     80630020
*                                                                       80640020
         SR    R15,R15                  SET GOOD RETURN                 80650020
         L     R1,TRMDESTQ-1            ADDRESS OF SOURCE QCB           80660020
         STC   R5,QCBLKRLN-IEDQQCB(R1)  SET LOCK RELATIVE LINE #        80670020
         USING IEDQQCB,R1                                      @OX12487 80690010
         TM    QCBTSOF1,QCBDELAY        QCB IN TIME DELAY QUEUE@OX12487 80700010
         BNO   NOTIMEQ                  BRANCH IF NO           @OX12487 80710010
         LR    R5,R13                   SAVE REGISTER 13       @OX12487 80720010
         LA    R13,AVTSAVE3             GET SAVE AREA          @OX12487 80730010
         L     R15,AVTHG02              ADDRESS OF  TIME DELAY @OX12487 80770010
*                                        ROUTINE               @OX12487 80780010
         BALR  R14,R15                  REMOVE QCB             @OX12487 80790010
         LR    R13,R5                   RESTORE REGISTER 13    @OX12487 80810010
         MVC   QCBSLINK(THREE),QCBSTCHN  UPDATE STCB CHAIN     @OX13486 80811010
         LA    R5,QCBSTVTO              ADDRESS OF LINK FIELD  @OX13486 80812010
         IC    R14,QCBSTVTO             SET UP QCB             @OX13486 80813010
         ST    R5,QCBSTVTO              FOR SEND               @OX13486 80814010
         STC   R14,QCBSTVTO             OPERATION              @OX13486 80815010
NOTIMEQ  EQU   *                                               @OX12487 80820010
         XC    QCBLKRRN(THREE),QCBLKRRN CLEAR LINE NUMBER      @OZ11170 80850010
         TM    X1(R8),X1                EXTENDED LOCK REQUEST           80880020
         BNZ   RETURN                   YES, RETURN TO CALLER    S22025 81230022
*                                                                       81630020
         NI    SCBSTATE,SCBMSGLF        SET EXTENDED                    82030020
RETURN   EQU   *                                                 S22025 82230022
         L     R14,AVTUI                LOAD RETURN ROUTINE      S22025 82430022
         B     FOUR(R14)                BRANCH TO RETURN ROUT    S22025 82630022
         EJECT                                                          82830020
NONZ     EQU   7                        SEVEN                    S22024 83230022
EQUAL    EQU   8                        EIGHT                    S22024 83630022
ZERO     EQU   8                        EIGHT                    S22024 84030022
THREE    EQU   3                        CONSTANT               @OX13486 84230010
X0       EQU   0                        ZERO                     S22024 84430022
X1       EQU   1                        ONE                      S22024 84830022
XD0      EQU   X'D0'                    HEX D0                   S22024 85230022
BFRD     EQU   X'1A'                    BUFFERED TERMINAL SCHEDULER     86000020
         DCBD  DSORG=TX                                                 86050020
         TTRMD                                                          86100020
         TLCBD                                                          86400020
         TSCBD                                                          87300020
         TPRFD                                                          88200020
         TQCBD                                                          89100020
         TAVTD                                                          90000020
         TPEWAD                                                @SA71652 90400056
         END                                                            90900020
