BL01     TITLE '''IEDQBL01''  -  MSGGEN ROUTINE'                        00500020
IEDQBL   CSECT                                                          01000020
         SPACE 3                                                        01030022
*********************************************************************** 01500020
*                                                                     * 02500020
* MODULE NAME = IEDQBL (TCAM, MH)                              @Y17XAMS 02580000
*                                                                     * 02660000
* DESCRIPTIVE NAME = MESSAGE GENERATOR                                * 02740000
*                                                                     * 02820000
* COPYRIGHT = NONE                                                    * 02900000
*                                                                     * 03000020
* STATUS = VERSION 10.0                                        @Y17XAMS 03500000
*                                                                     * 04000020
* FUNCTION = ALLOW MESSAGE HANDLER TO SCHEDULE DELIVERY OF A   @Y17XAMS 04500000
* USER SPECIFIED MESSAGE TO THE SOURCE/DESTINATION TERMINAL IN @Y17XAMS 04530000
* AN IMMEDIATE FASHION, IE, WITHOUT BEING QUEUED.              @Y17XAMS 04560000
*                                                                     * 04590000
* NOTES = SEE BELOW                                            @Y17XAMS 04620000
*                                                                     * 04650000
*    DEPENDENCES = NONE                                        @Y17XAMS 04680000
*                                                                     * 04710000
*    RESTRICTIONS = NONE                                       @Y17XAMS 04740000
*                                                                     * 04770000
*    REGISTER CONVENTIONS = SEE REGISTER EQUATES               @Y17XAMS 04800000
*                                                                     * 04830000
*    PATCH LABEL = NONE                                        @Y17XAMS 04860000
*                                                                     * 04890000
* MODULE TYPE = PROCEDURE                                      @Y17XAMS 04920000
*                                                                     * 04950000
*    PROCESSOR = ASSEMBLER                                     @Y17XAMS 04980000
*                                                                     * 05010000
*    MODULE SIZE = 700 DECIMAL BYTES                           @Y17XAMS 05040000
*                                                                     * 05070000
*    ATTRIBUTES = REUSABLE, ENABLED, PROBLEM PROGRAM MODE      @Y17XAMS 05100000
*                                                                     * 05130000
* ENTRY POINT = 1. FIRST EXECUTABLE INSTRUCTION                @Y17XAMS 05160000
*               2. AT LABEL ERBENTRY                           @Y17XAMS 05190000
*                                                                     * 05220000
*    PURPOSE =  1. SEE FUNCTION                                @Y17XAMS 05250000
*               2. RETURN POST OF ERB AFTER ERB POST TO        @Y17XAMS 05280000
*                  REQUEST BUFFER                              @Y17XAMS 05310000
*                                                                       05340000
*    LINKAGE =  1. FROM IEDQBD                                 @Y17XAMS 05370000
*               2. FROM TCAM DISPATCHER                        @Y17XAMS 05400000
*                                                                X03039 11400007
* INPUT = FROM IEDQBD                                            X03039 11500000
*         R1    CHAIN OF ELEMENTS TO BE POSTED OR ZERO (0)            * 12500000
*         R3    ADDRESS OF STATION CONTROL BLOCK (SCB)                * 13000000
*         R4    ADDRESS OF LINE CONTROL BLOCK (LCB)                   * 13500000
*         R7    ADDRESS OF IEDQBD QCB                                 * 14000000
*         R8    ADDRESS OF MSGGEN PARAMETER LIST                      * 14500000
*         R11   BASE FOR TCAM DISPATCHER                              * 15000000
*         R12   BASE FOR THIS ROUTINE                                 * 15500000
*         R13   ADDRESS OF AVTSAVE2                                   * 16000000
*                                                                     * 16500020
*       = FROM TCAM DISPATCHER                                 @Y17XAMS 16550000
*         R1    ERB ADDRESS                                    @Y17XAMS 16600000
*         R3    STCB ADDRESS (GENSTCB)                         @Y17XAMS 16700000
*         R7    QCB ADDRESS (GENQCB)                           @Y17XAMS 16800000
*         R11   TCAM DISPATCHER BASE ADDRESS                   @Y17XAMS 17000000
*         R13   AVTSAVE2 ADDRESS                               @Y17XAMS 17300000
*                                                                     * 17500000
* OUTPUT = BUFFERS RETURNED TO BUFFER POOL                     @Y17XAMS 17600000
*          ERB POSTED TO IEDQBD                                @Y17XAMS 17700000
*          ERB POSTED TO IOGENER                               @Y17XAMS 18000000
*          ERB POSTED TO IEDNGD                                @Y17XAMS 18500000
*                                                                X03039 18920007
* EXITS - NORMAL = TCAM DISPATCHER AT DSPCHAIN                 @Y17XAMS 20000000
*                                                                     * 20500020
* EXITS-ERROR =  NONE                                                 * 21000000
*                                                                     * 21500020
* EXTERNAL REFERENCES = SEE BELOW                              @Y17XAMS 21580000
*                                                                     * 21660000
*    ROUTINES = IEDQTNT (TRM LOOKUP ROUTINE)                   @Y17XAMS 21740000
*               IEDQGA02 (BUFFER STEAL ROUTINE)                @Y17XAMS 21820000
*               IEDQAE (OPTION FIELD LOOKUP ROUTINE)           @Y17XAMS 21900000
*               IEDMVBFR (MOVE BUFFER ROUTINE)                 @Y17XAMS 22000000
*                                                                     * 22100000
*    DATA AREAS = MSGGEN PARAMETER LIST                        @Y17XAMS 22200000
*                 PRIORITY DSECT                               @Y17XAMS 22300000
*                 IEDMVBFR PARAMETER LIST (TPLMVD)             @Y17XAMS 22400000
*                                                                     * 22500000
* CONTROL BLOCKS = AVT                                         @Y17XAMS 22600000
*                  BFR                                         @Y17XAMS 22700000
*                  CCW                                         @Y17XAMS 22800000
*                  DCB                                         @Y17XAMS 22900000
*                  ERB                                         @Y17XAMS 23000000
*                  LCB                                         @Y17XAMS 23100000
*                  SCB                                         @Y17XAMS 23200000
*                  STCB                                        @Y17XAMS 23300000
*                  TRM                                         @Y17XAMS 23400000
*                                                                     * 23500020
* TABLES = DEVICE CHARACTERISTICS TABLE                        @Y17XAMS 24000000
*                                                                     * 25000020
* MACROS = IEDHJN                                              @Y17XAMS 25500000
*                                                                     * 26500020
* CHANGE ACTIVITY =                                            @Y17XAMI 26600000
*A-000000-999999                                               @X31X8M0 26604000
*A400000,407000,790200                                           S22025 26608000
*A510200-513200,514100,832000                                    S22026 26612000
*C793500,794000                                                  S21903 26616000
*A408800                                                        SA57322 26620000
*A556000-557000,700090-704770,764300-764800,781000-782000,       S22024 26624000
*A790210-790400                                                  S22024 26628000
*A702970                                                        OY03454 26632000
*A110000,165000,185000,385000,408890,700000,775000,790410,       X03039 26636000
*C035000,045000,055000,075000,115000,170000,190000,200000,230000,X03039 26640000
*C408500-408800,557000,700090,700180-704940,764320,764440,764500,X03039 26644000
*C764530                                                         X03039 26648000
*D050000,060000,065000,405000,781000,783000,790060,790100,       X03039 26652000
*D790202-790250,790290-790330,831000                             X03039 26656000
*A408707                                                       @XA07544 26660000
*A512400,790410                                                @SA72461 26664000
*A512400                                                       @SA72461 26668000
*C408606,408635,512520,702380                                  @Y17XAMG 26672000
*A055000,165000,215000,267000,330000,407900,408500,408990      @Y17XAMS 26676000
*A460000,512400,512480,512540,512580,616200,645000,700000      @Y17XAMS 26680000
*A790420                                                       @Y17XAMS 26700000
*C025800,035000,045000-055000,075000-077000,170000-189200      @Y17XAMS 26720000
*C200000,220000-230000,325000,408200,408527-408536,410000      @Y17XAMS 26740000
*C480000,500000,512000,512420,512480,512560,570000,616200      @Y17XAMS 26760000
*C655000-675000,764320                                         @Y17XAMS 26800000
*D020000,085000-113600,120000,240000-260000,408545-408779      @Y17XAMS 26840000
*D408863-408866,435000,511000,764620,764830-764860             @Y17XAMS 26880000
*D790270-790350,790410-790416                                  @Y17XAMS 26920000
*A702740                                                       @ZM46617 26940000
*C700260-700280                                                @OY19400 26940182
* DUMMY APAR                                                   @OZ27328 26940282
*                                                                       26960000
*********************************************************************** 27000020
         EJECT                                                          27200000
*                                                                       27500020
*              REGISTERS                                                28000020
*                                                                       28500020
R0       EQU   0                        REG 0                    S22024 29000022
R1       EQU   1                        CHAIN OF ELEMENTS               29500020
R2       EQU   2                        WORK REGISTER                   30000020
RSCB     EQU   3                        SCB ADDRESS                     30500020
RLCB     EQU   4                        LCB ADDRESS                     31000020
R5       EQU   5                        WORK REGISTER                   31500020
RPRF     EQU   6                        BASE FOR BUFFER DSECT  @Y17XAMS 32000000
R7       EQU   7                        WORK REGISTER          @Y17XAMS 32500000
R8       EQU   8                        ADDRESS OF MSGGEN PARAMETERS    33000020
RTRM     EQU   8                        BASE FOR TRM           @Y17XAMS 33200000
R9       EQU   9                        REG 9                    S22024 33500022
R10      EQU   10                       REG 10                   S22024 34000022
R11      EQU   11                       BASE FOR DISPATCHER             34500020
R12      EQU   12                       BASE FOR THIS ROUTINE           35000020
R13      EQU   13                       DISPATCHER SAVE AREA (AVTSAVE2) 35500020
R14      EQU   14                       WORK REGISTER                   36000020
R15      EQU   15                       WORK REGISTER                   36500020
         EJECT                                                          37000020
         USING *,R12                                                    37500000
         USING IEDQSCB,RSCB                                             38000020
         USING IEDQLCB,RLCB                                             38500020
         USING IEDQPRF,RPRF             ADDRESSABILITY FOR PRF @Y17XAMS 38700000
         USING IEDQDISP,R11                                             39000020
         USING AVTSAVE2,R13                                             39500020
         EJECT                                                          40000020
IEDQBL   IEDHJN START                                            S22025 40200022
         ST    R1,LCBERBLK-1            LINK ELEMENTS                   40700020
         SPACE 2                                                        40730022
         L     R9,LCBSTCBA-1            GET THE ADDRESS OF THE   S22025 40760022
*                                         FIRST STCB             S22025 40790022
         USING IEDQSTCB,R9              STCB ADDRESSABILITY    @Y17XAMS 40800000
         CLI   STCBVTO,DSPMCPL8         IS THE LMD STCB IN THE   S22025 40820000
*                                         STCB CHAIN             S22025 40850007
         DROP  R9                                                       40850400
         BE    EXIT                     YES, RETURN              S22025 40850907
*                                                                X03039 40851807
         CLI   LCBFLAG1,LCBPLCB         3705 RESOURCE          @Y17XAMS 40852700
         BE    SNAMSGEN                 YES, TO SNA ROUTINE    @Y17XAMS 40853600
         SPACE 2                                                        40881022
*        IF A DIAL LINE AND NOT CURRENTLY CONNECTED--DUE TO ERRORS,     40882000
*        NO MSGGEN SHOULD BE DONE                               SA57322 40883000
         SPACE 2                                                        40884022
         TM    LCBSTAT2,LCBDIAL         DIAL LINE               SA57322 40885022
         BNO   NOTDIAL                  BR IF NOT DIAL          SA57322 40886022
         CLI   LCBTSTSW,AVTEFF          CONNECTION STILL ESTAB  SA57322 40887022
         BE    EXIT                     BR IF NOT CONNECTED     SA57322 40888022
NOTDIAL  EQU   *                                                SA57322 40889022
         LR    R14,R8                   SAVE PARAMETER LIST ADDR X03039 40899007
         SPACE 2                                                        40910022
         USING IEDGENDS,R8              PARAMETER LIST         @Y17XAMS 40950000
         TM    GENFLAGS,GENOMSG         IS MSG DATA SPECIFIED  @YM06037 40960000
         BO    EXIT                       BRANCH NO - DISALLOW @YM06037 40970000
         TM    GENINDEX,GENMSKSP        ERROR MASK SPECIFIED            41000000
         BO    BLNOMSK                  BRANCH NO                       41500020
*                                                                       42000020
         LA    R14,4(R14)               BUMP PAST ERROR WORD            42500020
BLNOMSK  EQU   *                                                        43000020
         LM    R14,R15,4(R14)           MESSAGE TEXT ADDRESS TO R14     44000020
*                                       ASSUME TRANSLATE TABLE          44500020
*                                       SPECIFIED IN MACRO              45000020
*                                       AND PLACE IN R15                45500020
         L     R2,LCBDCBPT              DCB ADDRESS                     46000020
         USING IHADCB,R2                DCB ADDRESSABILITY     @Y17XAMS 46100000
         TM    GENFLAGS,GENUSDCB        TRANSLATE TABLE CODED  @Y17XAMS 46200000
         BZ    BLSPECD                  BRANCH IF TRANSLATE TABLE       46500020
*                                       SPECIFIED                       47000020
*                                                                       47500020
         L     R15,DCBTRANS-1           TRANSLATE TABLE IN DCB @Y17XAMS 48000000
         TM    0(R15),TRANLIST          IS THERE A LIST OF TRAN- S22029 48010022
*                                       SLATE TABLES             S22029 48020022
         BZ    BLSPECD                  NO, TRANSLATE TABLE WAS  S22029 48030022
*                                       FOUND IN DCB             S22029 48040022
         ST    R14,AVTPARM              SAVE MSG DATA POINTER    S22029 48050022
         MVC   AVTPARM3(4),AELIST       SETUP INTERFACE TO       S22029 48060022
         MVC   AVTPARM3+2(1),1(R15)     LOCOPT ROUTINE TO SEARCH S22029 48070022
         LA    R1,AVTPARM3              FOR TRANSLATE TABLE IN   S22029 48080022
         STM   R2,R12,28(R13)           OPTION FIELD DEFINED FOR S22029 48090000
         LA    R14,LOCRTN               THIS TERMINAL.           S22029 48100022
         ST    R14,12(R13)              SAVE RETURN ADDRESS      S22029 48110022
         L     R9,CVTPTR                PICKUP ADDR OF LOCOPT    S22029 48120022
         L     R9,AVTCVTPT(R9)          ROUTINE (IEDQAE) FROM    S22029 48130022
         L     R9,0(R9)                 6TH WORD OF IEDQMSGS     S22029 48140022
         LR    R12,R13                  SAVE CALLERS ADDR        S22029 48150022
         LA    R13,72(R13)              LOAD AE SAVE ADDRESS     S22029 48160022
         ST    R12,4(R13)               STORE BACK CHAIN         S22029 48170022
         ST    R13,8(R12)               STORE FORWARD CHAIN      S22029 48180022
         L     R12,AVTMSGS-1-AVTSVSIZ   LOAD AVTMSGS             S22029 48190022
         L     R12,20(R12)              LOAD ADDR OF AE          S22029 48200022
         BR    R12                      GO TO LOCOPT RTN         S22029 48210022
LOCRTN   EQU   *                                                 S22029 48220022
         L     R14,AVTPARM              RESTORE DATA MSG PTR     S22029 48230022
         LTR   R15,R15                  WAS OPTION FIELD FOUND   S22029 48240022
         BZ    EXIT                     NO, RETURN               S22029 48250022
         L     R15,0(R15)               IS THERE A TRANSLATE     S22029 48260022
         LTR   R15,R15                  IN THE OPTION FIELD      S22029 48270022
         BZ    EXIT                     NO, RETURN               S22029 48280022
*                                                                       48500020
BLSPECD  EQU   *                                                        49000020
         LA    R15,0(,R15)              CLEAR HIGH ORDER                49500020
         CLC   DCBIOBAD+1(3),AVTFZERO   IS SOURCE/DESTINATION  @Y17XAMS 50000000
*                                       AN APPLICATION PROGRAM          50500020
         BE    EXIT                     BRANCH YES - IGNORE MSGGEN      51000000
         LR    R9,R1                    SAVE R1                  S22026 51020022
         LR    R10,R14                  SAVE R14                 S22026 51040022
         LR    R5,R15                   SAVE R15                 S22026 51060022
         LH    R1,LCBTTCIN              GET TERM INDEX           S22026 51080022
         LTR   R1,R1                    TERM CONNECTED           S22026 51120022
         BZ    NOTERM                   BRANCH IF NO             S22026 51140022
         L     R15,AVTRNMPT             TERM ROUTINE             S22026 51160022
         BALR  R14,R15                  LINK TO ROUTINE          S22026 51180022
         USING IEDQTRM,R1               TRM ADDRESSABILITY     @Y17XAMS 51190000
         TM    TRMDEVFL+1,TRMCONC       CONCENTRATOR           @Y17XAMS 51200000
         BO    EXIT                     BRANCH IF YES IGNORE     S22026 51240022
         TM    TRMSTATE,TRMPROC+TRMLIST DIST/CASCADE LIST?     @Y17XAMS 51242000
         BNZ   NOTERM                   BR YES, NO CHAR INDEX  @SA72461 51244009
         SR    R14,R14                  CLEAR WORK REGISTER    @SA72461 51246009
         IC    R14,TRMCHCIN             CHARACTERISTICS INDEX  @Y17XAMS 51248000
         DROP  R1                                              @Y17XAMS 51249000
         BCTR  R14,0                    DECREMENT FOR N-1TH ENT@SA72461 51250009
         MH    R14,AVTDCTLN             COMPUTE OFFSET         @Y17XAMG 51252000
         A     R14,AVTCSTCS             POINT TO CHARACTERISTIC@SA72461 51254009
         USING IEDDCT,R14               DCT ADDRESSABILITY     @Y17XAMS 51255000
         TM    DCTBYTE1,DCTUMASK        GENERAL POLL DEVICE?   @Y17XAMS 51256000
         BO    EXIT                     BR YES, IGNORE MSGGEN  @SA72461 51257000
         DROP  R14                                             @Y17XAMS 51258000
NOTERM   EQU   *                                                 S22026 51260022
         LR    R1,R9                    RESTORE REG              S22026 51280022
         LR    R14,R10                  RESTORE REG              S22026 51300022
         LR    R15,R5                   RESTORE REG              S22026 51320022
         SR    R9,R9                    ZERO REG                 S22026 51410022
*                                                                       51500020
         IC    R9,0(R14)                LENGTH OF MESSAGE               52000020
         BCTR  R9,0                     DECREMENT FOR MVC               52500020
         LA    R10,SCBUNTCT-SCBSRCE-1   MAXIMUM MSGGEN SIZE             53000000
         CLR   R9,R10                   CHECK LENGTH OF MESSAGE PASSED  53500020
         BNH   OK                       BRANCH LENGTH OK                54000020
*                                                                       54500020
         LR    R9,R10                   ERROR - USE MAXIMUM LENGTH      55000020
OK       EQU   *                                                        55500020
         EX    R9,BLMVC                 MOVE TEXT TO SCB                56000020
*                                                                       56500020
         LA    R5,NOTR                  SET RETURN REGISTER             56700020
         TM    GENFLAGS,GENOCODE        WAS CODE =NO SPECIFIED @Y17XAMS 57000000
         BCR   1,R5                     BRANCH YES - NO TRANSLATE       57600020
*                                                                       58200020
         BCT   R15,CKTRAN               DEFAULT IN DCB IS '1'           58800020
*                                       FALL THRU IF NO TABLE           59400020
*                                                                       60000020
*                                                                       61000020
NOTR     EQU   *                                                        61500020
         TM    LCBSTAT1,LCBSENDN        SEND STATE?              S99228 61530022
         BO    USUAL                    YES, OMIT GEN POLL CHECK S99228 61560000
         SR    R5,R5                    CLEAR INVLIST INDEX REG  S99228 61590022
         IC    R5,DCBEIOBX              INSERT LCB LENGTH      @Y17XAMS 61620000
         DROP  R2                                              @Y17XAMS 61630000
         SH    R5,AVTHA4                REDUCE LCB LENGTH BY     S99228 61650022
         SH    R5,AVTHA4                8 BYTES FOR ADDR LCB EXT S99228 61680022
         USING IEDQLCBX,R5                                       S99228 61710022
         LA    R5,ZERO(R5,RLCB)         LOAD LCB EXTENSION ADDR  S99228 61740022
*                                                                S99228 61770022
*        ASSUME GENERAL POLL IN PROGRESS                         S99228 61800000
*                                                                S99228 61830022
         NI    LCBXFLAG,LCBGPSTP        STOP GENERAL POLL        S99228 61860022
         DROP  R5                                                S99228 61890022
USUAL    EQU   *                                                 S99228 61920022
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN BIT FOR I/O GEN      62000020
         LH    R5,LCBTTCIN              CURRENTLY CONNECTED             62500020
         STH   R5,LCBTTBIN              TO BE CONNECTED                 63000020
         SR    R5,R5                                                    63500020
         STH   R5,LCBTTCIN              CLEAR CURRENTLY CONNECTED       64000020
         STH   R5,LCBTPCD               SET TP OP CODES OF ZERO         64500000
         LA    R1,LCBCPA                CHANNEL PROGRAM AREA   @Y17XAMS 64600000
         USING IEDQCCW,R1               CCW ADDRESSABILITY     @Y17XAMS 64700000
         LA    R5,SCBSRCE               DATA ADDRESS                    65000020
         ST    R5,CCWADDR-1             TO LCB FOR IOGENER     @Y17XAMS 65500000
         MVI   CCWOPCDE,CCWWRITE        SET WRITE OP CODE      @Y17XAMS 66000000
         LA    R9,1(,R9)                ADD FOR COUNT                   67000020
         ST    R9,CCWCOUNT-2            CLEAR FLAGS, SET COUNT @Y17XAMS 67500000
         DROP  R1                                              @Y17XAMS 67700000
*                                                                       68000020
*        SET TO POST ERB TO I/O GENERATOR                               68500000
*                                                                       68700000
         LA    R9,PRIACTIV              PRIORITY FOR TPOST              69000020
         LA    R5,AVTACTIB              I/O GENERATOR QCB               69500020
         B     EXIT1                    EXIT TO DISPATCHER              70000020
         EJECT                                                          70004007
SNAMSGEN EQU   *                        SNA MSGGEN PROCESS     @Y17XAMS 70005000
         USING IEDNSVTD,R9              SAVT ADDRESSABILITY    @YM08501 70005500
         USING IEDGENDS,R2              MSGGEN PARAMETER LIST  @Y17XAMS 70006000
         USING IEDNTRM,RTRM                                    @Y17XAMS 70009000
         L     R9,AVTSAVTP              SAVT BASE              @YM08501 70009500
         LR    R2,R8                    LOAD PARM LIST ADDR    @Y17XAMS 70010000
         LH    R1,LCBTTCIN              TNT INDEX                X03039 70011000
         L     R15,AVTRNMPT             TERMNAME ROUTINE         X03039 70012000
         BALR  R14,R15                  GET TERMINAL ADDRESS     X03039 70013000
         LR    RTRM,R1                  SET TRM BASE REG       @Y17XAMS 70018000
         SH    RTRM,TRMBCKUP            GET NEGATIVE PREFIX    @Y17XAMS 70020000
         TM    TRMBYTE0,TRMSNA          SNA RESOURCE           @Y17XAMS 70022000
         BO    LUTEST                   BRANCH IF YES          @Y17XAMS 70024000
         TM    GENFLAGS,GENOMSG        IS MSG DATA SPECIFIED   @YM06037 70024600
         BO    EXIT                      BRANCH NO- DISALLOW   @YM06037 70025200
         CLI   TRMTYPE,TRMPSNA          PRE-SNA TERMINAL       @OY19400 70026082
         BE    CKDIAL                   IF YES, CHECK IF DIAL  @OY19400 70026682
         CLI   TRMTYPE,TRMCTERM         CTERM TYPE ENTRY?      @OY19400 70027282
         BNE   EXIT                     NO, IGNORE MSGGEN      @OY19400 70027882
CKDIAL   EQU   *                                               @OY19400 70028482
         TM    TRMBYTE0,TRMDIAL         DIAL                   @Y17XAMS 70030000
         BNO   NONDIAL                  NO - CONTINUE          @YA09726 70032000
         TM    TRMPRE1,TRMSESSN         IN SESSION             @Y17XAMS 70034000
         BNO   EXIT                     NO - EXIT              @Y17XAMS 70036000
NONDIAL  EQU   *                                               @YA09726 70036500
         TM    TRMPRE1,TRMSPACT+TRMSTPND LINE UP?              @YA07123 70037000
         BZ    EXIT                     NO GET OUT             @YA07123 70037500
         B     INPROG                   YES - CONTINUE         @Y17XAMS 70038000
LUTEST   EQU   *                                               @Y17XAMS 70048000
         CLI   TRMTYPE,TRMLUNT          LU                     @Y17XAMS 70058000
         BNE   EXIT                     NO - EXIT              @Y17XAMS 70061000
         SR    R1,R1                    CLEAR                  @Y109726 70061300
         ICM   R1,AD,TRMSIBPT           GET SIB POINTER        @YA09726 70061600
         LTR   R1,R1                    SIB POINTER?           @YA09726 70061900
         BZ    EXIT                     NO GET OUT             @YA09726 70062200
         TM    SIBSESSN-IEDSIBD(R1),SIBDAPND+SIBDRPND DATA TRAFFIC      70062500
*                                       ACTIVE?                @YA09726 70062800
         BNO   EXIT                     NO GET OUT             @YA09726 70063100
INPROG   EQU   *                                               @Y17XAMS 70064000
         OI    LCBSTAT2,LCBMSGNN        SET MSGGEN IN PROGRESS @Y17XAMS 70067000
         LR    R5,R2                    PARM LIST ADDRESS      @Y17XAMS 70070000
         TM    GENINDEX,GENMSKSP        ERROR MASK SPECIFIED   @Y17XAMS 70073000
         BO    SETMADR                  NO - DONT MODIFY       @Y17XAMS 70076000
         LA    R5,4(R5)                 YES - BUMP PAST ERROR  @Y17XAMS 70079000
*                                       MASK AND POINT TO      @Y17XAMS 70082000
*                                       MSGGEN DATA ADDRESS    @Y17XAMS 70085000
SETMADR  EQU   *                                               @Y17XAMS 70088000
         L     R5,4(R5)                 GET MSGGEN DATA AREA   @Y17XAMS 70091000
         USING MSGNAREA,R5              MSGGEN DATA AREA       @Y17XAMS 70094000
         SR    RPRF,RPRF                CLEAR REGISTER         @Y17XAMS 70097000
         ICM   RPRF,AD,LCBERBCH         BUFFER ADDRESSABILITY  @Y17XAMS 70100000
         BNZ   SETPARM                  IF BFR AVAIL, USE IT   @Y17XAMS 70103000
         SR    R15,R15                  CLEAR REG              @Y17XAMS 70106000
         TM    GENFLAGS,GENOMSG        IS MSG DATA SPECIFIED   @YM06037 70106700
         BO    REMAIN                    BRANCH NO- GET 1 BUFFER        70107400
*                                                              @YM06037 70108100
         IC    R15,MSGNCT               PLACE MSGGEN DATA LEN  @Y17XAMS 70109000
*                                       IN EVEN/ODD PAIR       @Y17XAMS 70112000
         LA    R15,PRFSHDR-PRFSUNIT(R15) TOTAL BYTES           @Y17XAMS 70118000
         SR    R14,R14                  ZERO EVEN REG          @Y17XAMS 70138000
         D     R14,AVTKEYLE             COMPUTE UNITS REQUIRED @Y17XAMS 70142000
         LTR   R14,R14                  REMAINDER              @Y17XAMS 70146000
         BZ    NOREMAN                  NO                     @Y17XAMS 70150000
REMAIN   EQU   *                                               @YM06037 70152000
         LA    R15,1(R15)               YES, INCREASE UNIT     @Y17XAMS 70154000
*                                       COUNT FOR PARTIAL      @Y17XAMS 70158000
NOREMAN  EQU   *                                               @Y17XAMS 70162000
         LR    R0,R15                   UNITS REQUIRED         @Y17XAMS 70166000
         LA    R1,1                     REQUEST ONE BUFFER     @Y17XAMS 70170000
         L     R15,AVTSTEAL             IEDQGA02 ADDRESS       @Y17XAMS 70174000
         BALR  R14,R15                                         @Y17XAMS 70178000
         STCM  R15,AD,LCBERBCH          SAVE BUFFER ADDRESS    @Y17XAMS 70182000
         LTR   RPRF,R15                 BFR STEAL SUCCESSFUL   @Y17XAMS 70186000
         BNZ   SETPARM                  YES                    @Y17XAMS 70190000
*                                                                       70194000
*        BUFFER STEAL UNSUCCESSFUL, SO POST ERB TO REQUEST BUFFERS      70198000
*                                                                       70202000
         STC   R1,LCBRBCT1              REQUEST 1 BUFFER       @Y17XAMS 70206000
         STC   R0,LCBRBCT2              UNITS REQUIRED         @Y17XAMS 70210000
         OI    LCBERBST,LCBPRCPG        REQUEST ERB POST       @Y17XAMS 70218000
         LA    R14,GENQCB               QCB ADDRESS            @Y17XAMS 70238000
         ST    R14,LCBRCQCB             QCB TO POST AFTER BFR  @Y17XAMS 70242000
*                                       ALLOCATION             @Y17XAMS 70246000
         LA    R9,PRIINTRQ              ERB PRIORITY           @Y17XAMS 70250000
         LA    R5,AVTBFREB              AVAILABLE BUFFER QCB   @Y17XAMS 70254000
         B     EXIT1                                           @Y17XAMS 70258000
SETPARM  EQU   *                                               @Y17XAMS 70262000
         USING IEDPLMV,R1                                      @Y17XAMS 70266000
         XC    PRFSIZE(2),PRFSIZE      INITIALIZE TO ZERO      @YM07314 70267500
         TM    GENFLAGS,GENOMSG        IS MSG DATA SPECIFIED   @YM06037 70268000
         BO    CLEARPF1                 BR NO                  @YM08501 70269000
         LA    R1,AVTSAVE4              PARMLIST ADDRESS       @Y17XAMS 70274000
         XC    IEDPLMV(PLMVLEN),IEDPLMV CLEAR PARAMETER LIST   @ZM46617 70278000
         LA    R7,PRFSHDR               TARGET  UNIT ADDRESS   @Y17XAMS 70282000
         STM   RPRF,R7,PLMVTU           TARGET DATA & UNIT     @Y17XAMS 70286000
         LA    R14,MSGNDATA             POINT TO MSGGEN DATA   @Y17XAMS 70290000
         ST    R14,PLMVSU               SOURCE UNIT ADDRESS    @Y17XAMS 70294000
         ST    R14,PLMVSD               SOURCE DATA ADDRESS    @Y17XAMS 70298000
         SR    R14,R14                  CLEAR REG              @Y17XAMS 70302000
         IC    R14,MSGNCT               LENGTH OF ...          @Y17XAMS 70306000
         STH   R14,PLMVLNTH             ... MSGGEN DATA        @Y17XAMS 70310000
         OI    PLMVFLG1,PLMVSCTG        SET FLAG               @Y17XAMS 70318000
         L     R15,SAVTMVBF             IEDMVBFR ADDRESS       @Y17XAMS 70338000
*                                                              @Y17XAMS 70345000
*        IEDMVBFR WILL USE AVTSAVE2 AS SAVE AREA               @Y17XAMS 70352000
*                                                              @Y17XAMS 70359000
         BALR  R14,R15                                         @Y17XAMS 70366000
         SR    R14,R14                  CLEAR FOR LOAD         @YM07314 70367000
         IC    R14,MSGNCT               GET MESSAGE SIZE       @YM07314 70368000
         STH   R14,PRFSIZE              SAVE IN BUF            @YM07314 70369000
         DROP  R1                                              @Y17XAMS 70373000
CLEARPF1 EQU   *                                               @YM06995 70376000
         USING IEDPF1,R1                                       @Y17XAMS 70380000
         LR    R1,RPRF                  START OF BUFF PREFIX ..@Y17XAMS 70387000
         SH    R1,PRF1BKUP              ... NEG EXTENSION      @YM06511 70394000
         XC    IEDPF1(PRF1LEN),IEDPF1   CLEAR NEG EXT          @Y17XAMS 70401000
         TM    TRMBYTE0,TRMSNA          SNA                    @Y17XAMS 70408000
         BNO   BFPRFX                   NO                     @Y17XAMS 70415000
         TM    GENFLAGS,GENRHINC        RH DATA SPECIFIED      @Y17XAMS 70422000
         BNO   BFPRFX                   NO                     @Y17XAMS 70429000
RHBLD    EQU   *                                               @YM06037 70432000
         LA    R14,252                  HEX FC FOR AND TO TURN @Y17XAMS 70436000
*                                       OFF TWO LOW ORDER BITS @Y17XAMS 70443000
*                                       OF LENGTH              @Y17XAMS 70450000
         IC    R15,GENENGTH             PARM LIST LENGTH       @Y17XAMS 70457000
         NR    R15,R14                  TURN OFF LOW ORDER BIT @Y17XAMS 70464000
         SH    R15,AVTHA4               POINT TO RH DATA ADDR  @Y17XAMS 70471000
         L     R15,IEDGENDS(R15)        LOAD RH DATA ADDRESS   @Y17XAMS 70478000
         MVC   PRF1RH,0(R15)            MOVE RH DATA INTO BFR  @Y17XAMS 70485000
*                                       PREFIX                 @Y17XAMS 70500000
BFPRFX   EQU   *                                               @Y17XAMS 70560000
         LH    R14,PRFSIZE              GET MSG SIZE OR ZERO   @YM07314 70570000
         LA    R14,PRFSHDR-PRFSUNIT(R14) ADD HEADER SIZE       @YM07314 70580000
         STH   R14,PRFSIZE              SET UP BUFF SIZE       @YM07314 70590000
         STCM  RLCB,AD,PRFLCB           INIT LCB ADDRESS       @Y17XAMS 70620000
         MVC   PRFDEST,LCBTTCIN         SET DESTINATION        @YM07708 70630000
         NI    PRFSTAT1,PRFNHDRF        MARK AS HEADER         @YM06960 70640000
         NI    PRFSTAT1,PRFNLSTF        MARK AS LAST           @YM06960 70660000
         MVI   LCBISZE,AVTEZERO         INIT RESERVE COUNT     @Y17XAMS 70680000
         L     R5,SAVTDNIR              OUTDH QCB ADDRESS      @YM06902 70800000
         LA    R9,PRIOUTBD              PRIORITY               @YM06902 70830000
         B     EXIT1                                           @Y17XAMS 70860000
*                                                                       70920000
EXIT     EQU   *                                                        71000020
         L     R5,AVTMSGS-1             ADDRESS OF MSGS CSECT           71500020
         L     R5,0(,R5)                ADDRESS OF IEDQBD               72000020
         LA    R9,PRIEDISP              SET LOW PRIORITY         S22025 72500022
EXIT1    EQU   *                                                        73000020
         STC   R9,LCBERBPY              SET PRIORITY                    74000020
         ST    R5,LCBERBQB-1            SET ERB QCB ADDRESS             74500020
         LA    R1,LCBERB                ERB ADDRESS                     75000020
*                                                                       75500020
         BAL   R14,DSPCHAIN             EXIT TO DISPATCHER     @Y17XAMX 76000000
*                                                                       76030020
CKTRAN   EQU   *                                                        76060020
********************************************************************    76090020
*                                                                       76120020
*        BYPASS ASSEMBLER PROBLEM                                       76150000
         USING DUMMY+3,R15                                              76180020
         L     R15,OUTRANS                                              76210020
*                                                                       76240020
*********************************************************************   76270020
         LTR   R15,R15                  IS ONE SPECIFIED                76300020
         BCR   8,R5                     RETURN IF NOT                   76330020
*                                                                       76360020
         EX    R9,BLTRN                 TRANSLATE TO LINE CODE          76390020
         BR    R5                       RETURN                          76420020
         EJECT                                                          76423022
*****************************************************************S22024 76426022
*        THE FOLLOWING QCB IS USED TO REENTER THIS ROUTINE       S22024 76429000
*        FROM IEDQGA WHEN RETURN POSTING THE ERB AFTER         @Y17XAMS 76432000
*        ALLOCATING BUFFERS                                      S22024 76435000
*****************************************************************S22024 76438022
         SPACE 1                                                 S22024 76441022
GENQCB   DC    A(IEDQBL)                ADDR FOR RESTORING BASE@Y17XAMS 76444000
         DC    A(0)                     LINK FIELD               S22024 76447022
GENSTCB  DC    AL1(DSPMCPL4)            STCB KEY               @Y17XAMS 76450000
         DC    AL3(GENSTCB)             STCB CHAIN POINTER     @Y17XAMS 76453000
         SPACE 1                                                 S22024 76456022
         L     R12,ZERO(R7)             SET UP BASE REGISTER     S22024 76459000
         SH    R1,ERBOFFST              BACK UP TO PLCB          S22024 76465022
         LR    RLCB,R1                  SET UP LCB BASE REGISTER S22024 76468022
         L     RSCB,LCBSCBA-ONE         SET UP SCB BASE          S22024 76471022
         SR    R1,R1                    ZERO REG FOR NULL ELEMENTS22024 76474022
*                                       CHAIN                    S22024 76477022
         L     R8,SCBMACR-ONE           SET UP PARM LIST ADDRESS S22024 76480022
         B     START                    BRANCH BACK TO START     S22024 76489022
         EJECT                                                          76500020
BLMVC    MVC   SCBSRCE(1),1(R14)        EXECUTED MOVE TO PLACE MSGGEN   77000020
*                                         TEXT IN SCB                   77500020
*                                       EX MVC TO PUT TEXT IN    X03039 77600007
*                                       BFR FOR A VTAM TERMINAL  X03039 77700007
BLTRN    TR    SCBSRCE(1),0(R15)        EXECUTED TRANSLATE TO CONVERT   78500020
*                                         MSGGEN TEXT TO LINE CODE      79000020
ERBOFFST DC    AL2(LCBERBKY-IEDQLCB)    OFFSET TO ERB            S22024 79004022
TRMBCKUP DC    AL2(TRMPRFSZ)            NEGATIVE PREFIX SIZE   @Y17XAMS 79009000
PRF1BKUP DC    AL2(PRF1LEN)             BUFFER NEGATIVE PREFIX @Y17XAMS 79014000
AELIST   DC    XL4'14040010'            PARM LIST TO LOCOPT             79020020
ZERO     EQU   0                        ONE                      S22024 79039022
ONE      EQU   1                        ONE                      S22024 79040200
AD       EQU   7                        MASK FOR ADDR ICM OR STCMX03039 79042007
CVTPTR   EQU   16                       OFFSET TO CVT ADDR       S22029 79043000
TRANLIST EQU   X'80'                    FLAG INDICATING LIST     S22029 79050000
*                                       OF TRANSLATE TABLES      S22029 79060000
         EJECT                                                          79070000
IEDGENDS DSECT                          MSGGEN DSECT PARM LIST @Y17XAMS 79080000
GENINDEX DS    X                        AVTMSGS INDEX TO IEDQBL@Y17XAMS 79090000
GENMSKSP EQU   X'01'                    MASK SPECIFIED         @Y17XAMS 79100000
GENENGTH DS    X                        PARM LIST LENGTH       @Y17XAMS 79110000
GENFLAGS DS    X                        FLAGS                  @Y17XAMS 79120000
GENUSDCB EQU   X'80'                    USE TABLE IN DCB       @Y17XAMS 79130000
GENOMSG  EQU   X'20'                   MSG DATA OMITTED        @YM06037 79135000
GENRHINC EQU   X'40'                    RH DATA INCLUDED       @Y17XAMS 79140000
GENOCODE EQU   X'10'                    CODE=NO SPECIFIED      @Y17XAMS 79150000
GENMASK  DS    XL5                      MSGGEN MASK            @Y17XAMS 79160000
         SPACE 3                                                        79170000
MSGNAREA DSECT                          MSGGEN AREA IN BFR UNIT  X03039 79200000
MSGNCT   DS    X                        LENGTH OF MSGGEN DATA    X03039 79220000
MSGNDATA DS    0XL24                    MSGGEN TEXT              X03039 79250000
         SPACE 3                                               @Y17XAMS 79260000
*********************************************************************** 79270000
*        THE FOLLOWING DSECT IS REQUIRED TO ENABLE THE ASSEMBLER      * 79300000
*        TO PROPERLY HANDLE SOMETHING OTHER THAN ORDINARY             * 79400000
*        INEFFECIENT CODING PRACTICES.                                * 79500000
*********************************************************************** 79580000
DUMMY    DSECT                                                          79660000
         DS    A                        DSECT FOR                S21903 79740000
OUTRANS  DS    A                        ASSEMBLER PROBLEM        S21903 79820000
         EJECT                                                 @Y17XAMS 79900000
         TAVTD                                                          80000000
         EJECT                                                          80100000
         TCCWD                                                 @Y17XAMS 80200000
         EJECT                                                 @Y17XAMS 80300000
         DCBD  DSORG=TX                                                 80500000
         EJECT                                                          80580000
         TDCTD                                                 @Y17XAMS 80660000
         EJECT                                                 @Y17XAMS 80740000
         TDISPD                                                         80820000
         EJECT                                                 @Y17XAMS 80900000
         TLCBD                                                          81000020
         EJECT                                                 @Y17XAMS 81060000
         TPLMVD                                                @Y17XAMS 81120000
         EJECT                                                 @Y17XAMS 81180000
         TPRFD ,                                                 S22024 81240000
         EJECT                                                 @Y17XAMS 81300000
         TPRIOR                                                         81360000
         EJECT                                                 @Y17XAMS 81420000
         TSCBD                                                          81500020
         EJECT                                                          82000000
         TSIBD                                                          82100000
         EJECT                                                          82200000
         TSTCBD                                                @Y17XAMS 82300000
         EJECT                                                 @Y17XAMS 82600000
         TTRMD                                                   S22026 83200022
         END                                                            83500020
