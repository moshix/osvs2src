BT       TITLE '''IEDQBT'' - EOB/ETB ERROR RETRY MODULE'                00040056
IEDQBT   CSECT                                                          00080056
         SPACE 3                                                        00120056
*CHANGE ACTIVITY AS FOLLOWS                                             00160056
******************** MICROFICHE FLAGS *********************** SUPT CODE 00200056
*A191000                                                         S99228 00200154
*A105200-106500,247300-247600                                    S22029 00200254
*D100000-101000,188000-190000,278760-278840                      S22029 00200354
*C105000,106000,753000                                           S22029 00200454
*A119000,173000,185000,396000,542000,619000,679000,721000,756000 S22025 00200554
*A758000,761000                                                  S22025 00200654
*C091200,160000,167000,205000,360000-369000,372000-387000,386000 S22025 00200754
*C386000,398000-412000,425000,4362000,463000-464000,             S22025 00200854
*C468000-464000,468000-479000,483000,485000,513000-519000,       S22025 00200954
*C683400-689000,713000-714000,717000-719000                      S22025 00201054
*D326000-339000,384300,414000-416000,418000                      S22025 00201154
*D433200-433600,612000,617000,720000                             S22025 00201254
*A714200,726000                                                 SA55402 00201354
*D240000                                                        SA51793 00201454
*C109000,112000                                                 SA56631 00201554
*A119007-119091                                                  S22024 00201654
*A174200-174800,202100-202700,277300-277600,553070-553840        S22024 00201754
*A660300-660600,715030-715840                                    S22024 00201854
*C179200-181200,213000-222000,768000                             S22024 00201954
*A605000                                                        SA63639 00202054
*C308200                                                        SA63640 00202154
*D301300                                                        SA63640 00202254
*C682000                                                         X01004 00202354
*D721000                                                         X01004 00202454
*A 360000,379200,641000                                         SA63962 00202554
*D 637000                                                       SA63962 00202654
*A104000,105200                                                  Y06327 00202754
*D105300,105400                                                  A65901 00202854
*A105900                                                         A65901 00202954
*A105200                                                        0Y01869 00203054
*C106400,107000                                                 0Y01869 00203154
*      OY01869 IS LOGICAL DUP OF                                SA66591 00203254
*A557000                                                       @SA72449 00203356
*A715270                                                        SA68245 00223205
*C222000,553210,715780-715840                                   SA68245 00243205
*D146000,148000-152000                                          SA68678 00263205
*A145000,147000,273000,742000                                  @XA05300 00263356
*A553840,742000                                                @SA70192 00263456
*A426000                                                       @SA70682 00263556
*C252000-253000                                                @XA05300 00263656
*A683200                                                        SA69621 00273205
*D105930-105960                                                @YA09313 00276200
*A195000                                                       @XA09327 00279209
*A195300                                                       @XA09327 00285209
*A202400,553890,662000                                         @Y17XANG 00286200
*C470000                                                       @OS79713 00289200
*A742600                                                       @OY16454 00290200
*C702000                                                       @OY16454 00291200
*C427500,430000                                                @OY20146 00291386
*A257000,273360                                                @OZ31599 00291486
*C463000,466000                                                @0Z33243 00291586
         SPACE 3                                                        00292254
*********************************************************************** 00300020
*TITLE -- 'IEDQBT' EOB/ETB HANDLING SUBTASK                           * 00400020
*                                                                     * 00500020
*  MODULE NAME = IEDQBT                                               * 00510054
*                                                                     * 00520054
*  DESCRIPTIVE NAME = EOB/ETB ERROR RETRY MODULE                      * 00530054
*                                                                     * 00540054
*  COPYRIGHT = 'NONE'                                                 * 00550054
*                                                                     * 00600020
*STATUS -- CHANGE LEVEL 7                                        X03039 00700007
*                                                                     * 00800020
*FUNCTION -- THIS SUBTASK GAINS CONTROL WHEN A BUFFER IS TPOSTED TO   * 00900020
*  STARTMH AND THE STARTMH OPERANDS SPECIFY THAT SOME FORM OF EOB/ETB * 01000020
*  HANDLING IS TO BE DONE.  IF THE BUFFER IS NOT MARKED LAST, EXIT    * 01100020
*  IS MADE TO THE TCAM DISPATCHER AT DSPBYPAS TO PERFORM A BYPASS     * 01200020
*  FUNCTION TO MODULE IEDQAA.  IF THE BUFFER IS MARKED LAST,          * 01300020
*  INDICATING THAT AN EOB/ETB APPEARS IN THE BUFFER,  A CHECK IS      * 01400020
*  MADE FOR A TEXT ERROR.                                        X03039 01500007
*  IF AN ERROR HAS OCCURRED FOR A NON 3705 TERMINAL, RETRY IS    X03039 01550007
*  ATTEMPTED BY BACKING UP THE CCW ADDRESS IF A PREVIOS EOB/ETB       * 01600020
*  OCCURRED IN THE CURRENT BUFFER OR BY RECALLING A PREVIOUSLY        * 01700020
*  RECEIVED/SENT BUFFER.  IF NO ERROR OCCURRED, (FOR RECEIVE          * 01800020
*  OPERATIONS ONLY) A CHECK IS MADE FOR THE EOB/ETB OPTIONS           * 01900020
*  SELECTED.  IF A USER EXIT WAS SPECIFIED, A BRANCH AND LINK IS      * 02000020
*  DONE TO PASS CONTROL.  THE CONV= OPERAND IS THEN CHECKED TO        * 02100020
*  DETERMINE IF THE EOB/ETB JUST RECEIVED IS TO BE TREATED AS END     * 02200020
*  OF MESSAGE.  IF NOT, THE BUFFER IS TPOSTED TO CONTINUE        X03039 02300007
*  MESSAGE RECEPTION.  FOR SEND OPERATIONS, ONLY THE LAST BUFFER      * 02400020
*  OF A MESSAGE OR ONE WITH AN EOB/ETB ERROR WILL BE MARKED LAST.     * 02500020
*  IF A PERMANENT ERROR OCCURS, THE STOP/CONT OPTIONS ARE CHECKED AND * 02600020
*  THE MESSAGE CONTINUES OR IS ABORTED BASED ON THE OPTIONS.            02700020
*                                                                     * 02800020
*ENTRY POINT -- IEDQBT                                                * 02900020
*                                                                     * 03000020
*   CALLING SEQUENCE -                                                * 03100020
*                  L     R1,ELMAD                                     * 03200020
*                  L     R15,QCBSTCHN-1                               * 03300020
*                  LA    R15,4(R14)                                   * 03400020
*                  BR    R15                                          * 03500020
*                                                                     * 03600020
*INPUT -- ENTRY IS ALWAYS FROM THE TCAM DISPATCHER                    * 03700020
*         PARAMETERS ARE PASSED IMPLICITLY IN REGISTERS AS FOLLOWS:   * 03800020
*                  R1    ADDRESS OF THE PASSED ELEMENT -              * 03900020
*                        BUFFER OR ERB                                * 04000020
*                  R11   BASE FOR TCAM DISPATCHER                     * 04100020
*                  R13   ADDRESS OF AVTSAVE2                          * 04200020
*                  R15   BASE FOR THIS ROUTINE                        * 04300020
*                                                                     * 04400020
*OUTPUT -- IF NO ERROR OCCURRED, A USER EXIT MAY BE TAKEN, AN EOB/ETB * 04500020
*  RECEIVED MAY BE TREATED AS END OF MESSAGE OR MESSAGE RECEPTION IS  * 04600020
*  CONTINUED.  NON-PERMANENT ERRORS FOR NON 3705 TERMINALS ARE   X03039 04700007
*  RETRIED.  IF AN ERROR IS PERMANENT, THE MESSAGE IS EITHER     X03039 04800007
*  ABORTED OR CONTINUED AFTER THE POINT OF ERROR.                X03039 04900007
*                                                                     * 05000020
*EXTERNAL ROUTINES -- IEDQAE                                          * 05100020
*                                                                     * 05200020
*EXITS - NORMAL -- THE TCAM DISPATCHER AT ENTRY POINT DSPPOST OR      * 05300020
*  DSPBYPASS OR DSPCHAIN.                                        S22025 05400022
*                                                                     * 05500020
*EXITS-ERROR -- NONE                                                  * 05600020
*                                                                     * 05700020
*TABLES/WORKAREAS --                                                  * 05800020
*    DSECTS USED - LCB,SCB,AVT,DIS,PRF,PRI                            * 05900020
*                                                                     * 06000020
*ATTRIBUTES -- REUSEABLE, REFRESHABLE, ENABLED, RESIDENT, PROBLEM     * 06100020
*              PROGRAM MODE.                                          * 06200020
*                                                                     * 06300020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 06400020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET  * 06500020
*                                                                     * 06600020
*********************************************************************** 06700020
R0       EQU   0                        REG 0                    S22024 06800022
R1       EQU   1                        PASSED ELEMENT (BUFFER)         06900020
R2       EQU   2                        REG 2                    S22024 07000022
R3       EQU   3                        BASE REGISTER                   07100020
RLCB     EQU   4                        LCB ADDRESS                     07200020
R5       EQU   5                        REG 5                    S22024 07300022
RPREFIX  EQU   6                        REG 6                    S22024 07400022
R7       EQU   7                        STARTMH PARAMETER LIST (QCB)    07500020
RSCB     EQU   8                        SCB ADDRESS                     07600020
R9       EQU   9                        REG 9                    S22024 07700022
R10      EQU   10                       REG 10                   S22024 07800022
R11      EQU   11                       DISPATCHER BASE                 07900020
R12      EQU   12                       REG 12                   S22024 08000022
R13      EQU   13                       AVTSAVE2                        08100020
R14      EQU   14                       REG 14                   S22024 08200022
R15      EQU   15                       REG 15                   S22024 08300022
         EJECT                                                          08400020
         USING *,R3                                                     08500020
         USING STARTMH,R7                                               08600020
         USING IEDQDISP,R11                                             08700020
         USING AVTSAVE2,R13                                             08800020
         USING IEDQSCB,RSCB                                     OY01869 08850054
*                                                                       08900020
         DC    AL1(DSPMCPL8)            SUBTASK ENTRY CODE              08970020
         DC    C'EDQBT'                 MODULE ID                       09040020
         IEDHJN                                                         09120022
         SPACE 3                                                        09200020
         SR    R2,R2                    CLEAR REGISTER                  09300020
         TM    PRFTIC-IEDQPRF(R1),X08   PASSED ELEMENT A BUFFER         09400020
         BZ    ERB                      BRANCH NO - ERB                 09500020
*                                                                       09600020
         LR    RPREFIX,R1               BUFFER ADDRESS                  09700020
         USING IEDQPRF,RPREFIX                                          09800020
*                                                                       09900020
         MVI   PRFQCBA+2,REGOF          SET RETURN REGISTER = 12        10200020
         L     RLCB,PRFLCB-1            LCB ADDRESS                     10300020
         USING IEDQLCB,RLCB                                             10400020
         L     RSCB,LCBSCBA-1           GET SCB ADDRESS         0Y01869 10410054
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PLCB?          Y06327 10430005
         BE    TSO3705                  BRANCH YES               Y36327 10460005
         TM    LCBTSOB,LCBTSBUF         IS A TIME SHARING        S22029 10500022
*                                       TERMINAL ON THIS LINE    S22029 10510022
         BO    EOBTOBD                  YES - BYPASS TO STARTMH  S22029 10520022
         CLC   SCBDESTQ,AVTTSOPT+1      IS DESTINATION          0Y01869 10521454
*                                        TSINPUT QCB            0Y01869 10522154
         BE    EOBTOBD                  YES - LOGON NOT         0Y01869 10522854
*                                        COMPLETED YET -        0Y01869 10523554
*                                        BYPASS TO STARTMH      0Y01869 10524254
TSO3705  EQU   *                                                        10525005
         NC    LCBTTCIN(2),LCBTTCIN     TTCIN ZERO?              S22029 10543022
         BZ    MHOK                     BRANCH YES               S22029 10546022
         BAL   R14,FNDTRM               GET TERMINAL ENTRY       S22029 10550022
         LR    R15,R1                   SAVE TERMINAL ENTRY      S22029 10560022
         LR    R1,RPREFIX               RESTORE BUFFER ADDRESS   S22029 10570022
         L     R15,AVTEZERO(R15)        GET DEST QCB ADDRESS     S22029 10580022
         USING IEDQQCB,R15              DESTINATION QCB BASE     S22029 10590022
         TM    QCBDSFLG,QCBALTMH        IS TERMINAL CONNECTED TO S22029 10600022
*                                       AN ALTERNATE MH          S22029 10610022
         BZ    MHOK                     NO - USE OWNING MH QCB   S22029 10620022
         L     R7,STARTMH               GET ALTMH QCB ADDRESS    S22029 10630022
MHOK     EQU   *                                                0Y01869 10640054
         IC    R2,AEINDX                OFFSET TO AE             S22029 10643022
         STC   R2,PRFKEY                SET IN PARM LIST         S22029 10646022
         DROP  R15                                               S22029 10650022
*                                                                       10800020
         CLI   PRFPRI,PRIAPBFR          GET SCHEDULER           SA56631 10900022
         BE    EOBTAA                   BRANCH YES                      11000020
*                                                                       11100020
         CLI   LCBRSKEY,DSPPUTSC        PUT SCHEDULER           SA56631 11200022
         BE    EOBTAA                   BRANCH YES                      11300020
*                                                                       11400020
         TM    LCBCHAIN,LCBABRTN        ABORT SEQUENCE SET              11500020
         BO    EOBTAA                   BRANCH YES - END OF MESSAGE     11600020
*                                                                       11700020
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING                 11800020
         BO    EOBSND                   BRANCH YES                      11900020
*                                                                S22025 11910022
         LH    R5,PRFXTRA+1             EOB OFFSET               S22025 11912022
         LTR   R5,R5                    EOB IN THIS BUFFER       S22025 11914022
         BZ    TESTBFMM                 BRANCH IF NO             S22025 11916022
*                                                                S22025 11918022
         TM    PRFSTAT1,PRFNHDRN        TEXT BUFFER              S22025 11920022
         BZ    SETEOB                   BRANCH NO, IT'S A HEADER S22025 11922022
*                                                                S22025 11924022
         L     R9,LCBDCBPT              DCB POINTER              S22025 11926022
         IC    R2,DCBRESER+1-IHADCB(,R9) TEXT RESERVES           S22025 11928022
         LA    R2,AVTTXTSZ(,R2)         COVER CASE WHERE EOB IS  S22025 11930022
*                                         AT LOGICAL ZERO OFFSET S22025 11932022
         CH    R2,PRFXTRA+1             NO DATA IN BUFFER        S22025 11934022
         BNE   SETEOB                   BRANCH IF NO             S22025 11936022
*                                                                S22025 11938022
         SR    R5,R5                    INDICATE ZERO EOB OFFSET S22025 11940022
         B     SETEOB                   SET EOB OFFSET           S22025 11942022
*                                                                S22025 11944022
TESTBFMM EQU   *                                                 S22025 11946022
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER            S22025 11948022
         BO    NOUPDATE                 BRANCH IF NOT HEADER     S22025 11950022
*                                                                S22025 11952022
         TM    SCBQTYPE,SCBBFMM         SET ZERO EOB OFFSET FOR  S22025 11954022
*                                         'HEADER' BUFFER IN MID S22025 11956022
*                                         MSG SITUATION          S22025 11958022
         BZ    NOUPDATE                 BRANCH NOT MID MSG       S22025 11960022
*                                                                S22025 11962022
SETEOB   EQU   *                                                 S22025 11964022
         STH   R5,SCBEOB                SET EOB OFFSET           S22025 11966022
         ST    RPREFIX,AVTDOUBL         SCRATCH SPACE            S22025 11968022
         MVC   SCBDEOB+1(3),AVTDOUBL+1  SET BUFFER ADDRESS FOR FAS22025 11970022
NOUPDATE EQU   *                                                 S22025 11972022
*                                                                       12000020
         TM    PRFSTAT1,PRFNLSTN        BUFFER MARKED LAST              12100020
         BO    EOBTAA                   BRANCH NO - WAIT FOR LAST       12200020
*                                                                       12300020
         TM    SCBERR1,SCBCUTFN         IS CUTOFF OPERATING             12400020
         BO    EOBTAA                   BRANCH YES - NO RETRY           12500020
*                                                                       12600020
         TM    LCBCSW+3,UNEX            EOT RECEIVED                    12700020
         BO    EOBTAA                   BRANCH YES - NO OPTIONS         12800020
*                                                                       12900020
         TM    SCBERR4,SCBTXTTN         TEXT ERROR                      13000020
         BO    EOBERR                     BRANCH YES                    13100020
*                                                                       13200020
         TM    SCBERR4,SCBSLCTN+SCBCONNN  ANY OTHER ERRORS              13300020
         BNZ   EOBTAA                   BRANCH YES - EXIT               13400020
*                                                                       13500020
         TM    FLAGS,LOGICAL+LOGICOP    IS LOGICAL CHECKING REQUESTED   13600020
         BZ    EOBNOL                     BRANCH NO                     13700020
*                                                                       13800020
         IC    R2,LOGOPT                OFFSET TO LOGICAL= OPTIONS      13900020
         BNO   STUPXT                   BRANCH IF OPTION FIELD NOT      14000020
*                                        SPECIFIED                      14100020
         BAL   R10,LOCSUB               LOCATE OPTION FIELD             14200020
*                                                                       14300020
         B     EOBNOL                   BAD RETURN                      14400020
*                                                                       14500020
         LA    R2,BUMPOPT(R2)           GET L/E ADDR OPT OFFSET@XA05300 14600056
STUPXT   EQU   *                                                        14700020
         BAL   R10,LOCSUB1              LOC L/E ADDR OPT FIELD @XA05300 14800056
*                                                              @XA05300 14900056
         LTR   R15,R15                  OPTION FIELD FOUND     @XA05300 15000056
         BNZ   EOBNOL                   BR NO                  @XA05300 15100056
*                                                                       15300020
*              SET UP TO EXIT TO USER ROUTINE                           15400020
         L     R15,0(R12)               USER EXIT ADDRESS               15500020
         LR    R1,R12                   PASS OPTION FIELD ADDRESS IN R1 15600020
         BALR  R14,R15                  BRANCH AND LINK TO USER         15700020
*                                                                       15800020
         CLI   0(R12),0                 IS SWITCH = 0                   15900020
         BE    EOBNOL                   CONTINUE                 S22025 16000022
*                                                                S22025 16010022
         CLI   0(R12),4                 RVI REQUEST              S22025 16020022
         BNE   CKSTPCNT                 BRANCH IF NO             S22024 16030022
*                                                                S22025 16040022
         OI    LCBMSGFM,LCBEOT          RVI REQUEST              S22025 16050022
         OI    PRFSTAT1,PRFNLSTN        SET NOT LAST BUFFER      S22025 16060022
         B     ABORT                    CONTINUE PROCESSING      S22025 16070022
*                                                                       16100020
EOBNOL   EQU   *                                                        16200020
         NI    LCBMSGFM,X'FF'-X'80'     INSURE ACK IS SENT              16300020
         TM    FLAGS,CONV+CONVOP        IS CONV= SPECIFIED              16400020
         BZ    NOCONV                     BRANCH NO                     16500020
*                                                                       16600020
         BNO   CHKLMD                   BRANCH IF UNCONDITONAL   S22025 16700022
*                                                                       16800020
         IC    R2,CONVOPT               POINTER TO CONV= OPTIONS        16900020
         BAL   R10,LOCSUB               LOCATE OPTION FIELD             17000020
*                                                                       17100020
         B     NOCONV                   BAD RETURN                      17200020
*                                                                       17300020
         B     CKBSC                    GOOD RETURN              S22025 17310022
CHKLMD   EQU   *                                                 S22025 17320022
         TM    AEINDX,LMD+LMDOP         LMD REQUIRED             S22025 17330022
         BZ    CKBSC                    NO-BR                    S22025 17340022
         BNO   EOBTAA                   UNCONDITOONAL            S22025 17350022
         IC    R2,LMDOPT                POINTER TO LMD OPTIONS   S22025 17360022
         BAL   R10,LOCSUB               LOCATE OPTIONS           S22025 17370022
         B     CKBSC                    BAD RETURN               S22025 17380022
         B     EOBTAA                   GOOD RETURN              S22025 17390022
CKBSC    EQU   *                                                        17400020
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PLCB           S22024 17420022
         BNE   CKBSC1                   NO, CHECK FOR BSC        S22024 17440022
         OI    LCBSTAT2,LCBRESP         SET RESPONSE OWED        S22024 17460022
CKBSC1   EQU   *                                                 S22024 17480022
         TM    LCBSTAT2,LCBSYNC         IS LINE BSC                     17500020
         BZ    EOBTAA                   BRANCH NO - END OF MESSAGE      17600020
*                                                                       17700020
         TM    SCBBSCFM,RCVETX          ETX RECEIVED                    17800020
         BO    EOBTAA                   BR YES                          17860020
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PLCB           S22024 17920022
         BNE   NOCONV                   NO, CONTINUE             S22024 18020022
         NI    LCBSTAT2,AVTEFF-LCBRESP  TURN OFF RESPONSE OWED   S22024 18120022
*                                                                       18400020
NOCONV   EQU   *                                                        18500020
         TM    AEINDX,LMD+LMDOP         LMD REQUIEED             S22025 18510022
         BZ    NOLMD                    NO-BR                    S22025 18520022
         BNO   EOBTAA                   UNCONDITONAL             S22025 18530022
         IC    R2,LMDOPT                POINTER TO LMD OPTIONS   S22025 18540022
         BAL   R10,LOCSUB               LOCATE OPTIONS           S22025 18545022
         B     NOLMD                    BAD   RETURN             S22025 18550022
         B     EOBTAA                   GOOD  RETURN             S22025 18560022
         SPACE 2                                                 S22025 18570022
NOLMD    EQU   *                                                 S22025 18580022
*                                                                       18600020
*              CONTINUE RECEIVING MESSAGE                               18700020
         TM    LCBCSW+3,UNEX            END OF MESSAGE RECEIVED         19100020
         BO    EOBTAA                     BRANCH YES                    19200020
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @YM09045 19230000
         BE    ACTKA                    BR YES                 @YM09045 19260000
*                                                                       19300020
         L     R2,LCBDCBPT              LOAD ADDR DCB            S99228 19309022
         USING IHADCB,R2                                         S99228 19315022
         SR    R1,R1                    CLEAR LENGTH REGISTER    S99228 19321022
         IC    R1,DCBEIOBX              INSERT LCB LENGTH        S99228 19327022
         SH    R1,AVTHA4                REDUCE LCB LENGTH BY     S99228 19333022
         SH    R1,AVTHA4                8 BYTES FOR ADDR LCB EXT S99228 19339022
         DROP  R2                                                S99228 19345022
         USING IEDQLCBX,R2                                       S99228 19351022
         LA    R2,ZERO(R1,RLCB)         LOAD LCB EXTENSION ADDR  S99228 19357022
         TM    LCBXFLAG,LCBGPCTV        GENERAL POLL IN PROGRESS?S99228 19363022
         DROP  R2                                                S22027 19372022
         BO    EOBTAA                  YES, POST BUFFERS TO MH   S22027 19381022
         SPACE                                                          19390022
         SR    R1,R1                    INDICATE END OF POST LIST       19400020
         NI    LCBMSGFM,X'FF'-X'80'     SET ACK TO BE SENT              19500020
         ST    RPREFIX,AVTADBUF         SAVE BFR ADDRESS       @XA09327 19518009
         CLC   AVTADBUF+1(3),LCBRECAD   THIS THE EOB BFR       @XA09327 19524009
         BE    ACTKA                    YES,DO READ CONTINUE   @XA09327 19530009
         ST    R7,PRFQCBA-1                                    @XA09327 19536009
         LR    R1,RPREFIX               SAVE BFR ADDRESS       @XA09327 19542009
         XC    PRFLINK,PRFLINK          CLEAR FOR POST         @XA09327 19548009
         SR    R10,R10                  CLEAR FOR IC           @XA09327 19554009
         IC    R10,PRFNBUNT             GET NO OF UNITS        @XA09327 19560009
NXTONE   L     RPREFIX,PRFTIC           GET NEXT UNIT          @XA09327 19566009
         BCT   R10,NXTONE               LOOP TO GET BFR ADDR   @XA09327 19572009
         STCM  RPREFIX,NZ,LCBLSPCI      SET LSPCI BFR          @XA09327 19578009
         ST    RPREFIX,LCBCPA+12        SET CONTINUE BFR       @XA09327 19584009
         OI    PRFSTAT1-IEDQPRF(R1),PRFNLSTN SET NOT LAST      @XA09327 19590009
ACTKA    EQU   *                                                        19600020
         NI    SCBERR4,X'FF'-SCBTXTTN   RESET TEXT ERROR                19700020
         OI    PRFSTAT1,PRFNLSTN        SET NOT LAST BUFFER             19800020
SETCONT  EQU   *                                                        19900020
         OI    LCBSTAT1,LCBCONT         SET CONTINUE FLAG               20000020
         MVC   LCBTTBIN(2),LCBTTCIN     SET UP TO BE CONNECTED          20100020
         LA    R2,AVTACTIB              ADDRESS OF I/O GENERATOR        20200020
         CLI   LCBFLAG1,AVTEZERO       IS THIS A PLCB            S22024 20210022
         BNE   NOT3705                 NO TPOST TO ACTIVATE      S22024 20220022
         L     R2,AVTSAVTP              ADDRESS OF SECONDARY AVT S22024 20230022
         USING IEDNSVTD,R2                                       S22024 20240022
         L     R2,SAVTCNIR              CONTROL NIR QCB ADDR   @Y17XANG 20250000
         SR    R1,R1                    SET END OF POST LIST     S22024 20260022
NOT3705  EQU   *                                                        20270022
         ST    R2,PRFQCBA-1             SET QCB ADDRESS                 20300020
         ST    R1,PRFLINK-1             LINK ELEMENTS                   20400020
         MVI   PRFPRI,PRIDKEOB          SET PRIOITY              S22025 20500022
         LR    R1,RPREFIX               POST BUFFER TO ACTIVATE         20600020
         BAL   R14,DSPCHAIN             EXIT TO DISPATCHER     @Y17XAMX 20700000
*                                                                       20800020
CKNORTY  EQU   *                                                        20830020
         TM    LCBCHAIN,LCBNORTY        IS NO RETRY FLAG SET            20860020
CKSTPC   EQU   *                                                        20900020
         BO    EXIT                   EXIT IF NO RETRY SITUATION        21000020
*                                                                       21100020
         MVI   LCBINCAM,ZERO            CLEAR RETRY COUNTER             21200020
CKSTPCNT EQU   *                                                S22024  21300022
         BAL   R9,STOPCONT              GO CHECK STOP/CONT      SA68245 22200005
         B     NOCONV                   CONTINUE MESSAGE RECEPTION      23100020
*                                                                       23200020
*                                       TREAT AS END OF MESSAGE         23300020
ABORT    EQU   *                                                        23400020
         OI    LCBCHAIN,LCBABRTN        SET ABORT FLAG FOR KA           23500020
         SR    R1,R1                    SET END OF POST LOST            23600020
         B     SETCONT                  SET CONTINUE FLAG AND POST TO   23700020
*                                       IEDQKA                          23800020
EXIT     EQU   *                                                        23830020
         NI    LCBCHAIN,X'FF'-LCBNORTY  TURN OFF NO RETRY FLAG          23860020
EOBTAA   EQU   *                                                        23900020
         CLI   LCBFLAG1,AVTEZERO        3705 LCB?                       23910005
         BNE   OXPOWER                  BRANCH YES                      23920005
         SLDL  R2,64                    CLEAR WORK REGISTERS            23930005
         L     R7,LCBDCBPT              LOAD DCB ADDRESS                23940005
         IC    R1,DCBRESER+1-IHADCB(,R7)  INSERT NUMBER RESERVES        23950005
         LA    R2,AVTTXTSZ(,R2)         SET TEXT PREFIX SIZE            23960005
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER?                  23970005
         BO    TEXBUF                   BRANCH NO                       23980005
         LA    R2,AVTHDRSZ-AVTTXTSZ(,R2)  SET HEADER PREFIX SIZE        23990005
         IC    R1,DCBRESER-IHADCB(,R7)  GET HEADER RESERVES             24000005
TEXBUF   EQU   *                                                        24010005
         LA    R2,ZERO(R1,R2)           SET SIZE PREFIX AND RESERVES    24020005
         STC   R1,LCBISZE               SET RESERVES COUNT IN LCB       24030005
         CH    R2,PRFSIZE               NULL BUFFER?                    24040005
         BE    SETCONT                  BRANCH YES                      24050005
OXPOWER  EQU   *                                                        24060005
         TM    SCBSTATE,SCBPRER         HA2 A TEXT ERROR OCCURRED       24100020
         BZ    EOBTOBD                  BRANCH NO PREVIOUS ERROR        24200020
*                                                                       24300020
         OI    SCBERR4,SCBTXTTN         SET TEXT ERROR BIT              24400020
EOBTOBD  EQU   *                                                        24700020
         L     R7,LCBDCBPT              DCB POINTER              S22029 24730022
         L     R7,DCBMH-1-IHADCB(,R7)   MH QCB POINTER           S22029 24760022
         CLI   LCBFLAG1,LCBPLCB         THIS A PLCB            @YM06085 24768000
         BNE   GOTMH                    BR NO, HAVE PROPER MH  @YM06085 24776000
         L     R7,LCBMHA-1              GET PROPER MH QCB      @YM06085 24784000
GOTMH    EQU   *                                               @YM06085 24792000
         LR    R1,RPREFIX               RESTORE ELEMENT (BUFFER)        24800020
         L     R3,MHROUT-1              ADDRESS OF STARTMH STCB         24900020
         B     DSPBYPAS                 BYPASS TO STARTMH SUBTASK       25000020
*                                                                       25100020
         EJECT                                                          25200056
*        LOCATE OPTION FIELD SUBROUTINES                       @XA05300 25300056
         SPACE 2                                                        25400020
LOCSUB   EQU   *                                                        25500020
         IC    R5,OPTION(R2)            OPTION FIRLD POINTER            25600020
         STC   R5,PRFQCBA+1             SET IEDQAE PARAMETER LIST       25700020
         MVI   PRFQCBA,FOUR             SET UP PARMLIST LENGTH @OZ31599 25730086
         MVI   PRFQCBA+BUMPOPT,REGOF    SET UP RETURN REG=12   @OZ31599 25760086
         ST    RPREFIX,AVTADBUF         SET BUFFER ADDRESS FOR IEDQUI   25800020
         LR    R1,RPREFIX               RESTORE PARAMETER LIST          25900020
         L     R15,AVTUI                ADDRESS OF IEDQUI               26000020
         BALR  R14,R15                  BRANCH AND LINK TO LOCOPT       26100020
*                                                                       26200020
         LTR   R15,R15                  WAS FIELD FOUND                 26300020
         BCR   7,R10                    BRANCH NO - BAD RETURN          26400020
*                                                                       26500020
         IC    R5,OPTION+1(R2)          SWITCH TO REGISTER FOR CLI      26600020
         EX    R5,CLOPT                 IS OPTION FIEL EQUAL TO SWITCH  26700020
         BCR   8,R10                    BRANCH ZERO - BAD RETURN        26800020
*                                                                       26900020
         B     4(R10)                   RETURN TO CALLER                27000020
*                                                                       27100020
CLOPT    TM    0(R12),0                 TEST OPTION FIELD BITS          27200020
*                                                                       27300020
*                                                              @XA05300 27309056
LOCSUB1  EQU   *                                               @XA05300 27318056
         IC    R5,OPTION(R2)            GET OPTION FIELD INDEX @XA05300 27327056
         STC   R5,PRFQCBA+ONE           PUT IT IN AE PARM LIST @XA05300 27336056
         MVI   PRFQCBA,FOUR             SET UP PARMLIST LENGTH @OZ31599 27339086
         MVI   PRFQCBA+BUMPOPT,REGOF    SET UP RETURN REG=12   @OZ31599 27342086
         ST    RPREFIX,AVTADBUF         SET BFR ADDR FOR UI    @XA05300 27345056
         LR    R1,RPREFIX               SET PARM LIST REGISTER @XA05300 27354056
         L     R15,AVTUI                ADDR OF UI             @XA05300 27363056
         BALR  R14,R15                  GO LOCATE OPTION FIELD @XA05300 27372056
*                                                              @XA05300 27381056
         BR    R10                      RETURN TO CALLER       @XA05300 27390056
         EJECT                                                          27400020
*        EOB/ETB RETRY ON RECEIVE                                       27500020
         SPACE 3                                                        27600020
EOBERR   EQU   *                                                        27700020
         CLI   LCBFLAG1,AVTEZERO       IS THIS A PSEUDO LCB      S22024 27730022
         BE    CKSTPCNT                 YES, CHECK STOP/CONT    S22024  27760022
         LA    R10,RCVRTY               SET RETURN ADDRESS              27800020
         TM    LCBSTAT1,LCBINITN        RECEIVING INITIATE MODE         27830020
         BO    CKNORTY                  BRANCH YES - CHECK NO RETRY     27860020
*                                                                       27868020
*                                                                       27892020
CKRTRY   EQU   *                                                        27900020
*                                                                       28300020
         TM    LCBCHAIN,LCBNORTY        NO RETRY FLAG SET               28400020
         BCR   1,R10                    BRANCH YES - END OF MESSAGE     28500020
*                                                                       28600020
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION ERROR     A44885 28630021
         BCR   1,R10                    YES, BRANCH EOM          A44885 28660021
         CLI   LCBINCAM,MAX             HAS RETRY COUNT BEEN EXHAUSTED  28700020
         BCR   8,R10                    BRANCH IF RETRY EXHAUSTED       28800020
*                                                                       28900020
         IC    R9,LCBINCAM              PICK UP RETRY COUNT             29000020
         LA    R9,UNEX(,R9)             ADD ONE                         29100020
         STC   R9,LCBINCAM              STORE BACK                      29200020
         B     FOUR(R10)                RETURN TO CALLER                29300020
RCVRTY   EQU   *                                                        29400020
         B     CKSTPC                   CHECK IF RETRY COUNT EXHAUSTED  29500020
*                                                                       29600020
         LA    R10,LCBERB               ERB ADDRESS                     29700020
         TM    LCBERBST,LCBDLNKN        IS DLINK SWITCH SET             29800020
         BO    ERBFRE                   BRANCH NOT IN CHAIN             29900020
*                                                                       30000020
         LA    R9,AVTBFRTB-4            BUFFER RETURN QCB               30100020
*        RTN Q AND READY QUEUE.                                         30160020
*                                                                       30200020
NEXT     EQU   *                                                        30300020
         LR    R12,R9                   SET TO NEXT ELEMENT             30400020
         L     R9,4(0,R12)              FIRST/NEXT ELEMENT IN CHAIN     30500020
         LA    R9,0(0,R9)               CLEAR HIGH ORDER BYTR           30600020
         CLR   R9,R10                   IS THIS THE ERB                 30700020
         BE    REMOVERB                 BR IF ERB FOUND                 30720020
         C     R9,AVTDELAD              IS THIS THE DUMMY END           30740020
*        ELEMENT - IF YES THIS IS END OF THIS CHAIN.                    30760020
         BNE   NEXT                     BR NOT END OF CHAIN             30780020
         LA    R9,AVTREADY-4            ADDRESS OF READY Q FOR LOOP     30800020
         B     NEXT                     SEARCH READY QUEUE      SA63640 30820005
REMOVERB EQU   *                                                        30840020
*                                                                       30900020
         MVC   5(3,R12),5(R9)           REMOVE ERB FROM CHAIN           31000020
*                                                                       31100020
         OI    LCBERBST,LCBDLNKN        SET ERB POSTABLE                31200020
ERBFRE   EQU   *                                                        31300020
         OI    LCBMSGFM,X'80'           SET NAK BIT                     31400020
         SR    R12,R12                  CLEAR ELEMENT LINK REG          31500020
         LA    R9,AVTBFRTB              ADDRESS OF BUFFER RETURN        31600020
         L     R10,SCBDESTQ-1           DESTINATION OF THIS MESSAGE     31700020
         LA    R10,ZERO(,R10)           CLEAR HIGH ORDER                31800020
         CLR   R9,R10                   DESTINATION = BUFFER RETURN     31900020
         BE    ABORT                    BRANCH YES - END OF MESSAGE     32000020
*                                                                       32100020
         TM    SCBERR3,SCBLOSTN         WAS MESSAGE LOST                32200020
         BO    ABORT                    BRANCH YES                      32300020
*                                                                       32400020
         SR    R1,R1                    CLEAR FOR ERB LINK FIELD S22025 34000022
         IC    R9,LCBERBCT              PICK UP COUNT                   34100020
         AH    R9,LCBERBCT              ADD OTHER ONE BYTE COUNTER      34200020
         STC   R9,LCBCPA+16             SAVE IN LCB                     34300020
         LA    R9,D256                  CONSTANT FOR RECALL             34400020
         MVC   LCBCPA+17(7),SCBDNSEG    SAVE DNSEG AND CLSEG            34420020
         SPACE 2                                                        34430022
*        FOR THE CASE OF CANCELLED MESSAGES AND THEY WILL NOT           34440020
*        BE RESET - THE BUFFER MUST BE ADDED TO THE PRESENT CHAIN       34460020
         SPACE 2                                                        34480022
         MVI   SCBDEOB,ZERO             CLEAR INSERT OFFSET FOR RECALL  34500020
         NC    SCBDEOB+1(3),SCBDEOB+1   WAS THERE A PREVIOUS EOB        34600020
         BNZ   RECALL1                  BRANCH YES                      34700020
*        RECALL THE HEADER BUFFER                                       34800020
*                                                                       34900020
         OI    LCBCHAIN,LCBNORTY        SET FLAG FOR RECALL ENTRY       35000020
         MVC   SCBDEOB+1(3),SCBCCHDR    CORE ADDRESS OF HEADER          35100020
         TM    SCBQTYPE,SCBREUS+SCBNREUS  IS MESSAGE VORE QUEUED        35200020
         BZ    RECALL1                  BRANCH YES                      35300020
*                                                                       35400020
         MVC   SCBDEOB+1(3),SCBDCHDR    DISK ADDRESS OF HEADER          35500020
         B     RECALL1                  RECALL SEGMENT                  35600020
*                                                                       35700020
*   RETURN HERE WITH RECALLED BUFFER                                    35800020
SETRCV   EQU   *                                                        35900020
         L     R2,SCBDESTQ-1            DEST Q ADDR                     35920020
         MVZ   SCBQTYPE,QCBDSFLG-IEDQQCB(R2)   RSTORE QTYPE             35940020
         TM    SCBQTYPE,SCBREUS+SCBNREUS  ANY DISK QUEUEING             35945020
         BZ    NOXI                    BRANCH NO                        35950020
*                                                                       35955020
         XI    SCBQTYPE,SCBREUS+SCBNREUS   BITS ARE REVERSED            35960020
NOXI     EQU   *                                                        35980020
         MVC   SCBDNSEG(7),LCBCPA+17    RESET DNSEGAND CLSEG     S22025 36000022
         NC    LCBERBCH(3),LCBERBCH     HAS THE ERB BEEN POSTED SA63962 36100052
*        SINCE THE RECALL WAS DONE                              SA63962 36200052
         BZ    RESETSCB                 BR YES - SCBDESTQ CAN   SA63962 36300052
*                                       CAN BE RESET NOW        SA63962 36400052
         NI    PRFSTAT1,X'FF'-PRFDUPLN  RESET DUPL              SA63962 36500052
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER         37000020
         BO    HDROK                    BRANCH IF NOT A HEADER          37100020
         LR    R1,RPREFIX               FOR POSTING              S22025 37200022
         MVI   PRFPRI-IEDQPRF(R1),PRIDESTQ-1 SET PRIORITY SO THATS22025 37280022
*                                         A CANCEL BUFFER REACHESS22025 37360022
*                                         FA BEFORE RECALLED BUF S22025 37440022
*                                         GETS TO HM             S22025 37520022
         BAL   R14,POSTLIST             ADD TO POST LIST         S22025 37600022
         TM    LCBCHAIN,LCBNORTY        FIRST EOB                S22025 37680022
         BZ    PREVEOB                  BRANCH NO                S22025 37760022
*                                                                S22025 37840022
         MVI   PRFSTAT1-IEDQPRF(R1),PRFCNCLN+PRFNHDRN SET TO CANCS22025 37920022
         XC    LCBERBCH(3),LCBERBCH     CLEAR FOR FLAG          SA63962 37923052
         OI    LCBSTAT1,LCBRCLLN        SET RECALL FLAG TO      SA63962 37926052
*        CAUSE THE ERB TO FOLLOW THE SAME PATH AS WITH A        SA63962 37929052
*        RECALLED BUFFER                                        SA63962 37932052
         LA    R1,LCBERB                REPOST THE REB TO BT TO SA63962 37935052
*        ALLOW THE CANCELLED BFR TO BE Q'D BEFORE DESTQ IS RESETSA63962 37938052
         MVC   LCBERBLK(3),AVTPARM+ONE  ADD POST LIST TO ERB    SA63962 37941052
         BAL   R14,DSPCHAIN             EXIT TO DISPATCHER     @Y17XAMA 37944000
RESETSCB EQU   *                                                SA63962 37947052
*        THE ERB WILL RETURN HERE AFTER THE SECOND POST         SA63962 37950052
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN  IS THIS IS EXTENDED  SA63962 37953052
*        LOCK, DO NOT RESET SCBDESTQ OR THE LOCK FLAGS          SA63962 37956052
         BM    NODESTQ                  BR IF EXTENDED LOCK     SA63962 37959052
*        THE SCB MUST BE SET UP TO LOOK LIKE A NEW TRANSMISSION SA63962 37962052
         NI    SCBSTATE,X'FF'-(SCBLCK1N+SCBMSGLN+SCBPRER)       SA63962 37965052
*        CLEAR ALL LOCK FLAGS AND RESET THE MULTI RTE CKPT      SA63962 37968052
         LA    R14,AVTBFRTB             ADDRESS OF BUFFER RTN   SA63962 37971052
         IC    R1,SCBDESTQ-ONE          SET DESTQ TO BFRTN      SA63962 37974052
         ST    R14,SCBDESTQ-ONE         FOR CASE OF INVALID     SA63962 37977052
         STC   R1,SCBDESTQ-ONE          FORWARD ON NEW HDR      SA63962 37980052
NODESTQ  EQU   *                                                SA63962 37983052
         XC    SCBMRFSD(L'SCBMRFSD+L'SCBDLPTR),SCBMRFSD         SA63962 37986052
*        CLEAR MULTI ROUTE AND DLIST INDICATORS                 SA63962 37989052
         XC    SCBERR1(2),SCBERR1       CLEAR LOGICAL ERRORS     S22025 38000022
         NI    SCBSTATE,X'FF'-SCBCODE   RESET CODE BIT TO PREVENTS22025 38080022
*                                         DOUBLE HDR TRANSLATE   S22025 38160022
         XC    SCBDEOB+1(3),SCBDEOB+1   INDICATE NO PREVIOUS EOB        38300020
*    DECREMENT SEQUENCE NUMBER                                          38400020
*                                       IF ONLY EOT RECEIVED            38460020
         TM    SCBSTATE,SCBSEQIN        WAS SEQUENCE IN UPDATED         38500020
         BZ    BLDCCW                   BRANCH NO                S22025 38600022
*                                                                       38700020
         NI    SCBSTATE,X'FF'-SCBSEQIN   RESET FLAG                     38800020
         BAL   R14,FNDTRM               GET TERMINAL TABLE ENTRY        38900020
*                                                                       39000020
         LH    R14,TRMINSEQ-IEDQTRM(R1)  INPUT SEQUENCE #               39100020
         BCT   R14,NOTZRO               DECREMENT AND BRANCH IF NOT 0   39200020
*                                                                       39300020
         LH    R14,DC9999               RESET TO MAXIMUM                39400020
NOTZRO   EQU   *                                                        39500020
         STH   R14,TRMINSEQ-IEDQTRM(R1)  RESET                          39600020
         B     BLDCCW                   BUILD HEADER BUFFER      S22025 39630022
         EJECT                                                          39660022
PREVEOB  EQU   *                                                        39700020
*        LAST GOOD EOB WAS IN HEADER BUFFER.  WE WANT TO CANCEL  S22025 39800022
*  THE MESSAGE AND POST RECALLED BUFFER BACK TO DESTINATION QUEUES22025 39830022
*  WITH PRFSIZE ADJUSTED TO REFLECT CHECKED DATA.                S22025 39860022
         SPACE 2                                                        39870022
         MVC   PRFSIZE-IEDQPRF(2,R1),SCBEOB       GET NEW SIZE   S22025 39890022
         SR    R14,R14                  CLEAR A SIZE REGISTER    S22025 39892022
         IC    R14,PRFSCAN-IEDQPRF(R1)  GET THE SCAN POINTER     S22025 39894022
         CH    R14,PRFSIZE-IEDQPRF(R1)  IS PRFSCAN GREATER THAN  S22025 39896022
*                                         PRFSIZE                S22025 39898022
         BNH   ERRBUF                   NO, BRANCH               S22025 39900022
         SPACE 2                                                        39902022
         LH    R14,SCBEOB               GET THE EOB OFFSET       S22025 39904022
         LA    R14,ONE(R14)             INCREMENT BY 1           S22025 39906022
         STC   R14,PRFSCAN-IEDQPRF(R1)  RESET THE SCAN POINTER   S22025 39908022
ERRBUF   EQU   *                                                 S22025 39910022
         L     RPREFIX,LCBLSPCI-1       GET ERROR BUFFER         S22025 39920022
         BAL   R1,GETBUF                ADDRESS OF LAST UNIT OF  S22025 39950022
         L     R1,LCBLSPCI-1            BUFFER TO UPDATE LSPCI   S22025 39980022
         MVC   LCBLSPCI,PRFTIC+1        NEXT ASSIGNED BUFFER     S22025 40010022
         MVI   PRFSTAT1-IEDQPRF(R1),PRFCNCLN+PRFNHDRN SET STATUS S22025 40040022
*                                         TO CANCEL MSG          S22025 40070022
         MVI   PRFPRI-IEDQPRF(R1),PRIDESTQ SET PRIORITY          S22025 40100022
         BAL   R14,POSTLIST             ADD BUFFER TO CANCEL MSG S22025 40130022
         OC    LCBLSPCI(2),LCBLSPCI     DO WE HAVE BUFFER FOR    S22025 40160022
*                                         RETRY                  S22025 40190022
         BNZ   BLDCCW                   BRANCH IF YES            S22025 40220022
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S22025 40250022
*                                                             *  S22025 40270022
*        IT IS POSSIBLE THAT A BUFFER IS NOT AVAILABLE        *  S22025 40290022
*        FOR RETRY.  THE ERB COULD HAVE BEEN HUNG ON THE      *  S22025 40310022
*        BUFFER RETURN QUEUE WAITING FOR BUFFERS WHEN         *  S22025 40330022
*        THE ERROR BUFFER WAS POSTED TO MH.                   *  S22025 40350022
*                                                             *  S22025 40370022
*        THE FOLLOWING CODE WILL POST THE ERB TO REQUEST      *  S22025 40390022
*        AN ADDITIONAL BUFFER WHICH WILL BE USED TO RETRY     *  S22025 40410022
*                      THE ERROR BLOCK                        *  S22025 40430022
*                                                             *  S22025 40450022
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S22025 40470022
         L     R2,LCBDCBPT              GET THE DCB ADDRESS      S22025 40580022
         LA    R9,D256                  TO REQUEST ONE BUFFER    S22025 40610022
         IC    R9,DCBUNTCT-IHADCB(,R2)  GET THE NUMBER OF UNITS  S22025 40640022
*                                         PER BUFFER             S22025 40670022
         OI    LCBERBST,LCBPRCPG        SET THE ERB STATUS       S22025 40700022
         LA    R2,AVTBFREB              GET THE ADDRESS OF       S22025 40730022
*                                         BUFFER REQUEST         S22025 40760022
         MVI   LCBERBPY,PRIINTRQ        SET THE ERB PRIORITY     S22025 40790022
         MVC   LCBERBLK,AVTPARM+1       ADD POST LIST            S22025 40820022
         B     POSTERB                  POST ERB AND POST LIST   S22025 40850022
         SPACE 3                                                 S22025 40880022
GOTBUF   EQU   *                        WHEN BUFFER IS OBTAINED  S22025 40910022
         NI    LCBERBST,X'FF'-LCBPRCPG  RESET ERB STATE          S22025 40940022
         MVC   LCBLSPCI,LCBERBCH        SET BUFFER TO LCB CHAIN  S22025 40970022
         B     BLDCCW                   BUILD BUFFER FOR RETRY   S22025 41000022
         EJECT                                                          41030022
HDROK    EQU   *                                                        41300020
         MVI   AVTDOUBL,ZERO            CLEAR FOR LTR                   41700020
*        TO FORCE THIS BFR TO BE ADDED TO THE END OF THIS MSG           41860020
         L     R9,SCBCCHDR-1            ADDR OF HDR                     41930020
         TM    SCBQTYPE,SCBREUS+SCBNREUS  DISK QUEUEING OR BACKUP       42000020
         BZ    NXTBFR                   BRANCH NO                       42100020
*                                                                       42200020
         MVC   SCBDNSEG,PRFCRCD         SET SCB TO LAST GOOD EOB        42300020
         TM    SCBQTYPE,SCBCOREQ        CORE QUEUEING                   42400020
         BZ    POSTBACK                 BRANCH NO                S22025 42500022
*                                                                       42600020
         LA    R9,0(R9)                 CLEAR HI ORDER BYTE    @SA70682 42650056
         LTR   R9,R9                    CORE COPY LOST         @SA70682 42700056
         BZ    POSTBACK                 BRANCH YES             @OY20146 42750086
         TM    PRFKEY-IEDQPRF(R9),X10   IS CORE COPY LOST               42800020
         BO    POSTBACK                 BRANCH YES             @OY20146 43000086
         LA    RPREFIX,PRFCRCD-PRFCORE(RPREFIX)   FOR DISK BACKUP - SET 43010020
*        TO COMPARE THE PRFCRCD FIELD OF R6 INSTEAD OF PRFCORE          43020020
         LA    R10,PRFCRCD-PRFCORE      SET TO USE CRCD FOR CLC         43025020
         B     NXTBFRA                  NO UPDATE TO DEOB IF DISK       43030020
*        BACKUP - DEOB HAS THE CORRECT DISK ADDRESS                     43060020
*                                                                       43100020
*                                                                       43200020
NXTBFR   EQU   *                                                        43300020
         SR    R10,R10                  SET TO USE PRFCORE FOR CLC      43310020
NXTBFRA  EQU   *                                                        43380020
         LA    R1,0(R10,R9)             SET FOR CORRECT CLC             43400020
         CLC   PRFCORE,PRFCORE-IEDQPRF(R1)  IS THIS = RECALL            43420020
         BE    NXTBFRB                  BR IF THIS IS THIS RECALL       43460020
         MVC   SCBCLSEG(3),PRFCORE-IEDQPRF(R9)   LAST BFR ADDR          43500020
         MVC   AVTDOUBL+1(3),PRFNTXT-IEDQPRF(R9)   TO FULL WORD         43540020
         L     R9,AVTDOUBL              ADDR OF NEXT BFR                43580020
         B     NXTBFRA                  REPEAT CHECK FOR RECALL  S22025 43620022
NXTBFRB  EQU   *                                                        43660020
         L     R9,SCBCLSEG-1            ADDR OF LAST BFR IN Q           43700020
         L     RPREFIX,LCBERBCH-1       RESTORE BFR ADDR                43740020
         MVC   AVTDOUBL+1(3),PRFNTXT-IEDQPRF(R9)  NEXT NEXT ADDRESS     43790020
         L     R10,AVTDOUBL            FIRST UNIT TO BE FREED           43840020
         XC    PRFNTXT-IEDQPRF(3,R9),PRFNTXT-IEDQPRF(R9)  CLEAR NEXT    43900020
*                                       TEXT POINTER                    44000020
         LR    R1,R10                   SET FOR POST                    44200020
         SR    R5,R5                                                    44300020
NXTB     EQU   *                                                        44400020
         LR    R12,R10                  SAVE BUFFER ADDRESS             44500020
         SR    R9,R9                                                    44600020
         IC    R9,PRFNBUNT-IEDQPRF(R10)  NUMBER OF UNITS                44700020
         AR    R5,R9                    KEEP TOTAL COUNT                44800020
         BAL   R14,NXTUNT               KEEP @ OF LAST UNIT IN BFR      44900020
*                                                                       45000020
         L     R10,PRFTIC-IEDQPRF(R10)  NEXT UNIT ADDRESS               45100020
NXTUNT   EQU   *                                                        45200020
         BCTR  R9,R14                   GET NEXT UNIT                   45300020
*                                                                       45400020
         MVC   AVTDOUBL+1(3),PRFNTXT-IEDQPRF(R12)  TO FULL WORD         45500020
         MVC   PRFTIC+1-IEDQPRF(3,R10),AVTDOUBL+1  CHAIN NEXT BUFFER    45600020
*                                       TO LAST UNIT OF PREVIOUS        45700020
         L     R10,AVTDOUBL             ADDRESS OF NEXT BUFFER          45800020
         LTR   R10,R10                  END OF CHAIN                    45900020
         BNZ   NXTB                     BRANCH NO                       46000020
*                                                                       46100020
         STC   R5,PRFNBUNT-IEDQPRF(R1)    SET NUMBRR OF UNITS           46200020
         L     R2,AVTCADDR              GET MSUNIT COUNT       @OZ33243 46300086
         SR    R2,R5                    SUBTRACT OUT AVAILABLE @OZ32243 46350086
         ST    R2,AVTCADDR              STORE UPDATED COUNT    @OZ33243 46400086
         LA    R2,AVTBFRTB              BUFFER RETURN QCB      @OZ33243 46450086
         MVI   PRFPRI-IEDQPRF(R1),PRIBFRTB  SE\ PRIORITY                46700020
         BAL   R14,POSTLIST             ADD TO POST LIST         S22025 46800022
*                                                                S22025 46820022
POSTBACK EQU   *                                                 S22025 46840022
         L     R1,LCBERBCH-1            RECALLED BUFFER          S22025 46860022
         MVI   PRFPRI-IEDQPRF(R1),PRIDESTQ SET PRIORITY          S22025 46880022
         L     R2,SCBDESTQ-1            DESTINATION QUEUE        S22025 46900022
         MVC   PRFSIZE-IEDQPRF(2,R1),SCBEOB SET SIZE TO REFLECT  S22025 46920022
*                                         CHECKED DATA           S22025 46940022
         SR    R14,R14                  CLEAR A SIZE REGISTER    S22025 46941022
         IC    R14,PRFSCAN-IEDQPRF(R1)  GET THE SCAN POINTER     S22025 46942022
         CH    R14,PRFSIZE-IEDQPRF(R1)  IS PRFSCAN GREATER THAN  S22025 46943022
*                                         PRFSIZE                S22025 46944022
         BNH   CLEAREG                  NO, BRANCH               S22025 46945022
         SPACE 2                                                        46946022
         LH    R14,SCBEOB               GET THE EOB OFFSET       S22025 46947022
         LA    R14,ONE(R14)             INCREMENT BY 1           S22025 46948022
         STC   R14,PRFSCAN-IEDQPRF(R1)  RESET THE SCAN POINTER   S22025 46949022
CLEAREG  EQU   *                                                 S22025 46950022
         SR    R5,R5                    CLEAR FOR COMPARE        S22025 46960022
         CH    R5,SCBEOB                NO DATA IN BUFFER        S22025 46980022
         BE    BFRRTN                   YES, RETURN BUFFER     @OS79713 47000000
         L     RPREFIX,LCBDCBPT         DCB BASE               @OS79713 47001000
         TM    PRFSTAT1-IEDQPRF(R1),PRFNHDRN  HEADER BUFFER    @OS79713 47002000
         BNO   HDRBFR                   BRANCH YES             @OS79713 47003000
         IC    R5,DCBRESER+1-IHADCB(RPREFIX)  TEXT RESERVES    @OS79713 47004000
         LA    R5,AVTTXTSZ(,R5)         PLUS TEXT PREFIX SIZE  @OS79713 47005000
         B     COMPARE                  GO CHECK AGAINST EOB   @OS79713 47006000
HDRBFR   EQU   *                                               @OS79713 47007000
         IC    R5,DCBRESER-IHADCB(RPREFIX)  HEADER RESERVES    @OS79713 47008000
         LA    R5,AVTHDRSZ(,R5)         PLUS HEADER PREFIX SIZE@OS79713 47009000
COMPARE  EQU   *                                               @OS79713 47010000
         CH    R5,SCBEOB                LOGICALLY EMPTY BFR    @OS79713 47011000
         BL    POSTDEST                 BRANCH IF NOT TO POST  @OS79713 47012000
BFRRTN   EQU   *                                               @OS79713 47013000
*                                                                S22025 47020022
         LA    R2,AVTBFRTB              BUFFER RETURN            S22025 47040022
POSTDEST EQU   *                                                 S22025 47060022
         BAL   R14,POSTLIST             ADD TO POST LIST         S22025 47080022
*                                                                S22025 47100022
BLDCCW   EQU   *                                                 S22025 47120022
         L     RPREFIX,LCBLSPCI-1       GET RETRY BUFFER         S22025 47140022
         MVC   LCBERBCT(1),LCBCPA+16    RESET ORIGIANL BUFF CNT  S22025 47160022
         MVI   LCBERBCT+1,AVTEZERO      CLEAR SECOND BYTE        S22025 47180022
         L     R2,LCBDCBPT              DCB BASE                 S22025 47200022
         LH    R9,DCBBUFSI-IHADCB(R2)   BUFFER SIZE              S22025 47220022
         SR    R5,R5                    PRESET EOB OFFSET        S22025 47240022
         STH   R5,SCBEOB                SCBEOB                   S22025 47260022
         IC    R5,DCBRESER-IHADCB(R2)   ASSUME HEADER BUFFER     S22025 47280022
         STC   R5,LCBISZE               SET IDLES FOR HEADER     S22025 47300022
         LA    R12,AVTHDRSZ(R5)         HEADER PREFIX+ IDLES     S22025 47320022
         NI    PRFSTAT1,PRFNHDRF        SET TO HEADER BUFFER     S22025 47340022
         TM    LCBCHAIN,LCBNORTY        FIRST EOB IN BUFFER      S22025 47360022
         BO    ITSHDR                   YES, IT'S A HEADER       S22025 47380022
*                                                                S22025 47400022
         MVC   SCBDEOB+1(3),LCBLSPCI    SET NEW DEOB             S22025 47420022
         IC    R5,DCBRESER+1-IHADCB(R2) GET TEXT RESERVES        S22025 47440022
         LA    R12,AVTTXTSZ(R5)         TEXT PREFIX+IDLES        S22025 47460022
         OI    PRFSTAT1,PRFNHDRN        SET AS TEXT BUFFER       S22025 47480022
*                                                                S22025 47500022
ITSHDR   EQU   *                                                 S22025 47520022
         STH   R12,PRFSIZE              SET PREFIX SIZE          S22025 47540022
         IC    R5,PRFNBUNT              UNIT COUNT IN BUFFER     S22025 47560022
         MVI   PRFFLAGS,AVTEZERO        CLEAR CCW FLAGS          S22025 47580022
         TM    DCBPCI-IHADCB(R2),RCVPCI  PCI SPECIFIED           S22025 47600022
         BZ    NOPCI                    BRANCH IF NO             S22025 47620022
*                                                                S22025 47640022
         OI    PRFFLAGS,CCWPCI          SET CCW FLAG             S22025 47660022
NOPCI    EQU   *                                                 S22025 47680022
         LH    R2,DCBBUFSI-IHADCB(R2)   BUFFER SIXE                     48000020
         N     R2,AVTCLRHI              CLEAR HIGH ORDER HALF           48100020
         LH    R1,AVTKEYLE              UNIT SIZE                       48200020
         LH    R12,PRFSIZE              CCW OFFSET TO LAST EOB   S22025 48300022
         N     R12,AVTCLRHI             CLEAR HIGH ORDER HALF           48400020
         BAL   R9,BUMPUNT               CONTINUE SETTING UP BUFR S22025 48500022
*                                                                       48600020
         L     RPREFIX,PRFTIC           NEXT UNIT                       48700020
         SR    R2,R1                    DECREMENT BUFFER SIZE           48800020
BUMPUNT  EQU   *                                                        48900020
         BCTR  R5,0                     DECREMENT UNIT COUNT            49000020
         SR    R12,R1                   SUBTRACT UNIT SIZE              49100020
         BCR   11,R9                    BRANCH IF RESULT NEGATIVE       49200020
*                                                                       49300020
         AR    R12,R1                   ADD BACK UNIT SIZE              49400020
         LA    R14,PRFSUNIT(R12)        NEXT DATA BYTE                  49500020
         ST    R14,PRFIOADR-1           SET CCW ADDRESS                 49600020
         BAL   R10,CCWST1               COMMON CODE TO SET CCW'S        49700020
*                                                                       49800020
         LA    RPREFIX,0(,RPREFIX)      CLEAR FOR STORE                 49900020
         ST    RPREFIX,LCBCPA+12        SET FOR I/O GEN                 50000020
         LR    R14,R1                   CALCULATE COUNT                 50100020
         SR    R14,R12                                                  50200020
         STH   R14,PRFCOUNT             SET CCW COUNT                   50300020
         LR    R9,RPREFIX               SAVE BUFFER ADDRESS             50400020
         LTR   R5,R5                    IS UNIT COUNT ZERO              50500020
         BNZ   NOTLAST                  BRANCH NO                       50600020
*                                                                       50700020
         SR    R2,R12                   CALCULATE CORRECT COUNT         50800020
SETCCW   EQU   *                                                        50900020
         STH   R2,PRFCOUNT              SET CORRECT COUNT               51000020
         MVC   LCBCPA+16(8),PRFOPCDE-IEDQPRF(R9)  MOVE CCW FOR I/O GEN  51100020
         L     RPREFIX,LCBLSPCI-1       ADDRESS OF START BUFFER         51200020
         XC    LCBERBCH,LCBERBCH        CLEAR ERBCH              S22025 51300022
         NI    LCBCHAIN,X'FF'-LCBNORTY  RESET FLAG               S22025 51400022
         L     R1,AVTPARM               POST LIST                S22025 51500022
         B     ACTKA                    POST BUFFER TO KA        S22025 51600022
         SPACE 5                                                 S22025 51700022
*                                                                       52000020
NOTLAST  EQU   *                                                        52100020
         L     RPREFIX,PRFTIC           NEXT UNIT                       52200020
         LA    R12,PRFSUNIT             FIRST DATA BYTE                 52300020
         BAL   R10,CCWSET               SET UP CCW                      52400020
*                                                                       52500020
         STH   R1,PRFCOUNT              SET COUNT                       52600020
         SR    R2,R1                    DECTEMENT BUFSIZE               52700020
         BCT   R5,NOTLAST               LOOP TILL END OF BUFFER         52800020
*                                                                       52900020
         B     SETCCW                   TO COMMON CODE                  53000020
*                                                                       53100020
GETBUF   EQU   *                                                        53200020
         SR    R12,R12                  CLEAR FOR IC                    53300020
         IC    R12,PRFNBUNT             NUMBER OF UNITS IN BUFFER       53400020
         BAL   R9,GNXT                  ENTER LOOP TO FIND ADDRESS OF   53500020
*                                       NEXT BUFFER                     53600020
         L     RPREFIX,PRFTIC           NEXT UNIT ADDTESS               53700020
GNXT     EQU   *                                                        53800020
         BCTR  R12,R9                   LOOP TILL NEXT BUFFER FOUND     53900020
*                                                                       54000020
         BR    R1                       RETURN                          54100020
*                                                                       54200020
         SPACE 5                                                 S22025 54210022
POSTLIST EQU   *                                                 S22025 54220022
         ST    R2,PRFQCBA-1-IEDQPRF(R1) SET QCB ADDRESS          S22025 54230022
         MVC   PRFLINK-IEDQPRF(3,R1),AVTPARM+1  LINK PREVIOUS    S22025 54240022
*                                         ELEMENT INTO CURRENT   S22025 54250022
         ST    R1,AVTPARM               NEW PREVIOUS ELEMENT     S22025 54260022
         BR    R14                      RETURN                   S22025 54270022
         EJECT                                                          54300020
*        EOB/ETB RETRY ON SEND OPERATIONS                               54400020
         SPACE 3                                                        54500020
EOBSND   EQU   *                                                        54600020
         TM    SCBERR4,SCBTXTTN         TEXT ERROR SET ?                54700020
         BZ    EOBTAA                   BRANCH NO - PASS TO AA          54800020
*                                                                       54900020
         SR    R9,R9                    CLEAR FOR COUNT                 55000020
         CH    R9,PRFSIZE               IS THIS THE ERROR BUFFER        55100020
         BNE   EOBTAA                   BRANCH NO - WAIT FOT IT         55200020
*                                                                       55300020
         CLI   LCBFLAG1,AVTEZERO        IS THIS A PSEUDO LCB     S22024 55307022
         BNE   SENDRTRY                 NO, GO RETRY IF POSSIBLE S22024 55314022
         BAL   R9,STOPCONT              YES, GO CHECK STOP/CONT SA68245 55321005
         B     CHKCONT                  CONT= SPECIFIED          S22024 55328022
*                                       STOP= SPECIFIED          S22024 55335022
         OI    LCBCHAIN,LCBABRTN        SET ABORT FLAG           S22024 55336022
         OI    LCBERBST,LCBERROR        FLAG TO STOP DISK READS  S22024 55337022
         B     EOBTAA                   GO POST BUFFER TO MH     S22024 55338022
         SPACE                                                          55339022
CHKCONT  TM    LCBCSW+3,UNEX            IS THIS THE RESPONSE TO  S22024 55342022
*                                       THE LAST WRITE FOR THIS  S22024 55349022
*                                       MESSAGE                  S22024 55356022
         BZ    ACTKA                    NO, DO CONT= PROCESSING  S22024 55363022
         B     EOBTOBD                  YES, DO STOP= PROCESSING S22024 55370022
*                                                                S22024 55377022
SENDRTRY EQU   *                                                 S22024 55384022
         ST    R1,AVTDOUBL             @SAVE ELEMENT ADDRESS   @SA70192 55385056
         BAL   R14,FNDTRM               LOCATE TERMINAL ENTRY  @SA70192 55386056
         SR    R10,R10                  CLEAR WORK REGISTER    @SA70192 55387056
         IC    R10,TRMCHCIN-IEDQTRM(,R1) LOAD DCT INDEX        @SA70192 55388056
         BCTR  R10,0                    REDUCE FOR MULTIPLY    @SA70192 55389056
         MH    R10,AVTDCTLN             MULTIPLY BY DCT ENTRY  @Y17XANG 55390000
*                                       LENGTH.                @Y17XANG 55390200
         AL    R10,AVTCSTCS             ADD FRO ENTRY ADDRESS  @SA70192 55391056
         TM    3(R10),CCONTIN           CAN TERMINAL CONTINUE? @SA70192 55392056
         BZ    EOBTOBD                  BRANCH NO              @SA70192 55393056
         L     R1,AVTDOUBL              RELOAD ELEMENT ADDRESS @SA70192 55394056
         BAL   R10,CKRTRY               CHECK IF RETRY POSSIBLE         55400020
*                                                                       55500020
         B     EOBTOBD                  IF PERMANENT ERROR - POST       55600020
*                                       BUFFER TO IEDQBD                55700020
         NI    SCBERR1,AVTEFF-SCBNOBFN  RESET OUT OF BUFFERS   @SA72449 55750056
*                                                                       55800020
         LA    R10,AVTBFRTB             ADDRESS OF BUFFER RETURN QCB    55900020
CLRLNK   EQU   *                                                        56000020
         XC    PRFLINK,PRFLINK          CLEAR LINK FIELD                56100020
         ST    R10,PRFQCBA-1            SET QCB ADDRESS                 56200020
         MVI   PRFPRI,PRIBFRTB          SET PRIORITY                    56300020
         IC    R9,PRFNBUNT              NUMBER OF UNITS IN BUFFER       56400020
         LR    R5,RPREFIX               SAVE BUFFER ADDRESS             56500020
         BAL   R14,LOOPB                ENTER LOOP - FIND LAST UNIT     56600020
*                                                                       56700020
         L     R5,PRFTIC-IEDQPRF(R5)    NEXT UNIT ADDRESS               56800020
LOOPB    EQU   *                                                        56900020
         BCTR  R9,R14                   BRANCH IF NOT LAST UNIT         57000020
         TM    PRFTIC-IEDQPRF+3(R5),2   IS THERE A NEXT BUFFER          57100020
         BNZ   POSTBFR                  BRANCH IF NOT                   57200020
*                                                                       57300020
         MVC   PRFLINK,PRFTIC-IEDQPRF+1(R5)  LINK BUFFERS BY LINK       57400020
*                                       FIELD                           57500020
         L     RPREFIX,PRFTIC-IEDQPRF(R5)  NEXT BUFFER ADDRESS          57600020
         B     CLRLNK                   LOOP TILL END OF BUFFER CHAIN   57700020
*                                                                       57800020
*                                                                       57900020
POSTBFR  EQU   *                                                        58000020
         TM    LCBERBST,LCBDLNKN+LCBEOMSG  IS ERB AVAILABLE             58100020
         BNZ   RECALL         ON ZEROES EXIT TO THE DISPATCHER @Y17XAMA 58200000
*                                       BRANCH ERB NOT AVAILABLE        58300020
         BAL   R14,DSPCHAIN                                    @Y17XAMA 58350000
*                                                                       58400020
*        RECALL FROM DISK OR CORE AND SEND THRU MH                      58500020
*                                                                       58600020
RECALL   EQU   *                                                        58700020
         L     R2,LCBDCBPT              DCB ADDRESS                     58800020
         IC    R9,DCBBUFOU-IHADCB(R2)   BUFOUT                          58900020
         N     R9,MASK                  CLEAR REST OF REG               59000020
         SLL   R9,X08                   SET TO STORE IN LCBERBCT        59100020
         NC    SCBDEOB+1(3),SCBDEOB+1   FIRST RETRY OF HEADER           59200020
         BNZ   CKQTYP                   BRANCH NO                       59300020
*                                                                       59400020
         MVC   SCBDEOB+1(3),SCBSCHDR    SET FOR SEND RECALL             59500020
CKQTYP   EQU   *                                                        59600020
         TM    SCBQTYPE,SCBCOREQ        IS MESSAGE CORE QUEUED          59700020
         BO    CORE                     BRANCH YES                      59800020
*                                                                       59900020
         TM    SCBSTAT1,PRFNLSTN        WAS EOM RECALLED LAST TIME      60000020
         BO    RECALL1                  BRANCH YES                      60100020
*                                                                       60200020
         CLC   SCBDEOB+1(3),SCBCRCD     IS CURRENT RECALL A UNIT        60300020
*                                       OF THE LAST BUFFER              60400020
         BNL   CORE                     BR IF SENDING, REAL EOM SA63639 60500005
         NC    SCBXTRA(3),SCBXTRA       ANY XTRAS ?             SA63639 60510005
         BZ    RSET                     BRANCH IF NO            SA63639 60520005
         CLC   SCBDEOB+1(3),SCBXTRA     SENDING FROM XTRAS ?    SA63639 60530005
         BNL   CORE                     BRANCH IF NO            SA63639 60540005
RSET     EQU   *                                                SA63639 60550005
*                                                                       60600020
         OI    SCBSTAT1,PRFNLSTN        RESET TO NOT LAST BUFFER        60700020
RECALL1  EQU   *                                                        60800020
         XC    SCBNTXT,SCBNTXT          CLEAR FOR RECALL                60900020
         XC    SCBXTRA,SCBXTRA          CLEAR FOR RECALL                61000020
CORE     EQU   *                                                        61100020
         OI    LCBSTAT1,LCBRCLLN        SET RECALL BIT                  61300020
         MVI   LCBERBST,ZERO            CLEAR ERB STATE                 61400020
         MVC   LCBLINK-1(4),SCBDEOB     SAVE DEOB ACCROSS RECALL        61500020
         LA    R2,AVTDSIOB              DISK I/O QCB                    61600020
         ST    R1,LCBERBLK-1            LINK BUFFER TO ERB              61800020
         MVI   LCBERBPY,PRIRECAL        SET PRIORITY FOR RECALL         61900020
POSTERB  EQU   *                                                 S22025 61910022
         STH   R9,LCBERBCT              SET ERB COUNTS           S22025 61920022
         ST    R7,LCBRCQCB              SET RECALL ADDRESS       S22025 61930022
         XC    LCBERBCH(3),LCBERBCH     CLEAR FOR RECALL                61950020
         ST    R2,LCBERBQB-1            SET ERB QCB ADDRESS             62000020
         LA    R1,LCBERB                POST ERB TO DISK I/O            62100020
         BAL   R14,DSPCHAIN             EXIT TO DISPATCHER     @Y17XAMA 62200000
*                                                                       62300020
ERB      EQU   *                                                        62400020
         LR    RLCB,R1                  ERB ADDRESS                     62500020
         LA    R1,LCBERB-IEDQLCB        SIZE OF LCB BEFORE ERB          62600020
         SR    RLCB,R1                  LCB ADDRESS NOW IN RLCB         62700020
         L     RSCB,LCBSCBA-1           SCB ADDRESS                     62800020
         SR    R1,R1                    SET TO CLEAR ERB LINK FIELD     62900020
         ST    R1,AVTPARM               CLEAR POST LIST          S22025 62920022
         TM    LCBERBST,LCBPRCPG        REQUEST FOR A BUFFER     S22025 62940022
         BO    GOTBUF                   BRANCH YES               S22025 62960022
*                                                                S22025 62980022
         TM    LCBSTAT1,LCBRCLLN        LCBSTATE SET TO RECALL          63000020
         BZ    RECALL                   BRANCH NO                       63100020
*                                                                       63200020
         MVC   SCBUNTCT,SCBDEOB         RESTORE UNIT COUNT              63250020
         MVC   SCBDEOB,LCBLINK-1        RESTORE DEOB                    63300020
         L     RPREFIX,LCBERBCH-1       ADDRESS OF RECALLED SEGMENT     63400020
         NI    LCBERBST,LCBEOMSG        RESET STATUS EXCEPT FOR EOM     63500020
         OI    LCBERBST,LCBDLNKN                                        63600020
         NI    LCBSTAT1,X'FF'-LCBRCLLN  RESET RECALL FLAG               63800020
         LA    R2,AVTINOUT              ADDRESS OF DUMMY IN/OUTEND      63820020
         IC    R5,SCBMBHEN-1            SAVE HIGH ORDER BYTE            63840020
         ST    R2,SCBMBHEN-1            PREVENT MULTI-BFR HDR           63860020
         STC   R5,SCBMBHEN-1            RESTORE                         63880020
         TM    LCBSTAT1,LCBSENDN        SEND OPERATION                  63900020
         BZ    SETRCV                   BRANCH NO                       64000020
*                                                                       64100020
         NI    PRFSTAT1,X'FF'-PRFDUPLN  RESET DUPL FLAG         SA63962 64150052
         XC    LCBERBCH,LCBERBCH        CLEAR ERB CHAIN                 64200020
         XC    LCBLSPCI(3),LCBLSPCI                                     64300020
         L     R2,LCBDCBPT              DCB ADDRESS                     64400020
         IC    R9,DCBBUFOU-IHADCB(R2)   BUFOUT                          64500020
         N     R9,MASK                  CLEAR REST OF REG               64600020
         LR    R5,R9                    CLEAR FOR IC                    64700020
         IC    R5,DCBBUFMA-IHADCB(R2)   BUFMAX                          64800020
         SR    R5,R9                    DIFFERENCE                      64900020
         STC   R5,LCBERBCT              SET DISABLED COUNT              65000020
         OI    PRFSTAT1,PRFCNCLN        SET FLAG FOR GD                 65200020
         BAL   R14,FNDTRM               LOCATE TERMINAL ENTRY           65300020
*                                                                       65400020
         SR    R2,R2                    CLEAR FOR INSERT                65500020
         CH    R2,SCBEOB                ZERO BYTES INTO BUFFER          65600020
         BNE   LVFLAG                   BRANCH NO - LEAVE FLAG          65700020
*                                                                       65800020
         NI    PRFSTAT1,X'FF'-PRFCNCLN  RESET FLAG FOR GD               65900020
LVFLAG   EQU   *                                                        66000020
         CLI   LCBFLAG1,AVTEZERO       IS THIS A PSEUDO LCB      S22024 66030022
         BE    BFRPST                   YES, BRANCH              S22024 66060022
         IC    R2,TRMCHCIN-IEDQTRM(R1)  CHARACTERISTICS TABLE INDEX     66100020
         BCTR  R2,0                     RELATIVE TO ZERO                66200020
         MH    R2,AVTDCTLN              TIMES DCT ENTRY LEN    @Y17XANG 66300000
         AL    R2,AVTCSTCS              ADD START ADDRESS OF TABLE      66400020
         TM    3(R2),CKCN               DOES TERMINAL HAVE CONTINUE     66500020
*                                       AND CHECKING CAPABILITY ?       66600020
         BNO   BFRPST                   BRANCH NO - END OF MESSAGE      66700020
*                                                                       66800020
         MVI   LCBCPA+12,X20            SIMULATE CHAN PGM CK FOR GD     66850020
         OI    LCBCHAIN,LCBEXCP         SET EXCP REQUIRED               66900020
         TM    3(R2),IDL                DOES TERMINAL HAVE A WRITE      67000020
*                                       IDLE CAPABILITY ?               67100020
         BO    BFRPST                   BRANCH NO - EXCP WILL BE        67200020
*                                       DONE BY IEDQGD                  67300020
*                                                                       67400020
         NI    LCBCHAIN,X'FF'-LCBEXCP   RESET EXCP REQUIRED             67500020
         LA    R2,LCBCPA                ADDRESS OF WRITE IDLE-TIC LOOP  67600020
         ST    R2,LCBSTART-1            SET START ADDRESS FOR IEDQKA    67700020
         ST    R2,LCBCPA+8              SET TIC OF TIC-IDLE LOOP        67800020
         MVI   LCBCPA+8,TIC             SET TIC OP CODE                 67900020
         LA    R1,LCBFLAG1              IOB ADDRESS                     68100020
         EXCPVR (1),SUBSYS                                              68200005
BFRPST   EQU   *                                                        68300020
         LR    R1,RPREFIX               FIRST BUFFER TO POST            68320020
         CLI   LCBERBCT,AVTEZERO        BUFOUT EQUAL BUFMAX     SA69621 68326005
         BE    NOPOST                   YES, SKIP ERB POST      SA69621 68332005
         TM    LCBERBST,LCBEOMSG        END OF MESSAGE ?         S22025 68340022
         BO    NOPOST                   BRANCH IF YES            S22025 68410022
         NI    LCBERBST,LCBDLNKF        TURN OFF DELINK SWITCH   S22025 68480022
         LA    R1,AVTDSIOB              GET @ OF DISK I/O QCB    S22025 68550022
         ST    R1,LCBERBQB-1            STORE @ IN ERB           S22025 68620022
         LA    R1,LCBERB                GET ERB ADDRESS          S22025 68690022
         ST    RPREFIX,LCBERBLK-1       ADD BUFFER TO POST LIST  S22025 68760022
         MVI   LCBERBPY,PRIFSPCI        SET PRIORITY             S22025 68830022
NOPOST   EQU   *                                                        68950020
         NI    SCBERR4,X'FF'-SCBTXTTN   RESET ERROR FLAG                69000020
         BALR  R14,0                    SET FOR LOOP                    69100020
*                                                                       69200020
         ST    R7,PRFQCBA-1             SET QCB ADDRESS                 69300020
         MVI   PRFPRI,PRIMHBFR          SET PRIORITY                    69400020
         L     RPREFIX,PRFLINK-1        NEXT BUFFER IN CHAIN            69500020
         LA    RPREFIX,0(,RPREFIX)      CLEAR HIGH ORDER BYTE           69600020
         LTR   RPREFIX,RPREFIX          END OF CHAIN                    69700020
         BNZ   ADDLABEL      ON ZEROES  POST BUFFERS TO MH FOR @Y17XAMA 69800000
*                                       PROCESSING                      69900020
*                                       IEDQGD WILL CHAIN BUFFER INTO   70000020
*                                       THE WRITE IDLE - TIC LOOP       70100020
         BAL   R14,DSPCHAIN                                    @Y17XAMA 70150000
ADDLABEL EQU   *                                               @OY16454 70200000
         BCR   FIFTEEN,R14              CONTINUE WITH NEXT BFR @OY16454 70230000
*                                                                       70300020
FNDTRM   EQU   *                                                        70400020
         LH    R1,LCBTTCIN              SOURCE                          70500020
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF           70600020
         L     R15,AVTRNMPT             TERMNAME TABLE                  70700020
         BR    R15                      FIND TERMINAL ENTRY             70800020
*                                                                       70900020
CCWSET   EQU   *                                                        71000020
         ST    R12,PRFIOADR-1           SET UP CCW                      71100020
CCWST1   EQU   *                                                        71200020
         MVI   PRFOPCDE,CCWREAD         SET COMMAND CODE         S22025 71300022
         OI    PRFFLAGS,CCWCD+CCWSLI    SET FLAGS                S22025 71360022
         MVI   PRFFLAGS+1,AVTEZERO      CLEAR UNUSED BYTE        S22025 71420022
         MVI   PRFTIC,TIC              SET TIC CODE             SA55402 71430000
         NC    PRFTIC+1(3),PRFTIC+1    LAST BUFFER?             SA55402 71440000
         BCR   NZ,R10                  NO, RETURN               SA55402 71450000
         MVI   PRFTIC+3,LSTTWO         YES, SET DUMMY TIC ADDR  SA55402 71460000
         BR    R10                      RETURN                          71500020
         EJECT                                                          71503022
STOPCONT EQU   *                                                 S22024 71506022
*        THIS SUBROUTINE IS ENTERED WHEN AN UNRECOVERABLE ERROR  S22024 71509022
*        HAS OCCURED.  THE ROUTINE TESTS TO SEE WHETHER 'STOP='  S22024 71512022
*        OR 'CONT=' PROCESSING IS SPECIFIED.  REGISTER R2 IS     S22024 71515022
*        USED AS THE RETURN REGISTER;  RETURN IS TO 0(R2) IF     S22024 71518022
*        'CONT=' IS SPECIFIED OR TO 4(R2) IS 'STOP=' IS          S22024 71521022
*        SPECIFIED.                                              S22024 71524022
*                                                                S22024 71527022
         SR    R2,R2                    OFFSET TO OPTION FIELD  SA68245 71528005
         TM    FLAGS,CONT               WAS CONT= SPECIFIED      S22024 71530022
         BZ    TSTSTOP                  NO, ASSUME STOP=         S22024 71533022
*                                                                S22024 71536022
TSTCONT  EQU   *                        'CONT=' PROCESSING       S22024 71539022
         TM    FLAGS,STCOOP             OPTION FIELD TO CHECK    S22024 71542022
         BZ    XCONT                    NO, UNCONDITIONAL CONT=  S22024 71545022
         BAL   R10,LOCSUB               GO CHECK OPTION FIELD    S22024 71548022
         B     XSTOP                    OPTION FIELD NOT= SWITCH S22024 71551022
         B     XCONT                    OPTION FIELD = SWITCH    S22024 71554022
*                                                                S22024 71557022
TSTSTOP  EQU   *                        'STOP=' PROCESSING       S22024 71560022
         TM    FLAGS,STCOOP             OPTION FIELD TO CHECK    S22024 71563022
         BZ    XSTOP                    NO, UNCONDITIONAL STOP=  S22024 71566022
         BAL   R10,LOCSUB               GO CHECK OPTION FIELD    S22024 71569022
         B     XCONT                    OPTION FIELD NOT= SWITCH S22024 71572022
*                                       OPTION FIELD = SWITCH    S22024 71575022
XSTOP    B     FOUR(R9)                 TAKE 'STOP=' RETURN     SA68245 71578005
*                                                                       71585005
XCONT    BR    R9                       TAKE 'CONT=' RETURN     SA68245 71592005
         EJECT                                                          71600020
         DS    0F                       FORCE BOUNDARY ALIGNMENT S22025 71700022
MASK     DC    X'0000000F'              MASK TO CLEAR ALL BUT    S22025 71800022
*                                       LOW ORDER BYTE           S22025 71900022
DC9999   DC    H'9999'                  MAXIMUM SEQUENCE # COUNT S22025 72000022
ONE      EQU   1                        ONE                      S22024 72170022
TIMES4   EQU   2                        TWO                      S22024 72240022
X20      EQU   X'20'                    HEX 20                   S22024 72310022
CKCN     EQU   X'14'                    HEX 14                   S22024 72380022
IDL      EQU   X'02'                    HEX 02                   S22024 72450022
TIC      EQU   X'08'                    HEX 08                   S22024 72520022
LSTTWO   EQU   2                                                SA55402 72630000
NZ       EQU   7                                                SA55402 72660000
RD       EQU   2                        TWO                      S22024 72700022
X08      EQU   8                        EIGHT                    S22024 72800022
ZERO     EQU   0                        ZERO                     S22024 72900022
SIX      EQU   6                        SIX                      S22024 73000022
MAX      EQU   6                        SIX                      S22024 73100022
D256     EQU   256                      TWO56                    S22024 73200022
UNEX     EQU   1                        ONE                      S22024 73300022
STCB     EQU   12                       TWELVE                   S22024 73400022
SBVTO    EQU   0                        ZERO                     S22024 73500022
FOUR     EQU   4                        FOUR                     S22024 73600022
X10      EQU   X'10'                    HEX 10                   S22024 73700022
REGOF    EQU   X'0C'                    REG12 RETURN FROM QAE  @YM07659 73800000
RCVETX   EQU   X'20'                    ETX RECEIVED             S22024 73900022
PCI      EQU   X'08'                    HEX 08                   S22024 74000022
RCVPCI   EQU   X'22'                    HEX 22                   S22024 74100022
NONZRO   EQU   7                        SEVEN                    S22024 74200022
CCONTIN  EQU   X'04'                    TERMINAL CAPABLE OF    @SA70192 74230056
BUMPOPT  EQU   2                        BUMP TO L/E ADR OPT OFF@XA05300 74260056
FIFTEEN  EQU   15                       CONDITION CODE F       @OY16454 74280000
STARTMH  DSECT                                                          74300020
         DS    F                        TSO ONLY FIELD                  74400020
FLAGS    DS    BL1                      FLAG BYTE                       74500020
LCIN     EQU   X'80'                    LINE CONTROL IN                 74600020
CONT     EQU   X'40'                    CONT= SPECIFIED                 74700020
STCOOP   EQU   X'20'                    CONT OR STOP SPECIFIED OPTION   74800020
CONV     EQU   X'10'                    CONV= SPECIFIE YES OR OPTION    74900020
CONVOP   EQU   X'08'                    CONV= SPECIFIED OPTION FIELD    75000020
LOGICAL  EQU   X'04'                    LOGICAL= SPECIFIED              75100020
LOGICOP  EQU   X'02'                   LOGICAL= SPECIFIED SECOND OPTION 75200020
ALTMHAD  DS    AL3                      TSO ONLY                 S22029 75300022
LENGTH   DS    XL1                      PARAMETER LIST LENGTH           75400020
STCBA    DS    AL3                      STCB ADDRESS                    75500020
AEINDX   DS    AL1                      OFFSET TO LOCOPT IF REQUIRED    75600020
*                                                                       75620022
LMD      EQU   X'01'                    LMD SPECIFIED           S22025  75640022
LMDOP    EQU   X'02'                    LMD SPECIFIED IN OPTION S22025  75660022
MHROUT   DS    AL3                      ADDRESS OF STARTMH STCB         75700020
LOGOPT   DS    AL1                      POINTER TO LOGICAL= OPTION      75800020
LMDOPT   DS    0AL1                     OPTION FIELD INDEX       S22025 75850022
CONVOPT  DS    AL1                      POINTER TO CONV= OPTION         75900020
OPTION   DS    AL2                      START OF OPTION FIELD POINTERS  76000020
         EJECT                                                          76100020
         TCCWD                                                   S22025 76130022
         EJECT                                                          76160022
         TTRMD                                                          76200020
         TLCBD                                                          76300020
         TSCBD                                                          76400020
         TDISPD                                                         76500020
         TPRIOR                                                         76600020
         TQCBD                                                          76700020
         TAVTD SAVT=YES                                          S22024 76800022
         TPRFD                                                          76900020
         DCBD  DSORG=TX                                                 77000020
         END                                                            77100020
