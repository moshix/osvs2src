EC01     TITLE '''IEDQEC'' - TCAM PUT SCHEDULER'                        00100020
         SPACE 1                                                        00150022
IEDQEC   CSECT                                                          00200020
*A000000-999999                                                @X31X8A0 00200212
         SPACE 3                                                        00200322
******************** MICROFICHE FLAGS *********************** SUPT CODE 00200622
*C186000,191000,327000,360000,460000,                            S21903 00200704
*C474000,505000,510000,550000,624000                             S21903 00200804
*C340000                                                        SA52991 00201022
*A314000,345000,630000                                          SA52991 00201122
*A250200                                                        SA52508 00201222
*C081200                                                        SA52508 00201322
*A420000                                                         A44891 00201422
*D422700,431000-437000,570000                                    A44891 00201522
*C409000                                                         A44891 00201622
*C081400,655950                                                  A42404 00201722
*C081200                                                         S22025 00201822
*A126000,592000                                                  A48279 00201922
*C081400                                                         A48279 00202022
*D656000                                                         A48279 00202122
*A109000,541000,549000,564000                                   SA51096 00202222
*C523000,524000                                                  S21903 00202322
*A564500                                                        SA57699 00202422
*D564000                                                        SA57699 00202522
*C122000                                                        SA59182 00202622
*A240000,247000                                                  S22024 00202722
*A497500                                                        SA58449 00202800
*A549000,564000                                                 SA50196 00202900
*C110000                                                        SA50196 00203000
*C006000                                                         S21903 00203100
*A126300                                                        SA59526 00203200
*           CLEAN-UP                                            S21903  00203305
*A389000                                                        OY00458 00203405
*A031300-031900,033200-033600,053100-053600,065500,078500,       Y01004 00203505
*A080050-081840,121500,123500,235100-235700,240005-240055,249900,Y01004 00203605
*A267427-267476,267565-267615,422060-422420,422700,447400,       Y01004 00203705
*A479500,498500,549600-549700,561000,612500,624100-624900,655985,Y01004 00203805
*A656090-656590                                                  Y01004 00203905
*C018200,080000,081000,081200,121000-124000,249600,250200-250400,Y01004 00204005
*C287000,371000-373000,376000-378000,422000,479000-481000,498000 Y01004 00204105
*D077000,087000,125000,250600,266000,354000,356000,366000,454000,Y01004 00204205
*D566000-571000,606000,635000,639000-640000,648000,652000        Y01004 00204305
*C497620                                                         Y05330 00204405
*A292600                                                        OX02215 00204554
*C122000                                                        SA66354 00244454
*C007000-014500,018400-018600,020000,022000,031600,035000,043000 Y02027 00244506
*C072000,080150-080400,080500,080600,080700,080800,081000,081060 Y02027 00244606
*C081200,081300,091000,122000,136000,149000,150400,153000,154000 Y02027 00244706
*C155000,156000,177000,182000,191000,191500,209000,218000,229000 Y02027 00244806
*C235000,243000,247300,247500,249000,253000,254000,257300,257900 Y02027 00244906
*C258500,259000,260000,267350,267700,267840,268000,269000,287000 Y02027 00245006
*C292300,293000,295000,299000,324000,329000,345240,345330-347140 Y02027 00245106
*C364000,398000,400000,415000,422180,465500,467000,497620,498000 Y02027 00245206
*C501000,503000-504000,514000,521000-548200,600000-602000,611000 Y02027 00245306
*C614200,622000,623000-624900,656490,663000,670000               Y02027 00245406
*D053200-053500,065500,076000,080050,080550,080650,080750,081120 Y02027 00245506
*D081400-081900,106000,106000-109000,111000-114000,118000        Y02027 00245606
*D122200-126500,157000-167000,205-206000,210000,213000           Y02027 00245706
*D235100-235700,240008-240100,247600-247700,249600,257600.258200 Y02027 00245806
*D267420,257476,267565-267615,267910,267950,271200,292000,345270 Y02027 00245906
*D345300,348000,399000,401000,404000,470000-482000,505000-507000 Y02027 00246006
*D549000-565000,612500,614400-615000,616000,617000,618000,619000 Y02027 00246106
*D620000,621000,623000-624900,641000-653300,654200-654800,656290 Y02027 00246206
*D668000                                                         Y02027 00246306
*A031800,035200-035600,062500,080900,096000-105900,152300-152600 Y02027 00246406
*A153040,153880,154200-154600,155070-155840,156100-156800        Y02027 00246506
*A229100-229800,249400,267840-269840,292400,393200-393600,402000 Y02027 00246606
*A429000-433000,443500,469200-469600,498500,611500,616200,618200 Y02027 00246706
*A620200,656498-656578,670500                                    Y02027 00246806
*A 655990                                                      @SA69971 00247861
*C 587000-588000                                               @SA69971 00248861
*A148000,216000,217000,465000                                  @YA04914 00249861
*C173000,214000                                                @YA04914 00250861
*D200000,471000,484000,500000-510000,593000                    @YA04914 00251861
*C006800                                                       @Z30X8AM 00256808
*D098200,09800,100300,616200                                   @ZA02061 00261861
*A240000                                                       @Z30X8AM 00266808
*A099100,630000                                                @ZA02061 00271861
*A213000                                                       @YA07129 00272861
*A305000,321000,655990                                         @SA72774 00272961
*D148200-148800,214000                                         @YA08769 00273081
*C292605,292625,292645,292655-292670                           @ZA03747 00283081
*A099170                                                       @ZA04005 00291081
*A100500,100600,656538                                         @ZA04032 00291181
*A533000,661000                                                @ZA05000 00291681
*D656498,656506                                                @ZA05000 00292181
*C534500                                                       @ZA05000 00292681
*C122000                                                       @YA10439 00292781
*C100650                                                       @OY11959 00292881
*C547600                                                       @OZ07798 00292981
*A134000                                                       @OX12583 00293081
* A002930,247000,497560,497700,533000,533370,536000,613000     @G36XRAW 00293110
* C002001,245200,247400,530000,532500-533000,550000-550500,    @G36XRAW 00293210
* C613000                                                      @G36XRAW 00293310
* C247100,245300                                               @G36XRAW 00293410
* D497620,498000,533400,536500                                 @G36XRAW 00293510
* D245400-245800                                               @G36XRAW 00293610
* A497565-497575,497750,533010,533020,537000,613500            @G36XRAW 00293710
*A186500,655400                                                @XA11307 00293800
*C153040,183000                                                @XA11307 00294800
*C533500-536000                                                @Z40X9AG 00295800
*   INCLUDE APAR OX11037 THAT WAS LEFT OUT OF TCAM10           @OZ27031 00296800
*   INCLUDE LVL9 DEVELOPMENT CODE THAT WAS LEFT OUT OF TCAM10  @OZ27030 00297800
*                                       PEWA DSECT CHG         @OZ27843 00298800
*A186940                                                       @OZ26689 00298986
*A527000,620200                                                @OZ34827 00299400
*A250400,248100                                                @OZ35822 00299700
*                                       PEWA DSECT CHG         @OZ37365 00299800
* $01=OZ41322  JTC2202  79.11.06 047252:                           @01A 00299912
* $02=OZ43902  JTC2202  80.01.02 726652:                           @02A 00300012
* $11=OZ46207  ETC2302  80.05.23 076195: V2R3 APAR FIX             @11A 00333327
* $N1=2        JTC2412  81.02.23 076195: MULTIPLE TCAM HITS        @N1A 00340527
* $21=OZ52442  ETC2402  81.08.11 076195: V2R4 APAR FIX             @21A 00366627
* $22=OZ57770  ETC2402  81.12.11 251428: REDRIVE CLOSE PROCESS     @22A 00383227
         SPACE 4                                                        00399912
*********************************************************************** 00400020
*                                                                     * 00500020
*  $MOD(IEDQEC) COMP(A@) PROD(TCAM):                               @01C 00620012
*                                                                     * 00630000
*  DESCRIPTIVE NAME = PUT SCHEDULER                                   * 00640000
*                                                                     * 00650000
*  COPYRIGHT = 5735-RC3 COPYRIGHT IBM CORP. 1981                   @N1C 00650527
*  LICENSED MATERIAL - PROGRAM PROPERTY OF IBM                     @N1C 00651027
*  REFER TO COPYRIGHT INSTRUCTIONS FORM NUMBER G120-2083           @N1C 00651527
*                                                                     * 00670000
*  STATUS = ACF/TCAM VERION 2 RELEASE 4                            @N1C 00680027
*                                                                     * 00690000
*                                                                     * 00700006
*FUNCTION: THE ROUTINE IS DIVIDED INTO TWO SECTIONS (1)PUT-MCP        * 00750006
*   SUBTASK WHEN A PUT MACRO IS ISSUED AND (2) PUT SCHEDULER.         * 00800006
*   THE PUT-MCP SUBTASK IS ACTIVATE BY THE DISPATCHER WHEN AN RCB     * 00850006
*   IN THE AIB IS POSTED TO THE PUT QCB IN THIS ROUTINE. IF TERM      * 00900006
*   NAME OF THE MESSAGE DESTINAION IS SPECIFIED, IT IS VERIFIED       * 00950006
*   AND OFFSET OBTAINED. THE ERB IS POSTED TO THE REQUEST BUFFER      * 01000006
*   QUEUE TO GET BUFFERS FROM TCAM BUFFER POOL.                       * 01050006
*                                                                     * 01100006
*   THE PUT SCHEDULER IS ACTIVATED WHEN ELEMENT IS POSTED TO SCHED.   * 01150006
*   (1) ERB CONTAINING EMPTY BUFFERS                                  * 01200006
*   (2) LCB POSTED BY BD AT END OF MESSAGE TIME.                      * 01250006
*   THIS ROUTINE MOVES DATA FROM THE WORKAREA IN THE AIB TO MCP       * 01300006
*   BUFFERS, AND POSTS FULL BUFFERS TO THE MH POINTED TO BY THE PCB.  * 01350006
*   IF THE TERMINAL IS IN LOCK MODE AND MESSAGE IS THE RESPONSE,      * 01400006
*   ITS SEND SCHEDULER IS INSERTED IN STCB CHAIN OF LCB.              * 01450006
*                                                                     * 01500020
*   IF THE DCB INDICATES RECORD FORMAT W/O WORK AREA CONTENTS         * 01600020
*   DESCRIPTOR BYTE, THE CURRENT LAST FULL BUFFER IS SAVED.  CLOSE    * 01700020
*   POSTS THIS BUFFER TO THE MH, FLAGGING IT AS END OF MESSAGE.       * 01800020
*                                                                     * 01810020
*                                                                     * 01820006
*   WHEN WORKAREA IS EMPTY OR LCB IS ELEMENT, ECB IS POSTED           * 01830006
*   COMPLETE VIA CROSS MEMORY POST                                    * 01840006
*                                                                     * 01870020
*ENTRY POINT:                                                         * 01900020
*        IEDQEC                                                       * 02000020
*         PSTCB+2 - RCB IN AIB IS POSTED TO PUT-QCB                   * 02050006
*INPUT:                                                               * 02100020
*   1  - ADDRESS OF ERB, LCB OR SPECIAL ELEMENT                       * 02200020
*   1  - ADDRESS OF ERB, LCB, OR RCB IN AIB.                          * 02250006
*   11 - ADDRESS OF DISPATCHER                                        * 02300020
*   13 - ADDRESS OF REGISTER SAVEAREA                                 * 02400020
*   15 - ENTRY POINT ADDRESS                                          * 02500020
*OUTPUT:                                                              * 02600020
*   1  - ADDRESS OF ERB OR BUFFER                                     * 02700020
*   11 - SEE 'INPUT'                                                  * 02800020
*   13 - SEE 'INPUT'                                                  * 02900020
*EXTERNAL ROUTINES:                                                   * 03000020
*        DISPATCHER-IGG019RB(DSPPOSTR)                                * 03100020
*        DISPATCHER-IGG019RB(DSPLIFOR)                                * 03120005
*        AQCTL-SVC 102                                                * 03140005
*         OS POST - CROSS MEMORY                                      * 03160006
*         IEDQA1                                                      * 03180006
*EXITS-NORMAL:                                                        * 03200020
*        EXITS TO DISPATCHER(DSPCHAIN) TO POST ERB OR FULL BUFFER(S)  * 03300020
*        EXITS TO DISPATCHER(DSPPOST) TO POST A FULL BUFFER, OR TO    * 03320005
*   POST A SPECIAL ELEMENT TO THE OPEN/CLOSE SUBTASK                  * 03340005
*        EXITS TO DISPATCHER(DSPDISP) TO DISPATCH THE NEXT SUBTASK    * 03360005
*EXITS-ERROR:                                                         * 03400020
*         COMPLETION CODES OF:                                        * 03500006
*         X'54' - DESTINATION ERROR                                   * 03520006
*         X'5C' - THRESHOLD REACHED OR PUT IN PROGRESS                * 03540006
*         X'5E' - QUICK CLOSE                                         * 03560006
*TABLES/WORKAREAS:                                                    * 03600020
*        AVT                                                          * 03700020
*        LCB                                                          * 03800020
*        PROCESS ENTRY                                                * 03900020
*        PROCESS ENTRY WORKAREA                                       * 04000020
*        DEB                                                          * 04100020
*        PCB                                                          * 04200020
*         AIB                                                         * 04300006
*        SCB                                                          * 04400020
*        QCB                                                          * 04500020
*        DCB                                                          * 04600020
*ATTRIBUTES:REENTRANT,REFRESHABLE                                     * 04700020
*                                                                       04800020
*NOTES: THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL         * 04900020
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT  * 05000020
*   TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS BEEN ARRANGED   * 05100020
*   SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,     * 05200020
*   WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.          * 05300020
*                                                                     * 05310005
*                                                                     * 05360005
*********************************************************************** 05400020
         EJECT                                                          05500020
         SPACE                                                          05600020
*                                                                     * 05700020
*           S Y M B O L I C    R E G I S T E R S                      * 05800020
*                                                                     * 05900020
         SPACE                                                          06000020
RZERO    EQU   0                        GENERAL WORK REGISTER           06100020
RPARM    EQU   1                        PARAMETER REGISTER              06200020
REG1     EQU   1                        IEDGETCB PARM REG1         @N1A 06200527
*                                       AIB BASE REGISTER        Y02027 06250006
RCNT     EQU   2                        NUMBER OF BYTES IN BUFFER       06300020
RTEMP    EQU   3                        GENERAL WORK REGISTER           06400020
RNUM     EQU   4                        NUMBER OF BYTES TO BE MOVED     06500020
RUNIT    EQU   5                        ADDR OF CURRENT BUFFER UNIT     06600020
RWORK    EQU   6                        ADDRESS OF DATA IN WORKAREA     06700020
RBUF     EQU   7                        ADDR OF NEXT EMPTY BYTE         06800020
*                                       IN CURRENT BUFFER UNIT          06900020
RPEWA    EQU   8                        PROCESS ENTRY WORKAREA          07000020
RERB     EQU   9                        ELEMENT REQUEST BLOCK           07100020
RPCB     EQU   10                       PROCESS CONTROL BLOCK    Y02027 07200006
RDISP    EQU   11                       ADDRESS OF DISPATCHER           07300020
RBASE    EQU   12                       ADDRESS VECTOR TABLE            07400020
RAVT     EQU   13                       ADDRESS VECTOR TABLE(AVT)       07500020
RETURN   EQU   14                       RETURN ADDRESS                  07800020
RBFR     EQU   15                       ADDR OF BUFFER PREFIX    Y01004 07850005
RENTRY   EQU   15                       ENTRY POINT ADDRESS             07900020
         SPACE 2                                                        08000005
         USING *,RENTRY                 ESTABLISH ADDRESSABILITY Y01004 08010005
         B     PUTSCHED                 BRANCH TO PUT SCHEDULER  Y02027 08015006
         DS    F                        LINK FIELD OF QCB        Y02027 08020006
         DC    X'08'                    MCPL FOR LAST STCB       Y02027 08025006
         DC    AL3(PSTCB)               QCB STCB POINTER         Y02027 08030006
         DC    X'00000000'              PRIORITY AND LAST STCB   Y02027 08035006
*                                       INDICATOR                Y02027 08040006
IEDQEC   IEDHJN                                                         08045005
PSTCB    DC    X'0400'                  PUT STCB                 Y02027 08050006
*                                                                Y02027 08060006
*              CODE EXECUTED AS RESULT OF ELEMENT POSTED TO      Y02027 08070006
*              PUT QCB                                           Y02027 08080006
*                                                                Y02027 08090006
         BALR  RBASE,RZERO              ESTABLISH ADDRESSABILITY Y02027 08100006
LABEL    EQU   *                                                 Y02027 08110006
         DROP  RENTRY                                            Y02027 08120006
         USING *,RBASE                  CSECT ADDRESSABILITY     Y02027 08130006
         EJECT                                                          08200020
*                                                                     * 08300020
*      C O N T R O L   B L O C K   A D D R E S S A B I L I T Y        * 08400020
*                                                                     * 08500020
         SPACE                                                          08600020
         USING IEDQDISP,RDISP           TCAM DISPATCHER                 08800020
         USING IEDQPCB,RPCB             PROCESS CONTROL BLOCK (PCB)     08900020
         USING IEDQPEWA,RPEWA           PROCESS ENTRY WORKAREA (PEWA)   09000020
         USING AVTSAVE2,RAVT            AVT ADDRESSABILITY       Y02027 09100006
         USING LCBERB,RERB              ELEMENT(EMPTY BUFFER)           09200020
*                                       REQUEST BLOCK(ERB)              09300020
         USING IEDQPRF,RBFR             BUFFER PREFIX                   09400020
         SPACE                                                          09500020
         SH    RPARM,AVTHA16            BACK UP TO BEGINNING OF  Y02027 09600006
         USING IEDQAIB,RPARM            AIB FOR ADDRESSABILITY   Y02027 09610006
*                                                                Y02027 09620006
*              TEST FOR ABORT CONDITIONS                         Y02027 09630006
*                                                                Y02027 09640006
         L     RPEWA,AIBPPEWA           GET PEWA ADDRESS         Y02027 09650006
         L     RPCB,AIBPCBAD            GET PCB ADDRESS          Y02027 09660006
         LA    RENTRY,NOBFRS            SET RETURN CODE IF ERROR Y02027 09670006
         TM    AVTBIT3,THRESH           QUEUE THRESHOLD CONDITIONY02027 09680006
         BNZ   XMPOST1                  BRANCH IF YES            Y02027 09690006
         TM    PCBOFLG,PCBPIPN          PUT IN PROGRESS          Y02027 09700006
         BO    XMPOST1                  BRANCH IF YES            Y02027 09710006
*                                                                Y02027 09720006
*              CHECK DESTINATION OF MESSAGE                      Y02027 09730006
*                                                                Y02027 09740006
         L     RWORK,AIBWAPTR           GET ADDRESS OF WORKAREA  Y02027 09750006
         AH    RWORK,AIBMSTRT           ADD IN ANY PREFIX TO GET Y02027 09760006
*                                       TO MESSAGE START         Y02027 09770006
         LH    RNUM,AIBWASZE            GET SIZE OF WORK AREA    Y02027 09780006
         TM    AIBOPTCP,TNMEFLG         TERMNAME OF MSG. DEST.   Y02027 09790006
*                                       SPECIFIED IN WORKAREA    Y02027 09800006
         BZ    UPDATE                   BRANCH IF NO             Y02027 09810006
         LR    RTEMP,RPARM              SAVE AIB ADDRESS THRU    Y02027 09870006
*                                       BRANCH TO BINARY SEARCH  Y02027 09880006
         LR    RPARM,RWORK              LOAD ADDR OF TERMNAME    Y02027 09890006
*                                       IN REG 1                 Y02027 09900006
         LA    RENTRY,DEST              DEST ERROR CODE            @21C 09901627
         CLI   ZERO(RPARM),BLANK        1ST CHAR BLANK?            @21C 09903227
         BE    XMPOST1                  YES, EXIT                  @21C 09904827
         CLI   ZERO(RPARM),ZERO         1ST CHAR ZERO?             @21C 09906427
         BE    XMPOST1                  YES, EXIT                  @21C 09908027
         LA    RZERO,EIGHT              LOAD MAXIMUM LENGTH      Y02027 09910006
         LA    RENTRY,ADDR(RPARM)       BUMP TO END            @ZA02061 09911061
NAMELOOP EQU   *                                               @ZA02061 09912061
         CLI   ZERO(RENTRY),BLANK       END OF NAME            @ZA02061 09913061
         BNE   NAMEEND                  YES, BRANCH            @ZA02061 09914061
         BCTR  RENTRY,0                 DECREMENT ADDRESS      @ZA02061 09915061
         BCT   RZERO,NAMELOOP           SEARCH AGAIN           @ZA02061 09916061
         LR    RENTRY,RZERO             CLEAR REG              @ZA02061 09917061
         LR    RPARM,RTEMP              RESTORE AIB ADDRESS    @ZA04005 09917581
         B     INVDEST                  INVDEST                    @21C 09918027
NAMEEND  EQU   *                                               @ZA02061 09919061
         L     RENTRY,AVTMSGS-ONE       GET VCON TABLE ADDR      Y02027 09920006
         L     RENTRY,EIGHT(RENTRY)     LOAD ADDR OF IEDQA1      Y02027 09930006
         BAL   RETURN,FOUR(RENTRY)      BRANCH TO SEARCH ROUTINE Y02027 09940006
*                                       AT SECOND ENTRY POINT    Y02027 09950006
         LR    RPARM,RTEMP              RESTORE AIB ADDRESS      Y02027 09960006
         LTR   RENTRY,RENTRY            VALID TERMNAME           Y02027 09970006
         BNZ   STDEST                   BRANCH IF YES            Y02027 09980006
INVDEST  EQU   *                                                   @21A 09985027
         LA    RENTRY,DEST              DEST ERROR CODE          Y02027 09990006
         B     XMPOST1                  EXIT TO IEDQEB           Y02027 10000006
STDEST   EQU   *                                                 Y02027 10010006
         STH   RENTRY,PEWAOFF           SAVE TERMNAME OFFSET     Y02027 10020006
         LA    RWORK,TRMLEN(RWORK)      ADDRESS OF BYTE FOLLOW-  Y02027 10040006
*                                       ING DESTINATION          Y02027 10050006
         LA    RENTRY,LENERR            ERROR COMPLETION CODE  @ZA04032 10055081
         SH    RNUM,TNAMEL              DECREMENT WORKAREA SIZE  Y02027 10060006
         BM    XMPOST1                  BRANCH IF NEGATIVE     @OY11959 10065081
UPDATE   EQU   *                                                 Y02027 10070006
         ST    RWORK,PEWAMOVE           SAVE ADDR OF DATA IN W.A.Y02027 10080006
         TM    AIBOPTCP,MSGFLG          IS WORK UNIT A MESSAGE   Y02027 10090006
         BO    NORDEL                   BRANCH IF YES            Y02027 10100006
         TM    AIBRECFP,VARFLG          VARIABLE OR UNDEFINED    Y02027 10110006
         BNO   NORDEL                   BRANCH IF NEITHER        Y02027 10120006
         L     RTEMP,PEWAPROC           PROCESS TERM ENTRY       Y02027 10130006
         CLI   TRMCHCIN-IEDQTRM(RTEMP),AVTEZERO RECDEL PRESENT   Y02027 10140006
         BE    NORDEL                   BRANCH IF NO             Y02027 10150006
         LA    RNUM,ONE(RNUM)           ADD 1 TO WORKAREA SIZE   Y02027 10160006
NORDEL   EQU   *                                                 Y02027 10170006
         STH   RNUM,PEWALREC            SET SIZE OF WORKAREA     Y02027 10180006
         CLM   RNUM,THREE,AVTFZERO      IS DATA TO MOVE          Y02027 10190006
         BNE   CKPTTEST                 BRANCH IF YES            Y02027 10200006
         SR    RENTRY,RENTRY            SET GOOD COMPLETION CODE Y02027 10210006
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027 10220006
         BNO   XMPOST1                  BRANCH IF NO             Y02027 10230006
         CLI   PEWACTL,EOMFLAG          LAST PORTION OF MESSAGE  Y02027 10240006
         BNE   XMPOST1                  BRANCH IF NO             Y02027 10250006
*                                                                Y02027 10260006
*              CHECK FOR ENVIRONMENT CHECK POINT TAKEN SINCE     Y02027 10270006
*              LAST PUT                                          Y02027 10280006
*                                                                Y02027 10290006
CKPTTEST EQU   *                                                 Y02027 10300006
         TM    AIBEXLFP,CKPTFLP         CHECKPOINT EXIT SPECIFIEDY02027 10310006
         BNO   SETNO                    BRANCH IF NO             Y02027 10320006
         TM    PCBOFLG,PCBCKPTN         CHECKPOINT ISSUE SINCE   Y02027 10330006
*                                       LAST HEADER              Y02027 10340006
         BNO   SETNO                    BRANCH IF NO             Y02027 10350006
         NI    PCBOFLG,PCBCKPTF         IF YES, TURN OFF FLAG    Y02027 10360006
         B     SETCTL                   BRANCH IF YES            Y02027 10370006
SETNO    MVI   AIBEXLFP,AVTEZERO        SET NO CHECKPOINT TAKEN  Y02027 10380006
*                                       IF AIBEXLFP=CKPTFG,      Y02027 10390006
*                                       EXLST EXIT IS TO BE TAKENY02027 10400006
*                                                                Y02027 10410006
*        SET SEQUENCE FLAG FOR SEGMENT OF MESSAGE                Y02027 10420006
*                                                                Y02027 10430006
SETCTL   EQU   *                                                 Y02027 10440006
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027 10450006
         BO    NEWPUT                   BRANCH IF YES            Y02027 10460006
         CLI   PEWACTL,AVTEZERO         FIELD INITIALIZED        Y02027 10470006
         BNE   NXTA                     BRANCH IF YES            Y02027 10480006
         MVI   PEWACTL,MESSAGE          SET COMPLETE MSG FLAG    Y02027 10490006
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027 10500006
         BO    NEWPUT                   BRANCH IF YES            Y02027 10510006
         MVI   PEWACTL,HDRFLG           SET AS HEADER FIRST SEG  Y02027 10520006
         B     NEWPUT                   BRANCH TO CONTINUE       Y02027 10530006
NXTA     EQU   *                                                 Y02027 10540006
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027 10550006
         BO    NEWPUT                   BRANCH IF YES            Y02027 10560006
         MVI   PEWACTL,ISEGFLAG         SET INTERMEDIATE SEGMENT Y02027 10570006
         EJECT                                                   Y02027 10580006
NEWPUT   EQU   *                                                 Y02027 10590006
         OI    PCBOFLG,PCBPIPN          SET PUT IN PROGRESS      A50196 11000022
         LA    RERB,PEERB               ADDRESS OF ELEMENT REQUEST      11500020
*                                       BLOCK FROM PROCESS ENTRY        11600020
*                                       WORKAREA                        11700020
         TM    PEWAFLG,PBUF             PART-EMPTY BUFFER TO FILL       11900020
         BO    SETUP                    BRANCH IF YES                   12000020
         CLM   RNUM,HALF,AVTFZERO       IS THIS A NO-DATA OPERA- Y01004 12100005
*                                       TION (WORKAREA SIZE = 0) Y01004 12150005
         BE    SETUP                    BRANCH IF YES          @YA10439 12200081
         B     BUFSAVE                  BRANCH IF DATA OPERATION Y02027 12700006
SETUP    EQU   *                                                        13200020
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER          13300020
         L     RBFR,PERAQCB             BUFFER PREFIX ADDRESS           13400020
         LTR   RBFR,RBFR                IS 1ST PUT 0 LENGTH    @OX12583 13430081
         BZ    CLEANX                   BR YES, POST A.P.      @OX12583 13460081
         XC    PERAQCB(4),PERAQCB                                       13500020
         L     RBUF,PEWACBUF            ADDR OF FIRST EMPTY BYTE Y02027 13600006
         L     RPARM,PEWATIC            ADDR OF CURRENT UNIT            13700020
         LH    RCNT,PRFSIZE             INITIALIZE COUNTER              13800020
         L     RTEMP,PRFLCB-1           LCB ADDRESS                     13900020
*                                                                     * 13920020
*        INITIALIZE LCB FOR USE AFTER BUFFER ENTERS MESSAGE HANDLER   * 13940020
*                                                                     * 13960020
         LA    RZERO,PEWASCB                                            14000020
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RTEMP) SCB DIRECTORY ADDR     14100020
         ST    RZERO,LCBSCBA-1-IEDQLCB(0,RTEMP)                         14200020
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBRECVN SET RECIEVE SWITCH      14300020
         OI    LCBERBST-IEDQLCB(RTEMP),LCBDLNKN                         14400020
         MVI   LCBRSKEY-IEDQLCB(RTEMP),PSVTO PUT SCHEDULER MCPL         14500020
         MVC   LCBISZE-IEDQLCB(1,RTEMP),PCBRSERH RESERVE CNT TO LCB     14600020
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE TNT OFFSET             14700020
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP)                            14800020
         L     RZERO,PEWAQCBL           END OF THIS UNIT         Y02027 14900006
         SR    RZERO,RBUF               NUMBER OF EMPTY BYTES LEFT      15000020
         CLC   PEWALREC(2),AVTFZERO     SPECIAL NO-DATA EOM CASE Y02027 15040006
         BNE   MOVE                     BRANCH IF NO                    15080020
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BUFFER AS EOM              15120020
         B     POSTBUF                  POST BUFFER TO MH               15160020
         EJECT                                                          15200020
PUTSCHED EQU   *                                                 Y02027 15230006
         LA    RBASE,LABEL-IEDQEC(RENTRY) SCHED ADDRESSABILITY   Y02027 15260006
         CLI   LCBRSKEY-IEDQLCB(RPARM),PSVTO LCB                        15300006
         BNE   NOTLCB                   BRANCH IF NO           @XA11307 15304000
         CLI   LCBPRI-IEDQLCB(RPARM),DELAYPRI   LCB CAME       @XA11307 15304200
*                                         OFF OF TIME DELAY    @XA11307 15304400
         BNE   CLEANUP                  BRANCH IF NO           @XA11307 15304600
         MVI   LCBPRI-IEDQLCB(RPARM),RESETPRI NOT DELY PRIORITY@XA11307 15304800
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN  SET RECEIVE   @XA11307 15305000
*                                        SWITCH                @XA11307 15305200
         L     RPEWA,LCBERCCW-IEDQLCB(,RPARM) RESTORE PEWA ADDR@XA11307 15305400
         L     RPCB,PEPCBAD             PCB ADDRESS            @VS41903 15305600
         L     RWORK,PEWANEB            RESTORE DATA ADDRESS   @VS41903 15305800
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA  @VS41093 15306000
         B     NEWPUT                                          @XA11307 15306200
NOTLCB   EQU   *                                               @XA11307 15306400
         LR    RERB,RPARM               ERB ADDRESSABILITY       Y02027 15308006
         LA    RPCB,PEERB-IEDQPEWA      GET OFFSET TO PEWA       Y02027 15312006
         LR    RPEWA,RERB               GET ADDR OF ERB IN PEWA  Y02027 15316006
         SR    RPEWA,RPCB               COMPUTE PEWA ADDRESS     Y02027 15320006
         L     RPCB,PEPCBAD             PCB ADDRESSABILITY       Y02027 15324006
         L     RWORK,PEWANEB            RESTORE ADDR OF DATA     Y02027 15328006
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA    Y02027 15332006
         B     NEXTBUFX                 BRANCH FOR ERB           Y02027 15336006
*                                                                Y02027 15340006
*        PICK UP AND POST BUFFER SAVED FROM LAST OPERATION       Y02027 15344006
*                                                                Y02027 15348006
BUFSAVE  EQU   *                                                 Y02027 15352006
         ICM   RBFR,ALL,PERAQCB         ADDRESS OF SAVED BUFFER  Y02027 15356006
         BZ    NEXTBUFX                 BRANCH IF NO BUFFER TO   Y02027 15360006
*                                       POST                     Y02027 15364006
         XC    PERAQCB,PERAQCB          CLEAR ADDR OF PARTIAL    Y02027 15368006
*                                       BUFFER                   Y02027 15372006
         L     RTEMP,PRFLCB-ONE         GET LCB ADDRESS          Y02027 15376006
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE GET SRCE OFFSET Y02027 15380006
         LA    RZERO,PEWASCB            SCB ADDRESS              Y02027 15384006
         ST    RZERO,LCBSCBA-ONE-IEDQLCB(RTEMP) STORE IN LCB     Y02027 15388006
NEXTBUF  EQU   *                                                        15400006
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN       15440006
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO          15460006
*                                                                     * 15500006
*              FLAG THE LAST UNIT OF BUFFER BY STORING INVALID        * 15507006
*              TIC ADDRESS IN ITS TIC FIELD.                          * 15514006
*                                                                     * 15521006
SETFLAG  EQU     *                                                      15528006
         L     RPARM,PEWATIC            ADDR OF CURRENT BFR UNIT        15535006
TICX     EQU   *                                                        15542006
         NC    9(2,RPARM),9(RPARM)      LAST UNIT IN BUFFER             15549006
         BZ    TICIT                    BRANCH IF YES                   15556006
         L     RPARM,8(0,RPARM)         GET ADDR OF NEXT UNIT           15563006
         B     TICX                     GO CHECK FOR LAST UNIT          15570006
TICIT    EQU   *                                                        15577006
         MVI   11(RPARM),INVTIC         INVALID TIC ADDRESS             15584006
         LR    RPARM,RBFR               BUFFER PREFIX ADDRESS           15600006
         BAL    RETURN,DSPPOSTR         POST FULL BUFFER                15610006
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR          15620006
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS             15630006
NEXTBUFX EQU   *                                                        15640006
         ICM   RBFR,ADDR,LCBERBCH       ADDRESS OF NEXT EMPTY    Y01004 15650006
*                                       BUFFER.                  Y01004 15660006
         BZ    ERB                      IF NO EMPTY BUFFERS ARE  Y01004 15670006
*                                       LEFT, BRANCH TO GET MORE Y01004 15680006
*                                                                     * 16800020
*              INITIALIZE BUFFER PREFIX                               * 16900020
*                                                                     * 17000020
BUFINIT  EQU   *                                                        17100020
         MVI   PRFSTAT1,PRFNHDRN                                        17200020
         LA    RCNT,PRFSTXT-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914 17300061
         MVI   PRFPRI,PRIAPBFR          SET BUFFER PRIORITY             17400020
         MVI   PRFTIC,TIC               SET UP TIC FIELD                17500020
         LA    RBUF,PRFSTXT             START OF TEXT LABEL             17600020
         C     RWORK,PEWAMOVE           IS THIS THE BEGINNING OF Y02027 17700006
*                                       A NEW WORKAREA                  17800020
         BNE   GO                       BRANCH IF NOT TO AVOID          17900020
*                                       TESTING FOR HEADER              18000020
         MVI   PRFSTAT1,AVTEZERO        INIT BFR STATUS FIELD           18100020
         TM    PEWACTL,HDRFLG           HEADER SEGMENT           Y02027 18200006
         BO    PUTTEST                  BRANCH IF YES          @XA11307 18300000
         OI    PRFSTAT1,PRFNHDRN        SET NOT-HEADER FLAG IN          18400020
*                                       BUFFER PREFIX                   18500020
         B     GO                       BRANCH TO INITIALIZE LCB S21903 18600004
*                                       AND BUFFER PREFIX.       S21903 18650004
         SPACE 2                                               @XA11307 18651000
***************************************************************@XA11307 18652000
*                                                             *@XA11307 18653000
*                                                             *@XA11307 18654000
*  THIS CODE CONTROLS THE PROLIFIC PUTER.  THE USER SPECIFIES *@XA11307 18655000
*  A MAXIMUM NUMBER OF PUT'S (STORED IN PCBPACE) AND A TIME   *@XA11307 18656000
*  DELAY IN SECONDS (STORED IN PCBDELAY).  THUS AFTER THE     *@XA11307 18657000
*  SPECIFIED NUMBER OF PUT'S HAVE BEEN PROCESSED, A SPECIAL   *@XA11307 18658000
*  PRIORITY (X'D6') IS SET IN LCBPRI AND THE PUT LCB IS       *@XA11307 18659000
*  POSTED TO THE TIME DELAY SUBTASK.  AFTER THE REQUIRED DELAY*@XA11307 18660000
*  THE PUT LCB IS POSTED TO ITSELF BY TIME DELAY.             *@XA11307 18661000
*                                                             *@XA11307 18662000
*                                                             *@XA11307 18663000
***************************************************************@XA11307 18664000
PUTTEST  EQU   *                                               @XA11307 18665000
         NC    PCBPACE(TWO),PCBPACE     HAS USER SPECIFIED MAX @XA11307 18666000
*                                        NUMBER OF PUTS        @XA11307 18667000
         BZ    CLOSTST                  BRANCH IF NO           @XA11307 18668000
         NC    PCBDELAY(TWO),PCBDELAY   HAS USER SPECIFIED A   @XA11307 18669000
*                                        TIME DELAY            @XA11307 18670000
         BZ    CLOSTST                  BRANCH IF NO           @XA11307 18671000
         LH    RTEMP,PCBCNT             GET PUT COUNT          @XA11307 18672000
         LA    RTEMP,ONE(,RTEMP)        INCREMENT PUT COUNT    @XA11307 18673000
         STH   RTEMP,PCBCNT             RESET PUT COUNT        @XA11307 18674000
         CH    RTEMP,PCBPACE            HAS MAX NUMBER OF PUTS @XA11307 18675000
*                                        BEEN PROCESSED        @XA11307 18676000
         BNH   CLOSTST                  BRANCH IF NO           @XA11307 18677000
         XC    PCBCNT,PCBCNT            RESET PUT COUNT FOR    @XA11307 18678000
*                                        NEXT TIME DELAY       @XA11307 18679000
         L     RPARM,PCBLCBAD           GET LCB ADDRESS IN REG1@XA11307 18680000
*                                        FOR TIME DELAY ROUTINE@XA11307 18681000
         MVI   LCBPRI-IEDQLCB(RPARM),DELAYPRI  PRIORITY TO     @XA11307 18682000
*                                        SIGNAL TIME DELAY     @XA11307 18683000
         LA    RTEMP,AVTDELYB           TIME DELAY QUEUE       @XA11307 18684000
         ST    RTEMP,LCBQCBA-1-IEDQLCB(,RPARM)  FOR POST       @XA11307 18685000
         LA    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) SET UP STCB TO @XA11307 18686000
         ST    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) POINT TO ITSELF@XA11307 18687000
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBFREEN  SET LCB AS    @XA11307 18688000
*                                        FREE FOR TIME DELAY   @XA11307 18689000
         MVI   LCBRSKEY-IEDQLCB(RPARM),ENTRYFLG SET FLAG FOR   @XA11307 18690000
*                                        ENTRY AFTER DELAY     @XA11307 18691000
         MVC   LCBEOLTD-IEDQLCB(TWO,RPARM),PCBDELAY            @XA11307 18692000
*                                        TIME DELAY PARAMETER  @XA11307 18693000
         MVI   LCBTDL-IEDQLCB(RPARM),OFFSET INDEX FOR DELAY    @XA11307 18694000
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE @OZ26689 18694386
*                                       OF DATA IN WORK AREA   @OZ26689 18694686
         ST    RPARM,LCBCHAIN-IEDQLCB(,RPARM) QCB ADDESS       @XA11307 18695000
         ST    RPEWA,LCBERCCW-IEDQLCB(,RPARM) SAVE PEWA ADDRESS@XA11307 18696000
         NI    PCBOFLG,PIPOFF           TURN OFF PUT IN        @VS41517 18697000
*                                        PROGRESS BIT          @XA11307 18698000
         BAL   RETURN,DSPPOST           BRANCH TO TIME DELAY   @XA11307 18699000
CLOSTST  EQU   *                                                        18700020
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN CLOSEDOWN IN PROGRESS          18800020
         BNO   GO                       BRANCH IF NO                    18900020
         OI    PERCQCB+3,PBUF           SET ERROR FLAG                  19000020
         LA    RENTRY,QUICKC            SET CONDITION CODE       Y02027 19100006
         B     ERREXIT                  POST A.P. ECB            Y02027 19150006
         EJECT                                                          19200020
GO       EQU   *                                                        19300020
*                                                                     * 19320020
*        INITIALIZE LCB AND BUFFER PREFIX                             * 19340020
*                                                                     * 19360020
         MVC   PRFLCB(3),PCBLCBAD+1     PUT ADDRESS OF SOURCE LCB       19400020
*                                       INTO BUFFER PREFIX              19500020
         L     RPARM,PRFLCB-1           LCB ADDRESS                     19600020
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN SET RECIEVE SWITCH      19700020
         OI    LCBERBST-IEDQLCB(RPARM),LCBDLNKN                         19800020
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER MCPL         19900020
         LA    RZERO,PEWASCB            SOURCE SCB ADDRESS              20100020
         ST    RZERO,LCBSCBA-1-IEDQLCB(RPARM) STORE IT IN LCB           20200020
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RPARM)                        20300020
         ST    RPEWA,LCBERCCW-IEDQLCB(RPARM) SAVE PEWA ADDRESS          20400020
         MVC   PRFQCBA(3),PCBMH         ADDRESS OF MESSAGE HANDLER      20700020
*                                       TO PROCESS THIS BUFFER          20800020
         MVC   PRFSRCE(2),PEWAPETO      MOVE TERMNAME TABLE OFSETY02027 20900006
*                                       OF PUT PROCESS ENTRY INTO       21100020
*                                       SOURCE FIELD IN BFR PREFIX      21200020
         MVC   LCBTTCIN-IEDQLCB(2,RPARM),PRFSRCE  TNT OFFSET   @YA07129 21300061
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER                   21500020
         BO    STARTY                   BRANCH IF NO                    21600020
         MVC   LCBISZE-IEDQLCB(1,RPARM),PCBRSERH HEADER RESERVE@YA04914 21650061
         LA    RBUF,PRFSHDR             START OF HEADER LABEL           21700020
         LA    RCNT,PRFSHDR-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914 21750061
         MVC   PRFDEST(2),PEWAOFF       MOVE DESTINATION OFFSET  Y02027 21800006
*                                       TO TERMNAME TABLE FROM          21900020
*                                       PUT/WRITE WORKAREA INTO         22000020
*                                       BUFFER PREFIX                   22100020
         NC    PRFDEST(2),PRFDEST       DESTINATION OFFSET VALID        22200020
         BZ    STARTY                   BRANCH IF NOT TO BYPASS         22300020
*                                       LOCK MODE FUNCTIONS             22400020
         L     RPARM,PCBLCBAD           APPL PROG LCB ADDRESS           22500020
         NC    LCBINCAM-IEDQLCB(2,RPARM),LCBINCAM-IEDQLCB(RPARM)        22600020
*                                       OUTSTANDING LOCK RESPONSE       22700020
         BZ    STARTY                   BRANCH IF NO                    22800020
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE OFY02027 22900006
*                                       DATA IN W.A. TO BE MOVED Y02027 22910006
         ST    RBUF,PEWAPEUN            SAVE ADDR OF DATA IN BUF.Y02027 22920006
         ST    RENTRY,PEWASAVE          SAVE BUFFER ADDR         Y02027 22930006
         ST    RERB,PEWASAVE+4          SAVE ERB ADDR            Y02027 22940006
*                                                                Y02027 22950006
* REGISTERS 2,4, AND 8 MUST NOT BE CHANGED OR MUST BE SAVED AND  Y02027 22960006
* RESTORED IN PEWASAVE BEFORE GOING TO START.                    Y02027 22970006
*                                                                       22980006
         EJECT                                                          23000020
*                                                                     * 23100020
*      TEST TO SEE IF MESSAGE DESTINATION IS IN LOCK MODE             * 23200020
*                                                                     * 23300020
         SR    RPARM,RPARM              CLEAR WORK REGISTER TO ZERO     23400020
         LH    RPARM,PEWAOFF            DESTINATION OFFSET       Y02027 23500006
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALF           23600020
         L     RENTRY,AVTRNMPT          ADDRESS OF OFFSET               23700020
*                                       CONVERSION LOGIC                23800020
         BALR  RETURN,RENTRY            CONVERT OFFSET TO TERMINAL      23900020
*                                       TABLE ENTRY ADDRESS             24000020
         LR    RTEMP,RPARM              SAVE ENTRY ADDRESS     @Z30X8AM 24010008
         TM    TRMSTATE-IEDQTRM(RPARM),SINGLE VALID TERM ENTRY          24030020
         BNZ   START                    BRANCH IF NO                    24060020
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) GET ADDRESS OF         24100020
*                                       DEST QCB FROM TERM ENTRY        24200020
         LR    RUNIT,RPARM              SAVE DEST QCB ADDRESS    Y02027 24300006
         L     RPARM,QCBDCBAD-1-IEDQQCB(0,RPARM) GET ADDRESS OF         24400020
*                                       DCB FROM DEST QCB               24500020
*                                       VTAM TERMINAL            X03039 24510008
         TM    DCBOFLGS-IHADCB(RPARM),DCBOPEN  IS DCB OPENED            24600020
         BNO   START                    BRANCH IF NO                    24700020
         TM    TRMSTATE-IEDQTRM(RTEMP),TRMPREF VTAM TERMINAL   @G36XRAW 24703000
         BNO   NOT3705                  BR NO                  @G36XRAW 24706000
         LR    RPARM,RUNIT              RESTORE OCB ADDRESS      Y02027 24730006
         SH    RPARM,QCBHDRSZ           BACKUP TO RN PREFIX    @ZM47936 24740000
         ICM   RPARM,ALL,QCBPLCBA-ONE-IEDNQCB(RPARM) PLCB ADDR   Y02027 24750006
         BNM   START                    BRANCH IF POSITIVE - NO  S22024 24780022
*                                       PLCB ASSIGNED            S22024 24790022
         B     LCBLOOP                  BRANCH TO LCBLOOP        S22024 24800022
NOT3705  EQU   *                                                 S22024 24810022
         L     RERB,DCBDEBAD-IHADCB(RPARM)  GET DEB ADDR       @OZ35822 24830000
         CLC   QCBLKRLN-IEDQQCB(,RUNIT),DEBNMEXT(RERB)  TSO?   @OZ35822 24850000
         BH    START                    BR YES                 @OZ35822 24870000
         SR    RERB,RERB                CLEAR COUNTER TO ZERO    Y02027 24900006
         ICM   RERB,ONE,QCBLKRLN-IEDQQCB(RUNIT) GET LOCK         Y02027 24940006
*                                       RELATIVE LINE NUMBER.    Y01004 24990005
         BZ    START                    BRANCH IF TERMINAL IS   SA52508 25020005
*                                       NOT LOCKED.             SA52508 25040005
         TM    QCBDSFLG-IEDQQCB(RUNIT),QCBTSQ  IS TSO POSSIBLE @OZ35822 25045000
         BZ    NOTSO                    BR, NO                 @OZ35822 25050000
         ICM   RBUF,ADDR,DCBMH-IHADCB(RPARM)  GET MH ADDR      @OZ35822 25055000
         TM    QCBDSFLG-IEDQQCB(RUNIT),QCBALTMH  ALT MH ?      @OZ35822 25060000
         BZ    NOALTMH                  BR, NO                 @OZ35822 25065000
         L     RBUF,ZERO(RBUF)          GET ALT MH ADDR        @OZ35822 25070000
NOALTMH  EQU   *                                               @OZ35822 25075000
         TM    FOUR(RBUF),ONE           TSO MH                 @OZ35822 25080000
         BO    START                    BR YES, CAN'T BE LOCK  @OZ35822 25085000
NOTSO    EQU   *                                               @OZ35822 25090000
         SR    RZERO,RZERO              CLEAR REG TO ZERO               25100020
         LA    RZERO,LCBFLAG1-IEDQLCB                                   25200020
         SR    RBUF,RBUF                CLEAR REG TO ZERO        Y02027 25300006
         IC    RBUF,DCBEIOBX-IHADCB(RPARM) LCB LENGTH            Y02027 25400006
         L     RPARM,DCBIOBAD-IHADCB(0,RPARM)  GET ADDRESS OF           25500020
*                                       IOB FROM DCB                    25600020
         SR    RPARM,RZERO              ADDR OF DUMMY LCB               25700020
         MR    RBUF-ONE,RERB            COMPUTE LCB DISPLACEMENT Y02027 25730006
         AR    RPARM,RBUF               ADDR OF LCB              Y02027 25800006
LCBLOOP  EQU   *                                                 Y02027 25870006
         CLC   LCBTTCIN-IEDQLCB(2,RPARM),PEWAOFF  LCB FOR MESSAGEY02027 25940006
*                                       DESTINATION              Y02027 26010006
         BNE   START                    BRANCH IF NO                    26100020
         EJECT                                                          26500020
*                                                                     * 26620020
*        INSURE THAT CURRENT MESSAGE IS CORRECT RESPONSE              * 26640020
*                                                                     * 26660020
         LR    RZERO,RPARM              SAVE LCB ADDRESS                26700020
         L     RPARM,LCBSCBA-1-IEDQLCB(0,RPARM) GET ADDRESS OF          26702020
*                                       SCB FROM LCB                    26704020
         TM    SCBSTATE-IEDQSCB(RPARM),SCBLCK1N+SCBMSGLN  LOCK MODE     26706020
         BZ    START                    BRANCH IF NO                    26708020
         LR    RPARM,RZERO              RESTORE LCB ADDRESS             26710020
         L     RPARM,LCBINSRC-1-IEDQLCB(0,RPARM) INQUIRY DEST OFFSET    26714020
         SRL   RPARM,8                                                  26721020
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALFWORD       26728020
         LTR   RPARM,RPARM              LINE NOT LOCKED                 26730020
         BZ    START                    BRANCH IF NO                    26732020
         LR    RTEMP,RZERO              SAVE SOURCE LCB ADDRESS  Y02027 26735006
         L     RENTRY,AVTRNMPT          TNT OFFSET CONVERTER            26749020
         BALR  RETURN,RENTRY            GET TERM ENTRY ADDRESS          26756020
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) DEST QCB ADDRESS       26763020
         CLC QCBDCBAD-IEDQQCB(3,RPARM),PEPCBAD+ONE PCB'S EQUAL   Y02027 26770006
         BNE   START                    BRANCH IF NO                    26777020
         LR    RZERO,RTEMP              RESTORE SOURCE LCB ADDR  Y02027 26784006
         L     RPARM,LCBSCBA-ONE-IEDQLCB(RTEMP) GET ADDRESS OF   Y02027 26884006
*                                       SCB FROM LCB             Y02027 26984006
         TM    LCBINSRC+2-IEDQLCB(RTEMP),LOCKR   LINE DUE A RESPONSE    27140020
         BNO   START                    BRANCH IF NO                    27160020
         NI    LCBINSRC+2-IEDQLCB(RTEMP),AVTEFF-LOCKR                   27180020
         LA    RTEMP,PEWASCB            SOURCE SCB                      27200020
         MVC   SCBSTATE-IEDQSCB(1,RTEMP),SCBSTATE-IEDQSCB(RPARM)        27400020
*                                       COPY LOCK FLAGS TO SOURCE SCB   27500020
         NI    SCBSTATE-IEDQSCB(RTEMP),SCBLCK1N+SCBMSGLN                27800020
         LR    RPARM,RZERO              ADDRESS OF SOURCE LCB           28100020
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS      Y02027 28700006
         L     RTEMP,PCBLCBAD           APPL PROG LCB ADDRESS           28800020
         LH    RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  LOCK RESPONSE COUNT    28900020
         BCTR  RETURN,0                 DECREMENT COUNT BY ONE          29000020
         STH   RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  NEW RESPONSE COUNT     29100020
         TM    QCBSLINK+TWO-IEDQQCB(RUNIT),RELEASE  RELEASE IN   Y02027 29230006
*                                       EFFECT                   Y02027 29240006
         BO    START                    BRANCH IF YES                   29260020
         TM    QCBINSRC+2-IEDQQCB(RUNIT),QCBDELAY              @ZA03747 29260581
*                                       QCB IN TIME DELAY QUEUE OX02215 29261054
         BNO   NOTIMQ                   BRANCH IF NO            OX02215 29261554
         LR    RTEMP,RPARM              SAVE LCB ADDRESS        OX02215 29262054
         LR    RPARM,RUNIT              GET QCB ADDRESS        @ZA03747 29262581
         L     RENTRY,AVTHG02           ADDRESS OF TIME DELAY   OX02215 29263054
*                                       REMOVAL ROUTINE         OX02215 29263554
         BALR  RETURN,RENTRY            REMOVE QCB FROM TDQ     OX02215 29264054
         LR    RPARM,RTEMP              RESTORE LCB ADDRESS     OX02215 29265054
         LA    RETURN,QCBSTVTO-IEDQQCB(,RUNIT) ADDRESS OF SEND @ZA03747 29265581
*                                        SCHEDULER STCB        @ZA03747 29266081
         MVC   QCBSLINK-IEDQQCB(3,RUNIT),QCBSTCHN-IEDQQCB(RUNIT)        29266581
         STCM  RETURN,ADDR,QCBSTCHN-IEDQQCB(RUNIT)             @ZA03747 29267081
*                                       PUT SEND SCHEDULER BACK OX02215 29267554
*                                       INTO THE QCB            OX02215 29268054
NOTIMQ   EQU   *                                                OX02215 29268554
*                                                                     * 29270020
*        FIND SEND SCHEDULER AND INSERT IT'S STCB IN LCB              * 29280020
*                                                                     * 29290020
         L     RTEMP,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF TOP STCB    Y02027 29300006
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           29400020
         LA    RZERO,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF STCB        Y02027 29500006
         LA    RBUF,LCBSTCBA-1-IEDQLCB(0,RPARM) STCB CHAIN ADDR         29600020
         CR    RTEMP,RZERO              SEND SCHED ON DEST QCB          29700020
         BNE   STCBOUT                  BRANCH IF NO                    29800020
         MVC   QCBSTCHN-IEDQQCB(3,RUNIT),QCBSLINK-IEDQQCB(RUNIT) Y02027 29900006
*                                       REMOVE SEND SCHED FROM CHAIN    30000020
         LR    RPARM,RZERO              SEND SCHEDULER ADDRESS          30100020
INSERT   EQU   *                                                        30200020
         BAL   RETURN,DSPLIFOR          PUT SEND SCHEDULER ON TOP       30300020
         B     START                    RETURN TO MAINLINE CODE         30400020
STCBOUT  EQU   *                                                        30500020
         LA    RETURN,NOPLCBS           SET FOR POSSIBLE SCAN  @SA72774 30510061
         CLI   LCBFLAG1-IEDQLCB(RPARM),AVTEZERO PLCB             S22024 30520000
         BE    STCBOUTX                 BRANCH YES - USE COMMON  S22024 30540000
*                                       CODE                     S22024 30560000
         TM    LCBSTAT2-IEDQLCB(RPARM),LCBDIAL DIAL LINE                30600020
         BO    DIAL                     BRANCH IF YES                   30700020
STCBOUTX EQU   *                                                        30800020
         L     RTEMP,LCBSTCBA-1-IEDQLCB(0,RPARM) TOP STCB IN LCB        30900020
         LA    RWORK,4(0,RPARM)         SIMULATE FIRST ELEMENT          31000020
STCBLOOP EQU   *                                                        31100020
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           31200020
         CR    RTEMP,RZERO              DESIRED SEND SCHED STCB         31300020
         BE    DELINK                   BRANCH IF YES                   31400020
         CLI   4(RTEMP),AVTEZERO        END OF STCB CHAIN       SA52991 31430022
         BCR   AVTECD8,RETURN           BRANCH IF YES           SA52991 31460022
         LR    RWORK,RTEMP                                              31500020
         L     RTEMP,4(0,RTEMP)         ADDR OF NEXT STCB               31600020
         B     STCBLOOP                 GET NEXT STCB                   31700020
DELINK   EQU   *                                                        31800020
         MVC   5(3,RWORK),5(RTEMP)      DELINK STCB                     31900020
         LR    RPARM,RTEMP              DISP PARM REG                   32000020
         B     INSERT                   PUT STCB ON TOP OF CHAIN        32100020
         EJECT                                                 @SA72774 32107061
NOPLCBS  EQU   *                                               @SA72774 32114061
         SPACE 1                                               @SA72774 32121061
* THIS SUBROUTINE SETS UP PARAMETERS NEEDED TO SCAN THE  *     @SA72774 32128061
* 'NO-PLCBS' CHAIN FOR THE SEND SCHEDULER IF IT IS NOT   *     @SA72774 32135061
* ALREADY IN THE PLCB.                                   *     @SA72774 32142061
         SPACE 2                                               @SA72774 32149061
         L     RWORK,AVTSAVTP           SECONDARY AVT ADDRESS  @SA72774 32156061
         L     RWORK,SAVTPLCB-IEDNSVTD(,RWORK)                 @SA72774 32163061
*                                       PLCB RETURN QCB ADDRESS@SA72774 32170061
         L     RTEMP,FOUR(,RWORK)       FIRST ELEMENT ON QUEUE @SA72774 32177061
         B     STCBLOOP                 GO SCAN 'NO-PLCB' CHAIN@SA72774 32184061
         EJECT                                                          32200020
DIAL     EQU   *                                                        32300020
         TM    QCBTSOF1-IEDQQCB(RUNIT),QCBDELAY QCB IN TIME DELAYY02027 32400006
         BNO   DIALQ                    BRANCH IF NO                    32500020
         LR    RPARM,RZERO              STCB ADDRESS                    32600020
         B     INSERT                   BRANCH TO INSERT         S21903 32700004
*                             SEND SCHEDULER'S STCB IN LCB CHAIN S21903 32750004
DIALQ    EQU   *                                                        32800020
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDR        Y02027 32900006
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO          33000020
         IC    RTEMP,DCBEIOBX-IHADCB(0,RWORK)   LCB SIZE                33100020
         L     RWORK,DCBIOBAD-IHADCB(0,RWORK) IOB ADDRESS               33200020
         LA    RWORK,0(0,RWORK)         CLEAR HIGH-ORDER BYTE           33300020
         LA    RETURN,LCBFLAG1-IEDQLCB+8 OFFSET TO DIALOUT QUEUE        33400020
         SR    RWORK,RETURN             ADDR OF DIALOUT CALL Q          33500020
         AR    RWORK,RTEMP              ACTUAL LCB ADDRESS              33600020
DCQLOOP  EQU   *                                                        33700020
         L     RTEMP,4(0,RWORK)         ADDR OF STCB ON D.C. Q          33800020
         CLI   4(RTEMP),0               END OF D.C. QUEUE               33900020
         BE    SCANALL                  BRANCH IF YES           SA52991 34000022
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           34100020
         CR    RZERO,RTEMP              DEST SCHED STCB FOUND           34200020
         BE    DELINK                   BRANCH IF YES                   34300020
         LR    RWORK,RTEMP              SAVE TOP STCB ADDR              34400020
         B     DCQLOOP                  GO TEST NEXT STCB               34500020
         EJECT                                                          34503022
SCANALL  EQU   *                                                SA52991 34506022
*                                                               SA52991 34509022
*        FIND DEST QCB FOR LOCKED TERMINAL BY SCANNING THE      SA52991 34512022
*        STCB CHAIN FOR EACH LCB IN LINE GROUP.                 SA52991 34515022
*                                                               SA52991 34518022
         SPACE                                                          34521022
         SR    RPCB,RPCB                CLEAR REGISTER           Y02027 34524006
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDRESS     Y02027 34534006
         L     RERB,DCBDEBAD-IHADCB(RWORK)  ADDRESS OF DEB       Y02027 34544006
         IC    RPCB,DEBNMEXT(RERB)      NUMBER OF LCBS IN GROUP  Y02027 34554006
         L     RPARM,DCBIOBAD-IHADCB(RWORK)  IOB ADDRESS         Y02027 34564006
         LA    RERB,LCBFLAG1-IEDQLCB    OFFSET FROM LCB TO IOB   Y02027 34574006
         SR    RPARM,RERB               ADDR OF DUMMY LCB        Y02027 34584006
         IC    RERB,DCBEIOBX-IHADCB(RWORK) SIZE OF LCB           Y02027 34594006
RLNLOOP  EQU   *                                                 Y02027 34604006
         AR    RPARM,RERB               FIRST OR NEXT LCB        Y02027 34614006
         BAL   RETURN,STCBOUTX          CHAIN STCB               Y02027 34624006
         BCT   RPCB,RLNLOOP             BRANCH- LOOK AT NEXT LCB Y02027 34634006
*                                       LOCK NOT FOUND           Y02027 34644006
         EJECT                                                          34654006
START    EQU   *                                                 Y02027 34664006
         L     RERB,PEWASAVE+4          RESTORE ERB ADDR         Y02027 34674006
         L     RWORK,PEWANEB            RESTORE WORKAREA ADDRESS Y02027 34684006
         L     RBUF,PEWAPEUN            RESTORE ADDR OF DATA IN  Y02027 34694006
*                                       BUFFER                   Y02027 34704006
         L     RENTRY,PEWASAVE          RESTORE BUFFER ADDR      Y02027 34714006
STARTY   EQU   *                                                        34900020
         LR    RPARM,RBFR               ADDRESS OF FIRST BUFFER UNIT    35000020
*                                       LINK FIELD                      35100020
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR          35200020
         MVI   PEWATIC,PSVTO                                            35300020
*                                                                     * 35420020
*        COMPUTE BUFFER SIZE, UNIT SIZE, AND UNITS PER BUFFER         * 35440020
*                                                                     * 35460020
         LA    RZERO,PRFSUNIT           START OF BUFFER AFTER UMA       35500020
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED               35700020
         BNH   LESS                     BRANCH IF YES                   35800020
         AH    RZERO,PEWASOWA           EMPTY BYTE COUNT                35900020
         B     CONT                     BRANCH TO                S21903 36000004
*                                       SET-END-OF-UNIT ADDR     S21903 36050004
LESS     EQU   *                                                        36100020
         AH    RZERO,AVTKEYLE           ADDRESS OF END OF BUFFER        36200020
CONT     EQU   *                                                        36300020
         ST    RZERO,PEWAQCBL           ADDR OF END OF THIS UNIT Y02027 36400006
         SR    RZERO,RBUF               SIZE OF DATA FIELD IN BFR       36500020
*                                                                     * 36620020
*              ALLOW SPACE IN BUFFER FOR RESERVE CHARACTERS           * 36640020
*                                                                     * 36660020
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS             36700020
         SR    RTEMP,RTEMP              CLEAR COUNTER                   36800020
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER                   36900020
         BO    TEXTBFR                  BRANCH IF NO                    37000020
         ICM   RTEMP,ONE,PCBRSERH       RESERVE CHARACTER COUNT. Y01004 37100005
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004 37200005
*                                       CHARACTERS FOR HEADER.   Y01004 37300005
         B     BUMPER                   BUMP POINTER & COUNTER          37400020
TEXTBFR  EQU   *                                                        37500020
         ICM   RTEMP,ONE,PCBRSERT       RESERVE CHARACTER COUNT. Y01004 37600005
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004 37700005
*                                       CHARACTERS FOR TEXT.     Y01004 37800005
BUMPER   EQU   *                                                        37900020
         AR    RBUF,RTEMP               BUMP PAST RESERVE CHARS         38000020
         AR    RCNT,RTEMP               ADD RESERVE CHAR COUNT          38100020
         SR    RZERO,RTEMP              SUBTRACT RESERVE COUNT          38200020
         EJECT                                                          38300020
*                                                                     * 38400020
*        MOVE DATA FROM USER'S WORKAREA TO THE MCP BUFFER             * 38500020
*                                                                       38600020
         SPACE                                                          38700020
MOVE     EQU   *                                                        38800020
         LR    RTEMP,RZERO              SIZE OF DATA FIELD IN BFR       38900020
         CR    RTEMP,RNUM               MORE THAN ONE UNIT      OY00458 38920005
         BNH   MOVE1                    BRANCH IF NO            OY00458 38940005
         LR    RTEMP,RNUM               SET SMALLER COUNT       OY00458 38960005
MOVE1    EQU   *                                                OY00458 38980005
         BCTR  RTEMP,RZERO              DECREMENT COUNT BY ONE          39000020
         EX    RTEMP,MOVER              FILL THE BUFFER                 39100020
         CR    RNUM,RZERO               WORKAREA EMPTY                  39200020
         BH    NEXT                     BRANCH IF NO                    39300020
*                                                                Y02027 39320006
*        WORKAREA IS EMPTY - PREPARE TO RETURN                   Y02027 39340006
*                                                                Y02027 39360006
         AR    RCNT,RNUM                INCREMENT COUNTER OF BYTES      39400020
*                                       MOVED INTO BUFFER               39500020
         AR    RBUF,RNUM                ADDR OF NEXT EMPTY BYTE         39600020
         STH   RCNT,PRFSIZE             STORE BYTE COUNT IN PREFIX      39700020
         TM    PEWAOPTC,MSGFLG          IS WORK UNIT A MESSAGE   Y02027 39800006
         BO    NORECDEL                 BRANCH IF YES            Y02027 40000006
         TM    PEWAGSW,VARFLG           VARIABLE FORMAT          Y02027 40200006
         BNO   NORECDEL                 BRANCH IF NO                    40500020
         L     RTEMP,PEWAPROC           PROCESS ENTRY ADDRESS           40600020
         NC    TRMCHCIN-IEDQTRM(1,RTEMP),TRMCHCIN-IEDQTRM(RTEMP)        40700020
*                                       RECORD DELIMITER SPECIFIED      40800020
         BZ    NORECDEL                 BRANCH IF NO             A44891 40900021
         BCTR  RBUF,0                   BACK UP ONE BYTE                41000020
         MVC   0(1,RBUF),TRMCHCIN-IEDQTRM(RTEMP) RECORD DELIMITER       41100020
         LA    RBUF,1(0,RBUF)           BUMP TO NEXT EMPTY BYTE         41200020
NORECDEL EQU   *                                                        41300020
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BFR AS EOM                 41400020
         TM    PEWACTL,EOMFLAG          WORKAREA CONTAIN END OF  Y02027 41500006
*                                       A MESSAGE                       41600020
         BO    POSTBUF                  BRANCH IF YES TO POST BFR       41700020
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM BIT IN PREFIX       41800020
         ST    RBFR,PERAQCB             SAVE ADDR OF LAST FILLED        41900020
*                                       BUT NON-EOM BUFFER              42000020
         OI    PEWAFLG,PBUF             PARTIAL BUFFER FLAG      A44891 42050021
         C     RBUF,PERAQCB+4           IS CURRENT UNIT FULL            42100020
         BNL   FULLUNIT                 BRANCH IF YES.           Y01004 42200005
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR.  Y01004 42206005
         MVI   PEWATIC,PSVTO            SET PUT SCHEDULER MCPL.  Y01004 42212005
         ST    RBUF,PEWACBUF            SAVE ADDRESS OF NEXT     Y02027 42218006
*                                       EMPTY BYTE.              Y01004 42224005
         B     CLEANX                   GO POST APPLICATION      Y01004 42230005
*                                       PROGRAM ECB.             Y01004 42236005
FULLUNIT EQU   *                                                 Y01004 42242005
         LA    RETURN,CLEANX            SET UP RETURN ADDRESS           42250020
*                                       FROM 'SETUNIT' ROUTINE.  Y01004 42270005
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT TO FILL            42300020
         BNZ   SETUNIT                  BRANCH IF YES                   42400020
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER          42500020
         B     CLEANX                   GO POST APPL PROG ECB           42600020
         EJECT                                                          42700020
*                                                                Y02027 42900006
*        OBTAIN ANOTHER EMPTY UNIT OR BUFFER TO FILL             Y02027 43100006
*                                                                Y02027 43300006
NEXT     EQU   *                                                        43800020
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM FLAG                43900020
         AR    RCNT,RZERO                                               44000020
         STH   RCNT,PRFSIZE                                             44100020
         SR    RNUM,RZERO               COMPUTE SIZE OF DATA            44200020
*                                       REMAINING IN WORKAREA           44300020
         STH   RNUM,PEWALREC            AND SAVE                 Y02027 44350006
         AR    RWORK,RZERO              ADDRESS OF NEXT BYTE OF         44400020
*                                       DATA TO BE MOVED                44500020
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT IN BUFFER          44600020
         BZ    NEXTBUF                  BRANCH IF NO                    44700020
         LA    RETURN,MOVE              SET UP RETURN ADDRESS           44730020
*                                       FROM 'SETUNIT' ROUTINE.  Y01004 44740005
SETUNIT  EQU   *                                                        44760020
         L     RBUF,8(0,RPARM)          ADDRESS OF NEXT UNIT            44800020
         MVI   8(RBUF),TIC              SET UP TIC COMMAND              44900020
         LR    RPARM,RBUF               ADDRESS OF NEXT BUFFER UNIT     45000020
*                                       LINK FIELD                      45100020
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR          45200020
         MVI   PEWATIC,PSVTO                                            45300020
         LA    RBUF,AVTUMALN(0,RBUF)    ADDRESS OF FIRST EMPTY          45500020
*                                       BYTE IN BUFFER                  45600020
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED               45700020
         BNH   LESSA                    BRANCH IF YES                   45800020
         LH    RZERO,PEWASOWA           EMPTY BYTE COUNT                45900020
         B     CONTA                    BRANCH TO                S21903 46000004
*                                       COMPUTE END-OF-UNIT ADDR S21903 46050004
LESSA    EQU   *                                                        46100020
         LH    RZERO,AVTKEYLE           NUMBER OF EMPTY BYTES           46200020
*                                       IN BUFFER                       46300020
         LH    RTEMP,PEWASOWA           MAXIMUM BUFSIZE        @YA04914 46310061
         N     RTEMP,AVTCLRHI           CLEAR HIGH HALFWORD    @YA04914 46320061
         SH    RTEMP,PRFSIZE            SPACE AVAILABLE IN UNIT@YA04914 46330061
         CR    RTEMP,RZERO               LESS THAN KEY LENGTH  @YA04914 46340061
         BNL   CONTA                    NO, BRANCH             @YA04914 46350061
         LR    RZERO,RTEMP              SET SHORT LAST UNIT    @YA04914 46360061
CONTA    EQU   *                                                        46400020
         LR    RTEMP,RBUF               FIRST EMPTY BYTE IN BFR         46500020
         ST    RBUF,PEWACBUF            FIRST EMPTY BYTE ADDRESS Y02027 46550006
         AR    RTEMP,RZERO              ADDR OF END OF THIS UNIT        46600020
         ST    RTEMP,PEWAQCBL           SAVE THIS POINTER        Y02027 46700006
         BR    RETURN                   RETURN TO CALLER                46800020
         EJECT                                                          46900020
*                                                                Y02027 46920006
*        POST BUFFER TO MESSAGE HANDLER                          Y02027 46940006
*                                                                Y02027 46960006
POSTBUF  EQU   *                                                        48300020
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN       48500020
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO          48600020
         LR    RPARM,RBFR               ADDR OF BUFFER TO POST          48700020
         L     RTEMP,PEWATIC            ADDR OF CURRENT TIC FIELD       48800020
TICLOOP  EQU   *                                                        48900020
         NC    9(2,RTEMP),9(RTEMP)      LAST UNIT IN BUFFER             49000020
         BZ    SETTIC                   BRANCH IF YES                   49100020
         L     RTEMP,8(0,RTEMP)         GET ADDR OF NEXT UNIT           49200020
         B     TICLOOP                  GO CHECK FOR LAST UNIT          49300020
SETTIC   EQU   *                                                        49400020
         MVI   11(RTEMP),INVTIC         SET INVALID TIC ADDRESS TO      49460020
*                                       INDICATE END OF BUFFER          49520020
         L     RTEMP,PRFLCB-1           LCB ADDRESS                     49600020
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP) SAVE PEWA ADDR IN LCB      49700020
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR          49750020
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNLSTN EOM BUFFER      SA58449 49756000
         BNO   YESEOM                   BRANCH IF YES          @G36XRAW 49756510
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW 49757010
YESEOM   EQU   *                                               @G36XRAW 49757510
         OI    PEWAFLG,ERBBUSY          SET LCB TO BE POSTED            49770010
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW 49775010
         SPACE 3                                                        49900020
         EJECT                                                          51100020
CLEANUP  EQU   *                                                        51200020
*                                                                     * 51300020
*        POST WAITING APPLICATION PROGRAM COMPLETE               Y02027 51400006
*                                                                     * 51500020
         L     RPEWA,LCBERCCW-IEDQLCB(RPARM) RESTORE PEWA ADDR          51600020
         NI    PEWAFLG,AVTEFF-ERBBUSY   SET LCB NOT LOOSE               51620020
         MVI   PEWASCB,AVTEZERO         RESET SCBSTATE TO NOT LOCK      51660020
         NI    LCBERBST-IEDQLCB(RPARM),LCBDLNKF SET ERB NOT POSTED      51730020
         TM    PEWAFLG,CFLG             CLOSE IN PROGRESS               51800020
         BO    CLOSE                    BRANCH IF YES                   51900020
CLEANX   EQU   *                                                        52000020
         SR    RENTRY,RENTRY            SET GOOD RETURN CODE     Y02027 52100006
ERREXIT  EQU   *                                                 Y02027 52150006
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027 52200006
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT DONE             Y02027 52250006
*                                                                Y02027 52300006
*              POST APPLICATION PROGRAM ECB COMPLETE             Y02027 52350006
*                                                                Y02027 52400006
XMPOST   EQU   *                                                 Y02027 52450006
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027 52500006
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027 52550006
         SR    RPARM,RZERO              GET AIB ADDRESSABILITY   Y02027 52600006
XMPOST1  EQU   *                                                 Y02027 52650006
         LR    RZERO,RENTRY             LOAD COMPLETION CODE     Y02027 52700006
         LTR   RZERO,RZERO              ERROR CONDITION?       @OZ34827 52703000
         BZ    XMPOST1A                 BR, NO                 @OZ34827 52706000
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED @OZ34827 52709000
         BNO   XMPOST1A                 BR, NO                 @OZ34827 52712000
         OI    PEWAGSW+ONE,NEEDHDRN     SET NEED HDR ON NXT PUT@OZ34827 52715000
         CLM   RZERO,ONE,FIVEC          ERROR  '5C' ?          @OZ34827 52718000
         BNE   XMPOST1A                 BR, NO                 @OZ34827 52721000
         TM    PEWACTL,HDRFLG           F1 OR F3 MSG SEG       @OZ34827 52724000
         BO    XMPOST1A                 BR, YES                @OZ34827 52727000
         NI    PEWAGSW+ONE,AVTEFF-NEEDHDRN RESET NEED HDR ON   @OZ34827 52730000
*                                           NEXT PUT.          @OZ34827 52733000
XMPOST1A EQU   *                                               @OZ34827 52736000
         MVC   AIBCMPTP(4),PEWAECBA     STORE ECB  IN LIST       Y02027 52750006
         MVC   AIBCMPTP(4),PEWAECBA     STORE ECB  IN LIST       Y02027 52770000
         L     RERB,PCBPEBAD            GET PEB ADDRESS          Y02027 52800006
         LTR   RERB,RERB                TEST IF AP IS ACTIVE     Y02027 52850006
         BNZ   XMPOST2                  YES, BYPASS AIB FREEING  Y02027 52900006
         MVI   AIBSTATE,AIBFREE         FREE AIB                 Y02027 52950006
         BAL   RETURN,DSPDISP           BR TO AVOID XMPOST     @G36XRAW 53000006
XMPOST2  EQU   *                                                 Y02027 53050006
         L     RERB,PEBASCB-IEDQPEB(RERB) GET ASCB ADDRESS       Y02027 53100006
         LTR   RERB,RERB                TEST IF FLAG HAS         Y02027 53150006
*                                       INVALIDATED ASCB ADDR    Y02027 53200006
         BNM   NONEGFLG                 BRANCH IF NEGATIVE FLG @G36XRAW 53250006
*                                       OFF-                   @G36XRAW 53300006
         BAL   RETURN,DSPDISP           BRANCH-AVOID XMPOST    @G36XRAW 53301010
NONEGFLG EQU   *                                               @G36XRAW 53302010
         L     RENTRY,PCBPEBAD          PEB ADDR               @ZA05000 53305081
         IEDGETCB REG1=RTEMP,CBNAME=TCX          ADDR OF TCX       @N1C 53305527
         CLC   PEBASID-IEDQPEB+TWO(2,RENTRY),TCXASID-IEDQTCX(RTEMP)     53320081
*                                       IS A.P. SUBTASK OF MCP @ZA05000 53325081
         BNE   XMPOST3                  BR, NO                 @ZA05000 53330081
         L     RPARM,AIBCMPTP           GET ECB ADDR           @ZA05000 53335081
         POST  (1),(0)                  DO NORMAL POST         @ZA05000 53337081
         BAL   RETURN,DSPDISP           RETURN TO DISPATCHER   @G36XRAW 53340010
XMPOST3  EQU   *                                               @ZA05000 53345081
*        ISSUE SVC 102 TO SCHEDULE SRB TO POST THE             @Z40X9AG 53350000
*        ECB IN THE APPLICATION PROGRAM"S MEMORY               @Z40X9AG 53360000
         MVC   AIBSSPAS,PEBASCB-IEDQPEB(RENTRY) SET ASCB ADDR  @Z40X9AG 53400000
         MVC   AIBSSPID,PEBASID+TWO-IEDQPEB(RENTRY) SET ASID   @Z40X9AG 53410000
         STC   RZERO,AIBSSPCC           SET COMPLETION CODE    @Z40X9AG 53450000
         MVC   AIBSSPTC,PEBTCB-IEDQPEB(RENTRY) SET TCB ADDR    @Z40X9AG 53500000
         MVI   AIBSSPF1,AIBSSPEC        SET ENTRY CODE         @Z40X9AG 53510000
         LA    RPARM,AIBCMPTP           POINT TO PARM LIST     @Z40X9AG 53550000
         AQCTL                          SVC 102                @Z40X9AG 53560000
         BAL   RETURN,DSPDISP           BRANCH-TO DISPATCHER   @G36XRAW 53700010
        SPACE 2                                                         54000020
*                                                                Y02027 54100006
*        CLOSE IS WAITING FOR END OF MESSAGE THROUGH MH          Y02027 54160006
*        POST ELEMT SET UP BY CLOSE                              Y02027 54220006
*                                                                Y02027 54280006
CLOSE    EQU   *                                                 Y02027 54340006
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027 54400006
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027 54460006
         SR    RPARM,RZERO              GET START OF AIB         Y02027 54520006
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027 54640006
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT AS FINISHED      Y02027 54700006
         L     RPARM,PEWARCB            GET ADDR OF RCB SET    @OZ07798 54760081
*                                       UP BY CLOSE              Y02027 54820006
         TS    FORTY7(RPARM)            SET POSTED FLAG IN RCB     @22A 54866627
         BNZ   ELEMONQ                  BR, CLOSE ELEM ON RDYQ     @22A 54913227
         BAL   RETURN,DSPPOST           PUT CLOSE ELEM ON Q        @22A 54959827
ELEMONQ  EQU   *                                                   @22A 55006427
         BAL   RETURN,DSPDISP           RETURN TO DISPATCHER       @22A 55053027
         EJECT                                                          55100020
         EJECT                                                          57200020
ERB      EQU   *                                                        57300020
         SPACE                                                          57400020
*                                                                     * 57500020
*     INITIALIZE ERB TO OBTAIN EMPTY BUFFERS                          * 57600020
*                                                                     * 57700020
         SPACE                                                          57800020
         LA    RPARM,AVTBFREB           ADDRESS OF AVAILABLE            57900020
*                                       BUFFER QCB                      58000020
         ST    RPARM,LCBERB             INITIALIZE ERB KEY AND          58100020
*                                       QCB FIELDS                      58200020
         MVI   LCBERBPY,PRIINTRQ        SET ERB PRIORITY                58300020
         XC    LCBERBLK(3),LCBERBLK     CLEAR ERB LINK FIELD TO ZERO    58400020
         MVI   LCBERBST,PUTFLG          FLAG THIS ERB AS A PUT ERB      58500020
         XC    LCBERBCH(3),LCBERBCH     SET BUFFER CHAIN PTR TO ZERO    58600020
         SR    RZERO,RZERO              CLEAR WORK REG         @SA69971 58700061
         IC    RZERO,PCBBUFIN           IN/OUT COUNT           @SA69971 58750061
         SRL   RZERO,FOUR               ISOLATE BUFIN          @SA69971 58800061
         STC   RZERO,LCBERBCT           INITIALIZE BFR REQ     @SA69971 58850061
         MVC   LCBERBCT+1(1),PEUNCT     UNITS PER BUFFER                58900020
         LA    RZERO,PEWASCB            SCB ADDRESS                     59000020
         ST    RZERO,LCBSCBA-1          ADDRESS OF CURRENT SCB          59100020
         L     RPARM,PCBLCBAD           LCB ADDRESS                     59200020
         ST    RZERO,LCBSCBA-1-IEDQLCB(,RPARM) SET SCB FOR MSG   A48279 59250022
         LA    RZERO,PERAQCB            ADDRESS OF PUT SCHEDULER        59400020
*                                       QCB                             59500020
         ST    RZERO,PERCQCB            MAKE ADDRESS OF QCB             59600020
*                                       AVAILABLE TO BUFFER REQUEST     59700020
*                                       SUBTASK                         59800020
         MVI   LCBPRI-IEDQLCB(RPARM),PRIAPBFR  LCB PRIORITY             59900020
         MVI   LCBERBST-IEDQLCB(RPARM),LCBDLNKN SET DELINK SWITCHY02027 60000006
         LA    RZERO,LCBRSKEY-IEDQLCB(RPARM) STCB ADDRESS        Y02027 60100006
         ST    RZERO,LCBRSKEY-IEDQLCB(RPARM) PUT STCB IN LCB     Y02027 60200006
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER VTO          60300020
         MVI   LCBLSPCI+2-IEDQLCB(RPARM),1 INVALID CCW OP CODE          60400020
         EJECT                                                          60500020
*                                                                     * 60700020
*        POST ERB TO BUFFER REQUEST QCB VIA DISPATCHER                * 60800020
*                                                                     * 60900020
         SPACE                                                          61000020
         ST    RWORK,PEWANEB            SAVE ADDRESS OF NEXT     Y02027 61100006
*                                       BYTE OF DATA IN WORKAREA Y02027 61150006
         LR    RPARM,RERB               ADDRESS OF ERB TO POST          61200020
         BAL   RETURN,DSPCHAIN          POST ERB TO BUFFER     @G36XRAW 61300020
*                                       REQUEST                @G36XRAW 61350010
         SPACE 3                                                        61400020
*                                                                Y02027 61420006
TNAMEL   DC    H'8'                     SIZE OF TERMNAME         Y02027 61820006
QCBHDRSZ DS    0H                       SIZE OF QCB HEADER     @ZM47936 61860000
         DC    AL2(QCBPRFSZ)                                   @ZM47936 61900000
PATCH    DC    25H'0'                   PATCH AREA               Y02027 62020006
FIVEC    DC    X'5C'                    ERROR CODE             @OZ34827 62070000
*                                                                Y02027 62220006
         EJECT                                                          62500020
*                                                                     * 62600020
*     E Q U A T E S   A N D   R E A D - O N L Y   C O N S T A N T S   * 62700020
*                                                                     * 62800020
         SPACE                                                          62900020
ERBKEY   EQU   X'00'                    ELEMENT REQUEST BLOCK KEY       63000020
BLANK    EQU   C' '                     BLANK TERMNAME         @ZA02061 63020061
DEBNMEXT EQU   X'10'                    EXTENT OFFSET IN DEB    SA52991 63050022
MOVER    DS    0H                                                       63100020
         MVC   0(1,RBUF),0(RWORK)       EXECUTED INSTRUCTION THAT       63200020
*                                       MOVES DATA FROM A USER'S        63300020
*                                       WORKAREA TO A MCP BUFFER        63400020
PSVTO    EQU   X'12'                    HEX UI                   S22024 63600022
PUTFLG   EQU   X'02'                    PUT ERB IDENTIFIER              63700020
OUTFLG   EQU   X'0F'                    HEX 0F                   S22024 63800022
DCBOPEN  EQU   X'10'                    HEX 10                   S22024 65360022
LOCKR    EQU X'20'                      HEX 20                   S22024 65390022
SINGLE   EQU   X'60'                    HEX 60                   S22024 65510022
RELEASE  EQU   X'01'                    HEX 01                   S22024 65540022
ENTRYFLG EQU   X'12'                    FLAG FOR ENTRY AFTER   @XA11307 65546000
*                                        TIME DELAY            @XA11307 65552000
OFFSET   EQU   X'14'                    OFFSET TO THE QCB      @XA11307 65558000
DELAYPRI EQU   X'D6'                    TIME DELAY SIGNAL      @XA11307 65564000
RESETPRI EQU   X'E0'                    LCB PRIORITY AFTER     @XA11307 65570000
*                                        TIME DELAY            @XA11307 65576000
PIPOFF   EQU   X'FD'                    TURN OFF PUT IN        @XA11307 65582000
*                                        PROGRESS BIT          @XA11307 65588000
TIC      EQU   X'08'                    TIC COMMAND                     65598020
ONE      EQU   1                        MASK TO ICM LO-ORDER BYTEY01004 65598505
INVTIC   EQU   2                        INVALID TIC ADDRESS             65599020
HALF     EQU   3                        MASK TO ICM HALFWORD.    Y01004 65609005
ADDR     EQU   7                        MASK TO ICM AN ADDRESS.  Y01004 65619005
ALL      EQU   15                       MASK TO ICM ALL 4 BYTES. Y01004 65639005
TRMLEN   EQU   8                        LENGTH OF TERMINAL NAME  Y02027 65649006
THRESH   EQU   X'C0'                    QUEUES FULL              Y02027 65651406
NOBFRS   EQU   X'5C'                    THRESH OR PUT IN PROGRESSY02027 65652206
DEST     EQU   X'54'                    DESTINATION ERROR C.C.   Y02027 65653006
QUICKC   EQU   X'5E'                    QUICK CLOSE COMPLETION C.Y02027 65653806
LENERR   EQU   X'52'                    INVALID WORK UNIT LNGTH@ZA04032 65654281
ZERO     EQU   0                        DISPLACEMENT             Y02027 65654606
TWO      EQU   2                        DISPLACEMENT             Y02027 65655406
THREE    EQU   3                        MASK OF 0011             Y02027 65656206
FOUR     EQU   4                        DISPLACEMENT             Y02027 65657006
EIGHT    EQU   8                        DISPLACEMENT             Y02027 65657806
FORTY7   EQU   47                       RCB OFFSET-POSTED FLAG     @22A 65658427
         EJECT                                                          65659005
         TPRIOR                                                         65700020
         EJECT                                                          65800020
*                                                                     * 65900020
*              D  S  E  C  T  S                                       * 66000020
*                                                                     * 66100020
         SPACE 3                                                        66110081
         TTCXD                                                 @ZA05000 66120081
         EJECT                                                          66130081
         EJECT                                                          66150081
         SPACE                                                          66200020
         TAVTD                                                   Y02027 66300006
         TLCBD                          LINE CONTROL BLOCK              66400020
         TPRFD                          BUFFER PREFIX                   66500020
         IHAASCB                        ADDRESS SPACE CNTRL BLOCK  @N1A 66500527
         IHAPSA                         PREFIXED SAVEAREA          @N1A 66501027
         TDISPD                         TCAM DISPATCHER                 66600020
         TTRMD                          PUT PROCESS ENTRY               66700020
         TPCBD                          PROCESS CONTROL BLOCK           66900020
         TAIBD EXT=PUTWRITE                                      Y02027 67000006
         TPEBD                                                   Y02027 67050006
         TPEWAD                         PROCESS ENTRY WORKAREA          67100020
         TSCBD                                                          67200020
         TQCBD                                                          67300020
         DCBD  DSORG=TX                                                 67400020
MASKOFF  EQU   X'FF'-LCBTETEN-LCBBFRSZ-LCBABRTN                         67500020
         END                                                            67600020
         LA    RENTRY,DEST              DEST ERROR CODE          Y02027 67636627
         B     XMPOST1                  EXIT TO IEDQEB           Y02027 67673227
STDEST   EQU   *                                                 Y02027 67709827
         STH   RENTRY,PEWAOFF           SAVE TERMNAME OFFSET     Y02027 67746427
         LA    RWORK,TRMLEN(RWORK)      ADDRESS OF BYTE FOLLOW-  Y02027 67783027
*                                       ING DESTINATION          Y02027 67819627
         LA    RENTRY,LENERR            ERROR COMPLETION CODE  @ZA04032 67856227
         SH    RNUM,TNAMEL              DECREMENT WORKAREA SIZE  Y02027 67892827
         BM    XMPOST1                  BRANCH IF NEGATIVE     @OY11959 67929427
UPDATE   EQU   *                                                 Y02027 67966027
         ST    RWORK,PEWAMOVE           SAVE ADDR OF DATA IN W.A.Y02027 68002627
         TM    AIBOPTCP,MSGFLG          IS WORK UNIT A MESSAGE   Y02027 68039227
         BO    NORDEL                   BRANCH IF YES            Y02027 68075827
         TM    AIBRECFP,VARFLG          VARIABLE OR UNDEFINED    Y02027 68112427
         BNO   NORDEL                   BRANCH IF NEITHER        Y02027 68149027
         L     RTEMP,PEWAPROC           PROCESS TERM ENTRY       Y02027 68185627
         CLI   TRMCHCIN-IEDQTRM(RTEMP),AVTEZERO RECDEL PRESENT   Y02027 68222227
         BE    NORDEL                   BRANCH IF NO             Y02027 68258827
         LA    RNUM,ONE(RNUM)           ADD 1 TO WORKAREA SIZE   Y02027 68295427
NORDEL   EQU   *                                                 Y02027 68332027
         STH   RNUM,PEWALREC            SET SIZE OF WORKAREA     Y02027 68368627
         CLM   RNUM,THREE,AVTFZERO      IS DATA TO MOVE          Y02027 68405227
         BNE   CKPTTEST                 BRANCH IF YES            Y02027 68441827
         SR    RENTRY,RENTRY            SET GOOD COMPLETION CODE Y02027 68478427
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027 68515027
         BNO   XMPOST1                  BRANCH IF NO             Y02027 68551627
         CLI   PEWACTL,EOMFLAG          LAST PORTION OF MESSAGE  Y02027 68588227
         BNE   XMPOST1                  BRANCH IF NO             Y02027 68624827
*                                                                Y02027 68661427
*              CHECK FOR ENVIRONMENT CHECK POINT TAKEN SINCE     Y02027 68698027
*              LAST PUT                                          Y02027 68734627
*                                                                Y02027 68771227
CKPTTEST EQU   *                                                 Y02027 68807827
         TM    AIBEXLFP,CKPTFLP         CHECKPOINT EXIT SPECIFIEDY02027 68844427
         BNO   SETNO                    BRANCH IF NO             Y02027 68881027
         TM    PCBOFLG,PCBCKPTN         CHECKPOINT ISSUE SINCE   Y02027 68917627
*                                       LAST HEADER              Y02027 68954227
         BNO   SETNO                    BRANCH IF NO             Y02027 68990827
         NI    PCBOFLG,PCBCKPTF         IF YES, TURN OFF FLAG    Y02027 69027427
         B     SETCTL                   BRANCH IF YES            Y02027 69064027
SETNO    MVI   AIBEXLFP,AVTEZERO        SET NO CHECKPOINT TAKEN  Y02027 69100627
*                                       IF AIBEXLFP=CKPTFG,      Y02027 69137227
*                                       EXLST EXIT IS TO BE TAKENY02027 69173827
*                                                                Y02027 69210427
*        SET SEQUENCE FLAG FOR SEGMENT OF MESSAGE                Y02027 69247027
*                                                                Y02027 69283627
SETCTL   EQU   *                                                 Y02027 69320227
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027 69356827
         BO    NEWPUT                   BRANCH IF YES            Y02027 69393427
         CLI   PEWACTL,AVTEZERO         FIELD INITIALIZED        Y02027 69430027
         BNE   NXTA                     BRANCH IF YES            Y02027 69466627
         MVI   PEWACTL,MESSAGE          SET COMPLETE MSG FLAG    Y02027 69503227
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027 69539827
         BO    NEWPUT                   BRANCH IF YES            Y02027 69576427
         MVI   PEWACTL,HDRFLG           SET AS HEADER FIRST SEG  Y02027 69613027
         B     NEWPUT                   BRANCH TO CONTINUE       Y02027 69649627
NXTA     EQU   *                                                 Y02027 69686227
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027 69722827
         BO    NEWPUT                   BRANCH IF YES            Y02027 69759427
         MVI   PEWACTL,ISEGFLAG         SET INTERMEDIATE SEGMENT Y02027 69796027
         EJECT                                                   Y02027 69832627
NEWPUT   EQU   *                                                 Y02027 69869227
         OI    PCBOFLG,PCBPIPN          SET PUT IN PROGRESS      A50196 69905827
         LA    RERB,PEERB               ADDRESS OF ELEMENT REQUEST      69942427
*                                       BLOCK FROM PROCESS ENTRY        69979027
*                                       WORKAREA                        70015627
         TM    PEWAFLG,PBUF             PART-EMPTY BUFFER TO FILL       70052227
         BO    SETUP                    BRANCH IF YES                   70088827
         CLM   RNUM,HALF,AVTFZERO       IS THIS A NO-DATA OPERA- Y01004 70125427
*                                       TION (WORKAREA SIZE = 0) Y01004 70162027
         BE    SETUP                    BRANCH IF YES          @YA10439 70198627
         B     BUFSAVE                  BRANCH IF DATA OPERATION Y02027 70235227
SETUP    EQU   *                                                        70271827
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER          70308427
         L     RBFR,PERAQCB             BUFFER PREFIX ADDRESS           70345027
         LTR   RBFR,RBFR                IS 1ST PUT 0 LENGTH    @OX12583 70381627
         BZ    CLEANX                   BR YES, POST A.P.      @OX12583 70418227
         XC    PERAQCB(4),PERAQCB                                       70454827
         L     RBUF,PEWACBUF            ADDR OF FIRST EMPTY BYTE Y02027 70491427
         L     RPARM,PEWATIC            ADDR OF CURRENT UNIT            70528027
         LH    RCNT,PRFSIZE             INITIALIZE COUNTER              70564627
         L     RTEMP,PRFLCB-1           LCB ADDRESS                     70601227
*                                                                     * 70637827
*        INITIALIZE LCB FOR USE AFTER BUFFER ENTERS MESSAGE HANDLER   * 70674427
*                                                                     * 70711027
         LA    RZERO,PEWASCB                                            70747627
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RTEMP) SCB DIRECTORY ADDR     70784227
         ST    RZERO,LCBSCBA-1-IEDQLCB(0,RTEMP)                         70820827
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBRECVN SET RECIEVE SWITCH      70857427
         OI    LCBERBST-IEDQLCB(RTEMP),LCBDLNKN                         70894027
         MVI   LCBRSKEY-IEDQLCB(RTEMP),PSVTO PUT SCHEDULER MCPL         70930627
         MVC   LCBISZE-IEDQLCB(1,RTEMP),PCBRSERH RESERVE CNT TO LCB     70967227
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE TNT OFFSET             71003827
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP)                            71040427
         L     RZERO,PEWAQCBL           END OF THIS UNIT         Y02027 71077027
         SR    RZERO,RBUF               NUMBER OF EMPTY BYTES LEFT      71113627
         CLC   PEWALREC(2),AVTFZERO     SPECIAL NO-DATA EOM CASE Y02027 71150227
         BNE   MOVE                     BRANCH IF NO                    71186827
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BUFFER AS EOM              71223427
         B     POSTBUF                  POST BUFFER TO MH               71260027
         EJECT                                                          71296627
PUTSCHED EQU   *                                                 Y02027 71333227
         LA    RBASE,LABEL-IEDQEC(RENTRY) SCHED ADDRESSABILITY   Y02027 71369827
         CLI   LCBRSKEY-IEDQLCB(RPARM),PSVTO LCB                        71406427
         BNE   NOTLCB                   BRANCH IF NO           @XA11307 71443027
         CLI   LCBPRI-IEDQLCB(RPARM),DELAYPRI   LCB CAME       @XA11307 71479627
*                                         OFF OF TIME DELAY    @XA11307 71516227
         BNE   CLEANUP                  BRANCH IF NO           @XA11307 71552827
         MVI   LCBPRI-IEDQLCB(RPARM),RESETPRI NOT DELY PRIORITY@XA11307 71589427
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN  SET RECEIVE   @XA11307 71626027
*                                        SWITCH                @XA11307 71662627
         L     RPEWA,LCBERCCW-IEDQLCB(,RPARM) RESTORE PEWA ADDR@XA11307 71699227
         L     RPCB,PEPCBAD             PCB ADDRESS            @VS41903 71735827
         L     RWORK,PEWANEB            RESTORE DATA ADDRESS   @VS41903 71772427
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA  @VS41093 71809027
         B     NEWPUT                                          @XA11307 71845627
NOTLCB   EQU   *                                               @XA11307 71882227
         LR    RERB,RPARM               ERB ADDRESSABILITY       Y02027 71918827
         LA    RPCB,PEERB-IEDQPEWA      GET OFFSET TO PEWA       Y02027 71955427
         LR    RPEWA,RERB               GET ADDR OF ERB IN PEWA  Y02027 71992027
         SR    RPEWA,RPCB               COMPUTE PEWA ADDRESS     Y02027 72028627
         L     RPCB,PEPCBAD             PCB ADDRESSABILITY       Y02027 72065227
         L     RWORK,PEWANEB            RESTORE ADDR OF DATA     Y02027 72101827
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA    Y02027 72138427
         B     NEXTBUFX                 BRANCH FOR ERB           Y02027 72175027
*                                                                Y02027 72211627
*        PICK UP AND POST BUFFER SAVED FROM LAST OPERATION       Y02027 72248227
*                                                                Y02027 72284827
BUFSAVE  EQU   *                                                 Y02027 72321427
         ICM   RBFR,ALL,PERAQCB         ADDRESS OF SAVED BUFFER  Y02027 72358027
         BZ    NEXTBUFX                 BRANCH IF NO BUFFER TO   Y02027 72394627
*                                       POST                     Y02027 72431227
         XC    PERAQCB,PERAQCB          CLEAR ADDR OF PARTIAL    Y02027 72467827
*                                       BUFFER                   Y02027 72504427
         L     RTEMP,PRFLCB-ONE         GET LCB ADDRESS          Y02027 72541027
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE GET SRCE OFFSET Y02027 72577627
         LA    RZERO,PEWASCB            SCB ADDRESS              Y02027 72614227
         ST    RZERO,LCBSCBA-ONE-IEDQLCB(RTEMP) STORE IN LCB     Y02027 72650827
NEXTBUF  EQU   *                                                        72687427
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN       72724027
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO          72760627
*                                                                     * 72797227
*              FLAG THE LAST UNIT OF BUFFER BY STORING INVALID        * 72833827
*              TIC ADDRESS IN ITS TIC FIELD.                          * 72870427
*                                                                     * 72907027
SETFLAG  EQU     *                                                      72943627
         L     RPARM,PEWATIC            ADDR OF CURRENT BFR UNIT        72980227
TICX     EQU   *                                                        73016827
         NC    9(2,RPARM),9(RPARM)      LAST UNIT IN BUFFER             73053427
         BZ    TICIT                    BRANCH IF YES                   73090027
         L     RPARM,8(0,RPARM)         GET ADDR OF NEXT UNIT           73126627
         B     TICX                     GO CHECK FOR LAST UNIT          73163227
TICIT    EQU   *                                                        73199827
         MVI   11(RPARM),INVTIC         INVALID TIC ADDRESS             73236427
         LR    RPARM,RBFR               BUFFER PREFIX ADDRESS           73273027
         BAL    RETURN,DSPPOSTR         POST FULL BUFFER                73309627
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR          73346227
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS             73382827
NEXTBUFX EQU   *                                                        73419427
         ICM   RBFR,ADDR,LCBERBCH       ADDRESS OF NEXT EMPTY    Y01004 73456027
*                                       BUFFER.                  Y01004 73492627
         BZ    ERB                      IF NO EMPTY BUFFERS ARE  Y01004 73529227
*                                       LEFT, BRANCH TO GET MORE Y01004 73565827
*                                                                     * 73602427
*              INITIALIZE BUFFER PREFIX                               * 73639027
*                                                                     * 73675627
BUFINIT  EQU   *                                                        73712227
         MVI   PRFSTAT1,PRFNHDRN                                        73748827
         LA    RCNT,PRFSTXT-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914 73785427
         MVI   PRFPRI,PRIAPBFR          SET BUFFER PRIORITY             73822027
         MVI   PRFTIC,TIC               SET UP TIC FIELD                73858627
         LA    RBUF,PRFSTXT             START OF TEXT LABEL             73895227
         C     RWORK,PEWAMOVE           IS THIS THE BEGINNING OF Y02027 73931827
*                                       A NEW WORKAREA                  73968427
         BNE   GO                       BRANCH IF NOT TO AVOID          74005027
*                                       TESTING FOR HEADER              74041627
         MVI   PRFSTAT1,AVTEZERO        INIT BFR STATUS FIELD           74078227
         TM    PEWACTL,HDRFLG           HEADER SEGMENT           Y02027 74114827
         BO    PUTTEST                  BRANCH IF YES          @XA11307 74151427
         OI    PRFSTAT1,PRFNHDRN        SET NOT-HEADER FLAG IN          74188027
*                                       BUFFER PREFIX                   74224627
         B     GO                       BRANCH TO INITIALIZE LCB S21903 74261227
*                                       AND BUFFER PREFIX.       S21903 74297827
         SPACE 2                                               @XA11307 74334427
***************************************************************@XA11307 74371027
*                                                             *@XA11307 74407627
*                                                             *@XA11307 74444227
*  THIS CODE CONTROLS THE PROLIFIC PUTER.  THE USER SPECIFIES *@XA11307 74480827
*  A MAXIMUM NUMBER OF PUT'S (STORED IN PCBPACE) AND A TIME   *@XA11307 74517427
*  DELAY IN SECONDS (STORED IN PCBDELAY).  THUS AFTER THE     *@XA11307 74554027
*  SPECIFIED NUMBER OF PUT'S HAVE BEEN PROCESSED, A SPECIAL   *@XA11307 74590627
*  PRIORITY (X'D6') IS SET IN LCBPRI AND THE PUT LCB IS       *@XA11307 74627227
*  POSTED TO THE TIME DELAY SUBTASK.  AFTER THE REQUIRED DELAY*@XA11307 74663827
*  THE PUT LCB IS POSTED TO ITSELF BY TIME DELAY.             *@XA11307 74700427
*                                                             *@XA11307 74737027
*                                                             *@XA11307 74773627
***************************************************************@XA11307 74810227
PUTTEST  EQU   *                                               @XA11307 74846827
         NC    PCBPACE(TWO),PCBPACE     HAS USER SPECIFIED MAX @XA11307 74883427
*                                        NUMBER OF PUTS        @XA11307 74920027
         BZ    CLOSTST                  BRANCH IF NO           @XA11307 74956627
         NC    PCBDELAY(TWO),PCBDELAY   HAS USER SPECIFIED A   @XA11307 74993227
*                                        TIME DELAY            @XA11307 75029827
         BZ    CLOSTST                  BRANCH IF NO           @XA11307 75066427
         LH    RTEMP,PCBCNT             GET PUT COUNT          @XA11307 75103027
         LA    RTEMP,ONE(,RTEMP)        INCREMENT PUT COUNT    @XA11307 75139627
         STH   RTEMP,PCBCNT             RESET PUT COUNT        @XA11307 75176227
         CH    RTEMP,PCBPACE            HAS MAX NUMBER OF PUTS @XA11307 75212827
*                                        BEEN PROCESSED        @XA11307 75249427
         BNH   CLOSTST                  BRANCH IF NO           @XA11307 75286027
         XC    PCBCNT,PCBCNT            RESET PUT COUNT FOR    @XA11307 75322627
*                                        NEXT TIME DELAY       @XA11307 75359227
         L     RPARM,PCBLCBAD           GET LCB ADDRESS IN REG1@XA11307 75395827
*                                        FOR TIME DELAY ROUTINE@XA11307 75432427
         MVI   LCBPRI-IEDQLCB(RPARM),DELAYPRI  PRIORITY TO     @XA11307 75469027
*                                        SIGNAL TIME DELAY     @XA11307 75505627
         LA    RTEMP,AVTDELYB           TIME DELAY QUEUE       @XA11307 75542227
         ST    RTEMP,LCBQCBA-1-IEDQLCB(,RPARM)  FOR POST       @XA11307 75578827
         LA    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) SET UP STCB TO @XA11307 75615427
         ST    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) POINT TO ITSELF@XA11307 75652027
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBFREEN  SET LCB AS    @XA11307 75688627
*                                        FREE FOR TIME DELAY   @XA11307 75725227
         MVI   LCBRSKEY-IEDQLCB(RPARM),ENTRYFLG SET FLAG FOR   @XA11307 75761827
*                                        ENTRY AFTER DELAY     @XA11307 75798427
         MVC   LCBEOLTD-IEDQLCB(TWO,RPARM),PCBDELAY            @XA11307 75835027
*                                        TIME DELAY PARAMETER  @XA11307 75871627
         MVI   LCBTDL-IEDQLCB(RPARM),OFFSET INDEX FOR DELAY    @XA11307 75908227
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE @OZ26689 75944827
*                                       OF DATA IN WORK AREA   @OZ26689 75981427
         ST    RPARM,LCBCHAIN-IEDQLCB(,RPARM) QCB ADDESS       @XA11307 76018027
         ST    RPEWA,LCBERCCW-IEDQLCB(,RPARM) SAVE PEWA ADDRESS@XA11307 76054627
         NI    PCBOFLG,PIPOFF           TURN OFF PUT IN        @VS41517 76091227
*                                        PROGRESS BIT          @XA11307 76127827
         BAL   RETURN,DSPPOST           BRANCH TO TIME DELAY   @XA11307 76164427
CLOSTST  EQU   *                                                        76201027
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN CLOSEDOWN IN PROGRESS          76237627
         BNO   GO                       BRANCH IF NO                    76274227
         OI    PERCQCB+3,PBUF           SET ERROR FLAG                  76310827
         LA    RENTRY,QUICKC            SET CONDITION CODE       Y02027 76347427
         B     ERREXIT                  POST A.P. ECB            Y02027 76384027
         EJECT                                                          76420627
GO       EQU   *                                                        76457227
*                                                                     * 76493827
*        INITIALIZE LCB AND BUFFER PREFIX                             * 76530427
*                                                                     * 76567027
         MVC   PRFLCB(3),PCBLCBAD+1     PUT ADDRESS OF SOURCE LCB       76603627
*                                       INTO BUFFER PREFIX              76640227
         L     RPARM,PRFLCB-1           LCB ADDRESS                     76676827
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN SET RECIEVE SWITCH      76713427
         OI    LCBERBST-IEDQLCB(RPARM),LCBDLNKN                         76750027
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER MCPL         76786627
         LA    RZERO,PEWASCB            SOURCE SCB ADDRESS              76823227
         ST    RZERO,LCBSCBA-1-IEDQLCB(RPARM) STORE IT IN LCB           76859827
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RPARM)                        76896427
         ST    RPEWA,LCBERCCW-IEDQLCB(RPARM) SAVE PEWA ADDRESS          76933027
         MVC   PRFQCBA(3),PCBMH         ADDRESS OF MESSAGE HANDLER      76969627
*                                       TO PROCESS THIS BUFFER          77006227
         MVC   PRFSRCE(2),PEWAPETO      MOVE TERMNAME TABLE OFSETY02027 77042827
*                                       OF PUT PROCESS ENTRY INTO       77079427
*                                       SOURCE FIELD IN BFR PREFIX      77116027
         MVC   LCBTTCIN-IEDQLCB(2,RPARM),PRFSRCE  TNT OFFSET   @YA07129 77152627
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER                   77189227
         BO    STARTY                   BRANCH IF NO                    77225827
         MVC   LCBISZE-IEDQLCB(1,RPARM),PCBRSERH HEADER RESERVE@YA04914 77262427
         LA    RBUF,PRFSHDR             START OF HEADER LABEL           77299027
         LA    RCNT,PRFSHDR-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914 77335627
         MVC   PRFDEST(2),PEWAOFF       MOVE DESTINATION OFFSET  Y02027 77372227
*                                       TO TERMNAME TABLE FROM          77408827
*                                       PUT/WRITE WORKAREA INTO         77445427
*                                       BUFFER PREFIX                   77482027
         NC    PRFDEST(2),PRFDEST       DESTINATION OFFSET VALID        77518627
         BZ    STARTY                   BRANCH IF NOT TO BYPASS         77555227
*                                       LOCK MODE FUNCTIONS             77591827
         L     RPARM,PCBLCBAD           APPL PROG LCB ADDRESS           77628427
         NC    LCBINCAM-IEDQLCB(2,RPARM),LCBINCAM-IEDQLCB(RPARM)        77665027
*                                       OUTSTANDING LOCK RESPONSE       77701627
         BZ    STARTY                   BRANCH IF NO                    77738227
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE OFY02027 77774827
*                                       DATA IN W.A. TO BE MOVED Y02027 77811427
         ST    RBUF,PEWAPEUN            SAVE ADDR OF DATA IN BUF.Y02027 77848027
         ST    RENTRY,PEWASAVE          SAVE BUFFER ADDR         Y02027 77884627
         ST    RERB,PEWASAVE+4          SAVE ERB ADDR            Y02027 77921227
*                                                                Y02027 77957827
* REGISTERS 2,4, AND 8 MUST NOT BE CHANGED OR MUST BE SAVED AND  Y02027 77994427
* RESTORED IN PEWASAVE BEFORE GOING TO START.                    Y02027 78031027
*                                                                       78067627
         EJECT                                                          78104227
*                                                                     * 78140827
*      TEST TO SEE IF MESSAGE DESTINATION IS IN LOCK MODE             * 78177427
*                                                                     * 78214027
         SR    RPARM,RPARM              CLEAR WORK REGISTER TO ZERO     78250627
         LH    RPARM,PEWAOFF            DESTINATION OFFSET       Y02027 78287227
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALF           78323827
         L     RENTRY,AVTRNMPT          ADDRESS OF OFFSET               78360427
*                                       CONVERSION LOGIC                78397027
         BALR  RETURN,RENTRY            CONVERT OFFSET TO TERMINAL      78433627
*                                       TABLE ENTRY ADDRESS             78470227
         LR    RTEMP,RPARM              SAVE ENTRY ADDRESS     @Z30X8AM 78506827
         TM    TRMSTATE-IEDQTRM(RPARM),SINGLE VALID TERM ENTRY          78543427
         BNZ   START                    BRANCH IF NO                    78580027
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) GET ADDRESS OF         78616627
*                                       DEST QCB FROM TERM ENTRY        78653227
         LR    RUNIT,RPARM              SAVE DEST QCB ADDRESS    Y02027 78689827
         L     RPARM,QCBDCBAD-1-IEDQQCB(0,RPARM) GET ADDRESS OF         78726427
*                                       DCB FROM DEST QCB               78763027
*                                       VTAM TERMINAL            X03039 78799627
         TM    DCBOFLGS-IHADCB(RPARM),DCBOPEN  IS DCB OPENED            78836227
         BNO   START                    BRANCH IF NO                    78872827
         TM    TRMSTATE-IEDQTRM(RTEMP),TRMPREF VTAM TERMINAL   @G36XRAW 78909427
         BNO   NOT3705                  BR NO                  @G36XRAW 78946027
         LR    RPARM,RUNIT              RESTORE OCB ADDRESS      Y02027 78982627
         SH    RPARM,QCBHDRSZ           BACKUP TO RN PREFIX    @ZM47936 79019227
         ICM   RPARM,ALL,QCBPLCBA-ONE-IEDNQCB(RPARM) PLCB ADDR   Y02027 79055827
         BNM   START                    BRANCH IF POSITIVE - NO  S22024 79092427
*                                       PLCB ASSIGNED            S22024 79129027
         B     LCBLOOP                  BRANCH TO LCBLOOP        S22024 79165627
NOT3705  EQU   *                                                 S22024 79202227
         L     RERB,DCBDEBAD-IHADCB(RPARM)  GET DEB ADDR       @OZ35822 79238827
         CLC   QCBLKRLN-IEDQQCB(,RUNIT),DEBNMEXT(RERB)  TSO?   @OZ35822 79275427
         BH    START                    BR YES                 @OZ35822 79312027
         SR    RERB,RERB                CLEAR COUNTER TO ZERO    Y02027 79348627
         ICM   RERB,ONE,QCBLKRLN-IEDQQCB(RUNIT) GET LOCK         Y02027 79385227
*                                       RELATIVE LINE NUMBER.    Y01004 79421827
         BZ    START                    BRANCH IF TERMINAL IS   SA52508 79458427
*                                       NOT LOCKED.             SA52508 79495027
         TM    QCBDSFLG-IEDQQCB(RUNIT),QCBTSQ  IS TSO POSSIBLE @OZ35822 79531627
         BZ    NOTSO                    BR, NO                 @OZ35822 79568227
         ICM   RBUF,ADDR,DCBMH-IHADCB(RPARM)  GET MH ADDR      @OZ35822 79604827
         TM    QCBDSFLG-IEDQQCB(RUNIT),QCBALTMH  ALT MH ?      @OZ35822 79641427
         BZ    NOALTMH                  BR, NO                 @OZ35822 79678027
         L     RBUF,ZERO(RBUF)          GET ALT MH ADDR        @OZ35822 79714627
NOALTMH  EQU   *                                               @OZ35822 79751227
         TM    FOUR(RBUF),ONE           TSO MH                 @OZ35822 79787827
         BO    START                    BR YES, CAN'T BE LOCK  @OZ35822 79824427
NOTSO    EQU   *                                               @OZ35822 79861027
         SR    RZERO,RZERO              CLEAR REG TO ZERO               79897627
         LA    RZERO,LCBFLAG1-IEDQLCB                                   79934227
         SR    RBUF,RBUF                CLEAR REG TO ZERO        Y02027 79970827
         IC    RBUF,DCBEIOBX-IHADCB(RPARM) LCB LENGTH            Y02027 80007427
         L     RPARM,DCBIOBAD-IHADCB(0,RPARM)  GET ADDRESS OF           80044027
*                                       IOB FROM DCB                    80080627
         SR    RPARM,RZERO              ADDR OF DUMMY LCB               80117227
         MR    RBUF-ONE,RERB            COMPUTE LCB DISPLACEMENT Y02027 80153827
         AR    RPARM,RBUF               ADDR OF LCB              Y02027 80190427
LCBLOOP  EQU   *                                                 Y02027 80227027
         CLC   LCBTTCIN-IEDQLCB(2,RPARM),PEWAOFF  LCB FOR MESSAGEY02027 80263627
*                                       DESTINATION              Y02027 80300227
         BNE   START                    BRANCH IF NO                    80336827
         EJECT                                                          80373427
*                                                                     * 80410027
*        INSURE THAT CURRENT MESSAGE IS CORRECT RESPONSE              * 80446627
*                                                                     * 80483227
         LR    RZERO,RPARM              SAVE LCB ADDRESS                80519827
         L     RPARM,LCBSCBA-1-IEDQLCB(0,RPARM) GET ADDRESS OF          80556427
*                                       SCB FROM LCB                    80593027
         TM    SCBSTATE-IEDQSCB(RPARM),SCBLCK1N+SCBMSGLN  LOCK MODE     80629627
         BZ    START                    BRANCH IF NO                    80666227
         LR    RPARM,RZERO              RESTORE LCB ADDRESS             80702827
         L     RPARM,LCBINSRC-1-IEDQLCB(0,RPARM) INQUIRY DEST OFFSET    80739427
         SRL   RPARM,8                                                  80776027
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALFWORD       80812627
         LTR   RPARM,RPARM              LINE NOT LOCKED                 80849227
         BZ    START                    BRANCH IF NO                    80885827
         LR    RTEMP,RZERO              SAVE SOURCE LCB ADDRESS  Y02027 80922427
         L     RENTRY,AVTRNMPT          TNT OFFSET CONVERTER            80959027
         BALR  RETURN,RENTRY            GET TERM ENTRY ADDRESS          80995627
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) DEST QCB ADDRESS       81032227
         CLC QCBDCBAD-IEDQQCB(3,RPARM),PEPCBAD+ONE PCB'S EQUAL   Y02027 81068827
         BNE   START                    BRANCH IF NO                    81105427
         LR    RZERO,RTEMP              RESTORE SOURCE LCB ADDR  Y02027 81142027
         L     RPARM,LCBSCBA-ONE-IEDQLCB(RTEMP) GET ADDRESS OF   Y02027 81178627
*                                       SCB FROM LCB             Y02027 81215227
         TM    LCBINSRC+2-IEDQLCB(RTEMP),LOCKR   LINE DUE A RESPONSE    81251827
         BNO   START                    BRANCH IF NO                    81288427
         NI    LCBINSRC+2-IEDQLCB(RTEMP),AVTEFF-LOCKR                   81325027
         LA    RTEMP,PEWASCB            SOURCE SCB                      81361627
         MVC   SCBSTATE-IEDQSCB(1,RTEMP),SCBSTATE-IEDQSCB(RPARM)        81398227
*                                       COPY LOCK FLAGS TO SOURCE SCB   81434827
         NI    SCBSTATE-IEDQSCB(RTEMP),SCBLCK1N+SCBMSGLN                81471427
         LR    RPARM,RZERO              ADDRESS OF SOURCE LCB           81508027
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS      Y02027 81544627
         L     RTEMP,PCBLCBAD           APPL PROG LCB ADDRESS           81581227
         LH    RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  LOCK RESPONSE COUNT    81617827
         BCTR  RETURN,0                 DECREMENT COUNT BY ONE          81654427
         STH   RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  NEW RESPONSE COUNT     81691027
         TM    QCBSLINK+TWO-IEDQQCB(RUNIT),RELEASE  RELEASE IN   Y02027 81727627
*                                       EFFECT                   Y02027 81764227
         BO    START                    BRANCH IF YES                   81800827
         TM    QCBINSRC+2-IEDQQCB(RUNIT),QCBDELAY              @ZA03747 81837427
*                                       QCB IN TIME DELAY QUEUE OX02215 81874027
         BNO   NOTIMQ                   BRANCH IF NO            OX02215 81910627
         LR    RTEMP,RPARM              SAVE LCB ADDRESS        OX02215 81947227
         LR    RPARM,RUNIT              GET QCB ADDRESS        @ZA03747 81983827
         L     RENTRY,AVTHG02           ADDRESS OF TIME DELAY   OX02215 82020427
*                                       REMOVAL ROUTINE         OX02215 82057027
         BALR  RETURN,RENTRY            REMOVE QCB FROM TDQ     OX02215 82093627
         LR    RPARM,RTEMP              RESTORE LCB ADDRESS     OX02215 82130227
         LA    RETURN,QCBSTVTO-IEDQQCB(,RUNIT) ADDRESS OF SEND @ZA03747 82166827
*                                        SCHEDULER STCB        @ZA03747 82203427
         MVC   QCBSLINK-IEDQQCB(3,RUNIT),QCBSTCHN-IEDQQCB(RUNIT)        82240027
         STCM  RETURN,ADDR,QCBSTCHN-IEDQQCB(RUNIT)             @ZA03747 82276627
*                                       PUT SEND SCHEDULER BACK OX02215 82313227
*                                       INTO THE QCB            OX02215 82349827
NOTIMQ   EQU   *                                                OX02215 82386427
*                                                                     * 82423027
*        FIND SEND SCHEDULER AND INSERT IT'S STCB IN LCB              * 82459627
*                                                                     * 82496227
         L     RTEMP,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF TOP STCB    Y02027 82532827
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           82569427
         LA    RZERO,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF STCB        Y02027 82606027
         LA    RBUF,LCBSTCBA-1-IEDQLCB(0,RPARM) STCB CHAIN ADDR         82642627
         CR    RTEMP,RZERO              SEND SCHED ON DEST QCB          82679227
         BNE   STCBOUT                  BRANCH IF NO                    82715827
         MVC   QCBSTCHN-IEDQQCB(3,RUNIT),QCBSLINK-IEDQQCB(RUNIT) Y02027 82752427
*                                       REMOVE SEND SCHED FROM CHAIN    82789027
         LR    RPARM,RZERO              SEND SCHEDULER ADDRESS          82825627
INSERT   EQU   *                                                        82862227
         BAL   RETURN,DSPLIFOR          PUT SEND SCHEDULER ON TOP       82898827
         B     START                    RETURN TO MAINLINE CODE         82935427
STCBOUT  EQU   *                                                        82972027
         LA    RETURN,NOPLCBS           SET FOR POSSIBLE SCAN  @SA72774 83008627
         CLI   LCBFLAG1-IEDQLCB(RPARM),AVTEZERO PLCB             S22024 83045227
         BE    STCBOUTX                 BRANCH YES - USE COMMON  S22024 83081827
*                                       CODE                     S22024 83118427
         TM    LCBSTAT2-IEDQLCB(RPARM),LCBDIAL DIAL LINE                83155027
         BO    DIAL                     BRANCH IF YES                   83191627
STCBOUTX EQU   *                                                        83228227
         L     RTEMP,LCBSTCBA-1-IEDQLCB(0,RPARM) TOP STCB IN LCB        83264827
         LA    RWORK,4(0,RPARM)         SIMULATE FIRST ELEMENT          83301427
STCBLOOP EQU   *                                                        83338027
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           83374627
         CR    RTEMP,RZERO              DESIRED SEND SCHED STCB         83411227
         BE    DELINK                   BRANCH IF YES                   83447827
         CLI   4(RTEMP),AVTEZERO        END OF STCB CHAIN       SA52991 83484427
         BCR   AVTECD8,RETURN           BRANCH IF YES           SA52991 83521027
         LR    RWORK,RTEMP                                              83557627
         L     RTEMP,4(0,RTEMP)         ADDR OF NEXT STCB               83594227
         B     STCBLOOP                 GET NEXT STCB                   83630827
DELINK   EQU   *                                                        83667427
         MVC   5(3,RWORK),5(RTEMP)      DELINK STCB                     83704027
         LR    RPARM,RTEMP              DISP PARM REG                   83740627
         B     INSERT                   PUT STCB ON TOP OF CHAIN        83777227
         EJECT                                                 @SA72774 83813827
NOPLCBS  EQU   *                                               @SA72774 83850427
         SPACE 1                                               @SA72774 83887027
* THIS SUBROUTINE SETS UP PARAMETERS NEEDED TO SCAN THE  *     @SA72774 83923627
* 'NO-PLCBS' CHAIN FOR THE SEND SCHEDULER IF IT IS NOT   *     @SA72774 83960227
* ALREADY IN THE PLCB.                                   *     @SA72774 83996827
         SPACE 2                                               @SA72774 84033427
         L     RWORK,AVTSAVTP           SECONDARY AVT ADDRESS  @SA72774 84070027
         L     RWORK,SAVTPLCB-IEDNSVTD(,RWORK)                 @SA72774 84106627
*                                       PLCB RETURN QCB ADDRESS@SA72774 84143227
         L     RTEMP,FOUR(,RWORK)       FIRST ELEMENT ON QUEUE @SA72774 84179827
         B     STCBLOOP                 GO SCAN 'NO-PLCB' CHAIN@SA72774 84216427
         EJECT                                                          84253027
DIAL     EQU   *                                                        84289627
         TM    QCBTSOF1-IEDQQCB(RUNIT),QCBDELAY QCB IN TIME DELAYY02027 84326227
         BNO   DIALQ                    BRANCH IF NO                    84362827
         LR    RPARM,RZERO              STCB ADDRESS                    84399427
         B     INSERT                   BRANCH TO INSERT         S21903 84436027
*                             SEND SCHEDULER'S STCB IN LCB CHAIN S21903 84472627
DIALQ    EQU   *                                                        84509227
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDR        Y02027 84545827
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO          84582427
         IC    RTEMP,DCBEIOBX-IHADCB(0,RWORK)   LCB SIZE                84619027
         L     RWORK,DCBIOBAD-IHADCB(0,RWORK) IOB ADDRESS               84655627
         LA    RWORK,0(0,RWORK)         CLEAR HIGH-ORDER BYTE           84692227
         LA    RETURN,LCBFLAG1-IEDQLCB+8 OFFSET TO DIALOUT QUEUE        84728827
         SR    RWORK,RETURN             ADDR OF DIALOUT CALL Q          84765427
         AR    RWORK,RTEMP              ACTUAL LCB ADDRESS              84802027
DCQLOOP  EQU   *                                                        84838627
         L     RTEMP,4(0,RWORK)         ADDR OF STCB ON D.C. Q          84875227
         CLI   4(RTEMP),0               END OF D.C. QUEUE               84911827
         BE    SCANALL                  BRANCH IF YES           SA52991 84948427
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           84985027
         CR    RZERO,RTEMP              DEST SCHED STCB FOUND           85021627
         BE    DELINK                   BRANCH IF YES                   85058227
         LR    RWORK,RTEMP              SAVE TOP STCB ADDR              85094827
         B     DCQLOOP                  GO TEST NEXT STCB               85131427
         EJECT                                                          85168027
SCANALL  EQU   *                                                SA52991 85204627
*                                                               SA52991 85241227
*        FIND DEST QCB FOR LOCKED TERMINAL BY SCANNING THE      SA52991 85277827
*        STCB CHAIN FOR EACH LCB IN LINE GROUP.                 SA52991 85314427
*                                                               SA52991 85351027
         SPACE                                                          85387627
         SR    RPCB,RPCB                CLEAR REGISTER           Y02027 85424227
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDRESS     Y02027 85460827
         L     RERB,DCBDEBAD-IHADCB(RWORK)  ADDRESS OF DEB       Y02027 85497427
         IC    RPCB,DEBNMEXT(RERB)      NUMBER OF LCBS IN GROUP  Y02027 85534027
         L     RPARM,DCBIOBAD-IHADCB(RWORK)  IOB ADDRESS         Y02027 85570627
         LA    RERB,LCBFLAG1-IEDQLCB    OFFSET FROM LCB TO IOB   Y02027 85607227
         SR    RPARM,RERB               ADDR OF DUMMY LCB        Y02027 85643827
         IC    RERB,DCBEIOBX-IHADCB(RWORK) SIZE OF LCB           Y02027 85680427
RLNLOOP  EQU   *                                                 Y02027 85717027
         AR    RPARM,RERB               FIRST OR NEXT LCB        Y02027 85753627
         BAL   RETURN,STCBOUTX          CHAIN STCB               Y02027 85790227
         BCT   RPCB,RLNLOOP             BRANCH- LOOK AT NEXT LCB Y02027 85826827
*                                       LOCK NOT FOUND           Y02027 85863427
         EJECT                                                          85900027
START    EQU   *                                                 Y02027 85936627
         L     RERB,PEWASAVE+4          RESTORE ERB ADDR         Y02027 85973227
         L     RWORK,PEWANEB            RESTORE WORKAREA ADDRESS Y02027 86009827
         L     RBUF,PEWAPEUN            RESTORE ADDR OF DATA IN  Y02027 86046427
*                                       BUFFER                   Y02027 86083027
         L     RENTRY,PEWASAVE          RESTORE BUFFER ADDR      Y02027 86119627
STARTY   EQU   *                                                        86156227
         LR    RPARM,RBFR               ADDRESS OF FIRST BUFFER UNIT    86192827
*                                       LINK FIELD                      86229427
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR          86266027
         MVI   PEWATIC,PSVTO                                            86302627
*                                                                     * 86339227
*        COMPUTE BUFFER SIZE, UNIT SIZE, AND UNITS PER BUFFER         * 86375827
*                                                                     * 86412427
         LA    RZERO,PRFSUNIT           START OF BUFFER AFTER UMA       86449027
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED               86485627
         BNH   LESS                     BRANCH IF YES                   86522227
         AH    RZERO,PEWASOWA           EMPTY BYTE COUNT                86558827
         B     CONT                     BRANCH TO                S21903 86595427
*                                       SET-END-OF-UNIT ADDR     S21903 86632027
LESS     EQU   *                                                        86668627
         AH    RZERO,AVTKEYLE           ADDRESS OF END OF BUFFER        86705227
CONT     EQU   *                                                        86741827
         ST    RZERO,PEWAQCBL           ADDR OF END OF THIS UNIT Y02027 86778427
         SR    RZERO,RBUF               SIZE OF DATA FIELD IN BFR       86815027
*                                                                     * 86851627
*              ALLOW SPACE IN BUFFER FOR RESERVE CHARACTERS           * 86888227
*                                                                     * 86924827
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS             86961427
         SR    RTEMP,RTEMP              CLEAR COUNTER                   86998027
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER                   87034627
         BO    TEXTBFR                  BRANCH IF NO                    87071227
         ICM   RTEMP,ONE,PCBRSERH       RESERVE CHARACTER COUNT. Y01004 87107827
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004 87144427
*                                       CHARACTERS FOR HEADER.   Y01004 87181027
         B     BUMPER                   BUMP POINTER & COUNTER          87217627
TEXTBFR  EQU   *                                                        87254227
         ICM   RTEMP,ONE,PCBRSERT       RESERVE CHARACTER COUNT. Y01004 87290827
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004 87327427
*                                       CHARACTERS FOR TEXT.     Y01004 87364027
BUMPER   EQU   *                                                        87400627
         AR    RBUF,RTEMP               BUMP PAST RESERVE CHARS         87437227
         AR    RCNT,RTEMP               ADD RESERVE CHAR COUNT          87473827
         SR    RZERO,RTEMP              SUBTRACT RESERVE COUNT          87510427
         EJECT                                                          87547027
*                                                                     * 87583627
*        MOVE DATA FROM USER'S WORKAREA TO THE MCP BUFFER             * 87620227
*                                                                       87656827
         SPACE                                                          87693427
MOVE     EQU   *                                                        87730027
         LR    RTEMP,RZERO              SIZE OF DATA FIELD IN BFR       87766627
         CR    RTEMP,RNUM               MORE THAN ONE UNIT      OY00458 87803227
         BNH   MOVE1                    BRANCH IF NO            OY00458 87839827
         LR    RTEMP,RNUM               SET SMALLER COUNT       OY00458 87876427
MOVE1    EQU   *                                                OY00458 87913027
         BCTR  RTEMP,RZERO              DECREMENT COUNT BY ONE          87949627
         EX    RTEMP,MOVER              FILL THE BUFFER                 87986227
         CR    RNUM,RZERO               WORKAREA EMPTY                  88022827
         BH    NEXT                     BRANCH IF NO                    88059427
*                                                                Y02027 88096027
*        WORKAREA IS EMPTY - PREPARE TO RETURN                   Y02027 88132627
*                                                                Y02027 88169227
         AR    RCNT,RNUM                INCREMENT COUNTER OF BYTES      88205827
*                                       MOVED INTO BUFFER               88242427
         AR    RBUF,RNUM                ADDR OF NEXT EMPTY BYTE         88279027
         STH   RCNT,PRFSIZE             STORE BYTE COUNT IN PREFIX      88315627
         TM    PEWAOPTC,MSGFLG          IS WORK UNIT A MESSAGE   Y02027 88352227
         BO    NORECDEL                 BRANCH IF YES            Y02027 88388827
         TM    PEWAGSW,VARFLG           VARIABLE FORMAT          Y02027 88425427
         BNO   NORECDEL                 BRANCH IF NO                    88462027
         L     RTEMP,PEWAPROC           PROCESS ENTRY ADDRESS           88498627
         NC    TRMCHCIN-IEDQTRM(1,RTEMP),TRMCHCIN-IEDQTRM(RTEMP)        88535227
*                                       RECORD DELIMITER SPECIFIED      88571827
         BZ    NORECDEL                 BRANCH IF NO             A44891 88608427
         BCTR  RBUF,0                   BACK UP ONE BYTE                88645027
         MVC   0(1,RBUF),TRMCHCIN-IEDQTRM(RTEMP) RECORD DELIMITER       88681627
         LA    RBUF,1(0,RBUF)           BUMP TO NEXT EMPTY BYTE         88718227
NORECDEL EQU   *                                                        88754827
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BFR AS EOM                 88791427
         TM    PEWACTL,EOMFLAG          WORKAREA CONTAIN END OF  Y02027 88828027
*                                       A MESSAGE                       88864627
         BO    POSTBUF                  BRANCH IF YES TO POST BFR       88901227
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM BIT IN PREFIX       88937827
         ST    RBFR,PERAQCB             SAVE ADDR OF LAST FILLED        88974427
*                                       BUT NON-EOM BUFFER              89011027
         OI    PEWAFLG,PBUF             PARTIAL BUFFER FLAG      A44891 89047627
         C     RBUF,PERAQCB+4           IS CURRENT UNIT FULL            89084227
         BNL   FULLUNIT                 BRANCH IF YES.           Y01004 89120827
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR.  Y01004 89157427
         MVI   PEWATIC,PSVTO            SET PUT SCHEDULER MCPL.  Y01004 89194027
         ST    RBUF,PEWACBUF            SAVE ADDRESS OF NEXT     Y02027 89230627
*                                       EMPTY BYTE.              Y01004 89267227
         B     CLEANX                   GO POST APPLICATION      Y01004 89303827
*                                       PROGRAM ECB.             Y01004 89340427
FULLUNIT EQU   *                                                 Y01004 89377027
         LA    RETURN,CLEANX            SET UP RETURN ADDRESS           89413627
*                                       FROM 'SETUNIT' ROUTINE.  Y01004 89450227
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT TO FILL            89486827
         BNZ   SETUNIT                  BRANCH IF YES                   89523427
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER          89560027
         B     CLEANX                   GO POST APPL PROG ECB           89596627
         EJECT                                                          89633227
*                                                                Y02027 89669827
*        OBTAIN ANOTHER EMPTY UNIT OR BUFFER TO FILL             Y02027 89706427
*                                                                Y02027 89743027
NEXT     EQU   *                                                        89779627
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM FLAG                89816227
         AR    RCNT,RZERO                                               89852827
         STH   RCNT,PRFSIZE                                             89889427
         SR    RNUM,RZERO               COMPUTE SIZE OF DATA            89926027
*                                       REMAINING IN WORKAREA           89962627
         STH   RNUM,PEWALREC            AND SAVE                 Y02027 89999227
         AR    RWORK,RZERO              ADDRESS OF NEXT BYTE OF         90035827
*                                       DATA TO BE MOVED                90072427
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT IN BUFFER          90109027
         BZ    NEXTBUF                  BRANCH IF NO                    90145627
         LA    RETURN,MOVE              SET UP RETURN ADDRESS           90182227
*                                       FROM 'SETUNIT' ROUTINE.  Y01004 90218827
SETUNIT  EQU   *                                                        90255427
         L     RBUF,8(0,RPARM)          ADDRESS OF NEXT UNIT            90292027
         MVI   8(RBUF),TIC              SET UP TIC COMMAND              90328627
         LR    RPARM,RBUF               ADDRESS OF NEXT BUFFER UNIT     90365227
*                                       LINK FIELD                      90401827
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR          90438427
         MVI   PEWATIC,PSVTO                                            90475027
         LA    RBUF,AVTUMALN(0,RBUF)    ADDRESS OF FIRST EMPTY          90511627
*                                       BYTE IN BUFFER                  90548227
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED               90584827
         BNH   LESSA                    BRANCH IF YES                   90621427
         LH    RZERO,PEWASOWA           EMPTY BYTE COUNT                90658027
         B     CONTA                    BRANCH TO                S21903 90694627
*                                       COMPUTE END-OF-UNIT ADDR S21903 90731227
LESSA    EQU   *                                                        90767827
         LH    RZERO,AVTKEYLE           NUMBER OF EMPTY BYTES           90804427
*                                       IN BUFFER                       90841027
         LH    RTEMP,PEWASOWA           MAXIMUM BUFSIZE        @YA04914 90877627
         N     RTEMP,AVTCLRHI           CLEAR HIGH HALFWORD    @YA04914 90914227
         SH    RTEMP,PRFSIZE            SPACE AVAILABLE IN UNIT@YA04914 90950827
         CR    RTEMP,RZERO               LESS THAN KEY LENGTH  @YA04914 90987427
         BNL   CONTA                    NO, BRANCH             @YA04914 91024027
         LR    RZERO,RTEMP              SET SHORT LAST UNIT    @YA04914 91060627
CONTA    EQU   *                                                        91097227
         LR    RTEMP,RBUF               FIRST EMPTY BYTE IN BFR         91133827
         ST    RBUF,PEWACBUF            FIRST EMPTY BYTE ADDRESS Y02027 91170427
         AR    RTEMP,RZERO              ADDR OF END OF THIS UNIT        91207027
         ST    RTEMP,PEWAQCBL           SAVE THIS POINTER        Y02027 91243627
         BR    RETURN                   RETURN TO CALLER                91280227
         EJECT                                                          91316827
*                                                                Y02027 91353427
*        POST BUFFER TO MESSAGE HANDLER                          Y02027 91390027
*                                                                Y02027 91426627
POSTBUF  EQU   *                                                        91463227
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN       91499827
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO          91536427
         LR    RPARM,RBFR               ADDR OF BUFFER TO POST          91573027
         L     RTEMP,PEWATIC            ADDR OF CURRENT TIC FIELD       91609627
TICLOOP  EQU   *                                                        91646227
         NC    9(2,RTEMP),9(RTEMP)      LAST UNIT IN BUFFER             91682827
         BZ    SETTIC                   BRANCH IF YES                   91719427
         L     RTEMP,8(0,RTEMP)         GET ADDR OF NEXT UNIT           91756027
         B     TICLOOP                  GO CHECK FOR LAST UNIT          91792627
SETTIC   EQU   *                                                        91829227
         MVI   11(RTEMP),INVTIC         SET INVALID TIC ADDRESS TO      91865827
*                                       INDICATE END OF BUFFER          91902427
         L     RTEMP,PRFLCB-1           LCB ADDRESS                     91939027
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP) SAVE PEWA ADDR IN LCB      91975627
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR          92012227
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNLSTN EOM BUFFER      SA58449 92048827
         BNO   YESEOM                   BRANCH IF YES          @G36XRAW 92085427
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW 92122027
YESEOM   EQU   *                                               @G36XRAW 92158627
         OI    PEWAFLG,ERBBUSY          SET LCB TO BE POSTED            92195227
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW 92231827
         SPACE 3                                                        92268427
         EJECT                                                          92305027
CLEANUP  EQU   *                                                        92341627
*                                                                     * 92378227
*        POST WAITING APPLICATION PROGRAM COMPLETE               Y02027 92414827
*                                                                     * 92451427
         L     RPEWA,LCBERCCW-IEDQLCB(RPARM) RESTORE PEWA ADDR          92488027
         NI    PEWAFLG,AVTEFF-ERBBUSY   SET LCB NOT LOOSE               92524627
         MVI   PEWASCB,AVTEZERO         RESET SCBSTATE TO NOT LOCK      92561227
         NI    LCBERBST-IEDQLCB(RPARM),LCBDLNKF SET ERB NOT POSTED      92597827
         TM    PEWAFLG,CFLG             CLOSE IN PROGRESS               92634427
         BO    CLOSE                    BRANCH IF YES                   92671027
CLEANX   EQU   *                                                        92707627
         SR    RENTRY,RENTRY            SET GOOD RETURN CODE     Y02027 92744227
ERREXIT  EQU   *                                                 Y02027 92780827
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027 92817427
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT DONE             Y02027 92854027
*                                                                Y02027 92890627
*              POST APPLICATION PROGRAM ECB COMPLETE             Y02027 92927227
*                                                                Y02027 92963827
XMPOST   EQU   *                                                 Y02027 93000427
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027 93037027
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027 93073627
         SR    RPARM,RZERO              GET AIB ADDRESSABILITY   Y02027 93110227
XMPOST1  EQU   *                                                 Y02027 93146827
         LR    RZERO,RENTRY             LOAD COMPLETION CODE     Y02027 93183427
         LTR   RZERO,RZERO              ERROR CONDITION?       @OZ34827 93220027
         BZ    XMPOST1A                 BR, NO                 @OZ34827 93256627
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED @OZ34827 93293227
         BNO   XMPOST1A                 BR, NO                 @OZ34827 93329827
         OI    PEWAGSW+ONE,NEEDHDRN     SET NEED HDR ON NXT PUT@OZ34827 93366427
         CLM   RZERO,ONE,FIVEC          ERROR  '5C' ?          @OZ34827 93403027
         BNE   XMPOST1A                 BR, NO                 @OZ34827 93439627
         TM    PEWACTL,HDRFLG           F1 OR F3 MSG SEG       @OZ34827 93476227
         BO    XMPOST1A                 BR, YES                @OZ34827 93512827
         NI    PEWAGSW+ONE,AVTEFF-NEEDHDRN RESET NEED HDR ON   @OZ34827 93549427
*                                           NEXT PUT.          @OZ34827 93586027
XMPOST1A EQU   *                                               @OZ34827 93622627
         MVC   AIBCMPTP(4),PEWAECBA     STORE ECB  IN LIST       Y02027 93659227
         MVC   AIBCMPTP(4),PEWAECBA     STORE ECB  IN LIST       Y02027 93695827
         L     RERB,PCBPEBAD            GET PEB ADDRESS          Y02027 93732427
         LTR   RERB,RERB                TEST IF AP IS ACTIVE     Y02027 93769027
         BNZ   XMPOST2                  YES, BYPASS AIB FREEING  Y02027 93805627
         MVI   AIBSTATE,AIBFREE         FREE AIB                 Y02027 93842227
         BAL   RETURN,DSPDISP           BR TO AVOID XMPOST     @G36XRAW 93878827
XMPOST2  EQU   *                                                 Y02027 93915427
         L     RERB,PEBASCB-IEDQPEB(RERB) GET ASCB ADDRESS       Y02027 93952027
         LTR   RERB,RERB                TEST IF FLAG HAS         Y02027 93988627
*                                       INVALIDATED ASCB ADDR    Y02027 94025227
         BNM   NONEGFLG                 BRANCH IF NEGATIVE FLG @G36XRAW 94061827
*                                       OFF-                   @G36XRAW 94098427
         BAL   RETURN,DSPDISP           BRANCH-AVOID XMPOST    @G36XRAW 94135027
NONEGFLG EQU   *                                               @G36XRAW 94171627
         L     RENTRY,PCBPEBAD          PEB ADDR               @ZA05000 94208227
         L     RTEMP,CVTPTR             ADDR OF CVT            @ZA05000 94244827
         ICM   RTEMP,ALL,CVTAQAVT-CVTMAP(RTEMP)  ADDR OF TCX   @ZA05000 94281427
         CLC   PEBASID-IEDQPEB+TWO(2,RENTRY),TCXASID-IEDQTCX(RTEMP)     94318027
*                                       IS A.P. SUBTASK OF MCP @ZA05000 94354627
         BNE   XMPOST3                  BR, NO                 @ZA05000 94391227
         L     RPARM,AIBCMPTP           GET ECB ADDR           @ZA05000 94427827
         POST  (1),(0)                  DO NORMAL POST         @ZA05000 94464427
         BAL   RETURN,DSPDISP           RETURN TO DISPATCHER   @G36XRAW 94501027
XMPOST3  EQU   *                                               @ZA05000 94537627
*        ISSUE SVC 102 TO SCHEDULE SRB TO POST THE             @Z40X9AG 94574227
*        ECB IN THE APPLICATION PROGRAM"S MEMORY               @Z40X9AG 94610827
         MVC   AIBSSPAS,PEBASCB-IEDQPEB(RENTRY) SET ASCB ADDR  @Z40X9AG 94647427
         MVC   AIBSSPID,PEBASID+TWO-IEDQPEB(RENTRY) SET ASID   @Z40X9AG 94684027
         STC   RZERO,AIBSSPCC           SET COMPLETION CODE    @Z40X9AG 94720627
         MVC   AIBSSPTC,PEBTCB-IEDQPEB(RENTRY) SET TCB ADDR    @Z40X9AG 94757227
         MVI   AIBSSPF1,AIBSSPEC        SET ENTRY CODE         @Z40X9AG 94793827
         LA    RPARM,AIBCMPTP           POINT TO PARM LIST     @Z40X9AG 94830427
         AQCTL                          SVC 102                @Z40X9AG 94867027
         BAL   RETURN,DSPDISP           BRANCH-TO DISPATCHER   @G36XRAW 94903627
        SPACE 2                                                         94940227
*                                                                Y02027 94976827
*        CLOSE IS WAITING FOR END OF MESSAGE THROUGH MH          Y02027 95013427
*        POST ELEMT SET UP BY CLOSE                              Y02027 95050027
*                                                                Y02027 95086627
CLOSE    EQU   *                                                 Y02027 95123227
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027 95159827
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027 95196427
         SR    RPARM,RZERO              GET START OF AIB         Y02027 95233027
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027 95269627
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT AS FINISHED      Y02027 95306227
         L     RPARM,PEWARCB            GET ADDR OF RCB SET    @OZ07798 95342827
*                                       UP BY CLOSE              Y02027 95379427
         BAL   RETURN,DSPPOST           EXIT TO DISPATCHER TO  @G36XRAW 95416027
*                                       POST ELEM TO READY QUE @G36XRAW 95452627
         EJECT                                                          95489227
         EJECT                                                          95525827
ERB      EQU   *                                                        95562427
         SPACE                                                          95599027
*                                                                     * 95635627
*     INITIALIZE ERB TO OBTAIN EMPTY BUFFERS                          * 95672227
*                                                                     * 95708827
         SPACE                                                          95745427
         LA    RPARM,AVTBFREB           ADDRESS OF AVAILABLE            95782027
*                                       BUFFER QCB                      95818627
         ST    RPARM,LCBERB             INITIALIZE ERB KEY AND          95855227
*                                       QCB FIELDS                      95891827
         MVI   LCBERBPY,PRIINTRQ        SET ERB PRIORITY                95928427
         XC    LCBERBLK(3),LCBERBLK     CLEAR ERB LINK FIELD TO ZERO    95965027
         MVI   LCBERBST,PUTFLG          FLAG THIS ERB AS A PUT ERB      96001627
         XC    LCBERBCH(3),LCBERBCH     SET BUFFER CHAIN PTR TO ZERO    96038227
         SR    RZERO,RZERO              CLEAR WORK REG         @SA69971 96074827
         IC    RZERO,PCBBUFIN           IN/OUT COUNT           @SA69971 96111427
         SRL   RZERO,FOUR               ISOLATE BUFIN          @SA69971 96148027
         STC   RZERO,LCBERBCT           INITIALIZE BFR REQ     @SA69971 96184627
         MVC   LCBERBCT+1(1),PEUNCT     UNITS PER BUFFER                96221227
         LA    RZERO,PEWASCB            SCB ADDRESS                     96257827
         ST    RZERO,LCBSCBA-1          ADDRESS OF CURRENT SCB          96294427
         L     RPARM,PCBLCBAD           LCB ADDRESS                     96331027
         ST    RZERO,LCBSCBA-1-IEDQLCB(,RPARM) SET SCB FOR MSG   A48279 96367627
         LA    RZERO,PERAQCB            ADDRESS OF PUT SCHEDULER        96404227
*                                       QCB                             96440827
         ST    RZERO,PERCQCB            MAKE ADDRESS OF QCB             96477427
*                                       AVAILABLE TO BUFFER REQUEST     96514027
*                                       SUBTASK                         96550627
         MVI   LCBPRI-IEDQLCB(RPARM),PRIAPBFR  LCB PRIORITY             96587227
         MVI   LCBERBST-IEDQLCB(RPARM),LCBDLNKN SET DELINK SWITCHY02027 96623827
         LA    RZERO,LCBRSKEY-IEDQLCB(RPARM) STCB ADDRESS        Y02027 96660427
         ST    RZERO,LCBRSKEY-IEDQLCB(RPARM) PUT STCB IN LCB     Y02027 96697027
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER VTO          96733627
         MVI   LCBLSPCI+2-IEDQLCB(RPARM),1 INVALID CCW OP CODE          96770227
         EJECT                                                          96806827
*                                                                     * 96843427
*        POST ERB TO BUFFER REQUEST QCB VIA DISPATCHER                * 96880027
*                                                                     * 96916627
         SPACE                                                          96953227
         ST    RWORK,PEWANEB            SAVE ADDRESS OF NEXT     Y02027 96989827
*                                       BYTE OF DATA IN WORKAREA Y02027 97026427
         LR    RPARM,RERB               ADDRESS OF ERB TO POST          97063027
         BAL   RETURN,DSPCHAIN          POST ERB TO BUFFER     @G36XRAW 97099627
*                                       REQUEST                @G36XRAW 97136227
         SPACE 3                                                        97172827
*                                                                Y02027 97209427
TNAMEL   DC    H'8'                     SIZE OF TERMNAME         Y02027 97246027
QCBHDRSZ DS    0H                       SIZE OF QCB HEADER     @ZM47936 97282627
         DC    AL2(QCBPRFSZ)                                   @ZM47936 97319227
PATCH    DC    25H'0'                   PATCH AREA               Y02027 97355827
FIVEC    DC    X'5C'                    ERROR CODE             @OZ34827 97392427
*                                                                Y02027 97429027
         EJECT                                                          97465627
*                                                                     * 97502227
*     E Q U A T E S   A N D   R E A D - O N L Y   C O N S T A N T S   * 97538827
*                                                                     * 97575427
         SPACE                                                          97612027
ERBKEY   EQU   X'00'                    ELEMENT REQUEST BLOCK KEY       97648627
BLANK    EQU   C' '                     BLANK TERMNAME         @ZA02061 97685227
DEBNMEXT EQU   X'10'                    EXTENT OFFSET IN DEB    SA52991 97721827
MOVER    DS    0H                                                       97758427
         MVC   0(1,RBUF),0(RWORK)       EXECUTED INSTRUCTION THAT       97795027
*                                       MOVES DATA FROM A USER'S        97831627
*                                       WORKAREA TO A MCP BUFFER        97868227
PSVTO    EQU   X'12'                    HEX UI                   S22024 97904827
PUTFLG   EQU   X'02'                    PUT ERB IDENTIFIER              97941427
OUTFLG   EQU   X'0F'                    HEX 0F                   S22024 97978027
DCBOPEN  EQU   X'10'                    HEX 10                   S22024 98014627
LOCKR    EQU X'20'                      HEX 20                   S22024 98051227
SINGLE   EQU   X'60'                    HEX 60                   S22024 98087827
RELEASE  EQU   X'01'                    HEX 01                   S22024 98124427
ENTRYFLG EQU   X'12'                    FLAG FOR ENTRY AFTER   @XA11307 98161027
*                                        TIME DELAY            @XA11307 98197627
OFFSET   EQU   X'14'                    OFFSET TO THE QCB      @XA11307 98234227
DELAYPRI EQU   X'D6'                    TIME DELAY SIGNAL      @XA11307 98270827
RESETPRI EQU   X'E0'                    LCB PRIORITY AFTER     @XA11307 98307427
*                                        TIME DELAY            @XA11307 98344027
PIPOFF   EQU   X'FD'                    TURN OFF PUT IN        @XA11307 98380627
*                                        PROGRESS BIT          @XA11307 98417227
TIC      EQU   X'08'                    TIC COMMAND                     98453827
ONE      EQU   1                        MASK TO ICM LO-ORDER BYTEY01004 98490427
INVTIC   EQU   2                        INVALID TIC ADDRESS             98527027
HALF     EQU   3                        MASK TO ICM HALFWORD.    Y01004 98563627
ADDR     EQU   7                        MASK TO ICM AN ADDRESS.  Y01004 98600227
ALL      EQU   15                       MASK TO ICM ALL 4 BYTES. Y01004 98636827
TRMLEN   EQU   8                        LENGTH OF TERMINAL NAME  Y02027 98673427
THRESH   EQU   X'C0'                    QUEUES FULL              Y02027 98710027
NOBFRS   EQU   X'5C'                    THRESH OR PUT IN PROGRESSY02027 98746627
DEST     EQU   X'54'                    DESTINATION ERROR C.C.   Y02027 98783227
QUICKC   EQU   X'5E'                    QUICK CLOSE COMPLETION C.Y02027 98819827
LENERR   EQU   X'52'                    INVALID WORK UNIT LNGTH@ZA04032 98856427
ZERO     EQU   0                        DISPLACEMENT             Y02027 98893027
TWO      EQU   2                        DISPLACEMENT             Y02027 98929627
THREE    EQU   3                        MASK OF 0011             Y02027 98966227
FOUR     EQU   4                        DISPLACEMENT             Y02027 99002827
EIGHT    EQU   8                        DISPLACEMENT             Y02027 99039427
         EJECT                                                          99076027
         TPRIOR                                                         99112627
         EJECT                                                          99149227
*                                                                     * 99185827
*              D  S  E  C  T  S                                       * 99222427
*                                                                     * 99259027
         SPACE 3                                                        99295627
         TTCXD                                                 @ZA05000 99332227
         EJECT                                                          99368827
CVTMAP   CVT   DSECT=YES                                       @ZA05000 99405427
         EJECT                                                          99442027
         SPACE                                                          99478627
         TAVTD                                                   Y02027 99515227
         TLCBD                          LINE CONTROL BLOCK              99551827
         TPRFD                          BUFFER PREFIX                   99588427
         TDISPD                         TCAM DISPATCHER                 99625027
         TTRMD                          PUT PROCESS ENTRY               99661627
         TPCBD                          PROCESS CONTROL BLOCK           99698227
         TAIBD EXT=PUTWRITE                                      Y02027 99734827
         TPEBD                                                   Y02027 99771427
         TPEWAD                         PROCESS ENTRY WORKAREA          99808027
         TSCBD                                                          99844627
         TQCBD                                                          99881227
         DCBD  DSORG=TX                                                 99917827
MASKOFF  EQU   X'FF'-LCBTETEN-LCBBFRSZ-LCBABRTN                         99954427
         END                                                            99991027
