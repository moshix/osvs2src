 TITLE 'IEDQFE30 BUFFER DUMP'                                           00100020
IEDQFE30 CSECT                                                          00200020
*A168000,198000,258000,267000,290000,300000,502000,710000       SA67105 00230054
*D208000-214000,708000                                          SA67105 00260054
*A329200,709000                                                 SA69093 00260105
*A324000                                                        OY03830 00260205
*C224000,236000                                                @SA69974 00260356
*A290060                                                       @YA05146 00260456
*C328000,329200                                                @ZA00216 00260556
*C007000,290480-291560,299000                                    X03039 00270507
*C 290480                                                      @Y17XASZ 00280500
*C279000,342000-344000                                         @OY19405 00280686
*C406000,412000,418000,424000,436000-454000                    @OY19405 00280786
*A227000,288000,302000,308000,340000,341000,422000,430000      @OY19405 00280886
*A503000,506000                                                @OY19405 00280986
*********************************************************************** 00300020
*                                                                     * 00400020
*MODULE NAME--IEDQFE30 BUFFER DUMP                                    * 00500020
*                                                                     * 00600020
*STATUS - CHANGE LEVEL 8                                         X03039 00700007
*                                                                     * 00800020
*FUNCTION-                                                            * 00900020
*   IEDQFE30 IS USED TO ACCUMULATE BUFFER INFORMATION FOR A LINE OR   * 01000020
*   LINES BEING TRACED BY THE LINE I/O TRACE.THE BUFFERS AND SELECTED * 01100020
*   STATUS INFORMATION ARE OUTPUTTED VIA COMWRITE.                    * 01200020
*   UPON ENTRY FROM IEDQC6 THIS ROUTINE CHECKS TO SEE IF THIS IS A    * 02000020
*   LOAD OR DELETE FUNCTION.IF A LOAD IS REQUESTED THE FLAGS AT       * 02200020
*   AVTAFE30 ARE TESTED. IF THEY ARE OFF,THIS ROUTINE STORES ITS ENTRY* 02400020
*   POINT ADDRESS INTO AVTAFE30 AND SETS THE FLAGS ON,INDICATING THAT * 02600020
*   THE ROUTINE IS ACTIVE.THE ROUTINE THEN RETURNS TO IEDQC6 WITH A   * 02800020
*   RETURN CODE OF ZERO. IF THE FLAGS ARE ALREADY ON RETURN IS TO     * 03000020
*   IEDQC6 WITH A RETURN CODE OF FOUR.IF A DELETE FUNCTION IS         * 03200020
*   REQUESTED THE FLAGS IN AVTAFE30 ARE SET OFF INDICATING THAT THE   * 03400020
*   ROUTINE IS NOT ACTIVE.                                            * 03600020
*                                                                     * 03800020
*   EACH TIME MODULE IEDQAA IS ENTERED THE FLAGS AT AVTAFE30 ARE      * 04000020
*   TESTED. IF THEY ARE ON THIS ROUTINE IS BRANCHED TO.               * 04200020
*   UPON ENTRY FROM IEDQAA THE LCB AND SCB ARE FOUND. A TEST IS MADE  * 04400020
*   ON LCBTRACE TO DETERMINE IF THE LINE IS BEING TRACED. IF THE LINE * 04600020
*   IS NOT BEING TRACED RETURN IS TO IEDQAA.IF THE LINE IS BEING      * 04800020
*   TRACED,APPROPRIATE DATA IS MOVED INTO THE INTERNAL TRACE TABLE AND* 05000020
*   RETURN IS TO IEDQAA. WHEN FIVE BUFFERS HAVE BEEN COLLECTED IN THE * 05200020
*   INTERNAL TRACE TABLE THE COMWRITE ECB IS POSTED VIA SVC 102 TO    * 05400020
*   HAVE THE TABLE WRITTEN TO THE COMWRITE DATASET.                   * 05600020
*                                                                     * 05800020
*ENTRY POINTS-ENTER IS ENTERED FROM IEDQC6 FOR INITIALIZATION.        * 06000020
*             ENTRY IS ENTERED FROM IEDQAA                            * 06200020
*                                                                     * 06400020
*INPUT FROM IEDQC6                                                    * 06600020
*      REG 0 ZERO FOR LOAD OPERATION                                  * 06800020
*            NON-ZERO FOR DELETE OPERATION                            * 07000020
*      FROM IEDQAA                                                    * 07200020
*      REG 1 CONTAINS BUFFER ADDRESS                                  * 07400020
*                                                                     * 07600020
*OUTPUT AFTER SETUP REG 15 HAS RC FOR IEDQC6                          * 07800020
*       WHILE BUFFERS ARE BEING TRACED-                               * 08000020
*       ADDRESS OF PARM LIST IN AVTCWPM1 OR AVTCWPM2                  * 08200020
*                                                                     * 08400020
*EXITS NORMAL BR 14 TO IEDQC6 WITH R 15=0                             * 09000020
*      ERROR  BR 14 TO IEDQC6 WITH R 15= RETURN CODE.                 * 09200020
*                                                                     * 09400020
*ATTRIBUTES SERIALLY REUSABLE                                         * 09600020
*                                                                       09800020
*TABLES-BUFFER TRACE TABLE                                              10000020
*        FORMAT OF EACH 96 BYTE ENTRY                      BYTES        10200020
*        BUFFER ADDRESS                                     4           10400020
*        ERROR BITS IN SCB                                  4           10600020
*        LAST HALF OF CSW                                   4           10800020
*        SENSE BYTE                                         1           11000020
*        FLAG 1 OF IOB                                      1           11200020
*        FLAG 3 OF IOB                                      1           11400020
*        STATUS OF ERB IN LCB                               1           11600020
*        STATUS OF LCB                                      2           11800020
*        UCB (CHAN UNIT ADDRESS)                            2           12000020
*        BUFFER PREFIX AND PART OF BUFFER                   76          12200020
*EXTERNAL ROUTINES-SVC 102 TO POST COMWRITE(IEDQFW)                     12400020
*                                                                     * 12500020
*********************************************************************** 12600020
         EJECT                                                          12800020
R0       EQU   0                                                        13000020
R1       EQU   1                                                        13200020
R2       EQU   2                                                        13400020
R3       EQU   3                                                        13600020
R4       EQU   4                                                        13800020
R5       EQU   5                                                        14000020
R6       EQU   6                                                        14200020
R7       EQU   7                                                        14400020
R8       EQU   8                                                        14600020
R9       EQU   9                                                        14800020
R10      EQU   10                                                       15000020
R11      EQU   11                                                       15200020
R12      EQU   12                                                       15400020
R13      EQU   13                                                       15600020
R14      EQU   14                                                       15800020
R15      EQU   15                                                       16000020
*        R3                        BASE ADDRESS                         16200020
*        R4                        AVT ADDRESS                          16400020
RWK1     EQU   2                                                        16600020
RWK2     EQU   5                                                        16800020
ZERO     EQU   0                                                SA67105 17500054
ONE      EQU   1                                                SA67105 18200054
X1A      EQU   26                 DISPLACEMENT                 @ZA00216 18400056
X2C      EQU   44                 DISPLACEMENT                 @ZA00216 18600056
         EJECT                                                          19000020
         USING IEDQAVTD,R4                                              19200020
         STM   R14,R12,12(R13)     SAVE                                 19400020
         BALR  R3,0                REGS                                 19600020
         USING *,R3                                                     19800020
IEDQFE30 IEDHJN  ENTER                                                  19900054
         ST    R13,SAVE+4                                               20000020
         LA    R8,SAVE                                                  20200020
         ST    R8,8(R13)                                                20400020
         LR    R13,R8                                                   20600020
         LTR   R0,R0               LOAD OR DELETE                       21800020
         BNZ   DELETE              BRANCH DELETE                        22000020
         OC    AVTAFE30,AVTAFE30        TEST IF PREV. LOADED.  @SA69974 22400056
         BNZ   ERROR               NO                                   22600020
         L     RWK2,AVTCWTCB       GET COMWRITE TCB ADDRESS             22650020
         ST    RWK2,COMWRTCB       AND PUT IN AQCTL PARM LIST           22700020
         OC    AVTBUFTR,AVTBUFTR   TRACE TABLE ON INTRO        @OY19405 22705086
         BZ    NOTABLE             NO                          @OY19405 22710086
         LA    R2,X'37'            SET UP                      @OY19405 22715086
         AH    R2,AVTKEYLE               TRACE                 @OY19405 22720086
         SRL   R2,5                           TABLE            @OY19405 22725086
         SLL   R2,5                                ENTRY       @OY19405 22730086
         STH   R2,ENTSZ                                 SIZE   @OY19405 22735086
NOTABLE  EQU   *                                                        22740086
         LA    RWK2,ENTRY          GET ENTRY POINT ADDRESS              22750020
         ST    RWK2,AVTAFE30       STORE ADDRESS IN AVT                 22800020
         MVI   AVTAFE30,X'FF'      SET LOADED FLAG                      23000020
         SR    R15,R15             SET GOOG RETURN CODE                 23200020
         B     RETURN                                                   23400020
DELETE   XC    AVTAFE30,AVTAFE30        CLEAR ADDRESS SLOT.    @SA69974 23600056
         SR    R15,R15             SET GOOD RETURN CODE                 23800020
         B     RETURN                                                   24000020
ERROR    LA    R15,4                    SET BAD RETURN CODE             24200020
RETURN   L     R13,SAVE+4          RETURN TO CALLER                     24400020
         L     R14,12(R13)         WITH RETURN CODE                     24600020
         LM    R0,R12,20(R13)      IN REG 15                            24800020
         BR    R14                                                      25000020
         SPACE 2                                                        25010020
*********************************************************************** 25020020
*        THE FOLLOWING CONSTANTS, VARIABLE AT ASSEMBLY TIME, CONTROL  * 25030020
*        THE SIZE OF EACH TRACE ENTRY AND THE NUMBER OF ENTRIES IN    * 25040020
*        EACH TRACE BUFFER.  IF CHANGED, SUBSEQUENT CHANGES MUST ALSO * 25050020
*        BE MADE IN THE FORMATTING PROGRAM - IEDQXB.                  * 25060020
*********************************************************************** 25070020
         SPACE                                                          25080020
SIZE     EQU   96                  LENGTH OF EACH TRACE ENTRY           25090020
ENTRYNUM EQU   10                  NUMBER OF ENTRIES IN EACH BUFFER     25100020
         EJECT                                                          25200020
*                                  MODULE 'IEDQAA' WILL NOW BRANCH      25400020
*                                  TO THIS MODULE AT SYMBOL 'ENTRY'     25600020
RTERM    EQU   1                   TERMINAL ENTRY ADDRESS       SA67105 25800054
RSCB     EQU   3                   SCB ADDRESS                          26000020
RLCB     EQU   4                   LCB ADDRESS                          26200020
RPREFIX  EQU   6                   BUFFER ADDRESS                       26400020
RTABLE   EQU   9                   370X LINE-TRACE TABLE ADDR   SA67105 26700054
         DROP  R3                                                       27000020
         DROP  R4                                                       27200020
         USING ENTRY,R2                                                 27400020
         USING AVTSAVE2,R13                                             27600020
         DS    0F                                                       27800020
ENTRY    B     NORM                ENTRY POINT FROM IEDQAA     @OY19405 27900086
         STM   R0,R15,SAVEREGS                                 @OY19405 27904086
         B     USER                ENTRY FROM BUFFTR MACRO     @OY19405 27908086
NORM     STM   R0,R15,SAVEREGS                                 @OY19405 27912086
         DROP  R2                                                       27920020
         USING ENTRY,R12                                                27940020
         LR    R12,R2                                                   27960020
         LR    RPREFIX,R1          SET BUFFER ADDRESS INTO RPREFIX      28000020
         USING IEDQPRF,RPREFIX                                          28200020
         L     RLCB,PRFLCB-1       LCB ADDRESS                          28400020
         USING IEDQLCB,RLCB                                             28600020
         L     RSCB,LCBSCBA-1      SCB ADDRESS                          28800020
         TM    AVTBUFSW,AVTUNCON   TRACE ALL SPECIFIED         @OY19405 28850086
         BO    TRACEBFR            YES, DONT CHK TERM TRACE    @OY19405 28900086
         USING IEDQSCB,RSCB                                             29000020
         LH    RTERM,LCBTTCIN      TNT OFFSET                   SA67105 29006054
         N     RTERM,AVTCLRHI           CLEAR NEG. PROPAGATION @YA05146 29008056
         BZ    TEST0X                   ZERO TNT - MUST BE 0X  @YA05146 29010056
         L     R15,AVTRNMPT        ADDR OF TNT CODE             SA67105 29012054
         BALR  R14,R15             GO GET TERMINAL ADDR         SA67105 29018054
         SH    RTERM,TERMPREF      BACK UP TO PREFIX            SA67105 29024054
         USING IEDNTRM,RTERM                                    SA67105 29030054
         TM    TRMSTATE,TRMPREF   3705-CONNECTED TERMINAL?     @YM08488 29036000
         BZ    TEST0X              BRANCH IF NO                 SA67105 29042054
         TM    TRMBYTE1,TRMTRACE   IS PTRACE ACTIVE            @Y17XASZ 29045000
*                                                                X03039 29058007
*  NOTE -                                                        X03039 29068007
*        NOP THE NEXT INSTRUCTION TO CAUSE BUFFER DUMPING        X03039 29078007
*        FOR ALL VTAM TERMINALS WHEN NO SPECIFIC VTAM            X03039 29088007
*        TERMINALS ARE BEING TRACED.                             X03039 29098007
*                                                                X03039 29108007
         BZ    RETURN1             BRANCH IF NO                 SA67105 29162054
         B     TRACEBFR            YES, GO TRACE THIS BUFFER    SA67105 29168054
         SPACE 1                                                SA67105 29174054
TEST0X   EQU   *                                                SA67105 29180054
         TM    LCBSTAT2,LCBTRACE   LINE BEING TRACED                    29200020
         BC    14,RETURN1                                               29500020
*                                                                     * 29600020
*NOTE-                                                                * 29700020
*        NOP THE PRECEDING INSTRUCTION TO CAUSE                       * 29800020
*        BUFFER DUMPING FOR ALL NON-VTAM TERMINALS WHEN NO       X03039 29900007
*        LINES ARE BEING TRACED.                                 X03039 29950007
*                                                                     * 30000020
TRACEBFR EQU   *                                                SA67105 30200054
         L     R10,AVTBUFTR        DID USER SPECIFY            @OY19405 30220086
         LTR   R10,R10             TRACE ON INTRO              @OY19405 30240086
         BNZ   BYPASSDF            YES, DON'T SET UP DEFAULT   @OY19405 30260086
         LA    R10,CURD            POINT TO INTERNAL TABLE     @OY19405 30280086
         USING IEDTRBUF,R10                                    @OY19405 30300086
BYPASSDF EQU   *                                                        30320086
         L     RWK2,CUR            LOAD TABLE POINTER                   30400020
         L     RWK1,0(RWK2)                                             30600020
         USING BUFFTRAC,RWK1                                            30800020
         MVC   BUFFID(4),DAT       MOVE IN EYE CATCHER FOR AA  @OY19405 30850086
         ST    R6,BUFFADD          STORE BUFFER ADD (ELEMENT)           31000020
         MVC   CBERRST(L'CBERRST),SCBERRST                              31200020
         MVC   CBSENS0(1),LCBSENS0 MOVE INFO INTO TABLE                 31400020
         MVC   CBCSWLW(4),LCBCSW+3 MOVE INFO INTO TRACE TABLE           31600020
         MVC   CBFLAG1(1),LCBFLAG1 MOVE INFO INTO TRACE TABLE           31800020
         MVC   CBFLAG3(1),LCBFLAG3 MOVE INFO INTO TRACE TABLE           32000020
         MVC   CBERBST(1),LCBERBST MOVE INFO INTO TRACE TABLE           32200020
         MVC   CBSTATE(2),LCBSTATE MOVE INFO INTO TRACE TABLE           32400020
         CLI   LCBFLAG1,ZERO            IS THIS A PLCB          OY03830 32460005
         BE    MPPLCB                   YES, NO UCB THERE       OY03830 32520005
         L     RWK2,LCBDCBPT       DCB ADDRESS                          32600020
         TM    X1A(RWK2),TRMLGB   IS THIS AN LGB               @ZA00216 32800056
         BO    MPPLCB                   BR YES                 @ZA00216 32840056
         L     RWK2,X2C(RWK2)     LOAD DCB ADDRESS             @ZA00216 32880056
         CLI   PRFPRI,PRIAPBFR          APPL PROG BUFFER ?      SA69093 32940005
         BE    MPPLCB                   BRANCH IF YES           SA69093 32960005
         SR    R7,R7               ZERO WORK REGISTER                   33000020
         IC    R7,LCBUCBX          INSERT INDEX BYTE                    33200020
         SLL   R7,2                MULT BY FOUR                         33400020
         L     RWK2,32(RWK2,R7)    UCB ADDRESS                          33600020
         MVC   UCB(2),4(RWK2)      MOVE INFO INTO TRACE TABLE           33800020
         B     REGRESTR            GO RESTORE ENTRY POINTER     PTR2345 33900020
MPPLCB   MVC   UCB(2),MPPFLAG      SET UCB ADDR TO ZERO         PTR2345 34000020
         S     RPREFIX,FULL8       POINT TO RH IN NEG. PREFIX  @OY19405 34020086
         MVC   CBCSWLW(4),0(RPREFIX) MOVE RH INTO TRACE ENTRY  @OY19405 34040086
         A     RPREFIX,FULL8       POINT AT BUFFER AGAIN       @OY19405 34060086
REGRESTR L     RWK2,CUR            RESTORE POINTER TO 'CURRENT' PTR2345 34100020
         LH    R7,ENTSZ            DATA SPACE LEFT IN THIS ENT @OY19405 34110086
         LA    R4,X'18'            IS DATA ALREADY MOVED       @OY19405 34120086
         SR    R7,R4               SUBTRACTED FROM SIZE OF ENT @OY19405 34130086
         LA    RWK1,24(RWK1)       BUMP DATA POINTER           @OY19405 34140086
         TM    AVTBUFSW,AVTFULLT   ENTIRE BUFFER TRACE         @OY19405 34150086
         BAL   R14,TRACALL         REQUESTED...., YES          @OY19405 34160086
         L     RWK1,0(RWK2)        RESTORE DATA POINTER        @OY19405 34170086
NOFULL   EQU   *                                               @OY19405 34180086
         LA    R14,SVC             POINT LINK REG TO SVC RTN   @OY19405 34190086
         BCTR  R7,0                DECREMENT FOR MOVE          @OY19405 34200086
         EX    R7,SINGLE           EXECUTE THE MOVE            @OY19405 34250086
         AH    RWK1,ENTSZ          UPDATE THE ENTRY POINTER    @OY19405 34300086
         CL    RWK1,8(RWK2)        LAST ENTRY IN TABLE                  34600020
         BNL   BUMP                YES                                  34800020
         ST    RWK1,0(RWK2)        NO SAVE                              35000020
         B     RETURN1                                                  35200020
BUMP     EQU   *                                                        35400020
         MVC   0(4,RWK2),4(RWK2)   UPDATE TABLE POINTERS                35600020
         L     RWK1,COUNT          TRACE NUMBER                         35800020
         LA    RWK1,1(RWK1)        OF TIMES TABLE                       36000020
         ST    RWK1,COUNT          HAS BEEN USED.                       36200020
         TM    PARMFLAG,X'40'      HAS COMWRITE WRITTEN TABLE           36400020
         BC    8,RETURN1           NO BRANCH TO USE TABLE AGAIN         36600020
         TS    AVTCWTS1            PARM POINTER AVAILABLE               36800020
         BC    4,CKTS2             NO BRANCH                            37000020
         LA    RWK1,PARMLIST       LOAD ADDRESS OF COMWRITE PARMS       37200020
         ST    RWK1,AVTCWPM1       STORE ADDRESS IN AVT PARM POINTER    37400020
         LA    RWK1,AVTCWEC1       GET COMWRITE ECB ADDRESS             37600020
         B     STAQC               GO SET UP TO WRITE                   37800020
CKTS2    TS    AVTCWTS2            PARM POINTER AVAILABLE               38000020
         BC    4,RETURN1           NO BRANCH                            38200020
         LA    RWK1,PARMLIST       LOAD ADDRESS OF COMWRITE PARMS       38400020
         ST    RWK1,AVTCWPM2       STORE ADDRESS IN AVT PARM POINTER    38600020
         LA    RWK1,AVTCWEC2       GET COMWRITE ECB ADDRESS             38800020
STAQC    ST    RWK1,AQPARM         STORE IN AQCTL PARM                  39000020
         MVI   AQPARM,X'20'        SET NORMAL FLAGS                     39200020
         MVI   PARMFLAG,X'00'      CLEAR FLAG                           39400020
         L     RWK1,CUR            LOAD POINTERS                        39600020
         LA    RWK2,CUR1                                                39800020
         CR    RWK1,RWK2           WHICH TABLE IS BEING USED NOW        40000020
         BNE   WRTTAB2             BRANCH TO WRITE SECOND TABLE         40200020
         MVC   COUNT1+1(3),COUNT+1      MOVE IN COUNT                   40400020
         L     R7,TABLE1           GET COMWR AREA HEADER       @OY19405 40600086
         MVC   12(4,R7),COUNT1     MOVE BUF ID AND COUNT       @OY19405 40620086
         ST    R7,PARMAREA         START ADD. FOR COMWR        &OY19405 40640086
         L     RWK2,8(RWK1)        GET END OF TABLE ADD.       @OY19405 40660086
         SR    RWK2,R7             COMPUTE TABLE LENGTH        @OY19405 40680086
         STH   RWK2,PARMLEN        STORE LENGTH FOR COMWR      @OY19405 40700086
         LA    RWK2,CUR2           UPDATE POINTER TO                    40800020
         ST    RWK2,CUR            USE TABLE TWO                        41000020
         BR    R14                 LINK, SVC UNLESS FULL BUFFER@OY19405 41200086
*                                  TRACE FILLED ONE TABLE, THEN@OY19405 41250086
*                                  WE LINK TO HOOK             @OY19405 41300086
WRTTAB2  EQU   *                                                        41400020
         MVC   COUNT2+1(3),COUNT+1      MOVE IN COUNT                   41600020
         L     R7,TABLE2           GET COMWR AREA HEADER       @OY19405 41800086
         MVC   12(4,R7),COUNT2     MOVE BUF ID AND COUNT       @OY19405 41820086
         ST    R7,PARMAREA         START ADD. FOR COMWR        @OY19405 41840086
         L     RWK2,8(RWK1)        GET END OF TABLE ADD.       @OY19405 41860086
         SR    RWK2,R7             COMPUTE TABLE LENGTH        @OY19405 41880086
         STH   RWK2,PARMLEN        STORE LENGTH FOR COMWR      @OY19405 41900086
         LA    RWK2,CUR1           UPDATE POINTER TO                    42000020
         ST    RWK2,CUR            USE TABLE ONE                        42200020
         BR    R14                 LINK, SVC UNLESS FULL BUFFER@OY19405 42250086
*                                  TRACE FILLED ONE TABLE, THEN@OY19405 42300086
*                                  WE LINK TO HOOK             @OY19405 42350086
SVC      LA    R1,AQPARM           POINT TO PARM LIST FOR COMWR@OY19405 42400086
         AQCTL                     ISSUE POST FOR COMWRITE              42600020
RETURN1  LM    R0,R15,SAVEREGS     RESTORE REGS                         42800020
         BR    R10                      RETURN TO IEDQAA                43000020
USER     LR    R12,R2              SET UP BASE REG             @OY19405 43001086
         LA    R13,72(R9)          POINT RD TO AVTSAVE2        @OY19405 43002086
         L     R10,AVTBUFTR        DID USER SPECIFY            @OY19405 43003086
         LA    R14,SVC             SET UP LINK FOR COMWR       @OY19405 43004086
         B     BUMP                UPDATE TABLE POINTERS       @OY19405 43005086
TRACALL  EQU   *                                               @OY19405 43006086
         BNOR  R14                 ENTIRE BUFFER NOT REQUESTED @OY19405 43007086
         L     R4,CUR1+8           COMPUTE SIZE OF ONE TABLE   @OY19405 43008086
         S     R4,CUR1+4           TO INSURE WE CAN WRITE      @OY19405 43009086
         CH    R4,PRFSIZE          IS ONE TABLE BIG ENOUGH     @OY19405 43010086
         BLR   R14                 NO, THEN TRACE PARTIAL      @OY19405 43011086
         LA    R14,RETURN1         SET LINK REG FOR EXIT       @OY19405 43012086
         LH    R4,PRFSIZE          GET DATA CNT TO BE TRACED   @OY19405 43013086
         LA    R8,12(RPREFIX)      POINT R8 TO DATA TO BE MOVED@OY19405 43014086
         LR    R11,RPREFIX         SET UP R11 AS UNIT POINTER  @OY19405 43015086
         LH    R3,AVTKEYLE         GET DATA CNT OF EACH UNIT   @OY19405 43016086
LOOP     LR    R9,R7               LOAD AMT TO MOVE THIS TIME  @OY19405 43017086
         CR    R7,R3               CORRECT SO FAR ?            @OY19405 43018086
         BL    OK                  YES                         @OY19405 43019086
         LR    R9,R3               NO, SWAP                    @OY19405 43020086
OK       CR    R9,R4               COMPARE WITH BUFFER DATA SIZ@OY19405 43021086
         BL    OKAGAIN             ALLRIGHT                    @OY19405 43022086
         LR    R9,R4               NO, SWAP                    @OY19405 43023086
OKAGAIN  BCTR  R9,0                SUBTRACT ONE FOR THE MOVE   @OY19405 43024086
         EX    R9,MOVEDATA         MOVE DATA                   @OY19405 43025086
         LA    R9,1(R9)            BUMP CNT BACK               @OY19405 43026086
         SR    R4,R9               DECREASE DATA LEFT TO MOVE  @OY19405 43027086
         SR    R7,R9               DECREASE DATA SPACE LEFT    @OY19405 43028086
         AR    RWK1,R9             UPDATE DATA POINTER         @OY19405 43029086
         LTR   R4,R4               ALL DATA BEEN MOVED         @OY19405 43030086
         BNZ   UPDATE              NO, CONTINUE                @OY19405 43031086
         LTR   R7,R7               ANY SPACE LEFT              @OY19405 43032086
         BZ    CLEANUP             NO, CONTINUE                @OY19405 43033086
         BCTR  R7,0                SUBTRACT ONE FOR THE MOVE   @OY19405 43034086
         EX    R7,MOVEZERO         CLEAR REST OF ENTRY         @OY19405 43035086
         AR    RWK1,R7             UPDATE THE                  @OY19405 43036086
         LA    RWK1,1(RWK1)        TRACE ENTRY POINTER         @OY19405 43037086
         B     CLEANUP             FINISHED... RETURN          @OY19405 43038086
UPDATE   CR    R3,R9               DID WE MOVE ALL OF ONE UNIT @OY19405 43039086
         BE    NXTUNIT             GET NEXT UNIT TO BE MOVED   @OY19405 43040086
         SR    R3,R9               SUBTRACT CNT ALLREADY MOVED @OY19405 43041086
         AR    R8,R9               UPDATE BUFFER POINTER       @OY19405 43042086
CLEANUP  LH    R7,ENTSZ            GET DATA SPACE IN ONE UNIT  @OY19405 43043086
         CL    RWK1,8(RWK2)        LAST ENTRY IN TABLE         @OY19405 43044086
         BNL   BUMP1               YES                         @OY19405 43045086
         ST    RWK1,0(RWK2)        NO, SAVE                    @OY19405 43046086
         LTR   R4,R4               THROUGH                     @OY19405 43047086
         BZR   R14                 YES, EXIT OR SVC COMWR EXIT @OY19405 43048086
         B     LOOP                CONTINUE                    @OY19405 43049086
NXTUNIT  L     R11,8(R11)          POINT TO NEXT UNIT          @OY19405 43050086
         LA    R8,12(R11)          POINT TO DATA TO BE MOVED   @OY19405 43051086
         LH    R3,AVTKEYLE         GET DATA CNT OF EACH UNIT   @OY19405 43052086
         LTR   R7,R7               CHECK TRACE ENTRY SIZE      @OY19405 43053086
         BNZ   LOOP                NOT ZERO, CONTINUE          @OY19405 43054086
         LH    R7,ENTSZ            RESTORE TRACE ENTRY SIZE    @OY19405 43055086
         B     LOOP                CONTINUE                    @OY19405 43056086
BUMP1    BAL   R14,BUMP            UPDATE TABLE POINTERS AND   @OY19405 43057086
*                                  RETURN HERE WITHOUT SVC     @OY19405 43058086
HOOK     LA    R14,SVC             SET LINK FOR SVC BEFORE EXIT@OY19405 43059086
         L     RWK2,CUR            RESTORE TABLE POINTER       @OY19405 43060086
         L     RWK1,0(RWK2)        RESTORE POINTER TO CURR ENT @OY19405 43061086
         LH    R7,ENTSZ            RESTORE TRACE ENTRY LENGTH  @OY19405 43062086
         LTR   R4,R4               WAS THERE MORE DATA IN BUFF @OY19405 43063086
         BZR   R14                 NO, ISSUE COMWR SVC AND EXIT@OY19405 43064086
         B     LOOP                CONTINUE TRACE OF BUFFER    @OY19405 43065086
MOVEDATA MVC   0(0,RWK1),0(R8)     MOVE DATA INTO TRACE AREA   @OY19405 43066086
MOVEZERO MVC   0(0,RWK1),CLEAR     CLEAR REST OF ENTRY         @OY19405 43067086
SINGLE   MVC   BUFFER(0),12(RPREFIX)          MOVE INTO TRACE  @OY19405 43068086
ENTSZ    DC    X'0060'             SIZE OF ONE TRACE ENTRY     @OY19405 43069086
FULL8    DC    F'00000008'         CONSTANT                    @OY19405 43070086
DAT      DC    CL4'TCAM'           DATA INDICATOR              @OY19405 43071086
CLEAR    DC    32F'0'              ZEROS FOR CLEARING TRACE ENT@OY19405 43072086
MPPFLAG  DC    XL2'0000'           USED FOR APPLIC UCB ADDRESS  PTR2345 43100020
         EJECT                                                          43200020
ADDRMASK DC    F'16777215'         CLEAR HI BYTE OF REG         PTR2345 43400020
CURD     DC    A(CUR1D)            TABLE BEING USED            @OY19405 43600086
TABLE1D  DC    A(BUFFER01)                                     @OY19405 43650086
TABLE2D  DC    A(BUFFER02)                                     @OY19405 43700086
CUR1D    DC    A(FIRST)            CURRENT ENTRY TABLE ONE     @OY19405 43750086
         DC    A(FIRST)            FIRST ENTRY POINTER         @OY19405 43800086
         DC    A(LAST)             LAST ENTRY POINTER          @OY19405 43850086
CUR2D    DC    A(FIRST2)           POINTERS FOR TABLE TWO      @OY19405 43900086
         DC    A(FIRST2)           FIRST                       @OY19405 43950086
         DC    A(LAST2)            LAST                        @OY19405 44000086
COUNTD   DC    F'0'                COUNT OF TABLES USED        @OY19405 44050086
BUFFER01 DC    3F'0'                    BUFFER TIME STAMP HEADER        45600020
COUNT1   DC    X'F1',AL3(0)             BUF IDENT AND SEQUENCE FIELD    45800020
FIRST    DS    (ENTRYNUM)XL(SIZE)  BUFFER 1 TRACE TABLE                 46000020
LAST     EQU   *                                                        46200020
BUFFER02 DC    3F'0'                    BUFFER TIME STAMP HEADER        46400020
COUNT2   DC    X'F2',AL3(0)             BUF IDENT AND SEQUENCE FIELD    46600020
FIRST2   DS    (ENTRYNUM)XL(SIZE)  BUFFER 2 TRACE TABLE                 46800020
LAST2    EQU   *                                                        47000020
         DS    0D                                                       47200020
PARMLIST EQU   *                   PARAMETER LIST FOR COMWRITE          47400020
PARMAREA DC    A(BUFFER01)                                              47600020
PARMTS   DC    X'00'                                                    47800020
PARMFLAG DC    X'40'               SET COMPLETE                         48000020
PARMLEN  DC    Y(LAST-BUFFER01)                                         48200020
PARMCT   DC    F'0'                                                     48400020
PARMID   DC    CL4'BUFF'           I D USED IF COMWRITE ABENDS          48600020
AQPARM   EQU   *                   PARMLIST USED BY SVC AQCTL           48800020
         DC    X'20'                                                    49000020
         DC    AL3(0)                                                   49200020
         DC    X'80',AL3(TJID)                                          49400020
COMWRTCB DC    F'0'                COMWRITE TCB                         49500020
TJID     DC    H'0'                                                     49600020
         DS    0F                                                       49800020
SAVE     DC    18F'0'              SAVE AREA                            50000020
SAVEREGS DC    16F'0'              SAVE 'IEDQAA' REGS                   50200020
TERMPREF DC    AL2(IEDQTRM-IEDNTRM)  370X TERMINAL PREFIX SIZE  SA67105 50300054
IEDTRBUF DSECT                                                 @OY19405 50308086
CUR      DS    AL4                 TABLE BEING USED            @OY19405 50316086
TABLE1   DS    AL4                                             @OY19405 50324086
TABLE2   DS    AL4                                             @OY19405 50332086
CUR1     DS    AL4                 CURRENT ENTRY TABLE ONE     @OY19405 50340086
         DS    AL4                 FIRST ENTRY POINTER         @OY19405 50348086
         DS    AL4                 LAST ENTRY POINTER          @OY19405 50356086
CUR2     DS    AL4                 POINTERS FOR TABLE TWO      @OY19405 50364086
         DS    AL4                 FIRST                       @OY19405 50372086
         DS    AL4                 LAST                        @OY19405 50380086
COUNT    DS    AL4                 COUNT OF TABLES USED        @OY19405 50388086
         EJECT                                                          50400020
BUFFTRAC DSECT                                                          50600020
BUFFID   DS    XL4                 IEDQAA EYE CATCHER          @OY19405 50650086
BUFFADD  DS    XL4                 BUFFER ADDRESS                       50800020
CBERRST  DS    XL4                 ERROR BITS IN SCB                    51000020
*CBERR1  DS    XL1 .               FIRST BYTE                           51200020
*                                  BIT DEFINITIONS                      51400020
*CBHDRRN EQU   X'80' .             INCOMPLETE HEADER                    51600020
*CBNOLOG EQU   SCBHDRRN .          INVALID LOGON MESSAGE                51800020
*CBORIGN EQU   X'40' .             INVALID ORIGIN ON                    52000020
*CBNOTRM EQU   X'20' .             NOT A TSO TERMINAL                   52200020
*CBSEQHN EQU   X'10' .             SEQUENCE HIGH ON                     52400020
*CBNOTSO EQU   SCBSEQHN .          TSO NOT IN SYSTEM                    52600020
*CBSEQLN EQU   X'08' .             SEQUENCE LOW ON                      52800020
*CBNXFRN EQU   X'04' .             MESSAGE NOT SENT/RECEIVED            53000020
*CBNOBFN EQU   X'02' .             INSUFFICIENT BUFFERS                 53200020
*CBCUTFN EQU   X'01' .             CUTOFF ERROR                         53400020
*                                                                       53600020
*CBERR2  DS    XL1 .               SECOND BYTE                          53800020
*                                  BIT DEFINITIONS                      54000020
*CBCRMIN EQU   X'80' .             CORE MINIMUM PASSED                  54200020
*CBCRMAX EQU   X'40' .             CORE MAXIMUM PASSED                  54400020
*        EQU   X'20' .             ERROR IN DYNAMIC TRANSLATE TSO       54600020
*CBALN   EQU   X'10' .             AUTOMATIC LINE NUMBERING             54800020
*CBOLTR  EQU   X'08' .             TOTE NOT IN SYSTEM                   55000020
*                                                                       55200020
*CBERR3  DS    XL1 .               THIRD BYTE                           55400020
*                                  BIT DEFINITIONS                      55600020
*CBLOSTN EQU   X'80' .             MESSAGE LOST (OVERLAID)              55800020
*CBXPI   EQU   SCBLOSTN .          ATTENTION - SEND IT                  56000020
*CBTMIDN EQU   X'40' .             ID FROM TERMINAL INVALID             56200020
*CBXPD   EQU   SCBTMIDN .          ATTENTION - SEND ID                  56400020
*CBTMINN EQU   X'20' .             TERMINAL INOPERATIVE                 56600020
*CBSATTN EQU   X'10' .             SIMULATED ATTENTION RECEIVED         56800020
*CBUSERN EQU   X'08' .             USER ERROR ON                        57000020
*CBFORMN EQU   X'04' .             FORMAT ERROR-BSC MESSAGE             57200020
*CBATTN  EQU   X'02' .             HARDWARE ATTENTION                   57400020
*CBXCEPN EQU   X'01' .             UNIT EXCEPTION                       57600020
*CBERR4  DS    XL1 .               FOURTH BYTE                          57800020
*CBSLCTN EQU   X'80' .             ERROR DURING SELECTION               58000020
*CBTXTTN EQU   X'40' .             ERROR DURING TEXT TRANSFER           58200020
*CBCONNN EQU   X'20' .             ERROR IN CONNECT/DISCONNECT          58400020
*CBTRMLN EQU   X'10' .             TERMINAL ERROR                       58600020
*CBLINEN EQU   X'08' .             LINE ERROR                           58800020
*CBCTLUN EQU   X'04' .             ERROR IN CONTROL UNIT                59000020
*CBCHANN EQU   X'02' .             ERROR IN CHANNEL                     59200020
*CBUNDFN EQU   X'01' .             UNDEFINED ERROR                      59400020
CBCSWLW  DS    XL4                 LAST WORD OF CSW IN LCB (IOB)        59600020
CBSENS0  DS    XL1                 SENSE BYTE IN LCB (IOB)              59800020
CBFLAG1  DS    XL1                 FLAG 1 OF LCB (IOB)                  60000020
CBFLAG3  DS    XL1                 FLAG 3 OF LCB (IOB)                  60200020
CBERBST  DS    XL1                 LCBERBST STATUS OF ERB               60400020
*                                  THE X'08' BIT MUST NEVER BE ON       60600020
*                                  IN THE STATUS BYTE. IT MUST          60800020
*                                  REMAIN THE 9TH BYTE OF THE ERB       61000020
*                                  BIT DEFINITIONS                      61200020
*CBEOMSG EQU   X'40' .             END OF MESSAGE READ FROM DISK        61400020
*CBRDERR EQU   X'20' .             LOGICAL READ ERROR                   61600020
*CBERROR EQU   X'04' .             ERROR ON SEND SIDE                   61800020
*CBPRCPG EQU   X'02' .             AFTER INITIAL REQUEST IS             62000020
*                                  SATISFIED, ERB WILL BE POSTED        62200020
*                                  TO QCB INDICATED IN LCBRCQCB         62400020
*CBCOMPL EQU   X'02' .             DISK REQUEST IS COMPLETE             62600020
*CBDLNKN EQU   X'01' .             DELINK SWITCH ON- ERB NOT POSTED     62800020
*                                  IF ON, THE ERB CAN BE POSTED         63000020
*CBDLNKF EQU   X'FE' .             ERB POSTED                           63200020
*                                  PCI CAN NOT POST ERB                 63400020
CBSTATE  DS    XL2                 LCBSTATE STATUS OF LCB               63600020
*                                                                       63800020
*CBSTAT1 DS    XL1 .               FIRST STATUS BYTE                    64000020
*                                  BIT DEFINITIONS                      64200020
*CBRCLLN EQU   X'80' .             RECALL BEING PERFORMED               64400020
*CBCTLMD EQU   X'40' .             LINE IN CONTROL MODE                 64600020
*CBOCNI  EQU   X'20' .             NON-IMMEDIATE OPERATOR CONTROL       64800020
*                                  OPERATION IN PROGRESS                65000020
*CBINITN EQU   X'10' .             RECEIVING INITIATE MODE MSG.         65200020
*CBCONT  EQU   X'08' .             CONTINUE OR RESET OPERATIONS         65400020
*CBFREEN EQU   X'04' .             LINE FREE                            65600020
*CBRECVN EQU   X'02'               LINE IS RECEIVING                    65800020
*CBSENDN EQU   X'01' .             ON = LINE SENDING                    66000020
*                                  BOTH SEND AND RECEIVE BITS           66200020
*                                  OFF INDICATE LINE IS STOPPED         66400020
*                                                                       66600020
*CBSTAT2 DS    XL1 .               SECOND STATUS BYTE                   66800020
*                                  BIT DEFINITIONS                      67000020
*CBTRACE EQU   X'80' .             I/O TRACE ACTIVE FOR THIS LINE       67200020
*CBLOCK  EQU   X'80' .             LINE IN LOCK MODE                    67400020
*CBMSGNN EQU   X'40' .             MSGEN/STARTUP MESSAGE                67600020
*CBBEOTN EQU   X'20' .             EOT FROM BFRED TERM - NO EOM         67800020
*CBSNDPR EQU   X'10' .             SEND PRIORITY SWITCH SET BY          68000020
*                                  SEND SCHEDULER                       68200020
*CBNEGRP EQU   X'08'               NEGATIVE RESPONSE TO POLLING         68400020
*                                  RECEIVED                             68600020
*CBSYNC  EQU   X'04' .             LINE IS BISYNC                       68800020
*CBDIAL  EQU   X'02' .             DIAL LCB                             69000020
*CBRESP  EQU   X'01' .                                                  69200020
*                                                                       69400020
UCB      DS    XL2                 UCB CHAN UNIT ADDRESS                69600020
BUFFER   DS    XL(SIZE-(UCB+2-BUFFTRAC)) SIZE OF BUFFER TRACED          69800020
         EJECT                                                          70000054
         TAVTD                                                          70100054
         EJECT                                                          70200054
         TLCBD                                                          70300054
         EJECT                                                          70400054
         TPRFD                                                          70500054
         EJECT                                                          70600054
         TSCBD                                                          70700054
         EJECT                                                          70800054
         TTRMD                                                  SA67105 70900054
         EJECT                                                          71000005
         TPRIOR                                                 SA69093 71100005
         END                                                            71200020
