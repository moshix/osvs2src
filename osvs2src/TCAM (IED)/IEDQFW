 TITLE 'IEDQFW COMWRITE'                                                00060020
IEDQFW   CSECT                                                          00120020
         SPACE 3                                                 S21903 00122052
*  CHANGE ACTIVITY AS FOLLOWS                                           00124052
******************** MICROFICHE FLAGS *********************** SUPT CODE 00126052
*A143000,167000,174000,209000,307000,309000,472000,498000,530000 A44876 00130052
*C173000,198000,296000,304000,413000,500000                      A44876 00130152
*D354000-362000,414000-415000                                    A44876 00130252
*A 195000,307560                                                SA63960 00130352
*C 193000,472000                                                SA63960 00130452
*D299000-304000,307000,461000                                   SA65375 00130552
*A460000,467300,472700                                         @SA69987 00130656
*C200000,431000-445000                                         @SA69987 00130756
*A307840                                                       @SA69988 00130856
*A498000                                                       @SA69989 00130956
*C307490-307770,414000                                         @SA69989 00131056
*D205000-209000                                                @SA69989 00131156
*A167800,457000                                                @SA70175 00131256
*C195500-197000,501000                                         @SA70175 00131356
*A181000,417000,429000,558000                                  @SA70176 00131456
*C536000,551000-553000                                         @SA70176 00131556
*C352000                                                       @SA70181 00131656
*A167800,195000,429560                                         @SA73145 00131707
*C508000                                                       @SA73145 00131807
*C498600                                                       @YA07124 00131981
*C307490-307580  MOVED AFTER 307760                            @YA09314 00141909
*C196860-196940                                                @YA09722 00151909
*A167900                                                       @YA09722 00161909
*A167960                                                       @ZA04043 00171909
*C196860-196880                                                @ZA04043 00181909
*A429620                                                       @YA11009 00191909
*C457630-457700                                                XA12523  00201900
*C 196900,196908                                               @Y17XASZ 00211900
*A196780                                                       @OY19405 00221982
*C307420                                                       @OZ32703 00222082
         SPACE 3                                                 S21903 00240052
*********************************************************************** 00300052
*                                                                     * 00320052
*MODULE NAME-IEDQFW COMWRITE                                          * 00340052
*                                                                     * 00360052
*  DESCRIPTIVE NAME = COMWRITE                                        * 00380052
*                                                                     * 00400052
*  COPYRIGHT = 'NONE'                                                 * 00420052
*                                                                     * 00440052
*  STATUS:  CHANGE LEVEL 5                                            * 00460052
*                                                                     * 00480052
*                                                                     * 00580020
*FUNCTION-                                                            * 00640020
*   UPON ENTRY A DEVTYPE MACRO IS ISSUED TO OBTAIN THE MAX BLOCK SIZE * 00700020
*   FOR THE OUTPUT DEVICE. THE OUTPUT DCB IS OPENED AND TESTED FOR    * 00800020
*   SUCCESSFUL OPEN. COMWRIT FLAGS IN THE AVT ARE INITIALIZED AND     * 00900020
*   THE DECB'S ARE MARKED NOT ACTIVE.COMWRITE NOW GOES INTO WAIT      * 01000020
*   STATE WAITING ON EITHER ECB.                                      * 01100020
*   WHEN AN ECB IS POSTED THE PARM LIST IS CHECKED FOR BOUNDARY       * 01200020
*   ALLIGNMENT. IF NOT ON FULLWORD MESSAGE IED116I IS WRITTEN TO      * 01300020
*   THE COMWRITE DATASET.IFPARMLIST IS OK THE PARMFLAG IS TESTED FOR  * 01400020
*   CLOSEDOWN.IF CLOSEDOWN IS REQUESTED COMWRITE CLOSES. IF NOT       * 01500020
*   A TEST IS MADE TO SEE IF THE DATA TO BE WRITTEN WILL EXCEED       * 01600020
*   THE MAX BLOCKSIZE OF THE DEVICE. IF YES MESSAGE IED117I IS WRITTEN* 01700020
*   TO THE COMWRITE DATASET. A TEST IS THEN MADE TO SEE IF THE BLOCK  * 01800020
*   TO BE WRITTEN WILL EXCEED CORE. IF YES MESSAGE IED115I IS WRITTEN * 01900020
*   TO COMWRITE DATASET. IF ALL TESTS ARE OK THE RECORD IS WRITTEN AND* 02000020
*   COMWRITE ISSUES WAIT ON EITHER ECB.                               * 02100020
*   A TEST IS MADE TO SEE IF THE RECORD PROVIDED HAS PREFIX SPACE     * 02120020
*   RESERVED FOR TIME STAMP.THIS IS INDICATED BY A FLAG BEING OFF IN  * 02140020
*   THE PARAMETER LIST.IF THE PREFIX EXISTS,THE RECORD WILL BE TIME   * 02160020
*   STAMPED AND A TIMER INTERVAL SET FOR 15 SECONDS.IF ANOTHER RECORD * 02180020
*   IS WRITTEN BEFORE THE 15 SECOND INTERVAL,THE TIMESTAMP AREA WILL  * 02200020
*   BE CLEARED TO BINARY ZERO.                                        * 02220020
*                                                                     * 02300020
* INPUT-- 1-PARMLIST POINTER POINTS TO A PARMLIST ON A FULLWORD       * 02400020
*           BOUNDARY, DEFINING DATA TO BE LOGGED.                     * 02500020
*         2-CORRESPONDING ECB MUST BE POSTED BY AQCTRL SVC.           * 02600020
* OUTPUT- --SPECIFIED DATA LOGGED ON SEQUENTIAL DATA SET NAMED BY     * 02700020
*           'COMWRITE' DD CARD.                                       * 02800020
* EXITS-  NORMAL-SVC EXIT- INVOKED BY TCAM CLOSEDOWN OR REQUESTED BY  * 02900020
*                USER IN PARMLIST.                                    * 03000020
* EXITS- ERROR- ALL ERROR EXITS ARE SYSTEM ABEND 044.REGISTER 3       * 03100020
*               CONTAINS A REASON CODE WHICH IS EXPLAINED BELOW.      * 03200020
*        REGISTER 3=1 PERMANENT I/O ERROR ON OUTPUT DEVICE,           * 03300020
*                     IN ASSOCIATION WITH MESSAGE IED113I.            * 03400020
*                     REG 7 CONTAINS USER ID,REG 8 CONTAINS           * 03500020
*                     ADDR OF FAILING DECB.                           * 03600020
*                                                                     * 03700020
*                  =2 STAE ROUTINE FAILED.REG 15 CONTAINS THE         * 03800020
*                     RETURN CODE.                                    * 03900020
*                                                                     * 04000020
*                  =3 USER PARMLIST INCORRECT AND OUTPUT              * 04100020
*                     REQUIRED WAS SPECIFIED IN PARMFLAG.             * 04200020
*                     REG 7 CONTAINS ADDR OF PARMLIST                 * 04300020
*                     SAVED IN COMWRITE. REG 11 CONTAINS              * 04400020
*                     ADDR OF ERROR MESSAGE.                          * 04500020
*                                                                     * 04600020
*                  =4 THE DEVTYPE SVC FAILED.REG 15 CONTAINS          * 04700020
*                     THE RETURN CODE                                 * 04800020
*                                                                     * 04900020
*                  =5 OPEN FAILED ON THE OUTPUT DCB.                  * 05000020
*   MESSAGES--                                                        * 05100020
*        IED112I TCAM REQUESTED COMWRITE CLOSEDOWN-                   * 05200020
*                TCAM IS IN CLOSEDOWN PROCESS.                        * 05300020
*        IED113I I/O ERROR,UNIT,STATUS/SENSE,USERID,COMWRITE CLOSING- * 05400020
*                PERMANANT ERROR ON OUTPUT DEVICE,UNIT IS 3 BYTES,    * 05500020
*                STATUS/SENSE IS 8 BYTES,AND USERID IS 4 BYTES.       * 05600020
*        IED114I 0000 ABEND,COMWRITE CLOSING-                         * 05700020
*                COMWRITE HAS ABENDED WITH INDICATED COMPLETION CODE. * 05800020
*        IED115I USERID DATA AREA EXCEEDS CORE-  THE DATA AREA        * 06100020
*                        SPECIFIED IN THE PARMLIST WILL WRAP THE      * 06200020
*                        HIGH END OF CORE.                            * 06300020
*        IED116I USERID PARMLIST NOT ON FULLWORD BOUNDARY---PARMLIST  * 06400020
*                        MUST BEGIN ON FULLWORD BOUNDARY.             * 06500020
*        IED117I USERID BLKSIZE EXCEEDS DEVICE SPECS--   THE LENGTH   * 06600020
*                        OF THE DATA FIELD EXCEEDS THE MAXIMUM        * 06700020
*                        ALLOWED FOR THAT DEVICE.                     * 06800020
*ATTRIBUTES -- SERIALLY REUSEABLE,RESIDENT ONCE ATTACHED, PROBLEM     * 06900052
*              PROGRAM MODE                                           * 06930052
*                                                                     * 06960052
*                                                                     * 07000020
* NOTE-  THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL        * 07100020
*        REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS        * 07200020
*        EQUIVALENT TO THE ONE USED AT ASSEMBLY TIME. REDEFINITION OF * 07300020
*        CHARACTER CONSTANTS BY REASSEMBLY WILL RESULT IN A CORRECT   * 07400020
*        MODULE FOR THE NEW DEFINITIONS. THIS MODULE IS ALSO          * 07500020
*        DEPENDENT ON DISPLACEMENTS IN SOME OS CONTROL BLOCKS. THESE  * 07600020
*        DISPLACEMENTS ARE DEFINED IN THE EQUATES PRECEEDING THE      * 07700020
*        CODING. REDEFINITION OF THESE EQUATES & REASSEMBLY WILL      * 07800020
*        RESULT IN A CORRECT MODULE FOR THE NEW DISPLACEMENTS.        * 07900020
*                                                                     * 08000020
* SYSTEM REQUIREMENTS--MULTIPLE WAIT OPTION AND MUST BE ATTACHED BY   * 08100020
*           INTRO OPTION                                              * 08200020
* TABLES/WORKAREA--                                                   * 08300020
* PARMLIST FORMAT---MUST BE ON FULLWORD BOUNDARY                      * 08400020
*              ******************                                     * 08500020
*           +0 * ADDR OF DATA   *  ADDR OF DATA TO BE LOGGED          * 08600020
*              *                *                                     * 08700020
*              ******************                                     * 08800020
*           +4 *TS *FLGS* LENGTH*                                     * 08900020
*              *                *                                     * 09000020
*              ******************                                     * 09100020
*           +8 *RECORD  COUNT   *                                     * 09200020
*              *                *                                     * 09300020
*              ******************                                     * 09400020
*          +12 * PARM ID        *                                     * 09500020
*              *                *                                     * 09600020
*              ******************                                     * 09700020
*                                                                     * 09800020
*              +4--TEST AND SET FLAGS FOR USE OF CALLER.              * 09900020
*              +5--FLAGS                                              * 10000020
*                  BIT 0  1= TERMINATE COMWRITE AFTER SPECIFIED       * 10100020
*                            RECORD COUNT HAS EXPIRED.                * 10200020
*                  BIT 1  1= PARMLIST COMPLETE (SET BY COMWRITE       * 10300020
*                            WHEN PARMLIST FUNCTIONS ARE COMPLETED)   * 10400020
*                         0= PARMLIST INCOMPLETE OR IN USE BY COMWRITE* 10500020
*                  BIT 2  1= REQUEST IMMEDIATE TERMINATION OF COMWRITE* 10600020
*                  BIT 3  1= OUTPUT DATA IS MANDATORY IF DATA CANNOT  * 10700020
*                            BE WRITTEN AS SPECIFIED, TERMINATE       * 10800020
*                            COMWRITE WITH A S044 ABEND               * 10900020
*                            WITH A THREE IN REGISTER 3.              * 11000020
*                         0= OUTPUT DATA NOT MANDATORY. IF DATA       * 11100020
*                            CANNOT BE WRITTEN AS SPECIFIED, WRITE    * 11200020
*                            ERROR MESSAGE IN OUTPUT.                 * 11300020
*                                                                     * 11400020
*              +6--LENGTH(2 BYTES)-MUST BE BETWEEN 18 AND             * 11500020
*                            32,760 DECIMAL & MUST NOT EXCEED THE     * 11600020
*                            MAXIMUM BLKSIZE OF THE OUTPUT DEVICE     * 11700020
*                                                                     * 11800020
* AVT --                                                              * 11900020
*         AVTCWFL2--                                                  * 12000020
*              BIT 0- 1= COMWRITE ACTIVE.(SET BY COMWRITE)            * 12100020
*              BIT 1-5 NOT USED                                       * 12200020
*              BIT 6- 0= WRAPPING OUTPUT ALLOWED (REUSE SAME VOL)     * 12300020
*                    1= WRAPPING OUTPUT NOT ALLOWED (INVOKES          * 12400020
*                       VOLUME SWITICHING WHICH REQUIRES              * 12500020
*                       OPERATOR INTERVENTION).                       * 12600020
*              BIT 7- 1= COMWRITE CLOSEDOWN WAS REQUESTED BY USER     * 12700020
*                       IN PARMLIST OR TCAM CLOSEDOWN-SET BY          * 12800020
*                       COMWRITE.                                     * 12900020
*                                                                     * 13000020
*********************************************************************** 13100020
         EJECT                                                          13200020
R0       EQU   0                   PARMREG,STAERTNE                     13300020
R1       EQU   1                   INPUT AVTREG/WORK                    13400020
R2       EQU   2    WORKREG                                             13500020
R3       EQU   3    CVT REG                                             13600020
R4       EQU   4    AVT REG                                             13700020
R5       EQU   5    BASE REG                                            13800020
RETREG   EQU   6                                                        13900020
RINDEX   EQU   7                   AVTCWPM INDEX REG                    14000020
R7       EQU   7    ECB REG                                             14100020
RDECB    EQU   8                   ADDR OF DECB                         14200020
R8       EQU   8    ECB REG                                             14300020
R9       EQU   9                        WORK REGISTER            A44876 14350021
R10      EQU   10   PARM LIST  REG                                      14400020
R11      EQU   11   AREA ADDRESS  REG                                   14500020
R12      EQU   12   LENGTH  REG                                         14600020
R13      EQU   13   SAVE AREA REG                                       14700020
R14      EQU   14                  RETURN REG                           14800020
R15      EQU   15                  RETURN CODE REG                      14900020
BUSY     EQU   X'40'                                                    15000020
CWACTIVE EQU   X'80'                                                    15100020
DECBIOB  EQU   X'10'               DECB DISPL TO IOB ADDR               15200020
SENSE    EQU   X'02'               SENSE DISPL IN IOB                   15400020
STATUS   EQU   X'0C'               CSW STATUS DISPL IN IOB              15500020
BLKSIZE  EQU   X'3E'               BSAM DCB DISPL TO BLKSIZE            16000020
BOXTOP   EQU   X'A4'               CVT HI CORE ADDR                     16200020
CLSDOWN  EQU   X'01'               AVTCWFL2=CLOSEDOWN REQUESTED         16300020
DISPL    EQU   12                  DISPL FROM AVTCWPM1 TO AVTCWPM2      16500020
*                                  USED TO SET  RINDEX                  16600020
CC       EQU   4                   DISPL OF COMPL CODE IN STAE WORKAREA 16700020
HEX20    EQU   X'20'                    DEV CLASS=DIRECT ACCESS  A44876 16720021
FOUR     EQU   4                                                        16740021
SIXTEEN  EQU   16                                                       16760021
BUFSZ    EQU   976                      BUFF TR - 960+16       @SA70175 16780056
DEVTFAIL EQU   X'01'                    DEVTYPE FAILED         @SA73145 16790007
ONE      EQU   1                        CONSTANT ONE           @YA09722 16792009
SEVEN    EQU   7                        MASK FOR ICM           @YA09722 16794009
FIFTEEN  EQU   15                       MASK FOR ICM           @ZA04043 16796009
         EJECT                                                          16800020
********       INITIALIZATION                                  ******** 16900020
         USING PARMLIST,R10                                             17000020
         USING IEDQAVTD,R4                                              17100020
         USING *,R5                                                     17200020
         STM   14,12,12(13)        SAVE REGS                            17500020
         LR    R5,R15              SET BASE                             17600020
IEDQFW   IEDHJN  ENTRY                                           S05331 17620052
         LA    R12,CWSAVE          LOAD SAVE AREA ADDRESS               17700020
         ST    R12,8(13)           SET FORWARD CHAIN                    17800020
         ST    R13,4(R12)          SET BACK CHAIN                       17900020
         LR   R13,R12              LOAD SAVE REG                        18000020
         LR    R4,R1               LOAD AVT ADDR PASSED BY ATTACH       18100020
         STM   R13,R5,STAESAVE         SAVE REGS FOR STAE RETRY@SA70176 18150056
**************** SET STAE TO RECOVER COMPL CODE & INFORM ************** 18200020
**************** OPERATOR. THIS CODE & THE STAERTINE MAY  ************* 18300020
**************** BE REMOVED WHEN THE STAE OPERAND OF     ************** 18400020
**************** ATTACH IS AVAILABLE.                    ************** 18500020
         STAE  STAERTNE,CT,,XCTL=NO ISSUE STAE                          18600020
         LTR   R15,R15             SUCESSFUL ?                          18700020
         BZ    CHKBLK              YES                                  18800020
         LA    R3,2(R0)            NO-LOAD REASON CODE                  18900020
         B     TERM                                                     19000020
*********                          **********                    ****** 19100020
**************** INSERT MAX BLKSIZE IN DCB FOR OPEN      ************** 19200020
CHKBLK   DEVTYPE  DDNAME,AREA,DEVTAB    GET DEVICE CHAR         SA63960 19300052
         LTR   R15,R15             CHK RETURN CODE                      19400020
         BNZ   DEVFAIL             BAD                                  19500020
         MVI   CWCTL,AVTEZERO           CLEAR DEVTYPE FAILED   @SA73145 19520007
*              COMPUTE LARGEST REQUIRED BLOCKSIZE FOR LOGDCB   @SA70175 19550056
*              BASED UPON THE CURRENT CONTENTS OF THE TRACE    @SA70175 19558056
*              TABLE POINTERS, MIN. REQUIREMENTS WILL BE FOR   @SA70175 19566056
*              BUFFER TRACE, 960 BYTES PLUS 16 BYTE PREFIX.    @SA70175 19574056
*              RESULT OF COMPUTATION WILL BE SAVED IN MAXBLK   @SA70175 19582056
*              FOR USE BY OPEN DCB EXIT.                       @SA70175 19590056
         LA    R9,BUFSZ                 SET BUFF TRACE SIZE.   @SA70175 19598056
         L     R2,AVTDISTR              ADDR OF STCB TRACE TBL @SA70175 19606056
         LTR   R2,R2                    TEST IF TABLE EXISTS.  @SA70175 19614056
         BZ    NOSTCB                   NO-BYPASS CALCULATION  @SA70175 19622056
         BAL   R1,COMPSIZE              GO TO CALCULATE SIZE.  @SA70175 19630056
NOSTCB   EQU   *                                               @SA70175 19638056
         L     R2,AVTRACE               ADDR OF IOTR TRACE TBL.@SA70175 19646056
         LTR   R2,R2                    TEST IF TABLE EXISTS.  @SA70175 19654056
         BZ    NOIOTR                   NO - DISREGARD.        @SA70175 19662056
         BAL   R1,COMPSIZE              COMPUTE SIZE,USE LARGE @SA70175 19670056
NOIOTR   EQU   *                                               @SA70175 19678056
         L     R2,AVTREADD              GET INTRO BUFF. TRACE  @OY19405 19678682
         LTR   R2,R2                    WAS IT SPECIFIED       @OY19405 19679282
         BZ    NOINTBUF                 NO BUFF. TRAC ON INTRO @OY19405 19679882
         LM    R14,R15,4(R2)            START ADD. OF TABLES   @OY19405 19680482
         LA    R14,0(R14)               CLEAR HIGH ORDER BYTES @OY19405 19681082
         LA    R15,0(R15)               OF BOTH REGISTERS      @OY19405 19681682
         SR    R15,R14                  GET SIZE OF ONE TABLE  @OY19405 19682282
         CR    R9,R15                   COMPARE SIZES          @OY19405 19682882
         BH    NOINTBUF                 OK, CONTINUE           @OY19405 19683482
         LR    R9,R15                   LARGEST SIZE IN R9     @OY19405 19684082
NOINTBUF EQU   *                                               @OY19405 19684682
         ICM   R2,FIFTEEN,AVTSAVTP      GET 3705 SECONDARY     @ZA04043 19686009
*                                       AVT POINTER            @ZA04043 19686809
         BNM   NOTPIOTR                 BRANCH, IF VTAM NOT    @ZA04043 19687609
*                                       IN SYSTEM              @ZA04043 19688409
         USING IEDNSVTD,R2                                     @YA09722 19689209
         L     R2,SAVTPIUT    GET ADDRESS OF PIU TRACE         @Y17XASZ 19689400
         LTR   R2,R2          IS THERE A TRACE ADDR            @Y17XASZ 19689600
         DROP  R2                                              @YA09722 19691609
         BZ    NOTPIOTR                 BRANCH, IF ZERO        @YA09722 19692409
         BAL   R1,COMPSIZE              GO COMPUTE TABLE SIZE  @YA09722 19694009
NOTPIOTR EQU   *                                               @YA09722 19696009
         STH   R9,MAXBLK                STORE MAX BLOCK SIZE   @YA09722 19698009
         B     OPENLOG                  GO OPEN LOG DATA SET   @YA09722 19700009
COMPSIZE EQU   *                                               @SA70175 19702056
         LM    R14,R15,4(R2)            LOAD LIMITS OF TABLE.  @SA70175 19710056
         LA    R14,0(R14)               CLEAR HIGH ORDER BYTES @SA70175 19718056
         LA    R15,0(R15)               OF BOTH REGISTERS.     @SA70175 19726056
         SR    R15,R14                  COMPUTE TOTAL SIZE     @SA70175 19734056
         SRL   R15,1                    DIVIDE BY 2.           @SA70175 19742056
         LA    R15,16(R15)              + 16 BYTES FOR PREFIX. @SA70175 19750056
         CR    R9,R15                   COMPARE SIZES.         @SA70175 19758056
         BCR   2,R1                     EXIT TO CALLER WITH    @SA70175 19766056
         LR    R9,R15                   LARGEST VALUE IN R9.   @SA70175 19774056
         BR    R1                       RETURN,                @SA70175 19782056
OPENLOG  EQU   *                                               @SA70175 19790056
         OPEN  (LOGDCB,(OUTPUT,REREAD))  OPEN LOG DATA SET       A44876 19800021
         TM    LOGDCB+48,X'10'     WAS OPEN SUCCESFUL ?                 19900020
         BO    TESTDA                   YES - GO TEST TYPE DEV @SA69987 20000056
         LA    R3,5                LOAD REASON CODE                     20100020
         B     TERM                GO ABEND                             20200020
DEVFAIL  LA    R3,4(R0)            LOAD REASON CODE                     20300020
         B     TERM                GO ABEND                             20400020
TESTDA   EQU   *                                               @SA69987 20500056
         TM    UNIT,HEX20               IS COMWRITE DS ON DIRECT        20908021
*                                       ACCESS DEVICE            A44876 20916021
         BZ    INIT                     IF NOT, DONT NEED CCHH   A44876 20924021
         L     R8,LOGDCB+44             LOAD DCB ADDR            A44876 20932021
         L     R9,SIXTEEN(R8)           LOAD # OF EXTENTS        A44876 20940021
         SLL   R9,FOUR                  MULTIPLY # OF EXTENTS BY        20948021
*                                       NUMBER OF BYTES PER EXT  A44876 20956021
         AR    R8,R9                    ADD OFFSET TO DEB BASE          20964021
*                                       POINTER                  A44876 20972021
         MVC   LASTRK,42(R8)            GET END CCHH OF LAST EXT A44876 20980021
INIT     EQU   *                                                        20988021
         OI    AVTCWFL2,CWACTIVE        INDICATE COMWRITE ACTIVE        21000020
         MVI   AVTCWTS1,X'00'      CLEAR TS1 &                          21100020
         MVI   AVTCWTS2,X'00'      TS2                                  21200020
       MVI     AVTCWEC1,X'00'      CLEAR ECB1                           21300020
       MVI     AVTCWEC2,X'00'      CLEAR ECB2                           21400020
         NI    CWCTL,X'00'         CLEAR CONTROL FLAGS                  21500020
********SET UP TWO ITEM WAITLIST AND WAIT FOR EITHER POSTED    ******** 21600020
FW02     TM    CWCTL,X'00'+W1START+W2START IS DECB1 OR DECB2 ACTIVE ?   21700020
         BO    DECWAIT             BOTH ARE                             21800020
         BZ    AVTWAIT             NEITHER IS                           21900020
         TM    CWCTL,X'00'+W1START AM I WHICH ONE                       22000020
         BO    DEC1AVT2            DECB1 IS                             22100020
         B     DEC2AVT1            DECB2 IS                             22200020
DECWAIT  LA    R7,DECB1                                                 22300020
         LA    R8,DECB2                                                 22400020
         B     CWWAIT                                                   22500020
AVTWAIT  LA    R7,AVTCWEC1                                              22600020
         LA    R8,AVTCWEC2                                              22700020
         B     CWWAIT                                                   22800020
DEC1AVT2 LA    R7,AVTCWEC2                                              22900020
         LA    R8,DECB1                                                 23000020
         B     CWWAIT              WAIT ON DECB1 + PARM2                23100020
DEC2AVT1 LA    R7,AVTCWEC1                                              23200020
         LA    R8,DECB2            WAIT ON DECB2 + PARM1                23300020
CWWAIT   TM    AVTBIT1,AVTCLOSN    TCAM CLOSE IN PROCESS ?              23400020
         BO    CLOSEDN             YES CLOSE AND RETURN                 23500020
         STM   R7,R8,WAITLIST      STORE ECB ADDRESS IN LIST            23600020
         OI    WAITEND-4,X'80'     SET END OF LIST                      23700020
         WAIT  1,ECBLIST=WAITLIST  WAIT ON ONE EVENT                    23800020
********SERVICE ELEMENTS THAT WERE POSTED                      ******** 23900020
********AVTCWEC1 MAY HAVE BEEN POSTED BY TCAM CLOSEDOWN        ******** 24000020
         TM    AVTBIT1,AVTCLOSN    TCAM CLOSE IN PROCESS ?              24100020
         BO    CLOSEDN             YES CLOSE LOG AND RETURN             24200020
         TM    DECB1,COMPLETE      PARM1  DONE ?                        24300020
         BZ    FW10                NO                                   24400020
         LA    RINDEX,0            SET INDEX TO AVTCWPM1                24500020
         LA    RDECB,DECB1         SET TO USE DECB1                     24600020
         BAL   RETREG,PARM1CMP     YES                                  24700020
FW10     TM    DECB2,COMPLETE      PARM2 DONE  ?                        24800020
         BZ    FW11                NO                                   24900020
         LA    RINDEX,DISPL        SET INDEX TO AVTCWPM2                25000020
         LA    RDECB,DECB2         SET TO USE DECB2                     25100020
         BAL   RETREG,PARM1CMP     YES                                  25200020
FW11     TM    AVTCWEC1,COMPLETE   PARM1 POSTED  ?                      25300020
         BZ    FW12                NO                                   25400020
         LA    RINDEX,0            SET INDEX TO AVTCWPM1                25500020
         LA    RDECB,DECB1         SET TO USE DECB1                     25600020
         BAL   RETREG,PARM1        YES                                  25700020
FW12     TM    AVTCWEC2,COMPLETE   PARM2  POSTED  ?                     25800020
         BZ    FW02                NO GO PICK UP ECB TO WAIT ON         25900020
         LA    RINDEX,DISPL        SET INDEX TO AVTCWPM2                26000020
         LA    RDECB,DECB2         SET TO USE DECB2                     26100020
         BAL   RETREG,PARM1        YES                                  26200020
         B     FW02                GO PICK UP ECB'S TO WAIT ON          26300020
         EJECT                                                          26400020
********RESET ECB1 & PARMLIST COMPLETE. CHECK PARAMATER        ******** 26500020
********LIST FOR VALIDITY. IF RECORD COUNT IS SPECIFIED,       ******** 26600020
********DECREMENT THE COUNT. ISSUE WRITE IF ALL IS OK          ******** 26700020
PARM1    LA    R2,0                RESET                                26800020
         STC   R2,AVTCWEC1(RINDEX) AVT ECB                              26900020
         L     R10,AVTCWPM1(RINDEX) GET PARMLIST POINTER                27000020
         MVC   PARMSAVE(16),PARMAREA SAVE PARMLIST FOR ABEND            27100020
         ST    R10,WORKA           CHECK                                27200020
         TM    WORKA+3,X'03'       BOUNDRY ALIGN                        27300020
         BNZ   BNDRY1              OF PARM LIST                         27400020
         LA   R1,PARMFLAG          BUILD                                27500020
         ST   R1,QPARM2                  PARM                           27600020
         MVC   PARMCMPL,PARMFLAG              LIST                      27700020
         NI    PARMCMPL,X'FF'-COMPLETE             TO RESET             27800020
         LA   R1,QPARM1            PARMLIST COMPLETE                    27900020
         SVC   102                 DATA MOVE                            28000020
         TM    PARMFLAG,COMWTCLS   REQ FOR CLOSE OF COMWRITE  ?         28100020
         BO    NORMCLOS            YES CLOSE                            28200020
         L     R11,PARMAREA        PICK UP AREA ADDRESS                 28300020
         LH    R12,PARMLEN         PICK UP LENTH                        28400020
         CH    R12,=H'18'          LESS THAN 18                         28500020
         BNL   PARM1CKH            NO                                   28600020
         LH    R12,=H'18'          YES, ADJUST                          28700020
PARM1CKH CH    R12,LOGDCB+BLKSIZE  EXCEED MAX BLKSIZE ?                 28800020
         BH    SIZE                YES                                  28900020
PARM1LOK L     R3,16               LOAD CVT POINTER     ****            29000020
         LR    R2,R11              LOAD DATA ADDRESS    ****            29100020
         AR    R2,R12              ADD LENGTH           ****            29200020
         CL    R2,BOXTOP(R3)       CHECK TOP OF CORE                    29300020
         BH    CORE1               EXCEDS CORE          ****            29400020
         TM    PARMFLAG,NOPREFIX        DATA PREFIX SPECIFIED           29500020
         BO    WRITETST                 GO TEST FOR DISK WRAP    A44876 29600021
         MVC   0(4,R11),PARMID          ELSE, MOVE CALLERS IT TO BUFFER 29700020
         XC    4(8,R11),4(R11)          CLEAR TIME STAMP FIELD          29800020
STAMP    TIME                                                           30500020
         STM   0,1,4(R11)               TIME STAMP BUFFER               30600020
WRITETST TM    UNIT,HEX20               IS DATA SET ON DA DEV?   A44876 30707021
         BZ    WRITEPM1                 IF NOT, BRANCH TO WRITE  A44876 30714021
         CLC   RCDADDR,LASTRK           COMPARE CCHH OF LAST RCD        30721021
*                                       WRITTEN TO CCHH OF LAST         30728021
*                                       TRACK ON COMWRITE        A44876 30735021
         BL    WRITEPM1                 BRANCH NOT LAST TRACK  @OZ32703 30742082
POINT1   TM    CWCTL,W1START            TEST IF DECB1 ACTIVE.  @SA69988 30761056
         BZ    POINT2                   NO - BYPASS CHECK.     @SA69988 30764056
         CHECK DECB1                    ENSURE COMPLETION.     @SA69988 30767056
POINT2   TM    CWCTL,W2START            TEST IF DECB2 ACTIVE.  @SA69988 30770056
         BZ    POINT                    NO - BYPASS CHECK.     @SA69988 30773056
         CHECK DECB2                    ENSURE COMPLETION.     @SA69988 30776056
         OC    EOFLOC,EOFLOC            TEST IF EOF RECORDED.  @YA09314 30777009
         BNZ   POINT                    YES - BYPASS NOTE.     @YA09314 30778009
         NOTE  LOGDCB                   RECORD EOF POINT FLD.  @YA09314 30779009
         ST    R1,EOFLOC                SAVE FOR LATER POINT.  @YA09314 30780009
POINT    POINT LOGDCB,TTRSTART          REPOSITION DATA SET      A44876 30784021
*              THE FOLLOWING BRANCH CAN BE ZAPPED TO A NOP IN  @SA69988 30784556
*              ORDER TO CAUSE A LINE OF ASTERISKS TO PRINT ON  @SA69988 30785056
*              THE SYSTEM CONSOLE WHEN COMWRITE DATA SET       @SA69988 30785556
*              WRAPS, THIS WILL ONLY BE EFFECTIVE WHEN COMWRITE@SA69988 30786056
*              IS ON DASD DEVICE. EMBEDDED IN THIS LINE WILL   @SA69988 30786556
*              BE A TIME STAMP INDICATING THE TIME OF WRAP.    @SA69988 30787056
*              THIS FEATURE SHOULD ONLY BE USED TO DETERMINE   @SA69988 30787556
*              THE CORRECT SIZE OF THE COMWRITE DATA-SET.      @SA69988 30788056
         B     WRITEPM1                 BYPASS WTO FOR WRAP    @SA69988 30788556
         SPACE 2                                               @SA69988 30789056
         MVC   TMSTMP,4(R11)            PICK UP TIME FROM LAST @SA69988 30789556
         OI    TMSTMP+3,X'0F'           REMOVE SIGN.           @SA69988 30790056
         UNPK  TMSTMPD,TMSTMP           CONVERT TO ZONED DEC.  @SA69988 30790556
         MVC   WTMSTMP,TMEDIT           MOVE IN EDIT FLD.      @SA69988 30791056
         TR    WTMSTMP,TMSTMPD          MOVE CORRESPOND'G FLDS @SA69988 30791556
         WTO   '********************** COMWRITE DS WRAP ****************30792056
               ************',ROUTCDE=(2),DESC=4                @SA69988 30792556
ETMSG    EQU   *                                               @SA69988 30793056
         ORG   ETMSG-20                                        @SA69988 30793556
WTMSTMP  DS    CL8                                             @SA69988 30794056
         ORG   ETMSG                                           @SA69988 30794556
         B     WRITEPM1                                        @SA69988 30795056
TMSTMP   DC    CL4' '                                          @SA69988 30795556
TMSTMPD  DC    CL7' '                                          @SA69988 30796056
         DC    C':'                                            @SA69988 30796556
TMEDIT   DC    AL1(0,1,7,2,3,7,4,5)     MOVE CORRESPOND'G MASK @SA69988 30797056
WRITEPM1 WRITE (RDECB),SF,,(R11),(R12),MF=E                             30800020
         LTR   RINDEX,RINDEX       DECB1 OR DECB2 ?                     30900020
         BNZ   ACTIVE2             DECB2                                31000020
         OI    CWCTL,W1START       SET DECB1 ACTIVE                     31100020
         B     CHKCNT                                                   31200020
ACTIVE2  OI    CWCTL,W2START       SET DECB2 ACTIVE                     31300020
CHKCNT   TM    PARMFLAG,CTOPTION   RECORD COUNT SPECIFIED ? $***        31400020
       BZ      LEAVE               NO                                   31500020
         TM    CWCOUNT(RDECB),CWCOUNT1  COUNT PREVIOUSLY SPECIFIED ?    31600020
         BO    WRITE1A                  YES  BYPASS SETTING             31700020
         MVC   CWRCT1(4,RDECB),PARMCT   NO  SET UP CW COUNT             31800020
         OI    CWCOUNT(RDECB),CWCOUNT1  SET  COUNT SPECIFIED            31900020
WRITE1A  L     R2,CWRCT1(RDECB)    GET CURRENT COUNT                    32000020
         BCT   R2,WRITE1B          SUBTRACT ONE AND GO TO WRITE         32100020
         B     NORMCLOS            COUNT = ZERO CLOSE                   32200020
WRITE1B  ST    R2,CWRCT1(RDECB)    STORE DECREMENTED COUNT              32300020
LEAVE    BR    RETREG              RETURN TO MAINLINE CODE              32400020
CORE1    LA    R12,L'HICORE        LOAD ERROR MSG LENGTH   *****        32500020
         MVC   HICORE+8(4),PARMID  PUT ID IN ERROR MSG                  32600020
         LA    R11,HICORE          LOAD ERROR MEG ADDRESS  *****        32700020
         B     MUST                                                     32800020
BNDRY1  LA     R12,L'ERRMSG       LOAD MSG SIZE                         32900020
         MVC   ERRMSG+8(4),PARMID  PUT ID IN ERROR MSG                  33000020
        LA     R11,ERRMSG         LOAD MSG LOCATION        *****        33100020
         B     MUST                                                     33200020
SIZE     LA    R12,L'ERRSIZE       LOAD ERRMSG SIZE                     33300020
         MVC   ERRSIZE+8(4),USERID MOVE IN USER ID                      33400020
         LA    R11,ERRSIZE         LOAD ERRMSG ADDR                     33500020
MUST     TM    PARMFLAG,REQOUT     IS DATA OUTPUT REQUIRED ?            33600020
         BZ    WRITEPM1            NO                                   33700020
         B     CLOSEDNA                                                 33800020
         EJECT                                                          33900020
********CHECK DECB1.   IF NORMAL COMPLETITION, SET             ******** 34000020
********PARMLIST COMPLETE & RESET DECBECB, DECB ACTIVE &       ******** 34100020
********                THEN RETURN. FOR ABNORMAL COMPLETITION ******** 34200020
********CAUSE OUTPUT WRAP OR VOL SWITCH IF END OF VOL, OR      ******** 34300020
********CLOSEDOWN IF PERM I/O ERROR                            ******** 34400020
PARM1CMP  L    R10,AVTCWPM1(RINDEX) LOAD PARMLIST POINTER               34500020
         MVC   PARMSAVE(16),PARMAREA SAVE PARMLIST FOR ABEND            34600020
         LTR   RINDEX,RINDEX       DECB1 OR DECB2 ?                     34700020
         BNZ   PARM2CMP            DECB2                                34800020
         NI    CWCTL,X'FF'-W1START RESET DECB1 ACTIVE                   34900020
         B     CHKIO                                                    35000020
PARM2CMP NI    CWCTL,X'FF'-W2START RESET DECB2 ACTIVE                   35100020
CHKIO    TM    0(RDECB),X'7F'           TEST FOR NORMAL COMP.  @SA70181 35200056
         BO    PARM1OKA            YES                                  35300020
CHECK1   CHECK (RDECB)                                                  36300020
         B     PARM1OKA            GO RESET FLAGS                       36400020
********       RESET ERROR FLAGS ON TCLOSE ONLY TO ALLOW  ************* 36500020
*********               OUTPUT TO RESUME                  ************* 36600020
PARM1OK  NI    LOGDCB+44,X'3F'     RESET DCB                            36700020
         NI    LOGDCB+61,X'EF'     ERROR FLAGS                          36800020
         L     R1,DECBIOB(RDECB)   GET IOB ADDRESS                      36900020
         LTR   R1,R1               ZERO ?                               37000020
         BZ    PARM1OKA                                                 37100020
         NI    0(R1),X'C0'         RESET IOB                            37200020
         NI    1(R1),X'00'         ERROR FLAGS                          37300020
**************************************************************          37400020
PARM1OKA L     R10,AVTCWPM1(RINDEX) GET PARM LIST ADDRESS               37500020
         LA   R1,PARMFLAG          BUILD                                37600020
         ST   R1,QPARM2                  PARM                           37700020
         MVC   PARMCMPL,PARMFLAG              LIST                      37800020
         OI    PARMCMPL,COMPLETE                   TO SET               37900020
         LA   R1,QPARM1            PARMLIST COMPLETE                    38000020
         SVC   102                 DATA MOVE                            38100020
         MVI   0(RDECB),X'00'      RESET  DECB ECB                      38200020
         LTR   RINDEX,RINDEX       DECB1 OR DECB2                       38300020
         BNZ   PARM2OK             DECB2                                38400020
         NI    CWCTL,X'FF'-W1START RESET DECB1 ACTIVE FLAG              38500020
         MVI   AVTCWTS1,X'00'      RESET TS1                            38600020
         B     PMCMPRET                                                 38700020
PARM2OK  NI    CWCTL,X'FF'-W2START RESET DECB2 ACTIVE FLAG              38800020
         MVI   AVTCWTS2,X'00'      RESET TS2                            38900020
PMCMPRET BR    RETREG              RETURN TO MAINLINE                   39000020
         EJECT                                                          39100020
********QUIESCE BOTH DECB,S & CLOSE THE OUTPUT DCB. IF CLOSE   ******** 39200020
********DOWN WAS REQUESTED EXIT. OTHERWISE REOPEN DCB.         ******** 39300020
CLOSEDN  WTO   'IED112I  TCAM REQUESTED COMWRITE CLOSEDOWN.',          C39360020
               ROUTCDE=2,DESC=7                                         39420020
         SR    R3,R3               SET NO ABEND                         39500020
         B     SETCLOSE                                                 39600020
CLOSEDNA LA    R3,3(R0)            LOAD REASON CODE                     39700020
         B     SETCLOSE                                                 39800020
NORMCLOS SR    R3,R3               SET NO ABEND                         39900020
SETCLOSE OI    AVTCWFL2,CLSDOWN    SET CLOSEDOWN REQUEST                40000020
CLOSE    TM    CWCTL,W1START       DECB1 ACTIVE ?                       40100020
         BZ    CLOSEDN1            NO CHECK DECB2                       40200020
         WAIT  ECB=DECB1           YES WAIT                             40300020
         LA    RINDEX,0            SET INDEX TO AVTCWPM1                40400020
         LA    RDECB,DECB1         SET TO USE DECB1                     40500020
         BAL   RETREG,PARM1OK      GO RESET FLGS AND RETURN             40600020
CLOSEDN1 TM    CWCTL,W2START       DECB2 ACTIVE                         40700020
         BZ    CLOSEDN2            NO CLOSE                             40800020
         WAIT  ECB=DECB2           YES WAIT                             40900020
         LA    RINDEX,DISPL        SET INDEX TO AVTCWPM2                41000020
         LA    RDECB,DECB2         SET TO USE DECB2                     41100020
         BAL   RETREG,PARM1OK      GO RESET FLGS AND RETURN             41200020
CLOSEDN2 OC    EOFLOC,EOFLOC            TEST FOR PREV. WRAP.   @SA69989 41400056
         BZ    CLOSEDN3                 NO-BYPASS POINT TO END @SA69989 41420056
         TM    UNIT,HEX20               TEST IF TAPE DEV.      @SA69989 41440056
         BNO   CLOSEDN3                 YES - BYPASS POINT     @SA69989 41460056
         POINT LOGDCB,EOFLOC            POINT TO END OF DATA   @SA69989 41480056
         WRITE DECB1,SF,,LASTREC,L'LASTREC,MF=E                @SA69989 41500056
         CHECK DECB1                    ENSURE COMPLETION.     @SA69989 41520056
CLOSEDN3 CLOSE (LOGDCB)                 CLOSE TRACE DATA SET.  @SA69989 41540056
         LTR   R3,R3                                                    41600020
         BZ    QFWEXIT                  ZERO = NORMAL EXIT.    @SA70176 41700056
         CH    R3,=H'16'                IS IT STAE RET CODE.   @SA70176 41710056
         BNE   TERM                     NO - GO TO ABEND.      @SA70176 41720056
         NI    AVTCWFL2,X'FF'-CWACTIVE  RESET ACTIVE BIT.      @SA70176 41730056
         L     R13,CWSAVE+4             LOAD CALLERS@SAVE ADR. @SA70176 41740056
         LM    R14,R12,12(R13)          RELOAD ENTRY REGS.     @SA70176 41750056
         BR    R15                      RE-ENTER IEDQFW.       @SA70176 41760056
QFWEXIT  EQU   *                        NORMAL EXIT POINT.     @SA70176 41770056
         MVI   AVTCWEC1,BUSY       SET ECB BUSY                         41800020
         MVI   AVTCWEC2,BUSY                                            41900020
        MVI    AVTCWTS1,X'FF'      SET TS1 &                            42000020
         MVI   AVTCWTS2,X'FF'      TS2 BUSY                             42100020
         NI    AVTCWFL2,X'FF'-CWACTIVE RESET COMWRITE ACTIVE            42200020
         MVI   AVTAFE10,X'00'           INDICATE                        42300020
         MVI   AVTAFE20,X'00'           SERVICE AIDS NO                 42400020
         MVI   AVTAFE30,X'00'           LONGER ACTIVE                   42500020
         L    R13,CWSAVE+4                                              42600020
         LM    14,12,12(13)        RESTORE REGS                         42700020
         LA    R15,0               SET RC=0                             42800020
         BR    R14                 RETURN                               42900020
         SPACE 4                                               @SA70176 42908056
STAECLOS EQU   *                                               @SA70176 42916056
         BALR  R15,0                    SET TEMP BASE REG.     @SA70176 42924056
         USING *,R15                                           @SA70176 42932056
         ENTRY STAECLOS                                        @SA70176 42940056
         LM    R13,R5,STAESAVE          RELOAD QFW REGS.       @SA70176 42948056
         DROP  R15                                             @SA70176 42956056
         SR    R3,R3                    DEVTYPE FAILED IND.    @SA73145 42958007
         TM    CWCTL,DEVTFAIL           DID DEVTYPE FAIL       @SA73145 42960007
         BO    SETCLOSE                 BR YES, TERMINATE      @SA73145 42962007
         TM    LOGDCB+48,X'10'          WAS OPEN SUCCESSFUL?   @YA11009 42962609
         BNO   SETCLOSE                 NO, OPEN NOT SUCCESSFUL@YA11009 42963209
         LA    R3,16                    SET EXIT CODE          @SA70176 42964056
         B     SETCLOSE                 GO TO CLOSE DOWN RTN   @SA70176 42972056
STAESAVE DC    9F'0'                    REGS REQUIRED FOR      @SA70176 42980056
*                                       RECOVERY FROM ABEND.   @SA70176 42988056
         EJECT                                                          43000020
***************************************************************@SA69987 43100056
*         SYNAD EXIT, ISSUE MSG IED113I, ABEND 044-1           @SA69987 43150056
*         AFTER 15 ERRORS.                                     @SA69987 43200056
***************************************************************@SA69987 43250056
SYNAD    STM   R0,R15,SYNADSV           SAVE ERR EXIT REGS.    @SA69987 43300056
         LA    R13,SYNADSV1             SET SAVE AREA REG.     @SA69987 43350056
       SYNADAF ACSMETH=BSAM             OBTAIN ERROR STATS.    @SA69987 43400056
         MVC   ERRMSG0C,50(R1)          MOVE STATS TO MSG      @SA69987 43450056
         L     R7,DECBIOB(R8)           GET IOB ADDR.          @SA69987 43500056
         MVC   WORK(2),STATUS(R7)       MOVE STATUS FROM IOB   @SA69987 43550056
         MVC   WORK+2(2),SENSE(R7)      MOVE SENSE FROM IOB    @SA69987 43600056
         UNPK  ERRM1ST+1(9),WORK(5)     UNPACK STATUS.         @SA69987 43650056
         TR    ERRM1ST+1(8),TABLE       CONVERT TO EBCDIC.     @SA69987 43700056
         MVC   ERRM1ST,ERRM1ST+1        OFFSET FIELD.          @SA69987 43750056
         MVI   ERRM1SN-1,C','           INSERT COMMA.          @SA69987 43800056
         MVI   ERRM1SN+4,C' '           ERASE TRASH.           @SA69987 43850056
         MVC   ERRM1USR,USERID          INSERT TR BLK ID.      @SA69987 43900056
         WTO   MF=(E,ERRMSG0)           OUTPUT FIRST HALF MSG  @SA69987 43950056
         WTO   MF=(E,ERRMSG1)           OUTPUT 2ND HALF OF MSG @SA69987 44000056
       SYNADRLS                                                @SA69987 44050056
         LH    R1,SYNADCT               GET COUNT OF PREC ERRS @SA69987 44100056
         BCT   R1,SYNADXT               DECREMENT COUNT.       @SA69987 44150056
         LA    R3,1                     SET ABEND CODE.        @SA69987 44200056
         B     TERM                     EXIT ON 15TH ERR.      @SA69987 44250056
SYNADXT  STH   R1,SYNADCT               STORE UPDATED COUNT FLD@SA69987 44300056
         LM    R0,R15,SYNADSV           RESTORE ERR REGS.      @SA69987 44350056
         BR    R14                      RETURN TO EOV.         @SA69987 44400056
**************** ENTRY TO CLEANUP & ABEND ***************************** 44600020
TERM     MVI   AVTCWEC1,BUSY       SET ECB BUSY                         44700020
         MVI   AVTCWEC2,BUSY                                            44800020
        MVI    AVTCWTS1,X'FF'      SET TS1 &                            44900020
         MVI   AVTCWTS2,X'FF'      TS2 BUSY                             45000020
         NI    AVTCWFL2,X'FF'-CWACTIVE RESET COMWRITE ACTIVE            45100020
         MVI   AVTAFE10,X'00'           INDICATE                        45200020
         MVI   AVTAFE20,X'00'           SERVICE AIDS NO                 45300020
         MVI   AVTAFE30,X'00'           LONGER ACTIVE                   45400020
         LA    R7,PARMSAVE         LOAD ADDR PARMLIST FOR ABEND         45500020
         L     R1,S044             SET  ABEND CODE                      45600020
         SVC   13                  ABEND                                45700020
         SPACE 4                                               @SA70175 45707056
*              DCB OPEN EXIT ROUTINE, SETS COMWRITE BLKSIZE TO @SA70175 45714056
*              LARGEST REQUIRED AS COMPUTED PREVIOUSLY OR      @SA70175 45721056
*              ALLOWS INSERTION OF BLKSIZE FROM JCL/LABEL.     @SA70175 45728056
DCBXITL  DS    0F                                              @SA70175 45735056
         DC    AL1(133),AL3(DCBXIT)                            @SA70175 45742056
         USING *,R15                                           @SA70175 45749056
DCBXIT   EQU   *                                               @SA70175 45756056
         CLC   LOGDCB+62(2),MAXBLK      DCB BUFSIZE OR MAXIMUM XA125235 45763000
*                                       CALCULATED SIZE LARGER XA125235 45766000
         BCR   10,R14                   BRANCH DCB BUFSIZE     XA125235 45770000
*                                       EQUAL OR HIGH          XA125235 45773000
         MVC   LOGDCB+62(2),MAXBLK      NO - INSERT MAX SIZE.  @SA70175 45777056
         BR    R14                      RETURN TO OPEN ROUTINE @SA70175 45784056
         EJECT                                                          45800020
**************** CONSTANTS FOR COMWRITE                  ************** 45900020
ERRMSG0  WTO   'IED113I I/O ERROR - JJJJJJJJ,SSSSSSSS,UUU,TT,DDDDDDDD,OX46000056
               OOOOO,EEEEEEEEEEEEEEE,BBBBCCCCHHHHRR,AAAAAA',   @SA69987X46010056
               MF=L,DESC=4,ROUTCDE=(2,8,11)                    @SA69987 46020056
EMSG0    EQU   *                                               @SA69987 46030056
         ORG   EMSG0-82                                        @SA69987 46040056
ERRMSG0C DS    0CL78                    MSG TEXT AREA.         @SA69987 46050056
         ORG   EMSG0                                           @SA69987 46060056
ERRMSG1  WTO   'IED113I - SSSS,SSSS - USER COMWRITE SUBTASK RECORD BYPAX46070056
               SSED.',MF=L,DESC=4,ROUTCDE=(2,8,11)             @SA69987 46080056
EMSG1    EQU   *                                               @SA69987 46090056
         ORG   EMSG1-54                                        @SA69987 46100056
ERRM1ST  DS    CL4                      STATUS FIELD.          @SA69987 46110056
         DS    CL1                                             @SA69987 46120056
ERRM1SN  DS    CL4                      SENSE FLD.             @SA69987 46130056
         DS    CL3                                             @SA69987 46140056
ERRM1USR DS    CL4                      TR BLK ID FLD.         @SA69987 46150056
         ORG   EMSG1                                           @SA69987 46160056
S044     DC    X'80044000'                                              46200020
WAITLIST EQU   *                                                        46300020
         DC    2F'0'                                                    46400020
WAITEND  EQU   *                                                        46500020
CWSAVE   DC    18F'0'                                                   46600020
PARMSAVE DC    3F'0'               4 WORD SAVE AREA FOR PARMLIST        46700020
SYNADSV  DC    16F'0'                   SAVE AREA FOR SYNAD REGSSA69987 46730056
SYNADSV1 DC    18F'0'                   SYNAD ALT AREA.        @SA69987 46760056
USERID   DC    F'0'                                                     46800020
AREA     DC    5F'0'                     DEVTYPE AREA           SA63960 47200052
AREA1    DC    H'0'                     SAVE LAST REC OVRHD     SA63960 47250052
SYNADCT  DC    H'15'                    MAX ERROR COUNT.       @SA69987 47270056
UNIT     EQU   AREA+2                   DEVICE CLASS FROM THE           47300021
*                                       DEVTYP MACRO             A44876 47400021
MAXBLK   EQU   AREA+6                   MAXIMUM BLOCKSIZE       SA63960 47600052
DDNAME   DC    CL8'COMWRITE '      REQUIRED DD NAME                     47700020
         ORG   *-X'F0'                                                  47800020
TABLE    DS    0F                                                       47900020
         ORG   *+X'F0'                                                  48000020
         DC    C'0123456789ABCDEF'                                      48100020
********       PARMLIST FOR QCTRL SVC DATA MOVE                ******** 48200020
         DS    0F                                                       48300020
QPARM1   DC    X'08'                                                    48400020
         DC    AL3(PARMCMPL)                                            48500020
QPARM2   DC    F'0'                                                     48600020
QPARM3   DC    X'80'                                                    48700020
         DC    AL3(PARMLNG)                                             48800020
*********                          **********                    ****** 48900020
WORKA    DC    F'0'                WORK AREA FOR CHK BNDRY ALIGN        49000020
WORK     DC    F'0'                                                     49100020
         DC    X'0F'               XTRA BYTE IN WORK FOR UNPK           49200020
PARMCMPL DC    X'00'                                                    49300020
PARMLNG  DC    X'0001'                                                  49400020
HICORE   DC    C'IED115I USER DATA AREA EXCEEDS CORE'                   49500020
ERRMSG   DC    C'IED116I USER PARMLIST NOT ON FULLWORD BOUNDARY'        49600020
ERRSIZE  DC    C'IED117I USER BLKSIZE EXCEEDS DEVICE SPECS.'            49700020
PERIOD   DC    C'.'                                                     49800020
EOFLOC   DC    F'0'                    @SAVE AREA FOR EOF NOTE.@SA69989 49806056
LASTREC  DC    C'*** PADDING RECORD ***' DUMMY LAST RECORD.    @SA69989 49812056
LASTRK   DC    F'0'                     SAVE AREA FOR DISK CCHH  A44876 49820021
EOTSW    DC    X'00'                    END OF TAPE SWITCH       A44876 49840021
TTRSTART DC    X'00000001'              START TTR OF DSK EXTENT@YA07124 49860081
         EJECT                                                          49900020
LOGDCB   DCB   DSORG=PS,MACRF=WP,DEVD=DA,DDNAME=COMWRITE,NCP=2,        X50000021
               EXLST=DCBXITL,RECFM=U,SYNAD=SYNAD               @SA70175 50100056
*                                                                A44876 50150021
         EJECT                                                          50200020
         SPACE 5                                                 S21903 50220052
         LTORG                                                          50240052
         EJECT                                                   S21903 50260052
*************THE FOLLOWING STMNTS MUST BE KEPT IN SEQUENCE************  50300020
         WRITE DECB1,SF,LOGDCB,DECB1,'S',MF=L                   #1      50400020
         DC    F'0'                RECORD COUNT FIELD,DECB1     #2      50500020
         DC    X'00'               RECORD COUNT INDICATOR       #3      50600020
CWCOUNT1 EQU   X'80'               COUNT CONTROL SPECIFIED      #4      50700020
CWCTL    DC    X'01'                    DECB1 & B2 STATUS BYTE @SA73145 50800007
W1START  EQU   X'80'               DECB1 ACTIVE                 #6      50900020
W2START  EQU   X'40'               DECB2 ACTIVE                 #7      51000020
         WRITE DECB2,SF,LOGDCB,DECB2,'S',MF=L                   #8      51100020
         DC    F'0'                RECORD COUNT FIELD,DECB2     #9      51200020
         DC    X'00'               RECORD COUNT INDICATOR       #10     51300020
**************************************************                      51500020
CWCOUNT  EQU   X'18'               DISPL FROM DECB TO COUNTID           51600020
CWRCT1   EQU   X'14'               DISPL FROM DECB TO RECCNT            51700020
         EJECT                                                          51800020
PARMLIST DSECT                                                          51900020
PARMAREA DS    F                   POINTER TO DATA AREA                 52000020
PARMTS   DS    XL1                 USER TEST & SET BYTE                 52100020
PARMFLAG DS    XL1                                                      52200020
CTOPTION EQU   X'80'               RECORD COUNT SPECIFIED               52300020
COMPLETE EQU   X'40'               PARMLIST COMPLETE-LIST IS FREE       52400020
COMWTCLS EQU   X'20'               REQUEST IMMEDIATE TERMINATION        52500020
REQOUT   EQU   X'10'               DATA OUTPUT IS REQUIRED              52600020
NOPREFIX EQU   X'08'                    PARMFLAG INDIC NO DATA PREFIX   52700020
PARMLEN  DS    H                   LENGTH OF DATA AREA                  52800020
PARMCT   DS    F                   RECORD COUNT WHEN CTOPTION SPECIFIED 52900020
PARMID   DS    F'0'                EBCIDIC PARMLIST ID SUP. BY USER     53000020
RCDADDR  EQU   LOGDCB+8                 CCHH OF LAST RCD WRITTEN        53020021
*                                       TO DISK                  A44876 53040021
BYTEBAL  EQU   LOGDCB+18                BYTE BALANCE ON TRACK    A44876 53060021
         EJECT                                                          53100020
**************** STAE EXIT RTNE. MAN BE REMOVED WHEN     ************** 53200020
**************** STAE OPERAND OF ATTACH IS AVAILABLE     ************** 53300020
STAERTNE CSECT                                                          53400020
         USING STAERTNE,R15        PICK UP NEW BASE                     53500020
         STM   R1,R14,WTOSAVE1          SAVE SYSTEM REGS.      @SA70176 53600056
         LA    R13,WTOSAVE                                              53700020
         C     R0,TWELVE           WAS WORK AREA PASSED                 53800020
         BNE   YES                 YES                                  53900020
         LR    R2,R0               NO-GET CC FROM REG 0                 54000020
         B     YES+4                                                    54100020
YES      L     R2,CC(R1)           GET CC FROM WORK AREA                54200020
         LA    R2,0(R2)            CLEAR HI ORD BYTE                    54300020
         ST    R2,WTOWORK1         PUT IN WORK AREA                     54400020
         UNPK  WTOWORK2(7),WTOWORK1+1(4) UNPACK                         54500020
         NI    WTOWORK2,X'0F'      RESET                                54600020
         MVZ   WTOWORK2+1(5),WTOWORK2 ZONE BITS                         54700020
         TR    WTOWORK2(6),WTOTABLE & XLATE                             54800020
         MVC   WTO+18(3),WTOWORK2  MOVE INTO MESSAGE                    54900020
WTO      WTO   'IED114I  S000 ABEND,COMWRITE CLOSING.',                C54960020
               ROUTCDE=(2,11),DESC=7                                    55020020
         BALR  R15,0                    SET NEW BASE AFTER WTO.@SA70176 55100056
         USING *,R15                                           @SA70176 55160056
         LM    R1,R0,WTOSAVE1           RESTORE REGS AND SET   @SA70176 55220056
*                                     RETURN CODE AND RETRY AD @SA70176 55280056
         DROP  R15                                             @SA70176 55340056
         BR    R14                                                      55400020
WTOTABLE DS    0X                  XLATE TABLE                          55500020
         DC    C'0123456789ABCDEF'                                      55600020
WTOWORK2 DC    7X'00'              UNPK WORK 2                          55700020
WTOSAVE  DC    18F'0'              REG SAVE AREA                        55800020
WTOSAVE1 DC    14F'0'                   SYSTEM REG SAVE AREA.  @SA70176 55830056
         DC    A(4),A(STAECLOS)         RC + RETRY ADDRESS.    @SA70176 55860056
WTOWORK1 DC    F'0'                UNPK WORK AREA                       55900020
         DC    X'00'               PADDING                              56000020
TWELVE   DC    F'12'                                                    56100020
         EJECT                                                          56300020
         TAVTD                                                          56500020
         END                                                            56600020
