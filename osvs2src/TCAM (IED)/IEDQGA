DQGA    TITLE '''IEDQGA''   BUFFER MANAGEMENT'                          00040005
IEDQGA   CSECT                                                          00080005
*A000000-999999                                                @X31X8P0 00100000
         SPACE 3                                                        00120005
*  CHANGE ACTIVITY AS FOLLOWS                                           00160005
******************** MICROFICHE FLAGS *********************** SUPT CODE 00200005
*A145080-145880,635880-639260,722030-722750,789000,809500        S99228 00200105
*C599400-599560                                                  S99228 00200205
*D599200,785600                                                  S99228 00200305
*C318000-319000,322000                                           S22029 00200405
*D654000-657000                                                  S22029 00200505
*C185000,319000,587000-589000                                    S21101 00200605
*D789000                                                         S21101 00200705
*A593000                                                         A42379 00200805
*C185000                                                         A42379 00200905
*A594000                                                         A47126 00201005
*C185000,599100                                                  A47126 00201105
*D567500-570000                                                  A47126 00201205
*D494000-495000                                                  S22026 00201305
*C149000,150000                                                  S22025 00201405
*A250000                                                         S22025 00201505
*D516000-518000,521000-527000                                    S22025 00201605
*A194800-195600,226300-226600,408500,787500                      S22026 00201705
*C194000-194400                                                  S22026 00201805
*A490200-490800,552100-552800,559500,562500,576300-576600        S22026 00201905
*A614500,617500                                                  S22025 00202005
*A785100-785800                                                  S22026 00202105
*C012000,318000                                                  S22025 00202205
*A096500                                                         S22025 00202305
*A675000                                                        SA61743 00202405
*A192000,248000,257000,308000,492000,566400,787000               S22024 00202605
*C007000,182000,199300,211000,229000-231000,363000-366000,378000 S22024 00202705
*C384000-385000,388000-390000,409000,425000,432000-433000,       S22024 00202805
*C490000,492000,500000                                           S22024 00202905
*A085100-085700,151180-151660,151720-151840,151900,572200-572600,X01004 00203005
*A574300-574600,575150,575700,576500,578100-578900,580500,581500,X01004 00203105
*A582100-582360,582460-582600,585100-585600,587020-587420,       X01004 00203205
*A587520-587820,588030-588360,591500,597020-597040,597080-597100,X01004 00203305
*A706070-706910                                                  X01004 00203405
*C302000,375000-376000,499000-500000,502000,576000,577000,578000,X01004 00203505
*C580000,581000,587500,588000,601000,605000,706000               X01004 00203605
*D501000,582000,588500,602000-603000,787000                      X01004 00203705
*A039300-039600,096700,145500-145700,151060-151120,151690,151870,Y01004 00203805
*A174090-174900,192100-192600,402100-402600,405500,442500,       Y01004 00203905
*A478300-478600,484600,485200,490700,529700,530400,531100,534600,Y01004 00204005
*A535200-535800,536400,566600-567000,575050-575120,575200-575650,Y01004 00204105
*A575750-575870,577300-577600,579500,580520-580600,582430,       Y01004 00204205
*A582620-582900,                                                 Y01004 00204305
*A584300-584600,593300,593600,594800,597060,597130-597420,       Y01004 00204405
*A668100-668900,672500,764500,777120-777880,778020-778980,       Y01004 00204505
*A779040-779940,780060-781980,782080,782220-782340,782460-782580,Y01004 00204605
*A782640-782760,782820-783060,783120-783360,783420-783600,803500,Y01004 00204705
*A804500,805500,806500,807500,808500                             Y01004 00204805
*C019000,085500,096500,192000,296000-297000,377000,402000,405000,Y01004 00204905
*C439000,442000,469000,478000,482000,484000,490600,529000,534000,Y01004 00205005
*C537000,539000-540000,566400,584000,587000,587640,587680,591000,Y01004 00205105
*C593000,594600,597000,598200,668000,780000,782400,802000        Y01004 00205205
*D182000,298000,395000,440000,456000-461000,485000,530000,531000,Y01004 00205305
*D535000,536000,576300-576600,579000,593500,745000,763000,768000,Y01004 00205405
*D778000,779000,782000,782200,782600,782800,783100,783400,       Y01004 00205505
*D783700-785800                                                  Y01004 00205605
*C636760-636840                                                  Y01948 00205705
*C575120,A575125-575135,C575540-575580,A588480-589920,           Y05331 00205805
*C777200,A777210-777230,C777720,A777730-777740,D780090           Y05331 00205905
*A780081-780097                                                         00206005
*A184000,575080-575530,597240-597560,777120-777720,780340-781640,Y02027 00206106
*A794100-794200                                                  Y02027 00206206
*C085100-085300,591000-591500,594600-594800,780150,780250        Y02027 00206306
*D174060-174840,575080-575640,582240-582320,582720-582880,       Y02027 00206406
*D597240-597510,777120-777840,778440-778480,778680-778720,       Y02027 00206506
*D780340-780460                                                  Y02027 00206606
*                                                                       00206706
*C583000                                                        OX02203 00216054
*A144800,575240                                                 OY00507 00216105
*D575260                                                        OY00507 00216205
* A579300,599592                                                OX03966 00216305
* C599480                                                       OX03966 00216405
*C636360,636440                                                 OX05279 00216505
*A000800,192060                                                @Z30X8PM 00216600
*C007600                                                       @Z30X8PM 00256600
*C598740,A599040                                               @ZA00219 00286561
*D257650                                                       @Z30X8PM 00296600
*C588080-588160                                                @XA07478 00316561
*C595000,600300,780290                                         @YA08099 00320509
*A330000,363000                                                @YA07705 00324509
*A151000,579300                                                @YA08774 00328509
*D722030,722720                                                @YA08773 00332509
*D585300,585600-585900                                         @ZA04004 00336509
*A493000,C499000,C593000,A575660,D003187,D600220-600280        @YA10024 00340509
*C566400-566550,C574000-574600,A783610,A777960                 @YA10024 00344509
*C494000                                                       @YA10687 00348509
*C709000                                                       @XA11334 00348681
*A585400                                                       @OX11963 00348791
*D145940,599568-599576                                         @YA12276 00348891
*C595000,599506-599512,600300,780290                           @YA12276 00348991
*C702000,C709000                                               @OX12526 00349091
*A600600                                                       @OS77863 00349191
* A019000,113000,214000,305500,307000,364000,                  @G36XRPV 00350100
* A789000,808000                                               @G36XRPV 00351100
* C007600,214000,257000                                        @G36XRPV 00352100
* D365000                                                      @G36XRPV 00353100
*A256000,272000,274000,277000,282000,283600                    @OY19124 00353611
*                                                                       00354100
*********************************************************************** 00360022
*                                                                     * 00400020
*TITLE -- 'IEDQGA' BUFFER MANAGEMENT                                  * 00500020
*                                                                     * 00600020
*  MODULE NAME = IEDQGA                                               * 00700005
*                                                                     * 00710005
*  DESCRIPTIVE NAME = BUFFER MANAGEMENT                               * 00720005
*                                                                     * 00730005
*  COPYRIGHT = 'NONE'                                                 * 00740005
*                                                                     * 00750005
*  STATUS:  CHANGE LEVEL 10                                    @G36XRPV 00760000
*                                                                     * 00800020
*FUNCTION -- THIS ROUTINE PERFORMS THREE FUNCTIONS -                  * 00900020
*   1. ASSIGN REQUESTED BUFFER(S) OR QUEUE A REQUEST TO BE SATISFIED  * 01000020
*      LATER.                                                         * 01100020
*   2. RETURN BUFFER UNITS TO THE BUFFER POOL                    S22025 01200022
*   3. BUILD CCWS FOR DATA TRANSFER IN EACH UNIT OF A BUFFER          * 01300020
*                                                                     * 01400020
*ENTRY POINTS -- THIS ROUTINE HAS THREE SEPARATE ENTRY POINTS         * 01500011
*   1. IEDQGA - BUFFER REQUEST - FROM THE DISPATCHER                  * 01600020
*   2. IEDQGB - BUFFER RETURN - FROM THE DISPATCHER                   * 01700020
*   3. IEDQGD - BUFFER ASSOCIATION - FROM THE OUTMSG MACRO EXPANSION  * 01800020
*      IN MH, OR FROM THE CTBFORM MODULE (IEDQGH).               Y01004 01900005
*   4. IEDQGA02 - BUFFER STEAL - CALLED USING AVTSTEAL         @G36XRPV 01950000
*                                                                     * 02000020
*   CALLING SEQUENCE                                                  * 02100020
*      FOR GA AND GB FROM THE DISPATCHER                              * 02200020
*             L    R15,QCBSTCHN         ADDR OF FIRST STCB            * 02300020
*             L    R1,BFRADDRESS                                      * 02400020
*             B    2(R15)                                             * 02500020
*      FOR GD IT IS                                                   * 02600020
*             LA   R15,IEDQGD                                         * 02700020
*                       L     R6,BFRADDR                              * 02800020
*             LA   R1,AVTPARM                                         * 02900020
*             BALR  R14,R15                                           * 03000020
*                                                                     * 03100020
*INPUT -- INPUT IS DIFFERENT FOR THE DIFFERENT SERVICES               * 03200020
*   1. GA, GB - R1 HAS THE BUFFER ADDRESS (GB) OF ERB                 * 03300020
*      ADDRESS (GA)                                                   * 03400020
*L              R15 HAS THE ENTRY POINT ADDRESS                       * 03500020
*               R7 HAS THE QCB ADDRESS                                * 03600020
*        2.  GD - R15 HAS ENTRY POINT ADDR                            * 03700020
*              R14 - RETURN ADDR                                      * 03800020
*             R13 - AVTSAVE2                                          * 03900020
*               R3 - CURRENT SCB ADDRESS (WHEN ENTERED FROM MH   Y01004 03930005
*                    OR FROM CTBFORM)                            Y01004 03960005
*                                                                     * 04000020
*OUTPUT -- THIS ROUTINE PERFORMS THREE DIFFERENT FUNCTIONS AND        * 04100020
*   OUTPUT IS DIFFERENT IN ALL THREE CASES.                           * 04200020
*   U9 BUFFER REQUEST(GA)                                             * 04300020
*      A. INITIAL REQUEST FROM A LINE - IS UNITS ARE AVAILABLE,       * 04400020
*         THEY WILL BE CHAINED TOGETHER TO FORM BUFFERS.  CCWS WILL   * 04500020
*         BE BUILT FOR EACH INIT, AND THE ERB POSTED TO THE           * 04600020
*         ACTIVATE QCB.  EXIT IS TO THE DISPATCHER.                   * 04700020
*         IF UNITS ARE NOT AVAILABLE, THE ERB IS PLACED BY PRIORITY   * 04800020
*         INTO THE ELEMENT CHAIN OF THE BUFFER RETURN QCB.            * 04900020
*      B. ERB FROM A PROCESS PROGRAM - IF AVAILABLE, UNITS ARE        * 05000020
*         CHAINED TO FORM BUFFERS AND THE ERB IS POSTED TO THE        * 05100020
*         PROCESS PROGRAM QCB.                                        * 05200020
*         IF UNITS ARE NOT AVAILABLE - SEE 1.A                        * 05300020
*      C. FIRST PCI REQUEST - IS AVAILABLE, UNITS ARE CHAINED INTO    * 05400020
*         BUFFERS.  CCWS ARE BUILT IN EACH UNIT.  EXEIT IS TO THE     * 05500020
*         DISPATCHER                                                  * 05600020
*         IS NO UNITS ARE AVAILABLE - SEE 1.A                         * 05700020
*      D. SUBSEQUENT PCI REQUEST - THE ERB IS CHAINED BY PRIORITY     * 05800020
*         INTO THE ELEMENT CHAIN OF THE BUFFER RETURN QCB.  EXIT      * 05900020
*         IS TO THE DISPATCHER.                                       * 06000020
*   2. BUFFER RETURN(GB)                                              * 06100020
*      A. IF THERE ARE NO ERBS WAITING FOR A BUFFER, THE UNITS        * 06200020
*         WHICH MAKE UP THE BUFFER ARE PLACED INTO THE CHAIN OF       * 06300020
*         AVAILABLE UNITS FROM THE BUFFER REQUEST QCB.  EXIT IS TO    * 06400020
*         THE DISPATCHER.                                             * 06500020
*      B. IF AN ERB IS WAITING, UNITS ARE CHAINED TOGETHER TO FORM    * 06600020
*         A BUFFER.  IF THE ERB HAS A LOW PRIORITY (NOT INITIAL,      * 06700020
*         FIRST PCI, OF DISK REQUESTE, CCWS WILL BE BUILT FOR EACH    * 06800020
*         UNIT OF THE BUFFER AND IT WILL BE INCLUDED IN THE CHANNEL   * 06900020
*         PROGRAM FOR THE LINE.  IS THE REQUEST WAS SATISFIED, THE    * 07000020
*         ERB IS DROPPED FROM THE BUFFER RETURN QCB ELEMENT CHAIN.    * 07100020
*         IF THE REQUEST WAS NOT SATISFIED, THE ERB IS RECHAINED BY   * 07200020
*         PRIORITY.                                                   * 07300020
*         IF THE ERB HAD A HIGHER PRIORITY ACTION IS TAKEN AS IN      * 07400020
*         1.A, B, OR C ABOVE.                                         * 07500020
*      3. BUFFER ASSOCIATION - ALL UNITS OF THE BUFFER(S) WILL        * 07600020
*         HAVE A READ OR WRITE AND TIC CCWS BUILT IN THE FIRST        * 07700020
*         THREE WORDS OF THE UNIT.  IF THE REQUEST IS OTHER THAN AN   * 07800020
*         INITIAL REQUEST FOR RECEIVING, THE BUFFER(S) WILL BE        * 07900020
*         INCLUDED IN THE CHANNEL PROGRAM FOR THE LINE.               * 08000020
*                                                                     * 08100020
*EXTERNAL ROUTINES -- IEDQDISP, INSERT BY PRIORITY, EITHER ON THE     * 08200005
*   READY QUEUE(DSPPOSTR) IN TO THE ELEMENT CHAIN OF A SPECIFIED      * 08300020
*   QCB(DSPPRIOR),                                                    * 08400020
*                  -- IEDQEB                                            08500006
*                  -- SETLOCK IS ISSUED TO ALLOW SERIALIZED      Y02027 08510006
*   EXECUTION OF CERTAIN CODE IN SUPERVISOR MODE,SUPERVISOR STATEY02027 08520006
*   THIS IS NESCESSARY TO CONVERT REAL AND VIRTUAL ADDRESSES.    Y02027 08530006
*                                                                X01004 08540005
*                 --IEAPTRV - VS REAL-TO-VIRTUAL SUBROUTINE - TO Y01004 08550005
*   TRANSLATE REAL TIC ADDRESSES IN BUFFER UNITS TO VIRTUAL.     X01004 08560005
*                                                                X01004 08570005
*EXITS-NORMAL -- EXIT IS THE DISPATCHER 3R THE CALLING ROUTINE AS     * 08600020
*   FOLLOWS                                                           * 08700020
*   1. BUFFER REQUEST AND BUFFER RETURN - EXIT IS TH THE DISPATCHER   * 08800020
*      A. AN ERB OR UNIT TO POST - DSPPOST                            * 08900020
*      B. NOTHING TO POST - DSPDISP                                   * 09000020
*      AN ERB TO BE INSERTED INTO THE BUFFER RETURN QCB ELEMENT       * 09100020
*         CHAIN - DSPPRIO                                             * 09200020
*   2. BUFFER ASSOCIATION - EXIT TO THE CALLING ROUTINE               * 09300020
*      A. MH MACRO EXPANSION OF OUTMSG                                * 09400020
*      B. BUFFER REQUEST                                              * 09500020
*      C. BUFFER RETURN                                               * 09600020
*      D. FOR CONCENTRATOR BUFFERS, EXIT IS TO THE DISPATCHER -  Y01004 09650005
*         DSPDISP                                                Y01004 09670005
*                                                                     * 09700020
*EXITS-ERROR -- NONE                                                  * 09800020
*                                                                     * 09900020
*TABLES/WORKAREAS -- TDISPD,DCBD,TPRFD,TLCBD,TQCBD,TAVTD 2            * 10000020
*   AVTFIELDS USED - AVTACTIB,AVTAVFCT,AVTBFREB,AVTBFRTB,AVTCPBCB,    * 10100020
*   AVTDELAD,AVTDOUBL,AVTDSKCT,AVTEA,AVTEINPR,AVTHDRSZ,AVTKEYLE,      * 10200020
*   AVTSVSIZ,AVTTXTSZ.                                                * 10300020
*                                                                       10400020
*ATTRIBUTES -- REUSEABLE, REFRESHABLE, ENABLED, RESIDENT              * 10500020
*                                                                     * 10600020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 10700020
*    PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER     * 10800020
*    SET.                                                             * 10900020
*                                                                     * 11000020
*********************************************************************** 11100020
         ENTRY IEDQGB                                                   11200020
         ENTRY IEDQGD                                                   11300020
         ENTRY IEDQGA02                                        @G36XRPV 11350000
*********************************************************************** 11400020
R0        EQU  0                         WORK REGISTER                  11500020
R1       EQU   1                         ELEMENT ADDRESS FORM           11600020
*                                        DISPATCHER                     11700020
*                                        ADDRESS OF PARM LIST           11800020
R2        EQU  2                         DCB UNIT COUNT                 11900020
*                                       ADDRESS OF THE LAST UNIT        12000020
*                                        OF THE LAST BUFFER             12100020
RSCB     EQU   3                        SCB BASE                        12200020
R3        EQU  3                        WORK REGISTER                   12300020
*                                        LAST UNIT IN THIS BUFFER       12400020
RLCB      EQU  4                        LCB ADDRESS                     12500020
R5        EQU  5                         COUNT OF AVAILABLE BUFFERS     12600020
*                                        USED RD SK/WR ID LOOP          12700020
R6       EQU   6                        WORK REGISTER            Y05331 12700105
RPREFIX   EQU  6                         BUFFER ADDRESS                 12800020
R7       EQU   7                        WORK REGISTER                   12900020
RQCB      EQU  7                        QCB ADDRESS                     13000020
R8        EQU  8                        COUNT RESERVED FOR DISK         13100020
R9       EQU   9                        WORK REGISTER                   13200020
RDCB      EQU  10                        DCB ADDRESS                    13300020
R11       EQU  11                        DISPATCHER BASE REGISTER       13400020
*                                        ERB BUFFER REQ. CT             13500020
*                                       UNUSED RD SK/WR ID LOOP         13600020
RBASE     EQU  12                       PROGRAM BASE REGISTER           13700020
RAVT      EQU  13                        BASE REGISTER FOR AVT 2        13800020
*                                        SAVE AREA ADDRESS              13900020
R14      EQU   14                        RETURN ADDRESS AND WORK        14000020
R15       EQU  15                       ENTRY POINT ADDRESS             14100020
*                                        WORK REGIS TER                 14200020
*********************************************************************** 14300020
ONE      EQU   1                        OFFSET                   S22024 14400022
TWO      EQU   2                        OFFSET                   S22024 14420022
ZEERO    EQU   0                        OFFSET                   S22024 14440022
THREE    EQU   3                        OFFSET                   S22024 14460022
FOUR     EQU   4                        OFFSET                   S22024 14480022
NOTEQ    EQU   7                        CC = NOT EQUAL          OY00507 14500005
ONESIX   EQU   16                       OFFSET TO UCBTYP FIELD   S99228 14532022
TWOFOUR  EQU   24                       OFFSET                   S22024 14540022
LAST     EQU   X'02'                    LAST UNIT OF BUFFER FLAG Y01004 14544005
OBAKER   EQU   X'0B'                    3270 SELECT CMD OPCODE   S99228 14548022
APCIRCV  EQU   X'20'                    A TYPE PCI ON RECEIVE    S99228 14556022
LRSCHED  EQU   X'1E'                    LOCAL RECEIVE SCHED MASK S99228 14564022
DEV2260  EQU   X'03'                    2260 DEVICE TYPE         S99228 14572022
COMCHAIN EQU   X'40'                    DATA CHAINING INDIC      S99228 14580022
EAUCOM   EQU   X'0F'                    3270 EAU COMMAND CODE    S99228 14588022
XXXINHIB EQU   X'0A'                    HEX 0A                   S22024 14600022
XXXUSED  EQU   X'20'                    HEX 20                   S22024 14700022
XXXCNCL  EQU   X'02'                   &H0702                   S22024  14800022
XXXPCISD EQU   X'51'                    HEX 51                   S22024 14900022
XXXPCIRV EQU   X'A2'                    HEX A2                   S22024 15000022
XXCTUSED EQU   X'80'                    DISABLED CT IS BEING REFER'D    15100022
NOTTIC   EQU   X'07'                    MASK FOR TEST          @YA08774 15102009
CPASTART EQU   X'04'                    LCBSTART VALID FLAG    @YA06893 15104009
CVTADDR  EQU   16                       ABSOLUTE LOCATION OF CVT Y01004 15106005
*                                       ADDRESS.                 Y01004 15112005
CVTPTRV  EQU   X'120'                   OFFSET INTO CVT OF ADDR. X01004 15118005
*                                          OF REAL-TO-VIRTUAL    X01004 15124005
*                                          SUBROUTINE.           X01004 15130005
ALL      EQU   15                       4-BYTE ICM MASK.         X01004 15136005
NILL     EQU   0                         CONSTANT                X01004 15142005
AD       EQU   7                        3-BYTE ICM MASK.         X01004 15148005
EIGHT    EQU   8                        CCW LENGTH.              X01004 15154005
NINE     EQU   9                        CONSTANT.                Y01004 15160005
ELEVEN   EQU   11                       CONSTANT                 X01004 15166005
TWELVE   EQU   12                       CONSTANT                 X01004 15172005
THIRTEEN EQU   13                       CONSTANT                 X01004 15178005
TWENTY   EQU   20                       CONSTANT.                Y01004 15184005
NO       EQU   14                       CONDITION CODE           X01004 15190005
         USING AVTSAVE2,RAVT            AVT BASE                 S22025 15200022
         USING IEDQQCB,RQCB                                             15300020
         USING IEDQLCB,RLCB                                             15400020
         USING IHADCB,RDCB                                              15500020
         USING IEDQPRF,RPREFIX                                          15600020
         USING  IEDQDISP,R11                                            15700020
         USING  IEDQSCB,RSCB                                            15800020
         TITLE  '''IEDQGA'' - BUFFER REQUEST'                           15900020
*********************************************************************** 16000020
*TITLE -  BUFFER REQUEST                                              * 16100020
*    THIS ROUTINE IS ENTERED AS A RESULT OF RECEIVE SCHEDULER OR      * 16200020
*    LINE PCI POSTING AN ERB TO THE BUFFER REQUEST QCB.  IF THE ERB   * 16300020
*    IS FOR AM INITIAL REQUEST, THE NUMBER OF UNITS REQUIRED ARE      * 16400020
*    REMOVED FROM THE AVAILABLE CHAIN TO FROM THE REQUESTED NUMBER    * 16500020
*    OF BUFFERS.  A BAL TO THE ASSOCIATION SUBROUTINE WILL BUILD      * 16600020
*    THE REQUIRED CCWS AND THE ERB WILL BE POSTED TO THE ACTIVATE     * 16700020
*    QCB. IF THE REQUESTED WAS A PROCESS PROGRAM, THE ERB WILL BE     * 16800020
*    POSTED TO THE SPECIFIED QCB.                                     * 16900020
*                                                                     * 17000020
*    IF THE REQUEST IS NOT INITIAL REQUEST, THE ERB IS CHAINED        * 17100020
*    BY THE PRIORITY INTO THE ELEMENT CHAIN OF THE BUFFER RETURN QCB. * 17200020
*                                                                     * 17300020
*********************************************************************** 17400020
         SPACE 2                                                        17500020
         DC    AL1(DSPMCPL2)            STCB                            17600022
         DC    X'00'                    STCB                            17700022
         SPACE 2                                                        17800022
         USING *,RBASE                  DECLARE BASE REGISTER           17900022
BFRREQ   EQU   *                        BEGINNING OF CODE               18000022
         LR    RBASE,R15                SET ADDRESSABILITY              18100020
IEDQGA   IEDHJN GASTART                                                 18400006
         LR    RLCB,R1                  ADDR OF ERB FROM DISP           18800020
         LA    R0,LCBERBFS              AMT TO SUBTR FOR START LCB      18900020
         SLR   RLCB,R0                 BACK UP TO LCB                   19000020
         TM    LCBERBST,LCBERROR        ERROR ON THE LINE               19100020
         BNO   NOERROR                  BRANCH IF NO.            Y01004 19200005
         NI    LCBERBST,AVTEFF-LCBERROR SET ERROR BIT OFF.       Y01004 19201005
         OI    LCBERBST,LCBDLNKN        SET DELINK SWITCH ON FOR Y01004 19202005
*                                       BUFFER DISPOSITION.      Y01004 19203005
         B     DSPDISP                  EXIT TO DISPATCHER TO    Y01004 19204005
*                                       STOP ASSIGNING BUFFERS.  Y01004 19205005
NOERROR  EQU   *                                                 Y01004 19206005
         TM    LCBERBST,LCBPRCPG        APPL PROG BUFFER REQ   @Z30X8PM 19216000
         L     RDCB,LCBDCBPT            ADDRESS OF DCB         @Z30X8PM 19226000
         BO    NOINIT1                  YES, SKIP PCI LOCK MP  @Z30X8PM 19236000
NOINIT   EQU   *                                               @Z30X8PM 19246000
         TS    LCBPCILK                 PCI ACTIVE ON THIS LINE  Y02027 19291006
         BNE   NOINIT                   YES, LOOP FOR MP TILL    Y02027 19294006
*                                       PCI COMPLETE             Y02027 19297006
NOINIT1  EQU   *                                                 Y02027 19298006
         XC    LCBERBCH(3),LCBERBCH     UNCHAIN ERB                     19300022
REENTRY  EQU   *                                                 S22025 19330022
         CLI   LCBERBPY,PRISBPCI        SUBSEQUENT POST OF ERB   S22025 19370022
         BNE   INITIAL                  NO,BRANCH                S22025 19440022
         L     RDCB,LCBDCBPT            DCB ADDRESS              S22025 19510022
         TM    DCBPCI,PCIADDXR          PCI=X ON INPUT           S22025 19580022
         BZ    PRINSERT                 NO,  INSERT PRIORITY     S22025 19650022
         MVI   LCBERBPY,PRIFSPCI        TREAT PCI=X THE SAME AS  S22025 19660022
*                                         FIRST PCI, I.E. ASSIGN S22025 19670022
*                                         BUFFERS AND LEAVE ERB  S22025 19680022
*                                         POSTABLE               S22025 19690022
INITIAL  EQU   *                                                        19720022
         BAL   R14,SETRSVD              GET BUFFERS                     19790022
         LA    RQCB,AVTBFREB            ADDR OF AVAIL BFR QCB           19860022
         L     RPREFIX,QCBELCHN-1       ELEMENT CHAIN            S22024 19930022
         LR    R15,RPREFIX              ADDRESS OF FIRST BUFFER         20000022
         BAL   R14,DCBCT                GET BUFFERS                     20070022
         LR    R0,R2                    SAVE NO. U ITS                  20200020
         CR    R5,R8                    DOES RSVD CT EXCEED AVAIL.      20300020
         BH    BFRTHERE                 CT  BR  IF AVAIL IS HIGH        20400020
LINK     EQU   *                                                        20500020
         NC    LCBERBCH(3),LCBERBCH    WERE ANY BFRS ASSIGNED           20520020
         BZ    LINK2                   NO, GO ENQUEUE ERB               20540020
         BAL   R9,FREEBFRS             GO FREE ASSIGNED BFRS            20560020
LINK2    EQU   *                                                        20580020
         STC    R11,LCBERBCT            RESTORE ERB RQ CT               20600020
PRINSERT EQU   *                                                        20900020
         TM    LCBERBST,LCBPRCPG        APPL PROG. REQUEST       Y02027 20920006
         BO    PCILK01                  YES, BYPASS LOCK CLEARINGY02027 20940006
         MVI   LCBPCILK,ZEERO           CLEAR PCI LOCK FOR MP    Y02027 20960006
PCILK01  EQU   *                                                 Y02027 20980006
         NI   LCBERBST,LCBDLNKF         SET DLNK OFF FOR PCI            21000020
         LA    R1,LCBERB                LCBERB ADDR              S22024 21100022
         LA    RQCB,AVTBFRTB            BFR RTN QCB                     21200020
         L     R11,AVTEA                DISP BASE REG                   21300020
         BAL   R14,DSPPRIO              PRIORITY INSERT        @G36XRPV 21400000
*                                         AND DISPATCH         @G36XRPV 21450000
         SPACE 1                                                        21500020
BFRTHERE EQU   *                                                        22100020
         CR    R5,R2                    ENOUGH FOR FIRST BFR            22200020
         BL    LINK                     BR NO                           22300020
         LA    RPREFIX,0(0,RPREFIX)     CLEAR HI ORDER BYTE             22400022
         LTR   RPREFIX,RPREFIX          IS IT ZERO                      22470022
         BZ    LINK                     CHECK ON BUFFERS                22540022
         LA    R14,LCBERBCH-5           *                               22750022
         BAL   R1,NC                    ENTER LOOP AND SET LOOP REG     22820022
         L     R14,PRFLINK-1-IEDQPRF(R14) PICK UP LINK           S22024 22900022
NC       EQU   *                                                 S22024 22970022
         NC    PRFLINK-IEDQPRF(THREE,R14),PRFLINK-IEDQPRF(R14) CHECK    23040022
*                                       LAST                     S22024 23110022
         BCR   7,R1                     BR IF NOT LAST ASSIGNED         23200020
         LA    R14,0(,R14)              INITIALIZE FOR LOOP             23300020
         SH    R14,AVTHA4               SUBTRACT                        23400022
         BAL   R9,UNIT                  MANIPULATE BUFFERS              23500022
         LA    R9,SETCT                 SET EXIT ADDR FOR COMMON CODE   23600020
         LA    R8,INITIAL               SET RETURN ADDR                 23700020
         CLI   LCBERBPY,PRIFSPCI       IS THIS FIRST PCI REQUEST        23800020
         BE    RECOUNT                  YES, GO SEE IF OTHERS NOW       23900020
         LR    R14,R8                   SET COMMON CODE EXIT POINT      24000020
         BCTR  R11,R9                   IS THE REQ, COMPLETE - BR NO    24100020
         OI   LCBERBST,LCBDLNKN         SET DLNK ON FOR PCI AND DISP    24200020
         STC   R11,LCBERBCT                                             24300020
*     CHECK FOR A PROCESS PGM - BR IF YES                               24400020
*   GET ADDR OF PROCESS QCB FROM LCB                                    24500020
         L     R8,LCBRCQCB                                              24600020
         TM    LCBERBST,LCBPRCPG        APPL PROG BUFFER REQ            24700020
         BO    POSTA                    BRANCH IF YES                   24800020
         BAL   R8,ASSOCIAT              IF NOT MPP ASSOCIATE BFR(S)     24900020
*                                       WITH LINE                       25000020
NOASSOC  EQU   *                                                 S22024 25003022
         TM    LCBSTAT1,LCBCONT         CONTINUE FROM LMD        S22025 25007022
         BZ    FIRSTIME                 BRANCH NO                S22025 25014022
         SPACE                                                          25021022
         L     RSCB,LCBSCBA-1           SET SCB BASE                    25028022
         MVC   SCBDEOB+1(3),LCBLSPCI    SET NEXT EOB RECORD      S22025 25035022
         MVC   LCBCPA+13(3),LCBLSPCI    SET CURRENT CCW ADDRESS  S22025 25042022
         MVC   LCBCPA+16(8),PRFOPCDE-IEDQPRF(R2)  SET THE CCW IN S22025 25070022
*                                         CASE OF A CONTINUE OPR S22025 25077022
FIRSTIME EQU   *                                                 S22025 25084022
         LA    R8,AVTACTIB                                              25100020
         MVI   LCBPCILK,ZEERO           CLEAR PCI LOCK FOR MP    Y02027 25150006
POSTA    EQU   *                                                        25200020
         ST   R8,LCBERBQB-1            FOR POST                         25300020
         LA    R1,LCBERB                                                25400020
         MVI    LCBERBPY,PRIACTIV                                       25500020
         L     R11,AVTEA                                                25600020
         L     R15,LCBERBCH-1           LOAD FIRST UNIT ADDR   @OY19124 25650011
         BAL   R14,DSPPOST              POST AND DISPATCH      @G36XRPV 25700000
         SPACE 1                                                        25800020
FREELAST EQU   *                                                        25900020
         LA    R9,LINK2                 LOAD EXIT POINT ADDR            26000020
         SR    R0,R2                   GET NUMBER OF UNITS ASSIGNED     26060020
*                                           FOR THIS BUFFER             26120020
         STC   R0,PRFNBUNT             SET NUMBER UNITS IN PARTIAL BFR  26180020
         BCTR  R11,0                   DECREMENT TEMP REQUEST COUNT     26240020
FREEBFRS EQU   *                                                        26300020
         BALR  R1,0                    SET LOOP RETURN ADDRESS          26360020
         SPACE 1                                                        26420020
         NC    LCBERBCH(3),LCBERBCH     WERE ANY ASSIGNED               26500020
         BCR   8,R9                    NO, GO RE-LINK REQUEST           26600020
         LA    R11,1(,R11)             ADD ONE TO NUMBER REQUESTED      26700020
*                                           FOR THIS BUFFER             26800020
         L     RPREFIX,LCBERBCH-1      GET FIRST ASSIGNED BFR ADDR      26900020
         MVC   LCBERBCH(3),PRFLINK     DE-LINK BUFFER                   27000020
         IC    R2,PRFNBUNT             GET NUMBER OF UNITS              27100020
NEXTONE  EQU   *                                                        27200020
         TM    AVTBFRFG,AVTBFRTN        RETURN UNITS HI OR LO  @OY19124 27207011
         BNO   ONTOP                    BRANCH RETURN HI       @OY19124 27214011
         NC    AVTBFREB+1(3),AVTBFREB+1 UNITS AVAILABLE        @ZM48772 27221011
         BZ    NOCOR                    BRANCH NO              @OY19124 27228011
         L     R5,AVTSELCH-1            LOAD ADDRESS LAST UNIT @OY19124 27235011
         STCM  RPREFIX,7,PRFLINK-IEDQPRF(R5) ADD NEW LAST UNIT @OY19124 27242011
NOCOR    EQU   *                                               @OY19124 27249011
         STCM  RPREFIX,7,AVTSELCH       SET ADDRESS LAST UNIT  @OY19124 27263011
         XC    PRFLINK,PRFLINK          CLEAR LINK FIELD       @OY19124 27270011
         NC    AVTBFREB+1(3),AVTBFREB+1 ANYTHING AVAILABLE     @ZM48772 27277011
         BNZ   ONTOPOFF                 BRANCH YES             @OY19124 27284011
ONTOP    EQU   *                                               @OY19124 27291011
         MVC   PRFLINK(3),AVTBFREB+1   LINK UNIT INTO CHAIN             27300020
         ST    RPREFIX,AVTBFREB                                         27400020
ONTOPOFF EQU   *                                               @OY19124 27405011
         TM    AVTSAVTF,AVTVTMCP      8 BYTE NEG PREFIX ? @ZM46639      27410000
         BNO   BYPCLEAR               NO                  @ZM46639      27420000
         LA    R15,EIGHT              SET PREFIX SIZE     @ZM46639      27430000
         LNR   R15,R15                MAKE NEGATIVE       @ZM46639      27440000
         AR    R15,RPREFIX            POINT TO PREFIX     @ZM46639      27450000
         XC    0(EIGHT,R15),0(R15)    CLEAR PREFIX        @ZM46639      27460000
BYPCLEAR EQU   *                                          @ZM46639      27470000
         OI    PRFTIC+3,X'01'          SET 'FREE' FLAG                  27500020
         L     RPREFIX,PRFTIC          GET NEXT UNIT ADDRESS            27600020
         BCTR  RPREFIX,0               TURN OFF 'FREE' FLAG IN REG      27700020
         LH    R5,AVTAVFCT              GET AVAILABLE COUNT    @OY19124 27750011
         LA    R5,1(0,R5)               INCREASE AVAIL. BFR CT          28200020
         STH   R5,AVTAVFCT              RESET AVAILABLE COUNT  @OY19124 28250011
         BCT   R2,NEXTONE               GET NEXT UNIT                   28300022
         BR    R1                      EXIT FROM LOOP                   28420020
         SPACE 1                                                        28500020
DCBCT    EQU   *                                                        28600020
         SR    R2,R2                    CLEAR FOR IC                    28700020
         IC    R2,LCBERBCT+1            GET NO UNITS                    28800020
         TM    LCBERBST,LCBPRCPG        IS THIS AN APPL PGM             28900020
         BCR   1,R14                   BR YES                           29000020
         L     RDCB,LCBDCBPT            ADDR OF DCB                     29100020
         IC    R2,DCBUNTCT              GET UNIT COUNT                  29200022
         BR    R14                      RETURN                          29300022
         SPACE                                                          29400022
UNIT     EQU   *                        UNIT                            29500022
         ICM   R15,AD,QCBELCHN          ADDRESS OF NEXT UNIT.    Y01004 29600005
         BZ    FREELAST                 BRANCH IF NO MORE UNITS. Y01004 29700005
         CR    R5,R8                    DOES AVAIL CT EXCEED RSVD       29900020
         BNH   FREELAST                 BR NO                           30000020
         BCTR  R5,0                     DECR AVAIL. CT                  30100020
         STCM  R15,AD,PRFTIC+ONE-IEDQPRF(R14)                    X01004 30200005
*                      LINK PREV. UNIT TO THIS ONE                      30300020
         MVC   QCBELCHN(3),PRFLINK-IEDQPRF(R15)                         30400020
*                       NEXT UNIT INTO AVAILABLE BFR QCB                30500020
         XC    PRFLINK-IEDQPRF(7,R15),PRFLINK-IEDQPRF(R15)              30550020
         MVI   PRFTICC-IEDQPRF(R15),PRFTICON SET TIC COMMAND   @G36XRPV 30570000
         LR    R14,R15                  ADDR OF UNIT JUST ASSIGNED      30600020
         BCT   R2,UNIT                  DECR CT OF UNITS PER BFR        30700020
         MVC   PRFTICC-IEDQPRF(L'TIC02,R15),TIC02 INVALID TIC  @G36XRPV 30730000
*                                         IN LAST BUFFER UNIT  @G36XRPV 30760000
         STH   R5,AVTAVFCT              SAVE AVAILABLE COUNT            30800020
         ST    RLCB,PRFLCB-1                                            31200020
         STH   R2,PRFSRCE               SET SRCE OFFSET TO 0            31300020
         STH   R2,PRFSIZE               SIZE TO 0                       31400020
         MVI   PRFSTAT1,PRFNHDRN+PRFNLSTN                               31500020
*              SET FLAGS FOR STATUS OF BFR                              31600020
         STC   R0,PRFNBUNT              SET NO. UNITS                   31700020
         XC    PRFCORE(PRFSHDR+4-PRFCORE),PRFCORE ZERO PREFIX    S22029 31800022
         TM    LCBTSOB,LCBTSBUF         IS THIS A TS BUFFER         TSO 32000020
         BCR   EIGHT,R9                 IF NO, RETURN.              TSO 32100005
         OI    PRFSTAT1,PRFTSMSG       FLAG TSO MESSAGE          S22029 32200022
         BR    R9                       RETURN                          32300022
         SPACE 1                                                        32400020
SETRSVD  EQU   *                                                        32500020
         SR    R11,R11                                                  32600020
         IC    R11,LCBERBCT             NO. BFRS REQUESTED(EN)          32700020
         LH    R8,AVTDSKCT                                              32800020
*                       DISK OPERATION IN PROGRESS                      32900020
         LH    R5,AVTAVFCT              CT OF AVAILABLE BFRS            33000020
         N     R5,AVTCLRHI              CLEAR HIGH BYTES       @YA07705 33050009
         BR    R14                      RETURN                          33100022
         EJECT                                                          33200022
*                                                                     * 33300020
*********************************************************************** 33400020
*    THIS ROUTINE RECEIVES CONTROL AS A RESULT OF LINE PCI, DISK I/O  * 33500020
*    OR DISPOSITION POSTING A FREE BUFFER.  IF AN ERB IS NOT WAITING  * 33600020
*    FOR A BUFFER, THE UNIT OF THIS BUFFER ARE PLACED IN THE          * 33700020
*    AVAILABLE CHAIN.                                                 * 33800020
*    IF AN ERB IS WAITING AND DOES NOT REPRESENT AN INITIAL REQUEST   * 33900020
*    OR A DISK REQUEST, A BUFFER IS CONSTRUCTED AND (VIA A BAL TO     * 34000020
*    THE ASSOCIATE SUBROUTINE), CCWS ARE BUILT FOR THE UNTIS          * 34100020
*    INVOLVED.                                                        * 34200020
*    IF THE ERB REPRESENTS A DISK REQUEST, THE BUFFER IS BUILT AND    * 34300020
*    POSTED TO THE CPR CLEANUP QCB.                                   * 34400020
*    IF THE ERB REPRESENTS AN INITIAL REQUEST, A BUFFER IS BUILT      * 34500020
*    AND CHAINED INTO THE ERB'S BUFFER CHAIN.  IF THE REQUEST IS      * 34600020
*    NOT SATISIFIED, RETURN IS TO THE DISPATCHER.  IF THE REQUEST IS  * 34700020
*    SATISFIED, THE ERB IS POSTED TO THE ACTIVATE QCB, AFTER THE      * 34800020
*    CCWS (VIA ASSOCIATION SUBROUTINE) ARE BUILT FOR UNITS.           * 34900020
*                                                                     * 35000020
*********************************************************************** 35100020
         DS    0H                                                       35200020
IEDQGB   EQU   *                                                        35300020
         SPACE 2                                                        35400020
         DC    AL1(DSPMCPL2)            STCB                            35500022
         DC    X'00'                    STCB                            35600022
         SPACE 2                                                        35700022
         USING *,15                     DECLARE TEMPORARY BASE REG      35800022
         L     RBASE,BASE               SET UP MODULE BASE              35900022
         DROP  15                       DROP TEMPORARY BASE             36000022
         LR    RPREFIX,R1               BFR ADDR                        36100020
         LA    RQCB,AVTBFREB            BFR REQ. QCB                    36200020
         LH    R5,AVTAVFCT              NO. OF BFRS IN POOL      S22024 36300022
         N     R5,AVTCLRHI              CLEAR HIGH BYTES       @YA07705 36350009
         SR    R2,R2                    CLEAR REG 2              S22024 36400022
         ICM   R2,ONE,PRFNBUNT          GET NO. OF UNITS       @G36XRPV 36406000
         BNZ   CNTOK                    IF ZERO MUST FIND FIRST@G36XRPV 36412000
NEXTUT   EQU   *                         TIC02 ADDRESS         @G36XRPV 36418000
         LA    R2,1(,R2)                UP UNIT COUNTER        @G36XRPV 36424000
         DROP  RPREFIX                                         @G36XRPV 36430000
         USING IEDQPRF,R1                                      @G36XRPV 36436000
         TM    PRFTIC+3,2               TEST FOR LAST UNIT     @G36XRPV 36442000
         BO    CNTSTC                   LAST UNIT              @G36XRPV 36448000
         L     R1,PRFTIC                GET NEXT UNIT          @G36XRPV 36454000
         B     NEXTUT                   CONTINUE SEARCH        @G36XRPV 36460000
         DROP  R1                                              @G36XRPV 36466000
         USING IEDQPRF,RPREFIX                                 @G36XRPV 36472000
CNTSTC   STC   R2,PRFNBUNT              CORRECT PRFNBUNT       @G36XRPV 36478000
CNTOK    EQU   *                                               @G36XRPV 36484000
         LR    R0,R2                    SAVE NO. OF UNITS        S22024 36600022
         BAL   R1,NEXTONE              GO FREE UNITS OF BUFFER          36700020
         LR    R2,R0                    RESTORE NO. OF UNITS            36900020
BFRASIGN EQU   *                                                        37100020
         L     RPREFIX,AVTBFREB+QCBELCHN-1-IEDQQCB GET AVAILABLE UNIT   37200020
*                                           ADDRESS                     37300020
         LA    RQCB,AVTBFRTB            BFR RTN QCB                     37400020
         L     RLCB,QCBELCHN-ONE        ADDRESS OF FIRST ERB     X01004 37500005
         CLM   RLCB,AD,AVTDELAD+ONE     ARE ANY ERB'S WAITING    X01004 37600005
         BE    RETURN1                  BRANCH IF NO             Y02027 37700006
         LA    R0,LCBERB-IEDQLCB        LOAD LCBERB PTR          S22024 37800022
         SR    RLCB,R0                  ADDR OF ERB                     37900020
         CLI   LCBERBPY,PRIDSKRQ        ERB PRIORITY                    38000022
         BL    XRSVDCT                  BRANCH IF LOW                   38100022
         ST    RLCB,PRFLCB-1            SAVE                            38200022
         MVC   QCBELCHN(3),LCBERBLK     REOMVE                          38300020
         LA    R1,AVTCPBCB              CLEANUP QCB              S22024 38400022
         ST    R1,PRFQCBA-1             TO BUFFER                S22024 38500022
         MVC   AVTBFREB+QCBELCHN-IEDQQCB(3),PRFLINK REMOVE BUFFER FROM  38600020
*                                           AVAILABLE QUEUE             38700020
         MVI   PRFNBUNT,ONE             NO. OF UNITS             S22024 38800022
         XC    PRFTIC+ONE(THREE),PRFTIC+ONE CLEAR LINK FIELD     S22024 38900022
         LR    R1,RPREFIX               LOAD UNIT ADDR           S22024 39000022
         L    R11,AVTEA                 RESTORE DISP ADDR               39100020
         MVI   PRFPRI,PRIDSKBF          MOVE PRIORITY                   39200022
         BAL   R14,DSPPOSTR             POST                            39300022
         BCT   R2,BFRASIGN              ASSIGN BUFFER                   39400022
         B     RETURN1                  EXIT TO DISPATCHER       Y02027 39500006
RETURN   EQU   *                        *                               39600022
         TM    LCBERBST,LCBPRCPG        APPL PROG REQUEST        Y02027 39610006
         BO    RETURN1                  YES, SKIP PCI SWITCH     Y02027 39620006
         MVI   LCBPCILK,ZEERO           CLEAR PCI LOCK FOR MP    Y02027 39630006
RETURN1  EQU   *                                                 Y02027 39660006
         L     R11,AVTEA                GET ADDR OF TCAM DISPATCHER     39700022
         B     DSPDISP                  RETURN TO DISPATCHER            39800020
         SPACE 1                                                        39900020
XRSVDCT  EQU   *                                                        40000020
         TM    LCBERBST,LCBERROR        ERROR ON THIS LINE              40100020
         BNO   NOTERROR                 BRANCH IF NO.            Y01004 40200005
         NI    LCBERBST,AVTEFF-LCBERROR RESET ERROR FLAG.        Y01004 40210005
         OI    LCBERBST,LCBDLNKN        SET DELINK SWITCH ON FOR Y01004 40220005
*                                       BUFFER DISPOSITION.      Y01004 40230005
         MVC   QCBELCHN(THREE),LCBERBLK REMOVE ERB.              Y01004 40240005
         B     BFRASIGN                 STOP BUFFER ASSIGNMENT.  Y01004 40250005
NOTERROR EQU   *                                                 Y01004 40260005
         BAL   R14,SETRSVD              GET BUFFERS                     40300022
         CR    R5,R8                    IS THE AVAILABLE CT LESS        40400020
*                                       THAN RESERVED COUNT      Y01004 40500005
         BNH   RETURN1                  BRANCH IF YES            Y02027 40550006
         BAL   R14,DCBCT                GET COUNT                       40600022
         LR    R0,R2                    SAVE NO. U ITS                  40700020
         MVC   QCBELCHN(3),LCBERBLK     REMOVE ERB                      40800020
         LA    RQCB,AVTBFREB            AVAILABLE BFR            S22024 40900022
         CLI   LCBERBPY,PRISBPCI       IS THIS SUBSEQUENT PCI REQ       41000020
         BNE   INITIAL                 NO, GO HANDLE IT AS INITIAL      41100020
         LA    R14,LCBERBCH-9           SET SO ERB CHAIN LOOKS LIKE TIC 41200020
*                                            OF PREVIOUS UNIT           41300020
         BAL   R9,UNIT                  MANIPULATE BUFFERS              41400022
         LA    R9,RECHAIN               SET EXIT ADDR FROM COMMON CODE  41500020
RECOUNT  EQU   *                                                        41600020
         LA    R14,ASSOC2               SET EXIT POINT                  41700020
         BCTR  R11,R9                   IF THE ENABLED CT IS NOT        41800020
*                       ZERO, RECHAIN THE ERB. IF IT IS 0, CHECK        41900020
*                       THE DISABLED CT.                                42000020
         STC    R11,LCBERBCT                                            42100020
         OI    LCBERBCT+1,XXCTUSED      FLAG THE DISABLED COUNT         42200020
         CLI   LCBERBCT+1,XXCTUSED      IS DISABLED ZERO                42300020
         BE    MORETEST                 YES, GO RELEASE ERB             42400020
         IC    R0,LCBERBCT+ONE          PICKUP COUNT             S22024 42500022
         LA    R1,AVTE80-1              SET FOR NR TO COEAR             42600020
         NR    R0,R1                    THE FLAG FROM DISA. CT          42700020
*        THE DISABLED COUNT SHOULD BE ADDED TO THE ENABLED COUNT        42800020
*        THE FLAG FOR THE DISABLED COUNT SHOULD BE OFF AND THE          42900020
*        DISABLED COUNT SHOULD BE SET TO ZERO                           43000020
         MVI   LCBERBCT+1,AVTEZERO      CLEAR FLAG AND DISA. CT 0       43100020
         IC    R11,LCBERBCT             GET COUNT                S22024 43200022
         AR    R11,R0                   ADD TO COUNT             S22024 43300022
         BR    R9                       GO EXIT FROM ROUTINE            43400020
         SPACE 1                                                        43500020
MORETEST EQU   *                                                        43600020
         OI    LCBERBST,LCBDLNKN        SET DELINK FOR PCI              43700020
         NI    LCBERBCT+1,X'FF'-XXCTUSED TURN OFF DISABLED FLAG         43800020
         ICM   R8,THREE,LCBERBCT        GET COUNT FIELDS.        Y01004 43900005
         LA    R8,RETURN                SET RTN ADDR                    44100020
         BCR   EIGHT,R14                BRANCH IF BOTH COUNTS    Y01004 44200005
*                                       ARE ZERO.                Y01004 44250005
         TM    LCBERBST,LCBDLNKN                                        44300020
         BCR   14,R14                   SEE COMMENT BELOW               44400022
*        IF THE DELINK SW IS OFF THE ERB HAS BEEN                       44500020
*                                       REPOSTED. IF IT IS NOT ON       44600020
*                                       IT MUST BE RECHAINED            44700020
         NI    LCBERBST,X'FF'-LCBDLNKN  TURN OFF 'POSTABLE' FLAG S22025 44800022
         LA    R8,REENTRY               SET RETURN ADDR          S22025 44850022
         BR    R14                      RETURN                          44900022
         SPACE 1                                                        45000020
RECHAIN  EQU   *                                                        45100020
         LA    R8,PRINSERT              SET EXIT REG                    45200020
SETCT    EQU   *                                                        45300020
         STC   R11,LCBERBCT                                             45400020
         BR    R14                      EXIT                            45500020
         TITLE   '''IEDQGA'' - BUFFER ASSOCIATION'                      46200020
*                                                                       46300020
*                                                                       46400020
********************************************************************    46500020
*                       BUFFER ASSOCIATION                            * 46600020
*                                                                     * 46700020
*        THIS ROUTINE MAY BE PASSED A BUFFER OR AN ERB WITH           * 46800020
*   BUFFERS IN THE BUFFER CHAIN.  THIS ROUTINE WILL BUILD             * 46900005
*   CCW'S IN THE FIRST 3 WORDS OF THE BUFFER UNIT(S) FOR EACH         * 47000020
*   BUFFER.  THE LAST BUFFER UNIT WILL TIC TO AN ADDRESS OF 2 TO      * 47100020
*   CAUSE A CHANNEL PROGRAM CHECK.  IF THIS BUFFER IS NOT THE FIRST,  * 47200020
*   THE LAST UNIT OF THE PREVIOUS BUFFER WILL BE MADE TO TIC TO       * 47300020
*   THE FIRST UNIT OF THIS ONE.  IF A CHANNEL PROGRAM CHECK HAS       * 47400020
*   OCCURRED, THE WRITE IDLE/READ SKIP LOOP WILL TIC TO THE BUFFER.   * 47500020
*   IF THIS IS A FIRST BUFFER FOR A WRITE, THE WRITE IDLE LOOP        * 47600020
*   WILL TIC TO THE BUFFER.                                           * 47700020
*        A PORTION OF THIS ROUTINE RUNS IN SUPERVISOR MODE AND   Y01004 47800005
*   KEY ZERO.  SUPERVISOR MODE IS NECESSARY TO PERFORM ADDRESS   Y01004 47830005
*   TRANSLATION.  KEY ZERO IS NECESSARY FOR SYSTEM INTEGRITY.    Y01004 47860005
*                                                                       47900020
********************************************************************    48000020
*                                                                       48100020
IEDQGD   DS    0H                                                Y01004 48200005
*                                                                       48300020
*        THIS ENTRY POINT IS USED BY MH WITH A FULL BUFFER TO    Y01004 48400005
*        WRITE, OR BY THE CTBFORM MODULE (IEDQGH) WITH A         Y01004 48450005
*        CONCENTRATED END-OF-MESSAGE BUFFER TO WRITE.            Y01004 48500005
*                                                                       48600020
         USING *,15                     SET TEMP. BASE                  48700020
         L     RBASE,BASE               SET PGM BASE                    48800020
         DROP  15                                                       48900020
         LA    R8,RETURN                PICK UP RETURN LOC       S22024 49000022
         TM    SCBQTYPE,SCBCONC         CONC SCB ?               S22026 49020022
         BZ    NOCONC                   NO                       S22026 49040022
         LA    R8,GDCONC                SET UP RETURN TO CON-    Y01004 49060005
*                                       CENTRATOR CODE.          Y01004 49070005
NOCONC   EQU   *                                                 S22026 49080022
         L     RLCB,PRFLCB-1            ADDR OF LCB                     49100020
         L     RDCB,LCBDCBPT            ADDR OF DCB              S22024 49200022
         LA    R14,ASSOC3               SET EXIT ADDR                   49300020
         MVC   AVTPARM+1(3),LCBLSPCI    SET PCI WORKAREA       @YA10687 49400009
         NC    LCBLSPCI(3),LCBLSPCI     IS THIS THE FIRST               49600020
         BCR   7,R14                    BR NO                           49700020
SETLSPCI EQU   *                                                        49800020
         STCM  RPREFIX,AD,AVTPARM+1     INITIALIZE WORKAREA TO @YA10024 49900009
*                                       ADDRESS OF FIRST BUFFER. X01004 50000005
         STCM  RPREFIX,AD,LCBCPA+THIRTEEN                        X01004 50200005
         BR    R14                      RETURN                          50300022
*                                                                       50400020
*        THIS ENTRY IS USED ONLY BY BUFFER REQUEST WITH AN ERB.         50500020
*        BUFFERS TO BE READ ARE ASSOCIATED WITH THIS ERB.               50600020
*                                                                       50700020
*        WHEN ENTERED ADDRESSES FOR LCB AND BUFFER DSECTS ALREADY       50800020
*        EXIST.                                                         50900020
*                                                                       51000020
*        WHEN ENTERED WITH AN ERB, READ SKIP LOOP A HAS NOT BEEN        51100020
*        BUILT.                                                         51200020
*                                                                       51300020
*                                                                       51400020
ASSOCIAT EQU   *                                                        51500020
         L     RPREFIX,LCBERBCH-1                                       51900020
         BAL   R14,SETLSPCI             SET                             52000022
         BAL   R14,SETCCWS              GO SET UP CCW                   52800022
         SR    RPREFIX,RPREFIX          CLEAR FOR ICM.           Y01004 52900005
         ICM   RPREFIX,AD,LCBERBCH      GET FIRST BUFFER ADDRESS Y01004 52950005
         ST    RPREFIX,AVTDOUBL+FOUR    SAVE FIRST BUFFER ADDR.  Y01004 53000005
*                                       AND SET A ZERO FLAG BYTE Y01004 53100005
ASSOC1   EQU   *                                                        53200020
         L     R9,AVTDOUBL+4            ADDR FIRST BFR                  53300020
         SR    R14,R14                  CLEAR FOR ICM.           Y01004 53400005
         ICM   R14,AD,PRFLINK           GET LINK FIELD OF BUFFER Y01004 53450005
         BZ    ASSOC5                   BRANCH IF THERE ARE NO   Y01004 53500005
*                                       MORE BUFFERS, TO ASSIGN  Y01004 53550005
*                                       A BUFFER.                Y01004 53600005
         LR    R9,R14                   PUT BUFFER ADDRESS IN R9 Y01004 53700005
         BAL   R14,BLDCCWS              BUILD THE CCW                   53800022
         STCM  R9,AD,PRFTIC+ONE-IEDQPRF(R3)  STORE BUFFER ADDR.  Y01004 53900005
*                                       IN TIC FIELD.            Y01004 54000005
         LR    RPREFIX,R9               SAVE LINK FIELD                 54100022
         B     ASSOC1                   TRY NEXT BUFFER                 54200022
         SPACE 2                                                        54300020
*        THIS ENTRY IS FROM A PCI WITH ONE BUFFER TO READ               54400020
         SPACE 1                                                        54500020
ASSOC2   EQU   *                                                        54600020
         XC    LCBERBCH(3),LCBERBCH                                     54700020
ASSOC3   EQU   *                                                        54800020
         LR    R9,RPREFIX                                               54900020
         BAL   R14,SETCCWS              SET UP CCW                      55000022
ASSOC5   EQU   *                        *                               55030022
         LA    R9,0(R9)                 CLEAR HI ORDER BYTE             55060022
         L     RSCB,LCBSCBA-1           LOAD SCB REG             S22026 55090022
         TM    SCBQTYPE,SCBCONC         CONCENTRATOR             S22026 55120022
         BZ    NOCONC1                  NO SKIP BRANCH TO LNR9   S22026 55150022
         L     R1,LCBSCBDA-1            GET LINE SCB ADDR        S22026 55230022
         TM    SCBSTAT1-IEDQSCB(R1),SCBCEND                      S22026 55240022
*                                       CONCENTRATED EOM         S22026 55250022
         BZ    GOAHEAD                  NO SKIP EOM FLAG SET     S22026 55260022
         B     LNR9                     ASSIGN BUFFER                   55270022
NOCONC1  EQU   *                        *                               55320022
         TM    PRFSTAT1,PRFNLSTN        LAST BUFFER OF MESSAGE          55370022
         BO    GOAHEAD                  BRANCH NO                       55420022
*        SET A FLAG TO REMEMBER THAT THE LAST UNIT OF THIS              55500020
*        BUFFER IS THE LAST UNIT THAT WILL BE RECEIVED FOR THIS         55600020
*        WRITE OPERATION - THE DC FLAG SOULD BE OFF.  R9 HAS            55700020
*        THE ADDRESS OF THE FIRST UNIT OF THE FIRST BUFFER TO BE        55800020
*        TO BE ASSIGNED THIS TIME.                                      55900020
LNR9     EQU   *                                                 S22026 55950022
         LNR   R9,R9                    INSURE NEGATIVE REGISTER        56000022
GOAHEAD  EQU   *                        *                               56080022
         BAL   R14,BLDCCWS              GO BUILD CCW                    56160022
         L     RSCB,LCBSCBA-1           RESTORE SCB BASE         S22026 56250022
         L     R2,AVTPARM               ADDR OF FIRST BFR      @YA10024 56300009
         CLI   LCBERBPY,PRIINTRQ        CHECK ERB PRIORITY              56400022
         BNE   CHECKIT                  NO CHECK DEVICE TYPE            56480022
         TM    LCBSTAT1,LCBRECVN        RECEIVE OPERATION               56560022
         BO    SETUP                    BRANCH-YES             @YA10024 56640009
CHECKIT  EQU   *                        CHECK DEVICE TYPE               56720022
         TM    LCBCPA+12,XXXCNCL        THIS AN ERB RETRY               57100020
         BNO   NOTRY                    BR NO                           57200020
*                                       CHECK TO SEE IF CURRENT  X01004 57220005
*                                       BUFFER IS THE FIRST ONE  X01004 57240005
*                                       TO BE RE-TRANSMITTED     X01004 57260005
         TM    PRFSTAT1-IEDQPRF(R9),PRFCNCLN+PRFNLSTN THIS THE BFR      57300020
         BO    SETUP                    BRANCH-YES             @YA10024 57400009
NOTRY    EQU   *                                                        57500020
         TM    SCBQTYPE,SCBCONC         CONCENTRATOR BUFFER      S22026 57502005
         BO    GDCONC                   IF YES, EXECUTE SPECIAL  Y01004 57504005
*                                       CONCENTRATOR CODE.       Y01004 57506005
         MODESET MODE=SUP                                               57508006
*                                       GET INTO SUPERVISOR MODE Y02027 57508806
         MODESET EXTKEY=SUPR                                            57509606
*                                       GET INTO SUPERVISOR KEY  Y02027 57510406
         LR    R15,RAVT                 SAVE AVT ADDRESS         Y02027 57511206
         L     R14,AVTSAVTP             SECONDARY AVT POINTER    Y05331 57512005
         L     R14,SAVTDIAG-IEDNSVTD(0,R14)  VM DIAG ROUTINE     Y05331 57512505
         STM   R11,R14,AVTSAVE2         SAVE REGISTERS USED BY   Y02027 57513006
*                                       SETLOCK ROUTINE          Y02027 57517006
SETASSC  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=CHANNEL PROGRAM,X57521006
               IGE0004G(SETERP),IGE0004H(SETERP),IGG019QE(SETERP),     X57525006
               IEDQGT(SETTRAN), 'PCI LINEEND AND START I/O APPENDAGES  X57529006
               ARE LOCKED ON THIS REAOURCE THRU THE EXCP PROCESSOR     X57533006
               ISSUING SETLOCK (ERP,BUFFER ASSOCIATION AND TRANSPARENT X57537006
               CCW BUILD MUST ISSUE SETLOCK'                            57541006
         LR    RAVT,R15                 RESTORE AVT ADDRESS      Y02027 57545006
         LM    R11,R14,AVTSAVE2         RESTORE REGISTERS USED   Y02027 57549006
*                                       BY SETLOCK ROUTINE       Y02027 57553006
         LA    RDCB,SETBFTIC            LOOP ENTRY ADDRESS.      Y01004 57566005
         NC    LCBLSPCI(3),LCBLSPCI     FIRST TIME             @YA10024 57572009
         BNZ   NOTFIRST                 BRANCH-NO              @YA10024 57578009
         MVC   LCBLSPCI(3),AVTPARM+1    SET LAST PCI           @YA10024 57584009
NOTFIRST EQU   *                                               @YA10024 57590009
         CLM   R9,AD,LCBLSPCI           DOES LCBLSPCI POINT TO   X01004 57600005
*                                          THE 1ST UNIT OF THE   X01004 57630005
*                                       FIRST BUFFER             X01004 57660005
         BE    SETR2                    BRANCH IF YES - THIS IS  X01004 57680005
*                                          THE 1ST BUFFER IN THE X01004 57700005
*                                          CHAIN.                X01004 57730005
         L     R1,LCBLSPCI-ONE          R1 NOW HAS ADDR OF       X01004 57760005
*                                          THE LAST BUFFER       X01004 57800005
*                                          SERVICED BY PCI.      X01004 57850005
         LR    R2,R1                    COPY BUFFER ADDRESS      Y01004 57900005
LOOKATIT EQU   *                                                 Y01004 57910005
         TM    LCBCPA+TWELVE,XXXUSED+XXXCNCL CHANL PGM CHK       Y01004 57920005
         BNM   OPOK                     BRANCH NO                Y01004 57930005
         TM    LCBCPA+EIGHT,NOTTIC      IS THIS A TIC COMMAND  @YA08774 57931009
         BNZ   OPOK                     BRANCH-NO              @YA08774 57932009
         CLI   LCBCPA+ONESIX,OBAKER     3270 LOCAL DEVICE ?     OX03966 57933005
         BE    OPOK                     YES, BRANCH             OX03966 57936005
         MVI   PRFOPCDE-IEDQPRF(R2),AVTEZERO SET 0 OP CODE       Y01004 57940005
OPOK     EQU   *                                                        57950005
         EX    R1,TESTEND               CHECK FOR END OF CHAIN   X01004 58000005
         BNZ   FOUNDIT                  BRANCH IF FOUND          X01004 58050005
         LR    R2,R1                    ADDRESS TO R2            X01004 58100005
         ICM   R1,ALL,PRFTIC-IEDQPRF(R1) ADDRESS OF NEXT UNIT    X01004 58150005
         BNM   LOOKATIT                 BRANCH IF TIC OP CODE IS X01004 58200005
*                                       VIRTUAL - DON'T CONVERT. X01004 58208005
         LA    R1,0(,R1)                CLEAR HIGH ORDER FOR VS2 X01004 58216005
         L     R15,CVTADDR              CVT ADDRESS              X01004 58240005
         L     R15,CVTPTRV(,R15)        REAL TO VIRTUAL SUBROUT  X01004 58248005
*                                          VIRTUAL SUBROUTINE    X01004 58256005
         BALR  R14,R15                  CONVERT REAL TO VIRTUAL  X01004 58264005
         B     OPOK                     FIND LAST UNIT          OX02203 58300054
*                                                                Y01004 58400005
TESTEND  TM    TWOXX,0                  EXECUTED TM FOR END OF   Y01004 58430005
*                                       BUFFER CHAIN             Y01004 58460005
FOUNDIT  EQU   *                                                        58500020
         TM    LCBCPA+TWELVE,XXXUSED+XXXCNCL  IS THERE A PREVIOUSX01004 58510005
*                                       BUFFER TO LINK IN        X01004 58520005
         BNM   SETBFTIC                 BRANCH NOT CHANNEL PGM CHY01004 58540005
         CLI   LCBCPA+ONESIX,EAUCOM     3270 EAU COMMAND?      @OX11963 58543091
         BE    ENDLOOP                  YES-LINK IN VIRTUAL    @OX11963 58546091
         OI    PRFTIC-IEDQPRF(R2),CCWREAL SET REAL OP CODE              58550005
SETBFTIC EQU   *                                                        58600020
         TM    PRFTIC-IEDQPRF(R2),CCWREAL ARE REAL ADDRESSES IN  Y01004 58700005
         BZ    ENDLOOP                  BRANCH IF NO - DON'T     Y01004 58702005
*                                          CONVERT ADDRESSES IN  X01004 58704005
*                                          NEW BUFFER EITHER.    X01004 58706005
         LR    R5,R9                    SET UP ADDRESS OF FIRST  X01004 58708005
*                                          BUFFER UNIT FOR LOOP. X01004 58710005
         TM    LCBCPA+TWELVE,XXXUSED+XXXCNCL  IS THERE A PRE-    X01004 58712005
*                                       VIOUS BUFFER TO LINK IN  X01004 58714005
         BNO   LOOPREAL                 BRANCH IF NO.            X01004 58716005
         L     R5,LCBLSPCI-1            R5 = LCBLSPCI (FIRST     X01004 58718005
*                                       BUFFER TO TRANSLATE).    X01004 58720005
LOOPREAL EQU   *                        LOOP - INSERT REAL ADDRS X01004 58722005
         L     R7,AVTEZERO(,R5)         CONVERT PRFIOADR TO REAL X01004 58724005
         LRA   R7,AVTEZERO(,R7)            AND STORE IN LO-ORDER X01004 58726005
         STCM  R7,AD,ONE(R5)               THREE BYTES OF FIELD. X01004 58728005
         TM    PRFFLAGS-IEDQPRF(R5),CCWCC+CCWCD CHAINING SET     Y01004 58730005
         BZ    ENDLOOPR                 BRANCH NO DO NOT SET TIC Y01004 58732005
         L     R7,EIGHT(R5)             PUT REAL ADDRESS OF NEXT X01004 58734005
         LRA   R0,0(,R7)                REAL ADDRESS             Y01004 58736005
         STCM  R0,AD,PRFTIC+1-IEDQPRF(R5) LINK BUFFER IN CHAIN   Y01004 58738005
         OI    PRFTIC-IEDQPRF(R5),CCWREAL SET TIC OP CODE - REAL Y01004 58740005
         LR    R5,R7                    ADDRESS OF NEXT UNIT     Y01004 58750005
         EX    R5,TESTEND               IS THIS LAST UNIT        Y01004 58754005
         BZ    LOOPREAL                 BRANCH NO - CONTINUE     Y01004 58758005
ENDLOOPR EQU   *                                                 Y01004 58762005
         BALR  RDCB,0                   REAL ADDRS HAVE BEEN     Y01004 58766005
*                                       INSERTED                 Y01004 58770005
ENDLOOP  EQU   *                                                 Y01004 58774005
         LRA   R5,0(,R9)                CONVERT TO REAL          Y01004 58778005
         TM    PRFTIC-IEDQPRF(R2),CCWREAL ARE ADDRS REAL         Y01004 58782005
         BO    CHAINBUF                 BRANCH YES               Y01004 58786005
         LR    R5,R9                    USE VIRTUAL ADDRESS      Y01004 58790005
CHAINBUF EQU   *                                                 Y01004 58800005
         ICM   R5,EIGHT,PRFTIC-IEDQPRF(R2)  VIRT OR REAL TIC   @XA07478 58808061
*                                       VALUE                  @XA07478 58813061
         ST    R5,PRFTIC-IEDQPRF(R2)    UPDATE ENTIRE TIC CCW  @XA07478 58818061
*                                          LAST UNIT OF PREVIOUS X01004 58824005
*                                          BUFFER OR TIC OF      X01004 58832005
*                                          CHANNEL PGM. IN LCB.  X01004 58840005
         TM    PRFTIC-IEDQPRF(R2),CCWREAL CHAN PGM ACTIVE?           VM 58848006
         BNO   NOVIRT                   NO,BRANCH                    VM 58858006
         L     R15,AVTSAVTP             SECONDARY AVT POINTER        VM 58868006
         L     R15,SAVTDIAG-IEDNSVTD(0,R15) VM DIAG ROUTINE          VM 58878006
         LTR   R15,R15                  IN VM MACHINE ?              VM 58888006
         BZ    NOVIRT                   NO,BRANCH                    VM 58898006
         ST    R14,AVTSAVE2+TWELVE      SAVE REG 14                  VM 58908006
         LA    R0,PRFTIC-IEDQPRF(,R2)   ADDR OF TIC,                 VM 58918006
*                                       AN IEDQDA PARAMETER          VM 58928006
         ST    RLCB,AVTSAVE2            IEDQDA PARAMETER             VM 58938006
         BALR  R14,R15                  LET VM CHANGE REAL TIC       VM 58948006
*                                       SAME WAY AS VIRTUAL TIC      VM 58958006
*                                       WAS CHANGED                  VM 58968006
         L     R14,AVTSAVE2+TWELVE      RESTORE R14                     58978006
NOVIRT   EQU   *                                                        58988006
         TM    LCBCPA+12,XXXUSED+XXXCNCL     CHNL PGM CK AND TRETRY     59000020
         BZ    RSETLOCK                 IF NEITHER IS SET,CHANNL Y02027 59100006
*                                       PGM TRANSLATION COMPLETE Y02027 59150006
         BM    SETR2                    BR IF JUST CNL PGM CK           59200020
         SR    R9,R9                    CLEAR FOR ICM.           Y01004 59300005
         ICM   R9,AD,LCBLSPCI           GET ADDRESS OF BUFFER TO Y01004 59320005
*                                       LINK INTO THE LCB.       Y01004 59350005
SETR2    EQU   *                                                        59400020
         TM    LCBCHAIN,LCBEXCP         IS THIS A DEVICE WITH    A47126 59420022
*              NO WRITE IDLES/SYNC LOOP                          A47126 59440022
         BO    RSETLOCK                 IF LOCAL DEVICE, CHANNEL Y02027 59460006
*                                       PGM TRANSLATION COMPLETE Y02027 59480006
         NI    LCBCPA+12,AVTEFF-XXXUSED-XXXCNCL-CPASTART       @YA12276 59500091
*                                       CLEAR REF BITS         @YA08099 59550009
         LA    R2,LCBCPA                INITIALIZE                      59600020
         BR    RDCB                     BRANCH TO "SETBFTIC" IF  Y01004 59700005
*                                       REAL ADDRESSES HAVE NOT  X01004 59703005
*                                       BEEN INSERTED IN UNITS   X01004 59706005
*                                       BRANCH TO "ENDLOOPR" IF  Y01004 59709005
*                                          REAL ADDRS HAVE BEEN  X01004 59712005
*                                          INSERTED.             X01004 59715005
TWOXX    DC    X'02'                    MASK FOR EXECUTED TM     Y01004 59718005
         DS    0H                       BOUNDARY ALIGNMENT.      Y01004 59721005
RSETLOCK EQU   *                                                 Y02027 59724006
         STM   R11,R14,AVTSAVE2         SAVE REGISTERS USED BY   Y02027 59734006
*                                       SETLOCK ROUTINE          Y02027 59744006
         LR    R15,RAVT                 SAVE AVT ADDRESS         Y02027 59754006
RSETASSC SETLOCK RELEASE,TYPE=LOCAL,RELATED=CHANNEL PROGRAM,           X59764006
               IEDQGA(SETASSC)                                          59774006
         LR    RAVT,R15                 RESTORE AVT ADDRESS      Y02027 59784006
         LM    R11,R14,AVTSAVE2         RESTORE REGISTERS USED   Y02027 59794006
*                                       BY SETLOCK ROUTINE       Y02027 59804006
         MODESET EXTKEY=TCAM                                            59814006
*                                       RESET KEY TO TCAM'S KEY  Y02027 59824006
         MODESET MODE=PROB                                              59834006
*                                       RESET TO PROBLEM PROGRAM Y02027 59844006
*                                       MODE                     Y02027 59854006
         TM    LCBCHAIN,LCBEXCP         IS THIS A LOCAL DEVICE   Y02027 59864006
         BO    NOLOCAL                  YES BRANCH             @ZA00219 59874061
         CLI   LCBINCAM,AVTEFF          EXCP NEEDED             OY00507 59880006
         BCR   NOTEQ,R8                 NO, RETURN              OY00507 59886006
         MVI   LCBINCAM,AVTEZERO        RESET EXCP INDICATOR    OY00507 59892006
         B     BFREXCP                  GO DO EXCP              OY00507 59898006
NOLOCAL  EQU   *                                               @ZA00219 59901061
         TM    LCBCPA+12,XXXUSED        CHANNEL PROGRAM CHECK           59905020
         BCR   NO,R8                    BRANCH NO.               A47126 59910005
         LR    R2,R9                    SET BFR ADDR FOR EXCP    A47126 59912022
         SPACE                                                          59915020
         CLI   LCBCPA+ONESIX,OBAKER     SELECT CMD PRESENT?      S99228 59940022
         BE    YESOB                    YES, 3270 LOCAL DEVICE   S99228 59942022
         CLI   LCBCPA+ONESIX,EAUCOM     3270 EAU COMMAND?        S99228 59942622
         BE    NOOBAKER                 BRANCH YES               S99228 59943322
         TM    LCBCHAIN,LCBSCRNN        SCREEN REQUEST FOR 2260? S99228 59944022
         BNO   BFREXCP                  BRANCH IF NO             S99228 59946022
         B     DYNEXCP                  PERFORM EXCP            OX03966 59948005
YESOB    EQU   *                                                 S99228 59950022
         L     R2,LCBLSPCI-1            SET LCBSTART TO FIRST  @YA12276 59950691
*                                       BUFFER                 @YA12276 59951391
         ST    R2,LCBCPA+TWOFOUR        SET BUFFER ADDR IN TIC   S99228 59952022
         MVI   LCBCPA+TWOFOUR,XXXTIC    SET TIC OPCODE IN TIC    S99228 59954022
NOOBAKER EQU   *                                                 S99228 59956022
         TM    PRFSTAT1-IEDQPRF(R9),PRFNLSTN  LAST BUFFER       SA59970 59958422
         BCR   ONE,R8                   NO RETURN               SA59970 59959222
DYNEXCP  EQU   *                                                OX03966 59959605
         SPACE                                                          59960020
         LA    R2,LCBCPA+ONESIX         ADDR OF SELECT, NO-OP OR S99228 59980022
*                                         MODIFIED WRITE                60000020
BFREXCP  EQU   *                                                        60020020
         NI    LCBCPA+12,AVTEFF-XXXUSED-XXXCNCL-CPASTART       @YA12276 60030091
*                                       RESET CPC BIT          @YA08099 60040009
         NI    LCBCHAIN,AVTEFF-LCBSCRNN RESET SCREEN REQUEST BIT        60060020
         NI    SCBERR1,AVTEFF-SCBNOBFN  RESET INSUFFICIENT BUF @OS77863 60080091
         STCM  R2,AD,LCBSTART           SET START ADDRESS.       X01004 60100005
         LA    R1,LCBFLAG1              IOB ADDR                        60400020
         EXCPVR (1),SUBSYS                                       X01004 60500005
         BR    R8                       EXIT                            60600020
         SPACE 3                                                        60700020
*        THIS SUBROUTINE SETS UP CCW'S TO READ OR WRITE WITH            60800020
*        THE PROPER FLAGS SET (PCI, SLI, DC)                            60900020
         SPACE 1                                                        61000020
*        PCI OPTIONS ARE DEFINED AS FOLLOWS IN THE DCB.                 61100020
*        BL1'00001000'                  PCI RCV = N -- NO PIC           61200020
*        BL1'00000010'                  PCI RCV = R -- FREE ONLY        61300020
*        BL1'00100000'                  PCI RCV = A -- ADD BFRS         61400020
*        BL1'10000000'                  PCI RCV = X -- ADD ONLY  S22025 61450022
*        BL1'00000100'                  PCI SND = N                     61500020
*        BL1'00000001'                  PCI SND = R -- FREE ONLY        61600020
*        BL1'00010000'                  PCI SND = A -- ADD BFRS         61700020
*        BL1'01000000'                  PCI SND = X -- ADD ONLY  S22025 61750022
         SPACE 2                                                        61800020
SETCCWS  EQU   *                                                        61900020
         XC    AVTDOUBL+2(3),AVTDOUBL+2 CLEAR WORK AREA                 62000020
         MVI   AVTDOUBL+3,CCWCD+CCWSLI  SET CCW FLAGS                   62100020
         TM    LCBSTAT1,LCBSENDN        LINE SENDING                    62200020
         BNO   BUILDRD                  BR NO                           62300020
         MVI   AVTDOUBL,XXXWRITE                                        62400020
         TM    DCBPCI,XXXPCISD          PCI ON SEND SPECIFIED           62500020
         BNZ   SETPCI                   BR YES                          62600020
NOPCI    EQU   *                                                        62700020
         MVI   AVTDOUBL+1,XXXDCH+XXXSLI                                 62800020
         BR    R14                      RETURN                          62900022
         SPACE 1                                                        63000020
BUILDRD  EQU   *                                                        63100020
         MVI   AVTDOUBL,XXXREAD                                         63200020
         TM    LCBTSOB,LCBTSBUF         NON-TSO NEVER USE INHIBIT READ  63230020
         BZ    BUR                      CHECK FOR PCI SPECIFIED         63260022
         TM    LCBTSOB,LCBINHBN+LCB2741N CAN WE USE RD INHIBIT?     TSO 63340022
         BZ    BUR                      NO CHECK PCI                TSO 63420022
         MVI   AVTDOUBL,XXXINHIB        YES, MOVE IT INTO THE AVT   TSO 63500022
BUR      EQU   *                        CHECK FOR PCI SPECIFIED     TSO 63580022
         CLI   LCBRSKEY,LRSCHED         LOCAL RECEIVE SCHEDULER? S99228 63588022
         BNE   REGPCI                   NO LOCAL -NORMAL PCI SET S99228 63596022
         L     R2,LCBDCBPT              LOAD DCB POINTER         S99228 63604022
         L     R2,DCBDEBAD-IHADCB(R0,R2)    LOAD DEB ADDR        S99228 63612022
         L     R2,DEBUCBAD-DEBNMSUB(R0,R2)  LOAD UCB ADDR        S99228 63620022
         LA    R2,ONESIX(R0,R2)         INDEX TO UCBTYP FIELD    S99228 63628022
         CLI   THREE(R2),DEV2260        2260 DEVICE             OX05279 63636005
         BE    REGPCI                   YES, SET PCI            OX05279 63644005
         L     R3,LCBINVPT-ONE          LOAD INVLIST ADDR        S99228 63652022
         MVC   AVTDOUBL(ONE),ZEERO(R3)  SET READ COMMAND         S99228 63660022
         TM    DCBPCI,APCIRCV           A TYPE PCI ON RECEIVE?   S99228 63668022
         BO    NOPCI                    BRANCH IF YES - DON'T SETY01948 63676005
*                                       PCI FLAG FOR 3270 LOCAL. Y01948 63684005
REGPCI   EQU   *                                                 S99228 63692022
         TM    DCBPCI,XXXPCIRV           PCI ON RECV SPECIFIED          63700020
         BZ    NOPCI                    BR NO                           63800020
SETPCI   EQU   *                                                        63900020
         MVI   AVTDOUBL+1,XXXDCH+XXXSLI+XXXPCI                          64000020
*                       SET FLAGS WITH PCI                              64100020
         BR    R14                      RETURN                          64200022
         SPACE 3                                                        64300020
*        THIS SUBROUTINE BUILDS CCWS IN THE FIRST 3 WORDS OF THE        64400020
*        BUFFER - ALL UNITS - AND WILL SET UP READ/WRITE COMMAND        64500020
*        CODE, THE ADDRESS TO START, FLAGS, COUNTS, AND THE TIC         64600020
*        TO THE NEXT UNIT IF THERE IS ONE.                              64700020
         SPACE 2                                                        64800020
BLDCCWS  EQU   *                                                        64900020
         LA    R15,AVTDOUBL+1                                           65000020
         LH    R11,AVTKEYLE             LENGTH OF A UNIT - 12 BYTES     65100020
         SR    R7,R7                                                    65200020
         IC    R7,PRFNBUNT              NO. UNITS THIS BUFFER           65300020
         TM    PRFSTAT1,PRFCNCLN        IS THIS EOB RESTATR             65800020
         BO    EOBRETRY                 BR YES TO EOB ERROR             65900020
        LA    R2,PRFSHDR                                                66000020
         LA    R0,AVTHDRSZ                                              66100020
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HDR                   66200020
         BNO   FLAGS                    BR YES                          66300020
         LA    R2,PRFSTXT               ADDR TO START TD WR             66400020
         LA    R0,AVTTXTSZ              LENGTH- TXT PRF SIZE = CNT      66500020
FLAGS    EQU   *                        *                               66600022
         SR    R11,R0                   SUBTRACT LENGTH                 66700022
         SR    R0,R0                    CLEAR FOR IC.            Y01004 66800005
         TM    LCBTSOB,LCBTSBUF         TSO BUFFER               X02004 66808005
         BO    NOIDLES                  BRANCH IF YES - NO IDLES X02004 66816005
         TM    LCBSTAT1,LCBSENDN        IS LINE SENDING          Y01004 66824005
         BNO   RCVIDLE                  BRANCH IF NO.            Y01004 66832005
         TM    PRFSTAT1,PRFNHDRN        IS IT A HEADER BUFFER    Y01004 66840005
         BO    NOIDLES                  BRANCH IF NO - NO IDLES. Y01004 66848005
         IC    R0,LCBISZE               GET IDLES COUNT FROM LCB Y01004 66856005
         B     ADDSIZE                  GO ADD IT TO START ADDR. Y01004 66864005
RCVIDLE  EQU   *                        LINE NOT SENDING.        Y01004 66872005
         IC    R0,DCBRESER+ONE          GET IDLES COUNT FROM DCB Y01004 66880005
*                                       (ASSUME TEXT BUFFER).    Y01004 66888005
ADDSIZE  EQU   *                        ADD IT                          66900022
         AR    R2,R0                    ADD NO IDLES TO ADDRESS         67000020
         SR    R11,R0                                                   67200020
NOIDLES  EQU   *                                                 Y01004 67250005
         IC    R1,AVTDOUBL              OP CODE                         67300020
         TM    LCBSTAT1,LCBSENDN        SEND OPERATION                  67330020
         BNO   SETADDR                  IF NOT SEND - NO SCREEN         67360020
         TM    LCBCHAIN,LCBSCRNN        SCREEN FUNCTION NEEDED          67400020
         BNO   SETADDR                  BR NO                           67500020
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER        SA61743 67530005
         BO    SETADDR                  NO, USE CURRENT OP CODE SA61743 67560005
         IC    R1,PRFKEY                GET NEW OP CODE                 67600020
SETADDR  EQU   *                        GET BUFFER ADDRESS              67800022
         ST    R2,PRFIOADR-1            STORE IN BUFFER PREFIX          67900022
         LR    R3,RPREFIX               SAVE ADDRESS                    68000022
         B     FLAGS2                   BUILD BUFFER PREFIX             68100022
*                                                                       68200022
ADDUNITS EQU   *                        *                               68300022
         MVI   PRFTIC-IEDQPRF(R3),XXXTIC SET UP FOR TIC                 68400022
         L     R3,PRFTIC-IEDQPRF(R3)    PICK IT UP                      68500022
         LA    R2,PRFSUNIT-IEDQPRF(R3)  ADDR TO START RD WR             68600020
         LA    R15,AVTDOUBL+3           SET FOR CCW FLAGS               68700020
         LH    R11,AVTKEYLE             GET KEY LENGTH                  68800022
         B     STORE2                   SET UP PRF                      68900022
*                                                                       69000022
EOBRETRY EQU   *                        RETRY                           69100022
         OI    LCBCPA+12,XXXCNCL        SET EOBRETRY FLAG               69200020
         LR    R2,RPREFIX               BUFFER ADDRESS                  69300020
         L     RSCB,LCBSCBA-1           ADDR OF SCB                     69400022
         LH    R0,PRFSIZE               GET BUFFER LENGTH        S22025 69420022
         BCTR R0,0                      SET ONE CHAR TO BE SENT  S22025 69440022
         CLC   SCBEOB(2),PRFSIZE        RECALLED SHORTER THAN ORGS22025 69460022
         BH    TRUEOB                   YES, USE ONE CHAR COUNT  S22025 69480022
         LH    R0,SCBEOB                COUNT TO EOB                    69500020
TRUEOB   EQU   *                                                 S22025 69550022
         CH    R0,AVTKEYLE              MORE THAN 1 UNIT                69600020
         BNL   SKIPBCT                  NOT LOW DON'T DECREMENT         69700022
         LA    R2,AVTUMALN(R2)          UPDATE                          69800022
         B     ADDSIZE                  ADD NO IDLES TO ADDRESS         69900022
*                                                                       70000022
SUBTR1   EQU   *                        *                               70100022
         BCT   R7,MOREUNIT              BRANCH IF MORE UNITS   @OX12526 70200091
         B     CPC                      OUT OF BUFFERS         @OX12526 70230091
MOREUNIT EQU   *                                               @OX12526 70260091
         L     R2,PRFTIC-IEDQPRF(R2)      TIC ADDR                      70300020
         SH    R0,AVTKEYLE                                              70400020
SKIPBCT    EQU   *                                                      70500020
* COPY WRITE IDLES OR READ SKIP CCW INTO BUFFER.                 X01004 70600005
         MVC   PRFOPCDE-IEDQPRF(EIGHT,R2),LCBCPA                 X01004 70607005
         SR    R1,R1                    CLEAR FOR IC.            X01004 70614005
         L     RDCB,DCBSCTAD-ONE        RDCB = ADDRESS OF SCT.   X01004 70621005
* ASSUME WRITE IDLES, SINCE READ HAS SKIP FLAG ON ANYWAY.        X01004 70628005
         IC    R1,THREE(,RDCB)          R1 = OFFSET OF IDLES IN  X01004 70635005
*                                          SCT.                  X01004 70642005
         LA    R1,ONE(R1,RDCB)          R1 = VIRTUAL ADDRESS OF  X01004 70649005
*                                          IDLES.                X01004 70656005
         STCM  R1,AD,PRFIOADR-IEDQPRF(R2)  PUT ADDRESS OF IDLES  X01004 70663005
*                                          INTO CCW.             X01004 70670005
         NI    PRFFLAGS-IEDQPRF(R2),AVTEFF-CCWCC  SET OFF COM-   X01004 70677005
*                                          MAND CHAINING IN CCW. X01004 70684005
         L     RDCB,LCBDCBPT            RESTORE DCB POINTER.     X01004 70691005
         MVI   PRFTIC-IEDQPRF(R2),CCWTIC                                70700020
         CH    R0,AVTKEYLE                                              70800020
         BNL   SUBTR1                   BRANCH FOR NEXT UNIT   @OX12526 70900091
CPC      EQU   *                                               @OX12526 70950091
         LR    R1,R2                                                    71000020
         AR    R2,R0                    ADDRESS OF ETB -12              71100020
         LA    R2,AVTUMALN(R2)          + 12                            71200020
         CLC   PRFSIZE(2),SCBEOB        IS EOB THE LAST CHAR. OF BFR    71300020
         LR    R3,R1                    UNIT ADDR IN 3                  71350020
         BE    NOFIX                    BR YES                   S22025 71400022
          IC    R1,AVTDOUBL             OP CODE                         71500020
         SR    R11,R0                   NEW COUNT                       71600020
STORE2   EQU   *                        *                               71700022
         ST    R2,PRFIOADR-1-IEDQPRF(R3) STORE IT                       71800022
FLAGS2   EQU   *                        *                               71900022
         STH   R11,PRFCOUNT-IEDQPRF(R3) STORE COUNT                     72000022
         STC   R1,PRFOPCDE-IEDQPRF(R3)  STORE OP CODE                   72100022
         MVC   PRFFLAGS-IEDQPRF(2,R3),0(R15) MOVE IT                    72200022
SAMEFLAG EQU   *                                                 S99228 72275022
         BCT   R7,ADDUNITS              IS THERE ANOTHER UNIT           72300022
         LH    R2,PRFSIZE               SIZE OF DATA                    72500020
         CLI   AVTDOUBL,XXXWRITE                                        72700020
         BE    SUBTR                    BR IF WRITE                     73500020
         SPACE 1                                                        74400020
         LH    R2,DCBBUFSI              GET BUFFER SIZE                 74600022
*                                                                       74800022
SUBTR    EQU   *                        *                               75000022
         SH    R2,AVTKEYLE              SUBTRACT KEY LENGTH             75200022
         BP    SUBTR                    IF HIGH, TRY IT AGAIN           75400022
         BZ    NOFIX                    THIS IS THE ONE                 75600022
         LH    R11,AVTKEYLE                                             76400020
         AR    R2,R11                   ADJUST COUNT OF DATA.    Y01004 76450005
         SR    R11,R2                   AMOUNT NOT TO WRITE             76500020
         LH    R2,PRFCOUNT-IEDQPRF(R3)   AMOUNT TO WRITE NOW            76600020
         SR    R2,R11                   NEW AMOUNT TO WIRTE             76700020
         STC    R2,PRFCOUNT+1-IEDQPRF(R3)                               76900020
NOFIX    EQU   *                                                        77000020
         MVI    PRFTIC+3-IEDQPRF(R3),2                                  77100020
         MVI   PRFTIC-IEDQPRF(R3),XXXTIC                                77200020
         LTR   R9,R9                    DO WE HAVE ONE                  77300022
         BCR   2,R14                    BRANCH IF SO                    77400022
         MVI    PRFFLAGS-IEDQPRF(R3),CCWSLI   YES-FLAGS OFF             77500020
         LPR   R9,R9                    INSURE POSITIVE VALUE           77600022
         BR    R14                      RETURN                          77700022
         SPACE 2                                                        77704005
GDCONC   EQU   *                        CONCENTRATOR CODE.       Y01004 77708005
         MODESET MODE=SUP                                               77712006
*                                       GET INTO SUPERVISOR MODE Y02027 77714006
         MODESET EXTKEY=SUPR                                            77716006
*                                       GET INTO SUPERVISOR KEY  Y02027 77718006
         L     R14,AVTSAVTP             SECONDARY AVT POINTER    Y05331 77720005
         L     R14,SAVTDIAG-IEDNSVTD(0,R14)  VM DIAGNOSE ROUTINE Y05331 77721005
         LR    R0,R14                   SAVE DIAGNISE ROUTNE ADDRY05331 77722005
         STM   R11,R14,AVTSAVE2         SAVE REGISTERS USED BY   Y02027 77723006
*                                       SETLOCK ROUTINE          Y02027 77728006
         LR    R15,RAVT                 SAVE AVT ADDRESS         Y02027 77733006
SETCONC  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=CHANNEL PROGRAM,X77738006
               IGE0004G(SETERP),IGE0004H(SETERP),IGG019QE(SETERP),     X77743006
               IEDQGT(SETTRAN), 'PCI LINEEND AND START I/O APPENDAGES  X77748006
               ARE LOCKED ON THIS REAOURCE THRU THE EXCP PROCESSOR     X77753006
               ISSUING SETLOCK (ERP,BUFFER ASSOCIATION AND TRANSPARENT X77758006
               CCW BUILD MUST ISSUE SETLOCK'                            77763006
         LR    RAVT,R15                 RESTORE AVT ADDRESS      Y02027 77768006
         LM    R11,R14,AVTSAVE2         RESTORE REGISTERS USED   Y02027 77773006
*                                       BY SETLOCK ROUTINE       Y02027 77778006
         LR    R11,R9                   FIRST BUFFER ADDR IN R11 Y01004 77788005
         LA    R2,LCBCPA                ASSUME CURRENT BUFFER IS Y01004 77792005
*                                       THE FIRST BUFFER.        Y01004 77796005
         NC    LCBLSPCI(3),LCBLSPCI     FIRST TIME             @YA10024 77796809
         BNZ   NOTFIRS2                 BRANCH-NO              @YA10024 77797609
         MVC   LCBLSPCI(3),AVTPARM+1    SET LAST PCI           @YA10024 77798409
NOTFIRS2 EQU   *                                               @YA10024 77799209
         CLM   R9,AD,LCBLSPCI           IS CURRENT BUFFER THE    Y01004 77800005
*                                       FIRST BUFFER             Y01004 77804005
         BE    CHAIN                    BRANCH IF YES            Y01004 77808005
         L     R1,LCBLSPCI-1            R1 = ADDR. OF FIRST BUFFEY01004 77812005
LOOK     EQU   *                                                 Y01004 77816005
         EX    R1,CNCTM                 PREVIOUS UNIT END OF CHN.Y01004 77820005
         BO    FOUND                    BRANCH IF YES            Y01004 77824005
         LR    R2,R1                    COPY CURRENT UNIT ADDR.  Y01004 77828005
         ICM   R1,ALL,PRFTIC-IEDQPRF(R1) ADDRESS OF NEXT UNIT    Y01004 77832005
         BNM   LOOK                     BRANCH IF TIC IS VIRTUAL Y01004 77836005
         LA    R1,0(,R1)                CLEAR HIGH ORDER FOR VS2 Y01004 77840005
         L     R15,CVTADDR              CVT ADDRESS              Y01004 77852005
         L     R15,CVTPTRV(,R15)        REAL TO VIRTUAL SUBROUT  Y01004 77856005
*                                       FROM CVT.                Y01004 77860005
         BALR  R14,R15                  CONVERT REAL TO VIRTUAL. Y01004 77864005
         B     LOOK                     GO FIND LAST UNIT.       Y01004 77876005
FOUND    EQU   *                                                 Y01004 77880005
         TM    PRFTIC-IEDQPRF(R2),CCWREAL ARE ADDRS REAL         Y01004 77900005
         BZ    INCHAIN                  BRANCH NO - VIRTUAL      Y01004 77907005
         LR    R5,R11                   ADDRESS OF FIRST UNIT.   Y01004 77914005
CONCLOOP EQU   *                                                 Y01004 77921005
         L     R1,PRFOPCDE-IEDQPRF(,R5)  GET VIRTUAL I/O ADDRESS Y01004 77928005
         LRA   R1,NILL(,R1)             MAKE IT A REAL ADDRESS.  Y01004 77935005
         STCM  R1,AD,PRFIOADR-IEDQPRF(R5)  PUT REAL ADDR IN UNIT Y01004 77942005
         TM    PRFFLAGS-IEDQPRF(R5),CCWCC+CCWCD CHAINING SET     Y01004 77949005
         BZ    TICTO                    BRANCH NO DO NOT SET TIC Y01004 77956005
         OI    PRFTIC-IEDQPRF(R5),CCWREAL SET REAL OP CODE       Y01004 77963005
         L     RDCB,PRFTIC-IEDQPRF(,R5) SAVE VIRTUAL TIC ADDRESS Y01004 77970005
         LRA   R1,NILL(,RDCB)           MAKE TIC ADDRESS REAL.   Y01004 77977005
         STCM  R1,AD,PRFTIC+1-IEDQPRF(R5) SET REAL ADDR          Y01004 77984005
         LR    R5,RDCB                  GET VIRTUAL ADDRESS OF   Y01004 77991005
*                                       NEXT UNIT.               Y01004 78000005
         EX    R5,CNCTM                 END OF BUFFER CHAIN      Y01004 78001005
         BZ    CONCLOOP                 BRANCH NO - CONTINUE     Y01004 78002005
TICTO    EQU   *                                                 Y01004 78003005
         TM    PRFTIC-IEDQPRF(R2),CCWREAL ARE ADDRS REAL         Y01004 78004005
         BZ    INCHAIN                  BRANCH NO - USE VIRTUAL  Y01004 78005005
         LRA   R11,0(,R11)              CONVERT TO REAL          Y01004 78006005
INCHAIN  EQU   *                                                 Y01004 78007006
         STCM  R11,AD,PRFTIC+1-IEDQPRF(R2)  CHAIN BUFFER         Y01004 78007106
*                                       CHANNEL PROGRAM          Y01004 78007206
         TM    PRFTIC-IEDQPRF(R2),CCWREAL IS CHAN PROG ACTIVE?       VM 78007306
         BZ    CHAIN                    NO,BRANCH                    VM 78007406
         L     R15,AVTSAVTP             SECONDARY AVT PTR            VM 78007506
         L     R15,SAVTDIAG-IEDNSVTD(0,R15) VM DIAG ROUTINE          VM 78007606
         LTR   R15,R15                  IN VM MACHINE ?              VM 78007706
         BZ    CHAIN                    NO,BRANCH                    VM 78007806
         LR    R5,R14                   SAVE REG 14                  VM 78007906
         LA    R0,PRFTIC-IEDQPRF(,R2)   TIC ADDR,IEDQDA PARAMETER    VM 78008006
         ST    RLCB,AVTSAVE2            CURRENT LCB ADDR  ''         VM 78008106
         BALR  R14,R15                  LET VM CHANGE REAL TIC       VM 78008206
*                                       SAME WAY AS VIRTUAL TIC      VM 78008306
*                                       WAS CHANGED                  VM 78008406
         LR    R14,R5                   RESTORE REG 14               VM 78008506
CHAIN    EQU   *                                                 Y01004 78010005
         L     R5,LCBSCBDA-ONE          GET LINE SCB ADDRESS.    Y01004 78011005
         TM    SCBSTAT1-IEDQSCB(R5),SCBNIDLE  ARE WE READY TO    Y01004 78012005
*                                       LINK BUFFERS TO WRITE    Y01004 78013005
*                                       IDLES LOOP               Y01004 78014005
         BO    RESETLOK                 IF NO, RESET LOCAL LOCK  Y02027 78015006
         LA    R2,LCBCPA                ADDR OF WRITE IDLES LOOP Y01004 78016005
         LR    R1,R2                    COPY IT INTO R1.         Y01004 78017005
         TM    LCBCPA+FOUR,CCWCC+CCWCD  IS WRITE IDLES LOOP REAL Y01004 78018005
         BNO   CHKLOOP                  BRANCH IF NO.            Y01004 78019005
         LRA   R1,NILL(,R2)             MAKE LCBCPA ADDRESS REAL Y01004 78020005
CHKLOOP  EQU   *                                                 Y01004 78021005
         CLM   R1,AD,LCBCPA+NINE        DOES WRITE IDLES LOOP    Y01004 78022005
*                                       TIC TO A BUFFER OR TO    Y01004 78023005
*                                       ITSELF                   Y01004 78024005
         BNZ   RESETLOK                 RESET LOCAL LOCK IF IT   Y02027 78025006
*                                       TIC'S TO A BUFFER.       Y01004 78026005
         ICM   R11,AD,LCBLSPCI          GET ADDR. OF 1ST BUFFER. Y01004 78027005
         ICM   R9,AD,AVTFZERO           CLEAR CURRENT BUFFER ADDRY01004 78028005
         NI    LCBCPA+12,AVTEFF-XXXUSED-XXXCNCL-CPASTART       @YA12276 78029091
*                                       CLEAR RET BITS         @YA08099 78029509
         B     FOUND                    GO CHAIN IN BUFFER(S).   Y01004 78030005
CNCTM    TM    CCTWO,0                  TEST FOR END OF CHAIN    Y01004 78031005
CCTWO    DC    X'02'                    FOR EXECUTED TM          Y01004 78032005
         SPACE                                                          78033005
RESETLOK DS    0H                                                Y02027 78034006
         LR    R15,RAVT                 SAVE AVT ADDRESS         Y02027 78044006
         STM   R11,R14,AVTSAVE2         SAVE REGISTERS USED BY   Y02027 78054006
*                                       SETLOCK ROUTINE          Y02027 78064006
RSETCONC SETLOCK RELEASE,TYPE=LOCAL,RELATED=CHANNEL PROGRAM,           X78074006
               IEDQGA(SETCONC)                                          78084006
         LR    RAVT,R15                 RESTORE AVT ADDRESS      Y02027 78094006
         LM    R11,R14,AVTSAVE2         RESTORE REGISTERS USED   Y02027 78104006
*                                       BY SETLOCK ROUTINE       Y02027 78114006
         MODESET EXTKEY=TCAM                                            78124006
*                                       REAET KEY TO TCAM'S KEY  Y02027 78134006
         MODESET MODE=PROB                                              78144006
*                                       RESET TO PROBLEM PROGRAM Y02027 78154006
*                                       MODE                     Y02027 78164006
         L     R5,LCBSCBDA-ONE          GET LINE SCB ADDRESS.    Y01004 78200005
         SR    R1,R1                    CLEAR FOR IC.            S22026 78220005
         IC    R1,AVTCSCH               GET OFFSET TO IEDQGH.    S22026 78226005
         L     R8,AVTMSGS-ONE           GET POINTER TO OPTIONAL  S22026 78232005
*                                       VCON TABLE.              S22026 78240005
         L     R8,NILL(R1,R8)           GET ADDRESS OF IEDQGH.   S22026 78245005
         AH    R8,FOUR(,R8)             ADD OFFSET TO SCBEOB     Y01004 78250005
*                                       SAVE AREA WITHIN IEDQGH. Y01004 78255005
         LH    R1,NILL(,R8)             GET NEW SCBEOB OFFSET    Y01004 78260005
*                                       SAVED IN IEDQGH.         Y01004 78266005
         AH    R1,SCBCTBAC              ADD AMOUNT OF DATA       Y01004 78272005
*                                       INSERTED.                Y01004 78280005
         STH   R1,SCBEOB                UPDATE SCBEOB.           Y01004 78286005
         XC    SCBCTBAC,SCBCTBAC        CLEAR COUNT OF DATA      Y01004 78292005
*                                       INSERTED.                Y01004 78298005
         XC    NILL(TWO,R8),NILL(R8)    CLEAR SCBEOB OFFSET IN   Y01004 78304005
*                                       IEDQGH.                  Y01004 78310005
         NI    SCBSTAT1-IEDQSCB(R5),AVTEFF-SCBCBGN  RESET CONC.  Y01004 78316005
*                                       MESSAGE BEGIN FLAG.      Y01004 78322005
         NI    SCBCTBFL,AVTEFF-SCBCTBND  RESET CTB END FLAG.     Y01004 78328005
         NI    SCBQTYPE-IEDQSCB(R5),SCBCONC  RESET TEMPORARY     Y01004 78334005
*                                       CONCENTRATOR FLAG IN     Y01004 78340005
*                                       LINE SCB.                Y01004 78347005
         L     R11,AVTEA                GET DISPATCHER ADDRESS.  Y01004 78354005
         MVI   LCBPCILK,ZEERO           CLEAR PCI LOCK FOR MP    Y02027 78357006
         B     DSPDISP                  EXIT TO DISPATCHER.      Y01004 78361005
SETUP    EQU   *                                               @YA10024 78391009
         NC    LCBLSPCI(3),LCBLSPCI     FIRST TIME             @YA10024 78421009
         BCR   7,R8                     BRANCH-NO              @YA10024 78451009
         MVC   LCBLSPCI(3),AVTPARM+1    SET LAST PCI           @YA10024 78481009
         BR    R8                       RETURN                 @YA10024 78511009
         SPACE 3                                                        78600020
PCIADDXR EQU   X'80'                    PCI = X ON RECEIVE       S22025 78750022
BASE     DC    A(BFRREQ)                BASE OF MODULE                  78800022
WRTCOM   DC    X'01'                    WRT CMD FOR 3270         S99228 78900022
         DROP  RPREFIX                                         @G36XRPV 78900600
         EJECT                                                          78901200
         TITLE '''IEDQGA02'' -  BUFFER STEAL ROUINE'           @G36XRPV 78901800
IEDQGA02 DS    0H                                              @G36XRPV 78902400
*********************************************************************** 78903000
*                                                                     * 78903600
* MODULE NAME        IEDQGA02                                         * 78904200
* DSCRIPTIVE NAME    BUFFER STEAL ROUTINE                             * 78904800
* COPYRIGHT          NONE                                             * 78905400
* STATUS             VERSION I.0 CHANGE LEVEL 10                      * 78906000
*                                                                     * 78906600
* FUNCTION  THIS ROUTINE IS LINKED TO BY TCAM MODULES WHICH REQUIRE   * 78907200
*   BUFFERS WITHOUT POSTING AN ERB TO THE BUFFER REQUEST QUEUE.       * 78907800
*           THE NUMBER OF UNITS/BUFFER ARE PASSED IN REISTER 0 AND    * 78908400
*   THE NUMBER OF BUFFERS IN REGISTER 1.  IF THE REQUESTED AMOUNT     * 78909000
*   OF UNITS ARE NOT AVAILABLE, A BAD RETURN CODE IS PASSED.  EACH    * 78909600
*   BUFFER HAS PRFNBUNT, PRFNHDRN, PRFNLSTN, PRFLINK, AND PRFTIC      * 78910200
*   SET TO THE APPROPRIATE VALUE.  THE LAST UNIT OF EACH BUFFER HAS   * 78910800
*   AN INVALID LINK FIELD TO THE NEXT UNIT.                           * 78911400
*                                                                     * 78912000
* REGISTER CONVENTIONS: SEE EQUATES                                   * 78912600
*                                                                     * 78913200
* ENTRY POINT: IEDQGA02                                               * 78913800
*                                                                     * 78914400
* LINKAGE: LINKED TO VIA USE OF ADDRESS IN AVT (AVTSTEAL)             * 78915000
*                                                                     * 78915600
* INPUT:  R0  NUMBER OF UNITS PER BUFFER                              * 78916200
*         R1  NUMBER OF BUFFER REQUIRED                               * 78916800
*         R13 REG SAVE AREA ADDRESS                                   * 78917400
*         R14 RETURN ADDRESS                                          * 78918000
*         R15 ROUTINE ADDRESS                                         * 78918600
*                                                                     * 78919200
* OUTPUT: ALL REGISTER ARE RESTORED EXCEPT FOR R15                    * 78919800
*         R15 = ADDRESS OF BUFFER CHAIN REQUESTED                     * 78920400
*             = 0 IF NUMBER OF UNITS REQUESTED ARE NOT AVAILABLE      * 78921000
*                                                                     * 78921600
* EXIT:   NORMAL - R14                                                * 78922200
*                                                                     * 78922800
* ROUTINES: NONE                                                      * 78923400
*                                                                     * 78924000
* CONTROL BLOCKS: AVT, TCX, QCB, PRF                                  * 78924600
*                                                                     * 78925200
*********************************************************************** 78925800
         EJECT                                                          78926400
*R0      EQU   0                        NUM OF UNITS PER BUFF  @G36XRPV 78927000
*R1      EQU   1                        NUMBER OF BUFFERS      @G36XRPV 78927600
RUNT     EQU   2                        ADDRESS TO CURRENT UNIT@G36XRPV 78928200
RUNTP    EQU   3                        ADDRESS TO PREVIOUS UNT@G36XRPV 78928800
RUNTC    EQU   4                        COUNTER FOR NUM OF UNTS@G36XRPV 78929400
RBUF     EQU   5                        ADRESS TO CURRENT BUFF @G36XRPV 78930000
RBUFP    EQU   6                        ADRESS TO PREVIOUS BUFF@G36XRPV 78930600
*R6      EQU   6                        WORK REG               @G36XRPV 78931200
RBUFC    EQU   7                        CNT FOR NUMBER OF BUF  @G36XRPV 78931800
*R7      EQU   7                        WORK REG               @G36XRPV 78932400
RRQCB    EQU   8                        ADDRESS TO QCB         @G36XRPV 78933000
RRAVT    EQU   8                        ADDRESS TO AVT         @G36XRPV 78933600
RTCX     EQU   8                        ADDRESS TO TCX         @G36XRPV 78934200
R13      EQU   13                       REG SAVE AREA ADDR     @G36XRPV 78934800
*R14     EQU   14                       RETURN ADDR            @G36XRPV 78935400
RR15     EQU   15                       RETURN CODE OR BUF ADDR@G36XRPV 78936000
         SPACE 1                                               @G36XRPV 78936600
ADDR     EQU   7                        ADDRESS INDICATOR      @G36XRPV 78937200
         EJECT                                                 @G36XRPV 78937800
         USING IEDQGA02,RBASE                                  @G36XRPV 78938400
         STM   14,12,12(R13)            SAVE REGISTERS         @G36XRPV 78939000
         LR    RBASE,RR15               SET BASE               @G36XRPV 78939600
IEDQGA02 IEDHJN START                   IDENTIFICATION MACRO   @G36XRPV 78940200
         SPACE 1                                               @G36XRPV 78940800
*                                                              @G36XRPV 78941400
*        GET AVT ADDRESS                                       @G36XRPV 78942000
*                                                              @G36XRPV 78942600
         L     RTCX,CVTADDR             GET TCX ADDR           @G36XRPV 78943200
         L     RTCX,AVTCVTPT(RTCX)       VIA CVT               @G36XRPV 78943800
         USING IEDQTCX,RTCX                                    @G36XRPV 78944400
         L     RRAVT,TCXAVT             GET AVT ADDR FROM TCX  @G36XRPV 78945000
         DROP  RTCX                                            @G36XRPV 78945600
         SPACE 1                                               @G36XRPV 78946200
*                                                              @G36XRPV 78946800
*        CHECK AVAILABILTY OF UNITS                            @G36XRPV 78947400
*                                                              @G36XRPV 78948000
         DROP  RAVT                                            @G36XRPV 78948600
         USING IEDQAVTD,RRAVT                                  @G36XRPV 78949200
         SLR   RR15,RR15                SET ERROR RETURN CODE  @G36XRPV 78949800
         LR    R7,R0                    R6 = NO. UNIT/BUFFER   @G36XRPV 78950400
         MR    R6,R1                    R7 = TOTAL UNITS       @G36XRPV 78951000
         LTR   R6,R6                    IF TOTAL IS NEG OR TOO @G36XRPV 78951600
         BNZ   RSETNLST                 BIG, GIVE BAD RTN CODE @G36XRPV 78952200
         LH    R6,AVTAVFCT              R6 = NUM OF FREE UNITS @G36XRPV 78952800
         SR    R6,R7                    IF NUM REQ IS GREATER  @G36XRPV 78953400
         BNP   RSETNLST                  THAN AVAIL BUFF MINUS @G36XRPV 78954000
         CH    R6,AVTDSKCT               NUM OF CPB, GIVE BAD  @G36XRPV 78954600
         BL    RSETNLST                  RETURN CODE           @G36XRPV 78955200
         SPACE 1                                               @G36XRPV 78955800
*                                                              @G36XRPV 78956400
*        GET ADDRESS OF FIRST FREE UNIT                        @G36XRPV 78957000
*                                                              @G36XRPV 78957600
         STH   6,AVTAVFCT               UPDATE AVAILABLE UNITS @G36XRPV 78958200
         LA    RRQCB,AVTBFREB           GET ADDR TO BUFFER POOL@G36XRPV 78958800
         DROP  RRAVT                                           @G36XRPV 78959400
         USING IEDQQCB,RRQCB                                   @G36XRPV 78960000
         ICM   RR15,ADDR,QCBELCHN       GET ADDR TO 1ST FREE UT@G36XRPV 78960600
         EJECT                                                 @G36XRPV 78961200
*                                                              @G36XRPV 78961800
*        BUILD THE BUFFER CHAIN                                @G36XRPV 78962400
*                                                              @G36XRPV 78963000
         LR    RUNT,RR15                UPDATE UNIT ADDR REG   @G36XRPV 78963600
         LR    RBUFC,R1                 UPDATE BUFFER CTR REG  @G36XRPV 78964200
         SR    RBUFP,RBUFP              INITIAL PREV UNT ADDR  @G36XRPV 78964800
CHKBCNT  EQU   *                                               @G36XRPV 78965400
         BAL   R14,GETBUF               GO RETREIVE A BUFFER   @G36XRPV 78966000
         USING IEDQPRF,RBUF                                    @G36XRPV 78966600
         STC   R0,PRFNBUNT              STORE NUMBER OF UNITS  @G36XRPV 78967200
         SR    R14,R14                  ZERO REGISTER          @G36XRPV 78967800
         STH   R14,PRFSRCE              CLEAR PRFSRCE          @G36XRPV 78968400
         STH   R14,PRFSIZE              CLEAR PRFSIZE          @G36XRPV 78969000
         MVI   PRFSTAT1,PRFNHDRN+PRFNLSTN NOT A HDR BUFFER OR T@G36XRPV 78969600
*                                           LAST BUFFER        @G36XRPV 78970200
         DROP  RBUF                                            @G36XRPV 78970800
         SPACE 1                                               @G36XRPV 78971400
         LTR   RBUFP,RBUFP              DOES A PREV BUF EXIST  @G36XRPV 78972000
         BZ    RSETBUFP                 IF NOT, BRANCH         @G36XRPV 78972600
         USING IEDQPRF,RBUFP                                   @G36XRPV 78973200
         STCM  RBUF,ADDR,PRFLINK        PLACE CURRENT BUF ADDR @G36XRPV 78973800
*                                        IN PREV BUFFER HEADER @G36XRPV 78974400
         DROP  RBUFP                                           @G36XRPV 78975000
RSETBUFP EQU   *                                               @G36XRPV 78975600
         LR    RBUFP,RBUF               UPDATE PREV BUF ADDR   @G36XRPV 78976200
         BCT   RBUFC,CHKBCNT            BRANCH TO BUILD MORE   @G36XRPV 78976800
         SPACE 1                                               @G36XRPV 78977400
*                                                              @G36XRPV 78978000
*        FINISH REQUEST FOR BUFFERS                            @G36XRPV 78978600
*                                                              @G36XRPV 78979200
RSETNLST EQU   *                                               @G36XRPV 78979800
         L     14,12(R13)               RELOAD REGISTER 14     @G36XRPV 78980400
         LM    0,12,20(R13)             REMAINING REGS         @G36XRPV 78981000
         BR    R14                      RETURN TO REQUESTOR    @G36XRPV 78981600
         EJECT                                                 @G36XRPV 78982200
*                                                              @G36XRPV 78982800
*        BUILD A BUFFER                                        @G36XRPV 78983400
*                                                              @G36XRPV 78984000
GETBUF   EQU   *                                               @G36XRPV 78984600
         LR    RBUF,RUNT                INIT ADDR TO BUFFER    @G36XRPV 78985200
         LR    RUNTC,R0                 SET UNIT COUNTER       @G36XRPV 78985800
CHKUCNT  EQU   *                                               @G36XRPV 78986400
         USING IEDQPRF,RUNT                                    @G36XRPV 78987000
         MVC   QCBELCHN,PRFLINK         UPDATE UNIT FREE QCB   @G36XRPV 78987600
         DROP  RUNT                                            @G36XRPV 78988200
         LR    RUNTP,RUNT               UPDATE PREV UNIT ADDR  @G36XRPV 78988800
         USING IEDQPRF,RUNTP                                   @G36XRPV 78989400
         ICM   RUNT,ADDR,PRFLINK        UPDATE CURR UNIT ADDR  @G36XRPV 78990000
         XC    PRFLINK,PRFLINK          INITIALIZE BUF LINKAGE @G36XRPV 78990600
         ST    RUNT,PRFTIC              SET UNIT LINKAGE       @G36XRPV 78991200
         MVI   PRFTICC,PRFTICON         SET TIC COMMAND        @G36XRPV 78991800
         BCT   RUNTC,CHKUCNT            DECREMENT UNIT COUNTER @G36XRPV 78992400
*                                        AND BRCH IF MORE REQ  @G36XRPV 78993000
MAKTIC02 EQU   *                                               @G36XRPV 78993600
         MVC   PRFTIC,TIC02             MAKE UNIT LINK INVALID @G36XRPV 78994200
         DROP  RUNTP                                           @G36XRPV 78994800
         BR    R14                      RETURN TO MAIN ROUTINE @G36XRPV 78995400
         DS    0F .                                            @G36XRPV 78996000
TIC02    DC    XL4'08000002' .          INVALID TIC VALUE      @G36XRPV 78996600
         EJECT                                                          79000020
******** DSECTS ********                                                79100020
         SPACE 3                                                        79200020
         TPRIOR                                                         79400020
         EJECT                                                          79410006
         IHAPSA                                                         79420006
         EJECT                                                          79450005
         TCCWD                                                          79500020
XXXDCH   EQU   CCWCD                                                    79600020
XXXSLI   EQU   CCWSLI                                                   79700020
XXXPCI   EQU   CCWPCI                                                   79800020
XXXTIC   EQU   CCWTIC                                                   79900020
XXXWRITE EQU   CCWWRITE                                                 80000020
XXXREAD  EQU   CCWREAD                                                  80100020
         EJECT                                                          80200005
         DCBD  DSORG=TX                                                 80300020
         EJECT                                                          80350005
         TQCBD                                                          80400020
         EJECT                                                          80450005
         TDISPD                                                         80500020
         EJECT                                                          80550005
         TPRFD                                                          80600020
         EJECT                                                          80650005
         TLCBD                                                          80700020
         EJECT                                                          80750005
         TSCBD                                                          80800020
         EJECT                                                 @G36XRPV 80810000
         TTCXD                                                 @G36XRPV 80820000
         EJECT                                                          80850005
         TAVTD                                                          80900005
         TDEBD                                                   S99228 80950022
         END                                                            81000020
