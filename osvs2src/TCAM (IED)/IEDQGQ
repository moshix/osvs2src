         TITLE 'IEDQGQ - QUEUE RESET EXECUTOR'                          00200022
IEDQGQ   CSECT                                                          00400022
*CHANGE ACTIVITY AS FOLLOWS:                                            00400122
*D338000-339000                                                 SA51078 00400222
*A338000-339200                                                 SA51078 00400322
*A028200-029200,125000,159000,183000                            SA51783 00400422
*D449000-456000                                                 SA51783 00400522
*A449000-453000,457300-457600                                   SA51783 00400622
*C587000                                                        SA51783 00400722
*A587020-587780,642200-642800                                   SA51783 00400822
*A014500-015500,024400-025600,074000-078000,090600-091200,108200-Y02027 00401006
*A109800,125500,173000,201000,224100-225900,226100-228000,228200-Y02027 00401206
*A2311008230300-232400,319500,331200-331600,362500,562020-562090,Y02027 00401406
*A562110-562190,562210-562290,562310-562390,562410-562490,562510-Y02027 00401606
*A562570,563100-563700,564860-564880,613500,614500,615500,616500,Y02027 00401806
*A634100-634700,303500,326600-327200,355500,392500,506500,586030-Y02027 00402006
*A586930,618500,634330-634360                                    Y02027 00402206
*C034000,072000-074000,108000,216000,224000-234000,256000-260000,Y02027 00402406
*C346000,354000,391000,562000-562500,562900,613000-616000        Y02027 00402606
*C303000,355000,392000                                           Y02027 00402806
*D036000-042000,046000-052000,074700-081700,234000,242000-244000,Y02027 00403006
*D262000-263000,302000,327000,390000,528300-558000,562000-562500,Y02027 00403206
*D563000-564000,592000,597000-599000,604000,607000,611000,624300-Y02027 00403406
*D633000                                                         Y02027 00403606
*A448000                                                       @SA74546 00433609
*C508200-508400                                                @SA74546 00463609
*A406000                                                       @YA09721 00493609
*C407000,413000,448200                                         @YA09721 00523609
*A335000,485000                                                @YA11164 00523781
*A250000,560000                                                @YA11498 00523881
*C562560                                                       @OZ07798 00523991
*C508200-508400                                                @OS76519 00524091
*A600000                                                       @OS76519 00524191
*A224800,624000                                                @OZ24656 00524291
*A562570,625000                                                @OZ26305 00554211
*********************************************************************** 00600022
* MODULE NAME -- IEDQGQ                                               * 00620022
*                                                                     * 00640022
* DESCRIPTIVE NAME -- QUEUE RESET EXECUTOR                            * 00660022
*                                                                     * 00680022
* COPYRIGHT -- NONE                                                   * 00700022
*                                                                     * 00720022
* STATUS --                                                           * 00800022
*    CHANGE LEVEL 6                                              Y02027 01000006
*                                                                     * 01200022
* FUNCTION --                                                         * 01400022
*   THIS ROUTINE DOES VALITITY CHECKING ON USER INPUT THAT HAS        * 01450006
*   BEEN STORED IN THE AIB. IF THE REQUEST IS VALID THE WORKAREA      * 01500006
*   IN THE AIB IS SET UP AS AN LCB-SCB.                               * 01550006
*    RECALLS 'SERVICED' HEADER RECORDS FROM THE DISK MESSAGE QUEUE    * 01600022
*    LOOKING FOR THE USER SPECIFIED OUTPUT SEQUENCE NUMBER AND        * 01800022
*    SCHEDULES IEDQFA TO MARK 'UNSERVICED' THOSE MESSAGES FOUND WITH  * 02000022
*    SEQUENCE NUMBERS HIGHER THAN OR EQUAL TO THE REQUESTED ONE.      * 02200022
*                                                                     * 02400022
*   AFTER THE ECB IN THE APPLICATION PROGRAM HAS BEEN POSTED          * 02440006
*   COMPLETE, A CHECKPOINT IS SCHEDULED TO RECORD CHANGES. IF         * 02480006
*   THE QUEUE WAS RESET FOR A LINE, THE SEND SCHEDULER IS PUT         * 02520006
*   IN LCB TO PRIME IT.                                               * 02560006
* ENTRY POINT --                                                      * 02600022
*         IEDQGQ                                                      * 02800022
*         BUILDCPB - IS A SUBROUTINE BRANCHED TO OUT IEDQFA     SA51783 02820022
*         AFTER AN 'EE' REQUEST FOR A CPB BY IEDQGQ HAS BEEN    SA51783 02840022
*         SATISFIED.  THIS SUBROUTINE BUILDS THE CPB PASSED TO  SA51783 02860022
*         IT BY IEDQFA TO MARK A MESSAGE UNSERVICED AND RETURNS SA51783 02880022
*         CONTROL TO IEDQFA TO EXECUTE THE WRITE TO DISK        SA51783 02900022
*                                                               SA51783 02920022
*                                                                     * 03000022
* INPUT --                                                            * 03200022
*   FROM IEDQEB-QRESET FUNCTION CODE, REGISTER 1 POINTS TO            * 03400006
*   ELEMENT IN AIB.                                                   * 04400006
*                                                                     * 05400022
*    FROM IEDQFA - THE ADDRESS OF THE RECALLED BUFFER IN THE WORK     * 05600022
*    AREA'S LCB                                                       * 05800022
*                                                                     * 06000022
* OUTPUT --                                                           * 06200022
*    QCBFFEFO IS CHANGED TO DISK RECORD ADDRESS OF THE MESSAGE WITH   * 06400022
*    THE REQUESTED SEQUENCE NUMBER OR THE MESSAGE WITH THE NEXT       * 06600022
*    HIGHEST SEQUENCE NUMBER FOUND                                    * 06800022
*                                                                     * 07000022
*         PASSED TO IEDQEB ARE:                                       * 07200006
*         AIBMSGNO CONTAINS NUMBER OF MESSAGES SUCESSFULLY            * 07400006
*         PROCESSED ON RETURN CODE OF 4, 8, OR 1C.                    * 07600006
*         AIBRETCD CONTAINS RETURN CODE                               * 07800006
*                                                                     * 08240022
* EXTERNAL REFERENCES --                                              * 08400022
*         IEDQFA                                                      * 08600022
*         IGC102 - AQCTL SVC                                          * 08800022
*         IGG019R4 - SEND SCHEDULER                                   * 09000022
*         OS POST - CROSS MEMORY                                      * 09060006
*         IEDQA1                                                      * 09120006
*                                                                     * 09200022
*                                                                     * 09400022
* EXITS,NORMAL --                                                     * 09600022
*         DSPDISP                                                     * 09800022
*                                                                     * 10000022
*                                                                     * 10200022
*                                                                     * 10400022
* EXITS,ERROR --                                                      * 10600022
*         THE FOLLOWING RETURN CODES ARE PASSED TO IEDQEB             * 10800006
*         X'04' - SEQUENCE NUMBER NOT FOUND                           * 10820006
*         X'08' - REUSABLE DISK IN PROGRESS                           * 10840006
*         X'0C' - REQUESTED SEQUENCE # INVALID                        * 10860006
*         X'10' - PROC DCB NOT CLOSED                                 * 10880006
*         X'14' - INVALID TERMNAME                                    * 10900006
*                 INVALID TERM ENTRY                                  * 10920006
*                 TERMINAL HELD                                       * 10940006
*         X'18' - QUEUING ERROR                                       * 10960006
*         X'1C' - POSSIBLE LOGICAL READ ERROR                         * 10980006
*                                                                     * 11000022
* TABLES/WORKAREAS --                                                 * 11200022
*    AVT                                                              * 11400022
*    BUFFER PREFIX                                                    * 11600022
*    LCB                                                              * 11800022
*    QCB                                                              * 12000022
*    SCB                                                              * 12200022
*    TERMINAL TABLE                                                   * 12400022
*    CPB                                                        SA51783 12500022
*   AIB                                                               * 12550006
*                                                                     * 12600022
* ATTRIBUTES --                                                       * 12800022
*    REENTERANT,REFRESHABLE,RESIDENT,ENABLED,PROBLEM PROGRAM MODE     * 13000022
*                                                                     * 13200022
* CHARACTER CODE DEPENDENCY --                                        * 13400022
*    THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL REPRESENTA-* 13600022
*    TION OF AN EXTERNAL CHARACTER SET.  THE CODING HAS BEEN ARRANGED * 13800022
*    SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,    * 14000022
*    WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.         * 14200022
*********************************************************************** 14400022
         SPACE 5                                                        14600022
*********************************************************************** 14800022
*              REGISTER EQUATES                                         15000022
*********************************************************************** 15200022
RZERO    EQU   0                                                        15400022
R1       EQU   1                        REG ONE                         15500022
RONE     EQU   1                                                        15600022
R2       EQU   2                                                        15800022
RDAT     EQU   2                        DATA FIELDS POINTER     SA51783 15900022
RELEM    EQU   3                        SPECIAL ELEMENT POINTER         16000022
RLCB     EQU   4                        LCB BASE REGISTER               16200022
RWORK    EQU   5                        GENERAL WORK REGISTER           16400022
RBFR     EQU   6                        RETURNED BUFFER POINTER         16600022
RQCB     EQU   7                        QCB BASE                        16800022
RTERM    EQU   8                        TERMINAL ENTRY BASE             17000022
RSCB     EQU   9                        SCB BASE                        17200022
RAIB     EQU   10                                                Y02027 17300006
RDISP    EQU   11                       DISPATCHER BASE                 17400022
RBASE    EQU   12                       MODULE BASE                     17600022
RAVT     EQU   13                       AVT BASE                        17800022
R14      EQU   14                                                       18000022
RENTRY   EQU   15                                                       18200022
RCPB     EQU   15                       CPB REG FOR BUILD SBRTN SA51783 18300022
*********************************************************************** 18400022
         SPACE 2                                                        18600022
         USING IEDQDISP,RDISP                                           18800022
         USING AVTSAVE2,RAVT                                            19000022
         USING IEDQQCB,RQCB                                             19200022
         USING IEDQTRM,RTERM                                            19400022
         USING IEDQPRF,RBFR                                             19600022
         USING IEDQLCB,RLCB                                             19800022
         USING IEDQSCB,RSCB                                             20000022
         USING IEDQAIB,RAIB             AIB ADDRESSABILITY       Y02027 20100006
         SPACE 2                                                        20200022
IEDQGQ   IEDHJN                                                         20400022
         DC    AL1(DSPMCPL4)            STCB                            20600022
         DC    AL3(*-1)                  ENTRY                          20800022
         SPACE 1                                                        21000022
BEGIN    LR    RBASE,RENTRY             SET UP BASE REGISTER            21200022
         USING BEGIN,RBASE              ESTABLISH ADDRESSIBILITY        21400022
         LR    RLCB,RONE                GET ELEMENT POINTER      Y02027 21600006
         CLI   FOUR(RONE),PRIRTBFR      IS THIS A RESET REQUEST OR      21800022
*                                       AN ERB FROM IEDQFA              22000022
         BNE   ERBRET                   BRANCH IF ERB FROM IEDQFA       22200022
         LR    RAIB,RONE                GET RCB ADDR AND         Y02027 22400006
         SH    RAIB,AVTHA16             BACK UP TO AIB           Y02027 22410006
         XC    AIBMSGNO(4),AIBMSGNO     CLEAR MSG # AND RET CODE Y02027 22420006
*                                                                Y02027 22430006
*              CHECK FOR VALID TERM NAME                         Y02027 22440006
*                                                                Y02027 22450006
         LA    RZERO,EIGHT              LOAD MAXIMUM SIZE        Y02027 22460006
         LA    RONE,AIBDESTN            LOAD ADDRESS OF          Y02027 22470006
*                                       TERMNAME IN REG 1        Y02027 22480006
         LA    RENTRY,SEVEN(RONE)       ADDR OF LAST CHAR      @OZ24656 22481091
NAMELOOP EQU   *                                               @OZ24656 22482091
         CLI   ZERO(RENTRY),BLANK       END OF NAME            @OZ24656 22483091
         BNE   SEARCH                   BR IF YES              @OZ24656 22484091
         BCTR  RENTRY,ZERO              DEC NAME PTR           @OZ24656 22485091
         BCT   RZERO,NAMELOOP           LOOK AT NEXT CHAR      @OZ24656 22486091
         LA    RWORK,TERMERR            SET RC='14'            @OZ24656 22487091
         B     XMPOST                     AND RETURN           @OZ24656 22488091
SEARCH   EQU   *                                               @OZ24656 22489091
         L     RENTRY,AVTMSGS-ONE       GET VCON TABLE ADDR      Y02027 22490006
         L     RENTRY,EIGHT(RENTRY)     LOAD ADDR OF IEDQA1      Y02027 22500006
         BAL   R14,FOUR(RENTRY)         BRANCH TO SEARCH ROUTINE Y02027 22510006
*                                       AT SECOND ENTRY POINT    Y02027 22520006
         LA    RWORK,TERMERR            POSSIBLE ERROR CODE      Y02027 22530006
         LTR   RENTRY,RENTRY            VALID TERM NAME          Y02027 22540006
         BZ    XMPOST                   BRANCH IF NO RC= X'14'   Y02027 22550006
         STH   RENTRY,AIBINDEX          STORE TERMNAME TABLE     Y02027 22560006
*                                       OFFSET IN AIB            Y02027 22570006
         LR    RONE,RENTRY              TERMNAME TABLE OFFSET    Y02027 22580006
         L     RENTRY,AVTRNMPT          OFFSET CONVERSION LOGIC  Y02027 22590006
         BALR  R14,RENTRY               GET ADDR OF TERM ENTRY   Y02027 22600006
         LR    RTERM,RONE               TT BASE                  Y02027 22610006
         ST    RTERM,AIBTTPTR           STORE IN AIB             Y02027 22620006
*                                                                Y02027 22630006
*              TEST FOR VALID ENTRY                              Y02027 22640006
*                                                                Y02027 22650006
         L     RQCB,TRMDESTQ-ONE        GET QCB ADDRESS          Y02027 22660006
         TM    TRMSTATE,TRMLINE+TRMLIST IS THIS LIST OR LINE     Y02027 22670006
         BNZ   XMPOST                   BRANCH IF EITHER RC=X'14'Y02027 22680006
         TM    TRMSTATE,TRMPROC         IS THIS A PROCESS ENTRY  Y02027 22690006
         BO    CKSTATUS                 BRANCH IF YES            Y02027 22700006
         TM    TRMSTATE,TRMHELDN        TERMINAL HELD            Y02027 22710006
         BO    XMPOST                   BRANCH IF YES RC= X'14'  Y02027 22720006
         B     CKTYPE                   BRANCH TO AVOID TEST     Y02027 22730006
CKSTATUS EQU   *                                                 Y02027 22740006
         LA    RWORK,PROCERR            POSSIBLE ERROR           Y02027 22750006
         NC    TRMSTAT(3),TRMSTAT       DCB FOR ENTRY CLOSED     Y02027 22760006
         BNZ   XMPOST                   BRANCH IF NO RC = X'10'  Y02027 22770006
*                                       PROCESS ENTRY MUST BE    Y02027 22780006
*                                       CLOSED FOR QRESET        Y02027 22790006
CKTYPE   EQU   *                                                 Y02027 22800006
*                                                                Y02027 22810006
*              CHECK FOR CORRECT QUEUING                         Y02027 22820006
*                                                                Y02027 22830006
         LA    RWORK,QERR               SET POSSIBLE ERROR       Y02027 22840006
         TM    QCBFLAG,QCBPROC+QCBTERMQ CHECK Q BY TERMINAL OR   Y02027 22850006
*                                       PROCESS ENTRY            Y02027 22860006
         BZ    XMPOST                   BRANCH IF NEITHER RC='18'Y02027 22870006
         TM    QCBPRIPQ,AVTEFF          PRIORITY LEVEL USED      Y02027 22880006
         BNZ   XMPOST                   BRANCH IF YES RC = X'18' Y02027 22890006
         TM    QCBDSFLG,QCBDISK         TERMINAL HAVE DISK QUEUESY02027 22900006
         BZ    XMPOST                   BRANCH IF NO  RC = X'18' Y02027 22910006
         TM    QCBDSFLG,QCBDRQQ         CONC DATA READY QUEUE    Y02027 22920006
         BO    XMPOST                   BRANCH IF YES RC = X'18' Y02027 22930006
         SR    RONE,RONE                CLEAR FOR INSERT         Y02027 22940006
         ICM   RONE,ADDR,QCBQBACK       POINTER TO LAST MSG QUED Y02027 22950006
         BZ    XMPOST                   QUEUE EMTRY, BRANCH      Y02027 22960006
*                                                                Y02027 22970006
*              CHECK FOR SEQUENCE NUMBER ERRORS                  Y02027 22980006
*                                                                Y02027 22990006
         LA    RWORK,SEQERR             POSSIBLE ERROR           Y02027 23000006
         LH    RONE,AIBOSEQN            SEQ # TO RESET TO        Y02027 23010006
         LH    R2,TRMOUTSQ              GET NEXT SEQ. OUT NO.    Y02027 23020006
         L     RZERO,AIBMAXNO           GET THE VALVE OF MAX BY  Y02027 23030006
*                                       WHICH QUEUE CAN BE       Y02027 23040006
*                                       BACKED UP                Y02027 23050006
         SR    R2,RONE                  FIND DIFFERENCE BETWEEN  Y02027 23060006
*                                       LAST SEQ OUT NUMBER AND  Y02027 23070006
*                                       REQUESTED SEQ. NUMBER    Y02027 23080006
         BNP   XMPOST                   BRANCH IF REQUESTED SEQ. Y02027 23090006
*                                       NO. HIGHER THAN LAST     Y02027 23100006
*                                       OUTPUT NUMBER, RC='0C'   Y02027 23110006
         CR    R2,RZERO                 DIFFERENCE GREATER THAN  Y02027 23120006
*                                       MAX ALLOWED              Y02027 23130006
         BH    XMPOST                   BRANCH IF YES RC = X'0C' Y02027 23140006
*                                                                Y02027 23150006
*              REQUEST IS VALID SO SET UP WORKAREA AS LCB AND SCBY02027 23160006
*                                                                Y02027 23170006
         L     RELEM,AIBQPEWA           GET PEWA ADDRESS         Y02027 23180006
         OI    PEWAGSW+ONE-IEDQPEWA(RELEM),RESETACT TURN ON      Y02027 23190006
*                                       RESET ACTIVE FLAG        Y02027 23200006
         L     RELEM,AIBWAPTR           AIBS WORKAREA            Y02027 23210006
         XC    ZERO(D238,RELEM),ZERO(RELEM) CLEAR WORKAREA FOR   Y02027 23220006
*                                       LCB & SCB                Y02027 23230006
         LA    RLCB,ZERO(RELEM)         GET ADDR OF LCB          Y02027 23240006
         LA    RSCB,LCBCPA-IEDQLCB(0,RLCB)     GET SCB ADDRESS          23600022
         ST    RSCB,LCBSCBDA-1          SET CURRENT SCB ADDRESS         23800022
         ST    RSCB,LCBSCBA-1           SET CURRENT SCB ADDRESS         24000022
*                                       QCB ADDRESS                     24600022
         LA    RQCB,0(0,RQCB)           CLEAR HIGH ORDER BYTE           24800022
         ST    RQCB,SCBDESTQ-1          SET SCB DEST QUEUE ADDRESS      25000022
         OI    TRMSTATE,TRMHELDN        SET TERMINAL ENTRY     @YA11498 25050081
*                                       HELD TO PREVENT HOLD   @YA11498 25100081
*                                       DURING QRESET          @YA11498 25150081
         OI    QCBSTAT,QCBTRMHO         MARK TERMINAL'S QCB 'HELD'      25200022
         MVC   SCBDEOB+1(3),QCBQBACK    GET QBACK CHAIN POINTER         25400022
         STH   R2,LCBTPCD+TWO           SAVE COUNTER             Y02027 25600006
         STH   R2,LCBTPCD+FOUR          SAVE COUNTER             Y02027 25800006
         EJECT                                                          26000006
         SPACE 2                                                        26400022
*********************************************************************** 26600022
*                       CONTINUE SEARCH                               * 26800022
*********************************************************************** 27000022
         SPACE 1                                                        27200022
CONT     EQU   *                                                        27400022
         LH    RWORK,LCBTPCD+2          GET NUMBER OF MESSAGES LEFT     27600022
*                                       TO BE MARKED UNSERVICED         27800022
         LTR   RWORK,RWORK              HAVE ALL BEEN MARKED UNSERVICED 28000022
         BZ    GOTEM                    BRANCH IF YES                   28200022
         MVC   LCBTPCD+6(3),LCBINVPT    SAVE DISK POINTER               28300022
         LA    RWORK,NOTALL             SET POSSIBLE RETURN CODE        28400022
         NC    SCBDEOB+1(3),SCBDEOB+1   WAS RECALLED PRFHQBCK EMPTY     28500022
         BZ    GOTEM1                   BRANCH IF YES                   28600022
         MVC   SCBSCHDR(3),SCBDEOB+1    SET DISK RECORD NUMBER FOR      28700022
*                                       NEXT BUFFER TO BE RECALLED      28800022
         XC    SCBXTRA(3),SCBXTRA       SET UP                          28900022
         XC    SCBNTXT(3),SCBNTXT       FIELDS                          29000022
         NI    SCBQTYPE,XOF             FOR IEDQFA                      29100022
         MVI   SCBDEOB,AVTEZERO         CLEAR HI-ORDER BYTE             29150022
         SPACE 1                                                        29200022
*********************************************************************** 29300022
*              POST REQUEST FOR DISK I/O TO RECALL BUFFER             * 29400022
*********************************************************************** 29500022
         SPACE 1                                                        29600022
POSTERB  EQU   *                                                        29700022
         LA    RWORK,REUSGO             SET RETURN CODE = REUS IS GOING 29800022
         TM    QCBDSFLG,QCBHELD         IS REUSABILITY ACTIVE ON        29900022
*                                       THIS QUEUE                      30000022
         BNO   GOPOST                   BRANCH IF NO                    30100022
         LA    R14,ABORT                SET RETURN CODE          Y02027 30300006
         B     POSTAIB                  POST AIB                 Y02027 30350006
GOPOST   EQU   *                                                        30400022
         ST    RELEM,LCBERCCW           SAVE REGISTERS ACROSS POST      30500022
         STM   RQCB,RTERM,LCBERCCW+4    TO IEDQFA                       30600022
         LA    RWORK,AVTDSIOB           GET ADDRESS OF DISK I/O QCB     30700022
         ST    RWORK,LCBERBQB-1         STORE IT IN ERB QCB FIELD       30800022
         XC    LCBERBLK,LCBERBLK        SET LINK FIELD TO ZERO          30900022
         MVI   LCBERBST,AVTEZERO        CLEAR ERBST                     30950022
         XC    LCBERBCH(3),LCBERBCH     CLEAR POINTER TO LAST BUFFER    31000022
         MVI   LCBERBPY,PRIAPBFR        SET PRIORITY                    31100022
         MVI   LCBERBCT,ONE             SET BUFFER REQUEST COUNT        31200022
         OI    LCBSTAT1,LCBRCLLN+LCBSENDN   SET RECALL FLAGS            31300022
         XC    LCBTTCIN(2),LCBTTCIN     CLEAR INDEX TO TERM CURR CONN   31400022
         LR    RWORK,RBASE              GET ENTRY ADDRESS               31500022
         SH    RWORK,MODBKUP                                            31600022
         ST    RWORK,LCBRCQCB           AND SAVE IT                     31700022
         LA    RONE,LCBERB              ERB ADDRESS FOR POST            31800022
         BAL   R14,DSPPOST              POST ERB TO DISK IO QCB@G36XRRU 31900000
         EJECT                                                          31950006
         SPACE 2                                                        32000022
*********************************************************************** 32100022
* RESTORE BASE REGISTERS FROM POST TO IEDQFA AND CHECK FOR A RETURNED * 32200022
* BUFFER                                                              * 32300022
*********************************************************************** 32400022
         SPACE 1                                                        32500022
ERBRET   EQU   *                                                        32600022
         CLI   FOUR(RONE),PRIQGQRN      PURGE ELEMENT            Y02027 32660006
         BE    AIBRETRN                 YES, BRANCH              Y02027 32720006
         LA    RLCB,0(0,RLCB)           CLEAR HIGH ORDER BYTE           32800022
         SH    RLCB,LCBBKUP             GET LCB BASE                    32900022
         L     RSCB,LCBSCBDA-1          SET SCB BASE                    33000022
         L     RELEM,LCBERCCW           RESTORE REGISTER                33100022
         LA    RQCB,AIBWAQR-AIBSTATE    GET OFFSET FROM WORKAREA Y02027 33120006
         LR    RAIB,RELEM               TO START OF AIB          Y02027 33140006
         SR    RAIB,RQCB                SUBTRACT FOR AIB BASE    Y02027 33160006
         LM    RQCB,RTERM,LCBERCCW+4    RESTORE REGISTERS               33200022
         NC    LCBERBCH(3),LCBERBCH     HAS BUFFER BEEN RETURNED        33300022
         BZ    ABORTQR                  BRANCH IF NO                    33400022
         L     RBFR,LCBERBCH-1          GET ADDRESS OF RECALLED BUFFER  33500022
         TM    PRFCRCD+2,CPBQTYPE       MSG READ FROM DISK     @YA11164 33510081
         BNZ   NOTMNMR                  BRANCH IF YES          @YA11164 33520081
         L     RBFR,PRFCORE-1           GET COPY OF BUFFER     @YA11164 33530081
*                                       FROM CORE QUEUE        @YA11164 33540081
NOTMNMR  EQU   *                                               @YA11164 33550081
         TM    PRFSTAT1,PRFNHDRN        IS THIS A HEADER BUFFER         33600022
         BO    NTHDR                    BRANCH IF NO                    33700022
         LH    RONE,PRFDEST             LOAD DEST OFFSET        SA51078 33800022
         N     RONE,AVTCLRHI            CLEAR HI-ORDER HALF     SA51078 33820022
         L     RENTRY,AVTRNMPT          TERM NAME ROUTINE       SA51078 33840022
         BALR  R14,RENTRY               LINK TO IT              SA51078 33860022
         CLC   TRMDESTQ-IEDQTRM(,RONE),SCBDESTQ                 SA51078 33880022
*                                       SAME DEST QCB           SA51078 33900022
         BNE   WRNGDEST                 BRANCH IF NO            SA51078 33920022
         SPACE 2                                                        34000022
*********************************************************************** 34100022
*    SAVE POINTERS FOR NEXT RECALL AND BEGIN CHECKING FOR ERRORS      * 34200022
*********************************************************************** 34300022
         SPACE 1                                                        34400022
         MVC   SCBDEOB+1(3),PRFHQBCK    SET UP TO RECALL NEXT UNIT      34500022
         CLC   SCBOSEQ,AIBOSEQN         IS THIS THE SEQUENCE #   Y02027 34600006
*                                       WE'RE LOOKING FOR               34700022
         BE    CHKSVCD                  BRANCH IF YES                   34800022
         BL    RETBUF                   BRANCH IF RECALLED NUM IS LOWER 34900022
         BH    CHKREUS                  BRANCH IF HIGHER                35000022
         SPACE 1                                                        35100022
CHKSVCD  EQU   *                                                        35200022
         TM    ZERO(RBFR),SRVCD         HAS THIS MESSAGE BEEN SERVICED  35300022
         LA    RWORK,SEQERR             SET UP RETURN CODE       Y02027 35400006
         LA    R14,ABORT                SET RETURN CODE          Y02027 35500006
         BZ    POSTAIB                  POST AIB                 Y02027 35550006
         SPACE 1                                                        35600022
CHKREUS  EQU   *                                                        35800022
         SPACE 2                                                        36000022
         TM    QCBDSFLG,QCBREUS         IS THIS QUEUE ON REUSABLE DISK  36100022
         BNO   CHKFEFO                  BRANCH IF NO                    36200022
         EJECT                                                          36250006
         SPACE 1                                                        36300022
*********************************************************************** 36400022
* IF RECALLED HEADER ( POINTED TO BY PRFCRCD) RESIDES IN A DISK ZONE  * 36500022
* THAT HAS BEEN REORGANIZED BY REUSABILITY, QRESET TERMINATES.        * 36600022
*********************************************************************** 36700022
         SPACE 1                                                        36800022
         L     RWORK,AVTTOTNR           GET TOTAL NUM OF DISK RECORDS   36900022
         SRL   RWORK,DIV2               GET NUMBER OF RECORDS ON 1/2    37000022
         LR    RONE,RWORK               THE DISK AND THEN FIND THE NUM  37100022
         SRL   RONE,DIV4                OF RECORDS ON 1/8 DISK          37200022
         AR    RWORK,RONE               TOTAL RECORDS ON 5/8 DISK       37300022
         MVC   LCBERCCW+X11(3),PRFCRCD  SET UP PTR TO CURRENT HDR UNIT  37400022
         L     RONE,LCBERCCW+X10        FOR REGISTER LOAD               37500022
         L     R2,AVTLODPT              GET RADDR THAT WILL TRIGGER     37600022
*                                       REUSABILITY                     37700022
         LA    RONE,3(RONE)             ROUND DISK RECORD ADDRESSES     37800022
         LA    R2,3(R2)                 TO A MULTIPLE OF FOUR           37900022
         SRL   RONE,DIV4                GET NUMBER OF DISK RECORDS      38000022
*                                       REPRESENTED BY AVTLODPT         38100022
         SRL   R2,DIV4                  AND BY PRFCRCD                  38200022
         SR    R2,RONE                  GET THE NUMBER OF RECORDS       38300022
*                                       BETWEEN AVTLODPT AND CURRENT    38400022
*                                       UNIT                            38500022
         CR    R2,RWORK                 IS CURRENT HDR 2 1/2 ZONES      38600022
*                                       BEHIND AVTLODPT                 38700022
         BNH   CHKTEXT                  BRANCH IF NO                    38800022
ABORTQR  EQU   *                                                        38900022
         LA    RWORK,LRERR              SET RETURN CODE          Y02027 39100006
         LA    R14,ABORT                SET RETURN CODE          Y02027 39200006
         B     POSTAIB                  PREPARE TO EXIT WITHOUT  Y02027 39250006
*                                       RESETTING QCBFFEFO              39300022
         SPACE 1                                                        39400022
*********************************************************************** 39500022
* CHECK TEXT AND/OR XTRA UNIT TO SEE IF IT LIES WITHIN AN ENDANGERED  * 39600022
* ZONE.  IF IT DOES, RETURN HEADER WITHOUT MARKING IT UNSERVICED AND  * 39700022
* CONTINUE SEARCH.                                                    * 39800022
*        RONE CONTAINS # OF RECORDS REPRESENTED BY PRFCRCD            * 39900022
*        RWORK CONTAINS # OF RECORDS WITHIN 5/8 OF TOTAL DISK         * 40000022
*********************************************************************** 40100022
         SPACE 1                                                        40200022
CHKTEXT  EQU   *                                                        40300022
         CLC   PRFNTXT,PRFCRCD          IS THERE A TEXT BUFFER          40400022
         BNL   CHKXTRA                  BRANCH IF NO TEXT UNIT OR IF    40500022
*                                       TEXT FOLLOWS HEADER             40600022
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER             @YA09721 40630009
         BNO   CHKXTRA                  BRANCH IF YES          @YA09721 40660009
         MVC   LCBERCCW+X11(3),PRFNTXT  SET UP DISK ADDRESS FOR@YA09721 40700009
         L     R2,LCBERCCW+X10          REGISTER LOAD                   40800022
         BAL   R14,COMPR                GO CHECK DISTANCE BETWEEN HDR   40900022
*                                       AND TEXT                        41000022
         SPACE 1                                                        41100022
CHKXTRA  EQU   *                                                        41200022
         MVC   LCBERCCW+X11(3),PRFXTRA  SET UP DISK ADDRESS FOR@YA09721 41300009
         L     R2,LCBERCCW+X10          REGISTER LOAD                   41400022
         LTR   R2,R2                    ARE THERE ANY XTRA UNITS        41500022
         BZ    CHKFEFO                  BRANCH IF NO                    41600022
         CLC   PRFXTRA,PRFCRCD          COMPARE XTRA AND HDR            41700022
         BH    CHKFEFO                  BRANCH IF XTRA IS AHEAD OF HDR  41800022
         LA    R14,CHKFEFO              SET SUBROUTINE EXIT ADDRESS     41900022
         SPACE 1                                                        42000022
COMPR    EQU   *                                                        42100022
         LA    R2,3(R2)                 ROUND TO MULTIPLE OF FOUR       42200022
         SRL   R2,DIV4                  CONVERT ADDRESS TO NUMBER       42300022
*                                       OF RECORDS IT REPRESENTS        42400022
         SR    RONE,R2                  GET DIFFERENCE BETWEEN HEADER   42500022
*                                       AND TEXT OR XTRA UNIT           42600022
         CR    RONE,RWORK               IS UNIT 2 1/2 ZONES BEHIND HDR  42700022
         BH    SKIPONE                  GO UPDATE COUNTER AND RETURN    42800022
*                                       UNIT.  THE UNIT IS TOO FAR      42900022
*                                       BEHIND HEADER. DO NOT RISK A    43000022
*                                       LOGICAL READ ERR                43100022
         BR    R14                      RETURN FROM SUBROUTINE          43200022
         SPACE 1                                                        43300022
*********************************************************************** 43400022
* IF RECALLED DATFEFO IS ZERO AND THIS IS NOT THE LAST MESSAGE        * 43500022
* QUEUED, SKIP UNSERVICING, RETURN UNIT AND CONTINUE SEARCH           * 43600022
*********************************************************************** 43700022
         SPACE 1                                                        43800022
CHKFEFO  EQU   *                                                        43900022
         L     RWORK,ZERO(RBFR)         GET DATFEFO POINTER             44000022
         LA    RWORK,ZERO(RWORK)                                        44100022
         LTR   RWORK,RWORK              IS DATFEFO ZERO                 44200022
         BNZ   UNSRV                    BRANCH IF NO                    44300022
         CLC   PRFCRCD,QCBLFEFO         IS THIS THE LAST MSG QUEUED     44400022
*                                       FOR THIS TERMINAL               44500022
         BNE   SKIPONE                  GO UPDATE COUNTER, RETURN UNIT  44600022
*                                       CONTINUE SEARCH                 44700022
UNSRV    EQU   *                                                        44800022
         TM    ZERO(RBFR),SRVCD         MESSAGE MARKED SERVICED@SA74546 44810009
         BNO   SKIPONE                  BRANCH IF NO           @YA09721 44820009
         MVC   LCBINVPT,PRFCRCD         SAVE DISK POINTER TO THIS UNIT  44850022
         LH    R2,LCBTPCD+2             GET COUNT OF MESSAGES LEFT TO   44860022
*                                       BE HANDLED                      44870022
         BCTR  R2,ZERO                  DECREMENT BY ONE                44880022
         STH   R2,LCBTPCD+2             SAVE BACK                       44890022
         MVC   PRFSVFLG,AVTEZERO(RBFR)  SAVE DATA FLAGS         SA51783 44900022
         MVC   PRFSVFFO,ONE(RBFR)       SAVE FEFO PTR           SA51783 45100022
         MVC   PRFSVSEQ,SCBOSEQ         SAVE SEQ OUT NUMBER     SA51783 45300022
         MVI   PRFPRI,PRIFEFO           PUT PRIORITY INTO BUFFER        45700022
         LA    R14,BUILDCPB             ADDR OF CPB BUILD SBRTN SA51783 45730022
         ST    R14,PRFTIC               PASS IT TO IEDQFA       SA51783 45760022
         MVI   PRFTIC,TIC               MARK IT AS BUFFER               45800022
         LA    RENTRY,AVTDSIOB          GET ADDRESS OF DISK I/O QCB     45900022
         B     WRTBUF                   GO POST RECALLED BUFFER TO      46000022
*                                       IEDQFA TO MARK MESSAGE          46100022
*                                       UNSERVICED                      46200022
         SPACE 1                                                        46300022
*********************************************************************** 46400022
* KEEP A COUNT OF THOSE MESSAGES THAT HAVE BEEN FOUND BUT SHOULD NOT  * 46500022
* BE MARKED UNSERVICED.  E.G., TEXT OR XTRA UNITS IN ENDANGERED ZONE  * 46600022
* ON REUSABLE DISK OR MESSAGE WAS ORIGINALLY SENT IN INITIATE OR      * 46700022
* LOCK MODE.                                                          * 46800022
*********************************************************************** 46900022
         SPACE 1                                                        47000022
SKIPONE  EQU   *                                                        47100022
         LH    RWORK,LCBTPCD+XA         GET COUNT OF MESSAGES SKIPPED   47200022
         LA    RWORK,ONE(RWORK)         BUMP BY ONE                     47300022
         STH   RWORK,LCBTPCD+XA         SAVE BACK                       47400022
         B     RETBUF                   GO RETURN BUFFER                47500022
         SPACE 2                                                        47600022
*********************************************************************** 47700022
*                  RETURN RECALLED UNIT                               * 47800022
*********************************************************************** 47900022
         SPACE 1                                                        47930022
NTHDR    EQU   *                                                        47960022
WRNGDEST EQU   *                                                        48000022
         MVC   SCBDEOB+1(3),PRFNTXT     PICK UP PROPER Q-BACK PTR       48100022
RETBUF   EQU   *                                                        48500022
         L     RBFR,LCBERBCH-1          GET ADDRESS OF         @YA11164 48530081
*                                       RECALLED BUFFER        @YA11164 48560081
         MVI   PRFPRI,PRIBFRTB          SET EMPTY BUFFER PRIORITY       48600022
         LA    RENTRY,AVTBFRTB          GET BUFFER RETURN QCB ADDRESS   48700022
         SPACE 5                                                        48800022
WRTBUF   EQU   *                                                        48900022
         ST    RENTRY,PRFQCBA-1         STORE IN BUFFER QCB             49000022
         XC    PRFLINK(3),PRFLINK       ZERO THE LINK FIELD             49100022
         LR    RONE,RBFR                SET PARM REG FOR DISPATCHER     49200022
         BAL   R14,DSPPOSTR             PUT BUFFER ON THE READY QUEUE   49300022
         L     RELEM,LCBERCCW           RESTORE REG FROM DISPATCHER     49400022
         LM    RQCB,RTERM,LCBERCCW+4    RESTORE REGISTERS               49500022
         B     CONT                     GO REQUEST READ OF HEADER       49600022
         SPACE 2                                                        49700022
*********************************************************************** 49800022
*          SET RETURN CODE AND, IF NECESSARY, UPDATE QCBFFEFO         * 49900022
*********************************************************************** 50000022
         SPACE 1                                                        50100022
         SPACE 1                                                        50200022
GOTEM    EQU   *                                                        50300022
         SR    RWORK,RWORK              ZERO REGISTER                   50400022
         SPACE 1                                                        50500022
GOTEM1   EQU   *                                                        50600022
         BAL   R14,POSTAIB              POST AIB                 Y02027 50650006
         MVC   QCBFFEFO,LCBINVPT        UPDATE THE FEFO POINTER FOR THE 50700022
*                                       SEND SCHEDULER                  50800022
         MVC   QCBPFEFO(THREE),LCBINVPT  AND SET UP OTHER QCB  @OS76519 50820091
         MVC   QCBPREVF(THREE),LCBINVPT  MESSAGE POINTERS      @OS76519 50840091
         SPACE 1                                                        50860022
ABORT    EQU   *                                                        50900022
         LH    R2,LCBTPCD+4             ORIGINAL NUM OF MESSAGES TO     51000022
*                                       BE MARKED UNSERVICED            51100022
         SH    R2,LCBTPCD+2             SUBTRACT NUMBER NOT FOUND       51200022
         LR    RONE,R2                  SAVE NUM OF MESSAGES RESET      51220022
         AH    RONE,QCBMSGCT            ADD NUM OF MESSAGES ON QUEUE    51240022
         STH   RONE,QCBMSGCT            UPDATE MESSAGE COUNT            51260022
         LH    RONE,LCBTPCD+XA          CHECK FOR SKIPPED MESSAGES      51300022
         LTR   RONE,RONE                ARE THERE ANY                   51400022
         BZ    SAVCNT                   BRANCH IF NO                    51500022
         SR    R2,RONE                  SUBTRACT SKIPPED MESSAGES FROM  51600022
*                                       TOTAL HANDLED                   51700022
         LTR   RWORK,RWORK              IS THERE AN ERROR CODE          51800022
         BNZ   SAVCNT                   BRANCH IF YES                   51900022
         LA    RWORK,FOUR               SET RETURN CODE INDICATING THAT 52000022
*                                       SOME OF THE REQUESTED MESSAGES  52100022
*                                       HAVE NOT BEEN MARKED UNSERVICED 52200022
         SPACE 1                                                        52300022
SAVCNT   EQU   *                                                        52400022
         STH   R2,LCBTPCD+2             SAVE # MESSAGES HANDLED -       52500022
*                                       INCLUDES THOSE 'UNSERVICED AND  52600022
*                                       THOSE SKIPPED DUE TO CERTAIN    52700022
*                                       ERROR CONDITIONS                52800022
         SPACE 1                                                        55900022
         SPACE 1                                                        56000022
         NI    TRMSTATE,TRMHELDF        RELEASE TERMINAL ENTRY @YA11498 56050081
         NI    QCBSTAT,AVTEFF-QCBTRMHO  RELEASE TERMINAL'S QCB          56100022
         L     RELEM,AIBQPEWA           GET PEWA ADDRESS         Y02027 56200006
         NI    PEWAGSW+ONE-IEDQPEWA(RELEM),AVTEFF-RESETACT  TURN Y02027 56201006
*                                       OFF ACIVE FLAG           Y02027 56202006
         LTR   RWORK,RWORK              RETURN CODE 0            Y02027 56203006
         BE    SETRET                   LEAVE AIBMSGNO=0         Y02027 56204006
         LA    RZERO,SEQERR             SEQUENCE ERROR           Y02027 56205006
         CR    RWORK,RZERO              RETURN CODE SET RC=0C    Y02027 56206006
         BE    SETRET                   LEAVE AIBMSGNO=0         Y02027 56207006
*                                                                Y02027 56208006
*              FOR RETURN CODE OF 4, 8, 1C SET NUMBER OF         Y02027 56209006
*              HANDLED MESSAGES                                  Y02027 56210006
*                                                                Y02027 56211006
         STH   R2,AIBMSGNO              STORE NO OF MESSAGES     Y02027 56212006
*                                       HANDLED - FOR REG 2      Y02027 56213006
         LA    RZERO,NOTALL             CHECK FOR                Y02027 56214006
         CR    RWORK,RZERO              RETURN CODE = 4          Y02027 56215006
         BE    SETRET                   BRANCH IF YES            Y02027 56216006
         EJECT                                                          56217006
*                                                                Y02027 56218006
*              CROSS MEMORY POST TO RETURN TO QRESET FUNCTION    Y02027 56219006
*                                                                Y02027 56220006
XMPOST   EQU   *                                                 Y02027 56221006
         LA    RSCB,LEAVE               SET RETURN TO AVOID CHECKY02027 56222006
*                                       POINT                    Y02027 56223006
XMPOST1  EQU   *                                                 Y02027 56224006
         SR    RZERO,RZERO              SET COMPLETION CODE      Y02027 56225006
         L     RELEM,AIBQPEWA           GET PEWA ADDRESS         Y02027 56226006
         TM    PEWAFLG-IEDQPEWA(RELEM),CFLG CLOSEDOWN IN PROGRESSY02027 56227006
         BO    CLOSE                    BRANCH IF YES - NO POST  Y02027 56228006
         STC   RWORK,AIBRETCD+ONE       PUT RETURN CODE IN AIB   Y02027 56229006
         MVC   AIBCMPTQ(4),AIBECBA      GET ECB ADDR             Y02027 56230006
         L     RWORK,AIBPCBAD           GET PCB ADDRESS          Y02027 56231006
         L     RWORK,PCBPEBAD-IEDQPCB(RWORK) GET PEB ADDRESS     Y02027 56232006
         LTR   RWORK,RWORK              TEST IF AP IS ACTIVE     Y02027 56233006
         BZR   RSCB                     BRANCH TO AVOID XMPOST   Y02027 56234006
         L     RWORK,PEBASCB-IEDQPEB(RWORK) GET ASCB ADDRESS     Y02027 56235006
         LTR   RWORK,RWORK              TEST IF FLAG HAS         Y02027 56236006
*                                       INVALIDATED ASCB ADDR    Y02027 56237006
         BMR   RSCB                     BRANCH IF NEGATIVE FLAG  Y02027 56238006
*                                       ON - AVOID XMPOST        Y02027 56239006
         ST    RWORK,AIBCMPTQ+FOUR      ASCB AND STORE IN LIST   Y02027 56240006
         L     RWORK,CVTPTR             ADDRESS OF CVT           Y02027 56241006
         LA    RWORK,CVTBRET-CVTMAP(RWORK) GET ERROR ADDRESS     Y02027 56242006
         ST    RWORK,AIBCMPTQ+EIGHT     AND STORE IN LIST        Y02027 56243006
         LA    R1,AIBCMPTQ              GET LIST ADDRESS         Y02027 56244006
         POST  ,(0),MF=(E,(1))                                   Y02027 56245006
         BR    RSCB                     BRANCH TO LEAVE          Y02027 56246006
*                                       OR CHECK POINT           Y02027 56247006
*                                                                Y02027 56248006
*              FOR RETURN CODE OF 0, 4, C SET RETURN FROM POST   Y02027 56249006
*              TO TAKE CHECKPOINT                                Y02027 56250006
*                                                                Y02027 56251006
SETRET   EQU   *                                                 Y02027 56252006
         LA    RSCB,CKPT                SET RETURN FROM POST     Y02027 56253006
         B     XMPOST1                  BRANCH TO POST           Y02027 56254006
CLOSE    EQU   *                                                 Y02027 56255006
         L     RONE,PEWARCB-IEDQPEWA(RELEM)    ADDR OF CLOSE   @OZ07798 56256091
*                                       RCB AS SET UP BY CLOSE   Y02027 56257006
         TS    FORTY7(RONE)             SET RCB POSTED FLAG    @OZ26305 56258011
         BCR   4,RSCB                   RCB ON RDY Q, CONT     @OZ26305 56259011
         LR    R2,RQCB                  SAVE REG                        56260022
         BAL   R14,DSPPOSTR             POST CLOSE ELEMENT              56270022
         LR    RQCB,R2                  RESTORE REG                     56280022
         BR    RSCB                     BRANCH TO LEAVE          Y02027 56290006
*                                       OR FALL THROUGH          Y02027 56310006
CKPT     EQU   *                                                 Y02027 56330006
*              TAKE CHECKPOINT TO RECORD CHANGES                 Y02027 56350006
*                                                                Y02027 56370006
         TM    AVTCKFLG,AVTCKTAC        CHECKPOINT IN SYSTEM   @G36XRRU 56405000
         BZ    NOCKPT                   BRANCH IF NO                    56410022
         LA    R1,AVTCKELE              CKPT ELE                        56415022
         L     RENTRY,AVTHG02           TIME Q DELINK ROUTINE           56420022
         BALR  R14,RENTRY               REMOVE CKPT ELE                 56425022
         TM    AVTCKELF,AVTCRTLN        CKPT ELE ALREADY POSTED         56430022
         BO    NOCKPT                   BRANCH IF YES                   56435022
         TM    AVTCKELF,AVTCPIPN        CKPT IN PROGRESS                56440022
         BO    REQCKPT                  BRANCH IF YES                   56445022
         MVC   AVTCKELE+1(3),AVTCKQAD   CKPT QCB ADDR                   56450022
         LA    R1,AVTCKELE              CKPT ELEMENT ADDR               56455022
         MVI   AVTCKELE+FOUR,PRICKPT    SET PRIORITY                    56460022
         LR    R2,RQCB                  SAVE REG                        56465022
         BAL   R14,DSPPOSTR             POST CKPT ELE                   56470022
         LR    RQCB,R2                  RESTORE REG                     56475022
REQCKPT  EQU   *                                                        56480022
         OI    AVTCKELF,AVTCRTLN        SET CKPT REQUESTED              56485022
*                                                                Y02027 56486006
*              PUT SEND SCHEDULER IN THE LCB                     Y02027 56487006
*                                                                Y02027 56488006
NOCKPT   EQU   *                                                        56490022
         TM    TRMSTATE,TRMPROC         IS RESET FOR A PROCESS ENTRY    56500022
         BO    LEAVE                    BRANCH IF PROCESS ENTRY         56600022
         LA    RWORK,QCBSTVTO           GET ADDRESS OF STCB             56700022
         L     R2,QCBSTCHN-1            GET ADDRESS OF FIRST STCB       56800022
*                                       IN CHAIN                        56900022
         LA    R2,ZERO(,R2)             CLEAR HIGH ORDER BYTE           57000022
         CR    RWORK,R2                 IS SEND SCHEDULER STCB IN QCB   57100022
         BNE   LEAVE                    BRANCH IF NO                    57200022
         SR    RENTRY,RENTRY            CLEAR REGISTER                  57300022
         IC    RENTRY,QCBSTVTO          GET SCHEDULER'S SUBTASK VECTOR  57400022
         AR    RENTRY,RENTRY            TABLE ENTRY AND GO TO THE       57500022
         L     R2,AVTDISP-24(RENTRY)    SPECIAL ENTRY IN THE            57600022
         SH    R2,AVTHA2                SEND SCHEDULER TO               57700022
         LH    RENTRY,ZERO(,R2)         INSERT ITS                      57800022
         AR    RENTRY,R2                STCB                            57900022
         BALR  R14,RENTRY               IN TERMINAL'S LCB               58000022
         SPACE 1                                                        58100022
*********************************************************************** 58200022
*                        EXIT TO THE DISPATCHER                       * 58300022
*********************************************************************** 58400022
LEAVE    EQU   *                                                        58500022
         B     DSPDISP                  EXIT                            58600022
         EJECT                                                          58603006
POSTAIB  EQU   *                                                 Y02027 58606006
*****************************************************************Y02027 58609006
*                                                                Y02027 58612006
*        THIS SUBROUTINE POSTS THE AIB BACK TO IEDQGQ TO ENSURE  Y02027 58615006
*        THAT ALL USEAGE OF THE AIB IS COMPLETE BEFORE POSTING   Y02027 58618006
*        THE APPLICATION PROGRAM.                                Y02027 58621006
*                                                                Y02027 58624006
*****************************************************************Y02027 58627006
         SPACE 1                                                 Y02027 58630006
         ST    R14,LCBERCCW             SAVE RETURN REG          Y02027 58633006
         STM   RQCB,RTERM,LCBERCCW+FOUR SAVE REGISTERS           Y02027 58636006
         STC   RWORK,AIBRETCD+ONE       SAVE RETURN CODE         Y02027 58639006
         L     RWORK,CVTPTR             ADDRESS OF CVT           Y02027 58642006
         L     RWORK,CVTAQAVT-CVTMAP(,RWORK) ADDRESS OF TCX      Y02027 58645006
         L     RWORK,TCXQRQ-IEDQTCX(,RWORK) IEDQGQ ADDRESS       Y02027 58648006
         ST    RWORK,AIBKEY             PUT IN ELEMENT           Y02027 58651006
         MVI   AIBPRI,PRIQGQRN          SET PRIORITY             Y02027 58654006
         XC    AIBLINK,AIBLINK          CLEAR LINK FIELD         Y02027 58657006
         LA    RONE,AIBKEY              SET DISP PARM            Y02027 58660006
         B     DSPPOST                  POST ELEMENT             Y02027 58663006
         SPACE 1                                                 Y02027 58666006
AIBRETRN EQU   *                                                 Y02027 58669006
         LA    RAIB,ZERO(,RONE)         SET AIB                  Y02027 58672006
         SH    RAIB,AVTHA16             ADDRESSABILITY           Y02027 58675006
         L     RLCB,AIBWAPTR            GET LCB ADDRESS          Y02027 58678006
         L     R14,LCBERCCW             GET RETURN ADDRESS       Y02027 58681006
         LM    RQCB,RTERM,LCBERCCW+FOUR RESTORE ERGISTERS        Y02027 58684006
         SR    RWORK,RWORK              CLEAR REGISTER           Y02027 58687006
         IC    RWORK,AIBRETCD+ONE       GET SAVED RETURN CODE    Y02027 58690006
         BR    R14                      RETURN TO INLINE         Y02027 58693006
         EJECT                                                          58700022
****************************************************************SA51783 58702022
*                                                              *SA51783 58704022
* THIS SUBROUTINE IS BRANCHED TO OUT OF IEDQFA AFTER A REQUEST *SA51783 58706022
* FOR A CPB BY IEDQGQ HAS BEEN FULFILLED.  IT BUILDS THE CPB   *SA51783 58708022
* AND DATA FIELDS NECESSARY TO MARK A MESSAGE UNSERVICED,      *SA51783 58710022
* RETURNS THE RECALLED BUFFER TO BUFFER RETURN, AND RETURNS    *SA51783 58712022
* TO IEDQFA ON A BRANCH TO DSPPOSTR SINCE R14 CONTAINS THE     *SA51783 58714022
* RETURN ADDRESS TO IEDQFA.                                    *SA51783 58716022
*                                                              *SA51783 58718022
****************************************************************SA51783 58720022
         SPACE 3                                                        58722022
         DROP  RBASE                    SUBROUTINE HAS NO BASE  SA51783 58724022
         USING IEDQDATA,RDAT            DATA FIELD              SA51783 58726022
         USING IEDQCPB,RCPB             CPB                     SA51783 58728022
         SPACE 3                                                        58730022
BUILDCPB EQU   *                                                SA51783 58732022
         L     RCPB,PRFTIC              ADDR OF CPB FROM IEDQFA SA51783 58734022
         L     RDAT,CPBXREAF            UNIT ADDR FOR WRT DATA  SA51783 58736022
         L     RQCB,PRFQCBA-1           QCB ADDR STORED BY FA   SA51783 58738022
         MVI   CPBRDWR,CPBWRC           WRITE DATA COMMAND      SA51783 58740022
         MVI   CPBXDWR,CPBNOPC          NOP COMMAND CODE        SA51783 58742022
         MVC   CPBADDR+1(3),PRFCRCD     SET ADDR OF BUFFER      SA51783 58744022
         MVC   DATFLAGS,PRFSVFLG        SET SAVED DATA FLAGS    SA51783 58746022
         NI    DATFLAGS,X'FF'-DATSENT   TURN OFF SERVICED FLAG  SA51783 58748022
         MVC   DATFEFO,PRFSVFFO         SET SAVED FEFO PTR      SA51783 58750022
         MVC   DATSEQOT,PRFSVSEQ        SET SAVED SEQ OUT NUM   SA51783 58752022
         MVI   PRFPRI,PRIBFRTB          SET RETURN BFR PRIORITY SA51783 58754022
         LA    R2,AVTBFRTB              BFR RETURN QCB ADDRESS  SA51783 58756022
         ST    R2,PRFQCBA-1             SET IT IN BUFFER        SA51783 58758022
         LR    R1,RBFR                  SET BFR AS ELEMENT      SA51783 58760022
         CLC   QCBLFEFO,PRFCRCD         LAST MSG QUEUED FOR TRM SA51783 58762022
         BNE   DSPPOSTR                 BR NO - POST BFR TO     SA51783 58764022
*                                       BFR RETURN AND RETURN   SA51783 58766022
*                                       ON R14 TO IEDQFA        SA51783 58768022
         MVC   QCBDATFL,DATFLAGS        UPDATE QCB FLAG FOR MSG SA51783 58770022
         B     DSPPOSTR                 POST BFR TO BFR RETURN  SA51783 58772022
*                                       QUEUE AND RETURN ON     SA51783 58774022
*                                       REGISTER 14 TO IEDQFA   SA51783 58776022
         EJECT                                                          58778022
*********************************************************************** 58800022
*                       EQUATES AND CONSTANTS                         * 58900022
*********************************************************************** 59000022
         SPACE 1                                                        59100022
         DS    0H                                                       59300022
LCBBKUP  DC    AL2(LCBERB-IEDQLCB)      USED TO ADJUST LCB BASE         59400022
MODBKUP  DC    AL2(12)                  USED TO LOCATE IEDQGQ'S QCB     59500022
RETELLEN DC    H'0006'                  LENGTH OF ELEMENT FOR RETURN    59600022
FOUR     EQU   4                                                        60000022
THREE    EQU   3                        LENGTH FOR MVC         @OS76519 60050091
NOTALL   EQU   X'04'                    RETURN CODE = PARTIAL RETRIEVAL 60100022
ONE      EQU   1                                                        60200022
PRIRTBFR EQU   X'D4'                    RETRIEVE PRIORITY               60300022
EIGHT    EQU   8                                                        60500022
REUSGO   EQU   8                                                        60600022
TIC      EQU   X'08'                    FLAG = BUFFER FOR DISK I/O      60800022
XOF      EQU   X'0F'                    QUEUE TYPE MASK                 60900022
ZERO     EQU   0                                                        61000022
XA       EQU   10                                                       61200022
TWO      EQU   2                        CONSTANT OF TWO          Y02027 61300006
ADDR     EQU   7                        ICM/STCM MASK            Y02027 61350006
D238     EQU   238                      LENGTH OF WORK AREA      Y02027 61400006
SEQERR   EQU   X'0C'                    SEQUENCE RETURN CODE     Y02027 61450006
PROCERR  EQU   X'10'                    PROCEDURAL ERROR         Y02027 61500006
TERMERR  EQU   X'14'                    INVALID TERM ENTRY       Y02027 61550006
QERR     EQU   X'18'                    QUEUING ERROR            Y02027 61600006
LRERR    EQU   X'1C'                    RET. CODE FOR ABORT FUNC-Y02027 61650006
*                                       TION TO AVOID POSSIBLE LOGICAL  61700022
*                                       READ ERROR                      61800022
PRIQGQRN EQU   X'E3'                    PRIORITY                 Y02027 61850006
SRVCD    EQU   X'40'                    FLAG = MESSAGE SERVICED         61900022
DIV4     EQU   2                                                        62000022
DIV2     EQU   1                                                        62100022
X40      EQU   X'40'                                                    62200022
X11      EQU   17                                                       62300022
X10      EQU   16                                                       62400022
SEVEN    EQU   7                        OFFSET                 @OZ24656 62450091
BLANK    EQU   X'40'                    CONSTANT               @OZ24656 62500091
FORTY7   EQU   47                       RCB POSTED FLAG OFFSET @OZ26305 62550011
         EJECT                                                          63400022
*                        D S E C T S                                    63410006
*                                                                       63420006
         TAIBD EXT=(QRESET)                                             63430006
         EJECT                                                          63433006
         TTCXD                                                          63436006
         TPEWAD                                                         63440006
         TPEBD                                                          63450006
CVTMAP   CVT   DSECT=YES                                                63460006
         TPCBD                                                          63470006
         TDISPD                                                         63500022
         TPRIOR                                                         63600022
         TSCBD                                                          63700022
         TQCBD                                                          63800022
         TPRFD                                                          63900022
         TLCBD                                                          64000022
         TTRMD                                                          64100022
         TAVTD                                                          64200022
         EJECT                                                          64220022
         TCPBD 3330                                             SA51783 64240022
         EJECT                                                          64260022
         TDATAD                                                 SA51783 64280022
         END                                                            64300022
         EJECT                                                          76800022
         TDISPD                                                         77000022
         TPRIOR                                                         77200022
         TSCBD                                                          77400022
         TQCBD                                                          77600022
         TPRFD                                                          77800022
         TLCBD                                                          78000022
         TTRMD                                                          78200022
         TAVTD                                                          78400022
         END                                                            78600022
