DQGT     TITLE     '''IEDQGT''    -   TRANSPARENT CCW BUILDER'          00200020
IEDQGT   CSECT                                                          00400020
*A-000000-999999                                               @X31X8I0 00400108
         SPACE 3                                                        00400205
*  CHANGE ACTIVITY AS FOLLOWS                                           00400405
******************** MICROFICHE FLAGS *********************** SUPT CODE 00400605
*A115000,149000,164100-164300,508100,458000                      S21903 00401005
*C022000,048000,050000,072000,074000,148000,150000,198000,228000,S21903 00401105
*C278000,284000,286000,304000,306000,392000,400000,434000,440000,S21903 00401205
*C442000,458000,462000,474000,478000,486000,498000,508000,512000,S21903 00401305
*C520000,528000,584500,549000,564000,572000,590000,602000,604000,S21903 00401405
*C612000,616000,626000,630000,640000,648000,672000,674000,702000,S21903 00401505
*C720000,736000,756000,768000,772000,804000,806000,820000,832000,S21903 00401605
*C850000,864000,870000,884000,896000,924000,928000               S21903 00401705
*A427400                                                        SA50219 00401805
*A468000                                                         A44884 00401905
*A870000                                                         A50198 00402005
*C872000,878000                                                  A50198 00402105
*A166000                                                        SA53639 00402205
*C216000                                                        SA53639 00402305
*A42650-426350                                                   S99238 00402405
*C216000                                                         S99238 00402505
*A186000,426600,966000                                          SA61750 00402605
*A202000,43800,588000,780000,786000,796000,838000               SA63953 00402751
*A078400-079600,083000,098600-099200,186100-186600,186700,186800,X01004 00402805
*A411000,718100-719900,720200-721800,722200-723800,724200-725800,X01004 00402905
*A726600-727800                                                  X01004 00403005
*C078000,082000,098000,160000,186000,314000,410000,412000,718000,X01004 00403105
*C722000,724000,726000,964000                                    X01004 00403205
*D260000,316000,372000,720000,728000-730000                      X01004 00403305
*A186650,186720-186760,191500-195000,234600-235200,310100-311800,Y01004 00403405
*A331000,358100-359000,392500-393500,478300-479500,519000,521000,Y01004 00403505
*A528300-529500,617000,619000,621000,646600-647200,718650,       Y01004 00403605
*A806100-807900,833000,953000,955000,957000,959000,961000,963000,Y01004 00403705
*A965000                                                         Y01004 00403805
*C191000,198000,214000,234000,290000-292000,310000,392000,478000,Y01004 00403905
*C518000,520000,528000,532000-538000,556000,616000,618000,620000,Y01004 00404005
*C622000,650000,698000,719000,719700-719850,720300-720600,       Y01004 00404105
*C721100-726000,726900-727700,732000,748000-750000,806000,       Y01004 00404205
*C844000-846000,852000                                           Y01004 00404305
*D206000,400000-404000,500000-508000,522000,632000-640000,       Y01004 00404405
*D652000-654000,700000-702000,752000,758000-772000,854000-928000 Y01004 00404505
*D427200-427400,484000                                          SA63953 00404605
*A396000                                                        SA64671 00404705
*C396000                                                        SA64671 00404805
*C718960-719020,C720800-720940,A721010,A725810-725980            Y05331 00404905
*A079400,191000,718160-720760,726800-730800,850600-851200        Y02027 00405006
*C079200,079600                                                  Y02027 00405106
*D191000-195200,718160-721300,726800-727400                      Y02027 00405206
         SPACE 3                                                        00590005
*A270000                                                       @XA03967 00592061
*A723300,727000,846000                                          OX01433 00595005
*A302000                                                       @SA73588 00595509
*D303000,C276000                                               @OS76520 00595691
*A731600                                                       @OY12651 00595791
*C396000,D396600-397500,C426300,A438600,A564000                @OY12980 00595891
*C726800,D729200,A731600                                       @OZ11198 00595991
*A004000                                                       @Z30X8IJ 00596008
*C015200,116000,124000,168000-184000,186200-186240             @Z30X8IJ 00597008
*C210000-212000,220000,272000,294000,366000,468500,470000      @Z30X8IJ 00598008
*C546000-548500,556000-562000                                  @Z30X8IJ 00599008
*D565000-569000,C396000,C426300                                @OY15018 00599191
*D396200-396400                                                @OZ18772 00599400
*C731800-731840                                                @OY16444 00599600
*A731920                                                       @OY16444 00599800
*A496000,A558000,A723760,A797000                               @OZ25095 00600000
*D496500-497500,558500,723770,797200,797800                    @OZ36857 00620000
*   $11=OZ47752  JTC2312  80.08.18 518009:                         @11A 00635026
*   $21=OZ52348  ETC2402  81.10.21 879315:                         @21A 00635127
*********************************************************************** 00650000
* $MOD(IEDQGT) COMP(I@) PROD(TCAM):                                @21A 00660027
*                                                                     * 00800020
*TITLE -- 'IEDQGT'    TRANSPARENT TRANSMISSION CCW BUILDER            * 01000020
*                                                                     * 01200020
*  MODULE NAME = IEDQGT                                               * 01400005
*                                                                     * 01420005
*  DESCRIPTIVE NAME = TRANSPARENT TRANSMISSION CCW BUIDLER            * 01440005
*                                                                     * 01460005
*  COPYRIGHT = 'NONE'                                                 * 01480005
*                                                                     * 01500005
*  STATUS:  CHANGE LEVEL 8                                     @Z30X8IJ 01520008
*                                                                     * 01600020
*FUNCTION -- TO BUILD THE NECESSARY CCWS IN EACH BUFFER UNIT TO       * 01800020
*   SEND TRANSPARENT DATA IN TRANSPARENT MODE IN THE CORRECT BLOCK    * 02000020
*   SIZE TO A TERMINAL AND TO CONSTRUCT IN THE LCB A SEQUENCE TO      * 02200022
*   WRITE DLE/ETB AND RD RESP.                                        * 02400020
*                                                                     * 02600020
*ENTRY POINT -- IEDQGT - AS A RESULT OF THE OUTBUF MACRO IN MH        * 02800020
*   CALLING SEQUENCE -               L    R6,BUFFERAD                 * 03000020
*                                    LA   R15,IEDQGT                  * 03200020
*                                    BALR R14,R15                     * 03400020
*                                                                     * 03600020
*INPUT -- A BUFFER ADDRESS IN R6, BLOCK SIZE IN SCBBKFCT+1 (HALF WORD)* 03800020
*   AND AVTSAVE2 IN R 13.                                             * 04000020
*                                                                     * 04200020
*OUTPUT -- EACH UNIT WILL HAVE A CCW TO WRITE OUT THE FIRST PORTION   * 04400020
*   OF THE UNIT TO BE CONTAINED IN THE BLOCK THAT INCLUDES THAT       * 04600020
*   UNIT. THE UNIT CONTAINING THE LAST BYTE OF DATA OF THE FIRST      * 04800022
*   BLOCK IN THIS TRANSMISSION WILL TIC TO THE LCB CHANNEL PROGRAM    * 05000022
*   AREA TO THE CCW TO WRITE THE DLE/ETB SEQUENCE.  THE LCBCPA        * 05200020
*   WILL CONTAIN THE NUMBER OF BYTES LEFT TO WRITE IN THIS UNIT,      * 05400020
*   THE ADDRESS OF THE UNIT AND THE VALUE FORMERLY IN THAT UNIT'S     * 05600020
*   TIC FIELD.  IF THIS IS NOT THE FIRST BLOCK THE UNIT CONTAINING    * 05800020
*   THE  LAST BYTE OF DATA FOR THE CURRENT BLOCK WILL HAVE A FLAG     * 06000020
*   INDICATING THIS AND THE TIC OP CODE AREA WILL CONTAIN THE         * 06200020
*   NUMBER OF BYTES LEFT TO BE WRITTEN FROM THIS UNIT.  IF AT READ    * 06400020
*   RESPONSE TIME ALL UNITS TO WRITE OUT THE NEXT BLOCK ARE NOT       * 06600020
*   AVAILABLE, THE CONDITION WILL BE TREATED LIKE A CHANNEL PROGRAM   * 06800020
*   CHECK AND CHANNEL WILL BE MADE TO EXECUTE A WRITE SYNC LOOP       * 07000020
*   WRITING SYNC CHARACTERS TO THE TERMINAL.  WHEN THE REQUIRED       * 07200005
*   UNITS ARRIVE, NORMAL TRANSMISSION WILL BE RESUMED BY CAUSING      * 07400022
*   THE WRSYNC LOOP TO TIC TO A WRITE DLE/STX SEQUENCE AND TIC TO     * 07600020
*   THE NEXT UNIT TO BE TRANSMITTED.  FOR OS/VS, WHEN ALL UNITS RE-   * 07800005
*   QUIRED TO WRITE THE NEXT BLOCK ARE AVAILABLE, THE DATA AND TIC    * 07840005
*   ADDRESSES IN ALL APPLICABLE CCWS IN THE LCB AND THE UNITS ARE     * 07880005
*   CONVERTED TO REAL BEFORE EXITTING TO THE DISPATCHER.  THIS   Y02027 07920006
*   OPERATION IS SERIALIZED BY ISSUING SETLOCK.  OTHERWISE, THESEY02027 07940006
*   ADDRESSES REMAIN VIRTUAL.                                    Y02027 07960006
*                                                                     * 08000020
*                                                                     * 08400020
*EXITS-NORMAL -- TO THE CALLING ROUTINE VIA BR 14                     * 08600020
*                                                                     * 08800020
*EXITS-ERROR -- NONE                                                  * 09000005
*                                                                     * 09200020
*TABLES/WORK AREAS -- LCB, SCB, PREFIX, CCW, DCB, AVT.                * 09400020
*                                                                     * 09600020
*ATTRIBUTES -- REUSABLE,REFRESHABLE,RESIDENT,SUPERVISOR STATE,   Y02027 09800006
*   AND SUPERVISOR MODE, SETLOCK, OTHERWISE, ENABLED AND PROBLEM Y02027 09860006
*   PROGRAM MODE.                                                     * 09920005
*                                                                     * 10000020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 10200020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 10400020
*   SET.                                                              * 10600020
*                                                                     * 10800020
*********************************************************************** 11000020
*                                                                     * 11200020
         EJECT                                                          11300005
*        REGISTER EQUATES                                             * 11400020
*********************************************************************** 11500022
R0       EQU   0                        WORK REGISTER          @Z30X8IJ 11600008
RUNIT    EQU   1                        NEXT UNIT ADDR                  11800020
RDCB     EQU   2                        DCB ADDR                        12000020
RSCB     EQU   3                        SCB ADDR                        12200020
RLCB     EQU   4                        LCB ADDRESS            @Z30X8IJ 12400008
RSIZE    EQU   5                        SIZE OF BFR                     12600020
RPREFIX  EQU   6                        BUFFER ADDRESS                  12800020
RKEY     EQU   7                        LENGTH REMAINING IN UNIT        13000020
R8       EQU   8                        WORK REG                        13200020
RETB     EQU   9                        COUNT REMAINING IN ETB SIZE     13400020
R10      EQU   10                       WORK REG                        13600020
R11      EQU   11                       WORK REG                        13800020
R12      EQU   12                       WORK REG                        14000020
RAVT     EQU   13                       AVT BASE                        14200020
R14      EQU   14                       RETURN REG                      14400020
RBASE    EQU   15                       BASE REG                        14600020
*********************************************************************** 14800022
*        ESTABLISH BASE ADDRESSABILITY                                * 14900022
*********************************************************************** 15000022
         USING IHADCB,RDCB                                              15200020
         USING IEDQLCB,RLCB                                             15400020
         USING IEDQSCB,RSCB                                             15600020
         USING IEDQPRF,RPREFIX                                          15800020
         USING AVTSAVE2,RAVT            AVT ADDRESSABILITY.      X01004 16000005
         USING    IEDQDISP,R11                                          16200020
         USING *,RBASE                                                  16400020
*********************************************************************** 16410022
*        MISCELLANEOUS EQUATES                                        * 16420022
*********************************************************************** 16430022
XXXUSED  EQU   X'20'                                                    16600020
XXXPCISD EQU   X'51'                    PCI=X CODED             SA53639 16700022
ETBCH    EQU   8                        OFFSET TO ETB          @Z30X8IJ 16800008
DLESTXCH EQU   10                       OFFSET TO THE TABLE    @Z30X8IJ 17000008
ETXCH    EQU   ETBCH+1                  OFFSET TO DLE/ETX      @Z30X8IJ 17200008
TWO      EQU   2                        CONSTANT VALUE PRINT   @Z30X8IJ 17400008
NINE     EQU   9                        CONSTANT VALUE 9       @Z30X8IJ 17600008
DONE     EQU   X'01'                    LAST BIT INDICATOR     @Z30X8IJ 17800008
FLAGETB  EQU   X'20'                    ETB FLAG               @Z30X8IJ 18000008
ETBDONE  EQU   X'02'                    ETB FINISHED           @Z30X8IJ 18200008
LAST     EQU   X'02'                    LAST UNIT INDICATOR    @Z30X8IJ 18400008
TICCHECK EQU   X'07'                    INVALID TIC INDICATOR,   X01004 18600005
*                                       OR FLAG INDICATING A     X01004 18604005
*                                       NON-TIC OP CODE.         X01004 18608005
EIGHT    EQU   8                        LENGTH OF A CCW.         X01004 18612005
SEVEN    EQU   7                        3-BYTE ICM MASK.         X01004 18616005
ELEVEN   EQU   11                       CONSTANT               @Z30X8IJ 18620008
TWELVE   EQU   12                       CONSTANT VALUE 12      @Z30X8IJ 18624008
ONE      EQU   1                        CONSTANT.                Y01004 18628005
THREE    EQU   3                        CONSTANT.                Y01004 18632005
FOUR     EQU   4                        CONSTANT.                Y01004 18636005
ZERO     EQU   0                        CONSTANT                 X01004 18640005
X20      EQU   X'20'                    TPROCESS ENTRY FLAG     SA61750 18650005
         EJECT                                                          18700020
IEDQGT   IEDHJN GTSTART                                                 19100006
         L     RLCB,PRFLCB-1            ADDR OF LCB                     19600020
*        BUFFER ADDRESS IS IN REGISTER 6 WHEN ENTERED.           Y01004 19800005
         L     RSCB,LCBSCBA-1           SCB ADDR                        20000020
         TM    SCBQTYPE,SCBCONC         IS IT A CONCENTRATOR       @11A 20040026
         BZ    NOTCONTR                 BR IF NOT                  @11A 20080026
         ICM   RSCB,SEVEN,LCBSCBDA      GET TERMINAL SCB           @11A 20120026
         OI    PRFSTAT1,PRFNLSTN       INDICATE NOT LAST           @21A 20128027
         TM    SCBSTAT1,SCBCEND        IS IT CONC MSG END          @21A 20136027
         BZ    NOTCONTR                BRANCH NOT ENDOF MSG        @21A 20144027
         NI    PRFSTAT1,X'FF'-PRFNLSTN TURN OFF NOT LAST           @21A 20152027
NOTCONTR EQU   *                                                   @11A 20160026
         L     RDCB,LCBDCBPT            DCB ADDR                        20200020
         LA    RDCB,0(RDCB)              FORCE POSITIVE         SA63953 20300051
         SR    R12,R12                  CLEAR FOR IC'S                  20400020
*        AVTDOUBL FIRST WORD IS A WORK AREA TO BUILD FLAGS FOR CCWS     20800020
         MVI   AVTDOUBL,CCWCD+CCWSLI    MOVE CHAIN DATA AND    @Z30X8IJ 21000008
         MVI   AVTDOUBL+ONE,CCWCD+CCWSLI  SUPPRESS INCORRECT   @Z30X8IJ 21100008
*                                         LENGTH BITS          @Z30X8IJ 21200008
         MVC   AVTDOUBL+TWO(TWO),AVTFZERO  SET NO-PCI FLAGS.     Y01004 21400005
         TM    DCBPCI,XXXPCISD          PCI ON SEND SPEC.       SA53639 21600022
         BZ    NOSET                    BR NO                           21800020
         OI    AVTDOUBL,CCWPCI          SET PCI BIT            @Z30X8IJ 22000008
NOSET    EQU   *                                                        22200020
         NC    LCBLSPCI(3),LCBLSPCI     FIRST TIME                      22400020
         BZ    FIRSTONE                 BR IF FIRST                     22600020
         MVI   AVTDOUBL+3,X'FF'         SET INDICATOR FOR 0 LSPCIS21903 22800022
         LH    RETB,LCBETB(RLCB)        SET ETB SIZE                    23000020
         LTR   RETB,RETB                ANY LEFT                        23200020
         BNZ   AROUND                   BRANCH IF SIZE NOT ZERO. Y01004 23400005
GETETB   EQU   *                                                 Y01004 23460005
         LH    RETB,SCBBKFCT+ONE        GET ETB SIZE FROM SCB.   Y01004 23520005
AROUND   EQU   *                                                        23600020
         LH    RSIZE,PRFSIZE            SIZE OF BFR                     23800020
         LH    RKEY,AVTKEYLE            SIZE OF EACH UNIT               24000020
         LR    RUNIT,RPREFIX            INITIALIZE                      24200020
         IC    R12,PRFNBUNT             NO OF UNITS THIS BFR            24400020
         SR    R11,R11                  CLEAR R11                       24500020
         IC    R11,LCBISZE              IDLE CHARACTERS IN THIS BFR     24600020
         LA    R11,PRFSTXT-PRFSUNIT(R11)     TXT SIZE + IDLES           24700020
         TM    PRFSTAT1,PRFNHDRN        THIS A HDR                      24800020
         BO    SETSIZE                  BR NO                           25000020
         LA    R11,PRFSHDR-PRFSTXT(R11)  RESET FOR IDLES + HDR          25200020
SETSIZE  EQU   *                                                        25400020
         TM    PRFSTAT1,PRFCNCLN        SPECIAL ETB CHECK BFR           25600020
         BNO   OKETBRT                  BR NO                           25800020
         TM    SCBQTYPE,SCBCONC        IS IT CONCENTRATOR          @21A 25850027
         BZ    NOCONC                  DON'T SIMULATE CPC          @21A 25900027
         NI    PRFSTAT1,X'FF'-PRFCNCLN CLEAR CANCEL MSG            @21A 25950027
         B     NOCPC                                               @21A 26000027
NOCONC   EQU   *                                                   @21A 26050027
         OI    LCBCPA+12,XXXUSED       FORCE CHNL PGM CK                26100027
NOCPC    EQU   *                                                   @21A 26150027
         L     R8,LCBSCBA-1            GET CONCENTRATOR SCB        @21C 26200027
         LH    R11,SCBEOB-IEDQSCB(R8) GET COUNT TO EOB             @21A 26250027
         CLR   R11,RKEY                 IS IT IN FIRST UNIT             26600020
         BL    OKETBRT                  BR IF IN FIRST UNIT             26800020
SET      EQU   *                                                        27000020
         MVC   PRFOPCDE-IEDQPRF(8,RUNIT),LCBCPA SET DUMMY CCW  @XA03967 27020061
         L     RETB,DCBSCTAD-1          SCT ADDRESS            @XA03967 27040061
         SR    R8,R8                    EOT INDEX              @XA03967 27060061
         ICM   R8,ONE,THREE(RETB)       EOT OFFSET             @XA03967 27080061
         LA    R8,ONE(R8,RETB)          EOT SEQUENCE           @XA03967 27100061
         STCM  R8,SEVEN,PRFIOADR-IEDQPRF(RUNIT)                @XA03967 27120061
         NI    PRFFLAGS-IEDQPRF(RUNIT),AVTEFF-CCWCC RESET CHAIN@XA03967 27140061
         MVI   PRFTIC-IEDQPRF(RUNIT),CCWTIC  SET TIC IN BFR    @Z30X8IJ 27200008
         CR    R11,RKEY                 IS IT IN THIS UNIT              27400020
         BL    OUT                      BRANCH IF IN THIS ONE  @OS76520 27600091
         BCTR  R12,0                    DECREMENT BUFFER COUNT   S21903 27800022
         SR    RSIZE,RKEY               DECR SIZE BY 1 UNIT             28000020
         SR    R11,RKEY                DECR CNT TO ETB                  28200020
         L     RUNIT,PRFTIC-IEDQPRF(RUNIT) NEXT UNIT             S21903 28400022
         B     SET                      BRANCH TO CHECK NEXT UNITS21903 28600022
OUT      EQU   *                                                        28800020
         MVI   AVTDOUBL+3,X'FF'         FORCE NOT FIRST TIME            28900020
         ST    RUNIT,LCBWRSTX+8(RLCB)   SET ADDR OF UNIT TO WRITE       29000020
         MVI   LCBWRSTX+8(RLCB),CCWTIC  SET TIC OP CODE                 29200020
         ST    RUNIT,LCBNEXT(RLCB)      SET ADDR OF NEXT UNIT  @Z30X8IJ 29400008
*                                         TO BE SENT           @Z30X8IJ 29500008
         LH    RETB,SCBBKFCT+1          ETB COUNT                       29600020
OKETBRT  EQU   *                                                        29800020
         SR    RSIZE,R11                ADJUST NO OF BYTES TO WR        30000020
         SR    RKEY,R11                 AND BYTES IN UNIT               30200020
         CLI   AVTDOUBL+3,X'FF'         INDICATOR SET            S21903 30400022
         BNE   CKWRETX1                 BRANCH TO CHECK SIZE     S21903 30600022
         TM    LCBCPA+12,XXXUSED        CHANL. PGM. CK.                 30800020
         BNO   SETFLAGS                 BRANCH IF NO.            Y01004 31000005
CKWRETX1 EQU   *                                                 Y01004 31010005
         CR    RSIZE,RETB               IS DATA SIZE LARGER THAN Y01004 31020005
*                                       ETB SIZE                 Y01004 31030005
         BH    SETFLAGS                 BRANCH IF YES - NO STX   Y01004 31040005
*                                       SHOULD BE WRITTEN.       Y01004 31050005
         TM    PRFSTAT1,PRFNLSTN        IS THIS THE LAST BLOCK   Y01004 31060005
         BO    SETFLAGS                 BRANCH IF NO.            Y01004 31070005
* IF FIRST BLOCK IS ALSO LAST BLOCK, WRITE ETX INSTEAD OF ETB.   Y01004 31080005
         ST    R11,AVTDOUBL+FOUR        SAVE ETB SIZE.           Y01004 31090005
         L     R10,DCBSCTAD-ONE         ADDRESS OF SPECIAL       Y01004 31100005
*                                       CHARACTERS TABLE.        Y01004 31110005
         SR    R11,R11                  CLEAR FOR IC.            Y01004 31120005
         IC    R11,ETXCH(,R10)          GET OFFSET TO DLE/ETX.   Y01004 31130005
         LA    R11,ONE(R10,R11)         ADDRESS OF DLE/ETX.      Y01004 31140005
         ST    R11,LCBWRETB(,RLCB)      SET ADDRESS FOR WRITE.   Y01004 31150005
         MVI   LCBWRETB(RLCB),CCWWRITE  SET WRITE OP CODE.       Y01004 31160005
         OI    LCBWRETB+FOUR(RLCB),CCWSKIP  SET ON SKIP FLAG.    Y01004 31170005
         L     R11,AVTDOUBL+FOUR        RESTORE ETB SIZE.        Y01004 31180005
SETFLAGS EQU   *                                                        31200020
         ICM   R8,TWO,AVTDOUBL          GET CCW FLAGS            X01004 31400005
         IC    R8,AVTDOUBL+2            PCI FLAGS OPTION                31800020
         LA    R11,AVTUMALN(R11,RUNIT)     ADDR FOR WRITE               32000008
BLDCCWS  EQU   *                                                        32200020
         MVC   LCBWORK+1(3,RLCB),PRFTIC+1-IEDQPRF(RUNIT)                32400020
         ST    R11,PRFOPCDE-IEDQPRF(RUNIT)      CCW ADDR                32600020
         MVI   PRFOPCDE-IEDQPRF(RUNIT),CCWWRITE                         32800020
         STH   R8,PRFFLAGS-IEDQPRF(RUNIT)   SET FLAGS                   33000020
         MVI   PRFTIC-IEDQPRF(RUNIT),CCWTIC  SET TIC OP CODE.    Y01004 33100005
*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *     33200020
*                                                                       33400020
*        THE CCW IN EACH UNIT MUST WRITE OUT THE SMALLEST OF 3          33600020
*        THINGS. -- SIZE OF DATA, SIZE OF ETB, OR UNIT LENGTH.          33800020
*                                                                       34000020
*  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *     34200020
COMPARE  EQU   *                                                        34400020
         CR    RETB,RKEY                IS ETB LESS THAN KEY            34600020
         BNH   CKSIZE                   BR YES - ETB LESS OR = TO KEY   34800020
         CR    RSIZE,RKEY               IS SIZE LESS THAN KEY           35000020
         BL    SETSIZE1                 BR IF SIZE IS LOW               35200020
         LR     R0,RKEY                 SET FOR STH                     35400020
         SR    RETB,RKEY                DECR CTS FOR ETB                35600020
         SR    RSIZE,RKEY               AND SIZE                        35800020
         B     COMMON                   EXECUTE COMMON CODE.     Y01004 35810005
CKSIZE   EQU   *                                                 Y01004 35820005
         CR    RETB,RSIZE               IS ETB SIZE LESS THAN    Y01004 35830005
*                                       DATA SIZE                Y01004 35840005
         BNH   SETETB                   BRANCH IF ETB SIZE IS    Y01004 35850005
*                                       LOW OR EQUAL.            Y01004 35860005
SETSIZE1 EQU   *                                                 Y01004 35870005
         LR    R0,RSIZE                 SET R0 FOR STH.          Y01004 35880005
         SR    RKEY,RSIZE               DECREMENT KEY SIZE.      Y01004 35890005
         SR    RETB,RSIZE               DECREMENT ETB SIZE.      Y01004 35900005
COMMON   EQU   *                                                        36000020
         LTR   RDCB,RDCB                IS CCW TO BE BUILT              36200020
         BM    DECR                     BR NO                           36400020
         STH   R0,PRFCOUNT-IEDQPRF(RUNIT)  STORE SIZE IN BUFFER@Z30X8IJ 36600008
DECR     EQU   *                                                        36800020
         BCT   R12,NEXTUNIT             IS THERE A NEXT UNIT BR YES     37000020
         STH   RETB,LCBETB(RLCB)        SAVE ETB COUNT FOR NEXT BFR     37400020
         TM    PRFSTAT1,PRFNLSTN        LAST BFR                        37600020
         BO    NOFLAG                   BR NO                           37800020
*        SOME TERMINALS MUST HAVE EVEN BLK SIZE WRITTEN TO THEM         38000020
*        IN TRANSPARENT MODE                                            38200020
         LTR   RETB,RETB                IS BLKSIZE DEPLETED             38400020
         BZ    CONTINUE                 BR YES                          38600020
         SR    RSIZE,RSIZE              ZERO FOR IC                     38800020
         TM    PRFTIC-IEDQPRF(RUNIT),FLAGETB   ETB THIS BFR UNIT        39000020
         BZ    NOETB                    BRANCH IF NO.            Y01004 39200005
         IC    RSIZE,PRFOPCDE-IEDQPRF(,RUNIT)  ASSUME YES.       Y01004 39250005
         B     ETBTHERE                 GO CALCULATE START ADDR. Y01004 39300005
NOETB    EQU   *                                                 Y01004 39350005
         TM    PRFTIC+3-IEDQPRF(RUNIT),LAST   FLAGGED LAST              39400020
         BNO   NOTLAST                  YES-IT HAS BEEN LINKED @OY15018 39600091
         MVI   PRFOPCDE-IEDQPRF(RUNIT),AVTEZERO DLE ETX SIGNAL @OY15018 39660091
         MVI   PRFFLAGS-IEDQPRF(RUNIT),CCWSLI+CCWCD PCI OFF    @OY15018 39680091
         B     ETBTHERE                 GO CALC START ADDRESS  @OY15018 39700091
NOTLAST  EQU   *                                               @OY15018 39720091
         IC    RSIZE,LCBCOUNT(RLCB)     GET COUNT FROM LCB              39800020
ETBTHERE EQU   *                                                        40600020
         LA    RKEY,AVTUMALN(RUNIT)     ADDR OF DATA START              40800020
         SR    R10,R10                  CLEAR FOR ICM            X01004 41000005
         ICM   R10,SEVEN,PRFIOADR-IEDQPRF(RUNIT) ADDR OF START   X01004 41100005
*                                                WRITE           X01004 41200005
         SR    R10,RKEY                 DATAT START - WRITE STATR       41400020
*        IS AMOUNT NOT INCLUDED IN CCW COUNT ( INCLUDES PRFX + IDLES    41600020
          AR   RSIZE,R10                                                41800020
         AH    RSIZE,PRFCOUNT-IEDQPRF(RUNIT)    TOTAL SIZE OF DATA      42600020
         LA    R8,AVTUMALN-1(RUNIT,RSIZE)   ADDR OF LAST DATA BYTE      42620020
         TM    SCBBSCFM,SCBNPDTR        DOES HE WANT PADDING     S99238 42625022
         BO    CONTINUE                 NO,CONTINUE            @OY15018 42630091
         SPACE                                                          42635022
         CLI   0(R8),X'37'              IS IT AN EOT                    42640020
         BNE   PADTEST                  BR NOT EOT                      42660020
         LH    R10,PRFSRCE              SOURCE OFFSET           SA61750 42661005
         N     R10,AVTCLRHI             CLEAR HIGH HALF         SA61750 42662005
         BZ    SETBLANK                 BRANCH IF YES           SA61750 42663005
         ST    RUNIT,AVTDOUBL+4         SAVE REGISTER ONE       SA61750 42664005
         LR    RUNIT,R10                SOURCE OFFSET           SA61750 42665005
         LR    R10,RBASE                SAVE BASE REG           SA61750 42666005
         L     RBASE,AVTRNMPT           CONVERSION LOGIC        SA61750 42667005
         BALR  R14,RBASE                COMPUTE TNT ENTRY ADDR  SA61750 42668005
         LR    RBASE,R10                RESTORE BASE REGISTER   SA61750 42669005
         LR    R10,RUNIT                TNT ENTRY ADDRESS       SA61750 42670005
         L     RUNIT,AVTDOUBL+4         RESTORE REGISTER ONE    SA61750 42671005
         TM    TRMSTATE-IEDQTRM(R10),X20 PROCESS ENTRY          SA61750 42672005
         BO    PADTEST                  BRANCH IF YES           SA61750 42673005
SETBLANK EQU   *                                                SA61750 42674005
         MVI   0(R8),X'40'              BLANK OUT EOT                   42680020
PADTEST  EQU   *                                                        42700020
         CH    RETB,SCBBKFCT+1          ANY LEFT IN THIS BLK    SA50219 42760000
         BE    CONTINUE                 BR NO                   SA50219 42780000
CKBLK    EQU   *                                                        42800020
         LH    RKEY,AVTKEYLE            GET KEYLENGTH                   43000020
         SR    RKEY,RSIZE               DECR KEY BY AMT THERE           43200020
         CLR   RKEY,RETB                WILL ALL PADS FIT THIS UNIT     43400022
         BL    EXKEY                    BR NO                           43600020
         LR    R10,RETB                 SET AMT TO MOVE                 43800020
         MVI   PRFOPCDE-IEDQPRF(RUNIT),AVTEZERO                 SA63953 43860051
         MVI   PRFFLAGS-IEDQPRF(RUNIT),CCWSLI+CCWCD PCI OFF    @OY12980 43890091
*        SET NO MORE TO SEND                                    SA63953 43920051
         BAL   R14,MOVEIT               BRANCH TO INSERT PADS    S21903 44000022
         B     CONTINUE                 BRANCH TO CONTINUE TEST  S21903 44200022
MOVEIT   EQU   *                                                        44400020
         LTR   R10,R10                  ANY TO MOVE                     44600020
         BCR   8,R14                    NO RETURN                       44800020
         LA    R8,AVTUMALN(RUNIT,RSIZE)  ADDR FIRST BYTE TO PAD         45000020
         MVI   0(R8),X'40'              SET BLANK FOR PAD               45200020
         BCT   R10,MOVEBLK              BR IF MORE THAN 1 BYTE          45400020
         LA    R10,1                    IF JUST 1 IT IS DONE ALREADY    45600020
         B     NOMOVE                   BRANCH                   S21903 45800022
*                                                                       45810022
MOVEBLK  EQU   *                                                        46000020
         BCTR  R10,0                    DECREMENT COUNT          S21903 46200022
         EX    R10,MOVE                 MOVE IN PADS                    46400020
         LA    R10,2(R10)               ADD 2 BACK                      46600020
NOMOVE   EQU   *                                                        46800020
         LR    R8,R10                   PUT SIZE INTO REG 8    @Z30X8IJ 46850008
         AH    R8,PRFSIZE               INCR SIZE BY NO. OF PADS A44884 46900022
         STH   R8,PRFSIZE               RESET PRFSIZE TO NEW NO. A44884 46950022
         SR    R8,R8                    CLEAR REGISTER 8       @Z30X8IJ 47000008
         TM    PRFTIC-IEDQPRF(RUNIT),FLAGETB    ETB THIS UNIT           47200020
         BO    SETTIC                   BR IF ETB TO SET TIC     S21903 47400022
         TM    PRFTIC+3-IEDQPRF(RUNIT),LAST      THIS LAST              47600020
         BO    LASTUNIT                 BRANCH IF YES.           Y01004 47800005
         IC    R8,LCBCOUNT(,RLCB)       GET REMAINING UNIT SIZE. Y01004 47830005
         AR    R10,R8                   CALCULATE NEW SIZE.      Y01004 47860005
         STC   R10,LCBCOUNT(,RLCB)      UPDATE SIZE IN LCB.      Y01004 47890005
         BR    R14                      RETURN.                  Y01004 47920005
LASTUNIT EQU   *                                                 Y01004 47950005
         AH    R10,PRFCOUNT-IEDQPRF(RUNIT)    GET NEW COUNT             48000020
         STC   R10,PRFCOUNT+1-IEDQPRF(RUNIT)   SET NEW COUNT            48200020
         TM    LCBCPA+12,XXXUSED        CHNL PGM CK                     48420020
         BCR   14,R14                   BR NO TO RETURN                 48440020
         TM    LCBCPA+12,ETBDONE        HAS AN ETB BEEN FOUND           48460020
         BCR   1,R14                    BR IF YES - NO CHANGES          48480020
         MVI   PRFOPCDE-IEDQPRF(RUNIT),CCWWRITE   SET OP CDE            48500020
         MVI   LCBCOUNT(RLCB),AVTEZERO  SET NO COUNT LEFT               48520020
         BR    R14                      RETURN                   S21903 48600022
MOVE     MVC   1(0,R8),0(R8)            PROPAGATE BLANKS                48800020
SETTIC   EQU   *                                                        49000020
         IC    R8,PRFOPCDE-IEDQPRF(RUNIT)    SAVE SIZE                  49200020
         AR    R10,R8                   FOR NEW SIZE LEFT               49400020
         STC   R10,PRFOPCDE-IEDQPRF(RUNIT)                              49600020
         BR    R14                      RETURN                   S21903 49800022
*                                                                       50810022
EXKEY    EQU   *                                                        51000020
         LR    R10,RKEY                 ANY TO MOVE              S21903 51200022
         BAL   R14,MOVEIT               MOVE REST OF UNIT               51400020
         SR    RETB,RKEY                DECR ETB COUNT                  51600020
         SR    R8,R8                    CLEAR FOR ICM.           Y01004 51800005
         ICM   R8,SEVEN,AVTBFREB+ONE    GET BUFFER ADDRESS.      Y01004 51900005
         BZ    CONTINUE                 BRANCH IF NO BUFFERS ARE Y01004 52000005
*                                       AVAILABLE.               Y01004 52100005
         MVC   AVTBFREB+1(3),PRFLINK-IEDQPRF(R8)                        52400020
         TM    PRFTIC+3-IEDQPRF(RUNIT),LAST                             52600020
         BO    NEWTIC                   BRANCH IF LAST UNIT.     Y01004 52800005
         ST    R8,LCBNEXT(,RLCB)        SET ADDRESS OF NEXT UNIT Y01004 52830005
*                                       TO BE SENT.              Y01004 52860005
         MVI   PRFTIC+THREE-IEDQPRF(R8),LAST  SET NEW LAST UNIT. Y01004 52890005
         B     TICFIXED                 GO UPDATE UNIT COUNT.    Y01004 52920005
NEWTIC   EQU   *                                                 Y01004 52950005
         L     R10,PRFTIC-IEDQPRF(RUNIT)   SAVE TIC ADDR                53000020
         STCM  R8,SEVEN,PRFTIC+ONE-IEDQPRF(RUNIT)  SET NEW TIC   Y01004 53200005
*                                       ADDRESS IN UNIT.         Y01004 53400005
         STCM  R10,SEVEN,PRFTIC+ONE-IEDQPRF(R8)  SET TIC FOR NEW Y01004 53600005
*                                       UNIT.                    Y01004 53800005
TICFIXED EQU   *                                                        54000020
         LR    RUNIT,R8                 NEW LAST UNIT ADDR              54200020
         IC    R8,PRFNBUNT              ADD TO UNIT COUNT               54400020
         LA    R8,ONE(R8)               INCREMENT UNIT COUNT   @Z30X8IJ 54600008
         STC   R8,PRFNBUNT              PUT COUNT IN BUFFER    @Z30X8IJ 54700008
         LH    R8,AVTAVFCT              GET AVAIL BFR COUNT    @Z30X8IJ 54800008
         BCTR  R8,R0                    DECREMENT THE COUNT      S21903 54900022
         STH   R8,AVTAVFCT              OF AVAILABLE BFRS               54950020
         XC    PRFFLAGS-IEDQPRF(4,RUNIT),PRFFLAGS-IEDQPRF(RUNIT)        55000020
         MVI   PRFFLAGS-IEDQPRF(RUNIT),CCWSLI+CCWCD   SET FLAGS         55200020
         LA    R8,AVTUMALN(RUNIT)       ADDR TO WRITE                   55400020
         ST    R8,PRFIOADR-ONE-IEDQPRF(RUNIT)  PUT WRITE ADDR  @Z30X8IJ 55600008
*                                                IN BUFFER     @Z30X8IJ 55700008
         MVI   PRFOPCDE-IEDQPRF(RUNIT),AVTEZERO ZERO CMD FIELD @Z30X8IJ 55800008
         MVI   PRFTIC-IEDQPRF(RUNIT),CCWTIC  PUT TIC IN BUFFER @Z30X8IJ 55900008
         SR    RSIZE,RSIZE              CLEAR REGISTER 8       @Z30X8IJ 56000008
         B     CKBLK                    BRANCH TO CHECK BLOCK    S21903 56400022
CONTINUE EQU   *                                                        57400020
         TM    PRFTIC-IEDQPRF(RUNIT),FLAGETB       SET ALREADY          57600020
         BO    NOFLAG                   BR YES                          57800020
         OI    PRFTIC-IEDQPRF(RUNIT),FLAGETB                            58000020
         TM    LCBCPA+12,XXXUSED        CHNL PGM CK                     58200020
         BNO   NOSETA                   BR NO                           58400020
         TM    LCBCPA+12,ETBDONE        HAS ETB BEEN DONE BEFORE        58600020
         BO    NOSETA                   BR YES                          58800020
         LR    R0,RKEY                  SET REMAINING CT IN R0  SA63953 58900051
         BAL   R8,SETWRETB              BRANCH TO SET WRITE ETB  S21903 59000022
NOSETA   EQU   *                                                        59200020
         NI    PRFFLAGS-IEDQPRF(RUNIT),X'FF'-CCWCD    CHAIN OFF         59400020
         OI    PRFFLAGS-IEDQPRF(RUNIT),CCWCC      NEW FLAG              59600020
         OI    LCBCPA+12,ETBDONE        SET ETB DONE FOR PADS           59800020
NOFLAG   EQU   *                                                        60000020
         CLI   AVTDOUBL+3,X'FF'         INDICATOR SET            S21903 60200022
         BNE   FIRST                    BRANCH IF NOT SET        S21903 60400022
         L     R10,LCBLAST(RLCB)        GET LAST UNIT OF PREV. BFR      60600020
         ST    RUNIT,LCBLAST(RLCB)                                      60800020
         TM    PRFSTAT1,PRFCNCLN        ETB ERROR RECOVERY              61000020
         BO    TESTCPA                  BRANCH IF YES            S21903 61200022
         TM    PRFTIC+3-IEDQPRF(R10),LAST                               61400020
         BO    NONEXT                   BRANCH IF LAST UNIT.     Y01004 61600005
         STCM  RPREFIX,SEVEN,LCBNEXT+ONE(RLCB)  SET ADDRESS OF   Y01004 61700005
*                                       NEXT UNIT TO BE SENT.    Y01004 61800005
         B     TESTCPA                  TEST FOR CHANNEL PGM CHK Y01004 61900005
NONEXT   EQU   *                                                 Y01004 62000005
         STCM  RPREFIX,SEVEN,PRFTIC+ONE-IEDQPRF(R10)  SET ADDR.  Y01004 62100005
*                                       OF NEXT BUFFER.          Y01004 62200005
TESTCPA  EQU   *                                                        62400020
         TM    LCBCPA+12,XXXUSED        CHANNEL PROGRAM CHECK    S21903 62600022
         BNO    RETURN                  BR IF NO                        62800020
         B     KEEPON                   CONTINUE CHECKING        S21903 63000022
FIRSTONE EQU   *                                                        64200020
         XC    LCBNEXT+1(3,RLCB),LCBNEXT+1(RLCB)                        64250020
*        THIS FIELD SHOULD BE CLEARED AT FIRST TIME                     64300020
         MVI   LCBCOUNT(RLCB),AVTEZERO  RESET AMT LEFT TO WRITE TO 0    64350020
         NI    LCBCPA+12,X'FF'-ETBDONE  SET FLAG OFF                    64400020
         XC    LCBWRSTX+9(3,RLCB),LCBWRSTX+9(RLCB)   CLEAR              64600020
         MVI   LCBWRSTX+EIGHT(RLCB),CCWTIC SET DLE/STX'S TIC OP  Y01004 64660005
*                                       CODE ONCE, THEN NO MORE. Y01004 64720005
*        CPA MUST BE INITIALIZED FOR WR DLE ETB, RD RESP, WR DLE STX    64800022
         STCM  RPREFIX,SEVEN,LCBLSPCI   SET UP LCBLSPCI.         Y01004 65000005
         L     R10,DCBSCTAD-1           ADDR OF SPECIAL CHARS. TBL      65600020
         IC    R12,ETBCH(R10)           OFFSET TO ETB CHAR.             65800020
         LA    R11,1(R10,R12)           ADDR OF DLE ETB                 66000020
         ST    R11,LCBWRETB(RLCB)       DCW ADDR                        66200020
         MVI   LCBWRETB(RLCB),CCWWRITE                                  66400020
         MVI   LCBWRETB+4(RLCB),CCWCC+CCWSLI                            66600020
         MVI   LCBWRETB+7(RLCB),TWO                                     66800020
         MVI   LCBTPCD+3,TPDLEETX      SET TP OP CODE                   67000020
         MVI   LCBTPCD+4,TPRDRPEB       SET TP OP CODE           S21903 67200022
         MVI   LCBTPCD+5,TPDLESTX       SET TP OP CODE           S21903 67400022
         LA    RSIZE,LCBERCCW+12        ADDR FOR READ                   67600020
         ST    RSIZE,LCBRDRSP(RLCB)     ADDR                            67800020
         MVI    LCBRDRSP(RLCB),CCWREAD    OPCODE                        68000020
         MVI   LCBRDRSP+4(RLCB),AVTEZERO    NO FLAGS                    68200020
         MVI    LCBRDRSP+7(RLCB),NINE   COUNT                           68400020
         IC    R12,DLESTXCH(R10)        CHARACTERS TBL OFFSET           68600020
         LA    R11,1(R10,R12)           CHAR. ADDRESS                   68800020
         ST    R11,LCBWRETX(RLCB)       CCW ADDR                        69000020
         MVI    LCBWRETX(RLCB),CCWWRITE  OP CODE                        69200020
         MVI   LCBWRETX+4(RLCB),CCWCD+CCWSLI                            69400020
         MVI    LCBWRETX+7(RLCB),TWO     COUNT                          69600020
         B     GETETB                   GO GET ETB SIZE FROM SCB Y01004 69800005
FIRST    EQU   *                                                        70400020
         ST    RUNIT,LCBLAST(RLCB)      SET ADDR OF LAST UNIT THIS BFR  70600020
         NC    LCBWRSTX+9(3,RLCB),LCBWRSTX+9(RLCB)  IS IT SET           70800020
         BNZ   KEEPON                   BR IF SET ALREADY               71000020
         STCM  RPREFIX,SEVEN,LCBWRSTX+NINE(RLCB)  SET THE WRITE  Y01004 71200005
*                                       DLE/STX TO TIC TO BUFFER Y01004 71400005
KEEPON   EQU   *                                                        71600020
         TM    LCBCPA+TWELVE,ETBDONE    ARE WE SET TO SEND BLOCK X01004 71800005
         BNO   RETURN                   BRANCH IF NO.            X01004 71808005
         STM   R11,RBASE,AVTSAVE2  SAVE REGISTERS USED BY MACROS Y02027 71808106
         MODESET MODE=SUP                                               71816006
*                                       GET INTO SUPERVISOR MODE Y02027 71836006
         MODESET EXTKEY=SUPR                                            71856006
*                                       GET INTO SUPERVISOR KEY  Y02027 71876006
         LR    R10,RAVT                 SAVE AVT ADDRESS         Y02027 71940006
SETTRAN  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=CHANNEL PROGRAM,X71960006
               IGE0004G(SETERP),IGE0004H(SETERP),IGG019QE(SETERP),     X71980006
               IEDQGA(SETASSC,SETCONC),'PCI LINEEND,AND START I/O      X72000006
               APPENDAGES ARE LOCKED ON THIS RESOURCE THRU THE EXCP    X72020006
               PROCESSOR ISSUING SETLOCK (ERP,BUFFER ASSOCIATION AND   X72040006
               TRANSPARENT CCW BUILD MUST ISSUE SETLOCK'                72060006
         LR    RAVT,R10                 RESTORE AVT ADDRESS      Y02027 72080006
         LM    R11,RBASE,AVTSAVE2       RETORE REGISTERS USED    Y02027 72100006
*                                       BY MACROS                Y02027 72106006
PCILOCK  EQU   *                                                 Y02027 72112006
         TS    LCBPCILK                 PCI ACTIVE ON THIS LINE  Y02027 72118006
         BNE   PCILOCK                  YES, LOOP FOR MP TILL    Y02027 72124006
*                                       PCI COMPLETE             Y02027 72130006
         LA    RKEY,LCBWRSTX(,RLCB)     RKEY HAS ADDRESS OF      Y01004 72140005
*                                       WRITE DLE/STX.           Y01004 72150005
         TM    LCBCPA+FOUR,CCWCC+CCWCD  REAL CHANNEL PROGRAM     Y01004 72160005
         BNO   DONE2                    BRANCH NO                Y01004 72170005
*                                                                Y01004 72200005
REAL     EQU   *                                                 Y01004 72210005
         LR    RETB,RKEY                TIC TO ADDRESS TO RETB   Y01004 72220005
         ICM   R10,SEVEN,PRFIOADR-IEDQPRF(RKEY) DATA ADDRESS     Y01004 72230005
         LRA   R10,0(,R10)              CONVERT TO REAL ADDRESS  Y01004 72240005
         STCM  R10,SEVEN,PRFIOADR-IEDQPRF(RKEY) SET REAL         Y01004 72250005
         TM    PRFFLAGS-IEDQPRF(RKEY),CCWCC+CCWCD LAST CCW       Y01004 72260005
         BZ    DONE1                    BRANCH YES               Y01004 72270005
*                                                                Y01004 72280005
         LA    RKEY,EIGHT(,RKEY)        BUMP TO NEXT CCW         Y01004 72290005
         TM    PRFOPCDE-IEDQPRF(RKEY),SEVEN  NEXT CCW A TIC      Y01004 72300005
         BNZ   REAL                     BRANCH YES - CONVERT     Y01004 72310005
*                                                                Y01004 72320005
         ICM   RKEY,SEVEN,PRFTIC-IEDQPRF+1(RETB) TIC TO ADDRESS  Y01004 72330005
         CLM   RBASE,EIGHT,FLAG         HAS LSPCI BEEN DONE     OX01433 72332005
         BE    CCWOK                    BR YES                  OX01433 72334005
         LA     RSIZE,0(RKEY)           ADDR OF FIRST UNIT      OX01433 72336005
*        IN CHANNEL PROGRAM                                     OX01433 72338005
         LA    R10,LCBERCCW             LCBCPA START            OX01433 72340005
         SR    R10,RSIZE                IS CCW BEFORE LCB       OX01433 72342005
         BP    PKLSPCI                  BR YES                  OX01433 72344005
         L     RSIZE,LCBDCBPT           ADDR OF DCB             OX01455 72346005
         SR    R10,R10                  CLAER FOR IC            OX01455 72348005
         IC    R10,DCBEIOBX-IHADCB(RSIZE)  LCB SIZE             OX01455 72350005
         AR    R10,RLCB                 END OF CPA              OX01455 72352005
         LA    RSIZE,0(RKEY)            RESET RSIZE             OX01455 72354005
         SR    R10,RSIZE                IS CCW PAST LCB         OX01433 72356005
         BP    CCWOK                    BR IS CCW IS IN LCB     OX01433 72358005
PKLSPCI  EQU   *                                                OX01433 72360005
         CLM   RKEY,SEVEN,LCBLSPCI      IS THIS UNIT FIRST INPCIOX01433 72362005
         BE    SETSW                    BR IF FIRST             OX01433 72364005
         L     R10,LCBLSPCI-1           GET LSPCI FIRST UNIT    OX01433 72366005
         BAL   RSIZE,SETOPCD            SET 0 OPCODE            OX01433 72368005
         ICM   R10,SEVEN,PRFTIC+1-IEDQPRF(R10)                  OX01455 72370005
*        NEXT UNIT IN LSPCI                                     OX01433 72372005
SETOPCD  EQU   *                                                OX01433 72374005
         MVI   PRFOPCDE-IEDQPRF(R10),AVTEZERO                   OX01433 72376005
*        SET 0 OP CODE                                          OX01433 72378005
         CLM   RKEY,SEVEN,PRFTIC+ONE-IEDQPRF(R10)               OX01433 72380005
*              IS THIS THE FIRST IN CHNL PGM                    OX01433 72382005
         BNER  RSIZE                    BR IF NOT               OX01433 72384005
         LRA   RSIZE,0(RKEY)            CONVERT TO REAL         OX01433 72386005
         STCM  RSIZE,SEVEN,PRFTIC+ONE-IEDQPRF(R10)              OX01433 72388005
*              SET REAL TIC                                     OX01433 72390005
         OI    PRFTIC-IEDQPRF(R10),CCWREAL FLAG AS REAL         OX01433 72392005
SETSW    EQU   *                                                OX01433 72394005
         ICM   RBASE,EIGHT,FLAG         SET LSPCI DONE          OX01433 72396005
CCWOK    EQU   *                                                OX01433 72398005
         LRA   R10,0(,RKEY)             CONVERT TO REAL          Y01004 72400005
         STCM  R10,SEVEN,PRFTIC-IEDQPRF+1(RETB) SET REAL TIC TO  Y01004 72420005
         OI    PRFTIC-IEDQPRF(RETB),AVTE80 SET REAL OP CODE      Y01004 72440005
         TM    PRFTIC-IEDQPRF+THREE(RETB),TICCHECK INVALID TIC   Y01004 72460005
         BZ    REAL                     BNCH NO - CONTINUE       Y01004 72480005
*                                                                Y01004 72500005
DONE1    EQU   *                                                 Y01004 72520005
         LRA   RKEY,LCBWRSTX(,RLCB)     REAL ADDR OF WRITE DLE   Y01004 72540005
DONE2    EQU   *                                                 Y01004 72560005
         ICM   RKEY,EIGHT,LCBCPA+EIGHT  TIC OP CODE              Y01004 72580005
         TM    LCBCPA+EIGHT,AVTE80      CHANNEL PROGRAM ACTIVE?      VM 72581006
         BNO   NOVIRT                   NO,BRANCH                    VM 72582006
         L     R10,AVTSAVTP             SECONDARY AVT POINTER        VM 72583006
         L     R10,SAVTDIAG-IEDNSVTD(0,R10) VM DIAG ROUTINE          VM 72584006
         LTR   R10,R10                  IN VM MACHINE ?              VM 72585006
         BZ    NOVIRT                   NO,BRANCH                    VM 72586006
         ST    RBASE,AVTSAVE2+TWELVE    SAVE REGISTER 15          M VM  72587006
         LA    R0,LCBCPA+EIGHT          ADDR OF TIC,IEDQDA PARAMETER VM 72588006
         ST    RLCB,AVTSAVE2            CURRENT LCB ADDRESS          VM 72589006
*                                       ALSO PARAMETER FOR IEDQDA    VM 72590006
         LR    RBASE,R10                VM DIAG ROUTINE ADDR         VM 72591006
         ST    RKEY,LCBCPA+EIGHT        LINK INTO VIRTUAL CHANNEL    VM 72592006
*                                       PROGRAM                      VM 72593006
         BALR  R14,RBASE                LINK INTO REAL               VM 72594006
*                                       CHANNEL PROGRAM              VM 72595006
         L     RBASE,AVTSAVE2+TWELVE    RESTORE REG 15         M     VM 72596006
         B     ENDVIRT                  DONE WITH VM SUPPORT CODE    VM 72597006
NOVIRT   EQU   *                                                     VM 72598006
         ST    RKEY,LCBCPA+EIGHT        LINK INTO CHANNEL PROGRAMY01004 72600005
*                                       IN CHANNEL PGM. IN LCB.  X01004 72620005
ENDVIRT  EQU   *                                                     VM 72622006
         MVI   LCBCPA+TWELVE,AVTEZERO   RESET CHANNEL PGM. CHECK X01004 72640005
*                                       FLAG IN LCB.             X01004 72660005
         MVI   LCBPCILK,ZERO            CLEAR PCI LOCK FOR MP    Y02027 72670006
         STM   R11,RBASE,AVTSAVE2       SAVE REGS USED BY      @OZ11198 72680091
*                                       SETLOCK ROUTINE          Y02027 72720006
         LR    R10,RAVT                 SAVE AVT ADDRESS         Y02027 72760006
RSETTRAN SETLOCK RELEASE,TYPE=LOCAL,RELATED=CHANNEL PROGRAM,           X72800006
               IEDQGT(SETTRAN)                                          72840006
         LR    RAVT,R10                 RESTORE AVT ADDRESS      Y02027 72880006
*                                       SETLOCK ROUTINE          Y02027 72960006
         MODESET EXTKEY=TCAM                                            73000006
*                                       RESET KEY TO TCAM'S KEY  Y02027 73040006
         MODESET MODE=PROB                                              73080006
*                                       RESET TO PROBLEM PROGRAM Y02027 73120006
*                                       MODE                     Y02027 73160006
         LM    R11,RBASE,AVTSAVE2       RESTORE REGISTERS USED @OZ11198 73162091
         CLI   LCBINCAM,AVTEFF          EXCP NEEDED            @OY12651 73164091
         BNE   RETURN                   NO,RETURN              @OY12651 73168091
         MVI   LCBINCAM,AVTEZERO        RESET EXCP NEEDED      @OY12651 73172091
         NI    LCBCHAIN,AVTEFF-LCBSCRNN RESET SCREEN RQST BIT  @OY12651 73176091
         LA    RUNIT,LCBCPA             GET START ADDRESS      @OY16444 73178000
         STCM  RUNIT,SEVEN,LCBSTART     SET START ADDRESS      @OY16444 73180000
         LA    RUNIT,LCBFLAG1           IOB ADDRESS            @OY12651 73188091
         EXCPVR (1),SUBSYS                                     @OY12651 73192091
         LR    RBASE,R11                RESTORE BASE           @OY16444 73196000
RETURN   DS    0H                                                Y01004 73200005
         L    R11,AVTEA                 DISPATCHER BASE                 73400020
         TM    SCBQTYPE,SCBCONC        IS IT CONCENTRATOR          @21A 73410027
         BZ    DSPDISP                 NO GO TO DISP               @21A 73420027
         L     R14,LCBSCBA-1           GET CONC SCB                @21A 73430027
         SR    RUNIT,RUNIT             CLEAR REG ONE               @21A 73440027
         IC    RUNIT,AVTCSCH           GET OFFSET TO CTBFORM       @21A 73450027
         L     R10,AVTMSGS-1           GET ADDR OF VCONS           @21A 73460027
         L     R10,0(RUNIT,R10)        GET ADDR OF IEDQGH          @21A 73470027
         AH    R10,4(R10)              POINT TO SAVED SCBEOB       @21A 73480027
         LH    RUNIT,0(R10)            PICK UP SAVED SCBEOB        @21A 73490027
*                     THE SAVED SCBEOB IS A CONSTANT IN IEDQGH     @21A 73500027
         AH    RUNIT,SCBEOBAC-IEDQSCB(R14) PUT IN CONC SCB         @21A 73510027
         STH   RUNIT,SCBEOB-IEDQSCB(R14) SAVE IN CONC SCBEOB       @21A 73520027
         XC    SCBEOBAC-IEDQSCB(2,R14),SCBEOBAC-IEDQSCB(R14)       @21A 73530027
*                        ZERO OUT SCBEOBAC IN CONC SCB             @21A 73540027
         XC    0(2,R10),0(R10)         CLEAR SAVED SCBEOB          @21A 73550027
         NI    SCBSTAT1,X'FF'-SCBCBGN  CLEAR CONC MSG BEGIN        @21A 73560027
         NI    SCBCTBFL-IEDQSCB(R14),X'FF'-SCBCTBND                @21A 73570027
*                                      CLEAR CONC SCB              @21A 73580027
         NI    SCBQTYPE,SCBCONC        CLEAR IN STATION SCB        @21A 73590027
         B     DSPDISP                  BRANCH TO DISPATCHER     S21903 73600022
NEXTUNIT EQU   *                                                        73800020
         LPR   RDCB,RDCB                RESET FLAG                      74000020
         LH    RKEY,AVTKEYLE            RESET KEY                       74200020
         L     RUNIT,LCBWORK(RLCB)      NEXT UNIT ADDR                  74400020
*        ADDR NEXT UNIT                                                 74600020
         ICM   R8,TWO,AVTDOUBL+ONE      SET CCW FLAGS.           Y01004 74800005
         ICM   R8,ONE,AVTFZERO          SET BYTE AFTER FLAGS = 0 Y01004 75000005
         LA    R11,AVTUMALN(RUNIT)      ADDR TO WRITE FROM              75400020
         B     BLDCCWS                  BRANCH TO BUILD CCWS     S21903 75600022
SETETB   EQU   *                                                        77400020
         SR    RSIZE,RETB               DECR SIZE BR AMOUNT TO WRITE    77600020
         SR    RKEY,RETB                DECR KEY                        77800020
         LR    R0,RKEY                  SET REMAINING COUNT     SA63953 78000051
         CR    RSIZE,RKEY               IS SIZE LESS THAN FULL UNIT     78200020
         BH    STCKEY                   BR YES                          78400020
         LR    R0,RSIZE                 SET REMAINING COUNT     SA63953 78600051
STCKEY   EQU   *                                                        78800020
         LTR   RDCB,RDCB                IS ANYTHING TO BE ALTERED       79000020
         BM    NOSTC                    BR IF NOT                       79200020
         STH   RETB,PRFCOUNT-IEDQPRF(RUNIT)                             79400020
         OI    PRFTIC-IEDQPRF(RUNIT),FLAGETB  SET ETB HERE      SA63953 79600051
         STC   R0,PRFOPCDE-IEDQPRF(RUNIT)  SET COUNT LEFT       SA63953 79700051
         NI    PRFFLAGS-IEDQPRF(RUNIT),X'FF'-CCWCD                      79800020
         OI    PRFFLAGS-IEDQPRF(RUNIT),CCWCC                            80000020
         OI    LCBCPA+12,ETBDONE                                        80200020
         CLI   AVTDOUBL+3,X'FF'         FIRST TIME               S21903 80400022
         BNE   NOSTCA                   BRANCH IF YES.           Y01004 80600005
         TM    LCBCPA+TWELVE,XXXUSED    WAS THERE A CHAN PGM CHK Y01004 80610005
         BNO   NOSTC                    BRANCH IF NO.            Y01004 80620005
         TM    LCBCPA+TWELVE,ETBDONE    WAS ETB FOUND IN BUFFER  Y01004 80630005
         BNO   NOSTCA                   BRANCH IF NO.            Y01004 80640005
         TM    LCBCPA+TWELVE,DONE       HAS WRITE FOR BLOCK BEEN Y01004 80650005
*                                       SET UP ALREADY           Y01004 80660005
         BO    NOSTC                    BRANCH IF YES.           Y01004 80670005
         OI    LCBCPA+TWELVE,DONE       IT'S BEING SET UP NOW.   Y01004 80680005
         ICM   R8,SEVEN,LCBNEXT+ONE(RLCB) GET ADDRESS OF NEXT    Y01004 80690005
*                                       UNIT TO BE SENT.         Y01004 80700005
         BZ    NOSTCB                   BRANCH IF IT'S THE FIRST Y01004 80710005
*                                       ETB FOR THIS MESSAGE.    Y01004 80720005
         TM    LCBWRSTX+ELEVEN(RLCB),LAST  IS THIS THE LAST UNIT A50198 80730005
         BNO   NOSTCB                   BRANCH IF NO TO SET UNIT A50198 80740005
*                                       ADDRESS.                 A50198 80750005
         STCM  RPREFIX,SEVEN,LCBWRSTX+NINE(RLCB) SET ADDRESS OF  Y01004 80760005
*                                       THIS BUFFER TO WRITE.    Y01004 80770005
         B     NOSTCB                   GO SET LAST UNIT TO TIC  Y01004 80780005
*                                       TO THE WRITE DLE/ETB.    Y01004 80790005
NOSTCA   EQU   *                                                        80800020
         NC    LCBNEXT+1(3,RLCB),LCBNEXT+1(RLCB)                        81000020
         BNZ   NOSTC                    IF NEXT IS ZERO THIS IS         81200020
*        THE FIRST UNIT OF THE FIRST BFR                                81400020
*        OR FIRST ETB UNIT IN MSG                                       81600020
NOSTCB   EQU   *                                                        81800020
         BAL   R8,SETWRETB              BRANCH TO WRITE ETB      S21903 82000022
NOSTC    EQU   *                                                        82200020
         LH    RETB,SCBBKFCT+1          RESET ETB COUNT                 82400020
         LTR   RKEY,RKEY                MORE IN UNIT                    82600020
         BZ    DECR                     BR NO                           82800020
         LNR   RDCB,RDCB                SET FLAG NOT TO MODIFY CCWS     83000020
         B     COMPARE                  RETURN                   S21903 83200022
         SPACE 3                                                        83300005
SETWRETB EQU   *                                                        83400020
         ST    RUNIT,LCBLSTWR(RLCB)     ADDR LAST UNIT BEING WRTN       83600020
         STC   R0,LCBCOUNT(RLCB)        SET COUNT               SA63953 83800051
         MVC   LCBNEXT+1(3,RLCB),PRFTIC+1-IEDQPRF(RUNIT)                84000020
         LA    R11,LCBWRETB(RLCB)       ADDR OF WR DLE ETB              84200020
         ST    R11,PRFTIC-IEDQPRF(RUNIT)        THIS UNIT MUST TIC      84400020
         MVI   PRFTIC-IEDQPRF(RUNIT),CCWTIC                             84600020
         MVI    PRFOPCDE-IEDQPRF(RUNIT),CCWWRITE                        84800020
         BR    R8                       RETURN                   S21903 85000022
FLAG     DC    X'7F'                                            OX01433 85050006
         EJECT                                                          85100006
         IHAPSA                                                         85150006
         EJECT                                                          85200005
         TLCBD                                                          93200020
LCBLSTWR EQU   LCBCPA+52-IEDQLCB        ADDR LAST UNIT BEING WRITTEN    93400020
LCBLAST  EQU   LCBCPA+64-IEDQLCB        ADDR LAST UNIT ASSIGNED         93600020
LCBNEXT  EQU   LCBCPA+56-IEDQLCB        ADDR NEXT UNIT TO BE SENT       93800020
LCBCOUNT EQU   LCBCPA+52-IEDQLCB        CT OF REM. SIZE IN UNIT         94000020
LCBETB   EQU   LCBCPA+60-IEDQLCB        REMAINING ETB COUNT             94200020
LCBWRETB EQU   LCBCPA+24-IEDQLCB        ADDR TO WR ETB FROM             94400020
LCBRDRSP EQU   LCBCPA+32-IEDQLCB        ADDR TO READ RESP FROM          94600020
LCBWRSTX EQU   LCBCPA+40-IEDQLCB        ADDR TO WR ETX FROM             94800020
LCBWRETX  EQU   LCBCPA+40-IEDQLCB                                       95000020
LCBWORK  EQU   LCBCPA+60-IEDQLCB        WORK AREA                       95200020
         EJECT                                                          95300005
         DCBD  DSORG=TX                                                 95400020
         EJECT                                                          95500005
         TDISPD                                                         95600020
         EJECT                                                          95700005
         TSCBD                                                          95800020
         EJECT                                                          95900005
         TPRFD                                                          96000020
         EJECT                                                          96100005
         TCCWD                                                          96200020
         EJECT                                                          96300005
         TAVTD                                                   X01004 96400005
         EJECT                                                          96500005
         TTPD                                                           96600020
         TTRMD                                                  SA61750 96700005
         END                                                            96800020
