         TITLE 'IEDQNF-CHECKPOINT EXECUTOR'                             00100000
IEDQNF   CSECT                                                          00600020
         SPACE 3                                                        00900020
*********************************************************************** 01200020
*                                                                     * 02100020
*  MODULE NAME = IEDQNF (TCAM,CHECKPOINT/RESTART)                     * 02200000
*                                                                     * 02440005
*  DESCRIPTIVE NAME = CHECKPOINT EXECUTOR                             * 02480005
*                                                                     * 02520005
*  COPYRIGHT = 'NONE'                                                 * 02560005
*                                                                     * 02600005
*  STATUS:  VERSION 10.0                                              * 02620000
*                                                                     * 02700020
*FUNCTIONS:THIS MODULE DETERMINES IF THERE IS ANYTHING THAT NEEDS TO  * 03000020
*   BE DONE BY CHECKPOINT AND WHICH MODULE SHOULD              @OY15469 03100000
*   PERFORM THE NEXT FUNCTION.                                        * 03370000
*                                                                     * 03440000
*   FOR TCAM CHECKPOINT, IF THE DISK IOB IS MARKED COMPLETE,          * 03510000
*   THE CHECKPOINT NOTIFICATION-DISPOSITION ROUTINE IS         @OY15469 03610000
*   GIVEN CONTROL. IF NO I/O IS IN PROCESS AND THERE IS A RECORD ON   * 04200020
*   THE DISK I/O QUEUE,THE I/O ROUTINE IS LOADED.        IF THERE     * 04500020
*   IS A REQUEST ELEMENT ON THE CHECKPOINT QCB,THE PROPER ROUTINE     * 04800020
*   IS GIVEN CONTROL TO BUILD A CHECKPOINT RECORD.@OY15469              04810000
*                                                                     * 04820000
*   FOR 3705 CHECKPOINT, THE 3705 CHECKPOINT OR 3705 RESTART          * 04830000
*   MODULE IS CALLED IF AN ELEMENT IS ON THE 3705 CHECKPOINT          * 04840000
*   QUEUE. IF I/O FOR A 3705 CHECKPOINT OR RESTART HAS FINISHED,      * 04850000
*   THEN THE KEY FIELD SAVED IN CAVTWTG IS USED TO DETERMINE          * 04860000
*   WHICH MODULE IS CALLED NEXT.                                      * 04870000
*                                                                     * 04880000
*   THE CHECKPOINT MODULES DO NOT NEED TO SAVE REGISTERS SINCE THEY   * 04890000
*   USE 'BALR' TYPE LINKAGE. THE CONTENTS OF THE FOLLOWING REGIS-     * 04900000
*   TERS ARE MAINTAINED FROM ONE LOAD MODULE TO ANOTHER:              * 04910000
*                                                                     * 04920000
*   2-ADDRESS OF CHECKPOINT WORK AREA (TCAM CHECKPOINT ONLY)          * 04930000
*   9-ADDRESS OF AVT                                                  * 04940000
*   12-BASE REGISTER FOR IEDQNF                                       * 04950000
*   14-RETURN REGISTER-TO IEDQNF                                      * 04960000
*   15-ENTRY POINT-LOADED MODULE                                      * 04970000
*                                                                     * 04980000
*   REGISTER 14 POINTS TO A BRANCH TABLE IN IEDQNF.THE LOADED         * 04990000
*   MODULE RETURNS TO THAT ADDRESS PLUS A MULTIPLE OF FOUR,DEPEND-    * 05000000
*   ING ON THE FUNCTION TO BE PERFORMED.                              * 05010000
*                                                                     * 05020000
*   R14 PLUS 0-LOAD THE MODULE WHOSE NAME OFFSET IS IN REG 15. @OY15469 05030000
*   R14 PLUS 4-FUNCTION COMPLETE.                              @OY15469 05050000
*   R14 PLUS 8-WAIT FOR I/O TO COMPLETE.                       @OY15469 05060000
*                                                                     * 05070000
*   IF THERE IS NOTHING TO, THIS MODULE WAITS ON THE ECB LIST         * 05080000
*   UNLESS THE CLOSEDOWN BIT (IN CHECKPOINT REQUEST                   * 05700020
*   ELEMENT) IS ON; THEN THIS MODULE RETURNS TO THE OPERATING         * 05800000
*   SYSTEM THUS TERMINATING THE CHECKPOINT ATTACHED TASK.             * 05900000
*                                                                     * 06600020
*NOTES = SEE BELOW                                                    * 06610000
*                                                                     * 06620000
*   DEPENDENCIES = THE OPERATION OF THIS MODULE DEPENDS               * 06630000
*   UPON AN INTERNAL REPRESENTATION OF THE                            * 06640000
*   EXTERNAL CHARACTER SET WHICH IS EQUIVALENT TO                     * 06650000
*   THE ONE USED AT ASSEMBLY TIME. THE CODING HAS BEEN ARRANGED SO    * 06660000
*   THAT REDEFINITION OF 'CHARACTER' CONSTANTS,BY REASSEMBLY,WILL     * 06670000
*   RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.               * 06680000
*                                                                     * 06690000
*   RESTRICTIONS = NONE                                               * 06700000
*                                                                     * 06710000
*   REGISTER CONVENTIONS = SEE REGISTER ASSIGNMENTS                   * 06720000
*                                                                     * 06730000
*   PATCH LABEL = PATCH                                               * 06740000
*                                                                     * 06750000
*MODULE TYPE = PROCEDURE                                              * 06760000
*                                                                     * 06770000
*   PROCESSOR = ASSEMBLER XF                                          * 06780000
*                                                                     * 06790000
*   MODULE SIZE = 740 DECIMAL BYTES                                   * 06800000
*                                                                     * 06810000
*   ATTRIBUTES = REUSABLE                                             * 06820000
*                                                                     * 06830000
*ENTRY POINT = IEDQNF                                                 * 06840000
*                                                                     * 07200020
*     PURPOSE = SEE FUNCTION                                          * 07250000
*                                                                     * 07300000
*     LINKAGE = RECEIVES CONTOL FROM THE OPERATING SYSTEM AS A        * 07350000
*               RESULT OF AN ATTACH MACRO ISSUED BY IEDQND.           * 07400000
*               REGISTER 15 HAS THE ENTRY POINT ADDRESS.              * 07450000
*                                                                     * 07800020
*INPUT = REGISTER 1 CONTAINS THE ADDRESS OF THE AVT                   * 07870000
*        REGISTER 13 CONTAINS THE CALLER'S SAVEAREA ADDRESS           * 07940000
*        REGISTER 15 CONTAINS THE ENTRY POINT ADDRESS                 * 08010000
*                                                                     * 09300020
*OUTPUT:NONE                                                          * 09600020
*                                                                     * 13800020
*EXITS-NORMAL:THIS MODULE EXITS TO OS IN ONE OF TWO WAYS:             * 14100020
*                                                                     * 14400020
*   1.WAIT-THERE ARE NO OUTSTANDING REQUEST ON THE CHECKPOINT QCB.    * 14700020
*   2.RETURN-THERE ARE NO OUTSTANDING REQUEST ON THE CHECKPOINT       * 15000020
*     QCB AND THE CLOSEDOWN COMPLETION BIT IS ON IN THE ENVIRONMENT   * 15300020
*     CHECKPOINT REQUEST ELEMENT.                                     * 15600020
*                                                                     * 15900020
*EXITS-ERROR:NONE                                                     * 16200020
*                                                                     * 16500020
*EXTERNAL REFERENCES = SEE BELOW                                      * 16507000
*                                                                     * 16514000
*   ROUTINES = SEE BELOW                                              * 16521000
*        'IEDQNG'-BUILDS INCIDENT RECORD FOR MH MACRO                 * 16528000
*        'IEDQNH'-BUILDS INCIDENT RECORD FOR TCHNG MACRO              * 16535000
*        'IEDQNJ'-BUILDS INCIDENT RECORD FOR OP.CONTROL COMMAND       * 16542000
*        'IEDQNK'-BUILDS ENVIRONMENT RECORD                           * 16549000
*        'IEDQNM'-BUILDS CKREQ RECORD                                 * 16556000
*        'IEDQNO'-MANAGES CHECKPOINT I/O QUEUE                        * 16563000
*        'IEDQNP'-WRITES CHECKPOINT RECORDS ON DISK                   * 16570000
*        'IEDQNQ'-ISSUES FREEMAINS AND NOTIFIES COMPLETION OF A       * 16577000
*                 CHECKPOINT                                          * 16584000
*        'IEDQNR'-TAKES CARE OF INSUFFICIENT CORE SITUATION           * 16591000
*        'IEDQNS'-TAKES CARE OF INCIDENT OVERFLOW                     * 16598000
*        'IEDQNT'-TAKES 3705 CHECKPOINTS - LOAD 1                     * 16605000
*        'IEDQNU'-TAKES 3705 CHECKPOINTS - LOAD 2                     * 16608000
*        'IEDQNV'-READS 3705 RESTART RECORDS                          * 16612000
*                                                                     * 16619000
*   DATA AREAS = CHECKPOINT WORKAREA                                  * 16626000
*               REQUEST ELEMENTS                                      * 16633000
*                                                                     * 16640000
*   CONTROL BLOCKS = AVT                                              * 16647000
*                    CAVT                                             * 16654000
*                    DCB                                              * 16661000
*                    DEB                                              * 16668000
*                    TCB                                              * 16675000
*                                                                     * 16682000
*TABLES = NONE                                                        * 16689000
*                                                                     * 16696000
*MACROS = DELETE                                                      * 16703000
*         IEDHJN                                                      * 16710000
*         LOAD                                                        * 16717000
*         RETURN                                                      * 16724000
*         SAVE                                                        * 16731000
*         WAIT                                                        * 16738000
*                                                                     * 16745000
*CHANGE ACTIVITY = SEE BELOW                                          * 16752000
*A-000000-999999                                              @Y16X5C0* 16759000
*A324000,483000,783000                                          A42413* 16766000
*C345000,486000                                                 A42413* 16773000
*A435000                                                       SA60802* 16780000
*A267000,324000,336000,360000,390000,405000,423000,429000     @Y17XACL* 16780500
*A495000,528000,546000,558000,588000,609000,627000,639000     @Y17XACL* 16781000
*A645000,665000,687000,711000,720000,726000,744000,777000     @Y17XACL* 16781500
*A786000,789000                                               @Y17XACL* 16782000
*C279000,312000                                               @Y17XACL* 16782500
*D270000,273000,285000,303000,354000,366000-381000            @Y17XACL* 16783000
*D393000-402000,426000,480000-488400,493000,498000,501000     @Y17XACL* 16783500
*D531000-537000,549000,552000,561000-570000,591000,594000     @Y17XACL* 16784000
*D612000,615000,630000,633000,642000,648000,651000,672000     @Y17XACL* 16784500
*D675000,690000-705000,714000,723000,729000,732000,747000     @Y17XACL* 16785000
*D780000,783000                                               @Y17XACL* 16785500
*A325000,534000,537000,720000,735000,777000                    @OY15469 16785600
*D483600-488400,576000,606000,624000,633000,645000,783000      @OY15469 16785700
*C033000,039000,051000-054000,252000-261000                    @OY15469 16785800
*A478000,492000,790740                                         @G36XRCU 16785900
*                                                                     * 16786000
*A391170,529400                                                @OZ31115 16786182
*C390060-390090,391890,777100                                  @OZ31115 16786282
*A547800,558000                                                @OY20868 16786382
*********************************************************************** 26700020
         EJECT                                                 @Y17XACL 26740000
*********************************************************************** 26780000
*                                                                     * 26820000
*        REGISTER ASSIGNMENTS                                         * 26860000
*                                                                     * 26900000
*********************************************************************** 26940000
         SPACE                                                          27600020
R0       EQU   0                        WORK REGISTER          @Y17XACL 27900000
R1       EQU   1                        WORK REGISTER          @Y17XACL 28000000
RCKPT    EQU   2                        ADDRESS OF TCAM CKPT   @Y17XACL 28100000
*                                       WORKAREA               @Y17XACL 28200000
R3       EQU   3                        ADDRESS OF REQUEST ELEMENT      28800020
R4       EQU   4                        ADDR OF LAST DISK RCD BUILT     29100020
R5       EQU   5                        ADDRESS OF LOAD LIST            29400020
R6       EQU   6                        BAL REG                         29700020
R7       EQU   7                        INDEX INTO LOAD LIST            30000020
R8       EQU   8                        INDEX INTO LOAD LIST            30300000
RAVT     EQU   9                        ADDRESS OF AVT                  30600020
R11      EQU   11                       WORK REGISTER          @Y17XACL 31200000
RBASE    EQU   12                       BASE REG                        31500020
R13      EQU   13                       SAVE AREA                       31800020
R14      EQU   14                       RETURN ADDRESS                  32100020
R15      EQU   15                       ENTRY POINT OR RETURN CODE      32400020
ZERO     EQU   0                        DISPLACEMENT           @OY15469 32410000
TWO      EQU   2                        LENGTH OR DISPLACEMENT @OY15469 32420000
THREE    EQU   3                        LENGTH                 @OY15469 32500000
FOUR     EQU   4                        LENGTH OR DISPLACEMENT @OY15469 32580000
FIVE     EQU   5                        DISPLACEMENT           @OY15469 32660000
EIGHT    EQU   8                        DISPLACEMENT           @OY15469 32740000
         EJECT                                                 @Y17XACL 32820000
*********************************************************************** 32900000
*                                                                     * 32980000
*        STANDARD LINKAGE                                             * 33060000
*                                                                     * 33140000
*********************************************************************** 33220000
         SPACE                                                          33300020
         USING *,R15                    TEMPORARY BASE                  33600020
         USING IEDQCKPD,RCKPT           TCAM CKPT WORKAREA     @Y17XACL 33660000
*                                       ADDRESSABILITY         @Y17XACL 33720000
         USING IEDQCRED,R3              BASE FOR REQUEST ELEMENT        33780000
         USING IEDQAVTD,RAVT            AVT ADDRESSABILITY     @Y17XACL 33840000
IEDQNF   IEDHJN SKIPID                  MODIFICATION DATE        S21903 33900005
         SAVE  (14,12)                                                  35100020
         LR    RAVT,R1                  ADDRESS OF AVT PASSED AS PRM416 36000000
         ST    R13,SAVE13               SAVE REGISTER 13       @Y17XACL 36300000
         LR    RBASE,R15                SET BASE REG                    38400020
         DROP  R15                                                      38700020
         USING IEDQNF,RBASE                                             39000020
         SPACE 2                                               @Y17XACL 39003000
         XC    IEDQCKAD(CAVTSIZE-FOUR),IEDQCKAD  CLEAR CKPT AVT@OZ31115 39006082
         LA    RCKPT,IEDQCKAD           GET ADDR OF CKPT AVT   @Y17XACL 39012000
         STCM  RCKPT,B'0111',AVTCKAVT   SAVE ADDR OF CAVT      @Y17XACL 39015000
         SLR   RCKPT,RCKPT              CLEAR TCAM CKPT        @Y17XACL 39018000
*                                       WORKAREA POINTER       @Y17XACL 39021000
         TM    AVTCKFLG,AVTCKTAC        IS TCAM CKPT ACTIVE    @Y17XACL 39024000
         BZ    QNF06                    NO, BRANCH             @Y17XACL 39027000
         EJECT                                                 @Y17XACL 39030000
*********************************************************************** 39033000
*                                                                     * 39036000
*        TCAM CHECKPOINT IS ACTIVE. FIND THE CHECKPOINT DEB ON        * 39039000
*        THE TCAM DEB CHAIN AND GET THE TCAM CHECKPOINT WORKAREA      * 39042000
*        ADDRESS. SET UP THE ECB WAIT LIST FOR TCAM CHECKPOINT.       * 39045000
*                                                                     * 39048000
*********************************************************************** 39051000
         L     R1,AVTTCB                GET TCAM TCB ADDRESS   @Y17XACL 39054000
         USING IEDQTCB,R1               TCB ADDRESSABILITY     @Y17XACL 39057000
         LA    R1,TCBDEB-(DEBDEBAD-DEBNMSUB) GET ADDR OF       @Y17XACL 39060000
*                                       TCAM DEB CHAIN AS      @Y17XACL 39063000
*                                       AS DUMMY 1ST DEB       @Y17XACL 39066000
         USING DEBNMSUB,R1              DEB ADDRESSABILITY     @Y17XACL 39069000
         USING IHADCB,R5                DCB ADDRESSABILITY     @Y17XACL 39072000
QNF02    EQU   *                                               @Y17XACL 39075000
         L     R1,DEBDEBAD              GET ADDR OF NEXT DEB   @Y17XACL 39078000
         L     R5,DEBDCBAD              GET DCB ADDRESS        @Y17XACL 39081000
         TM    DCBDSRG2,DCBDSGTQ        IS THIS A TCAM QUEUE   @Y17XACL 39084000
*                                       DATA SET               @Y17XACL 39087000
         BZ    QNF02                    NO, BRANCH             @Y17XACL 39090000
         TM    DCBOPTCD,CHECKPT         IS THIS THE TCAM       @Y17XACL 39093000
*                                       CKPT DCB               @Y17XACL 39096000
         BZ    QNF02                    NO, BRANCH             @Y17XACL 39099000
         L     RCKPT,DCBIOBAD           GET THE TCAM CKPT      @Y17XACL 39102000
*                                       WORKAREA ADDRESS       @Y17XACL 39105000
         LA    RCKPT,0(,RCKPT)          CLEAR HI BYTE          @Y17XACL 39108000
         ST    RCKPT,CAVTTCWA           PUT WORKAREA ADDR IN   @Y17XACL 39111000
*                                       THE CAVT               @Y17XACL 39114000
         ST    R13,CKPSAVE1+4           SAVE CALLER'S R13      @Y17XACL 39117000
         SR    R7,R7                    CLEAR REGISTER         @OZ31115 39117182
         IC    R7,AVTNCKPR              GET NUMBER OF CKREQ Q'S@OZ31115 39117282
         LTR   R6,R7                    CHECK FOR CKREQ=0      @OZ31115 39117382
         BZ    QNF03                    BRANCH IF ZERO         @OZ31115 39117482
         LA    R7,CKPCKRNO(0,R7)        NUMBER OF EXTRA RECORDS@OZ31115 39117582
*                                        (TO USE IN CASE OF    @OZ31115 39117682
*                                        DISK ERROR)           @OZ31115 39117782
         LA    R6,CKPCTTRL              CKREQ TTR ENTRY LENGTH @OZ31115 39117882
         MR    R6,R6                    NUMBER OF BYTES FOR    @OZ31115 39117982
*                                        CKREQ TTR TABLE       @OZ31115 39118082
QNF03    EQU   *                                               @OZ31115 39118182
         LA    R5,CKPLNGTH(0,R7)        FIXED WORK AREA LENGTH @OZ31115 39118282
         IC    R6,AVTCPRCD              NUMBER OF ENV RCDS     @OZ31115 39118382
         LA    R7,CKPTTRLN              LENGTH FOR EACH TTR    @OZ31115 39118482
         MR    R6,R6                    LENGTH FOR ALL RCDS    @OZ31115 39118582
         AR    R5,R7                    ADD TO TOTAL LENGTH    @OZ31115 39118682
         STH   R5,CAVTCKTR              SAVE CKPT TRACE OFFSET @OZ31115 39118782
QNF05    EQU   *                                               @OZ31115 39118882
         LA    R5,CKPSAVE1              GET CKPT SAVEAREA ADDR @Y17XACL 39120000
         ST    R5,8(R13)                SAVE CKPT SAVE AREA    @Y17XACL 39123000
*                                       ADDR IN IT'S SAVEAREA  @Y17XACL 39126000
         LA    R5,AVTCKPEC              GET ADDR OF ECB FOR    @Y17XACL 39129000
*                                       TCAM CKPT QUEUE        @Y17XACL 39132000
         ST    R5,CAVTTQE               SAVE ECB ADDR IN THE   @Y17XACL 39135000
*                                       WAIT LIST              @Y17XACL 39138000
         LA    R5,CKPECB                GET ADDR OF ECB FOR    @Y17XACL 39141000
*                                       TCAM CKPT I/O          @Y17XACL 39144000
         STCM  R5,B'0111',CAVTTIOE      SAVE ECB ADDR IN THE   @Y17XACL 39147000
*                                       WAIT LIST              @Y17XACL 39150000
         MVI   CKPECB,0                 CLEAR ECB COMPLETION   @Y17XACL 39153000
         DROP  R1,R5                                           @Y17XACL 39156000
         EJECT                                                 @Y17XACL 39159000
*********************************************************************** 39162000
*                                                                     * 39165000
*        IF 3705 CHECKPOINT IS NOT ACTIVE, THEN SET END OF LIST       * 39168000
*        IN THE WAIT LIST. OTHERWISE, PUT THE 3705 CHECKPOINT         * 39171000
*        QUEUE ECB ADDRESS IN THE WAIT LIST AND SET END OF LIST.      * 39174000
*                                                                     * 39177000
*********************************************************************** 39180000
QNF06    EQU   *                                               @Y17XACL 39183000
         TM    AVTCKFLG,AVTCKNAC        IS 3705 CKPT ACTIVE    @Y17XACL 39186000
         BNO   QNF07                    NO, BRANCH             @OZ31115 39189082
         SR    R5,R5                    CLEAR REGISTER         @OZ31115 39189482
         LA    R5,CKPLNGTH+CKPTTRLN     MINIMUM AREA SIZE      @OZ31115 39189882
         STH   R5,CAVTCKTR              SAVE CKPT TRACE OFFSET @OZ31115 39190282
         B     QNF08                    BRANCH                 @OZ31115 39190682
QNF07    EQU   *                                               @OZ31115 39191082
         MVI   CAVTEOL1,EOL             SET END-OF-LIST IN     @Y17XACL 39192000
*                                       THE WAIT LIST          @Y17XACL 39195000
         B     QNF10                    SCAN FOR WORK TO DO    @Y17XACL 39198000
         SPACE 2                                               @Y17XACL 39201000
QNF08    EQU   *                                               @Y17XACL 39204000
         L     R5,AVTSAVTP              GET SECONDART AVT ADDR @Y17XACL 39207000
         LA    R5,SAVTCKEC-IEDNSVTD(,R5) GET ADDR OF ECB FOR   @Y17XACL 39210000
*                                       THE 3705 CKPT QUEUE    @Y17XACL 39213000
         STCM  R5,B'0111',CAVTNQE       SAVE ECB ADDR IN THE   @Y17XACL 39216000
*                                       WAIT LIST              @Y17XACL 39219000
         MVI   CAVTEOL2,EOL             SET END-OF-LIST IN THE @Y17XACL 39222000
*                                       WAIT LIST              @Y17XACL 39225000
         SPACE 1                                               @Y17XACL 39225600
*                                       LOAD THE 3705 CKPT/    @Y17XACL 39226200
         LOAD  EPLOC=IEDQNW             RESTART I/O ROUTINE    @Y17XACL 39226800
         ST    R0,CAVTCRIO              SAVE ADDR OF ROUTINE   @Y17XACL 39227400
         EJECT                                                 @Y17XACL 39228000
*********************************************************************** 39231000
*                                                                     * 39234000
*        CHECK FOR 3705 CHECKPOINT I/O COMPLETE.                      * 39237000
*                                                                     * 39240000
*********************************************************************** 39243000
QNF10    EQU   *                                                        40500020
         ICM   R5,B'0111',CAVTNIOE      IS 3705 CKPT I/O       @Y17XACL 40510000
*                                       STARTED                @Y17XACL 40520000
         BZ    QNF12                    NO, BRANCH             @Y17XACL 40530000
         TM    ECBCC(R5),CKPPOST        IS ECB POSTED COMPLETE @Y17XACL 40540000
         BZ    QNF12                    NO, BRANCH             @Y17XACL 40550000
         SLR   R7,R7                    CLEAR INDEX REGISTER   @Y17XACL 40560000
         IC    R7,CAVTWTG               SET KEY SAVED BY 3705  @Y17XACL 40570000
*                                       CKPT/RESTART I/O       @Y17XACL 40580000
*                                       ROUTINES               @Y17XACL 40590000
         B     QNF20                    GO LOAD ROUTINE        @Y17XACL 40600000
         SPACE 2                                               @Y17XACL 40610000
*********************************************************************** 40620000
*                                                                     * 40630000
*        CHECK FOR TCAM CKPT I/O.                                     * 40640000
*                                                                     * 40650000
*********************************************************************** 40660000
QNF12    EQU   *                                               @Y17XACL 40670000
         TM    AVTCKFLG,AVTCKTAC        IS TCAM CKPT ACTIVE    @Y17XACL 40680000
         BZ    QNF15                    NO, BRANCH             @Y17XACL 40690000
         TM    CKPECB,CKPPOST           CHECK FOR POSTED DISK IOB       40800020
         BO    QNF35                    BRANCH IF I/O COMPLETED         41100020
         SPACE                                                          41400020
         L     R3,CKPEXCP               CHECK FOR EXCP ISSUED           41700020
         LTR   R3,R3                                                    42000020
         BZ    QNF70                    BRANCH IF NO I/O BEING DONE     42300020
         EJECT                                                 @Y17XACL 42330000
*********************************************************************** 42360000
*                                                                     * 42390000
*        CHECK FOR REQUEST ELEMENT ON THE 3705 CHECKPOINT/RESTART     * 42420000
*        QUEUE.                                                       * 42450000
*                                                                     * 42480000
*********************************************************************** 42510000
         SPACE 1                                               @Y17XACL 42540000
         USING IEDNSVTD,R5              SAVT ADDRESSABILITY    @Y17XACL 42570000
QNF15    EQU   *                                                        42900020
         TM    AVTCKFLG,AVTCKNAC        IS 3705 CKPT ACTIVE    @Y17XACL 42910000
         BZ    QNF17                    NO, BRANCH             @Y17XACL 42920000
         L     R5,AVTSAVTP              GET SAVT ADDR          @Y17XACL 42930000
         ICM   R3,B'0111',SAVTCKCH      GET REQUEST ELEMENT    @Y17XACL 42940000
*                                       FROM THE CHAIN         @Y17XACL 42950000
         CLI   CREPRI,0                 IS CHAIN EMPTY - I.E.  @Y17XACL 42960000
*                                       ONLY DUMMY END WITH    @Y17XACL 42970000
*                                       PRIORITY OF 0 IS ON    @Y17XACL 42980000
*                                       THE CHAIN              @Y17XACL 42990000
         BE    QNF17                    YES, BRANCH            @Y17XACL 43000000
         MVC   SAVTCKCH,CRELINK+1       REMOVE REQUEST ELEMENT @Y17XACL 43010000
*                                       FROM THE CHAIN         @Y17XACL 43020000
         L     R5,AVTOCGET              GET OPERATOR CONTROL   @Y17XACL 43021000
*                                       AVT ADDRESS            @Y17XACL 43022000
         L     R5,OPCCKPTF-IEDQOPCD(,R5) GETS ADDR OF OPCE     @Y17XACL 43023000
*                                       THAT NEEDS CKPT        @Y17XACL 43024000
         L     R5,OCCKPTWA-IEDQOPCE(,R5) GET 3705 CKPT         @Y17XACL 43025000
*                                       WORKAREA ADDRESS       @Y17XACL 43026000
         ST    R5,CAVTNWA               SAVE WORKAREA ADDRESS  @Y17XACL 43027000
         B     QNF19                    GO LOAD ROUTINE        @Y17XACL 43030000
         DROP  R5                                              @Y17XACL 43040000
         EJECT                                                 @Y17XACL 43050000
*********************************************************************** 43060000
*                                                                     * 43070000
*        CHECK FOR REQUEST ELEMENT ON THE TCAM CKPT QUEUE             * 43080000
*                                                                     * 43090000
*********************************************************************** 43100000
QNF17    EQU   *                                               @Y17XACL 43110000
         TM    AVTCKFLG,AVTCKTAC        IS TCAM CKPT ACTIVE    @Y17XACL 43120000
         BZ    QNF80                    NO, BRANCH             @Y17XACL 43130000
         L     R3,CKPLREB               GET LAST REQUEST ELEMENT       *43200020
                                        FOR WHICH RECORD WAS BUILT      43500020
         LA    R3,0(,R3)                CLEAR HIGH-ORDER BYTE   SA60802 43600005
         LTR   R3,R3                    CHECK FOR PREVIOUS RCD BLT      43800020
         LR    R11,R3                   SAVE PREVIOUS ELEMENT           44100020
         L     R3,4(R3)                 GET REQUEST EL FOR THIS RD      44400020
         BNZ   QNF18                    BRANCH IF THIS EL ISNT 1ST     *44700020
                                        ON QCB CHAIN TO BE BUILT        45000020
         L     R3,AVTCKPTB              GET 1ST ELEMENT ON QCB CHN      45300020
         LA    R11,AVTCKPTB-4           DUMMY PREVIOUS ELEMENT          45600020
QNF18    EQU   *                                                        45900020
         SPACE                                                          46200020
         CLI   4(R3),0                  CHECK FOR DUMMY LAST ELEMEN     46500020
         BE    QNF80                    BRANCH IF LAST ELEMENT          46800020
         CLI   CREKEY,CREREMVE          CHECK FOR TIME DELAY           X47100020
                                        REMOVAL ELEMENT                 47400020
         BNE   QNF19                    BRANCH IF NOT REMOVAL ELEM      47700020
         SPACE 1                                               @Y17XACL 47800000
*                                                              @G36XRCU 47900000
*        REMOVE TIME DELAY ELEMENT FROM QCB ELEMENT            @G36XRCU 48000000
*        CHAIN AND IGNORE                                      @G36XRCU 48100000
*                                                              @G36XRCU 48200000
         MODESET MODE=SUP               SET TO SUPERVISOR MODE @G36XRCU 48300000
         MODESET EXTKEY=SUPR            SET TO KEY 0           @G36XRCU 48400000
SETATSK  EQU   *                                               @G36XRCU 48500000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=USE,               *48600000
               RELATED=ATTACHED-TASKS-IGG019RO(SETATSK)        @G36XRCU 48700000
         MVC   CRELINK+1-IEDQCRED(3,R11),CRELINK+1 MOVE LINK FIELD      48900020
         L     R3,CRELINK               GET NEXT ELEMENT                49200020
         SETLOCK RELEASE,TYPE=LOCAL,REGS=USE,                          *49260000
               RELATED=ATTACHED-TASKS-IEDQNF(SETATSK)          @G36XRCU 49320000
         MODESET EXTKEY=TCAM            SET TO TCAM KEY        @G36XRCU 49380000
         MODESET MODE=PROB              SET TO PROBLEM STATE   @G36XRCU 49440000
         B     QNF18                    PROCESS NEXT REQUEST ELEMEN     49500020
         EJECT                                                 @Y17XACL 49540000
*********************************************************************** 49580000
*                                                                     * 49620000
*        DETERMINE NEXT MODULE TO LOAD                                * 49660000
*                                                                     * 49700000
*********************************************************************** 49740000
         SPACE                                                          50400020
QNF19    EQU   *                                                        50700020
         SR    R7,R7                    CLEAR INDEX REG                 51000020
         SPACE                                                          51300020
         IC    R7,0(R3)                 GET KEY FIELD OF ELEMENT        51600020
         SRL   R7,1                     GET MULTIPLE OF 8               51900020
QNF20    EQU   *                                                        52200020
         SRL   R7,1                     DIVIDE BY 2                0525 52500020
         LA    R5,QNFLIST(R7)           ADDRESS OF LOAD MODULE NAME     52800020
         MVC   MOD,0(R5)                MOVE LAST 4 CHARS OF   @Y17XACL 52870000
*                                       NAME                   @Y17XACL 52940000
         CLC   ZERO(TWO,R5),MODNT       3705 CKPT MODULE       @OZ31115 52943082
         BL    TCAMCKPT                 NO, BRANCH             @OZ31115 52946082
         L     R8,CAVTNWA               3705 CKPT WORKAREA ADDR@OZ31115 52949082
         AH    R8,CAVTNTR               ADDR 3705 CKPT TRACE   @OZ31115 52952082
         B     TRACE                    PUT IN TRACE ENTRY     @OZ31115 52955082
TCAMCKPT EQU   *                                               @OZ31115 52958082
         L     R8,CAVTTCWA              TCAM CKPT WORKAREA ADDR@OZ31115 52961082
         AH    R8,CAVTCKTR              ADDR TCAM CKPT TRACE   @OZ31115 52964082
TRACE    EQU   *                                               @OZ31115 52967082
         LR    R15,R8                   SAVE REG               @OZ31115 52970082
         AH    R8,TWO(0,R8)             ADDR OF NEXT SPACE     @OZ31115 52973082
         MVC   ZERO(TWO,R8),ZERO(R5)    SAVE MODULE NAME       @OZ31115 52976082
         LH    R8,TWO(,R15)             OFFSET TO THAT SPACE   @OZ31115 52979082
         LA    R8,TWO(R8)               BUMP TO NEXT SPACE     @OZ31115 52982082
         CH    R8,ZERO(0,R15)           END OF TABLE REACHED   @OZ31115 52985082
         BL    QNF21                    NO, SAVE OFFSET        @OZ31115 52988082
         LA    R8,FOUR                  RESET TO START OF TRACE@OZ31115 52991082
QNF21    EQU   *                                               @OZ31115 52994082
         STH   R8,TWO(,R15)             SAVE NEW OFFSET        @OZ31115 52997082
         LA    R8,BRNCHTAB              ADDR OF MODULE LIST    @OY15469 53010000
COMPNAME EQU   *                                               @OY15469 53080000
         CLC   ZERO(TWO,R8),ZERO(R5)    COMPARE FOR NAME IN LST@OY15469 53150000
         BE    CKLOAD                   CK FOR BRNCH OR LOAD   @OY15469 53220000
         LA    R8,EIGHT(R8)             BUMP TO NXT ENTRY      @OY15469 53290000
         B     COMPNAME                 CHECK NEXT MEMBER      @OY15469 53360000
CKLOAD   EQU   *                                               @OY15469 53430000
         L     R15,FOUR(R8)             PICK UP BRNCH ENTRY    @OY15469 53500000
         LA    R15,ZERO(R15)            CLEAR HI BYTE          @OY15469 53570000
         LTR   R15,R15                  HAS IT BEEN USED       @OY15469 53640000
         BNZ   LOADMOD                  USE ENTRY POINT        @OY15469 53710000
LOAD     EQU   *                                               @OY15469 53780000
         LOAD  EPLOC=ROUTINE            LOAD NEXT ROUTINE      @Y17XACL 53850000
         ST    R0,FOUR(R8)              STORE ENTRY POINT ADDR @OY15469 53920000
         LR    R15,R0                   SET ENTRY REG                   54000020
LOADMOD  EQU   *                                               @OY15469 54100000
         BALR  R14,R15                                                  54300020
         SPACE                                                          54600020
*********************************************************************** 54630000
*                                                                     * 54660000
*        BRANCH TABLE FOR RETURN FROM LOAD MODULE                     * 54690000
*               +0 => LOAD MODULE WHOSE KEY IS IN R15                 * 54720000
*               +4 => GET NEXT REQUEST ELEMENT                        * 54750000
*               +8 => WAIT FOR I/O TO COMPLETE TO TRY GETMAIN AGAIN   * 54780000
*              +12 => OVERFLOW REQUEST                        @OY20868* 54790082
*                                                                     * 54810000
*********************************************************************** 54840000
         B     QNF40                    OFFSET FOR NEXT LOAD IN R15     55500020
         B     QNF50                    GET NEXT REQUEST ELEMENT        55800020
         B     QNF30                    WAIT ON DISK I/O       @OY20868 55807082
         B     QNF80                    INCIDENT OVERFLOW -WAIT@OY20868 55814082
*                                        IF CKPT IN PROGRESS   @OY20868 55821082
         SPACE 1                                               @Y17XACL 55830000
*********************************************************************** 55860000
*                                                                     * 55890000
*        GETMAIN WAS NOT SATISFIED BUT THERE ARE SOMEMORE GETMAIN     * 55920000
*        RECORDS ON THE I/O QUEUE. WAIT UNTIL THEY ARE COMPLETE,      * 55950000
*        TRY AGAIN.                                                   * 55980000
*                                                                     * 56010000
*********************************************************************** 56040000
QNF30    EQU   *                                                        57300020
         WAIT  ECB=CKPECB               WAIT ON DISK I/O ECB            57900020
QNF35    EQU   *                                                        58200020
         LA    R7,CKPNOTIF              GET LOAD LIST OFFSET            58500020
         B     QNF20                    LOAD NOTIFICATION RTN           58800020
         EJECT                                                 @Y17XACL 58840000
*********************************************************************** 58880000
*                                                                     * 58920000
*        ANOTHER LOAD MODULE IS NEEDED FOR THIS FUNCTION              * 58960000
*                                                                     * 59000000
*********************************************************************** 59040000
         SPACE                                                          59700020
QNF40    EQU   *                                                        60000020
         LR    R7,R15                   OFFSET OF LOAD MODULE NAME      60300020
         B     QNF20                    LOAD THE MODULE                 60900020
         SPACE 2                                               @Y17XACL 60940000
*********************************************************************** 60980000
*                                                                     * 61020000
*        THIS FUNCTION IS COMPLETE. DETERMINE NEXT FUNCTION           * 61060000
*                                                                     * 61100000
*********************************************************************** 61140000
         SPACE                                                          61800020
QNF50    EQU   *                                                        62100020
         B     QNF10                    DETERMINE NEXT FUNCTION         62700020
         SPACE 2                                               @Y17XACL 64530000
*********************************************************************** 64560000
*                                                                     * 64590000
*        CHECK FOR A RECORD ON THE DISK I/O QUEUE,IF SO, LOAD I/O     * 64620000
*        ROUTINE.                                                     * 64650000
*                                                                     * 64680000
*********************************************************************** 64710000
         SPACE                                                          65400020
QNF70    EQU   *                                                        65700020
         NC    CKPIOQF+1(3),CKPIOQF+1   CHECK FOR EMPTY QUEUE           66000020
         BZ    QNF15                    BRANCH IF NO ELEMENT            66300020
         LA    R7,CKPDIOR               OFFSET                          66600020
         B     QNF20                    MOVE NAME AND LOAD              66900020
         EJECT                                                 @Y17XACL 66940000
*********************************************************************** 66980000
*                                                                     * 67020000
*        THERE IS NOTHING TO DO WAIT ON BOTH ECB'S OR TERMINATE       * 67060000
*                                                                     * 67100000
*********************************************************************** 67140000
         SPACE                                                          67800020
QNF80    EQU   *                                                        68100020
         TM    AVTCKELF,AVTCCLCN        CHECK CLOSEDOWN COMP. BIT       68400020
         BO    QNF90                    BRANCH IF ON-TERMINATE          68700020
         SPACE 1                                               @Y17XACL 68710000
         LA    R1,CAVTWL1               GET WAIT LIST ADDR     @Y17XACL 68720000
         TM    AVTCKFLG,AVTCKTAC        IS TCAM CKPT ACTIVE    @Y17XACL 68730000
         BO    QNF87                    YES, BRANCH            @Y17XACL 68740000
         LA    R1,CAVTWL2               GET WAIT LIST ADDR FOR @Y17XACL 68750000
*                                       ONLY 3705 CKPT ACTIVE  @Y17XACL 68760000
         SPACE 1                                               @Y17XACL 68770000
QNF87    EQU   *                                               @Y17XACL 68780000
         WAIT  ECBLIST=(1)              WAIT                   @Y17XACL 68790000
         MVI   AVTCKPCC,0               CLEAR ECB COMPLETION   @Y17XACL 68800000
*                                       FOR TCAM CKPT QUEUE    @Y17XACL 68810000
         TM    AVTCKFLG,AVTCKNAC        IS 3705 CKPT ACTIVE    @Y17XACL 68820000
         BZ    QNF10                    NO, BRANCH             @Y17XACL 68830000
         L     R5,AVTSAVTP              GET SAVT ADDR          @Y17XACL 68840000
         MVI   SAVTCKCC-IEDNSVTD(R5),0  CLEAR ECB COMPLETION   @Y17XACL 68850000
*                                       FOR 3705 CKPT QUEUE    @Y17XACL 68860000
         B     QNF10                    DETERMINE WHAT TO DO            70800020
         EJECT                                                 @Y17XACL 71100000
*********************************************************************** 71150000
*                                                                     * 71200000
*        MCP HAS CLOSED DOWN.TERMINATE THIS ATTACHED SUBTASK.         * 71250000
*                                                                     * 71300000
*********************************************************************** 71350000
         SPACE                                                          71700020
QNF90    EQU   *                                                        72000020
         LA    R8,BRNCHTAB-EIGHT        START OF TABLE         @OY15469 72010000
LOOPDELE EQU   *                                               @OY15469 72050000
         LA    R8,EIGHT(R8)             POINT TO NEXT MODULE   @OY15469 72070000
         CLI   ZERO(R8),AVTEFF          END OF TABLE           @OY15469 72100000
         BE    QNF95                    YES                    @OY15469 72140000
         CLC   FIVE(THREE,R8),AVTFZERO  NEED TO DELETE MODULE? @OY15469 72180000
         BNE   DELETE                   YES                    @OY15469 72220000
         B     LOOPDELE                 CHECK IF NEED TO DELETE@OY15469 72260000
DELETE   EQU   *                                               @OY15469 72300000
         MVC   MOD(FOUR),ZERO(R8)           MOD NAME TO DELETE @OY15469 72340000
         DELETE EPLOC=ROUTINE            DELETE THE MODULE     @OY15469 72380000
         B     LOOPDELE                 GET NEXT MODULE        @OY15469 72420000
QNF95    EQU   *                                               @OY15469 72460000
         L     R13,SAVE13               RESTORE CALLER'S R13   @Y17XACL 72500000
         RETURN (14,12),T                                               72600020
         EJECT                                                 @Y17XACL 72610000
*********************************************************************** 72620000
*                                                                     * 72630000
*        EQUATES AND DATA DEFINTIONS                                  * 72640000
*                                                                     * 72650000
*********************************************************************** 72660000
         SPACE 1                                               @Y17XACL 72670000
CHECKPT  EQU   X'20'                    TCAM CKPT DCB          @Y17XACL 72680000
EOL      EQU   X'80'                    END OF LIST INDICATOR  @Y17XACL 72690000
ECBCC    EQU   0                        OFFSET OF ECB          @Y17XACL 72700000
*                                       COMPLETION BYTE IN AN  @Y17XACL 72710000
*                                       ECB                    @Y17XACL 72720000
         SPACE 3                                               @Y17XACL 72730000
SAVE13   DS    A                        FULLWORD TO SAVE THE   @Y17XACL 72740000
*                                       CONTENTS OF REG 13     @Y17XACL 72750000
*                                       AT ENTRY TO THE MODULE @Y17XACL 72760000
*                                       AT ATTACH TIME         @Y17XACL 72770000
         SPACE 1                                               @Y17XACL 72780000
         DS    0D                                              @Y17XANL 72781000
IEDQNW   DC    CL8'IEDQNW'              LOAD NAME FOR 3705 I/O @Y17XACL 72782000
*                                       ROUTINE                @Y17XACL 72783000
         SPACE 1                                               @Y17XACL 72784000
ROUTINE  DS    0CL8                     NAME USED FOR LOADS    @Y17XACL 72785000
*                                       AND DELETES            @Y17XACL 72800000
         DC    CL4'IEDQ'                FIXED CHARACTERS       @Y17XACL 72810000
MOD      DC    CL4' '                   VARIABLE CHARACTERS    @Y17XACL 72820000
         EJECT                                                 @Y17XACL 72830000
*********************************************************************** 72840000
*                                                                     * 72850000
*        LIST OF ALL CHECKPOINT LOAD MODULE NAMES                     * 72860000
*                                                                     * 72870000
*********************************************************************** 72880000
         SPACE                                                          73500020
         CNOP  0,4                                             @OY15469 73600000
QNFLIST  EQU   *                                                        73800020
         DC    CL4'NG'                  LCB                        0525 74100020
         DC    CL4'NH'                  TCHNG                      0525 74400020
         DC    CL4' '                   UNUSED                 @Y17XACL 74500000
         DC    CL4' '                   UNUSED                     0525 75000020
         DC    CL4'NJ'                  OPERATOR CONTROL           0525 75300020
         DC    CL4'NK'                  MCPLOSE                    0525 75600020
         DC    CL4'NM'                  CKREQ                      0525 75900020
         DC    CL4'NK'                  ENVIORNMENT                0525 76200020
         DC    CL4'NO'                  I/O QUEUE MANAGER          0525 76500020
         DC    CL4'NP'                  I/O ROUTINE                0525 76800020
         DC    CL4'NQ'                  NOTIFICATION ROUTINE       0525 77100020
         DC    CL4'NR'                  NO CORE                    0525 77400020
         DC    CL4'NS'                  INCIDENT OVERFLOW          0525 77700020
MODNT    DC    CL4'NT'                  3705 CHECKPOINT-LOAD 1 @OZ31115 77710082
         DC    CL4'NV'                  3705 RESTART           @Y17XACL 77720000
         DC    CL4'NU'                  3705 CHECKPOINT-LOAD 2 @Y17XACL 77725000
BRNCHTAB EQU   *                                               @OY15469 77727000
         DC    CL4'NG',XL4'0'           LCB                    @OY15469 77730000
         DC    CL4'NH',XL4'0'           TCHNG                  @OY15469 77750000
         DC    CL4'NJ',XL4'0'           OPERATOR CONTROL       @OY15469 77770000
         DC    CL4'NK',XL4'0'           ENVIRONMENT            @OY15469 77790000
         DC    CL4'NM',XL4'0'           CKREQ                  @OY15469 77810000
         DC    CL4'NO',XL4'0'           I/O QUEUE MANAGER      @OY15469 77830000
         DC    CL4'NP',XL4'0'           I/O ROUTINE            @OY15469 77850000
         DC    CL4'NQ',XL4'0'           NOTIFICATION ROUTINE   @OY15469 77870000
         DC    CL4'NR',XL4'0'           NO CORE                @OY15469 77890000
         DC    CL4'NS',XL4'0'           INCIDENT OVERFLOW      @OY15469 77910000
         DC    CL4'NT',XL4'0'           3705 CHECKPOINT-LOAD 1 @OY15469 77920000
         DC    CL4'NU',XL4'0'           3705 RESTART           @OY15469 77940000
         DC    CL4'NV',XL4'0'           3705 CHECKPOINT-LOAD 2 @OY15469 77960000
         DC    X'FF'                                           @OY15469 77980000
         EJECT                                                 @Y17XACL 78000000
*********************************************************************** 78020000
*                                                                     * 78040000
*        THIS MODULE CREATES THE CHECKPOINT AVT BY ISSUING THE        * 78060000
*        TCAVTD MACRO WITH THE DSECT=NO OPERAND. THIS GENERATES       * 78080000
*        STORAGE FOR THE CAVT. THIS MODULE CLEARS THE CAVT AT         * 78100000
*        ATTACH TIME.                                                 * 78120000
*                                                                     * 78140000
*********************************************************************** 78160000
         SPACE 1                                               @Y17XACL 78180000
         TCAVTD DSECT=NO                                       @Y17XACL 78200000
         EJECT                                                 @Y17XACL 78220000
*********************************************************************** 78240000
*                                                                     * 78260000
*        THE FOLLOWING IS A PATCH AREA WHICH IS AVAILABLE TO ALL      * 78280000
*        THE MODULES IN THE CHECKPOINT SUBTASK.                       * 78300000
*                                                                     * 78320000
*********************************************************************** 78340000
PATCH    DC    50H'0'                    PATCH AREA            @Y17XACL 78360000
         EJECT                                                 @Y17XACL 78380000
         TAVTD                                                          78600020
         EJECT                                                 @Y17XACL 78700000
         TCKPD 3330                                                     78900000
         EJECT                                                 @Y17XACL 78930000
         DCBD  DSORG=(TX,TR)                                   @Y17XACL 78960000
         EJECT                                                 @Y17XACL 78990000
         TDEBD                                                 @Y17XACL 79020000
         EJECT                                                 @Y17XACL 79050000
         TOPCED                                                @Y17XACL 79056000
         EJECT                                                 @Y17XACL 79062000
         TOPCAVTD                                              @Y17XACL 79068000
         EJECT                                                 @Y17XACL 79074000
         IHAPSA                    DSECT FOR SETLOCK           @G36XRCU 79076000
         EJECT                                                          79078000
         TTCBD                                                 @Y17XACL 79080000
         SPACE 3                                               @Y17XACL 79110000
         END                                                            79200020
                                                                        82200000
                                                                        85200000
