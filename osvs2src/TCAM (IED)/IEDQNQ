QNQ      TITLE 'IEDQNQ-CHECKPOINT NOTIFICATION AND DISPOSITION MOD'     00200020
IEDQNQ   CSECT                                                          00400020
         SPACE 3                                                        00405022
*C240300,247000,481100,483100,508000,720000,722000,724000        Y02027 00405206
*C726000,738000,768000,770000,772000,774000,776000.778000        Y02027 00405406
*C780000,782000,784000,786000,788000-790000,795000               Y02027 00405606
*D199000,238400,238800,239200,239600,240600-241500,481200-482300 Y02027 00405806
*D524000,728000,730000,732000,734000,736000,740000,742000,774400 Y02027 00406006
*D774800,775200,775600,778300,778600,778900,779200,779500        Y02027 00406206
*D792000-794100                                                  Y02027 00406406
*A301000,303000                                                  Y02027 00406606
*A508200-509200,587500,720900-721800,723600,724500-725400,727200 Y02027 00406806
*A728100-729900,730800-731700,732600-733500,734400-735300        Y02027 00407006
*A736200-737100,738900-739800,740700-741600,769000,771000,773000 Y02027 00407206
*A775000,777000,779000,781000,783000,785000,787000,796420-794680 Y02027 00407406
*A822600-823200                                                  Y02027 00407606
*A198000,238000,774000,794000                                    A42413 00410022
*C208000,240300,778300                                           A42413 00411022
*A216000,304000,794000                                          SA52951 00412022
*C204000-210000,422000-440000,480000-484000,694000,697000-698000SA52951 00413022
*A506700                                                        SA58451 00413122
*D356000                                                       @SA70674 00443161
*A218000,774000                                                @XA05298 00473161
*D778000                                                       @XA05298 00503161
*D428000                                                       @SA71082 00533161
*A420000                                                       @SA74853 00563109
*D421000                                                       @OY13275 00573191
*A 219220-219860,794605-794615,795040-795880                   @OZ30932 00583100
* $21=OZ51057  JTC2412  81.07.22 460025: ENVIROMT RECORD ATTEMPTED @21A 00591527
* $22=OZ48955  JTC2412  82.02.05 665920: DUMMY LAST ELEMENT OVERL  @22C 00591627
         SPACE 3                                                        00600020
*********************************************************************** 00800020
*                                                                     * 01000020
*TITLE:'IEDQNQ'-CHECKPOINT NOTIFICATION AND DISPOSITION ROUTINE       * 01200020
*                                                                     * 01400020
*  MODULE NAME = IEDQNQ                                               * 01600061
*                                                                     * 01620061
*  DESCRIPTIVE NAME = CHECKPOINT NOTIFICATION & DISPOSITION           * 01640061
*                                                                     * 01660061
*  COPYRIGHT = ' NONE '                                               * 01680061
*                                                                     * 01700061
*  STATUS:  CHANGE LEVEL 6                                            * 01720061
*                                                                     * 01800020
*FUNCTION:THIS MODULE GET CONTROL AFTER A DISK WRITE OPERATION        * 02000020
*   CONPLETES OR AFTER A CHECKPOINT COULD NOT BE SATISFIED.IT         * 02200020
*   REMOVES THE REQUEST ELEMNT(S) FROM THE QCB CHAIN AND QPOSTS       * 02400020
*   THE ELEMENT(IF FROM AN NH MACRO) OR POSTS AN ECB(IF FROM          * 02600020
*   OPERATOR CONTROL OR AN APPLICATION PROGRAM).THE REQUEST ELEMENT   * 02800020
*   IS NOT REMOVED IF THE REQUEST HAS NOT BEEN COMPLETELY SATISFIED   * 03000020
*   (CKREQ, OPERATOR CONTROL INCIDENT, AND ENVIRONMENT CHECKPOINTS    * 03200022
*   MAY REQUIRE MULTIPLE SEGMENTS), OR IF A DISK ERROR OCCURRED ON    * 03400022
*   WRITE. IF THE LAST SEGMENT OF AN ENVIRONMENT CHECKPOINT WAS       * 03600020
*   JUST WRITTEN WITH AN INCIDENT OVERFLOW CONDITION(INDICATED IN     * 03800020
*   THE ENVIRONMENT REQUEST ELEMENT),SEVERAL INCIDENT REQUEST         * 04000020
*   ELEMENTS MAY BE REMOVED FORM THE QCB CHAIN; THE INCIDENT OVER-    * 04200020
*   FLOW BIT IN EACH INCIDENT REQUEST ELEMENT(BIT 0 OF KEY) AND IN    * 04400020
*   THE ENVIRONMENT REQUEST ELEMENT IS TURNED OFF. IF THE LAST        * 04600020
*   SEGMENT OF A CHECKPOINT WAS JUST WRITTEN,A FREEMAIN IS ISSUED     * 04800020
*   FOR THE RECORD. IF THE LAST SEGMENT OF AN ENVIRONMENT CHECK-      * 05000020
*   POINT WAS JUST WRITTEN A BIT IS TURNED ON IN EACH PCB(BIT 2 OF    * 05200020
*   PCBOFLG) TO INDICATE TO THE APPLICATION PROGRAM(S) THAT THE       * 05400020
*   CHECKPOINT WAS TAKEN,AND AN ELEMENT IS QPOSTED TO THE READY       * 05600020
*   QUEUE. IF THE REQUEST WAS FROM MCPCLOSE,THE ELEMENT IS THE        * 05800020
*   CLOSEDOWN COMPLETION QCB;OTHERWISE,IT IS THE ENVIRONMENT          * 06000020
*   REQUEST ELEMENT(TO BE PUT ON THE TIME DELAY QCB).                 * 06200020
*                                                                     * 06400020
*ENTRY POINT:                                                         * 06600020
*                                                                     * 06800020
*        IEDQNQ                                                       * 07000020
*                                                                     * 07200020
*INPUT:REGISTERS 2,9,12,14,15 CONTAIN THE FOLLOWING VALUES:           * 07400020
*                                                                     * 07600020
*   2-ADDRESS OF CHECKPOINT WORK AREA                                 * 07800020
*   9-ADDRESS OF AVT                                                  * 08000020
*   12-BASE REG FOR CHECKPOINT EXECUTOR-IEDQNF                        * 08200020
*   14-RETURN ADDRESS-IN IEDQNF                                       * 08400020
*   15-ENTRY POINT OF THIS MODULE                                     * 08600020
*                                                                     * 08800020
*OUTPUT:AN ELEMENT MAY BE QPOSTED TO THE READY QUEUE. SEE FUNCTION    * 09000020
*   FOR THE SITUATIONS.                                               * 09200020
*                                                                     * 09400020
*   A BIT IS SET FOR EACH APPLICATION PROGRAM                         * 09600020
*                                                                     * 09800020
*EXTERNAL ROUTINES:                                                   * 10000020
*                                                                     * 10200020
*        AQCTL SVC ROUTINE-QPOSTS ELEMENTS TO READY QUEUE             * 10400020
*        OS POST - CROSS MEMORY POST OF APPLICATION PROGRAM ECB       * 10600006
*        SVC 5 (FREEMAIN)                                             * 10650022
*        SVC 35 (WTO)                                                 * 10700022
*                                                                     * 10750022
*EXITS-NORMAL:IF A REQUEST WAS NOT COMPLETLY SATISFIED THE OFFSET     * 10800020
*   OF THE MODULE TO BUILD A RECORD FOR CKREQ,ICHNG,OR ENVIRONMENT    * 11000020
*   REQUESTS IS RETURNED IN R15,AND THIS MODULE BRANCHES TO THE       * 11200020
*   ADDRESS IN R14. OTHERWISE, IT BRANCHES TO 4 PLUS THE ADDRESS IN   X 11400020
*   R14.                                                              * 11600020
*                                                                     * 11800020
*EXITS-ERROR:THIS MODULE ISSUES AN ERROR MESSAGE VIA WTO. IF THE      * 12000020
*   RECORD WITH THE DISK ERROR IS CKREQ OR ENVIRONMENT,THE RECORD     * 12200020
*   IS FLAGGED IN THE CHECKPOINT WORK AREA. IT THEN BRANCHES TO THE   * 12400020
*   ADDRESS IN R14 WITH THE OFFSET OF THE DISK I/O ROUTINE,SO THAT    * 12600020
*   THE SAME RECORD CAN BE WRITTEN AT ANOTHER LOCATION.               * 12800020
*                                                                     * 13000020
*TABLES/WORK AREAS:                                                   * 13200020
*                                                                     * 13400020
*   AVT(AVTCKLE,AVTCKPTB,AVTCLOSB,AVTDELYB,AVTHA3,AVTOPCOB,           * 13600020
*       AVTPROPT)                                                     * 13800020
*   CHECKPOINT WORK AREA                                              * 14000020
*                                                                     * 14200020
*ATTRIBUTES:REENTERABLE                                               * 14400020
*                                                                     * 14600020
*NOTES:THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL REPRE-   * 14800020
*   SENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT TO    * 15000020
*   THE ONE USED AT ASSEMBLY TIME. THE CODING HAS BEEN ARRANGED SO    * 15200020
*   THAT REDEFINITION OF 'CHARACTER' CONSTANTS,BY REASSEMBLY, WILL    * 15400020
*   RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.               * 15600020
*                                                                     * 15800020
*********************************************************************** 16000020
         EJECT                                                          16100061
         SPACE 3                                                        16200020
*REGISTER ASSIGNMENTS                                                   16400020
         SPACE                                                          16600020
R0       EQU   0                                                        16800020
R1       EQU   1                                                        17000020
R2       EQU   2                        ADDRESS OF CKPT WORK AREA       17200020
R3       EQU   3                        ADDRESS OF REQUEST ELEMENT      17400020
R4       EQU   4                        ADDRESS OF DISK RECORD          17600020
R5       EQU   5                                                        17800020
R6       EQU   6                        ADDRESS OF PREVIOUS REQ ELM     18000020
R7       EQU   7                                                        18200020
R8       EQU   8                                                        18400020
RAVT     EQU   9                        ADDRESS OF AVT                  18600020
R10      EQU   10                       LENGTH FOR FREEMAIN             18800020
R11      EQU   11                       BRANCH REG                      19000020
R12      EQU   12                       BASE FOR CKPT EXECUTOR          19200020
R13      EQU   13                       BRANCH REG                      19400020
R14      EQU   14                       RETURN ADDR-IN CKPT EXECUTR     19600020
R15      EQU   15                       ENTRY POINT FOR THIS MODULE     19800020
         SPACE 3                                                        20000020
         USING *,R15                    BASE REG                        20200020
IEDQNQ   IEDHJN QNQ00                                            S99240 20400022
         USING IEDQAVTD,RAVT            BASE FOR AVT                    21200020
         USING IEDQCKPD,R2              BASE FOR CKPT WORK AREA         21400020
         USING IEDQCRED,R3              BASE FOR REQUEST ELEMENT        21600020
         USING IEDQCDRD,R4              BASE FOR DISK RECORD    SA52951 21700022
         L     R3,AVTCKPTB              GET QCB ELEMENT CHAIN           21800020
         CLI   CREKEY,CREREMVE          THIS CHECKPOINT REMOVAL@XA05298 21820061
*                                         ELEMENT              @XA05298 21840061
         BNE   QNQ02                    NO, BRANCH             @XA05298 21860061
         BAL   R6,QNQ78                 REMOVE THIS ELEMENT    @XA05298 21880061
         L     R3,AVTCKPTB              GET NEXT ELEMENT       @XA05298 21900061
QNQ02    EQU   *                                               @XA05298 21920061
         CLI   CREKEY,CRECPSYN          SYNCHRONIZE REQUEST    @OZ30932 21922000
         BNE   QNQ03                    NO, BRANCH             @OZ30932 21924000
         BAL   R13,GETLOCK              SET MODE AND GET LOCK  @OZ30932 21926000
         MVC   AVTCKPTB+ONE(L3),OFFST5(R3)  DELINK             @OZ30932 21928000
         BAL   R13,RELLOCK              SET MODE/RELEASE LOCK  @OZ30932 21930000
         LR    R6,R2                    ADDRESS OF WORKAREA    @OZ30932 21932000
         SH    R6,AVTHA4                BACKUP BY FOUR         @OZ30932 21934000
         LR    R5,R2                    START AT WORKAREA      @OZ30932 21936000
         L     R6,AVTEZERO(,R6)         GET SIZE OF PREFIX     @OZ30932 21938000
         SR    R5,R6                    GET ADDR OF PREFIX     @OZ30932 21940000
         LH    R6,EIGHT(,R5)            GET COUNT OUTSTANDING  @OZ30932 21942000
         BCTR  R6,AVTEZERO              DECREMENT BY ONE       @OZ30932 21944000
         STH   R6,EIGHT(,R5)            STORE NEW COUNT        @OZ30932 21946000
         LTR   R6,R6                    ANY MORE OUTSTANDING   @OZ30932 21948000
         BNZ   AVTECD4(R14)             YES, GO TO DISPATCHER  @OZ30932 21950000
         NI    AVTCKFLG,AVTEFF-AVTCKECB TURN OFF 2ND ECB FLAG      @21A 21951027
         XC    CKPIOFL1(FOUR),CKPIOFL1  CLEAR FLAGS            @OZ30932 21952000
         OI    CKPIOFL1,CKPCMDCH        TURN ON COMMAND CHAIN  @OZ30932 21954000
         XC    CKPIOFL3(EIGHT),CKPIOFL3 CLEAR FLAGS            @OZ30932 21956000
         XC    CKPIORC,CKPIORC          CLEAR ERROR COUNTS     @OZ30932 21958000
         L     R13,CKPCPARM             ADDRESS OF DEB         @OZ30932 21960000
         MVC   CKPIOBB(SIX),DEBBINUM-IEDQDEB(R13) DISK INFO    @OZ30932 21962000
         MVI   CKPIOM,AVTEZERO          CLEAR                  @OZ30932 21964000
         MVI   CKPIOR,ONE               RECORD NUMBER          @OZ30932 21966000
         LA    R13,CKPSCHID             ADDR OF CCW            @OZ30932 21968000
         ST    R13,CKPIOCPA-ONE         SET CHANNEL PROGRAM    @OZ30932 21970000
         MVI   CKPECB,AVTEZERO          CLEAR ECB              @OZ30932 21972000
         LA    R13,CKPCNTLR             ADDRESS OF CONTROL RCD @OZ30932 21974000
         STCM  R13,AD,CKPRW+ONE         PUT IN CHANNEL PROGRAM @OZ30932 21976000
         MVI   CKPRW,CKPWRITE           PUT IN COMMAND         @OZ30932 21978000
         MVI   CKPRW+SIX,AVTEZERO       CLEAR COUNT            @OZ30932 21980000
         MVC   CKPRW+SEV(ONE),CKPCRLEN  SET LENGTH OF RECORD   @OZ30932 21982000
         MVI   CKPSECTR,AVTEZERO        SET TO FIRST SECTOR    @OZ30932 21984000
         EXCP  CKPIOB                   WRITE RECORD           @OZ30932 21986000
         B     AVTECD4(R14)             EXIT TO DISPATCHER     @OZ30932 21988000
QNQ03    EQU   *                                               @OZ30932 21990000
         TM    CKPLREB,CKPNDRB          CHECK FOR UNSATISFIED REQ       22000020
         BZ    QNQ60                    BRANCH IF NOT UNSATISFIED       22200020
         SPACE 3                                                        22400020
*A CHECKPOINT REQUEST COULD NOT BE SATISFIED.REMOVE REQUEST ELEMENT     22600020
*FROM CKPT QCB CHAIN AND NOTIFY REQUESTOR.                              22800020
         SPACE                                                          23000020
         L     R6,CKPLREB               LAST REQ EL.-DISK RCD BUILT     23200020
         NC    CKPLREB+1(3),CKPLREB+1   CHECK FOR PREVIOUS ELEMENT      23400020
         BNZ   QNQ05                    BRANCH NOT ZERO                 23600020
         LA    R6,AVTCKPTB-4            GET DUMMY PREVIOUS ELEMENT      23800020
QNQ05    EQU   *                                                        24000020
         BAL   R13,GETLOCK              SET MODE AND GET LOCK    Y02027 24030006
         L     R3,4(0,R6)               NEXT REQ EL.IN CHAIN-RCD       X24200020
                                        NOT BUILD FOR IT                24400020
         MVC   5(3,R6),5(R3)            REMOVE REQ EL.FROM CHAIN        24600020
         BAL   R13,RELLOCK              SET MODE AND RELEASE LOCK|02027 24700006
         TM    CREKEY,B'01010000'       CHECK FOR ENVIRONMENT REQ       24800020
         BNO   QNQ80                    BRANCH IF NOT FOR ENV           25000020
         SPACE 3                                                        25200020
*THIS IS AN ENVIRONMENT REQUEST TO DISPOSE OF.                          25400020
         SPACE                                                          25600020
QNQ07    EQU   *                                                        25800020
         TM    AVTCKELF,AVTCINCN        CHECK FOR INCIDENT OVERFLOW     26000020
         BZ    QNQ30                    BRANCH IF NO INC OVERFLOW       26200020
         L     R3,AVTCKPTB              GET ELEMENT CHAIN FROM QCB      26400020
         LA    R6,AVTCKPTB-4            DUMMY PREVIOUS ELEMENT          26600020
         NI    AVTCKELF,X'FF'-AVTCINCN  TURN OFF INCIDENT OVERFLOW      26800020
         SPACE 3                                                        27000020
*THIS ENVIRONMENT CKPT IS A RESULT OF AN INCIDENT OVERFLOW. ALL         27200020
*INCIDENT REQUEST ELEMENTS WHICH HAVE AN OVERFLOW INDICATOR ON(HIGH     27400020
*ORDER BIT OF KEY FIELD) MUST BE REMOVED AND THE REQUESTORS             27600020
*NOTIFIED.                                                              27800020
         SPACE 3                                                        28000020
*BEGINNING OF LOOP THROUGH QCB CHAIN                                    28200020
         SPACE                                                          28400020
QNQ10    EQU   *                                                        28600020
         CLC   5(3,R6),AVTDELAD+1       CHECK FOR END OF ELMNT CHAI     28800020
         BE    QNQ30                    BRANCH IF END                   29000020
         SPACE                                                          29200020
         TM    CREKEY,CREINCOF          CHECK INCIDENT OVERFLOW BIT     29400020
         BZ    QNQ20                    BRANCH IF NOT ON                29600020
         SPACE                                                          29800020
         NI    CREKEY,X'FF'-CREINCOF    TURN OFF INCIDENT OVERFLOW      30000020
         BAL   R13,GETLOCK              SET MODE AND GET LOCK    Y02027 30100006
         MVC   5(3,R6),5(R3)            MOVE LINK FIELD TO PREVIOUS     30200020
         BAL   R13,RELLOCK              SET MODE AND RELEASE LOCKY02027 30300006
         BAL   R13,QNQ90                DETERMINE REQUESTOR,POST        30400020
         L     R3,AVTECD4(,R6)          GET NEXT ELE IN CHAIN   SA52951 30460022
         B     QNQ10                    CHECK FOR END OF CHAIN  SA52951 30520022
         SPACE                                                          30600020
QNQ20    EQU   *                                                        30800020
         LR    R6,R3                    SAVE PREVIOUS REQUEST ELEMT     31000020
         L     R3,4(0,R3)               GET NEXT ELEMENT IN CHAIN       31200020
         B     QNQ10                    GO CHECK FOR END OF CHAINS99240 31400022
         SPACE                                                          31600020
*END OF LOOP THROUGH QCB CHAIN                                          31800020
         SPACE 3                                                        32000020
*THERE IS NO INCIDENT OVERFLOW                                          32200020
         SPACE                                                          32400020
QNQ30    EQU   *                                                        32600020
         TM    AVTCKELF,AVTCMCPN        CHECK FOR MCPCLOSE REQUEST      32800020
         BZ    QNQ35                    BRANCH IF NOT MCPCLOSE REQ      33000020
         SPACE                                                          33200020
         LA    R1,AVTCLOSB              ADDR OF CLOSEDOWN COMPL QCB     33400020
         MVI   4(R1),PRICLSDN           SET LOW PRIOITY                 33600020
         LR    R0,R1                    QCB IS POSTED TO ITSELF         33800020
         NI    AVTCKELF,X'FF'-AVTCMCPN  TURN OFF REQUEST BITS           34000020
         B     QNQ40                    QPOST QCB TO READY QUEUE        34200020
QNQ35    EQU   *                                                        34400020
         MVC   AVTCKTIM,AVTCKELV        RESET CKPT TIME INTERVAL        34600020
         LA    R1,AVTCKELE              ADDRESS OF CKPT REQ ELEMENT     34800020
         LA    R0,AVTDELYB              ADDRESS TIME DELAY QCB          35000020
QNQ40    EQU   *                                                        35200020
         BAL   R11,QNQ85                QPOST                           35400020
         SPACE 3                                                        35800020
*TURN ON CHECKPOINT BIT IN EACH PCB.                                    36000020
         SPACE                                                          36200020
QNQ45    EQU   *                                                        36400020
         USING IEDQPCB,R10              BASE FOR PCB                    36600020
         LA    R10,AVTPCBPT-X'18'       DUMMY LAST PCB IN CHAIN         36800020
         SPACE 3                                                        37000020
*BEGINNING OF LOOP THROUGH ALL PCBS                                     37200020
         SPACE                                                          37400020
QNQ46    EQU   *                                                        37600020
         NC    PCBLINK(3),PCBLINK       CHECK FOR END OF CHAIN          37800020
         BZ    QNQ47                    BRANCH IF END                   38000020
         L     R10,PCBLINK-1            GET NEXT IN CHAIN               38200020
         OI    PCBOFLG,PCBCKPTN         TURN ON CKPT BIT                38400020
         B     QNQ46                    BRANCH TO LOOP                  38600020
         SPACE                                                          38800020
*END OF LOOP THROUGH PCBS                                               39000020
         SPACE 3                                                        39200020
QNQ47    EQU   *                                                        39400020
         LH    R10,CKPBPERR             LENGTH FOR ENV.DISK RCD         39600020
         SPACE 3                                                        39800020
*ISSUE FREEMAIN FOR CURRENT EXCP RECORD                                 40000020
         SPACE                                                          40200020
QNQ50    EQU   *                                                        40400020
         TM    CKPLREB,CKPNDRB          IS THIS UNSATISFIED REQUEST     40600020
         BO    QNQ55                    BRANCH IF UNSATISFIED           40800020
         SPACE                                                          41000020
         LA    R11,CKPEXCP              ADDRESS OF RCD TO FREE          41200020
         FREEMAIN E,LV=(R10),A=(R11),MF=(E,CKPGETML)                    41400020
         SPACE                                                          41600020
         XC    CKPEXCP,CKPEXCP          CLEAR CURRENT EXCP SLOT         41800020
QNQ55    EQU   *                                                        42000020
         NI    CKPLREB,AVTEFF-CKPNDRB   TURN OFF UNSATISFIED BITSA52951 42200022
         B     AVTECD4(R14)             RETURN TO CKPT EXECUTOR SA52951 43400022
         SPACE 3                                                        44200020
*THE DISK RECORD IN THE CURRENT EXCP SLOT HAS BEEN WRITTEN. DISPOSE     44400020
*OF IT. DETERMINE IF REQUEST IS COMPLETED.                              44600020
         SPACE                                                          44800020
QNQ60    EQU   *                                                        45000020
         L     R4,CKPEXCP               ADDR OF DISK RCD JUST WRITN     45200020
         MVI   CKPECB,0                 CLEAR ECB COMPLETION CODE       45400020
         TM    CKPIOECB,X'7F'           CHECK FOR DISK ERROR            45600020
         BNO   QNQ82                    BRANCH IF DISK ERROR            45800020
         CLI   CDRKEY,CDRTOTLC          CHECK FOR TOTAL(NOT LASTSEG     46000020
         BNE   QNQ65                    BRANCH NOT TOTAL-LAST SEG       46200020
QNQ63    EQU   *                                                        46400020
         LA    R15,CKPENV               OFFSET FOR MODULE TO BUILD     X46600020
                                        NEXT SEGMENT OF ENV CKPT        46800020
         BR    R14                      RETURN TO EXECUTOR              47000020
         SPACE                                                          47200020
QNQ65    EQU   *                                                        47400020
         CLI   CDRKEY,CDRTOTAL          CHECK FOR ENV-LAST SEGMENT      47600020
         BNE   QNQ67                    BRANCH IF NOT ENV RCD           47800020
         LA    R6,AVTCKPTB-AVTECD4      DUMMY PREVIOUS ELEMENT  SA52951 48000022
         LA    R13,AVTCKELE             ADDR OF CKPT ELEMENT    SA52951 48010022
         ST    R13,CKPTRMAD             SAVE ADDR FOR COMPARE   SA52951 48020022
QNQ66    EQU   *                                                SA52951 48030022
         CLC   OFFST5(L3,R6),CKPTRMAD+ONE IS THIS THE CKPT ELE  SA52951 48040022
         BE    QNQ6605                  IF SO,REMOVE FROM CHAIN SA52951 48050022
         SPACE 1                                                        48060022
         L     R6,AVTECD4(,R6)          NEXT ELEMENT IN CHAIN   SA52951 48070022
         B     QNQ66                    TEST FOR CKPT ELEMENT   SA52951 48080022
         SPACE 1                                                        48090022
QNQ6605  EQU   *                                                SA52951 48100022
         BAL   R13,GETLOCK              SET MODE AND GET LOCK    Y02027 48110006
         MVC   OFFST5(L3,R6),AVTCKELE+OFFST5 REMOVE CKPT ELE    SA52951 48240022
         CLC   CKPLREB+ONE(L3),CKPTRMAD+ONE WAS LAST DISK RCD   SA52951 48250022
*                                       BUILT FOR CKPT ELEMENT  SA52951 48260022
         BNE   QNQ6609                  IF NOT, BYPASS CLEAR    SA52951 48270022
         XC    CKPLREB,CKPLREB          CLEAR ELEMENT POINTER   SA52951 48280022
         SPACE 1                                                        48290022
QNQ6609  EQU   *                                                SA52951 48300022
         BAL   R13,RELLOCK              SET MODE AND RELEASE LOCKY02027 48310006
         B     QNQ07                    DISPOSE OF ENVIRON. REQ. S99240 48600022
         SPACE                                                          48800020
QNQ67    EQU   *                                                        49000020
         TM    CDRCKFLG,CDRCKRNC        CHECK FOR REQ NOT COMPLETED     49200020
         BZ    QNQ75                    BRANCH NOT CKREQ CONTINUED      49400020
         CLI   CDRKEY,CDRCKREQ          CHECK FOR CKREQ RECORD          49600020
         BNE   QNQ75                    BRANCH IF NOT CKREQ             49800020
         LA    R15,CKPCKREQ             OFFSET FOR CKREQ RTN            50000020
         BR    R14                      RETURN TO EXECUTOR              50200020
         SPACE                                                          50400020
QNQ75    EQU   *                                                        50600020
         LA    R6,QNQ80                 LOAD BR REG            @XA05298 50610061
         CLI   CDRKEY,CDROPC            WAS OPERATOR CONTROL     S99240 50620022
*                                        INCIDENT RECORD WRITTEN S99240 50640022
         BNE   QNQ78                    NO, REMOVE REQ ELEMENT   S99240 50660022
         LH    R10,CKPINCLN             FREEMAIN LNGTH FOR INCIDSA58451 50670022
         TM    CDRTTRLI+2,2             IS THIS THE LAST SEGMENT S99240 50680022
         BZ    QNQ50                    NO, FREE THIS RECORD AND S99240 50700022
*                                        RETURN TO WRITE NEXT    S99240 50720022
QNQ78    EQU   *                                                 S99240 50740022
         BAL   R13,GETLOCK              SET MODE AND GET LOCK    Y02027 50800006
         CLM   R3,AD,CKPLREB+1          CHECK PREVIOUS ELEMENT     @22C 50820027
         BNE   QNQ79                    BR IF NOT EQUAL TO FIRST Y02027 50840006
         XC    CKPLREB,CKPLREB          CLEAR ADDR OF ELEMENT    Y02027 50860006
QNQ79    EQU   *                                                 Y02027 50880006
         MVC   AVTCKPTB+1(3),5(R3)      DELINK ELEMENT           Y02027 50900006
         BAL   R13,RELLOCK              SET MODE AND RELEASE LOCKY02027 50920006
         BR    R6                       RETURN                 @XA05298 50960061
QNQ80    EQU   *                                                        51000020
         BAL   R13,QNQ90                DETERMINE REQUESTOR,POST        51200020
         B     QNQ50                    FREEMAIN                        51400020
         SPACE 3                                                        51600020
*THERE WAS A DISK ERROR IN THE LAST RECORD WRITTEN                      51800020
         SPACE                                                          52000020
QNQ82    EQU   *                                                        52200020
         CLI   CDRKEY,CDRCKREQ          CHECK RECORD TYPE               52600020
         BL    QNQ84                    INCIDENT                        52800020
         BH    QNQ83                    ENV                             53000020
         SPACE 3                                                        53200020
*CKREQ RECORD                                                           53400020
         SPACE                                                          53600020
         L     R8,CKPCTTRB              ADDRESS OF CKREQ TTR RABLE      53800020
         SPACE 3                                                        54000020
*BEGINNING OF LOOP THROUGH CKREQ-TTR TABLE                              54200020
         SPACE                                                          54400020
QNQ825   EQU   *                                                        54600020
         TM    CKPCTFLG(R8),CKPCTDER    CHECK FOR DISK ERROR            54800020
         BO    QNQ827                   BRANCH IF ERROR                 55000020
         CLC   CDRCKOFF,CKPCTOFF(R8)    COMPARE OFFSETS                 55200020
         BE    QNQ829                   BRANCH IF EQUAL                 55400020
QNQ827   EQU   *                                                        55600020
         LA    R8,CKPCTTRL(0,R8)        MOVE TO NEXT ENTRU              55800020
         B     QNQ825                   LOOP TO NEXT ENTRY              56000020
         SPACE                                                          56200020
*END OF LOOP THROUGH CKREQ-TTR TABLE                                    56400020
         SPACE 3                                                        56600020
QNQ829   EQU   *                                                        56800020
         OI    CKPCTFLG(R8),CKPCTDER    TURN ON DISK ERROR FLAG         57000020
         B     QNQ84                    WRITE ERROR MESSAGE             57200020
         SPACE 3                                                        57400020
*ENVIRONMENT SEGMENT                                                    57600020
         SPACE                                                          57800020
QNQ83    EQU   *                                                        58000020
         CLC   CKPRW+6(2),CKPCRLEN      CHECK FOR CONTROL RECORD        58200020
         BNE   QNQ835                   BRANCH IF NOT CONTROL RCD  0217 58300020
         WTO   'IED087I CHECKPOINT DISK ERROR-CONTROL RECORD',     0217X58400020
               ROUTCDE=11,DESC=4                                        58500020
         B     QNQ845                   BRANCH TO EXIT CODE        0217 58600020
QNQ835   EQU   *                                                   0217 58700020
         SR    R7,R7                    CLEAR FOR IC             Y02027 58750006
         IC    R7,CKPTTRCT              CORRENT ENV TTR                 58800020
         MH    R7,AVTHA3                MULTIPLY BY 3                   59000020
         LA    R7,CKPTTRT1-3(R7)        ADDRESS OF TTR             0217 59200020
         XC    0(3,R7),0(R7)            CLEAR TTR                       59400020
         SPACE 3                                                        59600020
*INCIDENT RECORD                                                        59800020
         SPACE                                                          60000020
QNQ84    EQU   *                                                        60200020
         WTO   'IED084I CHECKPOINT DISK ERROR-RECOVERED',          0217X60300020
               ROUTCDE=11,DESC=4                                        60400020
QNQ845   EQU   *                                                        60600020
         LA    R15,CKPDIOR              OFFSET FOR DISK I/O ROUTINE     61800020
         BR    R14                      RETURN TO EXICUTOR              62000020
         SPACE 3                                                        62200020
*SUBROUTINE TO SET UP REGISTERS FOR DISPATCHER TO QPOST ELEMENT TO      62400020
*THE READY QUENE. REGISTER 11 IS THE BRANCH REG.                        62600020
         SPACE                                                          62800020
QNQ85    EQU   *                                                        63000020
         ST    R0,CKPTRMAD              ADDR OF QCB                     63200020
         MVC   1(3,R1),CKPTRMAD+1       PUT QCB ADDR IN REQ ELEMENT     63400020
QNQ86    EQU   *                                                   1016 63500020
         XC    5(3,R1),5(R1)             CLEAR LINK FIELD               63600020
         LR    R0,R1                    DUPLICATE ADDRESS               63800020
         STM   R0,R1,CKPSAVE2           PUT INTO PARM LIST              64000020
         MVI   CKPSAVE2,X'0C'           PUT IN 1ST BYTE                 64200020
QNQ87    EQU   *                                                        64400020
         LA    R1,CKPSAVE2              ADDRESS OF PARM LIST            64600020
         LR    R5,R15                   SAVE REG                        64800020
         AQCTL                          POST ELEMENT TO READY Q         65000020
         LR    R15,R5                   RESTORE REG                     65200020
         SPACE                                                          65400020
         BR    R11                      RETURN                          65600020
         SPACE                                                          65800020
*END OF SUBROUTINE                                                      66000020
         SPACE 3                                                        66200020
*SUBROUTINE TO DETERMINE CKPT REQUESTOR AND POST IT COMPLETE            66400020
*REGISTER 13 IS BRANCH REG                                              66600020
QNQ90    EQU   *                                                        66800020
         SPACE                                                          67000020
         LH    R10,CKPINCLN             FREEMAIN LENGTH FOR INCIDNT     67200020
         LR    R1,R3                    ADDR OF ELEMENT FOR READY Q1016 67300020
         CLI   CREKEY,CREOPC            CHECK FOR OPERATOR CONTROL      67400020
         BNE   QNQ92                    BRANCH IF NOT OP CONTROL        67600020
         SPACE                                                          67800020
         LA    R0,AVTOPCOB              ADDR OPC QCB               1013 67900020
         BAL   R11,QNQ85                POST ELEMENT TO READY QUEUE1016 68000020
         BR    R13                      RETURN                     1016 68200020
         SPACE                                                          68400020
QNQ92    EQU   *                                                        68600020
         CLI   CREKEY,CRELCB            CHECK FOR LCB FROM MH           68800020
         BNE   QNQ94                    BRANCH IF NOT LCB               69000020
         SPACE                                                          69200020
         USING IEDQLCB,R3                                               69400020
         LA    R11,LCBERB-IEDQLCB       OFFSET FOR ERB INTO LCB    1016 69600020
         SR    R3,R11                   ADDR OF LCB BEGINNING      1016 69700020
         LR    R1,R3                    COPY LCB ADDR FOR POST     1021 69800020
         L     R11,LCBSCBA-1            ADDRESS OF SCB                  70000020
         USING IEDQSCB,R11                                              70200020
         NI    SCBSTATE,X'FF'-SCBCKPT   TURN OFF CHECKPT BIT            70400020
         BAL   R11,QNQ86                POST ELEMENT TO READY QUEUE1016 70900020
         BR    R13                      RETURN FROM SUBROUTINE          71400020
         SPACE                                                          71600020
QNQ94    EQU   *                                                        71800020
         LR    R11,R3                   ADDRESS OF CRE - IT IS   Y02027 72000006
*                                       LOCATED IN AIB           Y02027 72090006
         SH    R11,AVTHA16              BACK UP TO AIB           Y02027 72180006
         USING IEDQAIB,R11              ADDRESSABILITY OF AIB    Y02027 72270006
         MVC   AIBCMPTC(4),AIBCKECB     STORE ECB IN LIST        Y02027 72360006
         L     R1,AIBPCBAD              GET PCB ADDRESS          Y02027 72450006
         L     R1,PCBPEBAD-IEDQPCB(R1)  GET PEB ADDRESS          Y02027 72540006
         LTR   R1,R1                    TEST IF AP IS ACTIVE     Y02027 72630006
         BZ    BYPASS                   BRANCH IF NO TO AVOID    Y02027 72720006
*                                       XMPOST                   Y02027 72810006
         L     R1,PEBASCB-IEDQPEB(R1)   GET ASCB ADDRESS         Y02027 72900006
         LTR   R1,R1                    TEST IF FLAG HAS         Y02027 72990006
*                                       INVALIDATED ASCB ADDRESS Y02027 73080006
         BM    BYPASS                   BRANCH IF NEGATIVE - FLAGY02027 73170006
*                                       ON - AVOID XMPOST        Y02027 73260006
         ST    R1,AIBCMPTC+FOUR         STORE IN LIST            Y02027 73350006
         L     R1,CVTPTR                ADDRESS OF CVT           Y02027 73440006
         LA    R1,CVTBRET(R1)           GET ERROR ADDRESS -BR 14 Y02027 73530006
         ST    R1,AIBCMPTC+EIGHT        STORE IN LIST            Y02027 73620006
         LA    R1,AIBCMPTC              GET ADDR OF LIST         Y02027 73710006
         LR    R5,R15                   SAVE REG                 Y02027 73800006
         SR    R0,R0                    ZERO COMPLETION CODE     Y02027 73890006
         POST  ,(0),MF=(E,(1))                                   Y02027 73980006
         LR    R15,R5                   RESTORE REGISTER         Y02027 74070006
BYPASS   EQU   *                                                 Y02027 74160006
         CLI   CDRKEY,CDRCKREQ          CHECK FOR CKREQ                 74400020
         BCR   7,R13                    BRANCH IF NOT CKREQ             74600020
         LH    R10,CKPCKRLN             LENGTH OF CKREQ RCD             74800020
         BR    R13                      RETURN FROM SUBROUTINE          75000020
         SPACE 3                                                        75200020
GETLOCK  EQU   *                                                 Y02027 76800006
         LR    R5,R15                   SAVE REG                 Y02027 76900006
         LR    R7,R14                   SAVE REG                 Y02027 77000006
         MODESET MODE=SUP               SET TO SUPERVISOR STATE  Y02027 77100006
         MODESET EXTKEY=SUPR            SET TO KEY ZERO          Y02027 77200006
SETATSK  EQU   *                                                 Y02027 77300006
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=USE,               C77400006
               RELATED=ATTACHED-TASKS-IGG019RO/IGG019RB(SETATSK) Y02027 77500006
         LR    R15,R5                   RESTORE REG              Y02027 77600006
         LR    R14,R7                   RESTORE REG              Y02027 77700006
         BR    R13                      RETURN                   Y02027 77800006
         SPACE 3                                                 Y02027 77900006
RELLOCK  EQU   *                                                 Y02027 78000006
         LR    R7,R14                   SAVE REG                 Y02027 78100006
         LR    R5,R15                   SAVE REG                 Y02027 78200006
         SETLOCK RELEASE,TYPE=LOCAL,REGS=USE,                          C78300006
               RELATED=ATTACHED-TASKS-IEDQNQ(SETATSK)            Y02027 78400006
         MODESET EXTKEY=TCAM            SET TO TCAM KEY          Y02027 78500006
         LR    R15,R5                   RESTORE BASE REG         Y02027 78600006
         MODESET MODE=PROB              SET TO PROBLEM STATE     Y02027 78700006
         LR    R14,R7                   RESTORE REG              Y02027 78800006
         LR    R15,R5                   RESTORE REG              Y02027 78900006
         BR    R13                      RETURN                   Y02027 79000006
* EQUATED SYMBOLS                                               SA52951 79420022
         SPACE 1                                                        79430022
ONE      EQU   1                        CONSTANT ONE            SA52951 79440022
L3       EQU   3                        LENGTH OF THREE         SA52951 79450022
OFFST5   EQU   5                        OFFSET OF FIVE          SA52951 79460022
SIX      EQU   6                        OFFSET                 @OZ30932 79460500
SEV      EQU   7                        OFFSET                 @OZ30932 79461000
AD       EQU   7                        MASK                   @OZ30932 79461500
FOUR     EQU   4                        DISPLACEMENT             Y02027 79462006
EIGHT    EQU   8                        DISPLACEMENT             Y02027 79464006
CVTPTR   EQU   16                       PTR TO CVT               Y02027 79466006
CVTBRET  EQU   X'52'                    OFFSET IN CVT TO BR 14   Y02027 79468006
         EJECT                                                  SA52951 79470022
         IHAPSA                         DSECT FOR SETLOCK        Y02027 79500006
* DSECT FOR DEB                                                @OZ30932 79504000
         SPACE 2                                               @OZ30932 79508000
IEDQDEB  DSECT                                                 @OZ30932 79512000
         ORG   IEDQDEB+16               ORG TO START OF DEB    @OZ30932 79516000
DEBNMEXT DS    X                        NO EXTENTS IN DATA SET @OZ30932 79520000
         ORG IEDQDEB+25                 ORG TO DCB POINTER     @OZ30932 79524000
DEBDCBAD DS    AL3                      ADDR OF DCB            @OZ30932 79528000
         SPACE 1                                               @OZ30932 79532000
*FOR EACH EXTENT THERE IS A 16-BYTE SEGMENT AS FOLLOWS.        @OZ30932 79536000
         SPACE 1                                               @OZ30932 79540000
         ORG   IEDQDEB+32               ORG TO UCB             @OZ30932 79544000
DEBDVMOD DS    XL1                      DEVICE MODIFIER        @OZ30932 79548000
DEBUCBAD DS    XL3                      ADDR OF UCB            @OZ30932 79552000
DEBBINUM DS    XL2                      BIN NO                 @OZ30932 79556000
DEBSTRCC DS    XL2                      CYLINDER ADDR FOR START@OZ30932 79560000
DEBSTRHH DS    XL2                      TRACK ADDR FOR START   @OZ30932 79564000
DEBENDCC DS    XL2                      CYLINDER ADDR FOR END  @OZ30932 79568000
DEBENDHH DS    XL2                      TRACK ADDR FOR END     @OZ30932 79572000
DEBNMTRK DS    XL2                      NO TRACKS THIS EXTENT  @OZ30932 79576000
DEBEND   EQU   *                                               @OZ30932 79580000
DEBSEGLN EQU   DEBEND-DEBDVMOD          LNGTH OF SEG FOR EACH  @OZ30932 79584000
*                                       EXTENT                 @OZ30932 79588000
         SPACE 3                                                        79600020
         SPACE 3                                                        80600020
         TCKPD 3330                     MERLIN VERSION      0512 S21101 80800000
         TAVTD                                                          81200020
         TDISPD                                                         81400020
         TPCBD                                                          81600020
         TLCBD                                                          81800020
         TSCBD                                                          82000020
         TPRIOR                                                         82200020
         TAIBD EXT=(CKREQ)                                       Y02027 82260006
         TPEBD                                                   Y02027 82320006
         END                                                            82400020
