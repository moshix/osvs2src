         TITLE 'IEDQNX - OPERATOR AWARENESS MESSAGE ROUTER'             00050000
IEDQNX   CSECT                                                          00200020
         SPACE 3                                                        00220000
*********************************************************************** 00600020
*                                                                     * 00800020
* MODULE NAME = IEDQNX (TCAM, TERMINATION)                            * 01000000
*                                                                     * 01420022
* DESCRIPTIVE NAME = OPERATOR AWARENESS MESSAGE ROUTER                * 01430000
*                                                                     * 01460022
* COPYRIGHT = NONE                                                    * 01470000
*                                                                     * 01500022
* STATUS = VERSION 10.0                                               * 01510000
*                                                                     * 01600020
* FUNCTION = THIS MODULE BUILDS ERROR MESSAGES AND SENDS THEM TO      * 01700000
* THE PRIMARY OPERATOR CONTROL TERMINAL.                              * 01800000
*                                                                     * 01900000
* WHEN IEDQBD DETECTS AN ERROR SITUATION, CONTROL IS PASSED TO        * 02000000
* THIS ROUTINE WHERE ERROR ANALYSIS IS PERFORMED AND THE              * 02200000
* APPROPRIATE ERROR MESSAGE IS CONSTRUCTED IN AVTSAVE4. IF THE        * 02250000
* PRIMARY OPERATOR CONTROL TERMINAL IS THE SYSTEM CONSOLE THE         * 02300000
* MESSAGE IS DELIVERED VIA THE WTO SVC. OTHERWISE A BUFFER IS         * 02350000
* ACQUIRED FROM THE FREE POOL, ITS PREFIX AND THE SCB INITIALIZED     * 02400000
* FOR TPOST TO THE PRIMARY TERMINAL'S DESTINATION QUEUE, AND THE      * 02450000
* ERROR MESSAGE IS MOVED INTO THE BUFFER. THE ERROR INDICATOR IS      * 02500000
* RESET AND THE LCB IS INITIALIZED FOR TPOST TO IEDQBD TO CONTINUE    * 02550000
* LCB CLEANUP PROCESSING. THE BUFFER AND LCB ARE PASSED TO THE        * 02600000
* TCAM DISPATCHER AT DSPCHAIN.                                        * 02650000
*                                                                     * 02700000
* THIS MODULE'S ADDRESS IS CONTAINED IN THE TCAM AVT (AVTNX). IT IS   * 02750000
* LOADED AT TCAM INITIALIZATION IF THE 'PRIMARY' OPERAND ON THE       * 02800000
* INTRO MACRO IS NOT 'SYSCON'. IT IS ALSO LOADED EACH TIME A 3705     * 02850000
* DCB IS OPENED.                                                      * 02900000
*                                                                     * 02950000
* FOR 270X, WHEN I/O ERRORS OCCUR THE APPROPRIATE ERROR RECOVERY      * 03000000
* (ERP) ROUTINES GAIN CONTROL. AFTER THE ERROR IS DECLARED PERMANENT  * 03050000
* THE PRIMARY OPERATOR CONTROL STATION IS CHECKED FOR THE SYSTEM      * 03100000
* CONSOLE, AND IF NOT AN ERROR INDICATION IS SET IN THE LCB FOR THE   * 03150000
* LINE (LCBERMSG) AND INFORMATION PERTINENT TO THE ERROR IS           * 03200000
* INITIALIZED IN THE LCB AS FOLLOWS:                                  * 03260000
*                                                                     * 03320000
* LCBRESTR-THE COMMAND CODE OF THE FAILING CCW                        * 03400000
* LCBCSWST-THE TWO STATUS BYTES OF THE CSW                            * 03600000
* LCBSENS0-THE FIRST SENSE BYTE IN THE IOB                            * 03800000
* LCBFLAG2-THE TP OP CODE OF THE LAST RETRY CCW                       * 04000000
* LCBSENS1-THE TP OP CODE OF THE FIRST FAILING CCW                    * 04200000
* LCBERRCT-ADDRESSING CHARACTERS,LAST FOUR DIAL DIGITS,OR POLLING     * 04400000
*          CHARACTERS                                                 * 04600000
*                                                                     * 05000020
* WHEN IEDQBD DETECTS THE ERROR INDICATOR, CONTROL IS PASSED TO       * 05100000
* IEDQNX TO RECOVER INFORMATION FROM THE LCB AND CONSTRUCT THE        * 05200000
* IEA000I ERROR MESSAGE IN AVTSAVE4.                                  * 05300000
*                                                                     * 05400000
* FOR 370X, ERRORS MAY BE ASSOCIATED WITH THE 3705 ITSELF OR WITH     * 05600000
* RESOURCES ATTACHED TO THE 3705.                                     * 05800000
*                                                                     * 05900000
* FOR ERRORS ASSOCIATED WITH THE 3705 CHANNEL, 3705 ERP ROUTINES      * 06000000
* INITIALIZE CERTAIN INFORMATION IN THE 3705 LCB AS FOLLOWS:          * 06200000
*                                                                     * 06300000
* LCBUNADD-ADDRESS OF EBCDIC NAME OF THE 3705 CHANNEL UNIT ADDRESS    * 06400000
* LCBQNXMN-ERROR MESSAGE INDICATOR (IED064I,IED142I,IED162I)   @OX21816 06600082
* LCBRESTR-COMMAND CODE OF FAILING CCW                                * 06700000
*                                                                     * 06800000
* THE RESULTING INOPERATIVE PIU IS PASSED TO THE SSCP WHO SETS THE    * 07000000
* ERROR INDICATOR (LCBERMSG) BEFORE PASSING THE INOPERATIVE THROUGH   * 07200000
* THE SSCP MESSAGE HANDLER. IEDQNX GAINS CONTROL AND RECOVERS CERTAIN * 07300000
* INFORMATION FROM THE 3705 LCB TO BUILD THE APPROPRIATE ERROR        * 07400000
* MESSAGE.                                                            * 07500000
*                                                                     * 07600000
* FOR 3705 ERROR MESSAGES NOT ASSOCIATED WITH THE 3705 CHANNEL THE    * 07700000
* SSCP SAVES THE REQUEST UNIT COMMAND IN THE FIELD 'LCBNXCMD' AND     * 07800000
* THE TNT INDEX OF THE 3705 RESOURCE IN THE FIELD 'LCBLNENT'. THESE   * 07900000
* FIELDS ARE ANALYZED BY IEDQNX IN ORDER TO BUILD THE APPROPRIATE     * 08000000
* ERROR MESSAGE (IED403I OR IED509I).                                 * 08060000
*                                                                     * 08800020
* NOTES - SEE BELOW                                                   * 08809000
*                                                                     * 08818000
*    DEPENDENCIES = EBCDIC CHARACTER CODE DEPENDENCIES - CORRECTABLE  * 08827000
*    BY RECOMPILE                                                     * 08836000
*                                                                     * 08845000
*    RESTRICTIONS = NONE                                              * 08854000
*                                                                     * 08863000
*    REGISTER CONVENTIONS = ALL OF THE REGISTER SYMBOLS USED BY THIS  * 08872000
*    MODULE ARE DEFINED IN THE EQUATE STATEMENTS                      * 08881000
*                                                                     * 08890000
*    PATCH LABEL = NONE                                               * 08899000
*                                                                     * 08908000
* MODULE TYPE = PROCEDURE                                             * 08917000
*                                                                     * 08926000
*    PROCESSOR = ASSEMBLER F                                          * 08935000
*                                                                     * 08944000
*    MODULE SIZE = 1200 DECIMAL BYTES                                 * 08953000
*                                                                     * 08962000
*    ATTRIBUTES = SERIALLY REUSABLE, PROBLEM PROGRAM STATE            * 08971000
*                                                                     * 08980000
* ENTRY POINT = IEDQNX                                                * 08989000
*                                                                     * 09600020
*    PURPOSE = SEE FUNCTION                                           * 09620000
*                                                                     * 09640000
*    LINKAGE= AT ENTRY R12 CONTAINS THE ENTRY POINT ADDRESS OF THIS   * 09660000
*    MODULE.                                                          * 09680000
*                                                                     * 09700000
* INPUT = REGISTERS 3,4,11,12,13 CONTAIN THE FOLLOWING VALUES:   S22025 09720000
* 3-ADDRESS OF SCB                                                    * 09800000
* 4-ADDRESS OF LCB                                                    * 10800000
* 11-ADDRESS OF TCAM DISPATCHER                                       * 11000000
* 12-ADDRESS OF IEDQNX                                                * 11200000
* 13-ADDRESS OF AVTSAVE2                                              * 11400000
*                                                                     * 12200020
* OUTPUT = AN ERROR MESSAGE IS BUILT FOR THE PRIMARY CONTROL TERMINAL * 12300000
*                                                                     * 13000020
* EXITS-NORMAL = THIS MODULE BRANCHES TO DSPCHAIN WITH A CHAIN OF     * 13100000
* ELEMENTS IN REG1. THE BUFFER WITH THE ERROR MESSAGE IS THE FIRST    * 13200000
* IN THE CHAIN.                                                       * 13400000
*                                                                     * 13800020
* EXITS-ERROR = IF THERE ARE NO AVAILABLE BUFFERS,THIS MODULE BRANCHES* 13900000
* TO DSPCHAIN WITH THE LCB AS THE FIRST ELEMENT IN THE CHAIN          * 14000000
*                                                                     * 14400020
* EXTERNAL REFERENCES = SEE BELOW                                     * 14500000
*                                                                     * 14800020
*    ROUTINES = IEDQTNT  (TNT INDEX TO TRM CONVERSION)                * 14808000
*               IEDIAP04 (TNT INDEX TO NETWORK ADDRESS CONVERSION)    * 14816000
*               IEDIAP06 (NETWORK ADDRESS TO LCB ADDRESS CONVERSION)  * 14824000
*               IEDQTL   (DEVICE DEPENDENT SECTION ADDRESS LOOKUP)    * 14832000
*               IEDQGA02 (BUFFER STEAL ROUTINE)                       * 14840000
*                                                                     * 14848000
*    DATA AREAS = AVTSAVE4                                            * 14856000
*                                                                     * 14864000
*    CONTROL BLOCKS = AVT                                             * 14872000
*                     DCB                                             * 14880000
*                     DEB                                             * 14888000
*                     LCB                                             * 14896000
*                     PRF                                             * 14904000
*                     QCB                                             * 14912000
*                     SCB                                             * 14920000
*                     TNT                                             * 14928000
*                     TRM                                             * 14936000
*                     UCB                                             * 14944000
*                                                                     * 14952000
* TABLES = LINE TRACE TABLE CONTROL WORDS                             * 14960000
*                                                                     * 14968000
* MACROS = IEDHJN                                                     * 14976000
*          WTO                                                        * 14984000
*                                                                     * 14992000
* CHANGE ACTIVITY = SEE BELOW                                         * 15000000
*A389500,441000,667000,677000                                    S22026 18400000
*C098000,198000,628000,660000-666000,676000,692000,712000        S22025 18405000
*D714000                                                         S22025 18410000
*A233000,270200-271800,273000,294200-295200,332060-333620        S22024 18415000
*A333680-333740,333860-333920,373000,380200-381200               S22024 18420000
*A670400-671600,675000-676000,684600-685200,686400-687600        S22024 18425000
*C014000,333800,348000,676500,738000,746000                      S22024 18430000
*D552000                                                         S22024 18435000
*C675000                                                        SA61080 18440000
*C352000,360000                                                 SA66363 18445000
*A333560,677000,702000                                         @YA05956 18450000
*A319000,326000                                                @YA07494 18455000
*D330000                                                       @YA07494 18460000
*C352000,C360000,A364600                                       @OY11534 18465000
*A295200,A666000                                               @OX14080 18467000
*C677500,677506,677524                                         @OS77924 18468000
*A088000,096000,148000,184000,196000,204000,206000,208000      @Y17XATI 18470000
*A210000,214000,226000,236000,270000,272000,274000,294000      @Y17XATI 18475000
*A294800,312000,326500,333140,333170,333380,408000,612000      @Y17XATI 18480000
*A652000,656000,666000,677500,709000                           @Y17XATI 18485000
*C014000,014800,015200,018000-020000,080000-082000,090000      @Y17XATI 18490000
*C146000,150000-182000,200000-202000,228000-230000,270000      @Y17XATI 18495000
*C270400,270600-271600,271800,272000-273000,276000-294000      @Y17XATI 18500000
*C294200-294600,295000,304000,312000,318000,319600,326500      @Y17XATI 18505000
*C332300-333140,333440-333600,333860,376000-384000,388000      @Y17XATI 18510000
*C389500,402000,412000,418000-420000,430000,434000             @Y17XATI 18515000
*C440000-446000,456000-458000,490000,496000-500000,526000      @Y17XATI 18520000
*C542000,546000,564000,568000,586000-588000,592000-597000      @Y17XATI 18525000
*C598000-600000,618000,638000,642000-644000,656000             @Y17XATI 18530000
*C684600-709000                                                @Y17XATI 18535000
*D002400-003013,010000-012000,084000-086000,092000-094000      @Y17XATI 18540000
*D100000,126000-128000,198000,232000,302000,310000,316000      @Y17XATI 18545000
*D319000-319200,324000-326000,333320,333680,333920-365200      @Y17XATI 18550000
*D372000,390000,422000,426000-428000,436000-438000             @Y17XATI 18555000
*D462000-484000,488000,530000,677700                           @Y17XATI 18560000
*C295290-297660,C326760,C326800,A666600,A718000,D297720        @OX16393 18561000
*A272490,A272550,A333620                                       @OY16369 18562000
*A296190,C296390,C296590,C296690,A718120                       @OZ24288 18563000
*C270005,A270010,C270050,C333280                               @OX19662 18563182
*C272340                                                       @OY20726 18563282
*C066000,272440,272675-272680,272690-272695,677626,684160      @OX21816 18563382
*                                                                     * 18565000
*********************************************************************** 18600020
         EJECT                                                          18700000
*REGISTER ASSIGNMENTS                                                   19000020
         SPACE 1                                                        19200000
R0       EQU   0                        REG 0                    S22024 19400022
R1       EQU   1                        REG 1                    S22024 19600022
RMSG     EQU   2                        MESSAGE WORKAREA BASE  @Y17XATI 19700000
RSCB     EQU   3                        ADDRESS OF SCB         @Y17XATI 19800000
RLCB     EQU   4                        ADDRESS OF LCB         @Y17XATI 20000000
R5       EQU   5                        REG 5                    S22024 20400022
RPLCB    EQU   5                        PLCB BASE REGISTER     @Y17XATI 20500000
R6       EQU   6                        REG 6                    S22024 20600022
RPRF     EQU   6                        BASE FOR BUFFER        @Y17XATI 20700000
R7       EQU   7                        ADDRESS OF BUFFER               20800020
RQCB     EQU   7                        BASE FOR QCB           @Y17XATI 20860000
RUCB     EQU   7                        BASE FOR UCB           @Y17XATI 20920000
R8       EQU   8                        ADDRESS OF DATA IN BUFFER       21000020
RTRM     EQU   8                        BASE FOR TRM           @Y17XATI 21060000
RINDEX   EQU   9                        RESOURCE TNT INDEX     @Y17XATI 21120000
R9       EQU   9                        LENGTH OF UNIT                  21200020
R10      EQU   10                       LENGTH OF DATA IN UNIT          21400020
RDCB     EQU   10                       BASE FOR DCB           @Y17XATI 21460000
RDEB     EQU   10                       BASE FOR DEB           @Y17XATI 21520000
R11      EQU   11                       REG 11                   S22024 21600022
R12      EQU   12                       BASE REG                        21800020
R13      EQU   13                       ADDRESS OF AVTSAVE2             22000020
R14      EQU   14                       ADDRESS OF DATA WORK AREA       22200020
R15      EQU   15                       BRANCH REG                      22400020
         SPACE 3                                                        22500000
         USING IEDQMSGD,RMSG            BASE FOR MSG WORKAREA  @Y17XATI 22600000
         USING IEDQSCB,RSCB             BASE FOR SCB           @Y17XATI 22700000
         USING IEDQLCB,RLCB             BASE FOR LCB           @Y17XATI 22800000
         USING IEDQPRF,RPRF             BASE FOR BUFFER        @Y17XATI 22900000
         USING IEDQQCB,RQCB             BASE FOR QCB           @Y17XATI 23000000
         USING IEDNTRM,RTRM             BASE FOR TRM           @Y17XATI 23100000
         USING IHADCB,RDCB              BASE FOR DCB           @YM07042 23200000
         USING IEDQDISP,R11             DISPATCHER BASE          S22024 23300022
         USING *,R12                    BASE                            23400020
         USING AVTSAVE2,R13             BASE FOR AVT                    23600020
         USING IEDNSVTD,R14             BASE FOR SAVT          @Y17XATI 23700000
         EJECT                                                 @Y17XATI 23860000
IEDQNX   IEDHJN QNX00                                            S22026 24100022
         SPACE 1                                                        24300000
*        BUILD THE ERROR MESSAGE IN A WORK AREA.                        24700000
*        GET THE ERROR INFORMATION FROM THE LCB.                        25100000
         SPACE 1                                                        25600000
         LA    RLCB,0(RLCB)             CLEAR FOR COMPARE      @Y17XATI 26100000
         LA    RMSG,AVTSAVE4            MESSAGE WORKAREA       @Y17XATI 26500000
         SR    R1,R1                    CLEAR WORK REGISTER    @Y17XATI 27000000
         STH   R1,AVTDOUBL              CLEAR HALFWORD         @OX19662 27000582
         ICM   R1,HALF,AVTOPCIN         TNT INDEX OF PRIMARY   @OX19662 27000682
         BZ    SYSCON                   BR IF PRIMARY=SYSCON   @Y17XATI 27001082
         C     RLCB,SAVTSLCB            IS THIS SSCP'S PLCB?   @OX19662 27001182
         BNE   NOTSSCP                  BRANCH IF NO           @OX19662 27001282
         CLM   R1,HALF,LCBLNENT         WAS ERROR ON PRIMARY LU@OX19662 27001382
         BE    SYSCON                   BRIF YES MSG TO SYSCON @OX19662 27001482
NOTSSCP  EQU   *                                               @OX19662 27001582
         L     R15,AVTRNMPT             GET IEDQTNT BASE       @Y17XATI 27001682
         BALR  R14,R15                  GET TRM OF PRIMARY     @Y17XATI 27002082
         LR    RTRM,R1                  COPY TRM TO TRM BASE   @Y17XATI 27002182
         SH    RTRM,TRMBCKUP            ASSUME NEGATIVE PREFIX @Y17XATI 27002282
         TM    TRMSTATE,TRMPREF         PRIMARY A 3705 TERM    @Y17XATI 27002382
         BNO   NOT3705                  BR NO, ADD IDLES       @Y17XATI 27002482
         CLI   TRMTYPE,TRMLUNT          PRIMARY AN LU          @Y17XATI 27002582
         BNE   NOT3705                  BRIF NO, USE PREFIX    @OX19662 27002682
PRITRMPU EQU   *                                               @OX19662 27002782
         SR    R10,R10                  CLEAR REGISTER         @OX19662 27002882
         ICM   R10,3,TRMCOHRT           COHORT POINTER OF PRI  @OX19662 27002982
         BNZ   CHRTOK                   BRIF IF ONE THERE      @OX19662 27003082
         TM    TRMBYTE0,TRMDIAL         THIS SHOULD BE DIAL    @OX19662 27003182
         BZ    GETTRM                   BR ERROR NOT DIAL      @OX19662 27003282
         L     R8,TRMDESTQ-1            DEST QCB ADDRESS       @OX19662 27003382
         L     R15,AVTRNMPT             IEDQTNT BASE ADDRESS   @OX19662 27003482
         LH    R10,TNTLEN-IEDQTNTD(,R15) HIGHEST TTCIN         @OX19662 27003582
AGAIN    EQU   *                                               @OX19662 27003682
         LR    R1,R10                   COPY INTO PARM REG     @OX19662 27003782
         BALR  R14,R15                  CALC TERM ENTRY        @OX19662 27003882
         TM    TRMSTATE-IEDQTRM(R1),TRMLINE LINE?              @OX19662 27003982
         BNO   BCT                      BRANCH NO              @OX19662 27004082
         L     R1,TRMDESTQ-1-IEDQTRM(R1) GET QCB ADDRESS       @OX19662 27004182
         CLC   QCBRELLN-IEDQQCB(4,R1),QCBRELLN-IEDQQCB(R8)     @OX19662 27004282
*                                       DO LGB AND RLN MATCH?  @OX19662 27004382
         BNE   BCT                      BRANCH NO              @OX19662 27004482
         LR    R1,R0                    COPY TTE ADDRESS       @OX19662 27004582
         B     GOTIT                    WE HAVE RIGHT ENTRY    @OX19662 27004682
BCT      EQU   *                                               @OX19662 27004782
         BCT   R10,AGAIN                LOOP BACK              @OX19662 27004882
         B     GETTRM                   NEVER FOUND LINE       @OX19662 27004982
CHRTOK   EQU   *                                               @OX19662 27005082
         LR    R1,R10                   COPY COHORT POINTER    @OX19662 27005182
         L     R15,AVTRNMPT             GET TNT CODE ADDRESS   @OX19662 27005282
         BALR  R14,R15                  GET TERM ENTRY FOR CHRT@OX19662 27005382
GOTIT    EQU   *                                               @OX19662 27005482
         LR    R8,R1                    COPY TTE ADDRESS       @OX19662 27005582
         LA    R14,TRMPRFSZ             LENGTH OF NEG PREFIX   @OX19662 27005682
         SR    R8,R14                   AND BACK UP            @OX19662 27005782
         TM    TRMSTATE,TRMPREF         3705 TERM?             @OX19662 27005882
         BZ    GETTRM                   BRIF NO- PUNT NOT FOUND@OX19662 27005982
         CLI   TRMTYPE,TRMPUNT          IS THIS PUNT?          @OX19662 27006082
         BNE   PRITRMPU                 NO- LOOP BACK AGAIN    @OX19662 27006182
         STH   R10,AVTDOUBL             KEEP FOR FUTURE REF    @OX19662 27006282
         B     SYSCON                   PRIMARY'S PU HAD ERROR @OX19662 27006382
         SPACE                                                          27006482
NOT3705  EQU   *                                               @Y17XATI 27006582
         MVC   MSGPREF(L'IDLES),IDLES   SET CARRIAGE RETURN    @Y17XATI 27006682
*                                       AND FIFTEEN IDLES      @Y17XATI 27007000
         LA    RMSG,L'IDLES(RMSG)       ADJUST PAST PREFIX     @Y17XATI 27007500
         B     GETTRM                   BR TO GET TRM          @Y17XATI 27008000
         SPACE 1                                               @Y17XATI 27008500
SYSCON   EQU   *                                               @Y17XATI 27009000
         MVC   MSGWTOFL,WTOMCS          SET MCS FLAGS          @Y17XATI 27009500
         LA    RMSG,MSGWTO              ADJUST PAST WTO PREFIX @Y17XATI 27010000
         SPACE 1                                               @Y17XATI 27010500
GETTRM   EQU   *                                               @Y17XATI 27011000
         SR    R1,R1                    CLEAR FOR INSERT       @Y17XATI 27011500
         ICM   R1,HALF,LCBTTCIN         GET RESOURCE TNT INDEX @Y17XATI 27012000
         TM    AVTSAVTF,AVTVTMCP        NCP ENVIRONMENT        @YM07997 27012100
         BNO   GOTTCIN                  BR NO                  @YM07997 27012200
         L     R14,AVTSAVTP             GET SAVT BASE ADDRESS  @Y17XATI 27012500
         C     RLCB,SAVTSLCB            SSCP'S LCB             @Y17XATI 27013000
         BNE   GOTTCIN                  BR NO, INDEX CORRECT   @Y17XATI 27013500
         NC    LCBLNENT(2),LCBLNENT     3705 RESOURCE ERROR    @YM06008 27014000
         BZ    GOTTCIN                  BR NO, INDEX CORRECT   @Y17XATI 27014500
         ICM   R1,HALF,LCBLNENT         GET RESOURCE INDEX     @Y17XATI 27015000
GOTTCIN  EQU   *                                               @Y17XATI 27015500
         LR    RINDEX,R1                SAVE RESOURCE INDEX    @Y17XATI 27016000
         L     R15,AVTRNMPT             GET IEDQTNT BASE       @Y17XATI 27016500
         BALR  R14,R15                  GET RESOURCE TRM       @Y17XATI 27017000
         LR    RTRM,R1                  COPY TRM TO TRM BASE   @Y17XATI 27017500
         SH    RTRM,TRMBCKUP            ASSUME NEGATIVE PREFIX @Y17XATI 27018000
         CLI   LCBFLAG1,AVTEZERO        IS IT A 3705 PLCB        S22024 27020022
         BE    CHKPLCB                  YES, BRANCH            @Y17XATI 27030000
         SPACE 1                                               @Y17XATI 27040000
BLD000I  EQU   *                                               @Y17XATI 27100000
         SR    RPLCB,RPLCB              INDICATE NOT 3705 TERM @Y17XATI 27180000
         MVC   MSGPREF(L'IEA000I),IEA000I SET MESSAGE PREFIX   @Y17XATI 27181000
         LA    RMSG,L'IEA000I-1(RMSG)   ADJUST PAST PREFIX     @Y17XATI 27182000
         B     COMMAS                   BR TO FINISH MESSAGE   @Y17XATI 27183000
         SPACE 1                                               @Y17XATI 27184000
CHKPLCB  EQU   *                                               @Y17XATI 27185000
         MVC   LCBCSWST,LCBCSWRC        SET ERROR STATUS       @YM08042 27185500
         LR    R1,RINDEX                GET SOURCE TNT INDEX   @Y17XATI 27186000
         L     R14,AVTSAVTP             GET SAVT BASE ADDRESS  @Y17XATI 27187000
         L     R15,SAVTTNTX             IEDIAP04 BASE ADDRESS  @Y17XATI 27188000
         BALR  R14,R15                  GET NETWORK ADDRESS    @Y17XATI 27189000
         SPACE 1                                               @Y17XATI 27190000
         LR    R1,R15                   COPY NETWORK ADDRESS   @Y17XATI 27191000
*                                       AS PARM TO IEDIAP06    @Y17XATI 27192000
         L     R14,AVTSAVTP             GET SAVT BASE ADDRESS  @Y17XATI 27193000
         L     R15,SAVTLCBS             IEDIAP06 BASE REGISTER @Y17XATI 27194000
         BALR  R14,R15                  GET 3705 LCB ADDRESS   @Y17XATI 27195000
         SPACE 1                                               @Y17XATI 27196000
         LR    RPLCB,RLCB               COPY PLCB ADDRESS      @Y17XATI 27197000
         LA    RLCB,0(R15)              COPY TRUE LCB ADDRESS  @Y17XATI 27198000
         L     R14,AVTSAVTP             GET SAVT BASE ADDRESS  @Y17XATI 27199000
         C     RPLCB,SAVTSLCB           PLCB OF THE SSCP       @Y17XATI 27200000
         BNE   BLD162I                  BR NO, BUILD IED162I   @Y17XATI 27201000
         SPACE 1                                               @Y17XATI 27202000
         CLI   LCBQNXMN,AVTEZERO        INOP FROM TCAM PU      @Y17XATI 27203000
         BNE   CHKINOP                  BR YES, DETERMINE      @Y17XATI 27204000
*                                       WHICH MSG TO BUILD     @Y17XATI 27205000
         SPACE 1                                               @Y17XATI 27206000
         CLI   TRMTYPE,TRMLNCP          RESOURCE A 3705        @Y17XATI 27207000
         BE    TYPCMD                   BR YES, SEPARATE TYPE  @YM07042 27208000
         SPACE 1                                               @Y17XATI 27209000
         CLC   RLTD,LCBNXCMD-IEDQLCB(RPLCB) LINE TRACE ENDED   @Y17XATI 27210000
         BNE   BLD509I                  BR NO, BUILD IED509I   @Y17XATI 27211000
         SPACE 1                                               @Y17XATI 27212000
BLD403I  EQU   *                                               @YM06033 27213000
         ICM   R1,HALF,LCBTTCIN         GET 3705 TNT INDEX     @Y17XATI 27214000
         L     R15,AVTRNMPT             IEDQTNT BASE ADDRESS   @Y17XATI 27215000
         BALR  R14,R15                  GET 3705 TRM ADDRESS   @Y17XATI 27216000
         SPACE 1                                               @Y17XATI 27217000
         LA    R0,TRMNCPI               SELECT NCP DEVICE      @Y17XATI 27218000
*                                       DEPENDENT FIELD        @Y17XATI 27219000
         L     R15,AVTDDFT              IEDQTL BASE ADDRESS    @Y17XATI 27220000
         BALR  R14,R15                  GET NCPID              @Y17XATI 27221000
         SPACE 1                                               @Y17XATI 27222000
         USING IEDNCP,R15               ADDRESSIBILITY         @Y17XATI 27223000
         ICM   R15,ALL,NCPLTRAC         GET TRACE TABLE ADDR   @Y17XATI 27224000
         DROP  R15                                             @Y17XATI 27225000
         USING HEDCNTRL,R15             ADDRESSIBILITY         @Y17XATI 27226000
         ICM   R15,AD,HEDFSTHF          GET TABLE FIRST HALF   @Y17XATI 27227000
         DROP  R15                                             @Y17XATI 27228000
         USING TABHALF,R15              ADDRESSIBILITY         @Y17XATI 27229000
         MVC   MSGPREF(L'IED403I),IED403I SET MESSAGE PREFIX   @YM06033 27230000
         MVC   MSG403I(L'TABLINUM),TABLINUM INCLUDE GROUPNAME  @YM06033 27231000
*                                       AND RELATIVE LINE NO   @Y17XATI 27232000
         DROP  R15                                             @Y17XATI 27233000
         LA    RMSG,L'IED403I(RMSG)     POINT TO END OF        @OY20726 27234082
*                                       MESSAGE                @Y17XATI 27235000
         B     CHECKWTO                 BR SET TO OUTPUT MSG   @Y17XATI 27236000
         SPACE 1                                               @Y17XATI 27237000
CHKINOP  EQU   *                                               @Y17XATI 27238000
         TM    LCBQNXMN,LCBNX064        CONTROL UNIT NOT       @Y17XATI 27239000
*                                       OPERATIONAL            @Y17XATI 27240000
         BO    BLD064I                  BR YES, BUILD IED064I  @Y17XATI 27241000
         SPACE 1                                               @Y17XATI 27242000
         TM    LCBQNXMN,LCBNX142        IPL REQUIRED           @Y17XATI 27243000
         BO    BLD142I                  BR YES, BUILD IED142I  @OX21816 27244082
         SPACE 1                                               @Y17XATI 27245000
         B     BLD162I                  ELSE BUILD IED162I     @Y17XATI 27247000
         SPACE 1                                               @Y17XATI 27248000
BLD064I  EQU   *                                               @Y17XATI 27249000
         SR    R1,R1                   CLEAR FOR TEST          @XM05822 27251000
         CH    R1,AVTOPCON             IS PRIMARY SYSCON       @XM05822 27253000
         BE    DONTWTO                 DONT PRINT AGAIN        @XM05846 27255000
         MVC   MSGPREF(L'IED064I),IED064I SET MESSAGE PREFIX   @Y17XATI 27255100
         ICM   R1,AD,LCBUNADD           GET ADDRESS OF CUA     @Y17XATI 27255200
         MVC   MSG064I(L'UCBNAME),0(R1) INSERT CUA             @Y17XATI 27255300
         LA    RMSG,L'IED064I(RMSG)     POINT TO END OF MSG    @Y17XATI 27255400
         B     CHECKWTO                 BR SET TO OUTPUT MSG   @Y17XATI 27255500
DONTWTO  EQU   *                                               @XM05846 27256000
         LR    RLCB,RPLCB               RESTORE LCB ADDRESS    @XM05846 27266000
         B     BYWTO                    BYPASS WTO             @XM05846 27266500
         SPACE 1                                               @Y17XATI 27267000
BLD142I  EQU   *                                               @OX21816 27267582
         MVC   MSGPREF(L'IED142I),IED142I SET MESSAGE PREFIX   @OX21816 27267882
         ICM   R1,AD,LCBUNADD           GET ADDRESS OF CUA     @Y17XATI 27268500
         MVC   MSG142I(L'UCBNAME),0(R1) INSERT CUA             @OX21816 27269082
         LA    RMSG,L'IED142I(RMSG)     POINT TO END OF MSG    @OX21816 27269382
         B     CHECKWTO                 BR SET TO OUTPUT MSG   @Y17XATI 27270000
         SPACE 1                                               @Y17XATI 27270500
BLD162I  EQU   *                                               @Y17XATI 27271000
         MVC   MSGPREF(L'IED162I),IED162I SET MESSAGE PREFIX   @Y17XATI 27276000
         LA    RMSG,L'IED162I-1(RMSG)   ADJUST PAST PREFIX     @Y17XATI 27281000
         SPACE 1                                               @Y17XATI 27286000
COMMAS   EQU   *                                               @Y17XATI 27291000
         MVC   MSGCOMA1+1(19),MSGCOMA1  FILL IN COMMAS                  27400020
         LA    RMSG,1(RMSG)             POINT PAST COMMA       @Y17XATI 27460000
         BAL   R14,SETCUA               SET CUA IN MSG AND RTN @YM07042 27520000
         L     RDCB,LCBDCBPT            DCB BASE               @Y17XATI 28800000
         TM    DCBDSRG2,DCBDSGTR        IS THIS A 3705 DCB     @Y17XATI 29440000
         BNO   QNX02                    BRANCH NO                S22024 29480022
         SPACE 1                                               @Y17XATI 29482000
         LTR   RPLCB,RPLCB              3705 RESOURCE          @YM06937 29484000
         BZ    QNX02                    BR NO, HAVE LCB        @YM06937 29486000
         SPACE 1                                               @Y17XATI 29494000
         CLI   TRMTYPE,TRMLNCP          IS IT THE 3705         @YM06937 29494700
         BE    QNX02                    BR YES, HAVE LCB       @YM06937 29495400
         SPACE 1                                               @Y17XATI 29496100
         LR    RLCB,RPLCB               GET PLCB BASE          @Y17XATI 29497000
         SPACE 1                                               @Y17XATI 29500000
QNX02    EQU   *                                                 S22024 29520022
         LTR   RPLCB,RPLCB              ENTERED WITH PLCB      @OX14080 29523000
         BNZ   IS3705                   YES-CONTINUE           @OX14080 29526000
         SR    R8,R8                    CLEAR REGISTER         @OX16393 29529000
         SR    R14,R14                  CLEAR REGISTER         @OX16393 29532000
         L     R1,DCBDEBAD              DEB ADDRESS            @OX16393 29541000
         USING DEBTCBAD,R1              BASE FOR DEB           @OX16393 29550000
         IC    R8,DEBNMEXT              NUMBER OF EXTENTS      @OX16393 29562000
         SLL   R8,TWO                   SIZE OF UCB ADDRESSES  @OX16393 29571000
         L     R8,DEBUCBAD(R8)          THRESHOLD AREA         @OX16393 29580000
         IC    R14,LCBUCBX              RLN MINUS ONE          @OX16393 29592000
         SLL   R14,THREE                MULT BY NO OF BYTES    @OX16393 29601000
         AR    R8,R14                   BUMP TO SAVE OFFSET    @OX16393 29610000
         SRL   R14,1                    HALF AGAIN FOR ERRMSG  @OZ24288 29622000
         AR    R8,R14                   SAVED INFORMATION      @OZ24288 29625000
         USING LCBEXTX,R8               ADDRESSABILITY         @OX16393 29628000
         MVC   LCBSENS0,IEASENS0        RESTORE SENSE INFO     @OZ24288 29631000
         MVC   LCBRESTR+2(L2),IEADVCHS  RESTORE DEV CHARS      @OX16393 29640000
         MVC   LCBRESTR(L1),IEACMD      RESTORE COMMAND CODE   @OZ24288 29652000
         MVC   LCBCSW+3(2),IEACSW       RESTORE CSW            @OZ24288 29661000
         MVC   LCBFLAG2(1),IEALTPCD     RESTORE LAST TP OP CDE @OX16393 29670000
         MVC   LCBSENS1(1),IEAFTPCD     RESTORE FIRST TP CODE  @OX16393 29682000
IS3705   EQU   *                                               @OX14080 29769000
         USING IEDNTRM,RTRM                                    @OX14080 29775000
         SR    R8,R8                    CLEAR                      0802 29800020
         IC    R8,LCBRESTR              COMMAND CODE-FAILING CCW   0730 29900000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 30000000
         SPACE 1                                                        30400000
         IC    R8,LCBCSWUS              STAT BYTE OF CSW                30600000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 30800000
         SPACE 1                                               @Y17XATI 31200000
         BCTR  RMSG,0                   PREVENT SKIP OF COMMA  @Y17XATI 31280000
         IC    R8,LCBCSWCS              2ND STAT BYTE IN CSW            31360000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 31400000
         SPACE 1                                               @Y17XATI 31800000
         CLI   LCBFLAG1,AVTEZERO        IS IT 3705 PLCB?       @YA07494 31940057
         BE    NOSENSE                  BR YES, ZERO SENSE     @Y17XATI 31950000
         SPACE 1                                                        31960000
         IC    R8,LCBSENS0              SENSE BYTE IN IOB               32200020
         B     QNX025                   CONTINUE               @YA07494 32400000
         SPACE 1                                               @Y17XATI 32650000
NOSENSE  EQU   *                                               @Y17XATI 32651000
         SR    R8,R8                    USE SENSE OF ZERO      @Y17XATI 32652000
         SPACE 1                                               @Y17XATI 32653000
QNX025   EQU   *                                               @Y17XATI 32654000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32655000
         SPACE 1                                               @Y17XATI 32656000
         BCTR  RMSG,0                   PREVENT SKIP OF COMMA  @Y17XATI 32657000
         SR    R8,R8                    SECOND SENSE BYTE OF 0 @Y17XATI 32658000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32659000
         SPACE 1                                               @Y17XATI 32660000
         LTR   RPLCB,RPLCB              ENTRY WITH PLCB        @Y17XATI 32661000
         BZ    NOPLCB                   BR NO, CONTINUE        @Y17XATI 32662000
         SPACE 1                                               @Y17XATI 32663000
         LA    RMSG,NEXT(RMSG)          POINT TO NEXT POSITION @Y17XATI 32664000
         B     QNX002                   GO INSERT RESOURCENAME @Y17XATI 32665000
         SPACE 1                                                        32666000
NOPLCB   EQU   *                                               @Y17XATI 32667000
         IC    R8,LCBFLAG2              TP OP CODE OF LAST RETRY   0725 32668000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32669000
         SPACE 1                                               @Y17XATI 32670000
         BCTR  RMSG,0                   PREVENT SKIP OF COMMA  @Y17XATI 32671000
         IC    R8,LCBSENS1              TP OP CODE OF FAILING CCW  0730 32672000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32673000
         SPACE 1                                                        32674000
         BCTR  RMSG,0                   PREVENT SKIP OF COMMA  @Y17XATI 32675000
         IC    R8,LCBRESTR+2            ADDR CHAR,POLL CHAR OR @OX16393 32676000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32677000
         SPACE 1                                               @Y17XATI 32678000
         BCTR  RMSG,0                   PREVENT SKIP OF COMMA  @Y17XATI 32679000
         IC    R8,LCBRESTR+3            SECOND CHARACTER       @OX16393 32680000
         BAL   R14,QNX80                CONVERT TO EBCDIC      @Y17XATI 32681000
         SPACE 1                                               @Y17XATI 32682000
         SR    R1,R1                    CLEAR REG              @OY11534 32683000
         STH   R1,LCBTTBIN              CLEAR TERM INDEX       @OY11534 32684000
         B     QNX04                    WRITE OUT ERROR MSG    @Y17XATI 32685000
TYPCMD   EQU   *                                               @YM07042 32685100
*                                       ENTERING SLOWDOWN      @YM07994 32685200
         CLC   LCBNXCMD-IEDQLCB(L'LCBNXCMD,RPLCB),ENTSLO       @YM07994 32685300
         BE    BLD412                   YES, BUILD IED411I     @YM07042 32685400
*                                       EXITING SLOWDOWN       @YM07994 32685500
         CLC   LCBNXCMD-IEDQLCB(L'LCBNXCMD,RPLCB),EXTSLO       @YM07994 32685600
         BE    BLD412                   YES, BUILD IED412      @YM07042 32685700
         SPACE 1                                               @Y17XATI 32686000
BLD509A  EQU   *                                               @Y17XATI 32687000
         MVC   MSGPREF(L'IED509I),IED509I SET MESSAGE PREFIX   @Y17XATI 32688000
         MVC   MSG509I(L'MSGANS),MSGANS INSERT ANS CHARS       @Y17XATI 32689000
         LA    RMSG,L'IED509I(RMSG)     POINT TO END OF MSG    @Y17XATI 32690000
         B     QNX002                   BR TO INSERT TERMNAME  @Y17XATI 32690200
         SPACE 1                                               @Y17XATI 32690400
BLD412   EQU   *                                               @YM07042 32690600
         MVC   MSGPREF(L'IED412I),IED412I ASSUME IED412I MSG   @YM07042 32690800
*                                       EXITING SLOWDOWN       @YM07994 32690900
         CLC   LCBNXCMD-IEDQLCB(L'LCBNXCMD,RPLCB),EXTSLO       @YM07994 32691000
         BE    BLD412A                  YES, NO MODIFY         @YM07042 32691200
         MVC   MSG41EXT(L'MSGENT),MSGENT  MODIFY FOR ENTERING  @YM07042 32691400
         MVI   MSG11,IED411I            MODIFY MSG ID          @YM07042 32691600
BLD412A  EQU   *                                               @YM07042 32691800
         LA    RMSG,MSG41               POINT TO CUA POSITION  @YM07042 32692000
         BAL   R14,SETCUA               GO INSERT CUA          @YM07042 32692200
         LA    RMSG,MSG41END-MSG41-L'UCBNAME(RMSG) ADJUST TO   @YM07042 32692400
*                                       LAST POSITION OF MSG   @YM07042 32692600
         B     CHECKWTO                                        @YM07042 32692800
BLD509I  EQU   *                                               @Y17XATI 32693000
         MVC   MSGPREF(L'IED509I),IED509I SET MESSAGE PREFIX   @Y17XATI 32694000
         MVC   MSG509I(L'MSGINOP),MSGINOP INSERT INOP CHARS    @Y17XATI 32695000
         LA    RMSG,L'IED509I(RMSG)     POINT TO END OF MSG    @Y17XATI 32696000
         SPACE 1                                                        32698000
QNX002   EQU   *                                               @YA07494 33000057
         L     R15,AVTRNMPT             ADDRESS OF TERMNAME TBL  S22024 33218022
         USING IEDQTNTD,R15             BASE                     S22024 33224022
         LR    R0,RINDEX                SAVE RESOURCE INDEX    @Y17XATI 33227000
         SR    R9,R9                    ZERO REGISTER          @Y17XATI 33230000
         IC    R9,TNTENLEN              GET LENGTH OF AN ENTRY   S22024 33242000
         LA    R7,3(R9)                 LENGTH OF FULL ENTRY   @Y17XATI 33248000
         BCTR  R0,R0                    SUBTRACT ONE             S22024 33266022
         MR    R6,R0                    OFFSET TO TERMNAME     @Y17XATI 33272000
         LA    R7,TNTFIRST(R7)          ADDRESS OF TERMNAME    @Y17XATI 33278000
         BCTR  R9,R0                    SUBTRACT ONE           @Y17XATI 33284000
         EX    R9,MVCNM                 MOVE NAME INTO MESSAGE @Y17XATI 33302000
         LA    RMSG,NEXT(R9,RMSG)       POINT TO END OF MSG    @Y17XATI 33314000
         SPACE 1                                               @Y17XATI 33315000
CHECKWTO EQU   *                                                        33317022
         LR    RLCB,RPLCB               ELSE RECOVER LCB BASE  @Y17XATI 33317700
         SPACE 1                                               @Y17XATI 33318400
SKIPSET  EQU   *                                               @Y17XATI 33319100
         SR    R1,R1                    ZERO FOR COMPARE         S22024 33320022
         CH    R1,AVTOPCON              IS PRIMARY=SYSCON        S22024 33326022
         BE    MSGTOCNS                 BRANCH YES TO WTO      @OX19662 33328082
         C     RLCB,SAVTSLCB            IS THIS SSCP'S PLCB?   @OX19662 33329082
         BNE   QNX04                    BRANCH NO              @OX19662 33330082
         CLC   AVTOPCIN,LCBLNENT        WAS ERR ON PRITRM LU?  @OX19662 33331082
         BE    MSGTOCNS                 YES MSG TO SYSCON      @OX19662 33332082
         CLC   AVTDOUBL(2),AVTFZERO     WAS ERROR ON PRITRM PU?@OX19662 33333082
         BE    QNX04                    BRANCH NO MSG TO PRITRM@OX19662 33334082
MSGTOCNS EQU   *                                               @OX19662 33335082
         SPACE 1                                               @Y17XATI 33339000
         MVC   MSGMCS(L'MCSWORD),MCSWORD MCS CONSTANT          @Y17XATI 33340000
         LR    R1,RMSG                  END OF MESSAGE         @Y17XATI 33341000
         LA    RMSG,AVTSAVE4            ADDR OF WTO MESSAGE    @Y17XATI 33342000
         SR    R1,RMSG                  COMPUTE MESSAGE LENGTH @Y17XATI 33344000
         STH   R1,MSGWTOLN              SET WTO MESSAGE LENGTH @Y17XATI 33356000
         SPACE 1                                               @Y17XATI 33357000
         WTO   MF=(E,(RMSG))            WRITE MESSAGE TO CONSOLE S22024 33358000
BYWTO    EQU   *                                               @XM05822 33362000
         SPACE 1                                               @Y17XATI 33368000
         SR    R5,R5                    FORCE ONLY PLCB TPOST    S22024 33374022
         B     QNX50                    POST BFR                 S22024 33380022
         SPACE 1                                               @Y17XATI 33383000
*        MOVE ERROR MESSAGE FROM WORK AREA TO BUFFER                    33386000
         SPACE 1                                                        36800000
QNX04    EQU   *                                                 S22024 37300022
         SR    R5,R5                    CLEAR ADDR OF 1ST UNIT     0606 37400020
         LA    R0,UNITCNT               COUNT OF UNITS/BUFFER  @Y17XATI 37420000
         LA    R1,BFRCNT                COUNT OF BUFFERS       @Y17XATI 37440000
         L     R15,AVTSTEAL             BUFFER STEAL ROUTINE   @Y17XATI 37460000
         BALR  R14,R15                  ATTEMPT BUFFER STEAL   @Y17XATI 37480000
         SPACE 1                                               @Y17XATI 37500000
         LTR   R15,R15                  BFR STEAL SUCCESSFUL   @Y17XATI 37520000
         BZ    QNX50                    BR NO, ERROR EXIT      @Y17XATI 37540000
         SPACE 1                                               @Y17XATI 37560000
         LR    RPRF,R15                 SET FIRST BUFFER ADDR  @Y17XATI 37580000
         LR    R5,RPRF                  SAVE 1ST UNIT IN BFR   @Y17XATI 37600000
         LR    R7,RMSG                  COPY END OF MSG ADDR   @Y17XATI 37800000
         LA    RMSG,AVTSAVE4            BEGINNING OF MESSAGE   @Y17XATI 37850000
         SR    R7,RMSG                  MESSAGE LENGTH         @Y17XATI 37900000
         LA    R7,AVTHDRSZ(R7)          ADD HEADER SIZE        @Y17XATI 37950000
         XC    PRFSUNIT(PRFSHDR-PRFSUNIT),PRFSUNIT CLEAR PREFIX@Y17XATI 38000000
         ST    RLCB,PRFLCB-1            PUT LCB ADDR IN PREFIX @Y17XATI 38200000
         MVI   PRFNBUNT,UNITCNT         COUNT OF UNITS                  38300000
         STH   R7,PRFSIZE               PUT LENGTH INTO PREFIX @Y17XATI 38400000
         MVI   PRFSTAT1,PRFERMGN        SET AS ERRORMSG TO PREVENT      38820020
*                                       MULTI-ROUTE ON THE ERP          38830000
*                                       MSG AND ALLOW IT ON ORIG        38840000
         MVI   PRFSCAN,AVTHDRSZ         SET SCAN PTR FOR ERROR MSG 0212 38900020
         MVC   PRFTIC,TIC               SET TIC FIELD          @Y17XATI 38920000
         LH    R9,AVTKEYLE              LENGTH OF UNIT                  39200020
         LA    R0,AVTHDRSZ              LENGTH OF PREFIX                39400020
         LR    R10,R9                                                   39600020
         SR    R10,R0                   LENGTH OF DATA IN UNIT          39800020
         SPACE 1                                               @Y17XATI 39920000
         BCTR  R10,0                    SUBTRACT ONE FOR EXEC  @Y17XATI 40000000
         EX    R10,QNXINST1             MOVE MSG                        40400020
         SPACE 1                                                        40500000
*        CHECK LENGTH OF MSG TO SEE IF MULTIPLE UNITS REQUIRED          40600000
         SPACE 1                                                        40700000
QNX10    EQU   *                                               @Y17XATI 40800000
         LA    RMSG,NEXT(R10,RMSG)      BUMP ADDRESS OF MSG    @Y17XATI 41000000
         SH    R7,AVTKEYLE              REMAINING LENGTH       @Y17XATI 41200000
         BNP   QNX20                    BRANCH IF END OF MSG       0603 41600020
         SPACE 1                                               @Y17XATI 41660000
         LR    R9,RPRF                  SAVE PREVIOUS UNIT     @Y17XATI 41720000
         LA    R0,UNITCNT               COUNT OF UNITS/BUFFER  @Y17XATI 41800000
         LA    R1,BFRCNT                COUNT OF BUFFERS       @Y17XATI 41820000
         L     R15,AVTSTEAL             BUFFER STEAL ROUTINE   @Y17XATI 41840000
         BALR  R14,R15                  ATTEMPT BUFFER STEAL   @Y17XATI 41860000
         SPACE 1                                               @Y17XATI 41880000
         LTR   R15,R15                  BFR STEAL SUCCESSFUL   @Y17XATI 41900000
         BZ    QNX50                    BR NO, ERROR EXIT      @Y17XATI 41920000
         SPACE 1                                               @Y17XATI 41940000
         LR    RPRF,R15                 SET FIRST BUFFER ADDR  @Y17XATI 41960000
         IC    R15,PRFNBUNT-IEDQPRF(R5) COUNT OF UNITS IN BFR  @Y17XATI 42000000
         LA    R15,1(,R15)              ADD 1 TO COUNT             0603 43200020
         STC   R15,PRFNBUNT-IEDQPRF(R5)                        @Y17XATI 43300000
         ST    RPRF,PRFTIC-IEDQPRF(R9)  LINK UNITS             @Y17XATI 43400000
         MVC   PRFTIC,TIC               SET TIC FIELD          @Y17XATI 44000000
         LH    R10,AVTKEYLE             DATA LENGTH IN UNIT    @Y17XATI 44050000
         BCTR  R10,0                    DECREMENT FOR EXEC     @Y17XATI 44100000
         EX    R10,QNXINST2             MOVE DATA TO THIS UNIT @Y17XATI 44150000
         B     QNX10                    BR TO CHECK FOR MORE   @Y17XATI 44200000
         SPACE 1                                                        44600000
*        FIND TERMINAL ENTRY ADDRESS AND QCB ADDRESS FOR PRIMARY TERM   44800000
         SPACE 1                                                        45000000
QNX20    EQU   *                                                   0603 45400020
         LR    RPRF,R5                  GET 1ST UNIT IN BUFFER @Y17XATI 45500000
         LH    R1,AVTOPCIN              TNT INDEX OF PRIMARY   @Y17XATI 45600000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF WORD      46000020
         SPACE 1                                               @Y17XATI 46120000
QNX23    EQU   *                                                   1009 48600020
         STH   R1,PRFDEST               PUT OFFSET INTO PREFIX @Y17XATI 48800000
         L     R15,AVTRNMPT                                             49200020
         BALR  R14,R15                  GET TERM ENTRY ADDRESS          49400020
         SPACE 1                                               @Y17XATI 49460000
         LR    RTRM,R1                  BASE FOR TERM ENTRY    @Y17XATI 49520000
         SH    RTRM,TRMBCKUP            GET NEGATIVE PREFIX    @Y17XATI 49600000
         L     RQCB,TRMDESTQ-1          ADDRESS OF QCB         @Y17XATI 49700000
         ST    RQCB,PRFQCBA-1           PUT QCB ADDR IN PRF    @Y17XATI 49800000
         CLI   QCBDSFLG,QCBFQCB         CHECK FOR PUT PROCESS ENTRY1009 50400020
         BNE   QNX25                    BRANCH IF NOT PUT PROCESS  1009 50600020
         SPACE 1                                               @Y17XATI 50660000
         LH    R1,TRMALTD               GET ALTERNATE DEST     @Y17XATI 50720000
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF  @Y17XATI 50800000
         BZ    QNX50                    BRANCH IF NO ALT DESTINATN 1009 51200020
         SPACE 1                                               @Y17XATI 51300000
         B     QNX23                    GET TERM ENTRY FOR ALT DEST1009 51400020
         SPACE 1                                                        51500000
*        SET UP THE SCB-USUALLY DONE BY FORWARD MACRO                   51600000
         SPACE 1                                                        51800000
QNX25    EQU   *                                                   1009 52200020
         IC    R15,SCBSTATE             SAVE STATUS BYTE                52400020
         ST    RQCB,SCBDESTQ-1          PUT QCB ADDRESS IN SCB @Y17XATI 52500000
         STC   R15,SCBSTATE             RESTORE STATUS BYTE             52800020
         MVC   SCBPRI,QCBPRIPQ          MOVE HIGHEST PRIORITY TO SC0730 53200020
         SPACE 1                                                        53300000
*        POST CHAIN OF ELEMENTS TO THE READY QUEUE.                     53400000
         SPACE 1                                                        53600000
QNX30    EQU   *                                                   0606 54000020
         ST    RLCB,PRFLINK-1           LINK LCB TO THIS BFR   @Y17XATI 54100000
         MVI   PRFPRI,PRIDESTQ          SET PRIORITY                    54200000
         LR    R1,RPRF                  GET ADDRESS OF CHAIN   @Y17XATI 54300000
         SPACE 1                                               @Y17XATI 54400000
QNX40    EQU   *                                                        54800020
         XC    LCBLINK,LCBLINK          CLEAR LINK FIELD           0120 54900020
         NI    LCBCHAIN,X'FF'-LCBERMSG  CLEAR ERROR MSG REQUEST BIT     55000020
         BAL   R14,DSPCHAIN       EXIT AND POST CHAIN OF ELEM  @Y17XARX 55400000
         SPACE 1                                                        55500000
*        THERE ARE NO AVAILABLE BUFFERS-RETURN TO BUFFER DISPOSITION    55600000
         SPACE 1                                                        55800000
QNX50    EQU   *                                                        56200020
         LR    R1,RLCB                  ADDR OF LCB IS FIRST   @Y17XATIX56300000
                                        ELEMENT IN CHAIN                56600020
         LTR   RPRF,R5                  CHECK FOR PARTIAL BFR  @Y17XATI 56700000
         BZ    QNX40                    BRANCH IF NO UNITS OUT     0606 57000020
         SPACE 1                                               @Y17XATI 57100000
         LA    R1,AVTBFRTB              ADDR OF BFR RETURN QCB     0606 57200020
         ST    R1,PRFQCBA-1             STORE IN 1ST UNIT OF BFR   0606 57400020
         B     QNX30                    POST BFR BACK TO BFR DISPOS0606 57600020
         EJECT                                                 @Y17XATI 57700000
*        SUBROUTINE TO CONVERT HEX TO PRINTABLE HEX                     58000000
         SPACE 1                                                        60800000
QNX80    EQU   *                                                        61200020
         LA    RMSG,NEXT(RMSG)          SKIP ONE COMMA         @Y17XATI 61300000
         LR    R10,R8                   COPY THE 1 BYTE OF HEX          61400020
         SRL   R10,4                    SHIFT OUT RIGHT HAND HALF       61600020
         N     R8,QNXMASK3              MASK OUT FIRST BYTE    @Y17XATI 61700000
         CH    R10,QNXNINE              CHECK FOR ALPHABETIC            62200020
         BH    QNX85                    BRANCH IF ALPHABETIC            62400020
         SPACE 1                                               @Y17XATI 62460000
         O     R10,QNXMASK1             PRINTABLE NUMERIC               62600020
         B     QNX90                    GO STORE BYTE            S22025 62800022
         SPACE 1                                               @Y17XATI 62900000
QNX85    EQU   *                                                        63000020
         SH    R10,QNXNINE                                              63200020
         O     R10,QNXMASK2             PRINTABLE ALPHABETIC            63400020
         SPACE 1                                               @Y17XATI 63500000
QNX90    EQU   *                                                        63600020
         STC   R10,0(RMSG)              STORE CONVERTED BYTE   @Y17XATI 63700000
         LA    RMSG,NEXT(RMSG)          GET NEXT BYTE          @Y17XATI 63800000
         CH    R8,QNXNINE               CHECK FOR ALPHABETIC   @Y17XATI 64400000
         BH    QNX95                    BRANCH IF ALPHABETIC   @Y17XATI 64410000
         SPACE 1                                               @Y17XATI 64420000
         O     R8,QNXMASK1              PRINTABLE NUMERIC      @Y17XATI 64430000
         B     QNX100                   GO STORE BYTE          @Y17XATI 64440000
         SPACE 1                                               @Y17XATI 64450000
QNX95    EQU   *                                               @Y17XATI 64460000
         SH    R8,QNXNINE                                      @Y17XATI 64470000
         O     R8,QNXMASK2              PRINTABLE ALPHABETIC   @Y17XATI 64480000
         SPACE 1                                               @Y17XATI 64490000
QNX100   EQU   *                                               @Y17XATI 64500000
         STC   R8,0(RMSG)               STORE CONVERTED BYTE   @Y17XATI 64510000
         LA    RMSG,NEXT(RMSG)          POINT PAST INSERT      @Y17XATI 64520000
         BR    R14                      RETURN TO INLINE       @Y17XATI 64530000
         SPACE 1                                                        64530700
SETCUA   EQU   *                                               @YM07042 64531400
         SR    R7,R7                                           @Y17XATI 64532100
         IC    R7,LCBUCBX               GET UCB INDEX          @Y17XATI 64532800
         SLL   R7,2                     MULTIPLY BY 4          @Y17XATI 64533500
         L     RDCB,LCBDCBPT            ADDRESS OF LINE DCB    @Y17XATI 64534200
         L     RDEB,DCBDEBAD            ADDRESS OF DEB         @Y17XATI 64534900
         USING DEBTCBAD,RDEB            BASE FOR DEB           @YM06937 64535600
         L     RUCB,DEBUCBAD(R7)        ADDRESS OF UCB         @YM06937 64536300
         USING IEDQUCB,RUCB             BASE FOR UCB           @Y17XATI 64537000
         MVC   MSGLINE(L'UCBNAME),UCBNAME MOVE CUA TO MESSAGE  @Y17XATI 64537700
         LA    RMSG,L'UCBNAME(RMSG)     POINT TO NEXT POSITION @Y17XATI 64538400
         BR    R14                      RETURN                 @YM07042 64539100
         EJECT                                                 @Y17XATI 64540000
MVCNM    MVC   0(1,RMSG),0(R7)          OBJECT OF EXECUTE      @Y17XATI 64570000
QNXINST1 MVC   PRFSHDR(0),0(RMSG)       BUFFER WORK AREA       @Y17XATI 65070000
QNXINST2 MVC   PRFSUNIT(0),0(RMSG)      BUFFER WORK AREA       @Y17XATI 65600000
QNXNINE  DC    H'9'                     CONSTANT                        65800020
         DS    0F                       FORCE BOUNDARY ALIGNMENT S22025 65900022
QNXMASK1 DC    X'000000F0'              MASK FOR PRINTABLE       S22025 66000022
*                                       NUMERIC CHARACTER        S22025 66100022
QNXMASK2 DC    X'000000C0'              MASK FOR PRINTABLE       S22025 66200022
*                                       ALPHABETIC CHARACTER     S22025 66300022
QNXMASK3 DC    X'0000000F'              MASK TO CLEAR ALL BUT    S22025 66400022
*                                       RIGHT HALF OF LOW ORDER  S22025 66500022
*                                       BYTE                     S22025 66600022
L1       EQU   1                        LENGTH OF ONE          @OX14080 66600900
L2       EQU   2                        LENGTH OF TWO          @OX14080 66601800
L3       EQU   3                        LENGTH OF THREE        @OX14080 66602700
L4       EQU   4                        LENGTH OF FOUR         @OX14080 66603600
DIALDIG  EQU   17                       DIAL DIGIT SHIFT OFFSET@OX14080 66604500
LTPOP    EQU   8                        OFFSET TO LAST TP OP   @OX14080 66605400
FTPOP    EQU   9                        OFFSET TO FIRST TP OP  @OX14080 66606300
L7       EQU   7                        LENGTH OF SEVEN        @OX14080 66607200
FIVE     EQU   5                        LENGTH OF FIVE         @OX14080 66608100
SIX      EQU   6                        CONSTANT               @OX14080 66609000
UNITCNT  EQU   1                        UNITS/BUFFER REQUEST   @Y17XATI 66610000
BFRCNT   EQU   1                        BUFFER REQUEST COUNT   @Y17XATI 66620000
NEXT     EQU   1                        NEXT DATA POSITION     @Y17XATI 66630000
HALF     EQU   3                        MASK FOR ICM OF HLFWRD @Y17XATI 66640000
AD       EQU   7                        MASK FOR ICM OF ADDRESS@Y17XATI 66650000
ALL      EQU   15                       MASK FOR ICM OF WORD   @Y17XATI 66660000
TWO      EQU   2                                               @OX16393 66710000
THREE    EQU   3                                               @OX16393 66760000
TIC      DC    X'08000002'              TIC CCW                  S22026 67700022
MCSWORD  DC    X'10000100'              MCS DESCR & ROUTING    @OS77924 67750000
         DC    X'10'                    EVENTUAL ACTION REQ'ED @OS77924 67750600
         DC    X'00'                                           @Y17XATI 67751200
*                                       ROUTING CODES          @Y17XATI 67751800
         DC    X'01'                    MASTER CONSOLE INFO    @OS77924 67752400
         DC    X'00'                                           @Y17XATI 67753000
WTOMCS   DS    0XL2                     MCS FLAGS              @Y17XATI 67753600
         DC    X'80'                                           @Y17XATI 67754200
         DC    X'00'                                           @Y17XATI 67754800
RLTD     DS    0XL3                     RECORD LINE TRACE CMD  @Y17XATI 67755400
         DC    AL1(CD1NETS)             NETWORK SERVICES       @Y17XATI 67756000
         DC    AL1(CD1MAINT)            PHYSICAL MAINTENANCE   @Y17XATI 67756600
         DC    AL1(CD1RTRD)             RECORD TRACE DATA      @Y17XATI 67757200
ENTSLO   DS    0XL3                     ENTER SLOWDOWN COMMAND @YM07042 67757400
         DC    AL1(CD1NETS)             NETWORK SERVICES       @YM07042 67757600
         DC    AL1(CD1CONFS)            CONFIGURATION SERVICES @YM07042 67757800
         DC    AL1(CD1ESLOW)            ENTER SLOWDOWN         @YM07042 67758000
EXTSLO   DS    0XL3                     EXIT SLOWDOWN COMMAND  @YM07042 67758200
         DC    AL1(CD1NETS)             NETWORK SERVICES       @YM07042 67758400
         DC    AL1(CD1CONFS)            CONFIGURATION SERVICES @YM07042 67758600
         DC    AL1(CD1EXSLW)            EXIT SLOWDOWN          @YM07042 67758800
TRMBCKUP DS    0H                       TRM PREFIX SIZE        @Y17XATI 67759000
         DC    AL2(IEDQTRM-IEDNTRM)                            @Y17XATI 67759200
         EJECT                                                 @Y17XATI 67759400
IDLES    DS    0XL16                                           @Y17XATI 67759600
         DC    X'15'                    CARRIAGE RETURN AND    @Y17XATI 67760200
         DC    15X'32'                  FIFTEEN IDLES          @Y17XATI 67760800
IEA000I  DC    CL18'IEA000I I/O ERROR,' IEA000I PREFIX         @Y17XATI 67761400
IED064I  DC    CL45'IED064I LINE --- CONTROL UNIT NOT OPERATIONAL'      67762000
IED142I  DC    CL33'IED142I --- IPL REQUIRED FOR 3705'         @OX21816 67762682
IED162I  DC    CL23'IED162I 3705 I/O ERROR,' IED162I PREFIX    @Y17XATI 67763600
IED403I  DC    CL47'IED403I LINE TRACE FOR ------------ DEACTIVATED'    67764100
IED412I  DC    CL34'IED412I 3705 --- EXITING  SLOWDOWN'        @YM07042 67764200
*                                       IED411I/IED412I MSGS   @YM07042 67764300
IED509I  DC    CL26'IED509I ---- RECEIVED FOR ' IED509I PREFIX @Y17XATI 67764600
         SPACE 3                                               @Y17XATI 67765600
MSGANS   DC    CL4'ANS'                 INSERT TO IED509I      @Y17XATI 67766100
MSGINOP  DC    CL4'INOP'                INSERT TO IED509I      @Y17XATI 67766600
MSGENT   DC    CL8'ENTERING'            INSERT TO IED412I/411I @YM07042 67766800
IED411I  EQU   C'1'                     INSERT TO IED412I/411I @YM07042 67767000
         EJECT                                                 @Y17XATI 67767200
*DSECT FOR ERROR MESSAGE WORK AREA                                      68000020
         SPACE 1                                                        68200000
IEDQMSGD DSECT                                                          68400020
MSGWTOPF DS    0F                       WTO MESSAGE PREFIX     @Y17XATI 68402000
MSGWTOLN DS    H                        WTO MESSAGE LENGTH     @Y17XATI 68404000
MSGWTOFL DS    H                        WTO MESSAGE FLAGS      @Y17XATI 68406000
MSGWTO   DS    0C                       WTO MESSAGE START      @Y17XATI 68408000
         ORG   MSGWTOPF                 REDEFINE MESSAGE DSECT @Y17XATI 68410000
MSGPREF  DS    0C                       NON-WTO MESSAGE PREFIX @Y17XATI 68412000
MSG064I  EQU   MSGPREF+13               IED064I INSERT OFFSET  @Y17XATI 68414000
MSG142I  EQU   MSGPREF+8                IED142I INSERT OFFSET  @OX21816 68416082
MSG403I  EQU   MSGPREF+23               IED403I OFFSET INSERT  @YM06033 68418000
MSG41    EQU   MSGPREF+13               IED411/412 INSRT OFFSET@YM07042 68418400
MSG41EXT EQU   MSGPREF+17               IED411/412 INSRT OFFSET@YM07042 68418800
MSG11    EQU   MSGPREF+5                IED411/412 INSRT OFFSET@YM07042 68419200
MSG41END EQU   MSGPREF+L'IED412I        END OF IED412I MESSAGE @YM07042 68419600
MSG509I  EQU   MSGPREF+8                IED509I INSERT OFFSET  @Y17XATI 68420000
MSGCOMA1 DS    0C                       FIRST COMMA            @Y17XATI 68422000
MSGMCS   DS    0C                       MCS CONSTANT           @Y17XATI 68424000
MSGLINE  DS    0C                       CHANNEL UNIT ADDRESS   @Y17XATI 68426000
         EJECT                                                 @Y17XATI 68428000
HEDCNTRL DSECT                          3705 TRACE TABLE       @Y17XATI 68430000
*                                       CONTROL WORDS DSECT    @Y17XATI 68432000
         DS    F                                               @Y17XATI 68434000
         DS    F                                               @Y17XATI 68436000
         DS    CL1                                             @Y17XATI 68438000
HEDFSTHF DS    AL3                      ADDRESS OF FIRST HALF  @Y17XATI 68440000
*                                       OF TRACE TABLE         @Y17XATI 68442000
         SPACE 3                                               @Y17XATI 68444000
TABHALF  DSECT                          3705 TRACE TABLE DSECT @Y17XATI 68447000
         DS    CL16                                            @Y17XATI 68450000
TABLINUM DS    CL12                     GROUPNAME,RLN          @Y17XATI 68453000
         EJECT                                                 @Y17XATI 68456000
         TAVTD                                                          71600020
         EJECT                                                 @Y17XATI 71620000
         TCD1D                                                 @Y17XATI 71640000
         EJECT                                                 @Y17XATI 71660000
         DCBD  DSORG=TX                                        @Y17XATI 71680000
         EJECT                                                 @Y17XATI 71700000
         TDEBD                                                 @Y17XATI 71720000
         EJECT                                                 @Y17XATI 71740000
         TDISPD                                                @Y17XATI 71760000
         EJECT                                                 @Y17XATI 71780000
         TLCBD                                                          71800020
         EJECT                                                 @OX16393 71802000
LCBEXTX  DSECT                                                 @OX16393 71804000
THRWORD  DS    F                        FOUR BYTE THRESH INFO  @OX16393 71806000
IEALTPCD DS    CL1                      SAVED LAST TP OP CODE  @OX16393 71808000
IEAFTPCD DS    CL1                      SAVED FIRST TP OP CODE @OX16393 71810000
IEADVCHS DS    CL2                      SAVED DEVICE CHARACTERS@OX16393 71812000
IEASENS0 DS    CL1                      SENSE INFORMATION      @OZ24288 71814000
IEACMD   DS    CL1                      SAVED COMMAND CODE     @OZ24288 71816000
IEACSW   DS    CL2                      SAVED CSW              @OZ24288 71818000
         EJECT                                                 @Y17XATI 71820000
         TNCPID                                                @Y17XATI 71840000
         EJECT                                                 @Y17XATI 71860000
         TPRFD                                                 @Y17XATI 71910000
         EJECT                                                 @Y17XATI 71960000
         TPRIOR                                                         72000020
         EJECT                                                 @Y17XATI 72020000
         TQCBD                                                 @Y17XATI 72040000
         EJECT                                                 @Y17XATI 72060000
         TSCBD                                                 @Y17XATI 72080000
         EJECT                                                 @Y17XATI 72100000
         TTNTD                                                 @Y17XATI 72120000
         EJECT                                                 @Y17XATI 72140000
         TTRMD                                                          72200020
         EJECT                                                 @Y17XATI 72250000
IEDQUCB  DSECT                                                 @Y17XATI 72300000
         IEFUCBOB                                              @Y17XATI 72350000
         END                                                            75000020
