         TITLE 'IEDQWB - TOTE RESOURCE MANAGEMENT MODULE'               00060000
IEDQWB   CSECT                                                          00120000
*A000000-999999                                                @Y16X5U0 00180000
*** THIS MODULE IS RESEQUENCED AS OF TCAM 10.0                 @Y17XAUU 00240000
* CHANGE ACTIVITY AS FOLLOWS:                                           00300000
*A169200,357300,677700,760500,855900                             X02004 00360000
*D354600                                                         X02004 00420000
*D326222-326330,775610-775760                                   SA41597 00480000
*A770000,886000                                                  A41582 00540000
*C070000-072000,700030-700050,773500                             A41582 00600000
*A106990-107030,688460-688640,775330-775340                      S21903 00660000
*C700054,700056-700058                                           S21903 00720000
*D326222-326330,775610-775820                                    S21903 00780000
*C000000-999999                                                  S22024 00840000
*C841500-842400                                                  S05331 00900000
*D760600-761000                                                @YA10453 00960000
*A129600,664200,833400                                         @YA10453 01020000
*A152100,237600,242100,308700,836100938700                     @Y17XAUU 01080000
*C678600,675000,834020,334800,340200,602100,606600             @Y17XAUU 01140000
*D351650-351700,643500,841500                                  @Y17XAUU 01200000
* A012000,038400,129500,305400                                 @XM05671 01210010
* D212400-214800                                               @XM05672 01220010
*                                                                       01230010
         EJECT                                                          01260000
*********************************************************************** 01320000
*                                                                     * 01380000
* MODULE NAME:  IEDQWB (TCAM,TOTE)                             @Y17XAUU 01440000
*                                                                     * 01500000
* DESCRIPTIVE NAME:  TOTE RESOURCE MANAGEMENT MODULE                  * 01560000
*                                                                     * 01620000
* COPYRIGHT:  'NONE'                                                  * 01680000
*                                                                     * 01740000
* STATUS:  VERSION 10.0                                        @Y17XAUU 01800000
*                                                                     * 01860000
* FUNCTIONS:                                                          * 01920000
*                                                                     * 01980000
*    IEDQWB PERFORMS ONE OF THE FOLLOWING FUNCTIONS REQUESTED BY      * 02040000
*    MODULE IEDQWA:                                                   * 02100000
*                                                                     * 02160000
*    FUNCTION 1 - ON THE FIRST PASS, IEDQWB DETERMINES THE CORE       * 02220000
*                 AVAILABLE TO TOTE.  IT GETS THE NUMBER OF DUMMY     * 02280000
*                 ENTRIES REQUESTED ON THE OLTERM= OPERAND OF THE     * 02340000
*                 TTABLE MACRO AND INITIALIZES THE DUMMY TERMNAME     * 02400000
*                 TABLE ENTRIES AND THE EXTENDED AREA FOR THE TERMINAL* 02460000
*                 ENTRIES (TTE'S) AND QUEUE CONTROL BLOCKS (QCB'S).   * 02520000
*                 IT ALSO LOADS THE ACCESS MANAGER ROUTINE     @Y17XAUU 02580000
*                 IEDQWO AND ALL SERVICE ROUTINES (IEDQWAA,    @Y17XAUU 02640000
*                 IEDQWAB,IEDQWAJ,IEDQWM2,IEDQW35,IEDQW39,     @Y17XAUU 02700000
*                 IEDQWP1,IEDQWP2,IEDQW37,IEDQW28,IEDQW36,     @Y17XAUU 02760000
*                 IEDQWAC,IEDQW41,IEDQW42,IEDQW44,IEDQW47,     @Y17XAUU 02820000
*                 IEDQW16,IEDQW25, AND IEDQW33). IT CHECKS TO  @Y17XAUU 02880000
*                 SEE IF THE TOTE MH (IEDTOTMH) HAS BEEN       @Y17XAUU 02940000
*                 SYSGEN'ED WITH THE MCP. IF THE TOTE MH IS    @Y17XAUU 03000000
*                 PRESENT, ITS ADDRESS IS SAVED IN THE RESPL   @Y17XAUU 03060000
*                 CONTROL BLOCK.                               @Y17XAUU 03120000
*                                                                     * 03180000
*    FUNCTION 2 - THIS FUNCTION CLEANS UP WHEN A TCAM CLOSEDOWN HAS   * 03240000
*                 BEEN ISSUED.  IT FREEMAINS ANY CORE GOTTEN BY TOTE, * 03300000
*                 DETACHES THE OLT, AND DELETES THE ACCESS MANAGER    * 03360000
*                 MODULE IEDQWO AND AND THE SERVICE ROUTINES.  @Y17XAUU 03420000
*                                                                     * 03480000
*    FUNCTION 3 - THIS FUNCTION IS THE END OF SUBTASK (I.E. OLT) CLEAN* 03540000
*                 UP ROUTINE.  IT FREES ANY DUMMY ENTRIES THAT WERE   * 03600000
*                 USED AND FREEMAINS THE OLTCB.  IT MANAGES THE CORE  * 03660000
*                 IN THE EXTENDED AREA (N X 184 BYTES WHERE N IS THE  * 03720000
*                 VALUE SPECIFIED ON OLTERM= OPERAND OF THE TTABLE    * 03780000
*                 MACRO) TO MINIMIZE FRAGMENTATION OF THE AREA.       * 03840000
*                 IF CLEANUP WAS INITIATED BY OPERATOR CONTROL @XM05671 03850010
*                 (VIA POST OF OP CTL CLEANUP ELEMENT), THE    @XM05671 03860010
*                 COUNT OF 'TESTS AFFECTED' CONTAINED IN THE   @XM05671 03870010
*                 ELEMENT IS DECREMENTED. IF ZERO, OP CTL IS   @XM05671 03880010
*                 REDRIVEN BY POSTING THE ELEMENT TO AVTOPCOB. @XM05671 03890010
*                                                                     * 03900000
*    FUNCTION 4 - THIS FUNCTION ALLOCATES DUMMY TNT ENTRIES, QCB'S,   * 03960000
*                 LGB'S AND TTE'S FOR THE CONTROL TERMINAL, ALT@Y17XAUU 03970000
*                 PRINTER, PRIMARY TEST DEVICE OR SECONDARY TEST      * 04080000
*                 DEVICE WHEN REQUESTED.  IT ASSIGNS THE MAIN STORAGE * 04140000
*                 TO THE OLT AND DISPATCHES THE OLT.                  * 04200000
*                                                                     * 04260000
*    FUNCTION 5 - THIS FUNCTION INITIALIZES THE OLTCB FOR A NEWLY     * 04320000
*                 RECEIVED TRM BY ALLOCATING THE CORE REQUIRED,       * 04380000
*                 CLEARING THE CORE AND SETTING UP THE REQUIRED       * 04440000
*                 CONTROL FIELDS.                                     * 04500000
*                                                                     * 04560000
*    FUNCTION 6 - THIS FUNCTION PERFORMS CLEANUP WHEN AN OLT          * 04620000
*                 ABNORMALLY TERMINATES.  IT INFORMS THE SYSTEM       * 04680000
*                 CONSOLE OPERATOR OF THE OLT ABENDING AND THE        * 04740000
*                 COMPLETION CODE.                                    * 04800000
*                                                                     * 04860000
* ENTRY POINT:                                                        * 04920000
*                                                                     * 04980000
*    IEDQWB                                                    @Y17XAUU 05040000
*                                                                     * 05100000
* INPUT:  REGISTERS 00,02,04,13,14,15 CONTAIN THE FOLLOWING VALUES:   * 05160000
*                                                                     * 05220000
*                 00 - PARAMETER REGISTER                             * 05280000
*                 01 - RESPL ADDRESS                           @Y17XAUU 05290000
*                 02 - BUFFER ADDRESS                          @Y17XAUU 05340000
*                 04 - AVT ADDRESS                                    * 05400000
*                 13 - SAVE AREA ADDRESS                              * 05460000
*                 14 - RETURN ADDRESS                                 * 05520000
*                 15 - ENTRY POINT ADDRESS                            * 05580000
*                                                                     * 05640000
* OUTPUT: REGISTERS 01 AND 15 CONTAIN THE FOLLOWING VALUES:           * 05700000
*                                                                     * 05760000
*                 01 - PARAMETER LIST ADDRESS                         * 05820000
*                 15 - RETURN CODE                                    * 05880000
*                                                                     * 05940000
* EXTERNAL REFERENCES:  NONE                                          * 06000000
*                                                                     * 06060000
* EXITS,NORMAL:  RETURNS TO IEDQWA WITH ONE OF THE FOLLOWING          * 06120000
*                RETURN CODES SET IN REGISTER 15:                     * 06180000
*                                                                     * 06240000
*                    0 - CONTINUE QUEUE SCAN                          * 06300000
*                    4 - WAIT FOR NEXT REQUEST FROM TCAM              * 06360000
*                    8 - RETURN TO TCAM                               * 06420000
*                                                                     * 06480000
* EXITS,ERROR: NONE                                                   * 06540000
*                                                                     * 06600000
* MODULE TYPE: PROCEDURE                                       @Y17XAUU 06660000
*                                                              @Y17XAUU 06720000
* PROCESSOR: ASSEMBLER XF                                      @Y17XAUU 06780000
*                                                              @Y17XAUU 06840000
* MODULE SIZE: SEE ASSEMBLE LISTING                            @Y17XAUU 06900000
*                                                              @Y17XAUU 06960000
* MACROS: LOAD                                                 @Y17XAUU 07020000
*         DELETE                                               @Y17XAUU 07080000
*         IEDHJN                                               @Y17XAUU 07140000
*         SAVE                                                 @Y17XAUU 07200000
*         OPEN                                                 @Y17XAUU 07260000
*         STIMER                                               @Y17XAUU 07320000
*         WAIT                                                 @Y17XAUU 07380000
*         TTIMER                                               @Y17XAUU 07440000
*         DETACH                                               @Y17XAUU 07500000
*         ATTACH                                               @Y17XAUU 07560000
*         FREEMAIN                                             @Y17XAUU 07620000
*         GETMAIN                                              @Y17XAUU 07680000
*         POST                                                 @Y17XAUU 07800000
*         WTO                                                  @Y17XAUU 07860000
*         TOPCTL                                               @Y17XAUU 07920000
*                                                              @Y17XAUU 07980000
* NOTES: SEE BELOW                                             @Y17XAUU 08040000
*                                                              @Y17XAUU 08100000
*  DEPENDENCIES: EBCDIC CHARACTER CODE.                        @Y17XAUU 08160000
*                                                              @Y17XAUU 08220000
*  RESTRICTIONS: NONE                                          @Y17XAUU 08280000
*                                                              @Y17XAUU 08340000
*  REGISTER CONVENTIONS: SEE REGISTERS ASSIGNMENT              @Y17XAUU 08400000
*                                                              @Y17XAUU 08460000
*  PATCH: PATCH                                                @Y17XAUU 08520000
*                                                              @Y17XAUU 08580000
* PURPOSE: SEE FUNCTION                                        @Y17XAUU 08640000
*                                                              @Y17XAUU 08700000
* TABLES/WORK AREAS:                                                  * 08760000
*                                                                     * 08820000
*    AVT, CVT, OLTCB, RESPL, TNT, PRF, DCB, LCB, REQ, UCB, SAT,       * 08880000
*    NAT, RVT                                                  @Y17XAUU 08890000
*                                                                     * 08940000
* ATTRIBUTES:                                                         * 08990000
*                                                                     * 09040000
*    ENABLED, PROBLEM PROGRAM MODE, TRANSIENT                         * 09090000
*                                                                     * 09140000
*********************************************************************** 09240000
         EJECT                                                          09290000
*********************************************************************** 09340000
*                                                                       09390000
*        REGISTER EQUATES                                               09440000
*                                                                       09540000
*********************************************************************** 09590000
         SPACE 2                                                        09640000
R0       EQU   0                  WORK REGISTER                         09690000
R1       EQU   1                  PARAMETER LIST ADDRESS                09740000
R2       EQU   2                  WORK REGISTER                         09840000
R3       EQU   3                  WORK REGISTER                         09890000
R4       EQU   4                  ADDRESS OF AVT                        09940000
R5       EQU   5                  WORK REGISTER                         09990000
R6       EQU   6                  WORK REGISTER                         10040000
R7       EQU   7                  WORK REGISTER                         10140000
R8       EQU   8                  WORK REGISTER                         10190000
R9       EQU   9                  WORK REGISTER                         10240000
R10      EQU   10                 WORK REGISTER                         10290000
R11      EQU   11                 BASE REGISTER                         10340000
R12      EQU   12                 ADDRESS OF RESIDENT PARAMETER LIST    10440000
R13      EQU   13                 REGISTER SAVE AREA ADDRESS            10490000
R14      EQU   14                 RETURN ADDRESS                        10540000
R15      EQU   15                 RETURN CODE REGISTER                  10590000
*                                                                       10640000
         SPACE 3                                                        10740000
**************************************************************** S22024 10790000
*        MODULE EQUATES                                        * S22024 10840000
**************************************************************** S22024 10890000
         SPACE 2                                                        10940000
D0       EQU   0                  CONSTANT VALUE                 S22024 11040000
D1       EQU   1                  CONSTANT VALUE                 S22024 11090000
D2       EQU   2                  CONSTANT VALUE                 S22024 11140000
D3       EQU   3                  CONSTANT VALUE                 S22024 11190000
HWRD     EQU   3                  TO PICKUP HALFWORD           @Y17XAUU 11240000
MULTIPLY EQU   3                  TO MULTIPLY BY 8             @Y17XAUU 11340000
D4       EQU   4                  CONSTANT VALUE                 S22024 11390000
D5       EQU   5                  CONSTANT VALUE                 S22024 11440000
D6       EQU   6                  CONSTANT VALUE                 S22024 11490000
D7       EQU   7                  CONSTANT VALUE                 S22024 11540000
D8       EQU   8                  CONSTANT VALUE                 S22024 11640000
D9       EQU   9                  CONSTANT VALUE                 S22024 11690000
D10      EQU   10                 CONSTANT VALUE                 S22024 11740000
D12      EQU   12                 CONSTANT VALUE                 S22024 11790000
D20      EQU   20                 CONSTANT VALUE                 S22024 11840000
D21      EQU   21                 CONSTANT VALUE                 S22024 11940000
D24      EQU   24                 CONSTANT VALUE                 S22024 11990000
D28      EQU   28                 CONSTANT VALUE               @YA10453 12040000
D64      EQU   64                 CONSTANT VALUE                 S22024 12090000
D80      EQU   80                 CONSTANT VALUE                 S22024 12140000
D256     EQU   256                LENGTH FOR CLEARING OLTCB      S22024 12240000
XF0      EQU   X'F0'              USED WHEN UNPACKING A NUMBER   S22024 12290000
XFF      EQU   X'FF'              USED IN TURNING OFF FLAGS             12350000
BLANK    EQU   C' '               BLANK CHARACTER                S22024 12410000
ZEROEQ   EQU   0                  THE CONSTANT 0                 S22024 12470000
THREEEQU EQU   3                  CONSTANT VALUE 3               S22024 12530000
TNTADRLN EQU   3                  LENGTH OF ADDRESS IN TERMINAL  S22024 12590000
*                                   NAME TABLE ENTRY             S22024 12650000
OLTCBKEY EQU   X'D6'              OLTCB QUEUE ELEMENT KEY        S22024 12710000
EXAFQKEY EQU   X'C5'              KEY FOR EXTENDED AREA FREE     S22024 12770000
*                                   QUEUE ELEMENTS               S22024 12830000
TIMEEND  EQU   X'80'              TIMER COMPLETION FLAG          S22024 12890000
SUBTRNSZ EQU   8                  MINIMUM OLT SIZE (8K)        @YM07420 12950000
TESTCTR  EQU   8                  OFFSET OF 'AFFECTED TESTS'   @XM05671 12970010
*                                  CT. IN REQDATA PORTION OF OP@XM05671 12990010
*                                  CTL ELMT (GEN REQUEST ELMT) @XM05671 13010010
TICCODE  EQU   X'08'              TIC CHANNEL COMMAND CODE     @XM05671 13030010
OPENFLAG EQU   X'8F'              OPEN FLAG                      S21903 13080000
SUCCESS  EQU   X'10'              INDICATION OF SUCCESSFUL OPEN  S21903 13140000
*                                                                S22024 13200000
*        RETURN CODES                                            S22024 13260000
*                                                                S22024 13320000
CONTINUE EQU   0                  DIRECT IEDQWA TO CONTINUE THE  S22024 13380000
*                                   QUEUE SCAN                   S22024 13440000
GOWAIT   EQU   4                  DIRECT IEDQWA TO WAIT          S22024 13500000
TCAMRET  EQU   8                  DIRECT IEDQWA TO RETURN TO TCAMS22024 13560000
OLTFLG   EQU   X'80'              DCB OPEN FLAG (INPUT ONLY)   @Y17XAUU 13620000
ADRMSK   EQU   7                  ADDRESS MASK                 @Y17XAUU 13680000
MSKHI    EQU   X'08'              MASK FIELD                   @Y17XAUU 13740000
         SPACE 2                                                        13800000
         EJECT                                                          13860000
*                                                                       13920000
*        SATISFY SYSTEM LINKAGE CONVENTIONS                             13980000
*                                                                       14040000
         SAVE  (14,12)                                                  14100000
         USING IEDQAVTD,R4        SET UP ADDRESSIBILITY FOR AVT         14160000
         LR    R11,R15            GET ENTRY POINT ADDRESS               14220000
         USING IEDQWB,R11         ESTABLISH BASE REGISTER               14280000
IEDQWB   IEDHJN IEDQWBB,HJN       MODULE ID AND HJN                     14340000
         ST    R13,REGSAVE+D4     SAVE POINTER TO TCAM REG SAVE AREA    14400000
         LR    R12,R13            PUT SAVE AREA POINTER INTO REG 12     14460000
         LA    R13,REGSAVE        GET ADDRESS OF OWN SAVE AREA          14520000
         ST    R13,D8(R12)        STORE SAVE AREA ADDRESS IN TCAM       14580000
*                                   SAVE AREA                           14640000
         LR    R12,R1             GET ADDRESS OF RESIDENT PARAMETER     14700000
*                                   LIST                                14760000
         USING RESPL,R12          SET UP ADDRESSIBILITY FOR RESIDENT    14820000
*                                   PARAMETER LIST (RESPL)              14880000
         ST    R2,ELADDR               SAVE BUFFER ADDRESS       X02004 14940000
         EJECT                                                          15000000
*********************************************************************** 15060000
*                                                                     * 15120000
*        FUNCTION 1 - TOTE INITILIZATION                              * 15180000
*                                                                     * 15240000
*********************************************************************** 15300000
FUNCT1   EQU   *                                                        15360000
         TM    RESFLAGS,RESINIT   IS THIS THE FIRST PASS?               15420000
         BO    FUN140             NO, BRANCH                            15480000
         OI    RESFLAGS,RESINIT   YES, TURN OFF FIRST TIME SWITCH       15540000
         SR    R7,R7              CLEAR REGISTER 7                      15600000
         IC    R7,AVTOLTST        GET OLT TRANSIENT AREA SIZE OPTION    15660000
*                                   FROM THE AVT                        15720000
         SH    R7,RESSIZE         SUBTRACT TOTE RESIDENT REQUIREMENT    15780000
         STH   R7,RESBKTOT        STORE RESULT IN BLOCKS TOTAL          15840000
*                                                                       15900000
*        INITIALIZE DUMMY TNT ENTRIES                                   15960000
*                                                                       16020000
         L     R5,AVTRNMPT        GET TERMINAL NAME TABLE ADDR          16080000
         USING IEDQTNTD,R5        SET UP ADDRESSIBILITY FOR TERMNAME    16140000
*                                   TABLE                               16200000
         LH    R7,TNTLEN          GET NUMBER OF TABLE ENTRIES           16260000
         LR    R8,R7                DUPLICATE IT                        16320000
         SR    R9,R9              GET                                   16380000
         IC    R9,TNTENLEN          LENGTH                              16440000
         LA    R9,D3(R9)            OF ENTRY                            16500000
         MR    R6,R9              GET ADDRESS OF TOTE DUMMY             16560000
         LA    R3,TNTFIRST(R7)      TNT FIELD                           16620000
         DROP  R5                                                       16680000
         USING DEXT,R3                                                  16740000
         MVC   RESTNTCT(D4),DEXTCNT SAVE TOTE TNT ENTRY COUNT           16800000
*                                     AND ADDRESS OF EXTENDED AREA      16860000
         ST    R3,RESTNTPT-D1     SAVE ADDRESS OF TOTE TNT FIELD        16920000
         SR    R7,R7              GET NUMBER OF TOTE                    16980000
         IC    R7,RESTNTCT        TNT ENTRIES                           17040000
         LR    R5,R7              DUPLICATE IT                          17100000
         LTR   R7,R7              IS THE NUMBER ZERO?                   17160000
         BZ    FUN120             YES, NO DUMMY TNT ENTRIES SPECIFIED   17220000
*                                   SO BRANCH AROUND SET UP             17280000
         MVI   DEXT,BLANK         FILL TOTE TNT AREA                    17340000
         MVC   DEXT+D1(D3),DEXT     WITH BLANKS                         17400000
         LR    R6,R3              SET INITIAL VALUE FOR TNT             17460000
         SH    R6,TNTEADLN          ENTRY ADDRESS POINTER               17520000
FUN110   EQU   *                                                        17580000
         AR    R6,R9              GET POINTER TO NEXT TNT               17640000
*                                   ENTRY ADDRESS FIELD                 17700000
         LA    R8,D1(R8)          GET TNT OFFSET FOR THIS ENTRY         17760000
         STH   R8,WBWORK01+D4     STORE OFFSET FOR MVC INSTRUCTION      17820000
         MVC   D0(D2,R6),WBWORK01+D4  MOVE OFFSET INTO TNT ENTRY        17880000
*                                       ADDRESS FIELD                   17940000
         BCT   R7,FUN110          LOOP TIL ALL TOTE TNT ENTRY           18000000
*                                   OFFSETS ARE SAVED                   18060000
         SR    R6,R9              CALCULATE ADDRESS                     18120000
         LA    R6,D3(R6)            OF LAST TOTE TNT ENTRY              18180000
         ST    R6,RESTTLST          AND SAVE IN RESIDENT                18240000
*                                   CONTROL BLOCK                       18300000
         DROP  R3                                                       18360000
*                                                                       18420000
*        INITIALIZE EXTENDED AREA FOR QCBS AND TTES                     18480000
*                                                                       18540000
*                                                                       18600000
*        REGISTER R5 CONTAINS NUMBER OF TOTE TNT ENTRIES                18660000
*                                                                       18720000
         L     R2,RESDMTTE-D1     GET EXTENDED AREA ADDRESS             18780000
         USING QEL,R2                                                   18840000
         LA    R3,RESEFQCB        PUT EXTENDED AREA FREE QCB            18900000
         ST    R3,QELQCB-D1         ADDRESS IN ELEMENT                  18960000
         MVI   QELKEY,EXAFQKEY         AND SET KEY                      19020000
         LA    R7,DEXTLFTR        GET EXTENDED AREA LENGTH FACTOR       19080000
         MR    R6,R5              CALCULATE LENGTH OF EXTENDED          19140000
         STH   R7,QELSIZE           AREA AND SAVE IT                    19200000
         L     R15,RESADDND       GET QUEUE HANDLER ADDRESS             19260000
         BALR  R10,R15              AND ADD ELEMENT TO END              19320000
*                                   OF QUEUE                            19380000
         DROP  R2                                                       19440000
FUN120   EQU   *                                                        19500000
         TM    AVTSAVTF,AVTVTMCP  3705 ENVIRONMENT             @Y17XAUU 19560000
         BZ    MHEXIT             NO - BYPASS TOTE MH CHECK    @Y17XAUU 19620000
         L     R10,AVTSAVTP       GET SAVT ADDRESS             @Y17XAUU 19680000
         LA    R10,D0(R10)        CLEAR FLAG BYTE              @Y17XAUU 19740000
         USING IEDNSVTD,R10       ESTABLISH ADDRESSABILITY     @Y17XAUU 19800000
         LH    R7,SAVTMHDX        GET INDEX OF FIRST MH ENTRY  @Y17XAUU 19860000
         L     R15,SAVTTNTX       GET TTCIN TO NETWORK ADDRESS @Y17XAUU 19920000
*                                 CONVERSION ROUTINE ADDRESS   @Y17XAUU 19980000
         L     R10,SAVTMHTB       GET MH TABLE ADDRESS         @Y17XAUU 20040000
         DROP  R10                                             @Y17XAUU 20100000
         USING IEDMHTD,R10        ESTABLISH ADDRESSABILITY     @Y17XAUU 20160000
MHLOOP   DS    0H                 CHECK FOR TOTE MH GEN'ED     @Y17XAUU 20220000
         CLI   MHTABEND,MHFLGE    END OF TABLE                 @Y17XAUU 20280000
         BE    MHEXIT             YES - TOTE MH NOT GEN'ED     @Y17XAUU 20340000
         CLC   MHNAME,TOTEMH      TOTE MH ENTRY                @Y17XAUU 20400000
         BE    MHFOUND            YES                          @Y17XAUU 20460000
         LA    R7,D1(R7)          INCREMENT TTCIN OFFSET       @Y17XAUU 20520000
         LA    R1,MHTABLEN        MH TABLE ENTRY LENGTH        @Y17XAUU 20580000
         AR    R10,R1             POINT TO NEXT ENTRY          @Y17XAUU 20640000
         B     MHLOOP             CHECK NEXT ENTRY             @Y17XAUU 20700000
MHFOUND  DS    0H                 TOTE MH HAS BEEN GEN'ED      @Y17XAUU 20760000
         MVC   RESTOTMH(D4),MHENTRY SAVE TOTE MH ADDRESS       @Y17XAUU 20820000
         STH   R7,RESMHSRC        SAVE TOTE MH TTCIN           @Y17XAUU 20880000
         LR    R1,R7              SET UP TO FIND NETWORK ADDR  @Y17XAUU 20940000
         BALR  R14,R15            CALL IEDIAP04                @Y17XAUU 21000000
         STH   R15,RESMHNAT       SAVE TOTE MH NETWORK ADDRESS @YM07278 21060000
MHEXIT   DS    0H                 END OF TOTE MH CHECK         @Y17XAUU 21120000
         DROP  R10                                             @Y17XAUU 21180000
         LA    R1,RESAPDCB        GET ADDRESS OF DIAGMSG DCB     S21903 21540000
         ST    R1,WBWORK01        PUT IN PARM LIST               S21903 21600000
         MVI   WBWORK01,OPENFLAG  SET FLAG                       S21903 21660000
         LA    R1,WBWORK01        POINT TO PARM LIST             S21903 21720000
         OPEN  MF=(E,(1))         OPEN SYSOUT DCB                S21903 21780000
         LA    R6,RESPLADR        RESIDENT MOD ADDRESS LIST    @Y17XAUU 21840000
         LA    R7,LOADLIST        RESIDENT MOD ID LIST         @Y17XAUU 21900000
*                                                            * @Y17XAUU 21960000
*        THE ENTRIES IN THE RESIDENT MODULE ADDRESS LIST MUST* @Y17XAUU 22020000
*        BE DEFINED IN THE SAME ORDER AS THE RESIDENT MODULE * @Y17XAUU 22080000
*        ID LIST.                                            * @Y17XAUU 22140000
*                                                            * @Y17XAUU 22200000
LOADRES  DS    0H                 LOAD RESIDENT MODULES        @Y17XAUU 22260000
         CLC   D0(D2,R7),ENDLIST  END OF LOAD LIST             @Y17XAUU 22320000
         BE    LOADEND            YES - EXIT                   @Y17XAUU 22380000
         MVC   MODID(D2),D0(R7)   MOVE MOD ID TO LOAD NAME     @Y17XAUU 22440000
         LOAD  EPLOC=MODNAME      LOAD THE MODULE              @Y17XAUU 22500000
         ST    R0,D0(R6)          SAVE MODULE ADDRESS          @Y17XAUU 22560000
         LA    R6,D4(R6)          NEXT ADDRESS SLOT            @Y17XAUU 22620000
         LA    R7,D2(R7)          NEXT MOD ID                  @Y17XAUU 22680000
         B     LOADRES            LOAD NEXT MODULE             @Y17XAUU 22740000
LOADEND  DS    0H                 END OF LOADING               @Y17XAUU 22800000
FUN140   EQU   *                                                        22860000
         SR    R15,R15            CLEAR REG 15                          22920000
         IC    R15,RESWBFNC       GET FUNCTION CODE                     22980000
         B     RESB01(R15)          AND GO PERFORM IT                   23040000
RESB01   EQU   *                                                        23100000
         B     FUNCT1             TOTE INITILIZATION                    23160000
         B     FUNCT2             ISSUE FREEMAINS, DELETES AND          23220000
*                                   INFORMS CE OF CLOSEDOWN             23280000
         B     FUNCT3             SUBTASK ENDED CLEAN UP                23340000
         B     FUNCT4             HONORS TNT REQUEST, ASSIGN MAIN       23400000
*                                   STORAGE, AND DISPATCH OLT           23460000
         B     FUNCT5             SET UP OLTCB FOR NEW OLT REQUEST      23520000
         B     FUNCT6             OLT ABEND CLEAN UP ROUTINE            23580000
         SPACE 2                                                        23640000
RETURN2  EQU   *                                                        23700000
         LA    R15,GOWAIT         DIRECT IEDQWA TO ENTER                23760000
*                                   WAIT STATE                          23820000
         B     RETURN1              & RETURN                            23880000
RETURN   EQU   *                                                        23940000
         LA    R15,CONTINUE       DIRECT IEDQWA TO                      24000000
*                                   CONTINUE QUEUE SCAN                 24060000
RETURN1  EQU   *                                                        24120000
         L     R13,D4(R13)        GET CALLER'S SAVE AREA POINTER        24180000
         L     R14,D12(R13)       RESTORE REGISTER 14                   24240000
         LM    R0,R12,D20(R13)    RESTORE REMAINING REGS EXCEPT 15      24300000
         BR    R14                    RETURN TO CALLER                  24360000
         EJECT                                                          24420000
*********************************************************************** 24480000
*                                                                     * 24540000
*        FUNCTION 2 - ISSUE FREEMAINS,DELETES AND INFORM CE OF        * 24600000
*                     CLOSEDOWN                                       * 24660000
*                                                                     * 24720000
*********************************************************************** 24780000
FUNCT2   EQU   *                                                        24840000
         L     R5,RESOBQCB        GET 1ST OLTCB QUEUE ELEMENT           24900000
FUN201   EQU   *                                                        24960000
         USING TOTOBPTR,R5        SET UP ADDRESSIBILITY FOR OLTCB       25020000
         CLI   TOTELKEY,QENDKEY   IS THIS THE END OF OLTCB QUEUE?       25080000
         BE    FUN202             YES, BRANCH                           25140000
         TM    TOTFLG10,TOTOLTED  IS OLT REQUEST SATISFIED?             25200000
         BO    FUN2015            YES, BRANCH                           25260000
         L     R5,TOTELLNK-D1     GET NEXT QUEUE ELEMENT                25320000
         DROP  R5                                                       25380000
         B     FUN201             BRANCH BACK AND EXAMINE NEXT ELEMENT  25440000
FUN2015  EQU   *                                                        25500000
         LR    R2,R5              PUT OLTCB ADDRESS INTO REGISTER 2     25560000
         BAL   R9,OLTTERM         GO TERMINATE REQUEST                  25620000
         B     FUNCT2             GET NEXT QUEUE ELEMENT                25680000
FUN202   EQU   *                                                        25740000
         L     R1,RESOBQCB        GET 1ST OLTCB QUEUE ELEMENT           25800000
         USING TOTOBPTR,R1        SET UP ADDRESSIBILITY FOR OLTCB       25860000
         CLI   TOTELKEY,QENDKEY   IS OLTCB QUEUE EMPTY?                 25920000
         BE    FUN203             YES, BRANCH                           25980000
         DROP  R1                                                       26040000
         STIMER REAL,TIMEREND,DINTVL=SECS10  SET 10 SECOND TIMER        26100000
         WAIT  ECB=RESTECB1       WAIT FOR OLT COMPLETIONS              26160000
         XC    RESTECB1(D4),RESTECB1  CLEAR TOTE ECB                    26220000
         TTIMER CANCEL            CANCEL TIMER                          26280000
         TM    WBFLAGS,TIMEEND    DID TIMER TIME OUT?                   26340000
         BZ    FUNCT2             NO, GO BACK AND GET 1ST OLTCB         26400000
         L     R5,RESOBQCB        GET 1ST OLTCB QUEUE ELEMENT           26460000
FUN2022  EQU   *                                                        26520000
         USING TOTOBPTR,R5        SET UP ADDRESSIBILITY FOR OLTCB       26580000
         CLI   TOTELKEY,QENDKEY   IS THIS END OF OLTCB QUEUE?           26640000
         BE    FUN203             YES, BYPASS SUBTASK DETACH            26700000
         CLC   TOTTCBAD+D1(D3),ZERO HAS THE ATTACH BEEN PERFORMED?      26760000
         BE    FUN203             NO, BYPASS SUBTASK DETACH             26820000
         OI    TOTFLG04,TOTDTCHD  SET TASK ALREADY DETACHED FLAG        26880000
         DETACH TOTTCBAD          DETACH SUBTASK                        26940000
         L     R5,TOTELLNK-D1     GET NEXT QUEUE ELEMENT                27000000
         DROP  R5                                                       27060000
         B     FUN2022            GO BACK AND EXAMINE NEXT ELEMENT      27120000
FUN203   EQU   *                                                        27180000
         LA    R7,RESPLADR        RESIDENT MOD ID LIST         @Y17XAUU 27240000
DELLIST  DS    0H                 DELETE RESIDENT MODULES      @Y17XAUU 27300000
         CLC   D0(D2,R7),ENDLIST  END OF DELETE LIST           @Y17XAUU 27360000
         BE    DELEND             YES - EXIT                   @Y17XAUU 27420000
         MVC   MODID(D2),D0(R7)   MOVE MOD ID TO DELETE NAME   @Y17XAUU 27480000
         DELETE EPLOC=MODNAME     DELETE THE MODULE            @Y17XAUU 27540000
         LA    R7,D2(R7)          NEXT MOD ID                  @Y17XAUU 27600000
         B     DELLIST            DELETE NEXT MODULE           @Y17XAUU 27660000
DELEND   DS    0H                 END OF DELETING              @Y17XAUU 27720000
         LA    R15,TCAMRET        DIRECT IEDQWA TO RETURN TO TCAM       27780000
         B     RETURN1            RETURN TO IEDQWA                      27840000
         EJECT                                                          27900000
*********************************************************************** 27960000
*                                                                     * 28020000
*        FUNCTION 3 - END OF SUBTASK CLEAN UP ROUTINE                 * 28080000
*                                                                     * 28140000
*********************************************************************** 28200000
FUNCT3   EQU   *                                                        28260000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       28320000
         NI    TOTFLG10,XFF-TOTOLTED  CLEAR SUBTASK ENDED FLAG          28380000
         CLC   TOTCMPCD+D1(D3),ZERO   DID THE SUBTASK ABEND?            28440000
         BNE   FUNCT6             YES, GO TO OLT ABEND CLEANUP ROUTINE  28500000
FUN33    EQU   *                                                        28560000
         BAL   R9,OLTTERM         GO TERMINATE REQUEST                  28620000
         B     RETURN             RETURN TO IEDQWA                      28680000
         SPACE 5                                                        28740000
OLTTERM  EQU   *                                                        28800000
         LR    R6,R2              SAVE OLTCB ADDRESS IN R6              28860000
         DROP  R2                                                       28920000
         USING TOTOBPTR,R6        SET UP ADDRESSIBILITY FOR OLTCB       28980000
         MVI   RQQTYPE,D0         SHOW CLEANUP REQUEST         @Y17XAUU 29040000
         LA    R7,TOTCTENT        GET C.T. ENTRY ADDRESS                29100000
         BAL   R14,TERMLUS        IF LU TERM SESSION           @Y17XAUU 29120000
*        IF CT ENTRY NOT ASSIGNED RETURN IS 8(REG14)           @Y17XAUU 29140000
         BAL   R14,RVTNAT         RVT/NAT PROCESSING           @Y17XAUU 29160000
         BAL   R8,FREETNT           AND GO FREE TNT ENTRY               29200000
*                                   AND EXTENDED AREA                   29280000
         LA    R7,TOTAPENT        GET A.P. ENTRY ADDRESS                29320000
         BAL   R14,TERMLUS        IF LU TERM SESSION           @Y17XAUU 29360000
*        IF AP ENTRY NOT ASSIGNED RETURN IS 8(REG14)           @Y17XAUU 29380000
         BAL   R14,RVTNAT         RVT/NAT PROCESSING           @Y17XAUU 29400000
         BAL   R8,FREETNT           AND GO FREE TNT ENTRY               29460000
*                                   AND EXTENDED AREA                   29520000
         LA    R7,TOTPRENT        GET PRIMARY DEVICE ENTRY ADDR         29760000
         TM    TOTFLG04,TOTPRCTF  PRIMARY ENTRY ASSIGNED?      @YM08057 29763000
         BZ    CHKSCDEV           ENTRY NOT ASSIGNED           @YM08057 29766000
         BAL   R14,TERMLUS        IF LU TERM SESSION           @Y17XAUU 29780000
*        IF PRIMARY TD IS NOT ASSIGNED RETURN IS 8(REG14)      @Y17XAUU 29800000
         BAL   R14,RVTNAT         RVT/NAT PROCESSING           @Y17XAUU 29820000
         BAL   R8,FREETNT           AND GO FREE TNT ENTRY               29860000
*                                   AND EXTENDED AREA                   29940000
CHKSCDEV EQU   *                                               @YM08057 30040000
         LA    R7,TOTSCENT        GET SECONDARY DEVICE                  30240000
*                                   ENTRY ADDRESS                       30300000
         TM    TOTFLG04,TOTSCCTF  SECONDARY ENTRY ASSIGNED?    @YM08057 30306000
         BZ    CHKTDEND           NO - CONTINUE                @YM08057 30312000
         BAL   14,TERMLUS         IF LU TERM SESSION           @Y17XAUU 30320000
*        IF SECONDARY TD IS NOT ASSIGNED RETURN IS 8(REG14)    @Y17XAUU 30340000
         BAL   R14,RVTNAT         RVT/NAT PROCESSING           @Y17XAUU 30360000
         BAL   R8,FREETNT           AND GO FREE TNT ENTRY               30400000
*                                   AND EXTENDED AREA                   30480000
CHKTDEND EQU   *                                               @YM08057 30540000
         OI    TOTFLG01,TOTCLNED  SET "CLEANUP ENDED" FLAG     @XM05671 30541010
*                                                              @XM05671 30542010
*        CHECK IF CLEANUP WAS INITIATED BY OPERATOR CONTROL.   @XM05671 30543010
*        IF SO, DECREMENT 'TESTS AFFECTED' COUNT. IF COUNT     @XM05671 30544010
*        IS ZERO, POST OPERATOR CONTROL ELEMENT TO AVTOPCOB    @XM05671 30545010
*        TO REDRIVE OPERATOR CONTROL.                          @XM05671 30546010
*                                                              @XM05671 30547010
         L     R2,TOTOPCLN        ADDR OF FIRST ELMT (IF ANY)  @XM05671 30548010
CHKOPCTL DS    0H                 START OF ELEMENT LOOP        @XM05671 30549010
         LTR   R2,R2              Q-OP CLT ELMT PRESENT        @XM05671 30550010
         BZ    BLKCHK             N-GET OUT OF LOOP            @XM05671 30551010
         USING IEDREQD,R2         GENERAL REQUEST ELEMENT DSECT@XM05671 30552010
         SR    R8,R8              CLEAR                        @XM05671 30553010
         ICM   R8,7,REQLINK       SAVE LINK ADDR               @XM05671 30554010
         LH    R7,REQDATA+TESTCTR 'TESTS AFFECTED' COUNTER     @XM05671 30555010
         BCTR  R7,R0              DECREMENT                    @XM05671 30556010
         STH   R7,REQDATA+TESTCTR STORE BACK IN ELMT           @XM05671 30557010
         LTR   R7,R7              Q-LAST TEST AFFECTED         @XM05671 30558010
         BNZ   CHKOPEND           N-SEE IF ANY MORE ELEMENTS   @XM05671 30559010
         L     R15,TOTRESPL       ADDR OF RESIDENT P LIST      @XM05671 30560010
         L     R15,RESREMEL-RESPL(R15) CALL SUBROUTINE TO      @XM05671 30561010
         BALR  R10,R15            REMOVE THIS ELMT FROM Q      @XM05671 30562010
         MVC   REQQCBA(D3),REQRQCBA MOVE IN RETURN QCB ADDR    @XM05671 30563010
         MVC   REQPRI(D1),REQRPRI RETURN POST PRIORITY         @XM05671 30564010
         MVI   REQRPRI,TICCODE    SET TIC CHANNEL CMD CODE     @XM05671 30565010
         MVC   REQRQCBA(D3),INVTIC+D1 SET INVALID TIC ADDR     @XM05671 30566010
         XC    REQLINK(D3),REQLINK CLEAR LINK FIELD            @XM05671 30567010
         LA    R0,TOTWAWRK        ADDR OF WORK AREA FOR SUBRT  @XM05671 30568010
         LA    R1,0(R2)           ELMT ADDR, HI BYTE INDICATES @XM05671 30569010
*                                  NO WAIT TO BE PERFORMED     @XM05671 30570010
         L     R4,TOTAVTPT        ADDR TCAM AVT                @XM05671 30571010
         L     R15,RESPLRVT       ADDR OF POSTWAIT ROUTINE     @XM05671 30572010
         BALR  R14,R15            POST ELMT TO OP CTL          @XM05671 30573010
CHKOPEND DS    0H                 END OF LOOP                  @XM05671 30574010
         LR    R2,R8              SET BASE WITH LINK ADDRESS   @XM05671 30575010
         B     CHKOPCTL           GO TO TOP OF LOOP            @XM05671 30576010
         DROP  R2                                              @XM05671 30577010
*                                                              @XM05671 30578010
BLKCHK   DS    0H                                              @XM05671 30579010
         LR    R2,R6              RESTORE OLTCB ADDRESS                 30600000
         DROP  R6                                                       30650000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       30700000
         SR    R3,R3              CLEAR REGISTER 3                      30750000
         LH    R3,RESBKTOT        GET CORE AVAILABLE PARAMETER          30800000
         L     R7,TOTUSCOR        GET TOTAL BYTES OF CORE IN USE S22024 30900000
         SR    R6,R6              CLEAR REGISTER 6               S22024 30950000
         D     R6,K1024           GET NUMBER OF 1K BLOCKS        S22024 31000000
         LTR   R6,R6              WAS THERE A REMAINDER?         S22024 31050000
         BZ    NOADD              NO, NO UPDATE REQUIRED         S22024 31100000
         LA    R6,D1              SET R6 TO ONE                  S22024 31200000
         AR    R7,R6              ADD ONE TO TOTAL 1K BLOCKS     S22024 31250000
NOADD    EQU   *                                                 S22024 31300000
         LA    R6,D8              GET MAXIMUM OLT SIZE (DEFAULT) S22024 31350000
         CR    R7,R6              WAS MORE THAN DEFAULT USED?    S22024 31400000
         BNH   REST1              NO, RESTORE TOTAL BLOCKS USED  S22024 31500000
         AR    R3,R7              ADD USED CORE TO TOTAL BLOCKS  S22024 31550000
         B     REST2              BRANCH AROUND DEFAULT UPDATE   S22024 31600000
REST1    EQU   *                                                 S22024 31650000
         AH    R3,TOTBKASN        ADD THE CORE ASSIGNED TO ENDED OLT    31700000
REST2    EQU   *                                                 S22024 31800000
         AH    R3,OLTCBSZ         ADD THE CORE ASSIGNED TO ENDED OLTCB  31850000
         STC   R3,RESBKTOT+D1     STORE NEW CORE AVAILABLE PARAMETER    31900000
         L     R15,RESREMEL       GET QUEUE HANDLER ADDRESS AND         31950000
         BALR  R10,R15              GO REMOVE ELEMENT FROM QUEUE        32000000
QPULLRET EQU   *                                                        32100000
*        DELETE PAGE FREEING OF OLTCB -- NOT NEEDED IN MVS     @ZM46680 32120010
         LR    R1,R2              SET UP R1 FOR FREEMAIN                32600000
         LA    R0,L'TOTSERV+(TOTOBEND-TOTOBPTR) GET OLTCB LEN  @Y17XAUU 32700000
         FREEMAIN R,LV=(0),A=(1)     ADR IS IN R1 -- FREE OLTCB CORE    32750000
         BR    R9                 RETURN TO CALLER                      32800000
         EJECT                                                          32850000
FREETNT  EQU   *                                                        32900000
*                                                                       33000000
*         REGISTER R6 POINTS TO OLTCB                                   33050000
*         REGISTER R7 POINTS TO DEVICE ENTRY                            33100000
*         REGISTER R8 IS LINK REGISTER                                  33150000
*         REGISTER R9 IS RESERVED LINKAGE REGISTER                      33200000
*                                                                       33300000
         USING TOTOBPTR,R6                                              33350000
         USING ENT,R7                                                   33400000
*                                                                       33450000
*        FREE TOTE TERMINAL NAME TABLE ENTRY                            33500000
*                                                                       33600000
         TM    ENTFLAG1,ENTTTASN  WAS TOTE TNT ENTRY ASSIGNED?          33650000
         BZ    D0(R8)             NO, RETURN                            33700000
         L     R3,ENTTNTAD        GET TNT ENTRY ADDRESS                 33750000
         SR    R5,R5              GET TNT ENTRY                         33800000
         IC    R5,TOTTTBEL          NAME FIELD LENGTH                   33900000
         LA    R5,D0(R3,R5)       GET ADDR OF TTE ADDR FIELD            33950000
         MVC   WBWORK01+D1(TNTADRLN),D0(R5)  SAVE TOTE TTE POINTER      34000000
         MVC   D0(D2,R5),ENTTTOFF SAVE TNT ENTRY OFFSET IN              34050000
*                                   TTE ADDRESS FIELD                   34100000
         USING DUMTNTE,R3                                               34150000
         NI    DTNTFLGS,XFF-DTNTASSN  FREE TNT ENTRY                    34200000
         DROP  R3                                                       34250000
*                                                                       34300000
*        SET UP EXTENDED AREA BLOCK TO FREE IT                          34350000
*                                                                       34400000
         L     R2,WBWORK01        GET EXTENDED AREA ADDRESS             34450000
         LA    R5,IEDQTRM-IEDTRM  SET TTE PREFIX SIZE          @YM09003 34500000
         SLR   R2,R5              POINT TO START OF EXTENDED A @YM09003 34550000
         LA    R2,D0(R2)          CLEAR HIGH ORDER BYTE                 34620000
*                                   FOR COMPARE                         34680000
         USING QEL,R2                                                   34740000
         MVC   QELSIZE(D2),ENTEABLN  MOVE SIZE INTO EXTENDED AREA       34800000
*                                      BLOCK                            34860000
         LA    R5,RESEFQCB        GET QCB ADDRESS                       34920000
         ST    R5,QELQCB-D1         AND SAVE IN EXTENDED AREA           34980000
*                                   BLOCK                               35040000
         MVI   QELKEY,EXAFQKEY    SET KEY IN EXTENDED AREA BLOCK        35100000
         DROP  R2                                                       35160000
         DROP  R7                                                       35220000
*                                                                       35280000
*        FIND CORRECT LOCATION IN QUEUE TO ADD FREED BLOCK              35340000
*                                                                       35400000
*        REGISTER R2 POINTS TO EXTENDED AREA BLOCK TO BE FREED          35460000
*        REGISTER R6 POINTS TO OLTCB                                    35520000
*        REGISTER R8 IS RESERVED LINK REGISTER                          35580000
*        REGISTER R9 IS RESERVED LINK REGISTER                          35640000
*                                                                       35700000
         SR    R7,R7              SET INDICATOR FOR NO PREVIOUS         35760000
*                                   BLOCK                               35820000
         LA    R1,RESEFQCB        GET ADDRESS OF QCB                    35880000
FTNT020  EQU   *                                                        35940000
         USING TQCB,R1                                                  36000000
         L     R3,TQCBLINK-D1     GET ADDRESS OF NEXT ELEMENT           36060000
*                                   IN QUEUE                            36120000
         LA    R3,D0(R3)          CLEAR HIGH ORDER BYTE                 36180000
*                                   FOR COMPARE                         36240000
         USING QEL,R3                                                   36300000
         CLI   QELKEY,QENDKEY     IS THIS END OF QUEUE?                 36360000
         BE    FTNT030            YES, BRANCH                           36420000
         CR    R2,R3              IS THIS CORRECT LOCATION IN           36480000
*                                   QUEUE FOR INSERT?                   36540000
         BL    FTNT030            YES, BRANCH                           36600000
         LR    R7,R3              NO, SAVE ADDRESS OF ELEMENT EXAMINED  36660000
         LA    R1,QELLINK-D1      GET ADDRESS OF NEXT QUEUE ELEMENT     36720000
         B     FTNT020            BRANCH BACK AND TRY AGAIN             36780000
         DROP  R1                                                       36840000
         DROP  R3                                                       36900000
FTNT030  EQU   *                                                        36960000
*                                                                       37020000
*        MERGE NEW ELEMENT WITH PREVIOUS ELEMENT                        37080000
*             IF THEY ARE CONTIGUOUS                                    37140000
*                                                                       37200000
*        REGISTER R2 POINTS TO NEW ELEMENT                              37260000
*        REGISTER R3 POINTS TO NEXT ELEMENT                             37320000
*        REGISTER R7 POINTS TO PREVIOUS ELEMENT                         37380000
*                                                                       37440000
         LTR   R7,R7              WAS THERE A PREVIOUS ELEMENT?         37500000
         BZ    FTNT040            NO, BRANCH                            37560000
         USING QEL,R7                                                   37620000
         LR    R5,R7              GET ADDRESS OF END                    37680000
         AH    R5,QELSIZE           OF PREVIOUS ELEMENT                 37740000
         CR    R2,R5              IS NEW ELEMENT CONTIGUOUS TO          37800000
*                                   PREVIOUS ONE?                       37860000
         BNE   FTNT040            NO, BRANCH                            37920000
         LH    R5,QELSIZE         CALCULATE SIZE                        37980000
         DROP  R7                                                       38040000
         USING QEL,R2                                                   38100000
         AH    R5,QELSIZE           OF MERGED BLOCK                     38160000
         DROP  R2                                                       38220000
         USING QEL,R7                                                   38280000
         STH   R5,QELSIZE           AND STORE IN SIZE FIELD             38340000
         DROP  R7                                                       38400000
         LR    R2,R7              POINT R2 TO MERGED BLOCK              38460000
         B     FTNT050            GO CHECK IF MERGED BLOCK IS           38520000
*                                   CONTIGUOUS TO NEXT ONE              38580000
FTNT040  EQU   *                                                        38640000
*                                                                       38700000
*        REGISTER R1 POINTS TO PREVIOUS LINK FIELD                      38760000
*                                                                       38820000
         LR    R7,R3              SAVE CONTENTS OF REGISTER R3          38880000
         L     R15,RESADDAF       GET QUEUE HANDLER ADDRESS AND         38940000
         BALR  R10,R15              ADD FREED BLOCK TO QUEUE            39000000
         LR    R3,R7              RESTORE REGISTER R3                   39060000
FTNT050  EQU   *                                                        39120000
*                                                                       39180000
*        MERGE FREED BLOCK WITH NEXT ONE IF THEY ARE CONTIGUOUS         39240000
*                                                                       39300000
*        REGISTER R2 POINTS TO FREED ELEMENT                            39360000
*        REGISTER R3 POINTS TO NEXT ELEMENT                             39420000
*        REGISTER R6 POINTS TO OLTCB                                    39480000
*                                                                       39540000
         USING QEL,R3                                                   39600000
         CLI   QELKEY,QENDKEY     IS FREED ELEMENT AT END OF QUEUE?     39660000
         BE    D0(R8)             YES, RETURN                           39720000
         DROP  R3                                                       39780000
         LR    R5,R2              CALCULATE END OF                      39840000
         USING QEL,R5                                                   39900000
         AH    R2,QELSIZE           FREED BLOCK                         39960000
         CR    R2,R3              IS FREED BLOCK CONTIGUOUS TO          40020000
*                                   NEXT BLOCK?                         40080000
         BNE   D0(R8)             NO, RETURN                            40140000
         L     R15,RESREMEL       GET QUEUE HANDLER ADDRESS             40200000
         BALR  R10,R15              AND REMOVE NEXT ELEMENT             40260000
*                                   FROM QUEUE                          40320000
         LH    R7,QELSIZE         CALCULATE SIZE                        40380000
         DROP  R5                                                       40440000
         USING QEL,R3                                                   40500000
         AH    R7,QELSIZE           OF MERGED BLOCK                     40560000
         DROP  R3                                                       40620000
         USING QEL,R5                                                   40680000
         STH   R7,QELSIZE         STORE SIZE OF MERGED BLOCK            40740000
*                                   IN SIZE FIELD                       40800000
         DROP  R5                                                       40860000
         BR    R8                 RETURN TO CALLER                      40920000
         DROP  R6                                                       40980000
         EJECT                                                          41040000
*********************************************************************** 41100000
*        FUNCTION 4 - SERVICE TNT REQUEST, ASSIGN MAIN STORAGE TO     * 41160000
*                     SUBTASK, AND DISPATCH OLT                       * 41220000
*                                                                     * 41280000
*********************************************************************** 41340000
FUNCT4   EQU   *                                                        41400000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       41460000
         TM    TOTFLG10,TOTOLTED  IS OLT SUBTASK ENDED?                 41520000
         BO    FUNCT3             YES, GO CLEAN UP                      41580000
         TM    TOTFLG10,TOTTNTRQ  IS REQUEST FOR TNT ENTRIES?           41640000
         BZ    FUN420             NO, BYPASS TNT SERVICE ROUTINE        41700000
*                                                                       41760000
*        SERVICE TNT ENTRY REQUEST                                      41820000
*                                                                       41880000
         LR    R5,R2              SAVE REQUESTING OLTCB ADDR            41940000
         DROP  R2                                                       42000000
         USING TOTOBPTR,R5                                              42060000
         CLI   RESTNTCT,ZEROEQ    WERE ANY TNT ENTRIES ALLOCATED?       42120000
         BE    FUN4192            NO, GO TO ERROR RETURN                42180000
         LA    R6,RQTNT           GET ADDR OF FIRST REQUEST             42240000
*                                   ELEMENT ENTRY                       42300000
         USING RQTNTENT,R6                                              42360000
         TM    RQTNTTYP,RQTYPANY  IS ANY TERMINAL SPECIFIED IN          42420000
*                                   REQUEST ELEMENT ENTRY?              42480000
         BZ    FUN4192            NO, GO TO ERROR RETURN                42540000
         LA    R7,EXAMINSZ        IS SIZE OF REQUESTED EXTENDED         42600000
         CH    R7,RQTNTLNT          AREA BLOCK SUFFICIENT?              42660000
         BH    FUN4192            NO, GO TO ERROR RETURN                42720000
FUN410   EQU   *                                                        42780000
         L     R7,RESTNTPT-D1     GET ADDRESS OF FIRST TOTE             42840000
*                                   TNT ENTRY                           42900000
FUN411   EQU   *                                                        42960000
         USING DUMTNTE,R7                                               43020000
         LA    R7,D0(R7)          CLEAR HIGH ORDER BYTE FOR COMPARE     43080000
         TM    DTNTFLGS,DTNTASSN  IS ENTRY ALREADY ASSIGNED?            43140000
         BZ    FUN412             NO, BRANCH                            43200000
         C     R7,RESTTLST        IS IT THE LAST ENTRY?                 43260000
         BE    FUN4192            YES, GO TO ERROR RETURN               43320000
         L     R8,AVTRNMPT        GET TERMINAL NAME TABLE ADDR          43380000
         USING IEDQTNTD,R8                                              43440000
         SR    R9,R9              GET LENGTH OF NAME FIELD              43500000
         IC    R9,TNTENLEN          IN TERMINAL NAME TABLE ENTRY        43560000
         DROP  R8                                                       43620000
         LA    R7,TNTADRLN(R9,R7) GET ADDR OF NEXT ENTRY                43680000
         B     FUN411               AND TRY IT                          43740000
FUN412   EQU   *                                                        43800000
         ST    R7,WBWORK01        SAVE ASSIGNED TNT                     43860000
*                                   ENTRY POINTER                       43920000
*                                                                       43980000
*        REGISTER R6 CONTAINS THE ADDRESS OF THE CURRENT REQUEST        44040000
*             ELEMENT ENTRY                                             44100000
*                                                                       44160000
*                                                                       44220000
*        GET EXTENDED AREA BLOCK                                        44280000
*                                                                       44340000
         LH    R7,RQTNTLNT        GET REQUESTED EXTENDED AREA           44400000
*                                   BLOCK LENGTH                        44460000
         TM    RQTNTLNT+D1,THREEEQU  IS LENGTH INTEGRAL MULTIPLE        44520000
*                                      OF FOUR?                         44580000
         BZ    FUN4142            YES, BRANCH                           44640000
         SRL   R7,D2              NO, ROUND UP                          44700000
         LA    R7,D1(R7)            TO INTEGRAL MULTIPLE                44760000
         SLL   R7,D2                OF FOUR                             44820000
FUN4142  EQU   *                                                        44880000
         LA    R1,RESEFQCB        GET EXTENDED AREA FREE                44940000
*                                   QUEUE POINTER                       45000000
FUN4143  EQU   *                                                        45060000
         USING TQCB,R1                                                  45120000
         L     R2,TQCBLINK-D1     GET NEXT QUEUE ELEMENT                45180000
         USING QEL,R2                                                   45240000
         CLI   QELKEY,QENDKEY     WAS THERE ANOTHER ELEMENT?            45300000
         BE    FUN4192            NO, GO TO ERROR RETURN                45360000
         CH    R7,QELSIZE         IS IT LARGE ENOUGH?                   45420000
         BNH   FUN4144            YES, BRANCH                           45480000
         LA    R1,QELLINK-D1      NO, GET NEXT ELEMENT IN QUEUE         45540000
         B     FUN4143            BRANCH BACK AND EXAMINE THE NEXT      45600000
*                                   ELEMENT                             45660000
         DROP  R2                                                       45720000
FUN4144  EQU   *                                                        45780000
         USING QEL,R2                                                   45840000
         L     R15,RESREMEL       GET QUEUE HANDLER ADDRESS AND         45900000
         BALR  R10,R15              AND REMOVE ELEMENT                  45960000
*                                   FROM QUEUE                          46020000
         LA    R8,EXAMINSZ(R7)    ADD MINIMUM EXTENDED                  46080000
*                                   AREA BLOCK SIZE                     46140000
*                                   TO REQUIRED SIZE                    46200000
         LH    R9,QELSIZE         GET SIZE OF FREE BLOCK                46260000
         SR    R9,R8              IS ENOUGH OF THE BLOCK LEFT TO        46320000
*                                   FORM ANOTHER FREE BLOCK?            46380000
         BM    FUN4146            NO, BRANCH                            46440000
*                                 YES, CONTINUE                         46500000
         LR    R8,R2              SAVE ADDRESS OF ELEMENT               46560000
         AR    R2,R7              GET ADDRESS OF NEW ELEMENT            46620000
         LA    R9,EXAMINSZ(R9)    GET SIZE OF NEW ELEMENT               46680000
         STH   R9,QELSIZE         SAVE SIZE OF NEW ELEMENT              46740000
         LA    R9,RESEFQCB        PUT QCB ADDRESS                       46800000
         ST    R9,QELQCB-D1         IN NEW ELEMENT                      46860000
         MVI   QELKEY,EXAFQKEY    SAVE KEY IN NEW ELEMENT               46920000
         L     R15,RESADDAF       GET QUEUE HANDLER ADDRESS AND         46980000
         BALR  R10,R15              ADD ELEMENT TO QUEUE                47040000
         LR    R2,R8              RESTORE ASSIGNED ELEMENT ADDR         47100000
         B     FUN4158            BRANCH                                47160000
FUN4146  EQU   *                                                        47220000
         LH    R7,QELSIZE         GET ASSIGNED BLOCK SIZE               47280000
FUN4158  EQU   *                                                        47340000
         LR    R0,R7              PUT BLOCK SIZE IN REGISTER R0         47400000
         BAL   R10,BLKCLEAR         AND GO CLEAR IT TO ZEROS            47460000
         L     R8,AVTRNMPT        GET TNT ADDR                          47520000
         USING IEDQTNTD,R8                                              47580000
         SR    R9,R9              GET ENTRY NAME                        47640000
         IC    R9,TNTENLEN          LENGTH                              47700000
         DROP  R8                                                       47760000
         L     R8,WBWORK01        GET TNT ENTRY ADDRESS                 47820000
         USING DUMTNTE,R8                                               47880000
         LA    R9,D0(R9,R8)       GET POINTER TO ADDRESS FIELD          47940000
*                                   OF ASSIGNED TNT ENTRY               48000000
         MVC   WBWORK01+D4(D2),D0(R9)  ALLIGN TNT ENTRY OFFSET          48060000
         LH    R10,WBWORK01+D4           AND LOAD INTO REGISTER 10      48120000
         ST    R2,WBWORK01        MOVE ADDR OF EXTENDED AREA            48180000
         MVC   D0(TNTADRLN,R9),WBWORK01+D1  BLOCK INTO TNT ENTRY        48240000
         LA    R7,TOTCTENT        GET ADDRESS OF C.T. PARMS    @Y17XAUU 48300000
         TM    RQTNTTYP,RQTNTCT   IS REQUEST FOR CONTROL TERMINAL?      48360000
         BO    FUN4170            YES, BRANCH                           48420000
         LA    R7,TOTAPENT        GET ADDRESS OF A.P. PARMS    @Y17XAUU 48480000
         TM    RQTNTTYP,RQTNTAP   IS REQUEST FOR ALTERNATE PRINTER?     48540000
         BO    FUN4170            YES, BRANCH                           48600000
         TM    RQTNTTYP,RQTNTPR   IS REQUEST FOR PRIMARY TEST DEVICE?   48660000
         BZ    FUN4160            NO, THEN IT IS A REQUEST FOR          48720000
*                                   A SECONDARY ENTRY                   48780000
         LA    R7,TOTPRENT        GET ADDRESS OF PRIMARY PARMS @Y17XAUU 48840000
         OI    TOTPRFLG,TOTPRTAS  SET PRIMARY TNT ENTRY        @Y17XAUU 48900000
*                                   ASSIGNED FLAG                       48960000
         B     FUN4170            GO ASSIGN ENTRY                       49020000
FUN4160  EQU   *                                                        49080000
         LA    R7,TOTSCENT        GET ADDRESS OF SECONDARY PARM@Y17XAUU 49140000
         OI    TOTSCFLG,TOTSCTAS  SET SECONDARY TNT ENTRY      @Y17XAUU 49200000
*                                   ASSIGNED FLAG                       49260000
FUN4170  EQU   *                                                        49320000
         USING ENT,R7                                          @YM07418 49380000
         ST    R8,ENTTNTAD        SAVE ADDRESS OF TNT ENTRY             49440000
         MVC   ENTEABLN(D2),RQTNTLNT SAVE LEN OF ASSIGNED      @YM09003 49500000
*                                   EXTENDED AREA BLOCK                 49560000
         STH   R10,ENTTTOFF       SAVE TNT ENTRY OFFSET                 49620000
         OI    ENTFLAG1,ENTTTASN  SET ASSIGNED FLAG IN                  49680000
*                                   DEVICE ENTRY                        49740000
         OI    DTNTFLGS,DTNTASSN  SET ASSIGNED FLAGS IN TNT             49800000
*                                   ENTRY                               49860000
         MVI   RQQTYPE,COUNTER    SET COUNTERFEIT REQUEST      @Y17XAUU 49920000
         LR    R6,R5              SET OLTCB BASE               @Y17XAUU 49980000
         BAL   R14,RVTNAT         CHECK RVT/NAT COUNTERFEITING @Y17XAUU 50040000
         DROP  R7                                              @YM07418 50100000
         DROP  R2                                                       50160000
         TM    RQTNTFGS,RQTNTLST  IS THIS THE LAST ENTRY?               50220000
         BO    FUN4194            YES, BRANCH                           50280000
         LA    R6,RQTENLEN(R6)    GET NEXT REQUEST ELEMENT FIELD        50340000
         DROP  R6                                                       50400000
         B     FUN410             LOOP IF MORE ENTRIES                  50460000
FUN4192  EQU   *                                                        50520000
         MVI   RQTNT,RQTNTERR     SET ERROR RETURN CODE                 50580000
FUN4194  EQU   *                                                        50640000
         NI    TOTFLG10,XFF-TOTTNTRQ  CLEAR TNT REQUEST FLAG            50700000
         DROP  R5                                                       50760000
         DROP  R8                                                       50820000
         LR    R2,R5              RESTORE CURRENT ENTRY POINTER         50880000
         B     FUN480             RETURN                                50940000
*                                                                       51000000
*        ASSIGN MAIN STORAGE TO SUBTASK                                 51060000
*                                                                       51120000
FUN420   EQU   *                                                        51180000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       51240000
         LH    R3,RESBKTOT        GET CORE AVAILABLE PARAMETER          51300000
         AH    R3,TOTBKASN        UPDATE WITH CORE ASSIGNED PARAMETER   51360000
         STH   R3,RESBKTOT        STORE IN CORE AVAILABLE FIELD         51420000
         XC    TOTBKASN(D2),TOTBKASN  CLEAR CORE BLOCKS ASSIGNED PARM   51480000
         SH    R3,TOTBKRQD        SUBTRACT AMOUNT REQUIRED              51540000
         BM    RETURN2            BRANCH IF NOT ENOUGH CORE             51600000
         STH   R3,RESBKTOT        UPDATE CORE AVAILABLE PARM            51660000
         LH    R3,TOTBKRQD        GET NO. OF BLOCKS REQUIRED            51720000
         STH   R3,TOTBKASN        ASSIGN REQUIRED CORE TO OLT -         51780000
         SLL   R3,D10             CONVERT TO NUMBER OF BYTES            51840000
         ST    R3,TOTMMSPC        SAVE RESULT IN OLTCB                  51900000
         NI    TOTFLG10,XFF-TOTOLTWT  CLEAR OLT WAITING FOR CORE FLAG   51960000
*                                                                       52020000
*        DISPATCH OLT                                                   52080000
*                                                                       52140000
         LA    R1,TOTOLTPL        GET PARAMETERS FOR TRM ANALYSIS       52200000
         LA    R3,TOTOLTCB        GET ADDRESS OF OLTCB AND SCT   S22024 52260000
         ST    R3,TOTOLTPL        PUT SCT ADDRESS IN OLTCB       S22024 52320000
*                                                                       52380000
         TM    TOTFLG10,TOTOLTRS  IS OLT RESTART REQUESTED?             52440000
         BZ    RES052             NO, BRANCH AROUND POST                52500000
         NI    TOTFLG10,XFF-TOTOLTRS  CLEAR OLT RESTART FLAG            52560000
FUN480   EQU   *                                                        52620000
         POST  TOTOTECB           POST OLT TO INDICATE ADDITIONAL      X52680000
                                    CORE ASSIGNED                       52740000
         B     RETURN             RETURN TO CALLER                      52800000
RES052   EQU   *                                                        52860000
         LA    R2,TOTOLTCB        SET UP OLTCB ADDR FOR SUBTASK  S22024 52920000
         USING TOTOLTCB,R2        SET UP ADDRESSIBILITY FOR OLTCBS22024 52980000
         MVC   ATTLIST+D21(D3),RESETXRA+D1  MOVE EXIT ADDR TO ATTACH    53040000
*                                          PARAMETER LIST               53100000
         ATTACH SF=(E,ATTLIST)    ATTACH IEDQWB1- TRM ANALYSIS MODULE   53160000
         LTR   R15,R15                  DID ATTACH COMPLETE?   @YA10453 53220000
         BNZ   FREECORE                   NO, MOD NOT ATTACHED @YA10453 53280000
         MVC   CNAME+D5(D2),CHARB1  RESTORE ATTACH MODULE NAME          53340000
         ST    R1,TOTTCBAD        SAVE TCB ADDRESS                      53400000
         B     RETURN             RETURN TO CALLER                      53460000
         DROP  R2                                                       53520000
         EJECT                                                          53580000
*********************************************************************** 53640000
*                                                                     * 53700000
*        FUNCTION 5 - INITILIZE THE OLTCB                             * 53760000
*                                                                     * 53820000
*********************************************************************** 53880000
FUNCT5   EQU   *                                                        53940000
         LA    R0,L'TOTSERV+(TOTOBEND-TOTOBPTR) GET OLTCB LEN  @Y17XAUU 54000000
         GETMAIN R,LV=(0)            GET CORE FOR OLTCB                 54060000
         LR    R2,R1              SAVE ADDRESS OF OLTCB                 54120000
         USING TOTOBPTR,R2                                              54180000
*        DELETE PAGE FIXING OF OLTCB -- NOT NEEDED IN MVS      @ZM46680 54210010
         LA    R0,L'TOTSERV+(TOTOBEND-TOTOBPTR) GET OLTCB LEN  @Y17XAUU 55080000
         BAL   R10,BLKCLEAR       CLEAR OLTCB                           55140000
         LA    R15,RESOBQCB       PUT ADDRESS OF OLTCB QCB              55200000
         ST    R15,TOTELQCB-D1      IN OLTCB                            55260000
         MVI   TOTELKEY,OLTCBKEY  SET OLTCB ELEMENT KEY                 55320000
         ST    R4,TOTAVTPT     SAVE AVT ADDRESS                         55380000
         LH    R10,RESBKTOT       GET TOTAL CORE BLOCKS AVAILABLE       55440000
         SH    R10,OLTCBSZ        SUBTRACT OLTCB SIZE                   55500000
         STH   R10,RESBKTOT       UPDATE TOTAL BLOCKS AVAILABLE PARM    55560000
*                                                                       55620000
*        GET IDENTIFICATION FOR NEW OLT                                 55680000
*                                                                       55740000
         LA    R5,D1              INITIALIZE I.D. REGISTER              55800000
RES0762  EQU   *                                                        55860000
         L     R7,RESOBQCB        GET FIRST OLTCB QUEUE ELEMENT         55920000
RES0764  EQU   *                                                        55980000
         CVD   R5,WBWORK01        CONVERT NEW I.D. TO DECIMAL           56040000
         UNPK  TOTOLTID(D2),WBWORK01(D8)  UNPACK NEW I.D.               56100000
         OI    TOTOLTID+D1,XF0    SET SIGN OF ID TO F                   56160000
         DROP  R2                                                       56220000
         USING TOTOBPTR,R7        SET UP ADDRESSIBILITY FOR OLTCB       56280000
         CLI   TOTELKEY,QENDKEY   IS THIS THE END OF QUEUE?             56340000
         BE    RES0768            YES, BRANCH                           56400000
         CLI   TOTOLTID,D0        HAS ID BEEN ASSIGNED?                 56460000
         BE    RES0766            NO, BRANCH                            56520000
         DROP  R7                                                       56580000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       56640000
         CLC   TOTOLTID(D2),TOTOLTID-TOTOBPTR(R7)  ARE SUBTASK I.D.S    56700000
*                                                    EQUAL?             56760000
         BNE   RES0766            NO, BRANCH                            56820000
         LA    R5,D1(R5)          YES, GET NEXT HIGHER I.D.             56880000
         B     RES0762            GO SEE IF IT IS ALREADY ASSIGNED      56940000
RES0766  EQU   *                                                        57000000
         DROP  R2                                                       57060000
         USING TOTOBPTR,R7                                              57120000
         L     R7,TOTELLNK-D1     GET NEXT QUEUE ELEMENT                57180000
         DROP  R7                                                       57240000
         B     RES0764            SEE IF IT HAS NEW I.D.                57300000
RES0768  EQU   *                                                        57360000
         USING TOTOBPTR,R2        SET UP ADDRESSIBILITY FOR OLTCB       57420000
         L     R15,RESADDND       GET QUEUE HANDLER ADDRESS AND         57480000
         BALR  R10,R15              ADD OLTCB TO END OF QUEUE           57540000
*                                                                       57600000
         MVI   TOTBKRQD+D1,SUBTRNSZ  PUT SUBTASK TRANSIENT AREA         57660000
*                                      SIZE DEFAULT IN OLTCB            57720000
         OI    TOTFLG10,TOTOLTWT  SET OLT WAITING FOR CORE FLAG         57780000
         LA    R7,RES#TBLE        SET UP PARAMETER LIST                 57840000
         ST    R7,TOT#TBLE          FOR OLT'S                           57900000
         LA    R1,RESPL           GET ADDRESS OF TOTE RESIDENT PARMS    57960000
         ST    R1,TOTRESPL          AND STORE IN OLTCB                  58020000
         LA    R7,TOTOLTMQ        GET ADDRESS OF OLT MESSAGE QCB        58080000
         L     R9,RESTRMQ         GET FIRST TRM QUEUE ELEMENT           58140000
         USING IEDQPRF,R9                                               58200000
         LA    R8,PRFSUNIT        GET START OF UNIT                     58260000
         AH    R8,PRFSCAN           ADD DISPLACEMENT FROM               58320000
*                                   SCAN POINTER                        58380000
         OC    D0(D8,R8),UPPER    CONVERT NAME TO UPPER CASE            58440000
         MVC   TOTCTNAM(D9),D0(R8)  MOVE CONTROL TERMINAL NAME INTO     58500000
*                                     THE OLTCB                         58560000
         LA    R5,RES#TBLE        GET BRANCH TABLE ADDRESS              58620000
         ST    R5,$TABLE            AND STORE IN SCT                    58680000
         MVC   TOTSTAE(D4),RESSTAEA  MOVE STAE EXIT ROUTINE      S22024 58740000
*                                         ADDRESS INTO OLTCB     S22024 58800000
         L     R15,AVTRNMPT       GET TERMNAME TABLE ADDRESS            58860000
         USING IEDQTNTD,R15       SET UP ADDRESSIBILITY FOR TERMNAME    58920000
*                                   TABLE                               58980000
         MVC   TOTTTBEL(D1),TNTENLEN  PICK UP MAX. LENGTH OF NAME FIELD 59040000
         TM    RESAPOPN,SUCCESS   SUCCESSFUL OPEN OF DIAGMSG     S21903 59100000
*                                   DCB?                         S21903 59160000
         BNO   FUN575             NO, DON'T DAVE ADDRESS OF DCB  S21903 59220000
         LA    R8,RESAPDCB        GET DCB ADDRESS                S21903 59280000
         ST    R8,TOTAPDCB        SAVE DCB ADDRESS IN OLTCB      S21903 59340000
         DROP  R15                                                      59400000
         DROP  R9                                                       59460000
         DROP  R2                                                       59520000
FUN575   EQU   *                                                        59580000
         LA    R1,RESTRMQ         REMOVE FIRST ELEMENT                  59640000
         L     R15,RESREMFR         FROM TOTE                           59700000
         BALR  R10,R15              TRM QUEUE                           59760000
         LTR   R1,R1              WAS QUEUE EMPTY?                      59820000
         BNP   FUN59              YES, BRANCH                           59880000
         USING IEDQPRF,R2         SET UP ADDRESSABILITY FOR BUFFER      59940000
*                                   PREFIX                              60000000
         IC    R8,PRFKEY          SAVE PREFIX KEY                       60060000
         ST    R7,PRFQCBA-D1      PUT OLT MESSAGE QCB ADDRESS           60120000
*                                   IN ELEMENT                          60180000
         STC   R8,PRFKEY          RESTORE PREFIX KEY                    60240000
         L     R15,RESADDND       GET QUEUE HANDLER ADDRESS AND         60300000
         BALR  R10,R15              ADD ELEMENT TO END OF OLT           60360000
*                                   MESSAGE QUEUE                       60420000
FUN59    EQU   *                                                        60480000
         B     RETURN             RETURN TO CALLER                      60540000
         DROP  R2                                                       60600000
         EJECT                                                          60660000
*********************************************************************** 60720000
*                                                                     * 60780000
*        FUNCTION 6 - OLT ABEND CLEANUP ROUTINE                       * 60840000
*                                                                     * 60900000
*********************************************************************** 60960000
*                                                                A41582 61020000
FUNCT6   EQU   *                                                 A41582 61080000
         USING TOTOBPTR,R2                                              61140000
         L     R7,TOTCMPCD        GET ABEND CODE                        61200000
         SLL   R7,D8              ELIMINATE HIGH ORDER BYTE      A41582 61260000
         LA    R10,D6             GET COUNT FOR CONVERT          A41582 61320000
         LA    R9,ABCODE          GET ADDRESS IN MESSAGE         A41582 61380000
FUN605   EQU   *                                                 A41582 61440000
         SR    R6,R6              CLEAR WORK REGISTER            A41582 61500000
         SLDL  R6,D4              GET NEXT HEX CHARACTER         A41582 61560000
         IC    R6,CNVTBL(R6)      CONVERT TO EBCDIC              A41582 61620000
         STC   R6,D0(R9)          SAVE IN MESSAGE                A41582 61680000
         LA    R9,D1(R9)          GET MESSAGE ADDR FOR NEXT CHAR A41582 61740000
         BCT   R10,FUN605         LOOP TILL ALL CHARACTERS       A41582 61800000
*                                   CONVERTED                    A41582 61860000
         MVC   ABID(D2),TOTOLTID  MOVE OLT I.D. TO ABEND MESSAGE        61920000
         CNOP  0,4                                               A41582 61980000
ABMSG    WTO   'IED284I OLT    ABEND       ',ROUTCDE=10,DESC=7          62040000
ABID     EQU   ABMSG+20           OLT ID NUMBER                  S21903 62100000
ABCODE   EQU   ABMSG+29           OLT ABEND CODE                 S21903 62160000
         TM    TOTFLG06,TOTABEND  DID SUBTASK PREVIOUSLY ABEND?         62220000
         BO    FUN33              YES,GO CLEAN UP SUBTASK               62280000
         OI    TOTFLG06,TOTABEND+TOTOTERM  NO SET ABEND FLAG            62340000
         XC    TOTCMPCD(D4),TOTCMPCD  CLEAR SUBTASK COMPLETION          62400000
*                                       CODE IN OLTCB                   62460000
         MVC   CNAME+D5(D2),CHARE SET ATTACH MODULE NAME                62520000
*                                   TO IEDQWE                           62580000
         B     RES052             GO TO IEDQWE TO CLEAN UP              62640000
         DROP  R2                                                       62700000
         EJECT                                                          62760000
*********************************************************************** 62820000
*                                                                     * 62880000
*                  TIMER COMPLETION ROUTINE                           * 62940000
*                                                                     * 63000000
*********************************************************************** 63060000
TIMEREND EQU   *                                                        63120000
         USING TIMEREND,R15                                             63180000
         STM   R14,R12,D12(R13)   SAVE REGISTERS                        63240000
         OI    WBFLAGS,TIMEEND    SET TIMER CONPLETION FLAG             63300000
         L     R10,REGSAVE+D4     GET RESIDENT MODULE SAVE AREA         63360000
         L     R10,D24(R10)       GET ADDRESS OF RESIDENT PARAMETERS    63420000
         USING RESPL,R10                                                63480000
         POST  RESTECB1           POST WAIT COMPLETE             S22024 63540000
         DROP  R10                                                      63600000
         DROP  R15                                                      63660000
         LM    R14,R12,D12(R13)   RESTORE REGISTERS                     63720000
         BR    R14                RETURN                                63780000
         EJECT                                                          63840000
*********************************************************************** 63900000
*                                                                     * 63960000
*        CLEAR BLOCK OF MAIN STORAGE                                  * 64020000
*             REGISTER R0 CONTAINS LENGTH OF BLOCK TO CLEAR           * 64080000
*             REGISTER R2 CONTAINS BLOCK ADDRESS                      * 64140000
*                                                                     * 64200000
*********************************************************************** 64260000
BLKCLEAR EQU   *                                                        64320000
         LR    R14,R0             BACKUP COUNT REGISTER                 64370000
         LR    R15,R2             BACKUP POINTER REGISTER               64420000
         LA    R1,D256            GET LENGTH FOR EXECUTE                64470000
CLR010   EQU   *                                                        64520000
         CR    R14,R1             IS REMAINDER 256 BYTES OR LONGER?     64620000
         BH    CLR020             YES, CLEAR 256 BYTES                  64670000
         LR    R1,R14             NO, CLEAR REMAINDER                   64720000
CLR020   EQU   *                                                        64770000
         BCTR  R1,D0              DECREMENT COUNT FOR EXECUTE           64820000
         EX    R1,CLR099          CLEAR NEXT SEGMENT                    64920000
         LA    R1,D1(R1)          RESTORE COUNT                         64970000
         CR    R14,R1             IS CLEAR COMPLETED?                   65020000
         BNH   D0(R10)            YES, RETURN TO CALLER                 65070000
         SR    R14,R1             NO, UPDATE REMAINDER                  65120000
         AR    R15,R1             GET NEXT SEGMENT ADDRESS              65220000
         B     CLR010             GO CLEAR NEXT SEGMENT                 65270000
*                                                                       65320000
CLR099   XC    D0(D0,R15),D0(R15) CLEAR FOR EXECUTE INSTRUCTION         65370000
         EJECT                                                          65420000
*********************************************************************** 65520000
*                                                                     * 65570000
*   NOT ENOUGH CORE FOR ATTACH MACRO TO BRING IN ANOTHER      @YA10453* 65620000
*     MODULE OR NOT ENOUGH FIXED CORE FOR OPERATOR CONTROL    @YA10453* 65670000
*     REQUEST, THEREFORE THE TRM CANNOT BE HONORED AT THIS    @YA10453* 65720000
*     TIME.                                                   @YA10453* 65820000
*                                                                     * 65870000
*********************************************************************** 65920000
FREECORE EQU   *                                               @YA10453 65970000
         LH    R10,RESBKTOT             GET TOTAL CORE BLCKS   @YA10453 66020000
         AH    R10,OLTCBSZ              ADD OLTCB SIZE         @YA10453 66120000
         STH   R10,RESBKTOT             UPDATE TOTAL BLOCKS    @YA10453 66170000
*                                         AVAILABLE PARM       @YA10453 66220000
         L     R15,RESREMEL             GET ADDR TO REMOVE     @YA10453 66270000
*                                         ELEM. FROM QUEUE     @YA10453 66320000
         BALR  R10,R15                  TAKE OLTCB OFF QUEUE   @YA10453 66420000
         MVC   FREE1+D28(D8),CNAME      MOVE IN MODNAME THAT   @YA10453 66470000
*                                         ATTACH FAILED ON     @YA10453 66520000
         MVC   CNAME+D5(D2),CHARB1      RESTORE ATTACH MODNAME @YA10453 66570000
FREE1    WTO   'IED330I OLT MODULE          CANNOT BE LOADED',         *66620000
               ROUTCDE=10,DESC=7                               @YA10453 66720000
         B     FREECOR2                 GO FREE OLTCB CORE     @YA10453 66770000
         SPACE                                                          66820000
NOFIXCOR EQU   *                                               @YA10453 66870000
         WTO   'IED276I OLT REQUEST REJECTED, UNABLE TO GET FIXED CORE *66920000
               FOR OPERATOR CONTROL REQUEST',ROUTCDE=10,DESC=7 @YA10453 67020000
         SPACE                                                          67070000
FREECOR2 EQU   *                                                        67120000
         LR    R1,R2                    SET UP R1 FOR FREEMAIN @YA10453 67170000
         LA    R0,L'TOTSERV+(TOTOBEND-TOTOBPTR) GET OLTCB LEN  @Y17XAUU 67220000
         FREEMAIN  R,LV=(0),A=(1)       FREE OLTCB CORE        @YA10453 67320000
         LA    R15,TCAMRET              DIRECT IEDQWA TO RTN   @YA10453 67370000
         B     RETURN1                  RETURN TO IEDQWA       @YA10453 67420000
         EJECT                                                          67470000
RVTNAT   DS    0H                 ROUTINE TO COUNTERFEIT OR    @Y17XAUU 67520000
*                                 CLEAN UP RVT AND NAT ENTRIES @Y17XAUU 67620000
*                                                              @Y17XAUU 67670000
*        IF 3705 MODE, SET UP TO COUNTERFEIT RVT AND           @Y17XAUU 67720000
*        NAT ENTRIES                                           @Y17XAUU 67770000
*                                                              @Y17XAUU 67820000
         USING TOTOBPTR,R6        SET OLTCB ADDRESSABILITY     @Y17XAUU 67920000
         USING ENT,R7             SET ADDRESSABILITY           @Y17XAUU 67970000
         ST    R14,RETSAVE        SAVE RETURN ADDRESS          @Y17XAUU 68020000
         L     R1,ENTTNTRL        GET TNT ADDRESS              @Y17XAUU 68070000
         SLR   R4,R4              CLEAR REG                    @Y17XAUU 68120000
         IC    R4,TOTTTBEL        GET MAX NAME LENGTH          @Y17XAUU 68170000
         AR    R1,R4              POINT TO TTE ADDRESS         @Y17XAUU 68220000
         ICM   R1,ADRMSK,D0(R1)   GET TTE ADDRESS              @Y17XAUU 68270000
         USING IEDQTRM,R1         SET TTE ADDRESSABILITY       @Y17XAUU 68320000
         TM    TRMSTATE,TRMPREF   3705 RESOURCE                @Y17XAUU 68370000
         BZ    FUNRVTE            NO                           @Y17XAUU 68420000
         DROP  R1                                              @Y17XAUU 68470000
         LA    R0,TOTWAWRK        POINT TO QWA WORK AREA       @Y17XAUU 68520000
         LA    R1,D1              REQUEST ONE BUFFER           @Y17XAUU 68570000
         L     R4,TOTAVTPT        GET AVT ADDRESS              @Y17XAUU 68620000
         L     R15,RESABUF        ADDRESS OF BUFFER REQ RTN    @Y17XAUU 68670000
         LA    R13,REGSAVE2       SET SAVE AREA FOR ALLOCBUF   @YM07351 68720000
         BALR  R14,R15            GO REQUEST A BUFFER          @Y17XAUU 68880000
         LA    R13,REGSAVE        RESTORE MY SAVE AREA ADDR    @YM07351 68910000
         SPACE                                                          68940000
*        SET UP BUFFER TO SEND TO POST/WAIT ROUTINE IN QWA     @Y17XAUU 68990000
         USING IEDREQD,R1         SET REQ ADDRESSABILITY       @Y17XAUU 69040000
         XC    IEDREQD(REQLEN),IEDREQD CLEAR BASIC PORTION     @Y17XAUU 69090000
*                                 OF REQUEST ELEMENT           @Y17XAUU 69140000
         LA    R15,QWBSYNCH       GET SYNCH QCB ADDRESS        @YM07770 69190000
         STCM  R15,ADRMSK,REQQCBA PUT IT IN ELEMENT            @Y17XAUU 69300000
         MVI   REQPRI,PRISSOLT    SET POST PRIORITY            @Y17XAUU 69340000
         MVI   REQRPRI,PRISSOLT   SET RETURN PRIORITY          @Y17XAUU 69380000
         ST    R7,REQDATA         SAVE DEVICE ENTRY CONTROL    @Y17XAUU 69420000
*                                 AREA ADDRESS                 @Y17XAUU 69470000
         CLI   RQQTYPE,D0         CLEAN UP REQUEST             @Y17XAUU 69520000
         BNE   RES00              NO                           @Y17XAUU 69570000
         MVI   REQDATA,D0         SHOW CLEANUP REQUEST         @Y17XAUU 69620000
         B     RES05              CONTINUE                     @Y17XAUU 69720000
RES00    EQU   *                                               @Y17XAUU 69770000
         MVI   REQDATA,XFF        INDICATE COUNTERFEIT REQ     @Y17XAUU 69820000
         SPACE                                                          69870000
RES05    EQU   *                                               @Y17XAUU 69920000
*        SET UP TO PASS ELEMENT TO POST/WAIT ROUTINE IN QWA    @Y17XAUU 70020000
         LA    R0,TOTWAWRK        POINT TO QWA WORK AREA       @Y17XAUU 70070000
         LA    R4,TOTAVTPT        GET AVT ADDRESS              @Y17XAUU 70120000
*        REG 1 ALREADY POINTS TO REQUEST ELEMENT               @Y17XAUU 70170000
         ICM   R1,MSKHI,WAIT      SET WAIT FLAG                @Y17XAUU 70220000
         L     R15,RESPLRVT       ADDRESS OF POST/WAIT ROUTINE @Y17XAUU 70270000
         LA    R13,REGSAVE2       SET UP SAVE AREA ADDRESS     @Y17XAUU 70320000
         BALR  R14,R15            GO TO POST THE ELEMENT       @Y17XAUU 70380000
         LA    13,REGSAVE         RESTORE MY SAVE AREA ADDRESS @Y17XAUU 70410000
*        ON RETURN REG 1 POINT TO REQUEST ELEMENT              @Y17XAUU 70440000
         MVC   REQRPRI(D4),INVTIC  SET INVALID TIC             @Y17XAUU 70490000
         LA    R0,TOTWAWRK        POINT TO QWA WORK AREA       @Y17XAUU 70540000
         L     R4,TOTAVTPT        GET AVT ADDRESS              @Y17XAUU 70590000
         L     R15,RESFBUF        FREE BUFFER ROUTINE ADDR     @Y17XAUU 70640000
         LA    R13,REGSAVE2       SET SAVE AREA FOR FREEBUF    @YM07351 70690000
         BALR  R14,R15            FREE THE BUFFER UNIT         @Y17XAUU 70740000
         LA    R13,REGSAVE        RESTORE MY SAVE AREA ADDR    @YM07351 70770000
FUNRVTE  EQU   *                                               @Y17XAUU 70800000
         L     R14,RETSAVE        RESTORE RETURN ADDRESS       @Y17XAUU 70860000
         BR    R14                RETURN TO CALLER             @Y17XAUU 70920000
         DROP  R1                                              @Y17XAUU 70980000
         DROP  R6                                              @Y17XAUU 71040000
         DROP  R7                                              @Y17XAUU 71100000
         EJECT                                                          71100800
TERMLUS  DS    0H                 BOUNDARY ALLIGNMENT          @Y17XAUU 71101600
************************************************************** @Y17XAUU 71102400
*                                                            * @Y17XAUU 71103200
*        IF SNA LU ENTRY AND ASSIGNED, BUILD REQUEST ELEMENT * @Y17XAUU 71104000
*        AND POST TO LUS TO TERMINATE LU-LU SESSION.         * @Y17XAUU 71104800
*        INPUT - R6 = OLTCB NEG. PREFIX ADDRESS              * @Y17XAUU 71105600
*                R7 = ENTRY CONTROL AREA ADDRESS             * @Y17XAUU 71106400
*                R14 = RETURN ADDRESS                        * @Y17XAUU 71107200
*        IF ENTRY IS NOT ASSIGNED RETURN IS 8(R14)           * @Y17XAUU 71108000
*                                                            * @Y17XAUU 71108800
************************************************************** @Y17XAUU 71109600
         ST    R14,RETSAVE3       SAVE RETURN ADDRESS          @Y17XAUU 71110400
         USING TOTOBPTR,R6        SET OLTCB ADDRESSABILITY     @Y17XAUU 71111200
         USING ENT,R7             SET DEV ENTRY ADDRESSABILITY @Y17XAUU 71112000
         TM    ENTFLAG1,ENTTTASN  WAS ENTRY ASSIGNED           @Y17XAUU 71112800
         BZ    D8(R14)            NO - RETURN TO CALLER        @Y17XAUU 71113600
         SLR   R1,R1              CLEAR REG                    @Y17XAUU 71114400
         IC    R1,TOTTTBEL        GET NAME LENGTH              @Y17XAUU 71115200
         L     R8,ENTTNTAD        COUNTERFEIT TNT ADDRESS      @Y17XAUU 71116000
         ALR   R8,R1              POINT TO TTE ADDRESS         @Y17XAUU 71116800
         ICM   R8,ADRMSK,D0(R8)   GET TTE ADDRESS              @Y17XAUU 71117600
         LA    R1,TRMPRFSZ        GET TTE PREFIX SIZE          @Y17XAUU 71118400
         SLR   R8,R1              POINT TO TTE PREFIX          @Y17XAUU 71119200
         USING IEDNTRM,R8         SET TTE ADDRESSABILITY       @Y17XAUU 71120000
         TM    TRMSTATE,TRMPREF   3705 RESOURCE                @Y17XAUU 71120800
         BZ    D4(R14)            NO - RETURN TO CALLER        @YM09003 71121600
         CLI   TRMTYPE,TRMLUNT    LU ENTRY                     @Y17XAUU 71122400
         BNE   D0(R14)            NO - RETURN TO CALLER        @YM09003 71123200
         SPACE                                                          71124000
*        SET UP TO REQUEST A BUFFER                            @Y17XAUU 71124800
         LA    R0,TOTWAWRK        POINT TO QWA WORK AREA       @Y17XAUU 71125600
         LA    R1,D1              REQUEST ONE BUFFER           @Y17XAUU 71126400
         L     R4,TOTAVTPT        PASS AVT ADDRESS             @Y17XAUU 71127200
         USING IEDQAVTD,R4        SET AVT ADDRESSABILITY       @Y17XAUU 71128000
         LA    R13,REGSAVE2       SET UP SAVE AREA ADDRESS     @Y17XAUU 71128800
         L     R15,RESABUF        ADDRESS OF BUF REQ RTN       @Y17XAUU 71129600
         BALR  R14,R15            GO REQUEST A BUFFER          @Y17XAUU 71130400
         LA    R13,REGSAVE        RESTORE MY SAVE AREA ADDRESS @Y17XAUU 71131200
         SPACE                                                          71132000
*        SET UP TO BUILD TERMINATE LU-LU SESSION ELEMENT       @Y17XAUU 71132800
         USING IEDREQD,R1         SET REQ ELEM ADDRESSABILITY  @Y17XAUU 71133600
         XC    IEDREQD(REQLEN),IEDREQD CLEAR BASIC PORTION     @Y17XAUU 71134400
         MVI   REQTYPE,REQLTRM    SET REQUEST TYPE             @Y17XAUU 71135200
         MVI   REQPRI,PRILUSR     SET LUS POST PRIORITY        @Y17XAUU 71136000
         MVC   REQLTNT(D2),ENTTTOFF COUNTERFEIT TTCIN          @Y17XAUU 71137000
         L     R15,AVTSAVTP       GET SAVT ADDRESS             @Y17XAUU 71138000
         USING IEDNSVTD,R15       SET SAVT ADDRESSABILITY      @Y17XAUU 71139000
         MVI   REQRPRI,PRISSOLT   SET RETURN PRIORITY          @Y17XAUU 71140000
         LA    R14,SAVTLUSQ       GET LUS QCB ADDRESS          @Y17XAUU 71140600
         DROP  R15                                             @YM08407 71141200
         STCM  R14,ADRMSK,REQQCBA PUT IN ELEMENT               @Y17XAUU 71141800
         SPACE                                                          71142400
*        SET UP TO POST ELEMENT                                @Y17XAUU 71143000
         LA    R0,TOTWAWRK        POINT TO QWA WORK AREA       @Y17XAUU 71143600
         ICM   R1,MSKHI,WAIT      SET WAIT FLAG                @Y17XAUU 71144200
         LA    R13,REGSAVE2       SET UP SAVE AREA ADDRESS     @Y17XAUU 71144800
         L     R15,RESPLRVT       ADDRESS OF POST/WAIT ROUTINE @Y17XAUU 71145400
         BALR  R14,R15            GO POST THE ELEMENT          @Y17XAUU 71146000
         LA    R13,REGSAVE        RESTORE MY SAVE AREA ADDRESS @Y17XAUU 71146600
         L     R14,RETSAVE3       RESTORE RETURN ADDRESS       @Y17XAUU 71147200
         USING IEDNSVTD,R15                                    @YM08407 71147800
         L     R15,AVTSAVTP       GET SAVT ADDRESS             @YM08407 71148400
         MVC   SCPT(D2),SAVTSCPT  SET SSCP TTCIN               @YM08407 71149000
         DROP  R15                                             @YM08407 71149600
TERMLOOP DS    0H                 BOUNDARY ALLIGNMENT          @YM08407 71150200
         SLR   R15,R15            CLEAR REG                    @YM08407 71150800
         ICM   R15,ADRMSK,TRMSIBPT SET SIB ADDRESS             @YM08407 71151400
         BZ    D0(R14)            NO SIB - RETURN TO CALLER    @YM08407 71152000
         USING IEDSIBD,R15        SET SIB ADDRESSABILITY       @YM08407 71152600
         CLC   SIBINDEX(D2),SCPT  LU-LU SESSION ENDED          @YM08407 71153200
         BE    D0(R14)            YES - RETURN TO CALLER       @YM08407 71153800
         DROP  R15                                             @YM08407 71154400
         STIMER WAIT,DINTVL=SEC05 WAIT 5 SECONDS               @YM08407 71155000
         B     TERMLOOP           CHECK AGAIN                  @YM08407 71155600
         DROP  R4                                              @Y17XAUU 71156200
         DROP  R7                                              @Y17XAUU 71156800
         DROP  R8                                              @Y17XAUU 71157400
         DROP  R6                                              @Y17XAUU 71158000
         DROP  R1                                              @Y17XAUU 71158600
         EJECT                                                          71160000
         DS    0F                                              @Y17XAUU 71210000
*        ROUTINE TO COUNTERFEIT OR CLEANUP TOTE                @Y17XAUU 71260000
*        RVT AND NAT ENTRIES                                   @Y17XAUU 71310000
*        INPUT- R1 = REQ ELEMENT                               @Y17XAUU 71360000
*               R3 = STCB ADDRESS                              @Y17XAUU 71460000
*               R7 = QCB ADDRESS                               @Y17XAUU 71510000
*               R11= DISPATCHER ADDRESS                        @Y17XAUU 71560000
*               R15= ENTRY POINT ADDRESS                       @Y17XAUU 71610000
*               R13= AVTSAVE2 ADDRESS                          @Y17XAUU 71660000
         ORG   *-8                                             @Y17XAUU 71710000
QWBSYNCH EQU   *                                               @Y17XAUU 71760000
         ORG                                                            71820000
         DC    AL1(DSPMCPL4),AL3(*-1)                          @Y17XAUU 71870000
         DROP  R11                        RELEASE              @Y17XAUU 71920000
         USING *,R12                      EST. ADDRESSABILITY  @Y17XAUU 71970000
         USING IEDQDISP,R11               EST. ADDRESSABILITY  @Y17XAUU 72020000
         USING AVTSAVE2,R13               EST. ADDRESSABILITY  @Y17XAUU 72120000
         USING IEDREQD,R10                EST. ADDRESSABILTY   @Y17XAUU 72170000
         USING ENT,R9                     EST. ADDRESSABILTY   @Y17XAUU 72220000
         LR    R12,R15            SET BASE REG                 @Y17XAUU 72260000
         LR    R10,R1             GET REQUEST ELEM ADDR        @Y17XAUU 72300000
         L     R9,REQDATA         ADDR OF DEV CONTRL INFO      @Y17XAUU 72350000
         LA    R9,AVTEZERO(R9)    CLEAR HIGH ORDER BYTE        @Y17XAUU 72400000
         LH    R1,ENTTROFF        GET REAL TTCIN               @Y17XAUU 72450000
         L     R8,AVTSAVTP        GET SEC AVT ADDR             @Y17XAUU 72500000
         LA    R8,AVTEZERO(R8)    CLEAR HIGH ORDER BYTE        @Y17XAUU 72600000
         USING IEDNSVTD,R8        EST. ADDRESSABILTY           @Y17XAUU 72650000
         L     R15,SAVTTNTX       GET ADDR OF NAT CONVERS RTN  @Y17XAUU 72700000
         BALR  R14,R15            CALL IEDIAP04                @Y17XAUU 72750000
         STCM  R15,HWRD,SUBA      SAVE NETWORK ADDR            @Y17XAUU 72800000
         STCM  R15,HWRD,ELEM      SAVE NETWORK ADDR            @Y17XAUU 72900000
*        SEPARATE NETWORK ADDRESS INTO SUBAREA AND ELEMENT     @Y17XAUU 72950000
         SLR   R5,R5              CLEAR                        @Y17XAUU 73000000
         IC    R5,SAVTSUBL        GET SUBAREA VALUE LENGTH     @Y17XAUU 73050000
         SLL   R15,AVTEZERO(R5)  SHIFT OUT SUBAREA'S ADDRESS   @Y17XAUU 73100000
        STCM  R15,HWRD,ELEM      SAVE THE RESULT               @Y17XAUU 73200000
        SLR   R15,R15            CLEAR REG                     @Y17XAUU 73250000
        ICM   R15,HWRD,ELEM      GET INTERMEDIATE RESULT       @Y17XAUU 73300000
        SRL   R15,AVTEZERO(R5)   ADJUST ELEMENT ADDRESS        @Y17XAUU 73350000
        STCM  R15,HWRD,ELEM      SAVE ELEMENT ADDRESS          @Y17XAUU 73400000
        LCR   R5,R5              NEGATE SUBAREA LENGTH         @Y17XAUU 73500000
        AL    R5,NABITLEN        GET ELEMENT BIT LENGTH        @Y17XAUU 73550000
        SLR   R15,R15            CLEAR                         @Y17XAUU 73600000
        ICM   R15,HWRD,SUBA      GET NETWORK ADDRESS           @Y17XAUU 73650000
        SRL   R15,AVTEZERO(R5)   SHIFT OUT ELEMENT ADDRESS     @Y17XAUU 73700000
        SPACE                                                           73800000
*       COUNTERFEIT RVT ENTRY                                  @Y17XAUU 73850000
        L     R6,SAVTSAT         GET SAT ADDRESS               @Y17XAUU 73900000
        USING IEDSATD,R6         EST. ADDRESSABILITY           @Y17XAUU 73950000
        BCTR  R15,R0             DECREMENT SUBAREA VALUE LEN   @Y17XAUU 74000000
        SLA   R15,MULTIPLY       GET OFFSET INTO SAT TABLE     @Y17XAUU 74100000
        ALR   R6,R15             POINT TO SAT ENTRY            @Y17XAUU 74150000
        L     R6,SATRNRVT        GET RVT ADDRESS               @Y17XAUU 74200000
        DROP  R6                 RELEASE                       @Y17XAUU 74250000
        USING IEDRVTD,R6         SET RVT ADDRESSABILITY        @Y17XAUU 74300000
         SLR   R15,R15            CLEAR                        @Y17XAUU 74400000
         ICM   R15,HWRD,ELEM      GET ELEMENT ADDRESS          @Y17XAUU 74450000
         ALR   R15,R15            MULTIPLY BY TWO              @Y17XAUU 74500000
         ALR   R6,R15             GET OFFSET INTO RVT          @Y17XAUU 74550000
         CLI   REQDATA,COUNTER    COUNTERFEIT REQUEST          @Y17XAUU 74600000
         BNE   QWBSYN20           NO DO NO COUNTERFEITING      @Y17XAUU 74700000
         MVC   RVTINDEX(D2),ENTTTOFF INSERT COUNTERFEIT TTCIN  @Y17XAUU 74750000
         DROP  R6                 RELEASE                      @Y17XAUU 74800000
         L     R6,SAVTNAT         GET NAT ADDRESS              @Y17XAUU 74850000
         USING IEDNATD,R6         SET NAT ADDRESSABILITY       @Y17XAUU 74900000
         SLR   R15,R15            CLEAR                        @Y17XAUU 75000000
         ICM   R15,HWRD,ENTTTOFF  GET COUNTERFEIT TTCIN        @Y17XAUU 75050000
         BCTR  R15,R0             DECREMENT                    @Y17XAUU 75100000
         ALR   R15,R15            GET OFFSET INTO RVT          @Y17XAUU 75150000
         ALR   R6,R15             POINT TO NAT ENTRY           @Y17XAUU 75200000
         MVC   NATODAF(D2),SUBA   GET NETWORK ADDRESS          @Y17XAUU 75300000
         B     SYNPOST            EXIT                         @Y17XAUU 75350000
         DROP  R6                 RELEASE                      @Y17XAUU 75400000
QWBSYN20 EQU   *                                                        75450000
         USING IEDRVTD,R6         GET RVT ADDR                 @Y17XAUU 75500000
         MVC   RVTINDEX(D2),ENTTROFF RESTORE REAL RVT ENTRY    @Y17XAUU 75600000
         DROP  R6                 RELEASE                      @Y17XAUU 75650000
SYNPOST  EQU   *                                                        75700000
         MVC   REQQCBA(D3),REQRQCBA GET RETURN QCB ADDRESS     @Y17XAUU 75750000
         MVC   REQPRI(D1),REQRPRI SET RETURN PRIORITY          @Y17XAUU 75800000
         XC    REQLINK(D3),REQLINK CLEAR LINK FIELD            @Y17XAUU 75850000
         LR    R1,R10             RESTORE ELEMENT ADDRESS      @Y17XAUU 75900000
         BAL   R14,DSPPOST        RETURN TO DISPATCHER         @Y17XAUX 75950000
         DROP  R10                RELEASE                      @Y17XAUU 76000000
         DROP  R12                RELEASE                      @Y17XAUU 76050000
         EJECT                                                          76100000
WBWORK01 DC    D'0'               WORK AREA                             76150000
SEC05    DC    X'F0F0F0F0F0F5F0F0' 5 SECOND WAIT               @YM08407 76200000
RETSAVE  DS    F                  SAVE AREA FOR RETURN ADDR    @Y17XAUU 76320000
PATCH    DC    CL100' '           MAINTENANCE AREA                      76370000
TOTEMH   DC    CL8'IEDTOTMH'      COMPARAND FOR TOTE MH        @Y17XAUU 76420000
LOADLIST DS    0H                 ID OF TOTE RESIDENT MODULES  @Y17XAUU 76470000
         DC    CL2'O'             I/O MANAGER                  @Y17XAUU 76520000
         DC    CL2'AB'            DATE ROUTINE                 @Y17XAUU 76620000
         DC    CL2'AJ'            $CUTEST ROUTINE              @Y17XAUU 76670000
         DC    CL2'35'            EXIO ROUTINE                 @Y17XAUU 76720000
         DC    CL2'AA'            TIME ROUTINE                 @Y17XAUU 76770000
         DC    CL2'39'            DPRINT ROUTINE - LOAD 1      @Y17XAUU 76820000
         DC    CL2'P1'            DPRINT ROUTINE - LOAD 2      @Y17XAUU 76920000
         DC    CL2'P2'            DPRINT ROUTINE - LOAD 3      @Y17XAUU 76970000
         DC    CL2'37'            CECOM ROUTINE                @Y17XAUU 77020000
         DC    CL2'28'            PLINK ROUTINE                @Y17XAUU 77070000
         DC    CL2'36'            WAITIO ROUTINE               @Y17XAUU 77120000
         DC    CL2'AC'            GRAB/$LETGO ROUTINE          @Y17XAUU 77220000
         DC    CL2'41'            CONVERT ROUTINE              @Y17XAUU 77270000
         DC    CL2'16'            GETCONFIG ROUTINE            @Y17XAUU 77320000
         DC    CL2'42'            MORECORE/FREECORE ROUTINE    @Y17XAUU 77370000
         DC    CL2'44'            HALT I/O ROUTINE             @Y17XAUU 77420000
         DC    CL2'47'            ROUTINE ROUTINE              @Y17XAUU 77490000
         DC    CL2'M2'            TRACE ROUTINE                @Y17XAUU 77560000
         DC    CL2'25'            SEND ROUTINE                 @Y17XAUU 77630000
         DC    CL2'33'            RECEIVE ROUTINE              @Y17XAUU 77700000
ENDLIST  DC    XL2'0'             END OF LIST INDICATOR        @Y17XAUU 77750000
MODNAME  DS    0CL8               LOAD MODULE NAME             @Y17XAUU 77800000
         DC    C'IEDQW'           MODULE PREFIX                @Y17XAUU 77850000
MODID    DC    CL3' '             MODULE ID                    @Y17XAUU 77900000
ATTLIST  ATTACH EPLOC=CNAME,SF=L  CONTROL PROGRAM PARAMETER LIST        78000000
*                                   USED IN EXECUTE FORM OF ATTACH      78050000
CNAME    DC    CL8'IEDQWB1'       MODULE NAME USED IN ATTACH MACRO      78100000
SECS10   DS    0D                                                       78150000
         DC    C'00001000'        TEN SECOND TIMER INTERVAL      A41582 78200000
RESSIZE  DC    H'45'              SIZE OF TOTE RESIDENT CODE   @Y17XAUU 78300000
*                                 IEDQWA - 2K                  @Y17XAUU 78350000
*                                 IEDQWA1 - 4K                 @Y17XAUU 78400000
*                                 IEDQWO - 3K                  @Y17XAUU 78450000
*                                 SERVICE ROUTINES - 36K       @Y17XAUU 78500000
*                                 ***TOTAL*** - 45K            @Y17XAUU 78600000
TNTEADLN DC    H'3'               LENGTH OF TNT ENTRY ADDRESS           78650000
*                                   FIELD                               78700000
REGSAVE  DS    18F                REGISTER SAVE AREA                    78730000
RETSAVE3 DS    F                  REG SAVE AREA                @Y17XAUU 78760000
REGSAVE2 DS    18F                SECOND SAVE AREA FOR IEDQWB  @YM07351 78790000
WBFLAGS  DC    XL1'00'            IEDQWB FLAG BYTE                      78840000
*                                                                       78890000
CNVTBL   DC    CL16'0123456789ABCDEF'  TRANSLATE TABLE                  78940000
ZERO     DC    XL3'0'             ZERO FIELD FOR COMPARE                78990000
OLTCBSZ  DC    H'3'               SIZE OF OLTCB IN BLOCKS      @Y17XAUU 79040000
NONAME   DC    CL8'0'             INDICATES NO NAME FOR CONCENTRATOR    79140000
UPPER    DC    CL8' '             USED TO CONVERT CONTROL TERMINAL      79190000
*                                   NAME TO UPPER CASE                  79240000
CHARB1   DC    CL2'B1'            USED IN ATTACH MACRO WHEN IEDQWB1     79290000
*                                   IS THE MODULE DESIRED               79340000
CHARE    DC    CL2'E '            USED IN ATTACH MACRO WHEN IEDQWE IS   79440000
*                                   THE MODULE DESIRED                  79490000
ELADDR   DC    F'0'                    ADDRESS OF BUFFER         X02004 79540000
FIX      EQU   X'02'                   PAGE FIX CODE             X02004 79590000
FREE     EQU   X'01'                   PAGE FREE CODE            X02004 79640000
*                                       BUFFER AND LCB           X02004 79740000
RQQTYPE  DC    X'00'              FLAG BYTE FOR COUNTERFEITING @Y17XAUU 79790000
COUNTER  EQU   X'FF'              COUNTERFEIT REQUEST          @Y17XAUU 79840000
NABITLEN DC    F'16'              NUMBER OF BITS IN NET ADDR   @Y17XAUU 79890000
INVTIC   DC    X'08000002'        INVALID TIC                  @Y17XAUU 79940000
K1024    DC    F'1024'            BYTE VALUE OF 1 K              S22024 79990000
ELEM     DS    H                  TO SAVE NETWORK ADDR(ELEMENT)@Y17XAUU 80040000
SUBA     DS    H                  TO SAVE NETWORK ADDR(SUBAREA)@Y17XAUU 80090000
SCPT     DS    H                  SSCP TTCIN SAVE AREA         @YM08407 80140000
WAIT     DC    X'80'              WAIT FOR POST COMPLETE FLAG  @Y17XAUU 80220000
         EJECT                                                          80270000
RESPL    RESPL                                                   S22024 80320000
         EJECT                                                          80370000
DUMTNTE  DSECT                                                          80420000
DTNTFLGS DS    BL1                TOTE TNT ENTRY FLAGS                  80520000
*                                                                       80570000
DTNTASSN EQU   X'80'              ENTRY ASSIGNED TO OLT                 80620000
         SPACE 5                                                        80670000
DEXT     DSECT                                                          80720000
DEXTCNT  DS    XL1                NUMBER OF TNT ENTRIES                 80820000
DEXTPTR  DS    AL3(0)             POINTER TO TOTE TTE QCB AREA          80870000
*                                                                       80920000
DEXTLFTR EQU   210                FACTOR FOR DETERMINING LENGTH@Y17XAUU 80980000
*                                   OF TOTE TTE/QCB/LGB AREA            81040000
         SPACE 5                                                        81120000
QEL      DSECT                                                          81180000
QELKEY   DS    C .           QUEUE ELEMENT KEY                          81240000
QELQCB   DS    AL3 .         ADDRESS OF QCB                             81300000
         DS    C                  UNUSED                                81360000
QELLINK  DS    AL3 .         ELEMENT LINK FIELD                         81420000
QELSIZE  DS    H .           ELEMENT SIZE                               81480000
*                                                                       81540000
QENDKEY  EQU   X'00' .       DUMMY LAST ELEMENT KEY                     81600000
*                                                                       81660000
EXAMINSZ EQU   12            MINIMUM EXTENDED AREA BLOCK SIZE           81720000
         SPACE 5                                                        81780000
TQCB     DSECT                                                          81840000
TQCBKEY  DS    C             QCB KEY FIELD                              81900000
TQCBLINK DS    AL3           QCB LINK FIELD                             81960000
         SPACE 5                                                        82020000
ENT      DSECT                                                          82080000
*                                                                       82140000
ENTUCBAD DS    AL2 .         UCB ADDRESS                                82200000
ENTTTOFF DS    H .           TNT ENTRY OFFSET (DUMMY)          @Y17XAUU 82260000
ENTTROFF DS    H .           TNT ENTRY OFFSET (REAL)           @Y17XAUU 82320000
ENTRSID  DS    H .           NETWORK ADDRESS                   @Y17XAUU 82380000
ENTRLN   DS    C .           RELATIVE LINE NUMBER                       82440000
ENTLCBAD DS    AL3 .         LINE CONTROL BLOCK ADDRESS                 82500000
ENTTNTAD DS    A .           TERMINAL NAME TABLE ENTRY ADDRESS          82560000
ENTTNTRL DS    A .                ADDRESS OF REAL TNT ENTRY             82620000
ENTEABLN DS    H .           EXTENDED AREA BLOCK LENGTH                 82680000
ENTFLAG1 DS    BL1 .         DEVICE FLAGS                               82740000
*                                                                       82800000
ENTTTASN EQU   X'80' .            TNT ENTRY ASSIGNED FLAG               82860000
ENTCONCN DS    CL8                NAME OF CONCENTRATOR ENTRY            82920000
*                                                                       82980000
         EJECT                                                          83040000
         TAVTD                                                          83100000
         EJECT                                                          83160000
         TDISPD                                                         83220000
         EJECT                                                          83280000
         TNATD                                                          83340000
         EJECT                                                          83400000
         TPRFD                                                          83460000
         EJECT                                                          83520000
         TRVTD                                                          83580000
         EJECT                                                          83640000
         TSATD                                                          83700000
         EJECT                                                          83760000
         TTNTD                                                          83820000
         EJECT                                                          83880000
         OLTCB POINTER=YES                                              83940000
         EJECT                                                          84000000
         TTRMD                                                          84060000
         EJECT                                                          84120000
         SPACE 5                                                        84180000
RQTNT    EQU   TOTWKSPC                                                 84240000
RQTNTERR EQU   X'FF'              ERROR RETURN CODE                     84300000
*                                                                       84360000
RQTNTENT DSECT                                                          84420000
*                                                                       84480000
RQTNTFGS DS    BL1           TNT REQUEST FLAGS                          84540000
*                                                                       84600000
RQTNTLST EQU   X'80' .            LAST ENTRY FLAG                       84660000
*                                                                       84720000
RQTNTTYP DS    BL1           TNT REQUEST ENTRY TYPE FIELD               84780000
*                                                                       84840000
RQTNTCT  EQU   X'80'                CONTROL TERMINAL ENTRY              84900000
RQTNTAP  EQU   X'40'                ALTERNATE PRINTER ENTRY             84960000
RQTNTPR  EQU   X'20'                PRIMARY TEST DEVICE ENTRY           85020000
RQTNTSC  EQU   X'10'                SECONDARY TEST DEVICE ENTRY         85080000
RQTYPANY EQU   RQTNTCT+RQTNTAP+RQTNTPR+RQTNTSC                          85140000
*                                                                       85200000
RQTNTLNT DS    H             TNT REQUEST BLOCK LENGTH                   85260000
*                                                                       85320000
RQTENLEN EQU   4                  LENGTH OF REQUEST                     85380000
*                                   ELEMENT ENTRY                       85440000
         SPACE 5                                                        85500000
CBSLPL   EQU   TOTWKSPC+4    PARAMETER LIST FOR TCAM POST               85560000
CBRQELE  EQU   TOTWKSPC+12   OPERATOR CONTROL REQUEST ELEMENT           85620000
CBRQKEY  EQU   CBRQELE            ELEMENT KEY                           85680000
CBRQQCBA EQU   CBRQELE+1          OPERATOR CONTROL QCB ADDRESS          85740000
CBRQPRI  EQU   CBRQELE+4          ELEMENT PRIORTY                       85800000
CBRQLINK EQU   CBRQELE+5          ELEMENT LINK FIELD                    85860000
CBRQVBCD EQU   CBRQELE+8          REQUEST VERB CODE                     85920000
CBRQELNG EQU   CBRQELE+9          ELEMENT LENGTH                        85980000
CBRQRLN  EQU   CBRQELE+10         RELATIVE LINE NUMBER                  86040000
CBRQRTCD EQU   CBRQELE+11         RETURN CODE                           86100000
CBRQECBA EQU   CBRQELE+12         ADDRESS OF ECB TO POST                86160000
*                                   SERVICE COMPLETE                    86220000
CBRQLADR EQU   CBRQELE+16         RESOURCE NAME                         86280000
         EJECT                                                          86340000
DCBDSECT DCBD  DSORG=TQ                                                 86400000
         EJECT                                                          86450000
         TLCBD                                                          86500000
         EJECT                                                 @Y17XAUU 86550000
         TMHTABD                                               @Y17XAUU 86600000
         EJECT                                                          86700000
         TDEBD                                                          86750000
         EJECT                                                          86800000
         TPRIOR                                                @Y17XAUU 86850000
         EJECT                                                          86900000
         TREQD                                                 @Y17XAUU 87000000
         EJECT                                                          87050000
         TSIBD                                                 @YM08407 87070000
         EJECT                                                          87090000
UCB      DSECT                                                          87120000
         IEFUCBOB                                                       87180000
         EJECT                                                          87240000
         END                                                            87300000
