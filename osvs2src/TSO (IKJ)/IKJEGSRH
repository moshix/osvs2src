SRH      TITLE 'IKJEGSRH, SERVICE ROUTINE REMOVES ACTIVEBRK POINTS'     00100002
         COPY  IKJEGSIO                                                 00104002
IKJEGSRH CSECT                     SEARCH AND REMOVAL SERVICE ROUTINE   00110002
* A75984, 75987                                                  YM2246 00120002
* A056084,095000                                               @YM00572 00130002
* C056020                                                      @YM00574 00140002
* A145100,145200                                               @YM06114 00142002
* C097972                                                      @ZA27728 00146003
         EJECT                                                          00150002
************************************************************            00200002
*                                                                       00250002
* STATUS                                                                00300002
*    CHANGE LEVEL 00, VERSION NUMBER 01, OS/VS2                         00350002
*                                                                       00400002
* FUNCTION                                                              00450002
*    SRH SEARCHS AND REMOVES WHATEVER BREAKPOINTS ARE EITHER AT         00500002
*    THE SPECIFIED ADDRESS OR WITHIN THE SPECIFIED RANGE                00550002
*    THE ADDRESS OF WHERE THE INSTRUCTION IS TO BE REPLACED IS          00600002
*    VALIDITY CHECKED AND IF THIS ADDRESS IS 'WRITTABLE' THE            00650002
*    INSTRUCTION IS PUT BACK.                                           00700002
*                                                                       00750002
* ENTRY POINTS                                                          00800002
*         IKJEGSRH - MAIN ENTRY POINT                                   00850002
*                                                                       00900002
* INPUT                                                                 00950002
*    THREE WORDS POINTED TO BY REGISTER 1.                              01000002
*    WORD 1 FLAGS 4=SEARCH ONLY, 0=SEARCH AND REMOVE, 8=SEARCH BACKUP   01050002
*    WORD 2 ADDRESS IN QUESTION (OR BEGINNING OF RANGE)                 01100002
*    WORD 3 END ADDRESS OF RANGE (OR ZERO IF NO RANGE)                  01150002
*                                                                       01200002
* OUTPUT                                                                01250002
*    1.  RETURN CODES                                                   01300002
*    *          00 - SUCCESSFUL COMPLETION OR BREAKPOINT(S) REMOVED     01350002
*    *          04 - NO BREAKPOINT FOUND                                01400002
*    *          08 - INVALID RANGE                                      01450002
*                                                                       01500002
* EXTERNAL REFERENCES                                                   01550002
*      ESATE    - ESTABLISH ABEND RECOVERY EXIT RTN (IKJEGSTA)          01600002
*                                                                       01610002
*      FREEMAIN - FREE CORE                                             01612002
*                                                                       01620002
*      IKJEGS9G - VALIDITY CHECK ADDRESS FOR WRITE ACCESS               01630002
*                                                                       01640002
*      IKJEGIO  - PRINT ERROR MESSAGES (INVOKED VIA 'IKJEGSIO'          01642002
*                 MACRO )                                               01642102
*                                                                       01644002
* EXITS,NORMAL                                                          01650002
*    RETURN TO CALLER VIA REGISTER 14                                   01700002
*                                                                       01750002
* EXITS,ERROR                                                           01800002
*    RETURN TO CALLER VIA REGISTER 14                                   01850002
*                                                                       01900002
* TABLES/WORK AREAS                                                     01950002
*    TCOMTAB -                                                          02000002
*    *    BREAKTAB - PTR TO ACTIVE BREAK ELEMENTS                       02050002
*    *    CWORKSRH - GENERAL WORK AREA FOR IKJEGSRH                     02060002
*                                                                       02100002
* ATTRIBUTES                                                            02150002
*    REENTRANT AND REFRESHABLE                                          02200002
*                                                                       02250002
* CHARACTER CODE DEPENDENCY                                             02300002
*    THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL              02350002
*    REPRESENTATION OF THE EXTERNAL CHARSRHER SET WHICH IS              02400002
*    EQUIVALENT TO THE ONE USED AT ASSEMBLY TIME. THE                   02450002
*    CODING HAS BEEN ARRANGED SO THAT REDEFINITION OF                   02500002
*    'CHARACTER' CONSTANTS, BY REASSEMBLY, WILL RESULT IN               02550002
*    A CORRECT MODULE FOR THE NEW DEFINITIONS.                          02600002
*                                                                       02650002
* NOTES                                                                 02700002
*                                                                       02750002
************************************************************            02800002
* CHANGE ACTIVITY:                                                      02810000
*    @ZA17788 - ENTRY POINT OF STAE EXIT RTN SPECIFIED INCORRECTLY      02820000
*               IN STAE MACRO NEAR LABEL 'SRHSTART'.                    02830000
************************************************************            02840000
         EJECT                                                          02850002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 02900002
*        THE FOLLOWING ARE THE EQUATES NEEDED BY THE SEARCH ROUTINE     02950002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 03000002
         SPACE                                                          03050002
*        REGISTER EQUATES                                               03100002
R0       EQU   0                   GENERAL WORK REGISTER (INPUT REG)    03150002
R1       EQU   1                   GENERAL WORK REGISTER (PARAM PASS)   03200002
R2       EQU   2                   GENERAL WORK REGISTER                03250002
R3       EQU   3                   GENERAL WORK REGISTER                03300002
R4       EQU   4                   GENERAL WORK REGISTER                03350002
R5       EQU   5                   GENERAL WORK REGISTER                03400002
R6       EQU   6                   BASE REGISTER FOR CONTROL BLOCKS     03450002
R7       EQU   7                   BASE REGISTER FOR ACTIVE Q           03500002
R8       EQU   8                   BASE REGISTER FOR TEMPORARY USE      03550002
R9       EQU   9                   BASE REGISTER FOR TCOMTAB            03600002
R10      EQU   10                  BASE REGISTER FOR SRHWORK AREA       03650002
R11      EQU   11                  EXTRA REGISTER NOT USED              03700002
R12      EQU   12                  BASE REGISTER FOR IKJEGSRH           03750002
R13      EQU   13                  POINTER TO SAVE AREA                 03800002
R14      EQU   14                  USED FOR BAL ALSO WORK REG           03850002
R15      EQU   15                  USED FOR RETURN CODES ALSO WORK REG  03900002
         SPACE                                                          03950002
N0       EQU   0                   CONSTANT 0                           04000002
N1       EQU   1                   CONSTANT 1                           04050002
N2       EQU   2                   CONSTANT 2                           04100002
N3       EQU   3                   CONSTANT 3                           04150002
N4       EQU   4                   CONSTANT 4                           04200002
N5       EQU   5                   CONSTANT 5                           04250002
N6       EQU   6                   CONSTANT 6                           04300002
N7       EQU   7                   CONSTANT 7                           04350002
N8       EQU   8                   CONSTANT 8                           04400002
N9       EQU   9                   CONSTANT 9                           04450002
N10      EQU   10                  CONSTANT 10                          04500002
N12      EQU   12                  CONSTANT 12                          04550002
N16      EQU   16                  CONSTANT 16                          04600002
N20      EQU   20                  CONSTANT 20                          04650002
N24      EQU   24                  CONSTANT 24                          04660002
N32      EQU   32                  CONSTANT 32                          04700002
N56      EQU   56                  CONSTANT 56                          04750002
N60      EQU   60                  CONSTANT 60                          04760002
N72      EQU   72                  CONSTANT 72                          04800002
N120     EQU   120                 CONSTANT 120                         04810002
****     HEXIDECIMAL EQUATES                                            04850002
HEXC0    EQU   X'C0'               HEX CONSTANT C0                      04900002
HEX0A    EQU   X'0A'               HEX CONSTANT 0A                      04950002
HEXFF    EQU   X'FF'               HEX CONSTANT FF                      05000002
HEX0C    EQU   X'0C'               HEX CONSTANT 0C                      05050002
HEX10    EQU   X'10'               HEX CONSTANT 10                      05100002
****     BINARY MASK EQUATES                                            05102002
INSTMASK EQU   B'11000000'         INSTRUCTION LENGTH MASK              05110002
         EJECT                                                          05150002
SRHSTART DS    0H                  STARTING POSITION OF SRH             05200002
         SAVE  (14,12),,*          SAVE THE CALLERS REGISTERS           05250002
         LR    R12,R15             SETUP REG 12 AS SRH'S BASE           05300002
         USING SRHSTART,R12        ESTABLISH ADDRESSIBILITY             05350002
         USING TCOMTAB,R9          ESTABLISH ADDRESSIBILITY TO TCOMTAB  05400002
         L     R15,REGSAVE6        LOAD ADDR OF NEW SAVEAREA (SRH'S)    05450002
         ST    R13,N4(R15)         PLACE ADDR USER'S SAVEAREA INTO SRH  05500002
         ST    R15,N8(R13)         PLACE ADDR OFF SAVEAREA INTO USERS   05550002
         LR    R13,R15             R13= ADDR OF NEW SAVE AREA           05600002
         L     R3,WORKAREA         POINT TO TSTCWORK            @YM0574 05602002
         USING TSTCWORK,R3         ESTABLISH ADDRESSABILITY TO TSTCWORK 05604002
         LA    R3,CWORKSRH         POINT TO CWORKSRH                    05606002
         DROP  R3                  DISCONTINUE R3 AS TSTCWORK BASE      05606402
         USING SRHWORK,R3          ESTABLISH ADDRESSABILITY TO SRHWORK  05608002
         LR    R7,R1               R7= PTR TO 3 INPUT WORDS    @YM00572 05608402
         SPACE                                                          05610002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05650002
*                                                                       05652002
*        SETUP TO INTERCEPT AN ABEND                                    05660002
*                                                                       05670002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05700002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05700402
*********  WE MUST STANDARDIZE RETURN CODES FROM THIS MODULE *****      05700502
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05700602
         XC    SRHWORK(ESTAELN),SRHWORK CLEAR ESTAE PARM LIST AREA      05700802
         L     R4,TSTSTAE          POINT TO IKJEGSTA           @ZA17788 05702800
         ESTAE (R4),PARAM=LIST,MF=(E,SRHWORK)                  @ZA17788 05704800
         LR    R1,R7               RESTORE REGISTER 1          @YM00572 05711002
         LTR   R15,R15             WAS 'ESTAE' ACCEPTED                 05712002
         BZ    SRH0020             IF R15 = 0, START SEARCHING          05712402
         STC   R15,TSTESTRC        PRESERVE ESTAE RETURN CODE>          05712502
         LA    R15,N24             INDICATE ESTAE WAS NOT ACCEPTED      05712802
         B     SRH0600             RETURN WITHOUT TRYING TO REMOVE SCB  05713202
         EJECT                                                          05728402
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05735602
*        START PROCESSING BY SAVIVG INPUT                               05742802
*        REGISTER 1 = ORGINAL INPUT                                     05750002
*        REGISTER 2 = ADDR 1 (OR BEGINNING OF RANGE)                    05800002
*        ENDRANGE   = ADDR 2 (OR END OF RANGE)                          05850002
*        REGISTER 6 = FLAGS PASSED                                      05900002
*        REGISTER 7 = ORGINAL INPUT OF R1 (ADDR OF 3 WORDS)             05950002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   06000002
         SPACE                                                          06050002
SRH0020  DS    0H                  START WITH PDE USER FIELD            06100002
         LR    R7,R1               R7= POINTER TO 3 INPUT WORDS         06150002
         LA    R7,N0(R7)           ZERO HIGH ORDER BYTE, WILL BE A FLAG 06200002
         L     R6,N0(R1)           R6= FLAGS PASSED TO ROUTINE          06250002
         L     R2,N4(R1)           R2= FLAGS PASSED TO REMOVAL          06300002
         ST    R2,BGNRANGE         SAVE FIRST ADDRESS                   06360002
         ST    R1,SAVE1            SAVE ORIGINAL INPUT PTR              06360402
         L     R1,N8(R1)           R1= SECOND ADDR IF ANY (RANGE)       06362002
         ST    R1,ENDRANGE         SAVE SECOND ADDR IF ANY              06370002
         LTR   R1,R1               DOES 2ND ADDRESS EXIST YES=RANGE     06400002
         BZ    SRH0100             NO THEREFORE SINGLE ADDR             06450002
****    WE HAVE THE SECOND ADDRESS OF THE RANGE                         06500002
****     MAKE SURE ADDR 1 IS LESS THAN ADDR 2 OF RANGE                  06550002
         USING BRKELEM,R8          SETUP ADDR'ABILITY TO BREAK ELEMENT  06600002
SRH0040  DS    0H                  VARIFY THE ADDRESS OF A RANGE        06650002
         CLC   ENDRANGE,BGNRANGE   IS THE 2ND ADDR LESS THAN FIRST      06700002
         BNL   SRH0045             NO THE RANGE IS OK                   06750002
****     ERROR CONDITION INVALID RANGE                                  06800002
         B     SRH0460             RETURN ERROR CODE 8                  06850002
****     INITIALIZE RANGE LOOP                                          06900002
SRH0045  DS    0H                  SETUP INITIAL CONDITIONS             06950002
         CH    R6,EIGHT            WAS THE FLAG AN EIGHT                07060002
         BNE   SRH0050             NO THEREFORE USE ADDR AS IS          07070002
         LA    R4,N5               R4= N5 BACKUP INDEX                  07080002
         SR    R2,R4               BACKUP START OF THE RANGE            07090002
SRH0050  DS    0H                  SETUP INITIAL CONDITIONS             07092002
         L     R8,BREAKTAB         R8= ADDR OF ACTIVE BRK POINT QUEUE   07094002
         LA    R5,BREAKTAB         INITIALIZE LOOP WITH BACK POINTER    07096002
****     BEGIN LOOP LOOKING FOR BREAKPOINTS IN THE RANGE                07100002
SRH0060  DS    0H                  START FOR SEARCH LOOP                07150002
         LTR   R1,R8               DO WE HAVE A LINK TO WORK WITH       07200002
         BZ    SRH0440             NO STOP SEARCH                       07250002
         L     R4,BRKADDR          R4=ADDR OF THIS BREAK POINT          07300002
         CR    R4,R2               IS BRKADDR GREATER THAN START OF RNG 07350002
         BL    SRH0080             NO CONTINUE WITH NEXT ELEMENT        07400002
         C     R4,ENDRANGE         IS BRKADDR LESS THAN END OF RANGE    07450002
         BH    SRH0440             OUTSIDE OF UPPER LIMIT DONE SEARCH   07500002
****     WE HAVE AN ADDRESS WITHIN THE RANGE. LINK AROUND IT AND REMOVE 07550002
****     FIRST CHECK TO MAKE SURE THE ADDR IS NOT ON EXTENDED START     07552002
         CH    R6,EIGHT            WAS THE FLAG 8 (BACKUP)              07560002
         BNE   SRH0070             NO THEREFORE REMOVE ELEMENT          07570002
         LA    R10,N5(R2)          R10= ORIGINAL START OF RANGE         07580002
         CR    R4,R10              IS INST WITHIN RANGE                 07590002
         BNL   SRH0070             YES THEREFORE REMOVE INSTR           07592002
         TM    BRKINST,INSTMASK    WHAT IS THE LENGTH OF INST           07594002
         BO    SRH0070             LENGTH IS 6 THEREFORE REMOVE IT      07596002
         BM    SRH0064             LENGTH IS 4                          07598002
         LA    R0,N1(R4)           R0= ADDR OF END OF INSTR      YM2246 07598402
         B     SRH0068             DOES THIS OVERLAP ORIG RANGE         07598502
SRH0064  DS    0H                  INCREMENT INSTR ADDR BY 4            07598602
         LA    R0,N3(R4)           R0= END OF INSTR ADDR         YM2246 07598702
SRH0068  DS    0H                  IS (R0) WITHIN THE ORIGINAL RANGE    07611502
         CR    R0,R10              END OF INSTR WITHIN RANGE            07621502
         BL    SRH0080             NO THEREFORE CONTINUE SEARCH         07623502
****     THE ELEMENT IS WITH IN A RANGE AND THEREFORE CAN BE REMOVED    07623902
SRH0070  DS    0H                  REMOVE THE LOCATED ELEMENT           07624402
         L     R8,BRKLINK          GET ADDR OF THE NEXT ELEMENT         07637202
         B     SRH0180             BRANCH TO THE REMOVAL ROUTINE        07800002
         SPACE                                                          07850002
****     CONTINUE THE SEARCH WITH THE NEXT ELEMENT                      07900002
****     SAVE THE ADDR (R5) OF THE CURRENT BRKLINK FIELD FOR RELINKING  07950002
****     UPDATE R8 TO POINT TO THE NEXT LINK                            08000002
SRH0080  DS    0H                  SAVE CURRENT LINK ADDR AND CONTINUE  08050002
         LA    R5,BRKLINK          SAVE ADDR OF PREVIOUS BRKLINK        08100002
         L     R8,BRKLINK          PLACE ADDR OF NEXT ELEMENT INTO R8   08150002
         B     SRH0060             CONTINUE THE SEARCH                  08200002
         SPACE                                                          08250002
****     WE HAVE A SINGLE ADDR MUST SEARCH FOR A MATCH                  08300002
****     SEARCH THRU Q'S FOR A MATCH OF THE SINGLE ADDRESS              08350002
SRH0100  DS    0H                  SETUP FOR SEARCH                     08400002
         L     R8,BREAKTAB         R8= ADDR OF ACTIVE BRK POINT QUEUE   08450002
         LA    R5,BREAKTAB         SAVE AS A BACK POINTER               08500002
****     BEGIN LOOP LOOKING FOR ALL ENTRIES OF THE BREAK POINT          08550002
SRH0120  DS    0H                  START FOR SEARCH LOOP                08600002
         LTR   R1,R8               DO WE HAVE A LINK TO WORK WITH       08650002
         BZ    SRH0450             NO STOP SEARCH                       08700002
         L     R4,BRKADDR          R4=ADDR OF THIS BREAK POINT          08750002
         C     R4,BGNRANGE         BRKADDR SAME AS ADDR TO BE DELETED   08800002
         BL    SRH0160             NO CONTINUE WITH NEXT ELEMENT        08850002
****     WAS SOMETHING PREVIOUSLY REMOVED IF SO RETURN CODE = 0         08900002
         BH    SRH0440             IT IS OUT OF RANGE CHECK DEFERED     08950002
         SPACE                                                          09000002
****     WE HAVE THE CORRECT BREAKELEMENT. LINK AROUND IT AND REMOVE    09050002
SRH0140  DS    0H                  REMOVE THE BREAKPOINT                09100002
         L     R8,BRKLINK          GET ADDR OF THE NEXT ELEMENT         09150002
****     R5= ADDR OF THE PREVIOUS BRKLINK THIS MUST LINK TO THE NEXT    09200002
****     BREAK ELEMENT IN THE CHAIN                                     09250002
         B     SRH0180             BRANCH TO THE REMOVAL ROUTINE        09350002
         SPACE                                                          09400002
****     CONTINUE THE SEARCH WITH THE NEXT ELEMENT                      09450002
****     SAVE THE ADDR (R5) OF THE CURRENT BRKLINK FIELD FOR RELINKING  09500002
****     UPDATE R8 TO POINT TO THE NEXT LINK                            09550002
SRH0160  DS    0H                  SAVE CURRENT LINK ADDR AND CONTINUE  09600002
         LA    R5,BRKLINK          SAVE ADDR OF PREVIOUS BRKLINK        09650002
         L     R8,BRKLINK          PLACE ADDR OF NEXT ELEMENT INTO R8   09700002
         B     SRH0120             CONTINUE THE SEARCH                  09750002
SVCERR   EQU   *                                                        09760002
         ST    R14,SAVE14          PRESERVE RETURN ADDR                 09762002
         ST    R2,SAVE2            PRESERVE REGISTER 2                  09764002
         DROP  R3                  DISCONTINUE R3 AS SRHWORK BASE       09766002
         LR    R3,R15              PLACE RETURN CODE IN REG 2           09770002
         XC    TSTIOPRM(L'TSTIOPRM),TSTIOPRM  CLEAR IO PARM LIST AREA   09780002
         IKJEGSIO SVCERR,SVC=(R2),RC=(R3),ID=SRH28,MF=(E,TSTOIPRM)      09790002
         LA    R2,N12              PLACE DEC 12 IN REG 2                09792002
         CR    R15,R2              IS RC FROM IO > DEC 12               09794002
         BH    SRH0500         IF RC FROM IO > DEC 12 RET WITH IO RC    09796002
         L     R3,WORKAREA         POINT TO TSTCWORK                    09796402
         USING TSTCWORK,R3         ESTABLISH ADDRESSABILITY TO TSTCWORK 09796802
         LA    R3,CWORKSRH         POINT TO CWORKSRH           @ZA27728 09797203
         DROP  R3                  DISCONTINUE R3 AS TSTCWORK BASE      09797602
         USING SRHWORK,R3          ESTABLISH ADDRESSABILITY TO SRHWORK  09797702
         L     R2,SAVE2            RESTORE REGISTER 2                   09798002
         L     R14,SAVE14          RESTORE R14                          09808402
         BR    R14                 GO RETURN                            09829202
         EJECT                                                          09839602
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 09850002
*   THIS SECTION OF CODE REMOVES THE ACTIVE BREAKPOINT WHOSE ADDR IS    09900002
*   IN REGISTER 1. A CHECK IS MADE TO SEE IF THE BRK PT IS OF A RANGE   09950002
*   IF SO THE ADDR STRING IS CHECKED TO SEE IF IT IS SHARED, IF IT IS   10000002
*   THEN IT IS NOT FREED.                                               10050002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 10100002
         SPACE                                                          10150002
SRH0180  DS    0H                  CHECK IF SEARCH ONLY WAS INDICATED   10200002
         CH    R6,FOUR             WHERE WE TO REMOVE THE BREAK POINT   10250002
         BNE   SRH0200             YES THEREFORE REMOVE IT              10300002
         ST    R1,N4(R7)           STORE THE ADDRESS OF THE BREAKELEMNT 10350002
         B     SRH0480             RETURN WITH RETURN CODE OF 0         10400002
         SPACE                                                          10450002
****     R8 CURRENTLY POINTS TO NEXT ELEMENT (OR ZERO)                  10460002
****     R5 CURRENTLY CONTAINS THE ADDRESS OF THE PREVIOUS BRKLINKAGE   10470002
****     R1 POINTS TO THE ELEMENT TO BE DELETED                         10480002
SRH0200  DS    0H                  REMOVAL OF THE BREAK POINT INDICATED 10500002
         ST    R8,N0(R5)           LINK AROUND ELEMENT TO BE DELETED    10510002
         LR    R8,R1               R8= ADDR OF BEARKPOINT TO BE REMOVED 10550002
         O     R7,HIGHBIT          TURN ON HIGH BIT INDICATING REMOVAL  10600002
         L     R4,BRKNAME          R4=ADDR OF ADDR STRING TO REMOVE     10650002
         L     R5,BRKCHAIN         R5= ADDR OF SUBCOMMAND CHAIN         10700002
         LR    R10,R8              R4= ADDR OF BREAKPOINT TO BE REMOVED 10750002
         TM    BRKFLGS,BRKRANGE    IS THE BREAK PT OF A RANGE           10800002
         BNO   SRH0240             NO THEREFORE FREE ADDR STRING        10850002
****     MUST CHECK IF ADDRESS STRING IS SHARED                         10900002
         L     R8,BREAKTAB         R8= ADDR OF FIRST BREAK ELEMENT      10950002
SRH0220  DS    0H                  LOOK FOR MATCH OF ADDR STRING ADDRES 11000002
         LTR   R8,R8               DO WE HAVE A BREAK ELEMENT           11050002
         BZ    SRH0240             NO MORE THEREFORE FREE ADDR STRING   11100002
         L     R1,BRKNAME          R1= ADDR OF ADDR STRING TO COMPARE   11150002
         CR    R1,R4               ARE THE 2 ADDR STRINGS EQUAL         11200002
         BE    SRH0260             THEY ARE EQUAL DO NOT FREE           11250002
         L     R8,BRKLINK          GET ADDR OF THE NEXT BRK ELEMENT     11300002
         B     SRH0220             CONTINUE LOOKING FOR MATCH           11350002
****     FREE THE ADDRESS STRING (BREAK NAME) IN THE ACTIVE BREAK POINT 11400002
SRH0240  DS    0H                  REMOVE ADDR STRING                   11450002
         LA    R1,N0(R4)           ZERO OUT ANY HIGH ORDER DATA         11500002
         LH    R4,N0(R1)           R5= LENGTH OF THE BREAKNAME          11550002
         LA    R0,N9(R4)           INCREMENT LENGTH BY 9 FOR ROUNDING   11600002
         N     R0,MASKF8           ZERO LOWER 3 BITS                    11650002
         FREEMAIN RC,LV=(0),A=(1),SP=1  FREE THE ADDR STRING            11750002
         LTR   R15,R15             IS RETURN CODE = ZERO                11760002
         BZ    SRH0260             IF ZERO, BRANCH TO SRH0260           11770002
         LA    R2,N120             GET PRESCRIBED FREEMAIN SVC NUMBER   11772002
         BAL   R14,SVCERR          GO WRITE ERROR MESSAGE               11780002
         SPACE                                                          11800002
****     FREE THE SUBCOMMAND CHAIN IF ONE EXIST'S AND IT IS NOT SHARED  11850002
SRH0260  DS    0H                  SEE IF A SUBCHAIN EXISTS             11900002
         LA    R5,N0(R5)           ZERO HIGH ORDER BYTE                 11950002
         LTR   R5,R5               CHECK IF THE SUBCHAIN EXISTS         12000002
         BZ    SRH0340             NO THEREFORE RESTORE THE INST        12050002
         L     R8,BREAKTAB         R8= ADDR OF THE ACTIVE BRK POINTS    12100002
****     THE FOLLOWING LOOP CHECK IF THE SUBCOMMAND CHAIN IS SHARED     12150002
SRH0280  DS    0H                  IS SUBCOMMAND CHAIN SHARED           12200002
         LA    R8,N0(R8)           ZERO THE HIGH ORDER BYTE             12250002
         LTR   R8,R8               IS THERE A BREAK ELEMENT             12300002
         BZ    SRH0300             NO THEREFORE REMOVE THE SUBCHAIN     12350002
         L     R1,BRKCHAIN         R1= ADDR OF SUBCHAIN TO COMPARE      12400002
         CR    R1,R5               IF EQUAL SUBCHAIN SHARED             12450002
         BE    SRH0340             EQUAL THEN RESTORE INST AND FREE     12500002
         L     R8,BRKLINK          R8= ADDR OF THE NEXT BREAK ELEMENT   12550002
         B     SRH0280             CONTINUE SEARCH FOR MATCH            12600002
         SPACE                                                          12650002
****     IS THE CURRENT COMMAND IN THE SUBCOMMAND CHAIN                 12660002
****     IF SO FREE THE CHAIN ANYWAY AND TURN ON FLUSH BIT              12670002
SRH0300  DS    0H                  CHECK IF COMMAND IS IN THE CHAIN     12700002
         L     R1,SUBCHAIN         R1= ADDR OF THE SUBCHAIN IF ANY      12750002
         LA    R1,N0(R1)           ZERO OUT HIGH ORDER BYTE             12800002
         LTR   R1,R1               DOES A SUBCHAIN CURRENTLY EXIST      12850002
         BZ    SRH0320             NO THEREFORE FREE OFF BRK CHAIN      12900002
****     A SUBCHAIN EXISTS SEE IF 'OFF' IS PART OF THE SUBCHAIN         12950002
         CLR   R1,R5               IS SUBCHAIN ADDR LESS THAN BRKCHAIN  13000002
         BL    SRH0320             YES THEREFORE FREE BRKCHAIN          13050002
         LR    R0,R5               R0= ADDR OF START OF CHAIN           13060002
         AH    R0,N0(R5)           R0= END OF BRKCHAIN ADDR             13100002
         CLR   R1,R0               IS CURRENT COMMAND WITHIN SUBCHAIN   13150002
         BNL   SRH0320             NO THEREFORE FREE THE CHAIN          13200002
         XC    SUBCHAIN,SUBCHAIN   ZERO THE SUBCOMMOAND CHAIN PTR       13202002
         OI    TSTFLGS4,TSTFLUSH   TURN ON THE FLUSH BIT                13210002
         SPACE                                                          13250002
****     FREE THE BREAK CHAIN FOUND IN BREAK ELEMENT R5= ADDR BRKCHAIN  13300002
SRH0320  DS    0H                  FREE THE BRKCHAIN                    13350002
         LA    R1,N0(R5)           ZERO OUT ANY HIGH ORDER DATA         13400002
         LH    R5,N0(R1)           R5= LENGTH OF THE BREAKNAME          13450002
         LA    R0,N10(R5)          INCREMENT LENGTH BY 10 FOR ROUNDING  13500002
         N     R0,MASKF8           ZERO LOWER 3 BITS                    13550002
         FREEMAIN RC,LV=(0),A=(1),SP=1   FREE THE ADDR STRING           13650002
         LTR   R15,R15             IS RETURN CODE = ZERO                13670002
         BZ    SRH0340             IF ZERO, BRANCH TO SRH0340           13680002
         LA    R2,N120             GET PRESCRIBED FREEMAIN SVC NUMBER   13690002
         BAL   R14,SVCERR          GO WRITE ERROR MESSAGE               13692002
         SPACE                                                          13700002
****     NOW RESTORE THE INSTRUCTION AND FREE THE BREAK ELEMENT         13750002
SRH0340  DS    0H                  RESTORE THE INST IF ANY              13800002
         LR    R8,R10              RESTORE ADDR'ABILITY TO BREAKELEMENT 13850002
****     IF ENDSW IS ON AND RUNSW IS NOT - DO NOT RESTORE INSTR         13900002
         TM    TSTFLGS1,ENDSW+RUNSW ARE THEY BOTH ON                    13950002
         BM    SRH0420             OMIT RESTORING THE INSTRUCTION       14000002
         L     R5,BRKADDR          R5= ADDROF WHERE THE INST BELONGS    14500002
         TM    TSTFLGS1,RUNSW      IF RUN DON'T VALIDITY CHECK @YM06114 14510002
         BO    SRH0400             CONTINUE PROCESSING         @YM06114 14520002
****     VALIDITY CHECK THE ADDRESS FOR WRITTABLE                       14550002
         L     R10,PPTCB           R10= ADDR OF PP TCB                  14600002
         IKJEGS9G ADDRCHK,TCBADDR=(R10),VALUE=(R5),MF=(E,(R7))          14650002
         LTR   R15,R15             A NONZERO RETURN CODE                14700002
         BZ    SRH0400             GO RESTORE THE INSTRUCTION           14750002
         CH    R15,EIGHT           COMPARE RC TO  '8'                   14750402
         BNH   SRH0420             DO NOT RESTORE THE INSTRUCTION       14750802
         B     SRH0500             RETURN WITH RC FROM SVC97            14750902
SRH0400  DS    0H                                                       14751202
         OI    TSTFLGS1,TSTFIRST   TURN ON THE ABEND SW        @YM06114 14751602
         STM   R14,R12,N12(R13)    SAVE REGS IN CASE OF AN ABEND        14752002
         MVC   N0(N2,R5),BRKINST   RESTOR THE BREAK POINT INSTR         14760002
****     FREE THE ACTIVE BREAK ELEMENT                                  14850002
SRH0420  DS    0H                  ISSUE A FREEMAIN ON THE BRK ELEMENT  14900002
         NI    TSTFLGS1,HEXFF-TSTFIRST TURN OFF THE ABEND SW            14910002
         LA    R1,N0(R8)           R1= ADDR OF BRK ELEM HIGH BYTE IS 0  14950002
         FREEMAIN RC,LV=40,A=(1),SP=1  ISSUE THE FREEMAIN               15000002
         LTR   R15,R15             IS RETURN CODE = ZERO                15010002
         BZ    SRH0430             IF ZERO, BRANCH TO SRH0260           15020002
         LA    R2,N10              GET REGULAR FREEMAIN SVC NUMBER      15030002
         BAL   R14,SVCERR          GO WRITE ERROR MESSAGE               15040002
         B     SRH0480             RETURN WITH A ZERO                   15042002
****     WE ARE DONE WITH THE ELEMENT IN QUESTION BUT IF WE ARE         15050002
****     WORKING ON A RANGE WE MUST CONTINUE                            15100002
SRH0430  DS    0H                  DETERMINE IF THERE IS A RANGE        15110002
         CLC   ENDRANGE,ZEROWORD   IS THERE A RANGE IN PROCESS          15150002
         BE    SRH0480             NO RETURN WITH A ZERO                15200002
         B     SRH0050             CONTINUE SCANNING THE RANGE          15250002
SRH0440  DS    0H                  RETURN WITH A CODE OF 4              15300002
         LTR   R7,R7               HIGH BIT ON INDICATING BRK PT REMOVE 15350002
         BM    SRH0480             BRK PT WAS REMOVED RET CODE = 0      15400002
SRH0450  DS    0H                  RETURN WITH RETURN CODE OF FOUR      15410002
         LA    R15,N4              R15= RETURN CODE 04                  15450002
         B     SRH0500             RETURN TO CALLER                     15500002
SRH0460  DS    0H                  RETURN CODE OF 08                    15550002
         LA    R15,N8              R15= RETURN CODE 08                  15600002
         B     SRH0500             RETURN TO CALLER                     15650002
SRH0480  DS    0H                  RETURN WITH A NORMAL ZERO RET CODE   15700002
         XR    R15,R15             ZERO REGISTER 15 AS RETURN CODE      15750002
SRH0500  DS    0H                  RETURN WITH AN ERROR NONZERO RET COD 15800002
         LR    R2,R15              PRESERVE RETURN CODE                 15800402
         ESTAE 0                   REMOVE SCB                           15800802
         LR    R15,R2              PLACE RETURN CODE                    15801202
SRH0600  DS    0H                  RETURN WITH RETURN CODE IN REG 15    15801602
         L     R2,WORKAREA         POINT TO TSTCWORK                    15802002
         USING TSTCWORK,R2         ESTABLISH ADDRESSABILITY TO TSTCWORK 15804002
         L     R2,CWORKSRH         POINT TO CWORKSRH                    15806002
         DROP  R2                  DISCONTINUE R2 AS TSTCWORK BASE      15808002
         USING SRHWORK,R2         ESTABLISH ADDRESSABILITY TO CWORKSRH  15808402
         MVC   ABENTAB1(N4),MISC    RESTORE OLD ABEND INFORMATION       15810002
         L     R13,N4(R13)         R13= ADDR OF CALLERS SAVE AREA       15850002
         RETURN (14,12),,RC=(15)   THIS WILL RETUNR TO THE CALLER       15900002
         DROP  R8                  RELEASE BRK'S ADDR'IBILITY           16000002
         EJECT                                                          16010002
**********************************************************************  16020002
*        THE RETRY ROUTINE AND ABEND TABLE                              16030002
**********************************************************************  16030402
         SPACE                                                          16030802
STAELIST STAE  MF=L                LIST FORM OF THE STAE                16032802
STAELN   EQU   *-STAELIST          END OF STAE EXPANSION                16034802
ADDRETRY DC    A(RETRYRTN)         ADDRESS OF THE RETRY ROUTINE         16036802
ABENDTAB DS    0H                  THE ABEND TABLE FOR STAE             16038002
         DC    X'00'               ZERO POINTER                         16038402
         DC    AL3(SRH0420)        POINTER WHERE INSTRUCTION IS REPLACE 16038802
         DC    X'FF'               END OF TABLE INDICATOR               16039702
****     THE BEGINING OF THE RETRY ROUTINE                              16039802
RETRYRTN DS    0H                  THE RETRY ROUTINE                    16039902
         L     R5,CVTPTR           R5= ADDR OF THE CVT                  16043202
         USING CVT,R5              ESTABLISH ADDR'ABILITY TO THE CVT    16045202
         L     R1,CVTTCBP          R1= ADDR OF NEW CURRENT TCB'S        16045602
         L     R5,N4(,R1)          R5= ADDR OF CURRENT TCB (TEST TCB)   16046002
         DROP  R5                  RELEASE ADDR'ABILITY TO THE CVT      16046402
         USING TCB,R5              ESTABLISH ADDR'ABILITY TO THE TCB    16046502
         L     R9,TCBTRN           R9= ADDR OF TCOMTAB (RESTORE)        16046602
         DROP  R5                  RELEASE ADDR'ABILITY TO TCB          16059902
         L     R13,REGSAVE6        R13= ADDR OF CURRENT SAVEAREA        16069902
         LM    R14,R12,N12(R13)    RESTORE ALL REGISTERS FOR SRH        16071902
         SPACE                                                          16077702
*****************************************************************       16083202
*                                                                       16083602
*  MUST TURN OFF RETRY INDICATOR BEFORE BRANCHING OUT,                  16084002
*  FOR OTHERWISE IF ANOTHER ABEND OCCURS PERCOLATION                    16084402
*  WILL TAKE PLACE                                                      16084802
*                                                                       16084902
*****************************************************************       16085602
         SPACE                                                          16087302
         NI    TSTFLGS4,HEXFF-TSTRERTN  TURN OFF RETRY INDICATOR        16088002
         TM    TSTFLGS1,TSTFIRST   ABEND 0C4 WHILE RESTORING INSTRUCTON 16088702
         BO    SRH0420             CONTINUE BY FREEING THE BREAKELEMENT 16089402
         NI    TSTFLGS1,HEXFF-TSTFIRST TURN OFF THE ABEND SWITCH        16090602
         LA    R15,N20             R15= DEC 20 (RETURN CODE)            16091002
         B     SRH0500             RETURN TO CALLER (MAINLINE)          16091102
         EJECT                                                          16095602
**********************************************************************  16100002
*        CONSTANTS USED BY THE SRH ROUTINE                              16150002
**********************************************************************  16200002
         DS    0F                  ALIGNMENT                            16250002
ZEROWORD DC    X'00000000'         ONE WORD OF 0'S                      16260002
MASKF8   DC    X'00FFFFF8'         MASK TO ZERO TOP BYTE LOWER 3 BITS   16300002
SUBPOOL1 DC    X'01000000'         SUBPOOL ONE                          16350002
HIGHBIT  DC    X'80000000'         TURNS ON THE HIGH ORDER BIT          16400002
FOUR     DC    H'04'               CONSTANT FOUR                        16402002
EIGHT    DC    H'08'               CONSTANT EIGHT                       16404002
SUPERZAP DC    50CL1'Z'            SUPERZAP PATCHING AREA               16410002
ESTAEL   ESTAE MF=L                                                     16420002
ESTAELN  EQU   *-ESTAEL                                                 16430002
LIST     IKJEGSPL RTRY=RETRYRTN,ABNTB=ABENDTAB,MODNM=IKJEGSRH,TNM=SRH   16440002
         EJECT                                                          16450002
************************************************************            16500002
**                                                        **            16550002
**                  TCOMTAB DSECT                         **            16600002
**                                                        **            16650002
************************************************************            16700002
TCOMTAB TCOMTAB                                                         16750002
         EJECT                                                          16800002
************************************************************            16850002
**                                                        **            16900002
**                     BREAKPOINT QUEUE DSECT             **            16950002
**                                                        **            17000002
************************************************************            17050002
         BRKELEM                                                        17100002
         EJECT                                                          17110002
************************************************************            17120002
**                                                        **            17130002
**                     TCB DSECT                          **            17140002
**                                                        **            17142002
************************************************************            17144002
         IKJTCB                                                         17146002
         EJECT                                                          17149902
************************************************************            17199902
**                                                        **            17209902
**                     CVT DSECT                          **            17219902
**                                                        **            17229902
************************************************************            17239902
CVT      DSECT                                                          17241902
         CVT                                                            17242002
         TSTCWORK                  TEST WORKAREA DSECT                  17242402
         SPACE                                                          17242902
*********************************************************************** 17243302
*                                                                     * 17243702
*     THIS DSECT DESCRIBES THE SRH WORK-AREA                          * 17243802
*                                                                     * 17293802
*********************************************************************** 17303802
SRHWORK  DSECT                                                          17313802
SAVE1    DS    F                   SAVE REG1                            17323802
SAVE2    DS    F                   SAVE REG2                            17333802
SAVE14   DS    F                   SAVE REG14                           17334202
BGNRANGE DS    F                   SAVE START OF RANGE ADDR             17335802
ENDRANGE DS    F                   SAVE END OF RANGE ADDR               17336202
MISC     DS    12X                 MISCELLANEOUS WRK-AREA               17337802
         EJECT                                                          17343802
         END                                                            17393802
