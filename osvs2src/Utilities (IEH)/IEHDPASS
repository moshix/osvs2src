   TITLE 'IEHDPASS --- INSURES PASSWORD PROTECTION  IEHDASDR UTILITY'   00200121
         COPY  LCGASMSW                                          SM4351 00200221
IEHDPASS CSECT                                                          00200421
*********************************************************************** 00200508
*                  FIXES THIS MODULE                                    00200608
*                     LATEST FIRST                                      00204108
*********************************************************************** 00206108
*                                                                       00206508
*FIX FOR SERVICEING 46 DSCB/TRACK   @XA21058=@YA20902=@SA80167=@ZA32596 00206699
*                                                                       00206799
*C 51000,51300                       SU32 ONLY                 @ZA25515 00206899
*A 140510-140540                     SU32 ONLY                 @ZA25515 00206999
*C 401366-401384,728000              SU32 ONLY                 @ZA25515 00207099
*                                                                       00207499
*C 037690,037700,51100,500076        MVS ONLY                  @ZA16477 00207599
*                                                                       00207699
*C 500642,500665                     MVS ONLY                  @ZA16475 00207899
*A 500646-500655                     MVS ONLY                  @ZA16475 00208099
*                                                                       00208299
*  NO DELETIONS FOR VS2-3 SU32                                 @G32DSPD 00208499
*                                                                       00208699
*C 51200,52500,446000                        @YA13331=@XA14207=@ZA11927 00208899
*A 50500-51000                               @YA13331=@XA14207=@ZA11927 00209099
*                                                                       00209299
*  SU808 CHANGES                                               @Z40RSRB 00209499
*                                                               YM7392  00209699
*        RELEASE 21 DELETIONS                                         * 00211408
*                                                         PI0134=YM5964 00214908
*                                       OX03105 = YM3060                00218408
*1193                                                            A44112 00221908
*        RELEASE 20 DELETIONS                                         * 00225408
*1010630800                                                      M6183  00228908
*1010484000-486000                                               M4979  00232408
*1010287000,290000,349000,350000                                 A32516 00235908
*1010624000                                                      A33538 00239408
*1010396000                                                      S20201 00242908
*1010631000                                                      M5900  00246408
*        RELEASE 18 DELETIONS                                           00249908
*3166452900-453000,455900-457400,480000,613300                   MC0I   00253408
*        VS2 RELEASE 4 CHANGES                                          00255908
*A138200-138400,A286400-287600,493006-493012,564000-564600,    @Z40UAY1 00256308
*A585300-585600                                                @Z40UAY1 00256708
*STATUS CHANGE LEVEL 004                                                00256908
*C146200,493060                                                @Z40UAY1 00257108
*   THIS ENDS THE CHANGES FOR @Z40UAY1                                  00257308
*0000000000                                                    @Z40RSRJ 00257708
*                                                                     * 00260408
*********************************************************************** 00262408
         EJECT                                                          00263908
*FUNCTION/OPERATION- THIS ROUTINE PERFORMS THE FUNCTION OF            * 00273608
*   CHECKING FOR PASSWORD PROTECTED AND                        @Z40RSRB 00283608
*   RACF PROTECTED DATASETS ON VOLUMES WHICH                   @Z40RSRB 00285608
*   ARE BEING ANALYZED, FORMATTED, DUMPED FROM OR TO AND RESTORED TO. * 00294008
*   IF SUCH DATA SETS ARE FOUND, THIS ROUTINE REQUIRES THAT THE       * 00300808
*   APPROPRIATE PASSWORD(S) BE PROVIDED OR THE APPROPRIATE     @Z40RSRB 00310808
*   RACF AUTHORIZATION(S) BE HELD BEFORE ALLOWING THE          @Z40RSRB 00320808
*   FUNCTION TO CONTINUE USING THE VOLUME.                            * 00321208
*     UNEXPIRED DATA SETS ARE ALSO CHECKED FOR ON THE TO DEVICE.      * 00328008
*   INSTRUCTION TO OVERRIDE SUCH DATASETS AND USE THE VOLUME          * 00334808
*   MUST APPEAR IN THE CONTROL CARD AND THE OPERATORS REPLY TO A      * 00341608
*   CONSOLE MESSAGE IN ORDER TO ALLOW THE FUNCTION TO CONTINUE.       * 00348408
*   RACF AUTHORIZATION TO BYPASS THE ABOVE SECURITY CHECKING   @G32DSPD 00358432
*   ON EACH VOLUME IS TESTED. IF NO SUCH AUTHORIZATION IS HELD @G32DSPD 00363432
*   THE SECURITY CHECKS ARE MADE.                              @G32DSPD 00368432
*                                                                     * 00375608
*ENTRY POINTS- THE ONLY ENTRY POINT IS -IEHDPASS- AND CONTROL IS      * 00382408
*   RECEIVED FROM EITHER DUMP(IEHDDUMP), RESTORE(IEHDREST), OR        * 00389208
*   FORMAT/ANALYZE(IEHDANAL).                                         * 00396008
*                                                                     * 00402808
*INPUT- POINTERS TO A WORKAREA (REGISTER 12), TO A CONTROL BLOCK      * 00409608
*   (REGISTER 10), AND TO A BUFFER AREA (REGISTER 1).                 * 00416408
*     THE DIRECT ACCESS DEVICE BEING ANALYZED, FORMATTED, RESTORED    * 00423208
*   TO AND DUMPED FROM OR TO SERVE AS INPUT TO THIS MODULE. ALSO THE  * 00430008
*   TAPE BEING DUMPED TO, IF MAGNETIC TAPE IS USED, MAY BE INPUT TO   * 00436808
*   THIS ROUTINE.                                                     * 00443608
*                                                                     * 00450408
*EXITS- NORMAL- IF NO ERROR CONDITIONS OCCUR, -IEHDPASS- RETURNS TO   * 00457208
*   THE FUNCTION (IEHDANAL, IEHDDUMP, IEHDREST) WHICH LINKED TO IT    * 00464008
*   WITH A RETURN CODE OF ZERO.                                       * 00470808
*                                                                     * 00477608
*EXITS- ERROR- IF A NORMAL ERROR CONDITION OCCURS (ONE WHICH MAY BE   * 00484408
*   DIAGNOSED) AN ERROR MESSAGE IS WRITTEN AND A RETURN CODE          * 00491208
*   GREATER THAN ZERO IS PASSED BACK TO THE FUNCTION WHICH LINKED     * 00498008
*   TO -IEHDPASS-. IF AN ABNORMAL ERROR OCCURS A RETURN CODE GREATER  * 00504808
*   THAN ZERO IS SET BUT NO MESSAGE IS WRITTEN. RETURN IS ALWAYS TO   * 00511608
*   THE FORMAT/ANALYZE, DUMP OR RESTORE MODULE.                       * 00518408
*                                                                     * 00525208
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS ENTERED FROM EITHER        * 00532008
*   IEHDDUMP, IEHDREST OR IEHDANAL. MESSAGES WILL BE FORMULATED       * 00538808
*   BY IEHDMSGB AND PRINTED BY IEHDPRNT.                              * 00545608
*                                                                     * 00552408
*TABLES/WORKAREAS- UPON ENTRY REGISTERS 10 AND 12 POINT TO A          * 00559208
*   FUNCTION BLOCK AND A WORKAREA RESPECTIVELY. THEY ARE DESCRIBED    * 00566008
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-. REGISTER 1 POINTS TO   * 00572808
*   A BUFFER AREA TO BUILD THE CHANNEL PROGRAM AND READ IN THE DSCBS. * 00579608
*                                                                     * 00586408
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                             00593208
GR0      EQU   0                                                        00600016
GR1      EQU   1                                                        00800016
GR2      EQU   2                                                        01000016
GR3      EQU   3                                                        01200016
GR4      EQU   4                                                        01400016
GR5      EQU   5                                                        01600016
GR6      EQU   6                                                        01800016
GR7      EQU   7                                                        02000016
GR8      EQU   8                                                        02200016
GR9      EQU   9                                                        02400016
GR10     EQU   10                                                       02600016
GR11     EQU   11                                                       02800016
GR12     EQU   12                                                       03000016
GR13     EQU   13                                                       03200016
GR14     EQU   14                                                       03400016
GR15     EQU   15                                                       03600016
L6       EQU   6                        VOLUME ID LENGTH       @G32DSPD 03602032
L7       EQU   7                        FUNCTION NAME LENGTH   @G32DSPD 03605032
L8       EQU   8                        MAX DDNAME LENGTH       Y02083  03610002
MESS68   EQU   68                       IEH868I MESSAGE         Y02083  03650002
SEROFFS  EQU   65                       IEH858D VOLSER OFFSET   Y02083  03700002
COPYON   EQU   1                        COPYSW=COPIES USED     @Z40RSRB 03710008
PARTIAL  EQU   0                        DUMPSW=PARTIAL DUMP    @Z40RSRB 03720008
MSG60    EQU   60                       IEH860I MSG OFFSET     @Z40RSRB 03730008
MSG64    EQU   64                       IEH864I MSG OFFSET     @G32DSPD 03740032
MESS66   EQU   66                       IEH866I MSG OFFSET     @G32DSPD 03750032
UNITOFFS EQU   25                       IEH858I UNIT-ADDR OFFSET Y02083 03760002
CHPTP    EQU   X'10'                    CHECKPOINT PROMPT ISSUED YM7392 03762002
ON       EQU   X'01'                    DONOT PROMPT OPER FOR   YM7392  03764002
*                                       UNEXPIRED DATA/SETS     YM7392  03766002
OFF      EQU   X'00'                    RESETS ON SWITCH        YM7392  03768002
JN       EQU   73                       OFFSET TO JOBNAME     @ZA16477  03769000
SN       EQU   83                       OFFSET TO STEPNAME    @ZA16477  03770000
DSIDSIND EQU   93                       FORMAT 1 DSCB OFFSET    Y02083  03780002
CHKPT    EQU   X'01'                    DSCB FLAG FOR           Y02083  03790002
*                                       CHECK/POINT RESTART D/S Y02083  03792002
BASEREG  EQU   11                                                       03800016
VSAMID   EQU   X'08'                    FORMAT 1 VSAM FLAG      YM3060  03850003
D83      EQU   83                       OFFSET TO DSORG IN F1   YM3060  03900003
*                                       DSCB.                   YM3060  03950003
         USING FUNCBLK,10                                               04000016
         USING WORK,12                                                  04200016
         USING IEHDPASS,BASEREG                                         04400016
         USING CCWBUFF,9                                                04600016
         SAVE  (14,12),T,*             SAVE REGISTERS                   04800016
         LR    BASEREG,GR15            LOAD BASE REGISTER               05000016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA11927 05050008
         DC    C'SU32'                 SU08 APPLIED            @ZA25515 05100099
         DC    C'OZ32596 '             LAST FIX THIS MODUL     @ZA32596 05130099
         DC    C'&SYSDATE'                                     @Z40RSRB 05190008
         DS    0H                                              @Z40RSRB 05240008
APARNO   LA    GR2,PASSSAVE            SAVE AREA ADDRESS       @ZA11927 05250008
         ST    GR2,8(GR13)             ADDRESS OF NEW AREA TO OLD       05400016
         ST    GR13,4(GR2)             ADDRESS OF OLD AREA TO NEW       05600016
         LR    GR13,GR2                LOAD SAVE AREA ADDRESS           05800016
         LA    GR1,0(GR1)              SELECT OUT ADDRESS ONLY IN REG   05900016
         LR    GR9,GR1                 PICK UP POINTER TO BUFFER AREA   06000016
*                                         FOR CHANNEL PROG AND DSCBS    06200016
         MVI   TSTDSCB,X'00'           CLEAR SWITCH           A@ZA32596 06210099
*********************************************************************** 06220016
*  THIS ROUTINE BUILDS THE CHANNEL PROGRAMS NEEDED TO READ IN THE     * 06240016
*     DSCBS ONE TRACK AT A TIME. THE CCWS ARE PLACED IN A VARIABLE    * 06260016
*     LENGTH BUFFER AREA WHICH IS POINTED TO BY REGISTER 1. WORK      * 06280016
*     AREAS ARE ALSO INITIALIZED.                                     * 06300016
*********************************************************************** 06320016
         USING CONSTANT,3                                               06340016
         L     GR3,IODEVCON            PICK UP POINTER TO CONSTANT AREA 06360016
         SR    GR0,GR0                 CLEAR REGISTER.                  06380016
         IC    GR0,DSCBTRK             PICK UP NUMBER DSCBS PER TRACK   06400016
         ST    GR0,DSCBNO              SAVE NUMBER DSCBS PER TRACK      06460016
         DROP  3                                                        06520016
         LR    GR15,GR0                COMPUTE ADDRESS OF               06600016
         SLL   GR15,3                     AREA TO READ DSCBS. SAVE      06800016
         LA    GR15,24(GR15)              POINTER                       07000016
         ALR   GR15,GR1                                                 07200016
         ST    GR15,DSCBPTR            SAVE POINTER TO DSCB READAREA    07400016
         LA    GR8,140                 SIZE OF ONE DSCB                 07600016
         LM    GR2,GR7,CCWLIST         PICK UP FIRST THREE CCWS         07800016
         ALR   GR4,GR1                 PUT CORRECT ADDRESS IN TIC CCW   08000016
         STM   GR2,GR5,0(GR1)          PLACE SEARCH AND TIC CCWS IN     08200016
*                                         BUFFER.                       08400016
         ALR   GR6,GR15                PUT ADDRESS OF READ IN AREA      08600016
*                                         IN READ CCW                   08800016
CCWLOOP  STM   GR6,GR7,16(GR1)         PLACE CORRECT NUMBER OF          09000016
         ALR   GR6,GR8                    READ INSTRUCTIONS IN          09200016
         LA    GR1,8(GR1)                 BUFFER WITH APPROPRIATE       09400016
         BCT   GR0,CCWLOOP                READ IN AREA ADDRESSES        09600016
         MVI   RDCNT,X'92'             INITIALIZE DUMMY CCWS.      0552 09700017
         LM    GR2,GR3,RDCNT           PICK UP LAST CCW                 09800016
         STM   GR2,GR3,16(GR1)         PLACE CCW TO POSITION TO         10000016
*                                         NEXT TRACK IN BUFFER          10200016
         ST    GR1,RDCNTAD        SAVE ADDR FOR RD CNT MODIFICATION.    10300016
         LA    GR4,CCW1                PUT CCW ADDRESS                  10400016
         ST    GR4,DCCWAD                 IN IOB                        10600016
         MVC   LASTDSCB(5),NINES       INITIALIZE FOR END OF READ DSCBS 10800016
         SR    GR5,GR5                  ZERO OUT REGISTER               11000016
         ST    GR5,SECSW               INITIALIZE SWITCHES TO ZERO      11600016
         ST    GR5,TABLEAD             INITIALIZE TABLE ADDRESS TO ZERO 11800016
         ST    GR5,TABLESIZ            INIT. GETMAIN SIZE      @G32DSPD 11900032
*********************************************************************** 12000016
*   THIS ROUTINE DETERMINES WHICH FUNCTION IS IN OPERATION            * 12200016
*     AT PRESENT. DUMP REQUIRES CHECKING BOTH THE FROM AND TO DEVICES.* 12400016
*********************************************************************** 12600016
         CLI   FUNCSW,ANALYSIS         IS FUNCTION ANALYZE              12800016
         BE    TODEV                   YES-CHECK TO DEV ONLY            13000016
         CLI   FUNCSW,FORMAT           IS FUNCTION FORMAT               13200016
         BE    TODEV                   YES-CHECK TO DEV ONLY            13400016
         CLI   FUNCSW,RESTORE          IS FUNCTION RESTORE              13600016
         BE    TODEV1                  YES-CHECK TO DEV ONLY            13800016
         CLI   FUNCSW,DUMP             IS FUNCTION DUMP                 13860016
         BNE   SETCODE                 NO-ABNORMALLY TERMINATE JOB      13920016
*********************************************************************** 14000016
*           THIS SECTION OF CODE PERFORMS RACF SECURITY CHECKING. IF  * 14005032
*  THE DUMP FROM VOLUME IS RACF DEFINED THE USER MUST HAVE READ       * 14010032
*  ACCESS IN ORDER TO DUMP THE VOLUME.                         @G32DSPD 14015032
*********************************************************************** 14020032
         L     GR7,CVTPTR          GET CVT POINTER             @G32DSPD 14025032
         USING CVT,GR7                                         @G32DSPD 14030032
         L     GR7,CVTRAC          GET RACF POINTER            @G32DSPD 14035032
         DROP  GR7                                             @G32DSPD 14040032
         LTR   GR7,GR7             RACF ACTIVE IN THE SYSTEM?  @G32DSPD 14045032
         BZ    NULRACF1            NO,SKIP CHECKING            @G32DSPD 14050032
         USING RCVT,GR7            DO CHECK IF RACF IS         @ZA25515 14051099
         TM    RCVTSTA1,RCVTDASD   CURRENT.                    @ZA25515 14052099
         BZ    NULRACF1            NO DONT RACHECK             @ZA25515 14053099
         DROP  GR7                 YES DO RACHECK              @ZA25515 14054099
         L     GR7,FUCBPTR         GET FROM UCB                @G32DSPD 14055032
         USING UCB,GR7                                         @G32DSPD 14060032
         MVC   RACVOL,UCBVOLI      PUT UCB IN PARM LIST        @G32DSPD 14065032
         RACHECK ATTR=READ,ENTITY=RACVOL,CLASS=DASDVOL,        @G32DSPD*14070032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 14075032
         CLM   GR15,B'0001',RC8   VOLID DEFINED,UNAUTHORIZED ? @G32DSPD 14080032
         BE    UNAUTHF            NOT AUTHORIZED,GO TERMINATE  @G32DSPD 14085032
         CLM   GR15,B'0001',RC4   VOLID RACF DEFINED ?         @G32DSPD 14090032
         BE    NULRACF1           NO,END RACF CHECKS           @G32DSPD 14095032
* VOLUME IS RACF DEFINED AND USER IS READ AUTHORIZED, CHECK    @G32DSPD 14100032
* FOR AUTHORIZATION TO USE CPYVOLID OPTION.                    @G32DSPD 14105032
         TM    SEQSW,CPYVOLID     'CPYVOLID' REQUESTED ?       @G32DSPD 14110032
         BZ    TAPECHK            NO,BYPASS PASSWORD CHECKS    @G32DSPD 14115032
         CLI   DEVSW,X'FF'        TO DEVICE A DA DEVICE        @G32DSPD 14116032
         BNE   TAPECHK            'CPYVOLID' IGNORED IF NOT DA @G32DSPD 14117032
         RACHECK ATTR=ALTER,ENTITY=RACVOL,CLASS=DASDVOL,       @G32DSPD*14120032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 14125032
         LTR   GR15,GR15          IS USER AUTHORIZED ?         @G32DSPD 14130032
         BZ    TAPECHK            YES,ALLOW REQUEST            @G32DSPD 14135032
*   USER NOT AUTHORIZED,RESET 'CPYVOLID' INDICATOR             @G32DSPD 14140032
         NI    SEQSW,255-CPYVOLID DISALLOW 'CPYVOLID'          @G32DSPD 14145032
         OI    FLGBYT2,CPYREJEC   INDICATE CPYVOLID DISALLOWED @G32DSPD 14146032
         BAL   GR4,UNAUTHC        GIVE DIAGNOSTIC(IEH864I)     @G32DSPD 14150032
         B     TAPECHK            OK TO BYPASS PASSWD CHECKS   @G32DSPD 14155032
NULRACF1 EQU   *                                               @G32DSPD 14160032
* END RACF FROM VOL CHECKS.                                    @G32DSPD 14165032
*                                                              @G32DSPD 14170032
*********************************************************************** 14175032
*   THIS ROUTINE SCANS THE TIOT TO DETERMINE THE AMOUNT OF CORE       * 14200016
*     NEEDED FOR THE DSNAME TABLE OF PASSWORD PROTECTED DATASETS ON   * 14300016
*     THE FROM DEVICE.                                                * 14400016
*********************************************************************** 14600016
         TM    SEQSW,FEATURE1           FROM DD HAVE RPS                14620008
         BZ    FROMDEV             NO                            S20201 14640020
         MVC   TIC+D1(L3),DCCWAD+D1  SET UP TIC ADDR             S20201 14660020
         LA    GR4,SETCCW          POINT TO RPS CCWS             S20201 14680020
         ST    GR4,DCCWAD          STORE IN IOB                  S20201 14700020
FROMDEV  EQU   *                        *                        S20201 14720020
         L     GR8,CVTPTR              PICK UP POINTER TO CVT           14800016
         USING CVT,GR8                                                  15000016
         L     GR6,CVTTCBP             PICK UP POINTER TO TCB           15200016
         L     GR6,4(GR6)                                               15300016
         L     GR7,12(GR6)             PICK UP POINTER TO TIOT          15400016
         USING TIOT,GR7                                                 15600016
         LA    GR6,DDENTRY             PICK UP ADDRESS OF FIRST DDENTRY 15800016
         ST    GR6,TIOTSAVE              IN TIOT AND SAVE               16000016
         USING DDENTRY,GR6                                              16200016
         DROP  7,8                                                      16400016
         SR    GR4,GR4                 INITIALIZE REGISTER TO ZERO      16600016
NEXTDD   CLC   TIOEDDNM(8),INCON       IS IT SYSIN                      16920016
         BE    BUMPPTR                 YES-BUMP POINTER TO NEXT ENTRY   17200016
         CLC   TIOEDDNM(8),PRINTCON    IS IT SYSPRINT                   17400016
         BE    BUMPPTR                 YES-BUMP POINTER TO NEXT ENTRY   17600016
         CLC   TIOEDDNM(8),BLANKS  IS IT BLANK                   A44112 17620021
         BE    BUMPPTR              YES MUST BE CONCATENATED DD  A44112 17640021
         SR    GR3,GR3                 PUT TIOT LENGTH IN               17680016
         IC    GR3,TIOELNGH               REGISTER                      17760016
         SH    GR3,TWENTY              CALCULATE INDEX TO LAST UCB PTR  17840016
         AR    GR6,GR3                 ADJUST DD ENTRY INDEX FOR UCB    17920016
CHECKUCB CLC   TIOEFSRT(3),FUCBPTR+1   UCB FOR FROM DEVICE?             18000016
         BNE   NEXTUCB                 NO- MORE UCBS                    18080016
ADDENTRY EX    GR5,SWITCH1             SWITCH TO REDIRECT FLOW 2ND TIME 18200016
         LA    GR4,52(GR4)             ADD TO CORE SIZE FOR GETMAIN     18400016
NEXTUCB  LTR   GR3,GR3                 MORE UCBS TO CHECK               18430016
         BE    BUMPPTR                 NO - GO GET NEXT DD ENTRY        18460016
         SH    GR3,FOUR                INDEX TO NEXT UCB                18490016
         SH    GR6,FOUR                POINT TO NEXT UCB PTR            18520016
         B     CHECKUCB                GO CHECK NEXT UCB                18550016
BUMPPTR  SR    GR3,GR3                 PUT TIOT LENGTH IN               18580016
         IC    GR3,TIOELNGH                REGISTER                     18610016
         AR    GR6,GR3                 BUMP PTR TO NEXT DD ENTRY        18640016
         L     GR0,0(GR6)              END OF TIOT REACHED              18700016
         LTR   GR0,GR0                                                  18800016
         BNE   NEXTDD                  NO-GET NEXT ENTRY                19000016
         EX    GR5,SWITCH2             SWITCH TO REDIRECT FLOW 2ND TIME 19200016
         LA    GR8,TABLEAD             YES-SET UP ADDRESS FOR GETMAIN   19800016
         ST    GR4,TABLESIZ            SAVE SIZE OF DSNAME TABLE        20000016
         GETMAIN EC,LV=(4),A=(8)       GET CORE FOR DSNAME TABLE        20200016
         LTR   GR15,GR15               CORE AVAILABLE?                  20400016
         BNE   MORECORE                NO-GO WRITE MESSAGE              20600016
*********************************************************************** 20800016
*   THIS ROUTINE CREATES A TABLE CONTAINING THE NAMES OF EVERY DATASET* 21000016
*    ON THE FROM DEVICE FOR WHICH A PASSWORD DD CARD WAS SUPPLIED.    * 21100016
*    THE CORRESPONDING DDNAME FOR EACH DSNAME IS ALSO PLACED IN THE   * 21200016
*    TABLE.                                                             21300016
*********************************************************************** 21600016
         L     GR6,TIOTSAVE            PICK UP POINTER TO TIOT DDENTRY  21800016
         LA    GR5,X'F0'               SET SWITCHES FOR 2ND TIME        22000016
*                                        SCAN OF TIOT                   22200016
         LA    GR7,DADCB               PICK UP POINTER TO DCB           22400016
         ST    GR7,DDCBAD                                               22500016
         USING IHADCB,7                                                 22600016
         MVC   OPENLD+1(3),DDCBAD+1    MOVE DCB ADDRESS TO LIST         22800016
         LA    GR2,READJFCB            PICK UP BUFFER ADDRESS TO        23000016
         ST    GR2,LIST                  READ JFCB                      23200016
         MVI   LIST,X'87'              PICK UP EXIT LIST CODE           23400016
         L     GR8,TABLEAD             PICK UP POINTER TO DSNAME TABLE  23600016
         LA    GR15,VTOCREAD           SET UP FOR BRANCH IF TABLE FULL  23800016
         BAL   GR14,NEXTDD             GO GET FIRST DDNAME FOR RDJFCB   24000016
         SR    GR6,GR3            RESET POINTER TO START DD ENTRY. 9956 24100017
         MVC   DCBDDNAM(8),TIOEDDNM    PUT DDNAME IN DCB                24200016
         MVC   0(8,GR8),DCBDDNAM       ENTER DDNAME IN TABLE            24400016
         LA    GR8,8(GR8)              BUMP POINTER TO DSNAME SLOT      24600016
         RDJFCB MF=(E,OPENLD)          READ JFCB                        24800016
         USING JFCB,2                                                   25000016
         MVC   0(44,GR8),JFCBDSNM      ENTER DSNAME IN TABLE            25200016
         MVI   JFCBTSDM,X'08'          STOP WRITE OF JFCB AT OPEN       25300016
         LA    GR8,44(GR8)             BUMP POINTER TO NEXT ENTRY SLOT  25400016
         BAL   GR15,BUMPPTR            GO GET NEXT DDNAME IF ANY        25600016
*********************************************************************** 26400016
*  THIS ROUTINE CHECKS ALL THE FORMAT 1 DATA SET LABELS ON THE FROM   * 26600016
*    DEVICE FOR PROTECTION AND LOOKS UP THE NAME OF PROTECTED DATASETS* 26800016
*     IN THE DSNAME TABLE CREATED. IF NO PASSWORD DD CARD WAS SUPPLIED* 27000016
*     FOR THE DATA SET AND IT DOES NOT APPEAR IN THE DSNAME TABLE     * 27200016
*     A MESSAGE IS WRITTEN AND A RETURN CODE OF 8 IS SET. OTHERWISE A * 27400016
*     MESSAGE IS WRITTEN TO THE OPERATOR REQUESTING THE PASSWORD      * 27600016
*     FOR EACH DATA SET, ONE AT A TIME. AN INCORRECT RESPONSE         * 27800016
*     RESULTS IN A RETURN CODE OF 8 WITH MESSAGE. A CORRECT RESPONSE  * 28000016
*     ALLOWS PROCESSING TO CONTINUE.                                  * 28200016
*********************************************************************** 28400016
VTOCREAD LR    GR5,GR8                                                  28420016
         USING UCB,GR8                                                  28440016
         L     GR8,FUCBPTR             PICK UP POINTER TO UCB           28460016
         MVC   JFCBVOLS(6),SRTEVOLI    PUT VOL/SER NO. IN JFCB          28500016
         DROP  8                                                        28520016
BACK     LA    GR8,44                  SET REGISTER TO LAST ENTRY       28540016
         SR    GR5,GR8                    FOR LOOP CONTROL              28560016
         LA    GR7,BLOCKS+180           PICK UP DCB ADDRESS             28640008
         MVI   RDCNT,X'92'              INIT RDCNT TO MULTI-TRK         28730008
         L     GR2,DCBDEBAD       PICK UP POINTER TO DEB.               28830016
         MVC   SEEKAD+1(6),36(GR2) EXTRACT LOW EXTENT FROM DEB.         28910016
REPEAT   EQU   *                                                 A32516 28980020
         ST    GR7,DDCBAD               PUT DCB ADDR IN IOB.     A32516 29050020
         L     GR6,DSCBNO         GET NO. OF DSCBS PER TRK.      A32516 29120020
         L     GR3,DSCBPTR             PICK UP POINTER TO DSCB READAREA 29200016
         CLI   RDCNT,X'12'             END OF VTOC REACHED              29260016
         BE    RESTCCWS                YES-GO CHECK TODEVICE  C@ZA32596 29320099
         CLC   SEEKAD+3(4),LASTDSCB    IS LAST F1 DSCB FINISHED         29370099
         BH    RESTCCWS                YES-GO CHECK TO DEVICE C@ZA32596 29420099
         CLC   SEEKAD+3(4),42(GR2) IS THIS LAST TRACK OF VTOC.          29680016
         BNE   GOODCCW                 NO-GO READ                       29760016
         MVI   RDCNT,X'12'             YES CHANGE RDCNT TO SINGLE TRACK 29840016
         L     GR1,RDCNTAD                                              29860016
         CLI   DSCBNO+3,X'2E'          46 DSCB/TRACK?         A@ZA32596 29880099
         BNE   ENDCCW1                 NO THEN OK             A@ZA32596 29900099
         S     GR1,EIGHT               ONE LESS 0E CCW OP     A@ZA32596 29920099
ENDCCW1  MVI   16(GR1),X'12'      SET SINGLE READ COUNT.      C@ZA32596 29940099
GOODCCW  MVC   SAVECCHH(5),SEEKAD+3    SAVE SEARCH CCHHR      A@ZA32596 29960099
         EXCP  DISKIOB                 READ A DSCB            C@ZA32596 29980099
         BAL   GR4,WAIT                AWAIT COMPLETION OF I/O          30000099
         CLI   44(GR3),X'F4'           IS DSCB A FORMAT 4               30020099
         BNE   CHECKF1                 NO-GO CHECK FORMAT 1             30040099
         CLI   TSTDSCB,X'FF'           BEEN HERE BEFORE?      A@ZA32596 30060099
         BE    OKDSCB1                 YES, BRANCH            A@ZA32596 30080099
         L     GR4,FUCBPTR             GET UCB POINTER        A@ZA32596 30100099
         CLI   19(GR4),X'0B'           3350?                  A@ZA32596 30120099
         BNE   OKDSCB1                 NO, NO ACTION          A@ZA32596 30140099
         CLI   74(GR3),X'2E'           NO OF DSCB/TRK = 46?   A@ZA32596 30160099
         BNE   OKDSCB1                 NO, NO ACTION          A@ZA32596 30180099
         MVI   TSTDSCB,X'FF'           INDICATE BEEN HERE     A@ZA32596 30200099
         L     GR4,DSTATUS             PICK UP CCW POINTER    A@ZA32596 30220099
         LA    GR4,0(GR4)              CLEARHIGH ORDER BYTE   A@ZA32596 30240099
         S     GR4,SIXTEEN             POINT TO LAST 0E-OP    A@ZA32596 30260099
         MVC   SAVECCW(16),0(GR4)      SAVE CCW (0E + 92) OP  A@ZA32596 30280099
         MVC   0(8,GR4),8(GR4)         MAKE STRING 46 0E-CCWS A@ZA32596 30300099
         MVC   SEEKAD+3(5),SAVECCHH    START READ VTOC AGAIN  A@ZA32596 30320099
         LA    GR6,46                  INDICATE 46 DSCB/TRK   A@ZA32596 30340099
         ST    GR6,DSCBNO              SAVE NO OF DSCBS       A@ZA32596 30360099
         B     GOODCCW                 REATART CCW STRING     A@ZA32596 30380099
RESTCCWS CLI   TSTDSCB,X'FF'           ANY CHANGES TO CCWS?   A@ZA32596 30400099
         BNE   TAPECHK                 NO, TEST TO-DEVICE     A@ZA32596 30420099
         MVI   TSTDSCB,X'00'           RESET SWITCH           A@ZA32596 30440099
         MVI   DSCBNO+3,X'2F'          SET 47 DSCB/TRACK      A@ZA32596 30460099
         L     GR1,DSTATUS             GET CSW POINTER        A@ZA32596 30480099
         LA    GR1,0(GR1)              CLEAR HIGH ORDER BYTE  A@ZA32596 30500099
         S     GR1,EIGHT               POINT TO LAST CCW      A@ZA32596 30520099
         MVC   0(16,GR1),SAVECCW       SAVE CCW (0E + 92)OP   A@ZA32596 30540099
         B     TAPECHK                 GO TEST TO-DEVICE      A@ZA32596 30560099
OKDSCB1  MVC   LASTDSCB(5),45(GR3)  SAVE ADDR OF LAST F1 DSCB C@ZA32596 30580099
         LA    GR3,140(GR3)            BUMP POINTER TO NEXT DSCB        30800016
         BCTR  GR6,0                   SUBTRACT 1 FROM NO. DSCBS LEFT   31000016
CHECKF1  CLI   44(GR3),X'F1'           IS DSCB A FORMAT 1               31200016
         BNE   CONTROL1                                                 31400016
         STM   GR5,GR8,PROMPTSA         SAVE WORK REG          @Z40RSGD 31410008
         TM    DSIDSIND(GR3),CHKPT      THIS A CHKPT/RSTRT DS ? Y02083  31450002
         BNO   NOCR1                    NO, BRCH                Y02083  31460002
         L     GR8,FUCBPTR              LOAD UCB REG            YM7392  31480002
         BAL   GR4,PROMPT               YES, TELL OPERATOR.     Y02083  31500002
NOCR1    EQU   *                                                Y02083  31550002
         USING F1DSCB,GR3              FORMAT 1                @Z40RSRB 31560008
         TM    DS1DSIND,F1RACDEF       RAC DEFINED             @Z40RSRB 31570008
         BO    FRRACDEF                BR IF YES TO OPEN       @Z40RSRB 31580008
         TM    93(GR3),X'14'           D/S PASSWORD PROTECTED    A46957 31650000
         BC    9,CONTROL1              NO-CONTINUE               A46957 31700000
         DROP  GR3                     DROP F1DSCB             @Z40RSRB 31720108
         LA    GR7,DADCB               PICK UP PPINTER TO DUMMY DCB TO  31750003
         ST    GR7,DDCBAD                  OPEN PASSWORD DATA SET       31800003
         TM    D83(GR3),VSAMID          VSAM DSCB ?             YM3060  31810003
         BNO   NOVSAM                   NO, CONTINUE            YM3060  31820003
         MVC   DCBDDNAM,DDNAME1         MOVE FROMDD DDNAME      YM3060  31830003
         B     VSAM1                    OPEN VSAM F1 DSCB       YM3060  31840003
NOVSAM   EQU       *                                            YM3060  31842003
         LA    GR4,52                  SET UP FOR LOOP CONTROL          31850003
         L     GR8,TABLEAD             YES-PICK UP POINTER TO TABLE     32000016
         LTR   GR8,GR8                 HAVE ENTRIES BEEN MADE IN TABLE  32060016
         BZ    NOCARD                   YES, CHECK ENTRIES      YM3060  32070003
CKTABLE  CLC   0(44,GR3),8(GR8)        IS DATA SET IN TABLE             32400016
         BE    GETPASS                 YES-GO REQUEST PASSWORD          32600016
         BXH   GR8,GR4,NOCARD          BUMP POINTER TO NEXT ENTRY       32800016
         B     CKTABLE                 CHECK NEXT TABLE ENTRY           33000016
GETPASS  MVC   DCBDDNAM(8),0(GR8)      PUT DDNAME IN DCB                33200016
VSAM1    EQU   *                                                YM3060  33250003
         L     GR2,LIST           SET UP JFCB POINTER.             0141 33300017
         MVC   JFCBDSNM,D0(GR3)        PUT DSNAME IN JFCB       YM3060  33400003
         OPEN  MF=(E,OPENLD),TYPE=J                                     33600016
         TM    DCBOFLGS,X'10'          WAS OPEN SUCCESSFUL              33800016
         BZ    BADPASS                 NO-GO TERMINATE JOB              34000016
         NI    DCBMACRF+1,X'F3'        SET BITS OFF TO STOP WRITE OF    34200016
*                                        EOF AND UPDATE OF DSCB         34400016
         CLOSE ((7))                                                    34600016
         TM    D83(GR3),VSAMID          VSAM DSCB ?             YM3060  34650003
         BO    VSAM2                    YES, DON,T SET TAPE     YM3060  34700003
*                                       SECURITY SWITCH.        YM3060  34750003
         MVI   SECSW,X'01'             SET SECURITY SWITCH              34800016
VSAM2    EQU   *                                                YM3060  34850003
         LA    GR7,BLOCKS+180       PUT DCB FROM DUMP IN IOB     A32516 34860020
         L     GR2,DCBDEBAD            OBTAIN POINTER TO DEB     A32516 34920020
         CLI   FUNCSW,DUMP             NORMAL DUMP ?           @ZM40033 34970008
         BE    CONTROL1                YES, CONTINUE           @ZM40033 35010008
         LA    GR7,BLOCKS+172          USE VER2 OFFSET         @ZM40033 35050008
CONTROL1 LA    GR3,140(GR3)            BUMP POINTER TO NEXT DSCB        35100016
         BCT   GR6,CHECKF1             SUBTRACT 1 FROM NO. DSCBS LEFT   35400016
         B     REPEAT                  READ AGAIN                       35800016
FRRACDEF EQU   *                       OPEN TO CHECK SECURITY  @Z40RSGD 35801008
*   CHECK FOR INPUT RACF AUTHORIZATION                                  35802008
         L     GR8,FUCBPTR              INPUT UCB              @Z40RSGD 35803008
         LA    GR15,ACHKTRD             REQUEST INPUT AUTH     @Z40RSGD 35804008
         LR    GR5,GR3                  DSCB ADDRESS           @Z40RSGD 35804208
         BAL   GR7,SETUPUCB             CHECK RAC AUTH         @Z40RSGD 35805008
         L     GR5,PROMPTSA             RESTORE REG 5          @Z40RSGD 35805208
         B     VSAM2                    AUTHORIZED - CONTINUE  @Z40RSGD 35806008
*********************************************************************** 36000016
*  THIS ROUTINE CHECKS TO SEE IF TO DEVICE IS TAPE AND IF SOURCE      * 36030016
*    DIRECT ACCESS DEVICE HAS PASSWORD PROTECTED DATASETS. IF SO      * 36060016
*    THE SWITCH WHICH INDICATES STANDARD LABEL, PASSWORD PROTECTED    * 36090016
*    TAPE WITH BLANK OR ZERO SEQUENCE NUMBER MUST BE ON FOR           * 36120016
*    PROCESSING TO CONTINUE. OTHERWISE JOB IS TERMINATED WITH MESSAGE.* 36150016
*********************************************************************** 36200016
TAPECHK  CLI   DEVSW,X'00'             IS TO DEVICE TAPE                36500016
         BNE   DADEV                   NO- GO CHECK DIRECT ACCESS       36800016
         CLI   SECSW,X'01'             YES-IS SECURITY SWITCH ON        37200016
         BNE   RELEASE                 NO-GO RETURN TO PROCESSING       37400016
         TM    SWITCH,PASSSW           YES-IT THIS STANDARD LABEL       37600016
*                                          PASSWORD PROTECTED TAPE      37800016
*                                          WITH SEQ NO = BLANK OR ZERO  37900016
         BO    RELEASE                 YES-GO RETURN TO PROCESSING      38000016
         LA    GR1,35                  TAPE NOT SL AND PROTECTED        38200016
         BAL   GR5,MSGBLD              GO BUILD MESSAGE                 38300016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    38400016
         B     MSGPRNT                 GO PRINT MESSAGE                 38500016
*********************************************************************** 38600016
*  THIS ROUTINE CHECKS ALL FORMAT 1 DATA SET LABELS ON A DA DEVICE    * 38610016
*    FOR EXPIRATION AND FOR PROTECTION. IF AT LEAST ONE UNEXPIRED     * 38620016
*    DATA SET IS ENCOUNTERED AND EITHER THE PURGE OPTION IS NOT       * 38630016
*    SPECIFIED BY THE USER OR THE PURGE OPTION IS SPECIFIED BUT THE   * 38640016
*    OPERATOR REQUESTS TERMINATION OF THE JOB IN RESPONSE TO A WTOR   * 38650016
*    MESSAGE, AN ERROR MESSAGE IS WRITTEN AND A RETURN CODE OF 8 IS   * 38660016
*    SET.                                                             * 38670016
*  OTHERWISE THE DATA SET IS CHECKED FOR PROTECTION. THE PASSWORD FOR * 38680016
*    A PROTECTED DATA SET MUST BE SUPPLIED IF THE DATA SET IS TO BE   * 38690016
*    SCRATCHED AND THE VOLUME USABLE.                                 * 38700016
*********************************************************************** 38800016
         USING COPYBLK,6                                                38900016
DADEV    CLI   DEVSW,X'FF'             IS TO DEVICE DIRECT ACCESS       39000016
         BNE   DUMPFUNC                NO-GO CHECK FOR DUMP FUNCTION    39100016
TODEV1   LA    GR7,BLOCKS+44           PICK UP POINTER TO DCB/RESTORE   39400016
         B     TODEV2              GO TO PROCESS                 S20201 39600020
TODEV    LA    GR7,FBLOCKS             PICK UP POINTER TO DCB/FORMAT    39800016
*                                         AND ANALYSIS                  40000016
TODEV2   EQU   *                        *                        S20201 40010020
         LA    GR4,CCW1            RESET PTR IN                  S20201 40020020
         ST    GR4,DCCWAD          IOB                           S20201 40030020
         TM    SEQSW+D1,FEATURE    TODD HAVE RPS                 S20201 40040020
         BZ    GOAHEAD             NO                            S20201 40050020
         MVC   TIC+D1(L3),DCCWAD+D1  SET UP TIC ADDR             S20201 40060020
         LA    GR4,SETCCW          POINT TO RPS CCWS             S20201 40070020
         ST    GR4,DCCWAD          STORE IN IOB                  S20201 40080020
GOAHEAD  EQU   *                                                 S20201 40090020
VREAD    ST    GR7,DDCBAD              PUT DCB ADDRESS IN IOB           40100016
*********************************************************************** 40103032
*    THIS SECTION OF CODE PERFORMS RACF AUTHORIZATION CHECKS ON THE   * 40106032
*  'TO' VOLUME. IF THE VOLUME IS RACF DEFINED THE USER MUST HAVE      * 40109032
*  ALTER ACCESS TO THE VOLUME BEFORE DUMP,RESTORE,ANALYZE OR FORMAT   * 40112032
*  WILL BE ALLOWED.                                         @G32DSPD  * 40115032
*********************************************************************** 40118032
         L     GR3,CVTPTR              GET CVT POINTER         @G32DSPD 40121032
         USING CVT,GR3                                         @G32DSPD 40124032
         L     GR3,CVTRAC              GET RACF POINTER        @G32DSPD 40127032
         DROP  GR3                                             @G32DSPD 40130032
         LTR   GR3,GR3                 RACF ACTIVE IN SYSTEM   @G32DSPD 40133032
         BZ    NULRACF2                NO,SKIP CHECKS          @G32DSPD 40136032
         USING RCVT,GR3                DO CHECK IF RACF IS     @ZA25515 40136699
         TM    RCVTSTA1,RCVTDASD       CURRENT.                @ZA25515 40137299
         BZ    NULRACF2                NO DONT RACHECK         @ZA25515 40137899
         DROP  GR3                     YES DO RACHECK          @ZA25515 40138499
* GET VOLID FROM UCB. FIRST DETERMINE IF 'TO' OR 'COPY ' UCB.  @G32DSPD 40139032
         L     GR8,TUCBPTR             GET 'TO' UCB            @G32DSPD 40142032
         TM    COPYSW,COPYON           WORKING ON A COPY ?     @G32DSPD 40145032
         BZ    NOTCPY                  NO, KEEP 'TO' UCB       @G32DSPD 40148032
         L     GR8,CUCBPTR             YES,GET 'COPY' UCB      @G32DSPD 40151032
         USING UCB,GR8                                         @G32DSPD 40154032
NOTCPY   MVC   RACVOL,UCBVOLI          GET VOLID               @G32DSPD 40157032
         DROP  GR8                                             @G32DSPD 40160032
         RACHECK  ATTR=ALTER,ENTITY=RACVOL,CLASS=DASDVOL,      @G32DSPD*40163032
               VOLSER=0,MF=(E,RACKPRM)                         @G32DSPD 40166032
         CLM   GR15,B'0001',RC8        UNAUTHORIZED ?          @G32DSPD 40169032
         BE    UNAUTHT                 UNAUTHORIZED,GO END     @G32DSPD 40172032
         LTR   GR15,GR15               DEFINED AND AUTHORIZED? @G32DSPD 40175032
         BZ    CKMOREDD                YES,SKIP PASSWORD CHECKS@G32DSPD 40178032
*      IF 'TO VOL' IS NOT DEFINED TO RACF,CHECK PASSWORDS.     @G32DSPD 40181032
*  END 'TO VOL' RACF SECURITY CHECKS.                          @G32DSPD 40184032
         SPACE 2                                               @G32DSPD 40187032
NULRACF2 EQU   *                                               @G32DSPD 40190032
         MVC   LASTDSCB(5),NINES       INITIALIZE FOR END OF READ DSCB  40200016
         MVI   RDCNT,X'92'             INITIALIZE RDCNT TO MULTI-TRACK  40250016
         L     GR1,RDCNTAD                                              40260016
         MVI   16(GR1),X'92'      RESET RD CNT FOR MULTI-TRK.           40270016
         L     GR3,DCBDEBAD            PICK UP POINTER TO DEB           40300016
         MVC   SEEKAD+1(6),36(GR3)     EXTRACT LOW EXTENT FROM DEB      40400016
REPEAT2  L     GR2,DSCBNO              PICK UP NUMBER DSCBS PER TRACK   40600016
         L     GR5,DSCBPTR             PICK UP POINTER TO DSCB READAREA 40800016
         CLI   RDCNT,X'12'             END OF VTOC REACHED              40860016
         BE    OKCCWS                 YES-GO CHECK FOR COPIES C@ZA32596 40920099
         CLC   SEEKAD+3(4),LASTDSCB    IS LAST F1 DSCB FINISHED         40970099
         BH    OKCCWS                 YES-GO CHECK FOR COPIES C@ZA32596 41020099
         CLC   SEEKAD+3(4),42(GR3)     IS THIS LAST TRACK OF VTOC       41280016
         BNE   CCWOK                   NO-GO READ                       41360016
         MVI   RDCNT,X'12'             YES CHANGE RDCNT TO SINGLE TRACK 41440016
         L     GR1,RDCNTAD                                              41460016
         CLI   DSCBNO+3,X'2E'          VTOC HAS 46 DSCB/TRK   A@ZA32596 41480099
         BNE   ENDCCW2                 NO THEN OK             A@ZA32596 41500099
         S     GR1,EIGHT               ONE LESS 0E-OP CCW     A@ZA32596 41520099
ENDCCW2  MVI   16(GR1),X'12'           SET SINGLE READ COUNT. C@ZA32596 41540099
CCWOK    MVC   SAVECCHH(5),SEEKAD+3    SAVE SEARCH CCHHR      A@ZA32596 41560099
         EXCP  DISKIOB                 READ A DSCB            C@ZA32596 41580099
         BAL   GR4,WAIT                AWAIT COMPLETION OF I/O          41600099
         CLI   44(GR5),X'F4'           IS DSCB A FORMAT 4               41620099
         BNE   F1CHECK                 NO-GO CHECK FORMAT 1             41640099
         CLI   TSTDSCB,X'FF'           BEEN HERE BEFORE?      A@ZA32596 41660099
         BE    OKDSCB2                 YES THEN BRANCH        A@ZA32596 41680099
         L     GR4,TUCBPTR             GET UCB POINTER        A@ZA32596 41700099
         CLI   19(GR4),X'0B'           3350?                  A@ZA32596 41720099
         BNE   OKDSCB2                 NO, NO ACTION          A@ZA32596 41740099
         CLI   74(GR5),X'2E'           ACTUAL NO OF DSCB =46? A@ZA32596 41760099
         BNE   OKDSCB2                 NO, NO ACTION          A@ZA32596 41780099
         MVI   TSTDSCB,X'FF'           INDICATE BEEN HERE     A@ZA32596 41800099
         L     GR4,DSTATUS             PICK UP CCW POINTER    A@ZA32596 41820099
         LA    GR4,0(GR4)              CLEAR HIGH ORDER BYTE  A@ZA32596 41840099
         S     GR4,SIXTEEN             POINT TO LAST 0E CCW   A@ZA32596 41860099
         MVC   SAVECCW(16),0(GR4)      SAVE CCW (0E + 92) OP  A@ZA32596 41880099
         MVC   0(8,GR4),8(GR4)         MAKE STRING 46 0E-CCWS A@ZA32596 41900099
         MVC   SEEKAD+3(5),SAVECCHH    INDICATE START VTOC    A@ZA32596 41920099
         LA    GR2,46                  INDICATE 46 DSCB/TRACK A@ZA32596 41940099
         ST    GR2,DSCBNO              SAVE NO OF DSCBS       A@ZA32596 41960099
         B     CCWOK                   RESTART CCW-STRING     A@ZA32596 41980099
OKCCWS   CLI   TSTDSCB,X'FF'           ANY CHANGES TO CCWS?   A@ZA32596 42000099
         BNE   CKMOREDD                NO, THEN CHECK COPIES  A@ZA32596 42020099
         MVI   TSTDSCB,X'00'           RESET SWITCH           A@ZA32596 42040099
         MVI   DSCBNO+3,X'2F'          SET 47 DSCB/TRK        A@ZA32596 42060099
         L     GR1,DSTATUS             GET CSW POINTER        A@ZA32596 42080099
         LA    GR1,0(GR1)              CLEAR HIGH ORDER BYTE  A@ZA32596 42100099
         S     GR1,EIGHT               POINT TO LAST CCW      A@ZA32596 42120099
         MVC   0(16,GR1),SAVECCW       SAVE CCW (0E + 92) OP  A@ZA32596 42140099
         B     CKMOREDD                ALL OK, CHECK COPIES   A@ZA32596 42160099
OKDSCB2  MVC   LASTDSCB(5),45(GR5)  SAVE ADDR OF LAST F1 DSCB C@ZA32596 42180099
         LA    GR5,140(GR5)            BUMP POINTER TO NEXT DSCB        42400016
         BCTR  GR2,0                   SUBTRACT 1 FROM NO. DSCBS LEFT   42600016
F1CHECK  CLI   44(GR5),X'F1'           IS DSCB A FORMAT 1               42800016
         BNE   CONTROL2                                                 43000016
         TM    WTORSW,ON                WRITE TO OPER SWITCH ON  YM7392 43200002
         BO    SCRATCH                 YES-GO SCRATCH DATA SET   YM7392 43400002
               TIME                                                     43600016
         LR    GR0,GR1                 PUT DATE IN REGISTER 0           43660016
         XC    DATE(8),DATE            CLEAR OUT DATE AREA              43720016
         STH   GR0,DATE+6              ISOLATE DAY                      43780016
         SRDL  GR0,4                   SAVE ZONE IN REGISTER 1          43840016
         SRL   GR0,12                  ISOLATE YEAR                     43900016
         SLDL  GR0,4                   PUT ZONE ON YEAR                 43960016
         CVB   GR4,DATE                CONVERT DAY                      44020016
         STH   GR0,DATE+6              PUT YEAR IN FIELD                44080016
         CVB   GR1,DATE                CONVERT YEAT                     44140016
         STH   GR4,DATE+6              SAVE DAY                         44200016
         STC   GR1,DATE+5              SAVE YEAR                        44260016
         CLC   56(3,GR5),DATE+5        DATA SET EXPIRED                 44360016
         BNH   SCRATCH                 YES-GO SCRATCH DATA SET @ZA11927 44600008
         TM    SEQSW+1,PURGE           NO-PURGE REQUESTED?              44800016
         BZ    UNEXPIRE                NO-GO TERMINATE JOB              45000016
         OI    WTORSW,ON                SET WTOR SWITCH         YM7392  45200002
         CLI   COPYSW,X'01'            IS THIS COPIES                   45210016
         BNE   SKIP1                   NO-GO PICK UP UCB POINTER        45220016
         L     GR8,CUCBPTR             PICK UP POINTER TO COPY UCB      45230016
         B     CONTINUE                                                 45240016
SKIP1    L     GR8,TUCBPTR             PICK UP POINTER TO UCB           45250016
         USING UCB,GR8                                                  45260016
CONTINUE EQU   *                                                        45270002
PASSBY   MVC   TRYAGAIN+55(6),SRTEVOLI  PUT VOL-SER IN WTOR        MC0I 45300018
PASSBY1  MVC   TRYAGAIN+24(3),UCBNAME   PUT CH-UNIT ADDRESS IN WTORMC0I 45320018
         DROP  GR8                                                      45350016
         L     GR8,CVTPTR              PICK UP POINTER TO CVT           45380016
         USING CVT,GR8                                                  45410016
         L     GR8,CVTTCBP             PICK UP POINTER TO TCB           45440016
         L     GR8,4(GR8)                                               45470016
         DROP  8                                                        45500016
         L     GR8,12(GR8)             PICK UP POINTER TO TIOT          45530016
         USING TIOT,GR8                                                 45560016
         MVC   TRYAGAIN+63(8),TIOCNJOB  SAVE JOBNAME AND STEPNAME  MC0I 45600018
         MVC   TRYAGAIN+73(16),TIOCSTEP      IN WTOR MESSAGE       MC0I 45640018
TRYAGAIN WTOR  'IEH807D       HAS UNEXPIRED DATA SETS,       ,         X45680003
                        ,                 .',REPLY,1,DISKECB,      MC0IX45720018
               ROUTCDE=(4),DESC=(2)                                MC0I 45760018
WTREPLY  TM    DISKECB,COMPLETE        IS OPERATION COMPLETE            45800016
         BO    OKAY                    YES-GO CLEAR BITS                46000016
         WAIT  ECB=DISKECB             N/-WAIT FOR REPLY                46200016
OKAY     MVI   DISKECB,0               CLEAR POSTED BITS IN ECB         46400016
         CLI   REPLY,X'E4'             DOES REPLY INDICATE USE          46600016
         BE    SCRATCH                 YES-GO SCRATCH DATA SET          46800016
         CLI   REPLY,X'E3'             NO-DOES REPLY INDICATE TERMINATE 47000016
         BNE   NEWREPLY                NO-OPERATOR ERROR                47200002
UNEXPIRE LA    GR1,37                  UNEXPIRED DATASET ON TODD        47400016
         B     ERRORT                                                   47600016
NEWREPLY MVC   FILLIN+55(8),TIOCNJOB   PUT JOBNAME AND STEPNAME IN      47700016
         MVC   FILLIN+65(16),TIOCSTEP       WTO MESSAGE                 47800016
FILLIN   WTO   'IEH808I REPLY IN ERROR. REPLY WITH "U" OR "T",         C47900016
               ,                 .',ROUTCDE=(4),DESC=(5)           MC0I 48000018
         B     TRYAGAIN                 RE-ISSUE MSG                    48200002
         EJECT                                                          48200103
SCRATCH  EQU   *                                                Y02083  48210002
         TM    DSIDSIND(GR5),CHKPT      THIS A CHKPT/RSTRT DS ? Y02083  48250002
         BZ    NOCR2                    NO, BRCH                Y02083  48252002
         STM   GR5,GR8,PROMPTSA         SAVE WORK REG           Y02083  48256002
         L     GR8,TUCBPTR              GET TODD UCB ADDR       YM7392  48258002
         CLI   COPYSW,ON                COPIES ?                YM7392  48258402
         BNE   NOCR2A                   NO                      YM7392  48258802
         L     GR8,CUCBPTR              GET COPY UCB ADDR       YM7392  48259202
NOCR2A   EQU   *                                                YM7392  48259602
         BAL   GR4,PROMPT               YES, TELL OPERATOR.     Y02083  48260002
         SPACE 1                                                        48262002
NOCR2    EQU   *                                                Y02083  48270002
         USING F1DSCB,GR5               FORMAT 1               @Z40RSRB 48270508
         TM    DS1DSIND,F1RACDEF        RAC DEFINED            @Z40RSRB 48271008
         BZ    TONOTRAC                 BR IF NO               @Z40RSRB 48271508
         TM    DS1DSORG+D1,VSAMID       VSAM DSCB              @Z40RSRB 48272008
         BO    PR010                    BR IF YES TO OPEN      @Z40RSRB 48272508
         CLI   FUNCSW,RESTORE           DUMP/RESTORE FUNCTION  @Z40RSRB 48273008
         BH    RACCHKTO                 BR IF NO TO RACHECK    @Z40RSRB 48273508
         LA    GR15,ACHKTUPD            REQUEST UPDATE AUTH    @Z40RSGD 48273708
         CLI   DUMPSW,PARTIAL           PARTIAL DUMP/RESTORE   @Z40RSRB 48274008
         BE    RACCHKT2                 BR IF YES TO OPEN      @Z40RSRB 48274508
RACCHKTO EQU   *                        RACHECK DATASET NAME   @Z40RSRB 48275008
         LA    GR15,ACHKTALT            REQUEST ALTER AUTH     @Z40RSGD 48275208
RACCHKT2 EQU   *                        CHECK FOR COPY         @Z40RSGD 48275408
         LA    GR7,CONTROL2             RETURN IF SUCESSFUL    @Z40RSGD 48275708
         CLI   COPYSW,COPYON            WORKING ON COPY        @Z40RSRB 48276908
         BNE   GETOUCB2                 BR IF NO               @Z40RSRB 48277208
         L     GR8,CUCBPTR              GET COPY 'TO' UCB      @Z40RSRB 48277508
         B     SETUPUCB                 BR TO MOVE VOLSER      @Z40RSRB 48277808
GETOUCB2 EQU   *                        NOT COPY               @Z40RSRB 48278108
         L     GR8,TUCBPTR              GET 'TO' UCB           @Z40RSRB 48278408
SETUPUCB EQU   *                        MOVE VOLSER FOR RAC    @Z40RSRB 48278508
         USING UCB,GR8                  ADDRESS UCB            @Z40RSRB 48279008
         MVC   RACVOL,SRTEVOLI          MOVE VOLSER            @Z40RSRB 48279508
         RACHECK ENTITY=DS1DSNAM,MF=(E,RACKPRM), ALTER OWNER   @G32DSPD*48280032
               VOLSER=RACVOL,                                  @G32DSPD*48280332
               CLASS=DATASET,ATTR=(GR15) OF DATASET CHECKED    @Z40RSGD 48280632
         LTR   GR15,GR15                ALTER OWNER            @Z40RSRB 48281008
         BZR   GR7                      BRANCH IF YES          @Z40RSRB 48281508
         LA    GR1,MSG60                IEH860I MSG            @Z40RSRB 48282008
         BAL   GR5,MSGBLD               BUILD MSG              @Z40RSRB 48282508
*   PUT DDNAME IN MESSAGE                                      @Z40RSGD 48283008
         LA    GR5,DDNAME1              ASSUME IT IS FROM VOL  @Z40RSGD 48283408
         CLI   ACHKFLG2-ACHKLIST+RACKPRM,ACHKTRD IS IT FROM    @G32DSPD 48283932
         BE    MVDDN2                   YES-FROM VOLUME        @Z40RSGD 48289208
         LA    GR5,DDNAME2              ASSUME TO VOLUME       @Z40RSGD 48290408
         CLI   COPYSW,COPYON            IS IT A COPY VOL       @Z40RSGD 48290808
         BNE   MVDDN2                   NO-TO VOLUME           @Z40RSGD 48291608
         LA    GR5,DDNAME3              MUST BE COPY VOLUME    @Z40RSGD 48292808
MVDDN2   EQU   *                        DDNAME2 TO MSG         @Z40RSRB 48294008
         MVC   D0(L'DDNAME2,GR1),0(GR5) DDNAME TO MSG          @Z40RSGD 48295208
         B     GO                       PRINT MSG              @Z40RSRB 48296408
TONOTRAC EQU   *                        NOT RAC PROTECTED      @Z40RSRB 48297608
         DROP  GR5,GR8                                         @Z40RSRB 48298808
         TM    93(GR5),X'10'            IS IT PASSWORD PROTECTED M4979  48300002
         BZ    CONTROL2                 NO - DONT CHECK          M4979  48400020
         SPACE 1                                                        48410002
         TM    D83(GR5),VSAMID          VSAM DSCB ?             YM5964  48450002
         BO    PR010                    YES-GO TO OPEN          YM5964  48500002
         CLI   COPYSW,X'01'            COPIES BEING USED                48620016
         BNE   SKIP2                   NO-GO GET UCB POINTER            48640016
         L     GR8,CUCBPTR             PICK UP POINTER TO UCB           48660016
         B     ONWARD                                                   48680016
SKIP2    L     GR8,TUCBPTR             PICK UP POINTER TO UCB           48700016
         USING UCB,GR8                                                  48720016
ONWARD   EQU   *                                                        48810002
PASSOVER MVC   VOLIST+6(6),SRTEVOLI    PUT VOL-SER IN LIST              48990016
PASS     MVC   VOLIST+2(4),UCBTYP      PUT DEVICE TYPE IN LIST          49080016
         SR    GR0,GR0                 ZERO OUT REGISTER                49200016
         ST    GR5,PARMLIST+4          PROVIDE CURRENT DSCB FOR SCRATCH 49300016
         CLI   FUNCSW,RESTORE          IS FUNCTION DUMP/RESTORE US03168 49300608
         BH    PR040                    NO-CONTINUE             US03168 49302608
         CLI   DUMPSW,X'00'             YES, IS IT PARTIAL              49304608
         BNE   PR040                    NO-CONTINUE             US03168 49308003
         SPACE 1                                                        49309003
PR010    EQU   *                                                US03168 49310003
         LA    GR1,DADCB                LOAD DCBADDRS           US03168 49310203
         DROP  GR2,GR7                                          US03168 49310403
         USING IHADCB,GR1                                       US03168 49310603
         ST    GR1,OPENLD               PUT DCB ADDRS IN PARM   US03168 49311003
         MVI   OPENLD,X'8F'             SET END PARM FLAG       YM05997 49311202
         MVC   DCBDDNAM,DDNAME2         MOVE PRIME TO DDNAME    US03168 49311403
         CLI   COPYSW,X'01'             IS COPY SWITCH ON       US03168 49311603
         BNE   PR020                    NO-BRANCH OVER          US03168 49311803
         MVC   DCBDDNAM,DDNAME3         MOVE COPY TO DDNAME     US03168 49314003
PR020    EQU   *                                                US03168 49314203
         LA    GR0,READJFCB             ADDRS OF JFCB           US03168 49316003
         ST    GR0,LIST                 STORE IN PARM LIST      US03168 49318003
         MVI   LIST,X'87'               SET END INDICATOR       US03168 49320003
         RDJFCB MF=(E,OPENLD)           READ IN JFCB            US03168 49322003
         LA    GR1,READJFCB             ADDRS OF JFCB           US03168 49324003
         USING JFCB,GR1                                         US03168 49326003
         MVI   JFCBTSDM,X'08'           PREVENT JFCB WRITE-BACK US03168 49326103
         SPACE 1                                                        49336003
         MVC   JFCBDSNM,D0(GR5)         MOVE DSNAME TO JFCB     US03168 49340003
         OPEN  MF=(E,OPENLD),TYPE=J     OPEN DATASET            US03168 49342003
         LA    GR1,DADCB                LOAD DCB ADDRS          US03168 49344003
         USING IHADCB,GR1                                       US03168 49346003
         TM    DCBOFLGS,X'10'           WAS OPEN SUCCESSFUL     US03168 49348003
         BO    PR030                    YES-CONTINUE            US03168 49350003
         LA    GR1,36                   NO-SET ERROR CODE       US03168 49352003
         B     ERRORT                   GO PRINT MSG            US03168 49354003
         SPACE 1                                                        49356003
PR030    EQU   *                                                US03168 49358003
         CLOSE MF=(E,OPENLD)            CLOSE DATASET           US03168 49360003
         B     CONTROL2                 CONTINUE PROCESSING     US03168 49362003
         EJECT                                                          49364003
PR040    EQU   *                                                US03168 49366003
         DROP  GR1                                              US03168 49368003
         USING IHADCB,GR7                                       US03168 49370003
         SCRATCH PARMLIST              SCRATCH DATA SET                 49400016
         LTR   GR15,GR15               RETURN SUCCESSFUL                49600016
         BE    CONTROL2                                                 49800016
         TM    VOLIST+13,X'04'         I/O ERROR DURING SCRATCH         49820016
         BZ    PASSERR                 NO-PASSWORD ERROR                49840016
         LA    GR1,13                  YES-GO BUILD MESSAGE             49860016
         BAL   GR5,MSGBLD                                               49880016
         MVC   0(3,GR1),MSGCON         PROVIDE SVC NO TO PRINT          49900016
         CLI   COPYSW,X'01'            COPIES BEING USED                49920016
         BNE   SKIP3                   NO-GO MOVE DDNAME TO PRINT       49940016
         MVC   3(8,GR1),DDNAME3        PROVIDE COPIES TODD TO PRINT     49960016
         B     GO                                                       49980016
         EJECT                                                          49982002
**********************************************************************  49984002
*        THE FOLLOWING ROUTINE WILL PROMPT THE OPERATOR WHEN A          49986002
*        CHECKPOINT/RESTART DATA-SET IS ENCOUNTERED.                    49988402
**********************************************************************  49988502
         SPACE                                                          49988802
PROMPT   EQU   *                                                        49990002
         TM    WTORSW,CHPTP             PROMPTED OPER BEFORE?   YM7392  49992002
         BO    RELOAD                   YES, EXIT THIS RTNE.    YM7392  49992102
         MVC   CHKRESTR+SEROFFS(6),SRTEVOLI PUT VOL-SER IN WTOR Y02083  49992302
         MVC   CHKRESTR+UNITOFFS(3),UCBNAME PUT CH-UNIT IN WTOR Y02083  49993002
         DROP  GR8                                               Y02083 49994002
         L     GR8,CVTPTR              PICK UP POINTER TO CVT    Y02083 49996002
         USING CVT,GR8                                           Y02083 49998002
         L     GR8,CVTTCBP             PICK UP POINTER TO TCB    Y02083 49998402
         L     GR8,4(GR8)                                        Y02083 49998802
         DROP  8                                                 Y02083 49999202
         L     GR8,12(GR8)             PICK UP POINTER TO TIOT   Y02083 49999602
         USING TIOT,GR8                                          Y02083 49999702
         MVC   CHKRESTR+JN(L8),TIOCNJOB SAVE JOBNAME AND STPNM  YM7392  49999802
         MVC   CHKRESTR+SN(L8),TIOCSTEP      IN WTOR MESSAGE    YM7392  50000002
CHKRESTR WTOR  'IEH858D       HAS A CHECKPOINT/RESTART DATA SET,       X50006602
               ,        ,                 .',REPLY,1,DISKECB,  @ZA16477X50007600
               ROUTCDE=(4),DESC=(2)                              Y02083 50010602
         TM    DISKECB,COMPLETE        IS OPERATION COMPLETE     Y02083 50012602
         BO    OKOK                    YES-GO CLEAR BITS         Y02083 50013002
         WAIT  ECB=DISKECB             N/-WAIT FOR REPLY         Y02083 50013102
OKOK     MVI   DISKECB,0               CLEAR POSTED BITS IN ECB  Y02083 50013202
         CLI   REPLY,C'U'              DOES REPLY INDICATE USE   Y02083 50019902
         BE    RELOAD                   YES, RETURN             Y02083  50030002
         CLI   REPLY,C'T'               DID OPER TERM. REQUEST? Y02083  50043302
         BE    WRITEMSG                 TELL PRGMR THE OPER     Y02083  50045302
*                                       CANCELED HIS REQUEST.   Y02083  50049302
         MVC   FILLIT+55(8),TIOCNJOB   PUT JOBNAME AND STEPNAME IN      50051302
         MVC   FILLIT+65(16),TIOCSTEP       WTO MESSAGE         Y02083  50051702
FILLIT   WTO   'IEH808I REPLY IN ERROR. REPLY WITH "U" OR "T",         C50052102
               ,                 .',ROUTCDE=(4),DESC=(5)        Y02083  50052502
         B     CHKRESTR                 RE-ISSUE MSG            Y02083  50053702
RELOAD   EQU   *                                                Y02083  50053802
         OI    WTORSW,CHPTP             SET PROMPT FLAG         YM7392  50055802
         LM    GR5,GR8,PROMPTSA         RELOAD WORK REG         Y02083  50055902
         BR    GR4                      RETURN                  Y02083  50057902
WRITEMSG EQU   *                                                Y02083  50059002
         LA    GR1,MESS68               LOAD MSG NO. IEH868I    Y02083  50061102
         BAL   GR5,MSGBLD               BUILD MSG IEH868I       T02083  50063202
         MVC   0(L8,GR1),DDNAME1        MOVE IN DDNAME1       @ZA16475  50064299
         CLI   FUNCSW,DUMP              DUMP FUNCTION?        @ZA16475  50064999
         BE    LM                       DDNAME1 IT IS         @ZA16475  50065699
         MVC   0(L8,GR1),DDNAME2                              @ZA16475  50066399
LM       LM    GR5,GR8,PROMPTSA         RELOAD WORK REG       @ZA16475  50067099
         B     FORWARD                  GO PRT MSG AND EXIT     Y02083  50069502
         EJECT                                                          50071602
SKIP3    MVC   3(8,GR1),DDNAME2        PROVIDE TODD NAME TO PRINT       50073702
GO       LA    GR5,SETCODE             SET UP BRANCH AFTER PRINT        50075802
         B     MSGPRNT                 GO PRINT MESSAGE                 50077902
PASSERR  TM    VOLIST+13,X'02'         PASSWORD ERROR                   50080016
         BZ    SETCODE                 NO-OTHER ERROR/ABNORMALLY END    50120016
         LA    GR1,36                  YES-INCORRECT PASSWORD/TODD      50160016
         B     ERRORT                                                   50200016
CONTROL2 LA    GR5,140(GR5)            BUMP POINTER TO NEXT DSCB        50400016
         BCT   GR2,F1CHECK             SUBTRACT 1 FROM NO.DSCBS LEFT    50600016
         B     REPEAT2                 READ AGAIN                       51000016
         EJECT                                                          51000203
*********************************************************************** 51200016
*  THIS ROUTINE CHECKS TO SEE IF THERE ARE COPY VOLUMES. IF SO, THE   * 51250016
*   DCB IS PICKED UP, THE WRITE TO OPERATOR SWITCH IS INITIALIZED     * 51300016
*   AND THE NEXT VOLUME IS PROCESSED.                                 * 51350016
*********************************************************************** 51400016
CKMOREDD CLI   COPYSW,X'01'            HAVE ANY COPIES BEEN DONE        51500016
         BE    MORECOPY                YES-PICK UP CORRECT POINTER      51600016
         L     GR6,COPYPTR             ARE COPIES INVOLVED              51700016
         LTR   GR6,GR6                                                  51800016
         BE    RELEASE                 NO-GO RETURN CONTROL             52000016
         MVI   COPYSW,X'01'            INDICATE FIRST COPY DONE         52800016
         USING COPYBLK,6                                                53000016
RESUME   TM    FUNCSW,X'40'            IS FUNCTION FORMAT OR ANALYZE    53080016
         BO    FORMANAL               YES-FO PICK UP PROPER DCB POINTER 53160016
         LA    GR7,CIOBLOCK+44         PICK UP COPY DCB POINTER FOR     53240016
         B     SKIP                       DUMP OR RESTORE               53320016
FORMANAL LA    GR7,CIOBLOCK            PICK UP COPY DCB POINTER - F/A   53400016
SKIP     OI    WTORSW,OFF               RESET WTOR SWT          YM7392  53480002
         B     VREAD                   GO READ DSCB'S                   53600016
MORECOPY L     GR6,CCOPYPTR            PICK UP POINTER TO COPYBLOCK     54200016
         LTR   GR6,GR6                 MORE COPIES                      54260016
         BE    RELEASE                 NO-GO RETURN CONTROL             54320016
         B     RESUME                                                   54400016
*********************************************************************** 54600016
*  THIS ROUTINE IS USED TO PRINT ERROR MESSAGES FOR THE TO DEVICE     * 54660016
*    TO FREE CORE GOTTEN AND TO RETURN CONTROL.                       * 54720016
*********************************************************************** 54800016
ERRORT   BAL   GR5,MSGBLD              GO BUILD MESSAGE                 55200016
         CLI   COPYSW,X'01'            COPIES BEING USED                55300016
         BNE   SKIP4                   NO-GO MOVE DDNAME TO PRINT       55400016
         MVC   0(8,GR1),DDNAME3        YES-PROVIDE COPIES TODD TO PRINT 55500016
         B     FORWARD                                                  55600016
SKIP4    MVC   0(8,GR1),DDNAME2        PROVIDE TODD NAME TO PRINT       55700016
FORWARD  BAL   GR5,MSGPRNT             GO PRINT MESSAGE                 55800016
SETCODE  LA    GR15,8                  SET UP RETURN CODE/ERROR         56200016
ENDUP    CLI   FUNCSW,DUMP             MUST CORE BE FREED/DUMP ONLY     56300016
         BNE   GOBACK                  NO - GO RETURN                   56400008
         LR    GR3,GR15                SAVE RETURN CODE                 56450008
         L     GR4,TABLESIZ            PICK UP SIZE OF CORE             56500016
         LTR   GR4,GR4                 WAS CORE OBTAINED       @Z40RSRB 56510008
         BZ    GOBACK                  SKIP FREEMAIN IF NOT    @Z40RSRB 56520008
         LA    GR8,TABLEAD             PICK UP ADDRESS OF CORE          56600016
         FREEMAIN E,LV=(4),A=(8)       FREE CORE GOTTEN                 56800016
         LR    GR15,GR3                PUT RETURN CODE BACK IN REG 15   56900016
GOBACK   TM    FLGBYT2,CPYREJEC        'CPYVOLID' DISALLOWED   @G32DSPD 56920032
         BNO   KEEPRCX                 NO,LEAVE R-CODE AS IS   @G32DSPD 56960032
         CLM   GR15,B'0001',RC4        CURRENT R-CODE G.E. 4   @G32DSPD 57000032
         BNL   KEEPRCX                 YES,KEEP THAT CODE      @G32DSPD 57040032
         LA    GR15,4                  USE RC4 RETURN          @G32DSPD 57080032
KEEPRCX  EQU   *                       R-CODE NOT CHANGED      @G32DSPD 57120032
         L     GR13,PASSSAVE+4         RESTORE REGISTER 13              57160032
         RETURN (14,12),T,RC=(15)      RETURN WITH PROPER CODE          57200016
*********************************************************************** 57400016
*  THIS SECTION PRINTS ERROR MESSAGES FOR THE FROM DEVICE, AND SETS   * 57450016
*    UP RETURN CODES. THE SYNADAF MACRO IS USED FOR THE I/O ERROR     * 57500016
*    MESSAGE.                                                         * 57550016
*********************************************************************** 57600016
NOCARD   LA    GR1,40                  NO DD CARD FOR SECURITY DS       57660016
         B     ERRORF                                                   57720016
BADPASS  LA    GR1,36                  INCORRECT PASSWORD/FROMDD        57800016
ERRORF   BAL   GR5,MSGBLD              GO BUILD MESSAGE                 58000016
         MVC   0(8,GR1),DDNAME1        PROVIDE FROMDD NAME TO PRINT     58200016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    58300016
         B     MSGPRNT                 GO PRINT MESSAGE                 58400016
DUMPFUNC CLI   FUNCSW,DUMP             IS FUNCTION DUMP                 58500016
         BNE   SETCODE                 NO-ABNORMALLY TERMINATE JOB      58600016
RELEASE  LA    GR15,0                  SET UP RETURN CODE/SUCCESSFUL    58800016
         B     ENDUP                                                    59000016
MORECORE L     GR7,PTRCFUNC            INDICATE CORE NOT AVAILABLE/WAIT 59200016
         OI    0(GR7),NOCORE+WAITING                                    59400016
         LA    GR15,4                  SET RETURN CODE AND RETURN       59600016
         B     ENDUP                                                    59800016
* RACF AUTHORIZATION FAILURE, 'CPYVOLID' NOT ALLOWED.          @G32DSPD 59805032
UNAUTHC  LA    GR1,MSG64               INDICATE MSG IEH864I    @G32DSPD 59810032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59815032
         MVC   0(L'RACVOL,GR1),RACVOL  SET VOLID IN MESSAGE    @G32DSPD 59820032
         BAL   GR5,MSGPRNT             GO PRINT MESSAGE        @G32DSPD 59825032
         BR    GR4                     CONTINUE OTHER FUNCTIONS@G32DSPD 59830032
* RACF AUTHORIZATION FAILURE ON 'FROM VOL'.                    @G32DSPD 59835032
UNAUTHF  LA    GR1,MESS66              INDICATE MSG IEH866I.   @G32DSPD 59840032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59845032
         MVC   0(L7,GR1),DUMPNM        SET FUNCTION NAME       @G32DSPD 59850032
         MVC   20(L'DDNAME1,GR1),DDNAME1 INDICATE DDNAME       @G32DSPD 59852032
         LA    GR5,SETCODE             SET BAL RETURN,RC=8     @G32DSPD 59855032
         B     MSGPRNT                 PRINT AND TERMINATE     @G32DSPD 59860032
*  RACF AUTHORIZATION FAILURE ON 'TO VOL'.                     @G32DSPD 59865032
UNAUTHT  LA    GR1,MESS66              INDICATE MSG IEH866I    @G32DSPD 59870032
         BAL   GR5,MSGBLD              GET MESSAGE TEXT        @G32DSPD 59875032
         MVC   0(L7,GR1),DUMPNM        USE DUMP NAME           @G32DSPD 59880032
         CLI   FUNCSW,DUMP             IS IT DUMP ?            @G32DSPD 59885032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59890032
         MVC   0(L7,GR1),RESTNM        USE RESTORE NAME        @G32DSPD 59895032
         CLI   FUNCSW,RESTORE          IS IT RESTORE ?         @G32DSPD 59900032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59905032
         MVC   0(L7,GR1),ANALZNM       USE ANALYZE NAME        @G32DSPD 59910032
         CLI   FUNCSW,ANALYSIS         IS IT ANALYZE ?         @G32DSPD 59915032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59920032
         MVC   0(L7,GR1),FRMATNM       USE FORMAT NAME         @G32DSPD 59925032
         CLI   FUNCSW,FORMAT           IS IT FORMAT ?          @G32DSPD 59930032
         BE    SETDD2                  YES,GO SET DDNAME       @G32DSPD 59935032
         MVC   0(L7,GR1),BLANKS        UNKNOWN FUNCTION        @G32DSPD 59940032
SETDD2   MVC   20(L8,GR1),DDNAME2      SET DDNAME              @G32DSPD 59945032
         CLI   COPYSW,COPYON           THIS A COPY ?           @G32DSPD 59950032
         BNE   KPDD2                   NO,KEEP DDNAME2         @G32DSPD 59955032
         MVC   20(L8,GR1),DDNAME3      USE DDNAME3-COPY DD     @G32DSPD 59960032
KPDD2    LA    GR5,SETCODE             SET RC=8                @G32DSPD 59965032
         B     MSGPRNT                 PRINT AND TERMINATE     @G32DSPD 59970032
IOERR    LA    GR1,13                  I/O ERROR                        60000016
         BAL   GR5,MSGBLD              GO BUILD MESSAGE                 60200016
         SYNADAF ACSMETH=EXCP,PARM1=DISKIOB                             60400016
         MVC   MESS+22(78),49(GR1)     I/O INFORMATION TO PRINT  SM4350 60600021
         SYNADRLS                                                       60800016
         LA    GR5,SETCODE             SET UP FOR BRANCH AFTER PRINT    60870016
         B     MSGPRNT                 GO PRINT MESSAGE                 60940016
MSGBLD   LINK  EP=IEHDMSGB             BUILD MESSAGE                    61010016
         BR    GR5                                                      61080016
MSGPRNT  LINK  EP=IEHDPRNT             PRINT MESSAGE                    61150016
         BR    GR5                                                      61220016
         DROP  6                                                        61290016
         AIF  ('&LIB' NE 'LIB1').NOTOS  BRCH IF NON-OS ASSEM Y02083     61292002
*********************************************************************** 61296016
*   THIS SECTION CALCULATES THE ADDRESS OF THE MAIN UCB GIVEN THE SUB * 61302016
*      UCB POINTER FOR A 2321.                                        * 61308016
*********************************************************************** 61314016
         USING DATACELL,GR8                                             61318016
         USING JFCB,GR2                                         US03168 61318103
IS2321   MVC   JFCBVOLS(6),DCELVOLI    PUT VOL-SER FOR 2321 IN JFCB     61322016
         B     BACK                                                     61326016
YES2321  MVC   TRYAGAIN+56(6),DCELVOLI  PICK UP 2321 VOL-SER       MC0I 61328018
         MVI   TRYAGAIN+26,C'/'                                    MC0I 61330018
         MVC   TRYAGAIN+27(1),DCELBBNR+1    BIN NO. W/CUU FOR 2321 MC0I 61332018
         LA    GR3,PASSBY1             SET BRANCH AFTER CALCULATION     61334016
         B     CKMAIN                                                   61338016
Y2321    MVC   VOLIST+6(6),DCELVOLI    PICK UP 2321 VOL/SER             61342016
         LA    GR3,PASS                SET BRANCH AFTER CALCULATION     61346016
CKMAIN   LH    GR15,DCELBBNR           CALCULATE MAIN UCB               61350016
         SLL   GR15,4                                                   61356016
         LA    GR15,SRTEUSER-UCBOB(GR15)                                61362016
         SR    GR8,GR15                                                 61368016
NOCONVRT BR    GR3                                                      61374016
         DROP  8                                                        61380016
.NOTOS   ANOP                                                   Y02083  61390002
*********************************************************************** 61400016
*    WAIT ROUTINE FOR I/O OPERATIONS                                  * 61500016
*********************************************************************** 61600016
WAIT     TM    DISKECB,COMPLETE        IS OPERATION COMPLETE            61800016
         BO    TEST                    YES-GO TEST STATUS               62000016
         WAIT  ECB=DISKECB             NO-WAIT COMPLETION OF DISK       62200016
TEST     EQU   *                                                 A33538 62280020
         CLC   DSENSE(2),ZERO          ANY ERROR CONDITION.      A33538 62360020
         BNE   IOERR                   YES-I/O ERROR.            A33538 62440020
         CLI   DISKECB,GOOD            ALL OK.                   A33538 62520020
         BNE   IOERR                   NO-I/O ERROR                     62600016
         MVI   DISKECB,0               CLEAR POSTED BITS IN ECB         62800016
         BR    GR4                     RETURN                           63000016
         SPACE                                                          63050020
SETCCW   DS    0D                                                M6183  63080020
         CCW   X'23',F1,X'40',1         SET SECTOR ZERO          M5900  63110020
TIC      CCW   8,0,X'40',0                                       S20201 63150020
CCWLIST  CCW   X'31',SEEKAD+3,X'40',5                                   63200016
         CCW   X'08',CCW1-CCWBUFF,0,0                                   63400016
RDCCW    CCW   X'0E',0,X'60',140                                        63600016
RDCNT    CCW   X'92',SEEKAD+3,X'20',5                                   63800016
*   DA EVENT CONTROL BLOCK (ECB).                                       64000016
         DS    0D                      NECESSARY ALIGNMENT              64200016
DISKECB  DC    F'0'                    WAIT/COMPLETE BITS               64400016
*   DA INPUT/OUTPUT BLOCK (IOB).                                        64600016
DISKIOB  DS    0F                                                       64800016
DFLAGS   DC    XL2'4200'               FLAG1 AND FLAG2                  65000016
DSENSE   DC    H'0'                    SENSE BYTES                      65200016
DECBAD   DC    A(DISKECB)              ECB ADDRESS                      65400016
DSTATUS  DC    2F'0'                   CHANNEL STATUS                   65600016
DCCWAD   DC    1F'0'                   CCW ADDRESS                      65800016
DDCBAD   DC    F'0'                    DCBADDRESS                       66000016
DRESAD   DC    F'0'                    RESTART ADDRESS                  66200016
DBLKCT   DC    H'1'                    BLOCK COUNT INCREMENT            66400016
DERROR   DC    H'0'                    ERROR COUNT                      66600016
SEEKAD   DC    1F'0'                   MBBCCHHR                         66800016
         DC    X'00000001'                                              67000016
LASTDSCB DS    CL5                                                      67200016
NINES    DC    CL5'99999'                                               67400016
ZERO     DC    H'0'                    CHECK SENSE BYTES.        A33538 67500020
SIXTEEN  DC    F'16'                                          A@ZA32596 67510099
EIGHT    DC    F'8'                                           A@ZA32596 67520099
SAVECCW  DC    4F'0'                                          A@ZA32596 67530099
SAVECCHH DC    X'0000000000'                                  A@ZA32596 67540099
TSTDSCB  DC    X'00'                                          A@ZA32596 67550099
LIST     DS    0F                      FOR READ IN JFCB                 67600016
         DC    X'87'                                                    67800016
         DC    AL3(0)                                                   68000016
OPENLD   RDJFCB (,(INPUT)),MF=L        PARAMETER LIST FOR OPEN          68200016
TABLESIZ DS    1F                      SIZE OF DSNAME TABLE             68400016
TABLEAD  DS    1F                      POINTER TO DSNAME TABLE          68600016
DATE     DS    1D                      CURRENT DATE                     68800016
SECSW    DS    CL1                     SECURITY SWITCH                  69000016
WTORSW   DS    CL1                     WRITE TO OPERATOR INDICATOR      69200016
COPYSW   DS    CL1                     COPYSWITCH                       69400016
REPLY    DS    CL1                     OPERATOR REPLY                   69600016
REPLYAD  DC    A(REPLY)                ADDRESS OF OPERATOR REPLY AREA   69800016
GOOD     EQU   X'7F'                   NO I/O ERROR                     69900016
TICCODE  EQU   X'08'               TIC CCW OP CODE               S20201 69920020
D0       EQU   0                        DISP OF ZERO            SA61117 69922003
D1       EQU   1                   DISP OF 1                     S20201 69940020
L3       EQU   3                   LENGTH OF 3                   S20201 69960020
RACKPRM  RACHECK MF=L,CLASS=DATASET                            @G32DSPD 69970032
DATASET  DC    AL1(7),CL7'DATASET'      CLASS NAME             @Z40RSRJ 69980132
DASDVOL  DC    AL1(7),CL7'DASDVOL'      DASD CLASS NAME        @G32DSPD 69985032
RACVOL   DS    CL6                     VOLSER TO RACHECK       @Z40RSRB 69990008
PARMLIST CAMLST SCRATCH,0,,VOLIST,,OVRD                                 70000016
VOLIST   DC    H'1'                    VOLUME LIST FOR SCRATCH DATA SET 70200016
         DS    1H                                                       70400016
         DS    2F                                                       70600016
         DC    H'0'                                                     70800016
DSCBNO   DS    1F                      SAVE AREA FOR NUMBER DSCBS       70900016
DSCBPTR  DS    1F                      POINTER TO READAREA FOR DSCBS    71000016
RDCNTAD  DS    F                                                        71050016
DUMPNM   DC    CL7'DUMP   '            FUNCTION NAME           @G32DSPD 71057032
RESTNM   DC    CL7'RESTORE'            FUNCTION NAME           @G32DSPD 71064032
FRMATNM  DC    CL7'FORMAT '            FUNCTION NAME           @G32DSPD 71071032
ANALZNM  DC    CL7'ANALYZE'            FUNCTION NAME           @G32DSPD 71078032
RC4      DC    AL1(4)                  RACF R-CODE TESTS       @G32DSPD 71085032
RC8      DC    AL1(8)                  RACF RETURN-UNAUTHORIZED@G32DSPD 71092032
INCON    DC    C'SYSIN   '                                              71100016
PRINTCON DC    C'SYSPRINT'                                              71200016
DPASS    DC    CL8'DPASS   '            PAREST DDNAME           SA61117 71202003
F1       DC    F'1'                                              S20201 71250020
BLANKS   DC    CL8' '                                            A44112 71270021
TWENTY   DC    H'20'                                                    71300016
FOUR     DC    H'4'                                                     71400016
MSGCON   DC    C'29,'                  SVC NO. FOR I/O ERROR MESSAGE    71500016
TIOTSAVE DS    1F                      SAVE AREA FOR FIRST DD ENTRY     71600016
PROMPTSA DS    5F                       SAVE AREA FOR SUB-RTNE  Y02083  71650002
PASSSAVE DS    18F                                                      71800016
SWITCH1  NOPR  14                                                       72000016
SWITCH2  NOPR  15                                                       72200016
READJFCB DS    44F                     AREA TO READ IN JFCB             72400016
DADCB    DCB   DSORG=PS,MACRF=(E),DEVD=DA,EXLST=LIST                    72600016
         ICHPRCVT                                              @ZA25515 72800099
         EJECT                                                          72840099
         ICHACHKL                                          /*@Z40RSGD*/ 72880099
         EJECT                                                          72920099
         IEHDWORK                                                       72960099
         EJECT                                                          73000099
         IEHDBLKS                                                       73040099
         EJECT                                                          73080099
CCWBUFF  DSECT                                                          73200016
CCW1     DS    1D                                                       73400016
CCW2     DS    1D                                                       73600016
CCW3     DS    1D                                                       73800016
         EJECT                                                          73810099
F1DSCB   DSECT                          DSECT FOR F1DSCB       @Z40RSRB 73860099
         IECSDSL1 (1)                   FORMAT 1 DSCB          @Z40RSRB 73910099
F1RACDEF EQU   X'40'                    DS1DSIND=RAC DEFINED   @Z40RSRB 73960099
         EJECT                                                          74010099
CVT      DSECT                                                          74060099
         CVT                                                   @G32DSPD 74110099
         EJECT                                                          74160099
UCB      DSECT                                                          74210099
         IEFUCBOB                                                       74260099
         EJECT                                                          74310099
JFCB     DSECT                                                          74360099
         IEFJFCBN                                                       74410099
         DCBD  DSORG=PS                                                 74460099
         EJECT                                                          74510099
TIOT     DSECT                                                          75400016
TIOCNJOB DS    2F                                                       75600016
TIOCSTEP DS    4F                                                       75800016
DDENTRY  DS    0F                      DD ENTRY FOR EACH DD CARD        76000016
TIOELNGH DS    CL1                     LENGTH OF DD ENTRY               76200016
TIOESTTA DS    CL1                                                      76400016
TIOERLOC DS    CL2                                                      76600016
TIOEDDNM DS    2F                                                       77000016
TIOEJFCB DS    CL3                                                      77400016
TIOESTTC DS    CL1                                                      77600016
TIOESTTB DS    CL1                                                      77800016
TIOEFSRT DS    CL3                                                      78000016
         END                                                            88000016
