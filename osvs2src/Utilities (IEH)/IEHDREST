         COPY  LCGASMSW                                                 00102800
*********************************************************************** 00104837
*                  FIXES THIS MODULE                                  * 00104937
*                     LATEST FIRST                                    * 00105037
*********************************************************************** 00105137
*                                                                       00105299
*D 21000                                    SU32 ONLY          @ZA25515 00105399
*C 31550                                    SU32 ONLY          @ZA25515 00105499
*A 314600-314603,699300                     SU32 ONLY          @ZA25515 00105599
*                                                                       00105999
*C 031550                           @ZA18390=@YA16248=@XA16068=@SA75612 00106099
*A 314705,314706                    @ZA18390=@YA16248=@XA16068=@SA75612 00106199
*                                                                       00106299
*A 407685,407691,407792,407798      @ZA18389=@YA16247=@XA16067=@SA75611 00106799
*                                                                       00107299
*  VS2-3 FOR SU32 NO DELETIONS                                 @G32DSPD 00107799
*                                                                       00108299
*C 31600                                     @ZA16473=@YA15361=@XA16061 00108799
*A 510318-510323                             @ZA16473=@YA15361=@XA16061 00109299
*                                                                       00109799
*C 32000,348400                              @XA12893=@YA13102=@ZA07406 00110299
*A 31500-31600,524100                        @XA12893=@YA13102=@ZA07406 00111232
*                                                                       00113232
* FIX S337 ABEND AT END OF 2ND REEL.                           @ZM40467 00116037
*                                                                       00121037
*A 501614,618,644                                              @ZM40033 00126037
*                                                                       00128032
*                                                                       00131037
*  FIX APPLIED IN IEHDRVID          @SA75573=@XA10920=@YA10569=@ZA04433 00136037
*                                                                       00146037
*C 510647,510651,510655             @SA69560=@XA06597=@YA06113=@ZA01235 00148537
*                                                                       00150537
*C 510745,510749                    @SA69553=@YA04792=@XA04172=@ZA01202 00151037
*A 510738-510739,518870             @SA69553=@YA04792=@XA04172=@ZA01202 00156037
*                                                                       00166037
*C532240                                              OZ00102 = VS08412 00171037
*                                                               XM05805 00176037
*217000-228730,406600-407260,531600,535800   SA65560 = OX02864 = OY0265 00181037
*  APAR XA02828 FIXED AND FLAGGED AS OX02864                    XA02828 00186037
*C003071,D003402,A003704-003728,024761-024794,A037020,037920-038044     00191037
* 354900,355400-355920,356500,360500,361000,535900    OX2677 = SA65706  00201037
*                                                     OX1801 = SA61432  00206037
*                                                                     * 00211037
*STATUS CHANGE LEVEL 005                                              * 00216937
*********************************************************************** 00218937
         TITLE 'IEHDREST --- RESTORE FUNCTION'                          00224837
IEHDREST CSECT                                                          00226837
*FUNCTION/OPERATION- THIS ROUTINE HANDLES THE -RESTORE- FUNCTION      * 00228737
*   OF THE IEHDASDR SYSTEM UTILITY PROGRAM. RESTORE CONSISTS OF       * 00234637
*   RESTORING(COPYING) DATA TO A DIRECT ACCESS DEVICE FROM TAPE.      * 00240537
*   THE TAPE MUST HAVE BEEN CREATED EITHER BY -IEHDASDR- OR THE       * 00246437
*   STAND-ALONE DUMP/RESTORE PROGRAM. DATA IS RESTORED ONLY TO A      * 00252337
*   VOLUME RESIDING ON THE SAME DEVICE TYPE FROM WHICH IT WAS         * 00258237
*   DUMPED.                                                           * 00264137
*   RACF AUTHORIZATION IS REQUIRED IN ORDER TO USE THE         @G32DSPD 00270032
*   'CPYVOLID=YES' OPTION ON VOLUME IDS THAT ARE DEFINED TO    @G32DSPD 00280032
*   RACF.                                                      @G32DSPD 00290032
*                                                                     * 00300000
*INPUT-  POINTERS TO A WORKAREA(REGISTER 12) AND TO A CONTROL         * 00302002
*   BLOCK(REGISTER 10).                                               * 00302402
*   THE TAPE HAS THE FOLLOWING FORMAT                                 * 00307137
*                                                                     * 00307502
*   LIMITS RECORD- ALWAYS THE FIRST RECORD AFTER A TAPE MARK ON       * 00309102
*   EACH VOLUME OF TAPE. THIS RECORD IS 24 BYTES IN LENGTH AND        * 00311102
*   CONTAINS THE FOLLOWING INFORMATION.                               * 00311502
*                                                                     * 00311902
*        BYTES 0-3    CCHH OF THE FIRST TRACK DUMPED.                 * 00312102
*        BYTES 4-7    CCHH+1 OF THE LAST TRACK DUMPED.                * 00312202
*        BYTES 8-11   CCHH OF THE FIRST TRACK THIS VOLUME.            * 00312302
*        BYTES 12-19  CODE THAT IDENTIFIES THIS AS BEING A            * 00312402
*                     RESTORE TAPE.                                   * 00313202
*        BYTE  20     FULL DUMP SWITCH -X'F0'=FULL,X'00'=PARTIAL.     * 00313602
*        BYTE  21     DEVICE TYPE CODE AS FOLLOWS.                    * 00314002
*                      CODE 2    2314                                 * 00314402
*                           6    2305-1                               * 00314802
*                           7    2305-2                               * 00314902
*                           9    3330                                 * 00315502
*                           A    3340                                 * 00315902
*                           D    3330-1                               * 00316302
*        BYTE  22     3340 MODEL NUMBER                               * 00316702
*        BYTE  23     RESERVED                                        * 00316902
*                                                                     * 00317502
*   CONTROL RECORD- THIS RECORD IS WRITTEN FOR EACH TRACK DUMPED      * 00317602
*   AND IMMEDIATELY PRECEDES THE DATA RECORD FOR EACH TRACK. IT       * 00318002
*   CONTAINS A CHANNEL PROGRAM USED BY RESTORE TO WRITE ONE TRACK.    * 00318402
*   THE LENGTH OF THIS RECORD DEPENDS ON THE NUMBER OF RECORDS ON     * 00318802
*   THE DUMPED TRACK.                                                 * 00318902
*                                                                     * 00319002
*   TRACK IMAGE RECORD- THIS RECORD CONTAINS THE DATA DUMPED FROM     * 00319202
*   A TRACK AND ALWAYS FOLLOWS A CONTROL RECORD.  IT IS WRITTEN AS    * 00320002
*   ONE MAXIMUM LENGTH PHYSICAL RECORD ON TAPE. IT CONTAINS THE       * 00321402
*   DATA FIELD OF RECORD ZERO AND ALL FIELDS OF OTHER RECORDS THAT    * 00326102
*   WERE ON THE TRACK THAT WAS DUMPED.                                * 00330802
*                                                                     * 00335502
*   TRAILER RECORD- THIS ALWAYS FOLLOWS THE TAPE MARK THAT WAS AT     * 00344902
*   THE END OF THE LAST TRACK IMAGE RECORD. IT IS 24 BYTES IN         * 00349602
*   LENGTH, OF WHICH ONLY THE FIRST 4 BYTES ARE USED. IT INDICATES    * 00354302
*   WHETHER THE RESTORE IS COMPLETE WHEN THE END OF THIS VOLUME       * 00359002
*   IS REACHED.                                                       * 00363702
*                                                                       00372937
*EXITS-NORMAL- A SUCCESSFUL RESTORE RESULTS IN A RETURN TO THE        * 00373102
*   MODULE -IEHDINIT- WITH A RETURN CODE OF 0. A RESTORE COMPLETE     * 00377802
*   MESSAGE IS ALSO PLACED IN THE MESSAGE DATA SET.                   * 00382502
*                                                                     * 00387202
*EXITS-ERROR-  ANY ERROR ENCOUNTERED IS DESCRIBED BY AN APPROP-       * 00391902
*   IATE MESSAGE TO THE MESSAGE DATA SET. A RETURN CODE GREATER       * 00396602
*   THAN ZERO WILL ALSO BE PASSED BACK TO MODULE -IEHDINIT-.          * 00401302
*                                                                     * 00406002
*EXTERNAL ROUTINES-  THIS ROUTINE ONLY ENTERED FROM THE INITIALIZING  * 00410702
*   ROUTINE (IEHDINIT). ALL MESSAGES ARE BUILT BY -IEHDMSGB-          * 00415402
*   AND WRITTEN OUT BY -IEHDPRNT-. ALL DEVICE CONSTANTS REFERENCED    * 00420102
*   ARE IN -IEHDCONS-.                                                * 00424802
*                                                                     * 00434202
*TABLES/WORK AREAS-  UPON ENTRY, REGISTERS 10 AND 12 POINT TO A       * 00438902
*   FUNCTION BLOCK AND WORK AREA RESPECTIVELY. THEY ARE DESCRIBED     * 00443602
*   IN THE DSECTS CALLED -FUNCBLK- AND -WORK-.                        * 00448302
*                                                                     * 00481202
*ATTRIBUTES- SERIALLY REUSABLE,RELOCATABLE                            * 00485902
*                                                                     * 00487902
*********************************************************************** 00489902
         EJECT                                                          00490302
*********************************************************************** 00491902
*                                                                     * 00493902
*   THE FOLLOWING ARE REGISTER ASSIGNMENTS.                           * 00495302
*                                                                     * 00495702
*********************************************************************** 00497302
         SPACE                                                          00499302
GR0      EQU   0                                                        00500016
GR1      EQU   1                                                        00600016
GR2      EQU   2                                                        00700016
GR3      EQU   3                                                        00800016
GR4      EQU   4                                                        00900016
GR5      EQU   5                                                        01000016
GR6      EQU   6                                                        01100016
GR7      EQU   7                                                        01200016
GR8      EQU   8                                                        01300016
GR9      EQU   9                                                        01400016
GR10     EQU   10                                                       01500016
GR11     EQU   11                                                       01600016
GR12     EQU   12                                                       01700016
GR13     EQU   13                                                       01800016
GR14     EQU   14                                                       01900016
GR15     EQU   15                                                       02000016
UCBPTR   EQU   9                                                        02200016
BASEREG  EQU   11                                                       02300016
WORKBASE EQU   12                                                       02400016
K0       EQU   0                       DISPLACEMENT CONSTANT.    A21395 02402020
         SPACE 3                                                        02405016
*********************************************************************** 02407002
*                                                                     * 02409002
*   MESSAGE REFERENCES.                                               * 02410002
*                                                                     * 02412002
*********************************************************************** 02415016
         SPACE                                                          02417002
MESS6    EQU   6                       MESSAGE IEH806                   02425016
MESS13   EQU   13                      MESSAGE IEH813                   02440016
MESS15   EQU   15                      MESSAGE IEH815                   02450016
MESS16   EQU   16                      MESSAGE IEH816                   02455016
MESS28   EQU   28                      MESSAGE IEH828                   02465016
MESS30   EQU   30                      MESSAGE IEH830                   02470016
MESS31   EQU   31                      MESSAGE IEH831          @ZA06534 02470437
MESS32   EQU   32                      MESSAGE IEH832          @ZA06534 02472437
MESS49   EQU   49                      MESSAGE IEH849                   02474437
MESS50   EQU   50                      MESSAGE IEH850                   02476032
MESS64   EQU   64                      MESSAGE IEH864I         @G32DSPD 02478032
         EJECT                                                          02480016
         SPACE 2                                                        02500016
         USING FUNCBLK,10                                               02600016
         USING IEHREST,BASEREG                                          02700016
         USING WORK,12                                                  02800016
         SPACE 1                                                        02900016
IEHREST  SAVE  (14,12),T,*             SAVE THE REGISTERS.              03000002
         LR    BASEREG,GR15            LOAD THE BASE REGISTER.          03100016
         B     APARNO                  BRANCH AROUND APAR NO   @ZA07406 03150037
         DC    C'SU32 OZ25515'         LAST FIX THIS MOD       @ZA25515 03155099
APARNO   LA    GR7,RESTSAVE            SAVE AREA ADDRESS.      @ZA07406 03200037
         ST    GR7,8(GR13)             ADDRESS OF NEW AREA TO OLD.      03300016
         ST    GR13,4(GR7)             ADDRESS OF OLD AREA TO NEW.      03400016
         LR    GR13,GR7                LOAD SAVE AREA ADDRESS.          03500016
         SPACE                                                          03510002
         LA    GR9,BLOCKS              ADDRESSING FOR I/O BLOCKS.       03550002
         L     GR3,PTRCFUNC            PTR TO CURRENT FUNCTION.         03560002
         TM    0(GR3),PROCESS          PREVIOUSLY UNDER WAY?            03570002
         BZ    PROCTAPE                NO, START READING TAPE.          03580002
         L     GR15,FRTNPTR            YES, GET RETURN POINTER.         03590002
         BR    GR15                    TAKE UP WHERE WE LEFT OFF.       03592002
         SPACE 3                                                        03642002
PROCTAPE EQU       *                                                    03692002
         BAL   GR2,CKHEADER            PROCESS HDR RECORD       YL02912 03694437
         TM    SWITCH,EOV              1ST REEL ?               YL02912 03784437
         BO    PRIME1                   NO, PROCESS TAPE        YL02912 03874437
         L     GR1,BUFFPTR1             POINT TO DPASS WORK AREA        03992002
         LINK  EP=IEHDPASS                                              04092002
         LTR   GR15,GR15                GOOD RETURN ?           YL02912 04142002
         BNZ   FINAL4                   NO, EXIT WITH RC 8      YL02912 04192002
         B     PRIME1                   YES, PROCESS TAPE       YL02912 04201037
         EJECT                                                          04292002
*********************************************************************** 22816903
*        THIS SECTION WILL READ THE TAPE HEADER RECORD FROM THE       * 22817302
*        RESTORE TAPE AND VERIFY IT FOR INITIAL AND EOV PROCESSING.   * 22817602
*********************************************************************** 22967737
         USING IOBLOCKS,GR9                                             23017737
CKHEADER LA    GR9,BLOCKS              I/O CONTROL BLOCKS.      US03168 23067737
TAPEIN2  LA    GR3,CONTROL             ADDRESS TO READ CONTROL RECORD.  27150002
         ST    GR3,TAPEREAD            SET UP ADDRESS IN CCW.           27200002
         MVI   TAPEREAD,X'02'          RESET OP CODE.                   27250002
         LA    GR3,TAPEREAD            ADDRESS OF CCWS.                 27300002
         ST    GR3,TCCWAD              STORE IN IOB.                    27350002
READCTRL EXCP  TAPEIOB                 READ IN THE CONTROL RECORD.      27400002
         OI    FIRSTSW,PROCHDR           SET PROCESS HDR SWT     OX2864 27410002
         BAL   GR14,WAITTAPE           AWAIT COMPLETION OF READ.        27450002
         NI    FIRSTSW,X'FF'-PROCHDR     RESET PROCESS HDR SWT   OX2864 27460002
CKCTRL   LA    GR3,TAPECCW1            ADDRESS OF CCWS TO READ TAPE.    27500002
         ST    GR3,TCCWAD              STORE IN IOB.                    27550002
         SR    GR3,GR3                                                  27600002
         AIF   ('&LIB' EQ 'LIB1').WIN02 BRCH IF OS ASSEM        XL03130 27610002
         IC    GR3,CONTROL+D22          GET WINCH MODEL NO.     XL03130 27620002
         STC   GR3,IDEVMOD              STORE MODEL NO.I/P      XL03130 27630002
.WIN02   ANOP                                                   XL03130 27640002
         IC    GR3,CONTROL+21          DEVICE TYPE CODE FROM TAPE       27650002
         LA    GR3,CODES(GR3)          ADDRESS OF UCB DEVICE TYPE CODE. 27700002
         CLC   CONTROL+17(3),SACODE4   IS THIS A RESTORE TAPE.          27710037
         BNE   RMESS2                  NO--                             27780037
         CLC   IODEVCON(1),0(GR3)      DO THE DA DEVICE TYPES MATCH.    27850002
         AIF   ('&LIB' EQ 'LIB1').ICE01 BRCH IF OS ASSEM        XL03145 27860002
         BCR   EQ,GR2                   YES, START PROCESSING.  XL03145 27870002
         CLI   IODEVCON,ICEBERG         IS RECEIVING VOL AN     XL03145 27880002
*                                       ICEBERG DEVICE.         XL03145 27890002
.ICE02   ANOP                                                   XL03145 27892002
         BNE   RMESS1                   NO, ISSUE ERR MSG       XL03145 27894002
         AIF   ('&LIB' EQ 'LIB1').ICE01 BRCH IF OS ASSEM        XL03145 27896002
         CLI   D0(GR3),MERLN            WAS TRANSMITTING VOL A  XL03145 27898002
*                                       MERLIN DEVICE (3330).   XL03145 27898402
         BNE   RMESS1                   NO, GO GIVE ERROR MSG   XL03145 27898802
         OI    FIRSTSW,DOSBIT           FLAG FOR LATER TESTING  XL03145 27899202
.ICE01   ANOP                                                   XL03145 27899602
         BR        GR2       RETURN TO CALLING RTNE.            OX02864 27900002
         EJECT                                                          28010002
*********************************************************************** 28050002
*                                                                     * 28100002
*        START FUNCTION BY FILLING BUFFERS.                           * 28150002
*                                                                     * 28200002
*********************************************************************** 28250002
         SPACE                                                          28300002
PRIME1   LA    GR9,BLOCKS              ADDRESS OF I/O BLOCKS.           28700016
         AIF   ('&LIB' EQ 'LIB1').WIN03 BRCH IF OS ASSEM        XL03130 28810003
         CLI   IODEVCON,WINCH           WINCH DEVICE ?          XL03130 28820003
         BNE   WIN04                    NO, BRCH                XL03130 28830003
         CLC   IDEVMOD,ODEVMOD          COMPARE WINCH MODEL NO. XL03130 28850003
         BE    WIN04                    BRCH IF MODELS EQ       XL03130 28862003
         BH    RMESS1                   BRCH IF I/P BIGGER O/P  XL03130 28870003
         OI    FIRSTSW,DOSBIT           CAUSE F4 DOS-CONTAM-BIT XL03130 28872003
*                                       TO BE SET               XL03130 28874003
WIN04    EQU   *                                                XL03130 28876003
.WIN03   ANOP                                                   XL03130 28880003
         L     GR3,PTRCFUNC            POINTER TO CURRENT FUNCTION.     28900016
         OI    0(GR3),PROCESS          INDICATE FUNCTION IS UNDER WAY.  29000016
RDTAPE1  EXCP  TAPEIOB                 READ INTO BUFFER ONE.            29030037
         BAL   GR14,WAITTAPE           AWAIT COMPLETION.                29130037
         SPACE 1                                                        29230037
START1   L     GR2,BUFFPTR1            BUFFER ONE ADDRESS.              29330037
         BAL   GR14,CONVCCW            SET UP CCWS FOR SYSTEM. @ZA06534 29430037
         BAL   GR2,WRITE               WRITE ON DA FROM BUFFER ONE.     29700016
         CLI   BUFFSW,ON               ARE WE DOUBLE BUFFERED.          29800016
         BNE   RETURN                  NO--CHECK CONCURRENT OR WAIT.    29900016
         SPACE 1                                                        30100016
         LA    GR3,TAPECCW2            READ CCWS FOR BUFFER TWO.        30200016
         ST    GR3,TCCWAD              ADDRESS TO IOB.                  30300016
         EXCP  TAPEIOB                 FILL BUFFER TWO.                 30400016
         SPACE 1                                                        30500016
RETURN   EQU   *                       CHECK IF RETURN TO MONITOR.      30600016
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 30730016
         BZ    WAITOUT1                NO--GO TO WAIT.                  30760016
         LA    GR3,WAITOUT1            RETURN ADDRESS.                  30800016
RETURN1  ST    GR3,FRTNPTR             SAVE IN RETURN POINTER.          30900016
         LA    GR15,0                  SET RETURN CODE.                 30950016
         B     FINAL3                  RETURN TO MONITOR.               31000016
         SPACE 1                                                        31200016
WAITOUT1 EQU   *                                                        31300016
         BAL   GR14,WAITDISK           AWAIT OUTPUT OF ONE.             31400016
CHGSERAL EQU   *                                                 M0640  31403020
         TM    FIRSTSW,HEX1            FIRST TIME THROUGH       RESTFIX 31406002
         BO    CHKMORE                 NO                        M0640  31409002
         OI    FIRSTSW,HEX1            SET SWITCH FOR ENTRY     RESTFIX 31412002
         LA    GR3,SRCHKEYR            ADDR OF CCW FOR REC 3     M0640  31415002
         ST    GR3,DCCWAD              SET UP IOB                M0640  31418002
         XC    DSEEK+3(4),DSEEK+3      CLEAR SEEK ADDR           A38120 31419002
         L     GR5,BUFFPTR1            GET BUFFER ADDR           M6350  31419237
         ST    GR5,RDVOLSER            PUT IN READ/WRITE CCW     M6350  31420002
         MVI   RDVOLSER,X'06'          PUT IN READ COMMAND       M6350  31420502
         EXCP  DISKIOB                                           M0640  31421020
         WAIT  ECB=DISKECB                                       M0640  31424020
         CLI   DISKECB,GOOD                                      M0640  31427020
         BNE   IOERR                   GOT AN ERROR              M0640  31430002
         SPACE                                                          31430402
*********************************************************************** 31432002
*                                                                     * 31433002
*        AFTER THE UNITIAL WRITE TO DISK THE VOL SER THAT WAS WRITTEN * 31436002
*       THERE FROM TAPE HAS BEEN PUT INTO RDVOLBUF BY ABOVE CHAN      * 31439002
*        PROG. THIS SER MUST BE SAVED AND REPLACED BY THE ORIGINAL.   * 31442002
*                                                                     * 31445002
*********************************************************************** 31447002
         SPACE                                                          31448002
         L     GR8,TUCBPTR              GET UCB PTR              A42500 31450021
         MVI   RDVOLSER,X'05'           PUT IN WRITE COMMAND     M6350  31452001
         MVC   IDSAVE(6),4(GR5)         SAVE DISK VOLID          M6350  31453020
         MVC   4(6,GR5),28(GR8)         PUT BACK ORIGINAL VOLID. A42500 31457002
*********************************************************************** 31457232
*     THIS SECTION OF CODE PERFORMS RACF CHECKING. IF THE VOLID TO    * 31457432
*  BE COPIED IS DEFINED TO RACF AND THE USER DOES NOT HAVE ALTER      * 31457632
*  ACCESS TO IT, HE WILL BE DENIED EXECUTION OF THE 'CPYVOLID'        * 31457832
*  OPTION.                                                     @G32DSPD 31458032
*********************************************************************** 31458232
         TM    SEQSW,CPYVOLID           COPY VOLID REQUESTED ? @G32DSPD 31458432
         BNO   NOCHECKS                 NO,SKIP RACF CHECKS    @G32DSPD 31458632
         L     GR6,CVTPTR               GET CVT POINTER        @G32DSPD 31458832
         USING CVT,GR6                                         @G32DSPD 31459032
         L     GR6,CVTRAC               GET RACF POINTER       @G32DSPD 31459232
         DROP  GR6                                             @G32DSPD 31459432
         LTR   GR6,GR6                  IS RACF ACTIVE ?       @G32DSPD 31459632
         BZ    NOCHECKS                 NO,SKIP RACF CHECKS    @G32DSPD 31459832
         USING RCVT,GR6                 DO TEST IF RACF IS     @ZA25515 31460099
         TM    RCVTSTA1,RCVTDASD        CURRENT.               @ZA25515 31460199
         BZ    NOCHECKS                 NO DONT DO RACHECK     @ZA25515 31461299
         DROP  GR6                      YES DO RACHECK         @ZA25515 31461399
         MVC   RACVOL(6),IDSAVE         SET VOLID FOR RACHECK  @G32DSPD 31461499
         RACHECK  ATTR=ALTER,ENTITY=RACVOL,CLASS='DASDVOL'     @G32DSPD 31461599
         CLM   GR15,B'0001',RC8         USER AUTHORIZED ?      @G32DSPD 31461699
         BNE   CHECKSOK                 YES,CHECKS OK          @G32DSPD 31461799
         NI    SEQSW,255-CPYVOLID       FORBID COPY VOLID      @G32DSPD 31461899
         OI    FLGBYT2,CPYREJEC         SET CPYVOLID DISALLOWED@G32DSPD 31461999
         BAL   GR4,UNAUTH               GO PRINT MSG           @G32DSPD 31462099
CHECKSOK EQU   *                        USER IS AUTHORIZED     @G32DSPD 31462199
NOCHECKS EQU   *                        RACF NOT ACTIVE        @G32DSPD 31462232
         OC    COPYPTR(4),COPYPTR       ARE THERE ANY COPIES?           31463402
         BZ    GOWRT                    NO, GO WRITE VOLID.             31463802
         L     GR8,COPYPTR              YES, GET COPY BLOCK.            31464202
         USING COPYBLK,8                                         M2888  31466802
LOOPWRT  EQU   *                                                 M2888  31467102
         LA    GR9,CIOBLOCK             ADDRESSING FOR I/O BLOCKS.      31467402
         ST    GR3,DCCWAD               SET UP IOB.                     31467702
         OC    CCOPYPTR(4),CCOPYPTR     ARE THERE MORE COPIES?          31468102
         BZ    GOWRT                    NO, GO WRITE VOLID.             31468302
         L     GR8,CCOPYPTR             YES, GET NEXT COPY BLOCK.       31468602
         DROP  8                                                        31468902
         B     LOOPWRT                  GO UPDATE COPY BLOCK.           31469202
GOWRT    EQU   *                                                        31469502
         LA    GR9,BLOCKS               ADDRESSING FOR PRIMARY BLOCKS.  31469802
         EXCP  DISKIOB                                                  31470102
         WAIT  ECB=DISKECB                                              31470402
         CLI   DISKECB,GOOD                                    @ZA18390 31470500
         BNE   IOERR                                           @ZA18390 31470600
         MVC   DSEEK+3(4),CONTROL+8     RESET IOB SEEK           A38120 31470702
         OC    COPYPTR(4),COPYPTR       ANY COPIES?                     31471002
         BZ    ENDVOLID                 NO, TEST FOR BUFFERS.           31471302
         L     GR8,COPYPTR              YES, GET COPY BLOCK.            31471602
         USING COPYBLK,GR8                                              31471902
COPYIT   LA    GR9,CIOBLOCK             ADDRESSING FOR COPY BLOCKS.     31472202
         XC    DSEEK+3(4),DSEEK+3       CLEAR SEEK ADDRESS       A38120 31472502
         L     GR3,CUCBPTR              GET PTR TO COPY UCB PTR  M2888  31472802
         MVC   4(6,GR5),28(GR3)         PUT BACK ORIGINAL VOLID  M6350  31475802
         EXCP  DISKIOB                                           M2888  31489001
         WAIT  ECB=DISKECB                                       M2888  31490101
         MVC   DSEEK+3(4),CONTROL+8     RESET IOB SEEK           A38120 31491201
         OC    CCOPYPTR(4),CCOPYPTR                              M2888  31492301
         BZ    ENDVOLID                                          M2888  31493401
         L     GR8,CCOPYPTR                                      M2888  31494501
         B     COPYIT                                            M2888  31495601
ENDVOLID LA    GR9,BLOCKS                                        M2888  31496701
CHKMORE  EQU   *                                                 M0640  31497801
         SPACE 1                                                        31500016
         CLI   BUFFSW,ON               ARE THERE TWO BUFFERS.           31600016
         BNE   RDTAPE1                 NO--GO START ON 1 AGAIN.         31700016
         SPACE 1                                                        31800016
         BAL   GR14,WAITTAPE           YES-GO WAIT TO FILL BUFFER TWO.  31900016
         L     GR2,BUFFPTR2            BUFFER TWO ADDRESS.              31910037
         BAL   GR14,CONVCCW            SET UP CCWS FOR SYSTEM. @ZA06534 32010037
         BAL   GR2,WRITE               WRITE ON DA FROM BUFFER TWO.     32200016
         LA    GR3,TAPECCW1            CCWS TO FILL BUFFER ONE.         32400016
         ST    GR3,TCCWAD              STORE IN IOB.                    32500016
         EXCP  TAPEIOB                 FILL BUFFER ONE.                 32600016
         EJECT                                                          32700016
*   LINK BACK TO MONITOR HERE.                                          32800016
         TM    SW1,MULTIPLE            ANY REASON TO GO BACK TO MONITOR 32930016
         BZ    WAITOUT2                NO--GO TO WAIT.                  32960016
         LA    GR3,WAITOUT2            RETURN ADDRESS.                  33000016
         B     RETURN1                 RETURN TO MONITOR.               33100016
         SPACE 2                                                        33300016
WAITOUT2 BAL   GR14,WAITDISK           AWAIT OUTPUT OF BUFFER TWO.      33400016
         BAL   GR14,WAITTAPE           AWAIT INPUT OF BUFFER ONE.       33500016
         B     START1                  GO START OUTPUT OF ONE.          33600016
WRITE    EXCP  DISKIOB                 OUTPUT BUFFER ONE.               33605016
         OC    COPYPTR(4),COPYPTR      ARE WE RESTORING TO MORE DEVICES 33610016
         BCR   8,GR2                   NO--NO COPIES TODAY.             33615016
         L     GR8,COPYPTR             POINTER TO FIRST COPY BLOCK.     33620016
         USING COPYBLK,GR8                                              33625016
MORECOPY LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY      M2888   33627037
         SPACE                                                          33635016
         EXCP  DISKIOB                 WRITE OUT BUFFER ONE TO COPY.    33640016
         SPACE                                                          33645016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           33650016
         BZ    MORE1                   NO--CONTINUE ON.                 33655016
         L     GR8,CCOPYPTR            YES-POINTER TO NEXT COPY BLOCK.  33660016
         B     MORECOPY                GO WRITE ON NEXT DEVICE  M2888   33665002
         SPACE                                                          33670016
MORE1    LA    GR9,BLOCKS              ADDRESSING FOR PRIMARY DEVICES.  33675016
         BR    GR2                     RETURN.                          33680016
         SPACE 1                                                        33700016
WAITTAPE TM    TAPEECB,COMPLETE        IS THE OPERATION COMPLETE.       33800016
         BO    TESTT                   YES-GO TEST THE STATUS.          33900016
         WAIT  ECB=TAPEECB             AWAIT COMPLETION OF TAPE.        34000016
TESTT    EQU   *                                                 M0640  34060020
         CLI   TAPEECB,GOOD            ALL OK                    M0640  34120002
         MVI   TAPEECB,0               CLEAR ECB               @ZA06534 34160037
         BCR   8,GR14                  ALL OKAY//RETURN TO PROCESS.     34170037
         TM    TSTATUS+4,X'01'         WAS A TAPE MARK READ.            34180037
         BZ    IOTERR                   NO--MUST BE ERROR.     @ZA06534 34190037
         TM    FIRSTSW,PROCHDR         READING HDR REC ?        OX2864  34200037
         BNO   NOTHDR                  NO, BRCH                OX2864   34210037
         NI    FIRSTSW,X'FF'-PROCHDR   RESET PROCESS HDR SWT   OX2864   34220037
         EXCP  TAPEIOB                 REISSUE READ         OX2864      34274537
         B      WAITTAPE                                        OX2864  34274637
NOTHDR   EQU   *                                                NUFRNT  34274737
         L     GR3,PTRCFUNC            CURRENT QUEUE SLOT.              34275016
         TM    0(GR3),PROCESS          THIS FUNCTION REALLY STARTED.    34280016
         BZ    RMESS2                  NO--MUST BE EOF ON INITIAL READ. 34285016
         LA    GR3,TAPEDCB             TAPE DCB ADDRESS.                34290016
         USING IHADCB,GR3                                               34310016
         NI    DCBIFLGS,X'3F'          TURN OFF ERROR FLAGS.            34330016
         B     EOFTAPE                  GO HANDLE EOF           MVMPROB 34350002
         SPACE                                                          34351016
WAITDISK BAL   GR4,WAITD               WAIT ON PRIMARY DEVICE.          34352016
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           34352537
         BCR   8,GR14                  NO--RETURN.                      34353537
         L     GR8,COPYPTR             YES-ADDRESS OF FIRST COPY BLOCK. 34355016
         USING COPYBLK,GR8                                              34356016
WAIT1    LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY.             34357016
         BAL   GR4,WAITD               AWAIT THIS COPY.                 34359016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           34361016
         BZ    WAIT2                   NO--GET SET TO RETURN.           34362016
         L     GR8,CCOPYPTR            YES-ADDRESS OF NEXT COPY BLOCK.  34363016
         B     WAIT1                   GO WAIT ON NEXT COPY.            34364016
WAIT2    LA    GR9,BLOCKS              RESET ADDRESSING/PRIMARY DEVICE. 34374016
         BR    GR14                    RETURN.                          34384016
WAITD    TM    DISKECB,COMPLETE        IS THE OPERATION COMPLETE.       34500016
         BO    TESTD                   YES-GO TEST THE STATUS.          34600016
         WAIT  ECB=DISKECB             AWAIT COMPLETION OF DISK.        34700016
TESTD    EQU   *                                                        34800037
         CLI   DISKECB,GOOD            ALL OK ?                         34805037
         BCR   8,GR4                   YES-RETURN.                      34810016
         TM    DSTATUS+4,EOF1          WAS AN EOF ENCOUNTERED.          34820016
         BCR   1,GR4                   RESTORE CHAIN IS          M2888  34826002
*                                       COMPLETE                 M2888  34832020
         TM    DSENSE+1,NRFOPE        NO,NRF OR OPER INCOMPL   @ZA07406 34840037
         BNO   IOERR                  PERMANENT ERROR                   34845037
         EJECT                                                          34851537
*********************************************************************** 34852002
*                                                                     * 34860002
*   THIS CODING USED ONLY WHEN INTERRUPTED WHILE READ-BACK CHECKING   * 34870016
*     A TRACK-OVERFLOW OR END-OF-FILE RECORD.                         * 34880016
*                                                                     * 34890002
*********************************************************************** 34892002
         SPACE                                                          34894002
         L     GR3,TUCBPTR             YES-ADDRESS OF UCB.              34900016
         USING UCB,GR3                                                  34910016
         CLI  UCBTBYT4,ZEUS1            2305-1 DEVICE ?         SA57293 34920001
         BE   YEAZ                      YES, BRCH               SA57293 34922001
         CLI  UCBTBYT4,ZEUS2            2305-2 DEVICE           SA57293 34924001
         BNE  NOZ                       NO, BRCH                SA57293 34926001
YEAZ     EQU  *                                                 SA57293 34928001
         L    GR3,DDCBAD                GET DCB ADDR            SA57293 34928401
         USING IHADCB,GR3                                       SA57293 34928801
         L    GR3,DCBDEBAD              GET DEB ADDR            SA57293 34929201
         L    GR3,T32(GR3)              GET ZEUS UCB EXPOSURE   SA57293 34929601
NOZ      EQU   *                                                SA57293 34931501
         USING UCB,GR3                                          SA57293 34933401
         CLC   CCHH,UCBSEEK             WERE WE SWITCHED        YL02912 34935302
*                                       TO THE NEXT TRACK.      YL02912 34935702
         BL    REIT                     IF LOW REISSUE           M2916  34937201
         L     GR8,COPYPTR              CHECK COPIES             M2916  34939101
NRFLOOP  LTR   GR8,GR8                  ARE THERE COPIES         M2916  34940037
         BZ    IOERR                    PROCESS ERROR.         @ZA06534 34943037
         L     GR3,CUCBPTR              CHECK COPY UCB           M2916  34946701
         CLC   CCHH,UCBSEEK             SAME SEEK ADDRESS       YL02912 34948602
         BL    REIT                     LOW MEANS RETRY          M2916  34950501
         L     GR8,CCOPYPTR             CHECK FOR MORE COPIES    M2916  34952401
         B     NRFLOOP                                           M2916  34954301
REIT     EQU   *                                                 M2916  34956201
         DROP  3                                                        34958101
         SPACE 1                                                        34960016
         LA    GR3,READR0              ADDRESS OF READ R0 CCW.          34970016
         ST    GR3,DCCWAD              RESET STARTING POINT IN IOB.     34981002
         EXCP  DISKIOB                 FINISH THE CCW CHAIN.            35000016
         B     WAITDISK                GO WAIT ON ALL DEVICES.          35020016
         DROP  8                                                        35028016
         EJECT                                                          35030016
EOFTAPE  L     GR3,TCCWAD              ADDRESS OF LAST USED TAPE CCW.   35400016
         L     GR2,TSTATUS              LOAD CSW-CCW PTR        SA53319 35450001
         SH    GR2,EIGHT                EQUALIZE PTRS           SA62856 35452021
         LA    GR3,0(GR3)               ZERO HIGH BYTE          SA62856 35460021
         LA    GR2,0(GR2)               ZERO HIGH BYTE CSW      SA53319 35470001
         CR    GR3,GR2                  EOF ON 1ST CCW ?        SA53319 35480001
         L     GR3,0(GR3)              READ IN AREA.            SA53319 35482001
         BNE   TSTRESTC                GO DO IT                 XM05460 35592003
         SPACE                                                          35594003
         USING RBUFFER,GR3                                              35600016
OLDTAPE  EQU   *                                                OX02677 35650003
         ST    GR3,TAPEREAD            DATA ADDRESS TO CCW.             35700016
         LA    GR2,TAPEREAD            CCW ADDRESS TO READ TRAILER.     35800016
         ST    GR2,TCCWAD              CCW ADDRESS TO IOB.              35900016
         SPACE                                                          36000016
         EXCP  TAPEIOB                 READ TRAILER             OX02677 36100003
         BAL   GR14,WAITTAPE           AWAIT COMPLETION.                36200016
         SPACE                                                          36500016
*   TEST FOR RESTORE BEING COMPLETE HERE.                               36800016
         SPACE 1                                                        36900016
TSTRESTC EQU   *                                                SA53319 36950001
         OC    REELCK(4),RBUFFER       'OR' IN THE TRAILER RECORD.      36960016
         DROP  3                                                        37020016
         CLC   REELCK(4),REELMASK      ARE WE FINISHED.                 37100016
         BNE   VOLCHK                  NO-CHECK FOR MORE TAPES.  A21395 37200020
         EJECT                                                          37300002
*   FINAL PROCESSING ON COPY VOLUMES HERE, IF ANY.                      37303016
         OC    COPYPTR(4),COPYPTR      ARE COPIES BEING MADE.           37306016
         BZ    EXIT1                   NO--ONLY ONE VOLUME.             37309016
         SPACE                                                          37312016
         L     GR5,COPYPTR             POINTER TO FIRST COPY BLOCK.     37315016
         USING COPYBLK,GR5                                              37318016
EXIT     L     GR8,CUCBPTR             POINTER TO UCB FOR COPY.         37321016
         LA    GR9,CIOBLOCK            I/O BLOCKS FOR COPY DEVICE.      37322016
         LA    GR7,DDNAME3             DDNAME FOR THIS DEVICE.          37323016
         LA    GR2,CALTDATA            ALTERNATE TRACK INFORMATION.     37323816
         ST    GR5,ADDRBUFF            SAVE COPY BLOCK ADDRESS.         37324616
         BAL   GR5,RDVOLID             GO UPDATE THE ALTERNATE TRACK    37325416
         L     GR5,ADDRBUFF            RESTORE COPY BLOCK ADDRESS.      37326216
*                                        INFORMATION AND VOLID.         37327016
         SPACE                                                          37342016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           37345016
         BZ    EXIT1                   NO--GO PROCESS THE ONE VOLUME.   37348016
         L     GR5,CCOPYPTR            YES-ADDRESS OF NEXT COPY.        37351016
         B     EXIT                    GO PROCESS NEXT COPY.            37354016
         DROP  GR5                                                      37357016
         SPACE                                                          37360016
*   FINAL PROCESSING ON PRIMARY DIRECT ACCESS VOLUME HERE.              37366016
EXIT1    LA    GR9,BLOCKS              MAIN I/O BLOCKS.                 37369016
         L     GR8,TUCBPTR             POINTER TO THIS UCB.             37372016
         LA    GR7,DDNAME2             DDNAME FOR THIS DEVICE.          37373016
         LA    GR2,ALTDATA             ALTERNATE TRACK INFORMATION.     37374016
         BAL   GR5,RDVOLID             GO UPDATE THE ALTERNATE TRACK    37375016
*                                        INFORMATION AND VOLID.         37378016
         L     GR15,RETCODE            GET RETURN CODE.                 37428002
         B     FINALR2                 GO EXIT TO THE MONITOR.          37460016
         EJECT                                                          37500016
*********************************************************************** 37550002
*        THE FOLLOWING CODE IS NECESSARY BECAUSE OF A DUMP/REST  A46379 37600002
*        INCOMPATIABILITY BETWEEN RELEASE 18 AND 20.1.           A46379 37650002
*        THREE TAPE MARKS ARE WRITTEN BETWEEN THE TRAILER LABELS A46379 37700002
*        AND THE IEHDASDR TRAILER RECORD UNDER REL. 18, BUT ONLY A46379 37750002
*        TWO ARE WRITTEN BY REL. 20.1.                           A46379 37800002
*********************************************************************** 37850002
         USING IOBLOCKS,9                                               40600016
EOV1     EQU   *                                                OX2864  40610003
         TM    SWITCH,STDLABEL          SL TAPE ?               OX2864  40650003
         BNO   EOV1B                   NO, NO SPACING NEEDED.   OX02864 40726002
         SPACE                                                          40743402
         LA    GR8,TAPECHK             ADDR OF SPACE FORWD CCW   A46379 40743621
         ST    GR8,TCCWAD              STORE THAT ADDR IN IOB    A46379 40743721
SPACETP  EQU   *                                                OX2864  40747203
         EXCP  TAPEIOB                 EXECUTE THE CCW           A46379 40750903
         WAIT  ECB=TAPEECB             WAIT FOR THE SPACE FWD    A46379 40754403
         TM    TSTATUS+4,EOF1          WAS TAPE EOF ENCOUNTERED  A46379 40757921
         BO    SPACETP                 BRANCH IF YES             OX2864 40767903
         CLI   TAPEECB,GOOD                                    @ZA18389 40768500
         BNE   IOTERR                                          @ZA18389 40769100
         LA    GR8,BACKTAPE            ADDR OF SPACE BKWD CCW    A46379 40769921
         ST    GR8,TCCWAD              STORE THAT ADDR IN IOB    A46379 40771921
         EXCP  TAPEIOB                 EXECUTE THE BSP CCW       A46379 40776621
         WAIT  ECB=TAPEECB             WAIT FOR THE SPACE FWD    A46379 40778621
         CLI   TAPEECB,GOOD                                    @ZA18389 40779200
         BNE   IOTERR                                          @ZA18389 40779800
*        END OF ABOVE MENTIONED COMPATIABILITY CODE.             A46379 40780621
EOV1B    EQU   *                                                   1326 40781321
         LA    GR8,TAPEDCB             DCB ADDRESS.                     40786021
         USING IHADCB,8                                                 40800016
         XC    DCBBLKCT(4),DCBBLKCT    INSURE BLOCK COUNT IS ZERO.      40850016
         NI    DCBOFLGS,X'33'          INSURE BITS 0,1,4,5 ARE ZERO.    40900002
         OI    DCBOFLGS,X'04'          INDICATE TAPE MARK READ   A21395 40906037
         EOV   TAPEDCB                                                  41000016
         OI    SWITCH,EOV              REMEMBER VOLUME CROSSOVER.       41050016
         BAL   GR2,CKHEADER            GO READ/VERIFY HEADER    US03168 41052003
         B     PRIME1                  GO START ON NEXT TAPE.   US03168 41100003
         EJECT                                                          41200016
*********************************************************************** 41300016
*                                                                     * 41400016
*   THE FOLLOWING ROUTINE CONVERTS AND SETS UP THE CCWS THAT WERE     * 41500016
*   READ IN FROM TAPE FOR USE UNDER THE OPERATING SYSTEM. THIS        * 41600016
*   ROUTINE ALSO INCREMENTS THE TRACK ADDRESS AND STORES IT IN        * 41700016
*   THE IOB.                                                          * 41800016
*        REGISTER 2 MUST CONTAIN THE ADDRESS OF THE BUFFER.           * 41900037
*          UPON ENTRY.                                                * 42000016
*        REGISTER 6 IS USED AS A WORK REGISTER.                       * 42100016
*        REGISTER 7 IS A POINTER TO THE CURRENT CCW BEING CHECKED.    * 42200016
*        REGISTER 14 IS THE RETURN REGISTER.                          * 42300016
*********************************************************************** 42500016
         SPACE                                                          42550002
         USING RBUFFER,GR2                                              42700037
CONVCCW  L     GR4,IODEVCON            DEVICE CONSTANT ADDRESS @ZA06534 42900037
         USING CONSTANT,GR4                                    @ZA06534 42970037
         XC    ZERO1,ZERO1             CLR FIRST 8 BYTES OF BUF@ZA06534 43040037
         LR    GR0,GR2                 BUFFER ADDRESS.         @ZA06534 43110037
         AH    GR0,CCWSIZE             DATA SLOT ADDRESS.               43200016
         LA    GR9,BLOCKS              ADDRESS OF I/O CONTROL BLOCKS.   43300016
         USING IOBLOCKS,9                                               43400016
         LA    GR7,SEARIDE             FIRST CCW TO BE CHECKED.         43600016
         TM    SEQSW+D1,RPSFEAT        TODD HAVE RPS                    43620002
         BZ    TESTCCW                 NO                               43640002
         MVC   SETMASK(L8),SETCCW      YES,MOVE SECTOR CCW              43660002
*                                       INTO BUFFER OVER SFM CCW        43680002
TESTCCW  CLI   0(GR7),8                IS THIS A TIC COMMAND.           43700016
         BE    YESTIC                  YES-GO PROCESS.                  43800016
         MVI   TICSW,X'00'             NO--INSURE TIC SWITCH IS CLEAR.  43900016
         CLI   0(GR7),X'31'            IS THIS A SEARCH ID EQUAL.       44000016
         BE    YESSRCH                 YES-GO PROCESS.                  44100016
         CLI   0(GR7),X'1D'            IS THIS A WRITE COUNT-KEY-DATA   44200016
         BNE   NOTWCKD                 NO, CONTINUE CHKING      YM2241  44300002
         CLC   6(2,GR7),TOBIG          MAX BYTE COUNT           YM2241  44350002
         BNE   WRTCKD                  NO, CONTINUE CHK         YM2241  44360002
         MVC   6(2,GR7),DATASIZE       SET CNT TO BUFFSIZE      YM2241  44370002
         B     WRTCKD                  CONTINUE                 YM2241  44380002
NOTWCKD  EQU   *                       CONTINUE CHKING          YM2241  44390002
         CLI   0(GR7),X'05'            IS THIS A WRITE DATA.            44400016
         BE    WRTDATA                 YES-GO PROCESS.                  44500016
         CLI   0(GR7),X'11'            IS THIS AN ERASE CCW.            44600016
         BE    ERASE                   YES-GO PROCESS.                  44700016
         CLC   6(2,GR7),TOBIG          MAX BYTE COUNT           YM3473  44750002
         BNE   NOTRCKD                 NO, CONTINUE CHK         YM3473  44760002
         MVC   6(2,GR7),DATASIZE       SET CNT TO BUFFSIZE      YM3473  44770002
NOTRCKD  EQU   *                       CONTINUE CHKING          YM3473  44780002
         CLI   0(GR7),X'01'            IS THIS A WRITE-SPECIAL CKD.     44800016
         BE    WRTCKD                  YES-GO PROCESS.                  44900016
         TM    4(GR7),X'40'            IS THIS THE END OF CHAIN.        45000016
         BZ    CCWEXIT                 YES-RETURN TO CALLER             45100016
NEXTCCW  LA    GR7,8(GR7)              STEP POINTER TO NEXT CCW.        45200016
         B     TESTCCW                 REPEAT FOR THE NEXT CCW.         45300016
YESTIC   LR    GR6,GR7                                                  45400016
         CLI   TICSW,X'FF'             WAS PREVIOUS CCW A TIC.          45500016
         BE    YES2TICS                YES-SPECIAL CASE/TIC FOLLOWS TIC 45600016
         MVI   TICSW,X'FF'             INDICATE A TIC OPERATION.        45700016
         SH    GR6,EIGHT               POINT TO PREVIOUS CCW.           45800016
SETADDR  ST    GR6,ADDRESS             TEMPORARY STORAGE OF ADDRESS.    45900016
         MVC   1(3,GR7),ADDRESS+1      UPDATE ADDRESS FIELD OF CCW.     46000016
         B     NEXTCCW                 GO CHECK THE NEXT CCW.           46100016
YES2TICS LA    GR6,8(GR6)              POINT TO NEXT CCW.               46200016
         MVI   TICSW,X'00'             CLEAR THE TIC SWITCH.            46300016
         B     SETADDR                 UPDATE THE CCW AND CHECK NEXT.   46400016
YESSRCH  LA    GR6,DSEEK+3             ADDRESS OF SEARCH ID IN IOB.     46600016
         B     SETADDR                 UPDATE CCW AND CHECK NEXT.       46800016
WRTCKD   L     GR6,0(GR7)              DATA ADDRESS FROM THIS CCW.      47000016
         LA    GR6,0(GR6)              CLEAR HIGH ORDER BYTE.           47100016
         SH    GR6,BUFFADDR            GET DISPLACEMENT FROM START.     47200016
         AR    GR6,GR0                 ADD THIS TO OS BUFFER START.     47300016
         B     SETADDR                 GO UPDATE CCW ADDRESS.           47400016
WRTDATA  LR    GR6,GR0                 BUFFER ADDRESS FOR DATA.         47600016
         B     SETADDR                 GO UPDATE THE CCW ADDRESS.       47800016
RDCKD    CLC   6(2,GR7),ZERO           IS THIS AN EOF RECORD.           47820016
         BNE   NEXTCCW                 NO--CONTINUE ON.                 47830016
         MVI   0(GR7),X'12'            CHANGE OP CODE TO READ COUNT.    47840016
         B     NEXTCCW                 CONTINUE ON.                     47850016
ERASE    LR    GR6,GR2                 POINTER TO 8-BYTES OF ZERO.      48000037
         ST    GR6,ADDRESS             TEMPORARY STORAGE OF ADDRESS     48100016
         MVC   1(3,GR7),ADDRESS+1      UPDATE ERASE CCW ADDRESS.        48200016
         AGO   .FIX01                                                   48200237
         USING CONSTANT,2                                               48400016
CCWEXIT  L     GR2,IODEVCON            ADDRESSING FOR DEVICE CONSTANT   48500016
.FIX01   ANOP                                                           48500237
CCWEXIT  EQU   *                                               @ZA06534 48500437
         L     GR3,CONTROL+8           CURRENT CCH ADDRESS.             48550016
         MVC   DSEEK+3(4),CONTROL+8    TRACK ADDRESS TO IOB.            48600016
         LA    GR9,BLOCKS              PRIMARY I/O BLOCKS.              48605016
         USING IOBLOCKS,GR9                                             48610016
         LA    GR7,SEARIDE             START OF CCW CHAIN ADDRESS.      48615016
         TM    SEQSW+D1,RPSFEAT        TODD HAVE RPS                    48616002
         BZ    YO                      NO                               48617002
         LA    GR7,SETMASK             YES,POINT TO SET SECTOR          48618002
YO       EQU   *                        *                               48619002
         ST    GR7,DCCWAD              STORE IN IOB.                    48620016
         OC    COPYPTR(4),COPYPTR      ARE THER COPIES.                 48625016
         BZ    Y2                      NO--GO UPDATE THE TRACK ADDRESS. 48630016
         L     GR6,COPYPTR             ADDRESS OF FIRST COPY BLOCK.     48635016
         USING COPYBLK,GR6                                              48640016
Y1       LA    GR9,CIOBLOCK            COPY I/O BLOCKS.                 48645016
         ST    GR7,DCCWAD              CCW ADDRSSS TO COPY IOB.         48650016
         MVC   DSEEK+3(4),CONTROL+8    SET UP SEEK ADDRESS IN COPY IOB. 48655016
         OC    CCOPYPTR(4),CCOPYPTR    ARE THERE MORE COPIES.           48660016
         BZ    Y3                      NO--GO UPDATE THE TRACK ADDRESS. 48665016
         L     GR6,CCOPYPTR            ADDRESS OF NEXT COPY BLOCK.      48670016
         B     Y1                      GO PROCESS THIS COPY.            48675016
         DROP  GR6                                                      48680016
Y3       LA    GR9,BLOCKS              RESET ADDRESSING/PRIMARY BLOCKS. 48685016
Y2       CLC   DSEEK+6(1),LASTORIG+3   THIS LAST TRACK OF CYLINDER.     48690016
         BC    4,CCWEXIT1              NO--                             48800016
         A     GR3,CONVCYL             YES-STEP TO NEXT CYLINDER.       48900016
         B     CCWEXIT2                SKIP TRACK INCREMENT.            48950002
CCWEXIT1 AL    GR3,F1                  INCREMENT TO NEXT TRACK.         49800016
CCWEXIT2 ST    GR3,CONTROL+8           SAVE NEW VALUE.                  49900016
         BR    GR14                    RETURN.                          50000016
         DROP  GR2,GR4,GR9                                              50000137
         EJECT                                                          50210016
*********************************************************************** 50220016
*                                                                     * 50230016
*   THIS ROUTINE READS IN THE VOLUME LABEL OF THE DIRECT ACCESS       * 50240016
*     DEVICE. IF THE OLD SERIAL NUMBER IS TO BE RETAINED AND IT IS    * 50250016
*     DIFFERENT FROM THE NEW SERIAL NUMBER,THEN THE VOLUME LABEL IS   * 50260032
*     REWRITTEN WITH THE OLD SERIAL NUMBER. THIS ROUTINE ALSO         * 50270016
*     DSCB. THE ACTUAL SERIAL NO. OF THE VOLUME BEING RESTORED IS     * 50280037
*     ALSO SET UP IN THE COMPLETION MESSAGE FOR SUBSEQUENT PRINTING   * 50286037
*     THE ROUTINE TO ACCOMPLISH THIS IS CALLED BY -IEHDREST- AND  IS  * 50292037
*     NAMED -IEHDRVID-                                                * 50298037
*                                                                     * 50304037
*        REGISTER 8 MUST POINT TO THE UCB FOR THE DA DEVICE.          * 50310016
*        REGISTER 9 MUST POINT TO THE DIRECT ACCESS CONTROL BLOCKS    * 50320016
*        REGISTER 7 MUST POINT TO THE DDNAME UPON ENTRY.              * 50325016
*          UPON ENTRY.                                                * 50330016
*        REGISTER 6 IS A WORK REGISTER.                               * 50335016
*        REGISTER 3 IS A WORK REGISTER.                               * 50340016
*        REGISTER 2 MUST POINT TO THE ALTERNATE TRACK INFORMATION.    * 50346016
*        REGISTER 5 IS THE RETURN REGISTER.                           * 50353016
*                                                                     * 50360016
*********************************************************************** 50370016
         SPACE                                                          50372002
RDVOLID  EQU   *                                                        50390616
         CALL  IEHDRVID                CALL ROUTINE IEHDRVID            50391237
         LTR   GR15,GR15               GOOD RETURN FROM RVID ?          50431237
         BNZ   CHECKRET                NO, CHECK RETURN CODE            50471237
         BR    GR5                     RETURN  TO CALLING RTN           50511237
CHECKRET ST    GR15,RETCODE            SAVE RETURN CODE                 50550032
         CLC   RETCODE(4),UNUSRET      RETURN CODE EQU 4?               50591237
         BNE   UNUSRETX                NO, TERMINATE FUNCTION           50631237
         BR    GR5                     YES, CONTINUE PROCESS            50671237
UNUSRETX EQU   *                                                        50711237
         B     IOERR                   SEND ERROR MESSAGE               50751237
*********************************************************************** 50810002
*                                                                     * 50860002
*   THE FOLLOWING SELECTS MESSAGES TO BE PRINTED.                     * 50870002
*                                                                     * 50910002
*********************************************************************** 50920002
         SPACE                                                          50922002
RMESS1   LA    GR1,MESS15              MESSAGE 815.                     50929016
RMESS1A  BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         50937016
         MVC   0(8,GR1),DDNAME2        MOVE DDNAME TO MESSAGE.          50943016
RMESS1B  BAL   GR9,MSGWRT1             WRITE OUT THE MESSAGE.           50945016
         TM    SWITCH,EOV              DID WE EVER WRITE ON DA VOLUME.  50947016
         BO    UNUSABLE                YES-WE BETTER TELL USER/BEWARE.  50949016
         B     FINAL4                  NO--BETTER EXIT.                 50951016
         SPACE                                                          50955016
RMESS2   LA    GR1,MESS16              MESSAGE 816.                     50961016
         BAL   GR9,BUILD               PLACE MESSAGE IN BUFFER.         50964016
         MVC   0(8,GR1),DDNAME1         DDNAME TO MESSAGE.     @ZA06534 50967037
         B     RMESS1B                 WRITE OUT MESSAGE       @ZA06534 50971037
         SPACE 2                                                        50975037
* PRINT MESSAGE NOTIFYING USER THAT 'CPYVOLID' REQUEST DENIED  @G32DSPD 50979032
UNAUTH   LA    GR1,MESS64              GET MESSAGE ID          @G32DSPD 50979432
         BAL   GR9,BUILD               GET MESSAGE TEXT        @G32DSPD 50980632
         MVC   0(L'IDSAVE,GR1),IDSAVE  PUT VOLID IN MESSAGE    @G32DSPD 50981032
         BAL   GR9,MSGWRT1             GO WRITE MESSAGE        @G32DSPD 50981432
         BR    GR4                     RETURN                  @G32DSPD 50981832
         SPACE 2                                                        50982232
         USING IOBLOCKS,GR9                                             50983037
IOTERR   EQU   *                                               @ZA06534 50987037
         LA    GR3,TAPEIOB             IOB ADDRESS//TAPES.              50994037
         B     IOERR1                  GO GIVE ERROR MESSAGE.           50994616
IOERR    LA    GR3,DISKIOB             IOB ADDRESS.                     50995216
         DROP  9                                                        50995816
IOERR1   EQU   *                       PRINT I/O ERROR MESSAGES HERE.   50996716
         LR    GR7,GR14                SAVE RETURN ADDRESS.    @ZA06534 50997037
         LA    GR1,MESS13              MESSAGE 813.                     50997416
         BAL   GR9,BUILD               PLACE MESSAGE HEADING IN BUFFER. 50998216
         LR    GR1,GR3                 IOB ADDRESS.                     50998516
         SYNADAF ACSMETH=EXCP,PARM1=(1)                                 50998816
         MVC   MESS+22(78),49(GR1)     MOVE SYNAD MESS TO BUFFER SM4350 50999121
         SYNADRLS                                                       50999416
         BAL   GR9,MSGWRT1             WRITE OUT I/O ERROR MSG.         50999516
         LR    GR14,GR7                RESTORE RETURN ADDRESS. @ZA06534 50999737
         LA    GR9,BLOCKS              REG 9 MAY HAVE BEEN     @ZA06534 50999937
*                                      DESTROYED BY ERROR RTN. @ZA06534 51000137
         EJECT                                                          51000502
UNUSABLE EQU   *                                                        51002502
         BAL   GR4,WTOR                 TELL OPER TO VARY UNIT  YL02912 51002902
*                                       OFFLINE.                YL02912 51003302
         LA    GR3,DDNAME2             DDNAME FOR MESSAGE.              51004002
         BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MESSAGE.  51005002
         OC    COPYPTR(4),COPYPTR      ANY COPIES.                      51006002
         BZ    FINAL4                  NO--BRANCH.                      51007002
         USING COPYBLK,GR3                                              51008002
         L     GR3,COPYPTR             PTR TO 1ST OR ONLY COPY BLK.     51009002
UNUSE    BAL   GR4,MSGWRTA             GO TO SET UP AND PRINT MSG.      51010002
         OC    CCOPYPTR(4),CCOPYPTR    MORE COPIES.                     51011002
         BZ    FINAL4                  NO--BRANCH.                      51012002
         L     GR3,CCOPYPTR            YES-PTR TO NEXT COPY BLK.        51013002
         B     UNUSE                   CONTINUE PROCESSING.             51014002
         SPACE                                                          51015002
         USING COPYBLK,GR8                                      YL02912 51015102
WTOR     EQU   *                                                YL02912 51015402
         L     GR3,TUCBPTR              GET PRIME TODD UCB      YL02912 51015802
         BAL   GR9,WRTWTOR              TELL OPER PACK IS BAD.  YL02912 51017802
         OC    COPYPTR(L4),COPYPTR      ANY COPIES ?            YL02912 51019902
         BCR   8,GR4                    NO, EXIT                YL02192 51020102
         L     GR8,COPYPTR              PICKUP COPY BLK ADDR    YL02129 51020202
         L     GR3,CUCBPTR              LOAD COPY UCB ADDR      YL02192 51020502
WRTOP    BAL   GR9,WRTWTOR              TELL OPER AGAIN         YL02192 51020902
         OC    CCOPYPTR(L4),CCOPYPTR    MORE COPIES ?           YL02192 51021302
         BCR   8,GR4                    NO, EXIT                YL02192 51022202
         L     GR8,CCOPYPTR             PICKUP COPY BLK ADDR    YL02129 51022302
         B     WRTOP                    WRITE OPER AGAIN        YL02129 51022502
MSGWRTA  LA    GR1,MESS30              MESSAGE 830.                     51023202
         BAL   GR9,BUILD               GO TO SET UP MSG.                51023402
         MVC   0(8,GR1),0(GR3)         DDNAME TO MESSAGE.               51023602
         BAL   GR9,MSGWRT1             GO TO PRINT MSG.                 51023802
         BR    GR4                     RETURN TO CALLER.                51024002
         USING UCB,GR3                                          YL02912 51024202
WRTWTOR  EQU   *                                                YL02912 51024402
         MVC   RESTMSG+NAMEOFF,UCBNAME GET UCB NAME             YL02912 51024602
RESTMSG  WTOR      'IEH856D  RESTORE HAS FAILED FOR CUU, DEVICE SHOULD *51026602
               BE VARIED OFFLINE.',                                    *51030402
               REPLY,1,DSKECB,ROUTCDE=(4),DESC=(2)             YL02912  51031302
         WAIT  1,ECB=DSKECB        WAIT FOR REPLY              @ZA16473 51031837
         XC    DSKECB,DSKECB       CLEAR ECB                   @ZA16473 51032337
         BR    GR9                      RETURN                  YL02192 51032802
         DROP  GR3                                                      51034302
         DROP  GR8                                                      51035802
         SPACE                                                          51037302
         EJECT                                                          51050802
         SPACE 1                                                        51052302
BUILD    LINK  EP=IEHDMSGB                                              51053802
         BR    GR9                     RETURN.                          51055302
         SPACE 2                                                        51056802
MSGWRT1  EQU   *                                                        51058302
         LINK  EP=IEHDPRNT              WRITE OUT THE MESSAGE    M0543  51059802
         BR    GR9 RETURN               RETURN                   M0543  51061302
         SPACE                                                          51062802
VOLCHK   EQU   *                                                 M0543  51064302
         CLI   VOLNUMB,ONE             MORE THAN 1 VOLUME      @ZA01235 51064702
*                                      SPECIFIED IN JCL        @ZA01235 51065102
         BH    EOV1                    YES,PROCESS NXT TAPE    @ZA01235 51065502
         L     GR3,16                   GET CVT POINTER          M0543  51065802
         L     GR3,0(GR3)               GET TCB POINTER          M0543  51067321
         L     GR3,4(GR3)               GET CURRENT TCB          M0543  51069321
         L     GR3,12(GR3)              GET TIOT POINTER         M0543  51071321
         MVC   MESS48+JNOFFS(8),0(GR3)  PUT JOB NAME IN MESSAGE  OX1801 51073302
         MVC   MESS48+SNOFFS(8),8(GR3)  PUT STEP NAME IN MESSAGE OX1801 51073702
         L     GR8,FUCBPTR             LOAD FROM UCB ADR       @ZA01202 51073802
         MVC   MESS48+UNOFFS(3),13(GR8) PUT UNIT NAME IN MSG   @ZA01202 51073902
MESS48   WTOR  'IEH848D  IS ANOTHER TAPE REQUIRED FOR THIS RESTORE JOB?*51074121
               REPLY Y OR N.    JJJJJJJJ,SSSSSSSS,UUU',ANSW,1,         *51074502
               TAPECB,ROUTCDE=(3),DESC=(2)                     @ZA01202 51074902
         TM    TAPECB,COMPLETE         ANSWER TO MSG.            A21395 51075121
         BO    ANSWCHK                 YES-CHECK ANSWER.         A21395 51092421
         WAIT  ECB=TAPECB              NO-WAIT FOR REPLY.        A21395 51109721
ANSWCHK  EQU   *                                                 A21395 51127021
         MVI   TAPECB,OFF              CLEAR ECB STATUS BYTE.    A21395 51144321
         CLI   ANSW,YES                ANOTHER TAPE.             A21395 51161621
         BNE   CHECKNO                  NO, CHECK OTHER RESPONSE XM6320 51171600
         LA    GR1,MESS50               NO, SETUP ERROR MSG      XM6320 51195602
         BAL   GR9,BUILD                GET PROPER MSG           XM6320 51196000
         MVC   0(8,GR1),DDNAME1         MOVE DDNAME TO MSG       XM6320 51196100
         B     MSGWRT                   GO WRITE MSG             XM6320 51201900
CHECKNO  EQU   *                                                 XM6320 51203900
         CLI   ANSW,NO                 ONLY ONE TAPE.            A21395 51207700
         BNE   VOLCHK                  REWIRTE MSG.              A21395 51213521
         LA    GR1,MESS49              YES-ERROR.                A21395 51230802
         BAL   GR9,BUILD               GET PROPER MSG.           A21395 51248121
MSGWRT   EQU   *                       ALL ERRORS EXIT HERE.            51258102
         BAL   GR9,MSGWRT1             GO WRITE OUT THE MESSAGE.        51268102
FINAL4   LA    GR15,8                  SET UP THE RETURN CODE           51278102
         ST    GR15,RETCODE            SAVE THE RETURN CODE             51280102
*   EXIT TO MONITOR HERE.                                               51282102
FINALR2  L     GR3,PTRCFUNC            SLOT FOR THIS CURRENT FUNCTION.  51282502
         MVI   0(GR3),COMPLETE         INDICATE IT IS COMPLETE.         51282602
         TM    FLGBYT2,CPYREJEC        RACF REJECTED CPYVOLID  @G32DSPD 51283532
         BNO   FINAL3                  NO,KEEP R-CODE          @G32DSPD 51284432
         CLM   GR15,B'0001',RC4        R-CODE ALREADY G.E. 4   @G32DSPD 51285332
         BNL   FINAL3                  YES,DONT CHANGE         @G32DSPD 51286232
         LA    GR15,4                  USE R-CODE 4            @G32DSPD 51287132
FINAL3   L     GR13,RESTSAVE+4         RESTORE REGISTER 13.             51288402
         RETURN (14,12),T,RC=(15)      RESTORE/RETURN W/PROPER CODE.    51298402
         EJECT                                                          51300002
*********************************************************************** 51350002
*                                                                     * 51350402
*    DEFINED CONSTANTS.                                               * 51350502
*                                                                     * 51350602
*********************************************************************** 51350702
         SPACE                                                          51367102
F1       DC    F'1'                    USED TO INCREMENT TRACK ADDRESS. 51400016
ZERO     DC    F'0'                                                     51500016
REPLY    DC    F'0'                     ECB FOR WTOR FOR IEH856 YL02912 51510002
DSKECB   DC    F'0'                     ECB FOR WTOR FOR IEH856 YL02912 51520002
FUNCTION DC    C'RESTORE TO'           MESSAGE FILL IN.                 51550016
REELMASK DC    X'FFFFFFFE'             USED TO CHECK FOR LAST REEL TAPE 51600016
TOBIG    EQU   REELMASK                MAX CCW BYTE CNT         YM2241  51650002
EIGHT    DC    H'8'                                                     51700016
UNUSRET  DC    F'4'                    RETURN CODE OF 4.                51860002
BUFFADDR DC    X'3E18'                 STAND ALONE D/R BUFFER ADDRESS.  51870002
PROCHDR  EQU   X'04'                   INDIC IEHDASDR HEADER   OX2864   51880403
*                                       RECORDS ARE BEING PROC. OX2864  51880803
NLBLP    EQU   X'11'                    INDIC NL OR BLP LABELS  OX2864  51881203
JNOFFS   EQU   88                      IEH848D JOBNAME OFFSET    OX1801 51882002
SNOFFS   EQU   97                      IEH848D STEPNAME OFFSET   OX1801 51884002
YES      EQU   X'E8'                   POSITIVE REPLY.           A21395 51885020
UNOFFS   EQU   106                     DISP FOR UNIT NAME      @ZA01202 51887002
NO       EQU   X'D5'                   NEGATIVE REPLY.           A21395 51890020
ONE      EQU   1                                                 XM6320 51899001
GOOD     EQU   X'7F'                   NO ERRORS ON I/O.                51900016
SACODE5  DC    X'63C24D'               CODE THAT IDENTIFIES RESTORE TP. 51990037
ON       EQU   X'FF'                   SWITCH ON.                       52000016
OFF      EQU   X'00'                   SWITCH OFF.                      52100016
BLANK    EQU   C' '                    BLANK CHARACTER.                 52200016
NRF      EQU   X'08'                   NO RECORD FOUND INDICATOR.       52260016
EOF1     EQU   X'01'                   END-OF-FILE INDICATOR.           52320016
HEX1     EQU   X'01'                                            OX03063 52322002
SEARCH   EQU   X'31'                   SEARCH CCW COMMAND CODE          52328002
SWOFF    EQU   X'BF'                   SET RPS SWITCH OFF               52332002
D1       EQU   1                       DISP OF 1                        52336002
EQ       EQU   8                       EQUAL CONDITION.                 52338002
L8       EQU   8                       LENGTH OF 8                      52340002
K6       EQU   6                       DISPLACEMENT CONSTANT.    S20201 52344020
K16      EQU   *                       DISPLACEMENT CONSTANT.    S20201 52348020
K28      EQU   *                       DISPLACEMENT CONSTANT.    S20201 52352020
RPSFEAT  EQU   X'40'                   RPS FEATURE SWITCH               52356002
D16      EQU   16                       DISPL IN TRK-IMAGE REC  SA53319 52356401
X07      EQU   X'07'                    TRK-IMAGE SEEK CMD      SA53319 52356801
T32      EQU   32                       OFFSET INTO DEB TO UCB  SA57293 52358001
ZEUS1    EQU   6                        2305-1 UCB DEV TYPE     SA57293 52358401
ZEUS2    EQU   7                        2305-2 UCB DEV TYPE     SA57293 52358801
L4       EQU   4                                                 A30548 52360019
VOL1L    EQU   96                       VOL1 RECORD LENGTH      YL02912 52370002
RDHA     EQU   X'1A'                    READ HOME-ADDRESS CMD   YL02912 52380002
CCSILI   EQU   X'60'                    CCW CMD-CHNG AND SILI   YL02912 52390002
SILI     EQU   X'20'                    CCW SILI BIT MASK       YL02912 52400002
ALTRK    EQU   X'01'                    HOME ADDR FLAG FOR AN   YL02912 52402002
*                                       ALTERNATE TRACK.        YL02912 52404002
NAMEOFF  EQU   48                       IEH856 UCBNAME OFFSET   YL02912 52405037
VTCDISP  EQU   11                                                       52406437
TWO      EQU   2                                                        52406537
L5       EQU   5                                                        52406837
L6       EQU   6                                                        52406937
N0       EQU   0                                                        52407037
N4       EQU   4                                                        52407137
N5       EQU   5                                                        52407237
UNITTYP  EQU   19                       UNITTYPE OFFSET IN UCB @ZA04433 52408037
NRFOPE   EQU   X'09'                   NRF/OPER INCOMPL IND    @ZA07406 52410037
DWORDFF  DC    X'FFFFFFFF'                                              52413637
IOTAB    DC    C'0123456789ABCDEF'                                      52416237
L9       EQU   9                                                        52418837
FULL     EQU   X'F0'                                                    52421437
ALTER    EQU   82                                                       52437037
MSGCON   DC    C'82,'                                                   52439637
RC8      DC    X'08'                     TEST RACF RETURN CODE @G32DSPD 52440632
RC4      DC    AL1(4)                    TEST RACF RETURN CODE @G32DSPD 52441432
COMMA    EQU   C','                                                     52442237
PERIOD   EQU   C'.'                                                     52444837
         EJECT                                                          52447437
*********************************************************************** 52450002
*                                                                     * 52460002
*   TABLE OF UCB DEVICE TYPE CODES.                                   * 52470002
*                                                                     * 52480002
*********************************************************************** 52490002
         SPACE                                                          52492002
CODES    DC    X'05'                   2321 UCB DEVICE TYPE CODE.       52500016
         DC    X'01'                   2311                             52600016
         DC    X'08'                   2314                             52700016
         DC    X'04'                   2302                             52800016
         DC    X'03'                   2303                             52900016
         DC    X'02'                   2301                             53000016
         DC    X'06'                   2305-1                           53020002
         DC    X'07'                   2305-2                           53040002
         DC    X'00'                   NOT USED                         53060002
         DC    X'09'                   3330                             53080002
         DC    X'0A'                   3340                             53090002
         DC    X'0B'                   MADRID(3350)            MADRID   53092037
         DC    X'0C'                   UNUSED DEVICE TYPE               53094002
         DC    X'0D'                   3330-1                           53096002
D0       EQU   0                        ZERO DISPL.             XL03145 53096403
ICEBERG  EQU   X'0D'                    UCB DEVICE TYPE         XL03145 53096803
MERLN    EQU   X'09'                    MERLIN DEVICE TYPE      XL03145 53097203
DOSCON   EQU   X'80'                    FORMAT 4 DOS CONTAM BIT XL03145 53098003
D14      EQU   14                       FORMAT 4 DSCB OFFSET    XL03145 53098403
D22      EQU   22                       DISPL TO WINCHESTER     XL03145 53098803
*                                       MODEL NO.               XL03145 53099203
WINCH    EQU   X'0A'                    3340 DEVICE TYPE.       XL03145 53099302
L2       EQU   2                                                XL03145 53099603
D18      EQU   18                       F4 DSCB CYL OFFSET      XL03145 53099703
SACODE4  DC    X'63B24D'               CODE THAT IDENTIFIES RESTORE TP. 53100016
         EJECT                                                          53102002
*********************************************************************** 53104002
*                                                                     * 53106002
*        VOLID RETAIN CCW'S                                           * 53112002
*                                                                     * 53118002
*********************************************************************** 53120002
         SPACE                                                          53122002
SRCHKEYR CCW   X'31',SRKEY,X'60',5      SEARCH ID EQ             M2888  53124020
         CCW   8,SRCHKEYR,0,0                                    M0640  53130020
RDVOLSER CCW   X'00',0,X'20',92         READ/WRITE VOL SER       M6350  53140020
TAPEREAD CCW   2,0,X'20',24            USED TO READ IN CONTROL RECORD.  53220016
BACKTAPE CCW   X'27',0,X'30',1         BACKSPACE 1 TAPE RECORD   A46379 53222021
TAPECHK  CCW   X'02',0,X'30',1         FWD SPACE 1 TAPE RECORD  VS08412 53224002
         SPACE                                                          53230020
SETCCW   CCW   X'23',F1,X'40',1         SET SECTOR ZERO                 53242002
SECTIC   CCW   8,0,0,0                                           S20201 53250020
         SPACE                                                          53260020
READVTOC CCW   X'31',0,X'60',5         SEARCH ON RECORD 1 OF VTOC.      53300016
         CCW   8,READVTOC,0,0          REPEAT UNTIL FOUND.              53400016
RDVDATA  CCW   6,0,X'20',96            READ FORMAT 4 DATA.              53500016
RHA      CCW   X'1A',0,X'20',5          READ HA OF VOL1 TRK     YL02912 53510002
READR0   CCW   X'16',0,X'30',16        READ-BACK CHECK R0 ON            53530016
*                                        OVERFLOW TRACKS.               53560016
         SPACE                                                          53580402
*********************************************************************** 53582002
*                                                                     * 53584002
*   DEFINED STORAGE.                                                  * 53586002
*                                                                     * 53588002
*********************************************************************** 53588402
         SPACE                                                          53588802
TAPECB   DC    F'0'                    WAIT OR COMPLETION BITS.  A21395 53590002
RESTSAVE DS    18F                     SAVE AREA FOR CALLED ROUTINES.   53600016
ADDRBUFF DC    F'0'                                                     53900016
CCHHADDR DS    1F                      IPL TRACK ADDRESS.               53950016
RETCODE  DC    F'0'                    RETURN CODE SAVE AREA.           53952002
ANSW     DS    CL1                     OPERATOR REPLY AREA.      A21395 53960002
SRKEY    DC    X'0000000003'           SEARCH ARGUMENT                  54000002
REPLYECB DS    1F                                                       54010032
RACVOL   DS    CL6                     VOLID FOR RACHECK       @G32DSPD 55010032
         TITLE 'IEHDREST - MAINT. AREA '                                56130037
         SPACE 2                                                        56230037
*********************************************************************** 56330037
*           MAINTENANCE AREA - PATCH SPACE                            * 56430037
*                                                                     * 56530037
MAINT    DC    10CL10'PATCH'     EBCDIC FOR EYEBALLING DUMP             56630037
*                                                                     * 56730037
*********************************************************************** 56830037
         SPACE 3                                                        56930037
*********************************************************************** 57030037
         SPACE  4                                                       57130037
*******************  END OF MODULE  *********************************** 57230037
         TITLE 'IEHDREST - RESTORE FUNCTION'                            57330037
         EJECT                                                          58200016
IOBLOCKS DSECT                                                          61702016
*   RESTORE DA WRITE-OUT ECB.                                           61704016
DISKECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   61706016
         SPACE 1                                                        61708016
*   RESTORE DA WRITE-OUT IOB.                                           61710016
DISKIOB  DS    0F                                                       61712016
DISKFLG  DS    CL2                     FLAGS 1 AND 2.                   61714016
DSENSE   DS    CL2                     SENSE BYTES.                     61716016
DECBAD   DS    1F                      ECB ADDRESS.                     61718016
DSTATUS  DS    2F                      CHANNEL STATUS.                  61720016
DCCWAD   DS    1F                      CCW LIST ADDRESS.                61722016
DDCBAD   DS    1F                      DCB ADDRESS.                     61724016
DRESAD   DS    1F                      RESTART ADDRESS.                 61726016
DBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           61728016
DERROR1  DS    CL2                     ERROR COUNT                      61730016
DSEEK    DS    2F                      MBBCCHHR.                        61732016
BB       EQU   DSEEK+1                 BIN ADDRESS.                     61733016
CCHH     EQU   DSEEK+3                 CYLINDER-HEAD ADDRESS.           61734016
R        EQU   DSEEK+7                 RECORD NUMBER.                   61736016
         SPACE 1                                                        61738016
*   RESTORE DA WRITE-OUT DCB.                                           61740016
DISKDCB  DS    18F                                                      61742016
         SPACE 2                                                        61744016
*   RESTORE TAPE READ-IN ECB.                                           61746016
TAPEECB  DS    1F                      WAIT//COMPLETE BITS PLUS CODE.   61748016
         SPACE 1                                                        61750016
*   RESTORE TAPE READ-IN IOB.                                           61752016
TAPEIOB  DS    0F                                                       61754016
TAPEFLG  DS    CL2                     FLAGS 1 AND 2.                   61756016
TSENSE   DS    CL2                     SENSE BYTES.                     61758016
TECBAD   DS    1F                      ECB ADDRESS                      61760016
TSTATUS  DS    2F                      CHANNEL STATUS.                  61762016
TCCWAD   DS    1F                      CCW LIST ADDRESS.                61764016
TDCBAD   DS    1F                      DCB ADDRESS.                     61766016
TRESAD   DS    1F                      RESTART ADDRESS.                 61768016
TBLKCT   DS    CL2                     BLOCK COUNT INCREMENT.           61770016
TERROR   DS    CL2                     ERROR COUNT                      61772016
         SPACE 1                                                        61774016
*   RESTORE TAPE READ-IN DCB NUMBER ONE.                                61776016
TAPEDCB  DS    13F                                                      61778016
         SPACE 1                                                        61780016
*   CCWS TO READ-IN RESTORE TAPE.                                       61782016
         DS    0D                      ALIGNMENT.                       61784016
TAPECCW1 DS    CL8                     USED TO READ CCW RECORD.         61786016
TAPEDAT1 DS    CL8                     USED TO READ DATA RECORD.        61788016
TAPECCW2 DS    CL8                     USED TO READ CCW RECORD.         61790016
TAPEDAT2 DS    CL8                     USED TO READ DATA RECORD.        61792016
IOBLKEND DS    0H                      END OF IOBLOCKS DSECT.           61794016
         SPACE 1                                                        61800016
         IEHDBLKS                                                       62400016
         EJECT                                                          63000016
         IEHDWORK                                                       63600016
         SPACE                                                          63900016
VLABEL   DSECT                                                          64310016
VOLUME   DS    CL3                     LABEL IDENTIFIER.                64320016
VOLNO    DS    CL1                     LABEL NUMBER.                    64330016
SERIAL   DS    CL6                     LABEL SERIAL NUMBER.             64340016
SECURITY DS    CL1                     VOLUME SECURITY.                 64350016
VTOCPTR  DS    CL10                    POINTER TO VTOC                  64360016
         DS    CL20                    RESERVED.                        64370016
OWNER    DS    CL10                    OWNER IDENTIFICATION.            64380016
         DS    CL29                    BLANK.                           64390016
         SPACE                                                          66390016
RBUFFER  DSECT                                                          68900016
ZERO1    DS    CL8                     WILL CONTAIN 8 BYTES OF ZEROS.   69000016
CCWBUFF  EQU   ZERO1                                                    69100016
L1       EQU   1                       LENGTH ATTRIBUTE                 69150002
TICSW    DS    CL1                     'FF' INDICATES PREVIOUS CCW=TIC. 69200016
         DS    CL3                     NOT USED.                        69300016
ADDRESS  DS    CL4                     TEMPORARY ADDRESS HOLDER.        69400016
SEEKCCW  DS    CL8                     SEEK CCW FOR STAND-ALONE.        69500016
SETMASK  DS    CL8                     SET FILE MASK FOR STAND-ALONE.   69600016
SEARIDE  DS    CL8                     SEARCH EQUAL ID CCW.             69700016
         EJECT                                                          69900016
         ICHPRCVT                                              @ZA25515 69930099
         EJECT                                                          69960099
CVT      DSECT                                                          70000016
         CVT                                                            70100032
         EJECT                                                          70200016
UCB      DSECT                                                          70300016
         IEFUCBOB                                                       70400016
         EJECT                                                          70500016
JFCB     DSECT                                                          70600016
         IEFJFCBN                                                       70700016
         EJECT                                                          70800016
         DCBD  DSORG=PS                                                 70900016
         END                                                            71000016
