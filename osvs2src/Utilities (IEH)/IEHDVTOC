         TITLE  'IEHDVTOC  VTOC CONSTRUCTION MODULE'                    00100016
         COPY  LCGASMSW                                          SM4351 00150021
IEHDVTOC CSECT                                                          00200016
*A 039182,208,478040                                           @VS40037 00201003
* SCAN ALTERN. TRKS WHEN BUILDING ONLINE VTOC.                 @VS40452 00201503
* FIX @VS40452 PROBLEM.                                        @ZA06534 00202503
*D 418000,419000                     NOT OS  @YA04836=@XA05835=@ZA01205 00203502
*A 417400,417500                     NOT OS  @YA04836=@XA05835=@ZA01205 00205502
***************************************************************@ZA01205 00205902
*3506487000,488000,498400,600700                                 M2888  00207202
* 040004-040005                                                  YM0911 00208802
*        RELEASE 23 DELETIONS                                         * 00210402
*                                                               XM4389  00212002
*        RELEASE 22 DELETIONS                                         * 00213602
*        RELEASE 21 DELETIONS                                         * 00215202
*                                                                Y21107 00216802
*        RELEASE 20 DELETIONS                                         * 00218402
*3506055000-056000,065100-066100,482000,487000,498100-498700,    S20201 00220002
*3506577500,579500,582500-583500,600700,604000,613500            S20201 00221602
*3506479500                                                      M5900  00223202
*3506064300-069000,479000,583000,601000,605000                   JUDITH 00224802
*3506240880                                                      A32162 00226402
*3506039009                                                      A35837 00228002
*3506063000-064000,482000,487000,494000                          A34946 00229602
*3506039009,039252,039255,039258,039261,039360,039432,039435,    S20201 00231202
*3506039477                                                      S20201 00232802
*3506479460-479520                                               M6129  00234402
*        RELEASE 19 DELETIONS                                           00236002
*037000,448000-449900                                            O122   00237602
*        RELEASE 18 DELETIONS                                           00239202
*3109417600                                                      3649   00240802
*                                                                       00242402
*STATUS CHANGE LEVEL 004                                                00244002
*                                                                     * 00245602
*FUNCTION/OPERATION- THIS ROUTINE FORMATS THE VTOC,WRITES VOLUME      * 00247202
*   LABEL,IPL TEXT AND IPL BOOTSTRAP RECORDS. IT ALSO READS IPL TEXT  * 00248802
*   FROM EXTERNAL STORAGE WHEN SO REQUESTED.                          * 00250402
*   THIS ROUTINE FORMATS THE VTOC BY WRITING A FORMAT 4 DSCB THAT     * 00252002
*   DESCRIBES THE DEVICE CHARACTERISTICS OF THIS VOLUME. IT ALSO      * 00253602
*   CALCULATE THE TRACKS AVAILABLE FOR ALLOCATION AND CONSTRUCTS      * 00255202
*   A FORMAT 5 DSCB FROM THIS CALCULATION. THESE TWO DSCB ARE WRITTEN * 00256802
*   AND THE REMAINDER OF THE VTOC WITH FORMAT 0 DSCBS.                * 00258402
*                                                                     * 00260002
*ENTRY POINT- THE ONLY ENTRY POINT IS -IEHDVTOC- AND THIS MODULE IS   * 00261602
*   INVOKED ONLY BY IEHDANAL.                                         * 00263202
*                                                                     * 00264802
*INPUT- UPON ENTRY REGISTER 1 POINTS TO IEHDANAL WORKAREA,REGISTER 10 * 00266402
*   POINTS TO A FUNCTION BLOCK, REGISTER 12 POINTS TO A COMMUNCIATION * 00268002
*   WORKAREA,REGISTER 13 HAS A POINTER TO A REGISTER SAVE AREA,AND    * 00269602
*   REGISTER 14 CONTAIN A RETURN ADDRESS.                             * 00271202
*                                                                     * 00272802
*EXITS-NORMAL- ON  SUCCESSFUL COMPLETION -IEHDVTOC- RETURNS TO        * 00274402
*   -IEHDANAL- WITH A RETURN CODE OF 0 IN REGISTER 15.                * 00276002
*                                                                     * 00277602
*EXITS-ERROR- ON UNSUCCESSFUL COMPLETION -IEHDVTOC- RETURNS TO        * 00279202
*    -IEHDANAL- WITH A RETURN CODE OF 8 IN REGISTER 15 AND A MESSAGE  * 00280802
*    DESCRIBING THE ERROR IN THE MESSAGE DATA SET.                    * 00282402
*                                                                     * 00284002
*EXTERNAL ROUTINES- THIS ROUTINE IS ALWAYS INVOKED BY -IEHDANAL-.     * 00285602
*    IT IN TURNS INVOKES IEHDMSGB AND IEHDPRNT TO CONSTRUCT AND WRITE * 00287202
*    MESSAGES INTO THE MESSAGE DATA SET.                              * 00288802
*                                                                     * 00290402
*TABLES/WORKAREA- UPON ENTRY REGISTERS 1,10 AND 12 POINT TO  IEHDANAL * 00292002
*    WORKAREA,FUNCTION BLOCK AND A COMMUNICATION WORKAREA RESPECT-    * 00293602
*    IVELY. THEY ARE DESCRIBED BY DSECTS CALLED WORKAREA,FUNCBLK AND  * 00295202
*    WORK.                                                            * 00296802
         SPACE 3                                                        00298402
REG0     EQU   0                  PARAMETER REG.                        00300016
REG1     EQU   1                  PARAMETER LIST POINTER REG.           00400016
REG2     EQU   2                  REGS                                  00500016
REG3     EQU   3                       TWO                              00600016
REG4     EQU   4                           THRU                         00700016
REG5     EQU   5                                SEVEN                   00800016
REG6     EQU   6                                      WORK              00900016
REG7     EQU   7                                           REGS.        01000016
REG8     EQU   8                  PROGRAM BASE REG.                     01100016
REG9     EQU   9                  COPY BLOCK BASE REG.                  01200016
REGA     EQU   10                 FUNCTION BLOCK BASE REG.              01300016
REGB     EQU   11                 WORK AREA BASE REG.                   01400016
REGC     EQU   12                 COMMON WORK AREA REG.                 01500016
REGD     EQU   13                 SAVE AREA POINTER REG.                01600016
REGE     EQU   14                 RETURN ADDRESS REG/UCB BASE REG.      01700016
REGF     EQU   15                 ENTRY POINT REG.                      01800016
         USING IHADCB,REG7                                              01900016
         USING *,REG8                                                   02000016
         USING WORKAREA,REG5                                   @Y30LSFY 02100003
         USING FUNCBLK,REGA                                             02200016
         USING COPYBLK,REG9                                             02300016
         USING WORK,REGC                                                02400016
         USING UCBOB,REG6                                               02500016
         USING CONSTANT,REGE                                            02600016
         SAVE  (14,12),T,*        SAVE REGISTERS IN CALLER'S AREA       02700016
         LR    REG8,REGF          ESTABLISH PROGRAM BASE REGISTER.      02800016
         LR    REG5,REG1          ESTABLISH BASE FOR WORKAREA. @Y30LSFY 02900003
         LA    REGF,SAVEVTOC                                            03000016
         ST    REGF,8(REGD)       SAVE POINTER TO IEHDVTOC SAVE AREA.   03100016
         LA    REG7,FBLOCKS                                             03300016
         ST    REGD,SAVEVTOC+4     STORE PTR TO YOUR SAVEAREA IN MINE.  03400016
         LR    REGD,REGF               POINT TO MY SAVEAREA.   @Y30LSFY 03500003
         XC    DEXTNTS-D2(L6),DEXTNTS-D2  CLEAR BB OF BBCCHH.  @Y30LSFY 03550003
         L     REGE,IODEVCON           RESTORE DEV CONSTANT PTR@Y30LSFY 03600003
         STM   REG9,REG2,PRGSAVE       SAVE VOLATILE REGISTERS.@Y30LSFY 03650003
         LA    REG1,DDEB               POINT TO DUMMY DEB.     @Y30LSFY 03700003
         LA    REG2,RCD1CNT            POINT TO CCHH.          @Y30LSFY 03710003
         USING CVT,REGF                                        @Y30LSFY 03720003
         L     REGF,CVTPTR             GET CVT BASE.           @Y30LSFY 03730003
         XC    RCD1CNT(L8),RCD1CNT                             @Y30LSFY 03740003
         MVC   RCD1CNT+D3(L4),LASTORIG SET UP MBBCCHHR.        @Y30LSFY 03742003
         L     REGF,CVTPRLTV           GET ENTRY TO CNVRT RTNE.@Y30LSFY 03744003
         BALR  REGE,REGF          LINK TO CONVERT ROUTINE.     @Y30LSFY 03746003
         SRL   REG0,16                                         @Y30LSFY 03748003
         STH   REG0,RTAVTOCS      SAVE RTA FOR IEHDVTOC.       @Y30LSFY 03748403
         LM    REG9,REG2,PRGSAVE  RESTORE VOLATILE REGISTERS.  @Y30LSFY 03748803
         DROP  REG5                                            @Y30LSFY 03749003
         USING WORKAREA,REGB                                   @Y30LSFY 03749203
         LR    REGB,REG5          REESTABLISH WORKAREA BASE    @Y30LSFY 03749403
         XC    ZEROS(5),ZEROS       INITIALIZE ZEROS.                   03750016
         NI    IPLTRK1,X'00'      TURN IPL TEXT ON TRACK 1 BIT OFF.     03800016
         L     REG6,TUCBPTR       GET POINTER TO PRIMARY UCB.           03900016
         CLI   UCBTBYT4,WIN            IS THIS A 3340?           XM5465 03901103
         BNE   NO3340                  NO, CHECK OTHER DEVICES.  XM5465 03901203
         MVI   PASSCNT+D1,ONE          FORCE ONE PASS ON 3340.   XM5465 03901303
         TM    SEQSW,FLAGTEST          IS FLAGTEST = NO?         XM5465 03901803
         BO    RDALTS                  YES, TEST FOR PASSES.   @ZA06534 03911803
NO3340   EQU   *                                                 XM5465 03918803
         TM    SEQSW+D1,SS1VAL         SS/1 CONVERSION?        @Y30LSFY 03925803
         BO    TEXTCHK                 YES - PASSES=1          @ZA06534 03932803
         CLI   UCBTBYT4,FACTPACK        IS THIS 3330 DEV TYPE?  XL03145 03939803
         BL    RDALTS                   NO, PASS COUNT IS OK.  @ZA06534 03946803
         CLI   FUNCSW,ANALYSIS         IS THIS AN ALNALYZE       A51175 03953803
         BNE   RDALTS                  NO                      @ZA06534 03960803
         CLI   UCBTBYT4,D3350          3350 DEVICE ?           @VS40037 03967803
         BE    RDALTS                  YES, BRCH               @ZA06534 03974803
         OI    SEQSW,PASSES            FORCE PASSES              A51175 03981803
         TM    FLGBYT1,EMU             EMULATION ACTIVE ?      @VS40037 03988803
         BO    RDALTS                  ALLOW PASSES            @ZA06534 03995803
         XC    PASSCNT(2),PASSCNT      ZERO PASSCNT AND COUNT    A51175 04002803
* SET UP CHANNEL PROGRAM TO READ HOME ADDRESS AND R0 OF            O122 04010402
*ALTERNATE TRACKS                                                  O122 04011202
RDALTS   EQU  *                                                @ZM43013 04012003
         LA    REG7,FBLOCKS             GET POINTER TO PRIMARY     O122 04012603
         DROP  REG6                                              S20201 04012802
         USING BUFFREAD,REG6                                     S20201 04013602
         L     REG6,FBUFFPTR                                     S20201 04014402
         L     REGE,IODEVCON            GET ADDRESS OF DEVICE      O122 04015202
         LA    REG4,COMND1              GET CCW AREA ADDR      @ZM43013 04015403
         ST    REG4,CCWPTR              UPDATE IOBCCW PTR      @ZM43013 04015603
*                                          CONSTANTS TABLE         O122 04016002
         L     REG3,LASTORIG            GET LAST PRIMARY TRACK ADDRO122 04016802
         A     REG3,CONVCYL             UPDATE TO FIRST ALTERNATE  O122 04017602
         ST    REG3,SKADDR              SAVE ADDRESS               O122 04018402
         MVC   SEEKADDR+3(4),SKADDR     STORE IT IN SEEK ADDRESS   O122 04019202
         XC    SEEKADDR+7(1),SEEKADDR+7 CLEAR R OF SEEK ADDRESS    O122 04020002
         MVC   NOALT(2),TOTALALT        SAVE MAXIMUM NUMBER ALTS   O122 04020802
         XC    TRKSW(1),TRKSW           SET SWITCH TO ZERO         O122 04021602
         LM    REG0,REG3,CCW01          LOAD READ CCW'S            O122 04022402
         ALR   REG0,REG6                ADJUST DISPLACEMENT        O122 04023202
         ALR   REG2,REG6                *                          O122 04024002
         STM   REG0,REG3,COMND1         STORE CCW'S                O122 04024802
         BAL   REG5,FACTCHK             READ FROM ALTERNATE TRACK  O122 04025602
         B     CHKALT                   CHECK ALTERNATE TRACK      O122 04026402
*                                                                  O122 04027202
FACTCHK  EQU   *                                                   O122 04028002
         EXCP  WKAIOB                   EXECUTE CHANNEL PROGRAM    O122 04028802
         WAIT  1,ECB=WKAECB             WAIT FOR I/O TO COMPLETE   O122 04029602
         CLI   WKAECB,X'7F'             I/O SUCCESSFUL             O122 04030402
         BE    GOOK                     YES, OK                    O122 04031202
         CLI   WKAECB,X'41'             CSW CONTENTS USEFUL IN IOB O122 04032002
         BNE   IOERROR2                 NO, PUT OUT MESSAGE        O122 04032802
         CLI   IOBCSWST,UE              UNIT EXCEPTION             O122 04033602
         BNE   IOERROR2                 NO, PUT OUT MESSAGE        O122 04034402
GOOK     BR    REG5                     RETURN                     O122 04035202
CHKALT   EQU   *                                                   O122 04036002
         TM    ALTHA,X'02'              IS TRACK DEFECTIVE         O122 04036802
         BO    UPDATE                   YES, UPDATE ALT TRACK      O122 04037602
*                                          INFORMATION             O122 04038402
         CLC   ALTHA+1(4),ALTR0         IS TRACK ASSIGNED          O122 04039202
         BNE   UPDATE                   YES, UPDATE ALT TRK INFO   O122 04040002
         TM    TRKSW,TRKFND             HAS FIRST AVAILABLE ALTER- O122 04040802
*                                          NATE BEEN FOUND         O122 04041602
         BO    UPCCHH                   YES, CHECK FOR LAST        O122 04042402
*                                          ALTERNATE TRACK         O122 04043202
         OI    TRKSW,TRKFND             SET SWITCH FOR FIRST AVAIL-O122 04044002
*                                          ABLE ALTERNATE FOUND    O122 04044802
         MVC   ALTINFO(4),ALTHA+1       SET ADDR OF FIRST          O122 04046402
*                                          AVAILABLE ALTERNATE     O122 04047202
UPCCHH   EQU   *                                                   O122 04048002
         CLC   ALTHA+1(4),LASTALT       WAS LAST ALTERNATE CHECKED O122 04048802
         BNL   CHKCOPY                  YES, CHECK FOR MORE COPIES O122 04049602
         MVC   SAVECCHH(4),ALTHA+1      GET CURRENT CCHH           O122 04050402
         L     REG3,SAVECCHH            *                          O122 04051202
         CLC   SEEKADDR+6(1),LASTORIG+3 LAST TRACK OF CYLINDER     O122 04052002
         BC    4,UPCCHH1                NO --                      O122 04052802
         A     REG3,CONVCYL             INCREMENT CYLINDER         O122 04053602
         AIF   ('&LIB' EQ 'LIB2').X227320                       XL03912 04054003
CK2321   EQU   *                                                   O122 04054402
         CLI   SEEKADDR+5,X'04'         IS THIS A 2321 AND LAST CYLO122 04055202
         BC    7,UPCCHH2                NO --                      O122 04056002
         AL    REG3,STC2321             INCREMENT STRIP            O122 04056802
         CLI   SEEKADDR+4,X'09'         THIS LAST STRIP            O122 04057602
         BC    7,UPCCHH2                NO --                      O122 04058402
         AL    REG3,SCC2321             INCREMENT SUBCELL          O122 04059202
.X227320 ANOP                                                   XL03912 04059603
         B     UPCCHH2                  STORE VALUE                O122 04060002
UPCCHH1  AH    REG3,HA1                 INCREMENT TO NEXT TRACK    O122 04060802
UPCCHH2  ST    REG3,SAVECCHH            STORE UPDATED CCHH         O122 04061602
         MVC   SEEKADDR+3(4),SAVECCHH   UPDATE SEEK ADDRESS        O122 04062402
         BAL   REG5,FACTCHK             READ HA AND R0 OF NEXT     O122 04063202
*                                          TRACK                   O122 04064002
         B     CHKALT                   CHECK ALTERNATE TRACK      O122 04064802
UPDATE   EQU   *                        UPDATE NUMBER ALTS AVAIL-  O122 04065602
*                                          ABLE                    O122 04066402
         LH    REG3,NOALT               PICK UP CURRENT NUMBER     O122 04067202
         SH    REG3,HA1                 DECREMENT BY 1             O122 04068002
         STH   REG3,NOALT               SAVE CURRENT NUMBER        O122 04068802
         B     UPCCHH                   CHECK FOR LAST ALT         O122 04069602
*                                                                  O122 04070402
*                                                                  O122 04071202
CHKCOPY  EQU   *                                                   O122 04072002
         TM    TRKSW,TRYCOPY            GET ADDRESS OF COPY BLOCK  O122 04072802
*                                          FROM FUNCTION BLOCK     O122 04073602
         BO    GETCOPY                  NO, GET FROM COPY BLOCK    O122 04074402
         OI    TRKSW,TRYCOPY            SET FOR PRIMARY COPY DONE  O122 04075202
         MVC   FALTDATA(6),ALTINFO      SAVE ALTERNATE TRACK       O122 04076002
*                                          INFORMATION             O122 04076802
         L     REG9,COPYPTR             PICK UP POINTER FOR COPY   O122 04077602
         B     CHKIT                    CHECK FOR POINTER          O122 04078402
GETCOPY  EQU   *                                                   O122 04079202
         MVC   CALTDATA(6),ALTINFO      SAVE ALTERNATE TRACK       O122 04080002
*                                          INFORMATION             O122 04080802
         L     REG9,CCOPYPTR            PICK UP POINTER FOR COPY   O122 04081602
*                                          ALTERNATES AVAILABLE    O122 04082402
CHKIT    EQU   *                                                   O122 04083202
         LTR   REG9,REG9                WAS THIS LAST COPY         O122 04084002
         BZ    GETREADY                 YES, RESET REGISTERS       O122 04084802
         LA    REG7,CIOBLOCK            GET POINTER TO I/O BLOCKS  O122 04085602
         MVC   SEEKADDR+3(4),SKADDR     UPDATE SEEK ADDR FOR COPY  O122 04086402
         XC    SEEKADDR+7(1),SEEKADDR+7    VOLUME                  O122 04087202
         MVC   NOALT(2),TOTALALT        REINITIALIZE NUMBER OF     O122 04088002
*                                          ALTERNATES              O122 04088802
         NI    TRKSW,X'FE'              TURN OFF BIT FOR FIRST     O122 04089602
*                                          AVAILABLE ALTERNATE     O122 04090402
         BAL   REG5,FACTCHK             START READING HOME ADDRESS O122 04091202
*                                          AND R0 FROM ALTERNATES  O122 04092002
         B     CHKALT                   GO CHECK ALTERNATE         O122 04092802
GETREADY EQU   *                                                   O122 04093602
         DROP REG6                                                 O122 04094402
         USING UCBOB,REG6                                          O122 04095202
TEXTCHK  EQU   *                                                   O122 04096002
         LA    REG7,FBLOCKS             RESTORE DCB ADDRESS        O122 04096802
         L     REG6,TUCBPTR             RESTORE UCB POINTER        O122 04097602
         LA    REG1,RCOUNT1N   PT. TO WAIT STATE RCD FOR NON-IPL   O122 04098402
         TM    SEQSW,IPLDD        IPL TEXT REQUESTED.                   04099202
         BZ    NONIPL             NO-BUILD NON-IPL RECORD.              04100016
         L     REGF,FIPLPTR       GET POINTER TO IPL TEXT FROM FUNCBLK. 04200016
         LTR   REGF,REGF          WAS IPL TEST POINTER SUPPLIED.        04300016
         BNZ   TESTDEV            YES-BUILD IPL RECORD.                 04400016
         MVI   FIPLPTR,X'80'      SET UP MY IPL POINTER INDICATOR.      04450016
         CLC   DDNAME1(8),SYSINDD IS IPL TEXT ENTERED THRU SYSIN.       04500016
         BNE   OPENIPL            NO-MUST READ IPL.                     04600016
         MVC   FIPLPTR+1(3),WIPLPTR+1  YES-MOVE PTR TO FUNCBLK.         04700016
TESTDEV  EQU   *                                                        04800016
         L     REG6,TUCBPTR       RESTORE UCB POINTER.                  04850016
         AIF   ('&LIB' EQ 'LIB2').X227321                       XL03912 04870003
         CLI   UCBID,X'FF'        IS THIS A 2321.                       04900016
         BNE   IPLWARN            YES- WARN USER IPL TEXT NOT ALLOWED.  05000016
.X227321 ANOP                                                   XL03912 05010003
         TM    UCBTBYT2,UCB2OPT3   DO WE HAVE CARNY              S20201 05020003
         BZ    NOCARN              NO                            S20201 05040020
         OI    SEQSW+D1,RPSS       YES                          XM4389  05060003
NOCARN   EQU   *                                                 S20201 05080020
         AIF   ('&LIB' EQ 'LIB2').X227322                       XL03912 05090003
         CLI   UCBTBYT4,X'04'         IS THIS A 2302.                   05100016
         BE    IPLWARN            YES- WARN USER IPL TEXT NOT ALLOWED.  05200016
         CLI   UCBTBYT4,X'02'         IS THIS A 2301.                   05300016
         BE    BLIPLRCD           YES-BUILD CCW FOR IPL ON TRACK 0.     05400016
         CLI   UCBTBYT4,X'06'           DEVICE CODE LESS THAN    S20201 05460020
*                                       2305                     S20201 05520020
         BL    IPLON1                   YES - IPLTEXT ON TRACK   S20201 05580020
*                                       ONE                      S20201 05640020
.X227322 ANOP                                                   XL03912 05670003
BLIPLRCD EQU   *                                                        05700016
         LA    REG1,RCOUNT1I      POINT TO IPLABLE RECORD 1.            05800016
         LA    REG7,FBLOCKS             GET ADDR OF I/O BLOCKS     O122 05850019
* RECORDS ONE THRU THREE ARE CONSTRUCTED HERE.                          05900016
NONIPL   EQU   *                                                        06000016
         MVI   VVTOCPTR,X'40'                                           06100016
         MVC   VVTOCPTR+1(69),VVTOCPTR BLANK VOL LABEL RESERVED FIELDS. 06200016
         MVC   RCD1CNT(36),0(REG1) MOVE RECORD1 TO OUTPUT AREA.  A34946 06270020
         MVC   RCD2CNT(44),RCOUNT2N MOVE RECORD2 TO OUTPUT AREA  A34946 06340020
         XC    IPLSEEK(16),IPLSEEK     CLEAR SEEK AND SEARCH ADDRS.9581 06410017
         MVC   RCD3CNT(16),RCOUNT3N COUNT KEY AND PART OF DATA   S20201 06610020
         MVC   VVTOCPTR(4),MBBCCHH1                                     07000016
         MVI   VVTOCPTR+4,1       INSERT POINTER TO VTOC INTO LABEL.    07100016
         MVC   VOLSERNO(6),FSERNO    ASSUME SAME VOLID-                 07200016
         MVI   VOLSECTY,X'F0'           SET SECURITY BYTE        S20201 07220020
         TM    SEQSW,NEWVOLID     TEST FOR NEW VOLID ID                 07300016
         BO    NUSERIAL           BRANCH IF NEW VOLID REQUESTED.        07360016
         L     REG6,TUCBPTR       PICK UP POINTER TO UCB.               07420016
         AIF   ('&LIB' EQ 'LIB2').X227323                       XL03912 07460003
         CLI   UCBID,X'FF'        IS THIS A 2321 DATA CELL.             07500016
         BNZ   DA2321             YES-GET VOLID FROM SUBUCB.            07600016
.X227323 ANOP                                                   XL03912 07650003
         MVC   VOLSERNO(6),SRTEVOLI    INSERT OLD VOLID INTO LABEL.     07700016
NUSERIAL EQU   *                                                        07800016
         TM    SEQSW,OWNERID      OWNER IDENTIFICATION REQUESTED.       07900016
         BZ    BLDCCWS            NO-BRANCH AND BUILD CHANNEL PROGRAM.  08000016
         MVC   VOLOWNER(10),FOWNID PLACE OWNER ID INTO VOLUME LABEL.    08100016
BLDCCWS  EQU   *   HERE WE CONSTRUCT THE CHANNEL PROGRAM TO WRITE       08200016
*                  TRACK ZERO RECORDS 1 THRU 3. WE ASSUME NO-IPL TEXT   08300016
*                  WAS REQUESTED                                        08400016
         LM    REG0,REG5,CCW1     GET THE FIRST THREE CCWS.             08500016
         ALR   REG0,REGB          SEARCH ID EQ TO (CCHHR=00000).        08600016
         ALR   REG2,REG7               TIC TO CCW1.                     08700016
         LA    REG6,RCD1CNT                                             08800016
         ALR   REG4,REG6          WRITE COUNT KEY DATA RECORD 1.        08900016
         LA    REG9,CC1COUNT       GET LENGTH OF RECORD 1.              08930016
         ALR   REG5,REG9           PLACE COUNT INTO CCW.                08960016
         STM   REG0,REG5,CCMND1   STORE SID EQ-IIC-WRITE CKD CCWS.      09000016
         LA    REG6,CCMND6-CCMND1 GET DISPLACEMENT OF CCWT=CCW1         09100016
         SR    REGF,REGF          CLEAR REGF.                           09150016
         LA    REGE,X'01'                                               09230016
         SRDL  REGE,8                                                   09310016
         ALR   REG4,REGF          SET READ COMMAND FOR WRITE CHECK.     09400016
         ALR   REG2,REG6          SET UP PROPER TIC ADDRESS.            09500016
         STM   REG0,REG5,CCMND6   STORE SID EQ-TIC-READ CKD CCWS.       09600016
         LA    REG6,RCD2CNT-RCD1CNT   GET DISPLACEMENT RECORD 2 COUNT.  09700016
         ALR   REG4,REG6          SET READ CMND FOR RCD2 WRITE CHECK.   09800016
         LA    REG9,CC2COUNT-CC1COUNT                                   09830016
         ALR   REG5,REG9           COMPUTE LENGTH OF RECORD 2.          09860016
         STM   REG4,REG5,CCMND9   STORE READ CCW.                       09900016
         SR    REG4,REGF          CHANGE READ TO WRITE.                 10000016
         STM   REG4,REG5,CCMND4   STORE WRITE CCW.                      10100016
         LA    REG6,RCD3CNT-RCD2CNT   GET DISPLACEMENT OF RCD3-RCD2     10200016
         ALR   REG4,REG6          SET WRITE CMND FOR RCD3.              10300016
         LA    REG9,CC3COUNT-CC2COUNT                                   10330016
         ALR   REG5,REG9           COMPUTE LENGTH OF RECORD 3.          10360016
         STM   REG4,REG5,CCMND5   STORE RECORD3 WRITE CCW               10400016
         AR    REG4,REGF           CHANGE WRITE TO READ COMMAND         10500016
         STM   REG4,REG5,CCMNDA   STORE READ CMND FOR WRITE CHECK.      10600016
         MVI   CCMNDA+4,X'30'      TURN OFF CONMAND CHAIN.              10630016
         L     REG9,COPYPTR        RESTORE COPY BLOCK POINTER.          10660016
         AIF  ('&LIB' EQ 'LIB2').X304700                         XM3645 10670003
*  THE CHANNEL IS COMPLETED HERE IF NO IPL TEXT IS REQUESTED,OR IF      10700016
*  THIS DEVICE IS NOT A 2301 OR 2314                                    10800016
         L     REG6,TUCBPTR       GET UCB ADDRESS                       10900016
.X304700 ANOP                                                    XM3645 10950003
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               11000016
         BZ    COMPCCW            NO-CHANNEL PROGRAM IS COMPLETE.       11100016
         AIF  ('&LIB' EQ 'LIB1').X304701                         XM3645 11150003
         B    BUILDIPL            BUILD IPL CCWS.                XM3645 11160003
         AGO  .X304702                                           XM3645 11162003
.X304701 ANOP                                                    XM3645 11170003
         TM    IPLTRK1,X'01'      IS IPL TEXT ON TRACK 1 BIT ON.        11200016
         BZ    BUILDIPL           NO CONSTRUCT CHANNEL PROGRAM FOR IPL. 11300016
         LA    REG7,FBLOCKS       GET POINTER TO ACTIVE CONTROL BLKS.   11500016
         MVC   IPLSEEK+2(4),UCBSKA+3   INSERT CORRECT CCHH OF IPL       11600016
         MVC   IPLSURCH(4),UCBSKA+3     TEXT INTO RECORD2 SEEK/SEARCH.  11700016
         XC    SEEKADDR+3(5),SEEKADDR+3  ZERO SEEK ADDR IN IOB.         11730016
         MVI   IPLSURCH+4,1       SET UP RECORD NO FOR IPL TEXT.        11760016
         BAL   REG5,EXCPIPL       LINK TO EXCP TO WRITE IPL RECORD.     11800016
         L     REG9,COPYPTR       GET COPY POINTER.                     11900016
IPLLOOP1 EQU   *                                                        12000016
         LTR   REG9,REG9          IS THERE ANOTHER COPY.                12100016
         BZ    BUILDF4            NO-CONSTRUCT VTOC.                    12200016
         L     REG6,CUCBPTR       GET POINTER TO COPY UCB .             12300016
         MVC   IPLSEEK+2(4),UCBSKA+3 SET CORRECT CCHH OF IPL TEXT INTO  12400016
         MVC   IPLSURCH(4),UCBSKA+3    RECORD2 SEEK/SEARCH ADDRESS.     12500016
         TM    SEQSW,NEWVOLID     IS NEW VOL SPECIFIED.                 12600016
         BO    KEEPSERL           YES-RETAIN THE SAME VOLID FOR COPY.   12700016
         MVC   VOLSERNO(6),SRTEVOLI  INSERT VOLID FOR THIS COPY.        12800016
KEEPSERL EQU   *                                                        12900016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O CONTROL BLOCKS.     13000016
         XC    SEEKADDR+3(5),SEEKADDR+3 CLEAR SEEK ADDRESS         O122 13050019
         BAL   REG5,EXCPIPL       LINK TO EXCP TO WRITE IPL RECORD.     13100016
         L     REG9,CCOPYPTR            GET ADDR OF COPY BLOCK     O122 13150019
         B     IPLLOOP1           LOOP UNTIL FINISH.                    13200016
.X304702 ANOP                                                    XM3645 13250003
EXCPIPL  EQU   *                                                        13300016
         EXCP  WKAIOB             INITIATE CHANNEL PROGRAM.             13400016
         TM    WKAECB,COMPLETE    IS I/O COMPLTE.                       13500016
         BO    DONTWAIT           YES- BYPASS WAIT SVC.                 13600016
         WAIT  1,ECB=WKAECB       WAIT FOR I/O COMPLETION.              13700016
DONTWAIT EQU   *                                                        13800016
         CLI   WKAECB,X'7F'       WAS I/O SUCCESSFULLY COMPLETED.       13900016
         BCR   8,REG5              YES-RETURN.                          14000016
IOERROR1 EQU   *                                                        14100016
         CLC   SEEKADDR+3(4),ZEROS   WAS ERROR ON TRACK ZERO.           14200016
         BE    MSGZERO            YES- PRINT MESSAGE AND TERMINATE.     14300016
IOERROR2 EQU   *                                                        14450016
         LA    REG1,13            GET MESSAGE NUMBER.                   14500016
         BAL   REG5,MSGLINK       LINK TO MESSAGE ROUTINE.              14600016
         BAL   REG5,SYNADERR      NO-SYNAD ERROR RETURN.                14650016
EXIT     EQU   *                                                        14700016
         BAL   REG5,MSGPRINT      WRITE MESSAGE.                        14800016
         LA    REGF,8              SET UP RETURN CODE FOR MINITOR.      14900016
EXITFINL EQU   *                                                        15000016
         CLI   FIPLPTR,X'80'      WAS IPL TEXT POINTER PASSED.          15020016
         BNE   PTROKAY            YES-LEAVE POINTER FOR MONITOR.        15040016
         XC    FIPLPTR(4),FIPLPTR NO-CLEAR IT.                          15060016
PTROKAY  EQU   *                                                        15080016
         L     REGD,SAVEREGD       GET POINTER TO IEHDANAL SAVE AREA.   15100016
         RETURN (14,12),T,RC=(15) RESTORE REGS AND RETURN.              15200016
BUILDIPL EQU   *                                                        15300016
         USING BUFFER,REG9                                              15320016
         MVI   CCMNDA+4,X'40'      TURN ON COMMAND CHAIN.               15340016
         L     REG9,FIPLPTR  POINT TO IPL COUNT FIELD.                  15360016
         LA    REG9,0(REG9)  CLEAR HIGH ORDER BYTE OF IPL POINTER.      15380016
         LM    REG0,REG5,CCMND8   HERE                                  15400016
         STM   REG0,REG5,CCMND9        WE                               15500016
         LA    REG6,SEEKADDR+3            MODIFY                        15600016
         LM    REG0,REG1,CCW1FMT                 THE                    15700016
         ALR   REG0,REG6                                                15800016
         LM    REG2,REG3,CCMND7                     CHANNEL             15900016
         LA    REG6,CCMND7-CCMND6                           PROGRAM     16000016
         ALR   REG2,REG6          TO                                    16100016
         STM   REG0,REG3,CCMND7      WRITE                              16200016
         LM    REG0,REG1,CCW3              THE                          16300016
         L     REGE,FIPLPTR                        RECORD               16400016
         LA    REGE,0(REGE)       CLEAR HIGH ORDER BIT IN REG.          16420016
         AIF   ('&LIB' EQ 'LIB2').X0001                          X02912 16430002
         LA    REG6,3625                                                16440016
         AGO   .X0002                                            X02912 16450002
.X0001   ANOP                                                    X02912 16452002
         L     REG6,IPLMAX        GET MAX RECORD SIZE FOR IPLTXT X02912 16460002
.X0002   ANOP                                                    X02912 16462002
         ST    REG6,IPL1CNT+4     STORE DATA LNGTH IN COUNT OF IPLTEXT. 16470016
         LM    REG0,REG1,CCW3                               TRACK       16500016
         ALR   REG1,REG6          SET UPLNGTH OF IPL TEXT IN CCW.       16550016
         ALR   REG0,REGE                                                16600016
         STM   REG0,REG1,CCMND6                                  ZERO.  16700016
         AR    REG0,REGF          MODIFY WRITE CCW TO READ.             16800016
         STM   REG0,REG1,CCMNDC                                         16900016
         MVI   CCMNDC+4,X'10'                                           17000016
         MVI   IPL1CNT+4,4        INSERT RECORD NUMBER INTO IPL COUNT.  17100016
         MVC   IPL1CNT(4),RCD1CNT  INSERT CCHH FOR IPL RECORD.          17200016
         MVC   IPLSURCH(5),IPL1CNT     SET UP IPL SEARCH                17230016
         XC    IPLSEEK(6),IPLSEEK      AND SEEK ADDRESS.                17260016
COMPCCW  EQU   *                                                        17300016
         DROP  REG9                                                     17330016
         USING COPYBLK,REG9                                             17360016
         XC    SEEKADDR+3(5),SEEKADDR+3  SET UP JOB FOR TRACK ZERO.     17400016
CARNIVAL EQU   *                                                 S20201 17409020
         TM    SEQSW+D1,RPSS       DO WE HAVE CARNY             XM4389  17418003
         BZ    NOTCARN             NO                            S20201 17427020
         LA    REG0,SETSECCW       YES, DO A SET SECTOR          S20201 17436020
         ST    REG0,CCWPTR                                       S20201 17445020
         LA    REG0,CCMND1         GET CHAN PROG                 S20201 17454020
         ST    REG0,TEMP           SET IT IN TIC                 S20201 17463020
         MVC   TICADD(K3),TEMP+K1                                S20201 17472020
         B     LOADCOPY            CHECK FOR COPIES              S20201 17481020
NOTCARN  EQU   *                                                 S20201 17490020
         LA    REG0,CCMND1                                              17500016
         ST    REG0,CCWPTR        INSERT POINTER TO CCWS INTO IOB.      17600016
LOADCOPY EQU   *                                                 S20201 17650020
         L     REG9,COPYPTR       GET POINTER TO COPY BLOCK             17700016
COPYLOOP EQU   *                                                        17800016
         LTR   REG9,REG9     IS THIS THE LAST COPY.                     17900016
         BZ    STRTEXCP      YES-PREPARE TO INITIATE EXCP.              18000016
         MVC   CIOBLOCK+72(44),FBLOCKS+72  MOVE CONTOOL BLKS TO COPY.   18100016
         LA    REG7,CIOBLOCK      POINT TO COPY CONTROL BLOCKS.         18200016
         ST    REG7,DCBADD        UPDATE DCB POINTER IN IOB.            18300016
         LA    REG0,WKAECB-IHADCB(REG7)  GET PTR TO ECB.                18330016
         ST    REG0,ECBADD-IHADCB(REG7)  GET PTR TO ECB.                18360016
         L     REG9,CCOPYPTR      GET NEXT COPYBLK POINTER.             18400016
         B     COPYLOOP           LOOP UNTIL ALL COPIES ARE BUILT.      18500016
OPENIPL  EQU   *                                                        18600016
         LA    REG7,INPUTDCB      GET POINTER TO IPL DCB.               18700016
         MVC   DCBDDNAM(8),DDNAME1     INSERT IPL DDNAME.               18800016
         OPEN  (INPUTDCB,INPUT)   OPEN IPL DATA SET OR MEMBER.          18900016
         TM    DCBOFLGS,X'10'     WAS DCB OPENED.                       19000016
         BZ    NOTOPEN            NO-SET UP ERROR AND TERMINATE.        19100016
GETLOOP2 EQU   *                                                        19150016
         L     REG6,FBUFFPTR      GET POINTER TO OUTPUT AREA.           19200016
         LA    REG6,8(REG6)       SAVE SPACE FOR COUNT FIELD.           19300016
         AIF   ('&LIB' EQ 'LIB2').X0003                          X02912 19350002
         LA    REG3,3624(REG6)    POINT TO END OF BUFFER AREA.          19400016
         AGO   .X0004                                            X02912 19450002
.X0003   ANOP                                                    X02912 19452002
         LR    REG3,REG6                START OF READIN AREA     X02912 19460002
         LA    REG3,0(REG3)             CLEAR HIGH ORDER BYTE    X02912 19470002
         A     REG3,IPLMAX              POINT TO END OF BUFFER   X02912 19480002
         BCTR  REG3,0                                            X02912 19490002
.X0004   ANOP                                                    X02912 19492002
         SR    REG2,REG2          CLEAR EXECUTE REGISTER.               19500016
         LA    REG7,FBLOCKS       RESET I/O CONTROL BLOCK PTR.          19550016
GETLOOP1 EQU   *                                                        19600016
         GET   INPUTDCB           GET LOGICAL RECORD.                   19700016
         CLC   1(3,REG1),TEXTCARD IS THIS A TEXT RECORD.                19800016
         BNE   GETLOOP1           NO-DISCARD IT AND GET ANOTHER.        19900016
         IC    REG2,11(REG1)      GET NO OF BYTES IN THIS RECORD.       20000016
         L     REGF,4(REG1)       GET DISPLACEMENT OF TEXT CARD.        20010016
         LA    REGF,0(REGF)       CLEAR HIGH ORDER BYTE OF DISP REG.    20020016
         AR    REG6,REGF          GET ADDRESS OF THIS RECORD.           20030016
         LR    REGF,REG6          SAVE POINTER TO ADDR OF THIS TEXT.    20040016
         AR    REGF,REG2          GET POINTER TO END OF TRACK BUFFER.   20050016
         CR    REGF,REG3          WILL TEXT RECORD FIT IN BUFFER.       20060016
         BNH   MOVETEXT           YES-MOVE RECORD INTO OUTPUT BUFFER.   20070016
IPLMSG2  EQU   *                                                        20110016
         CLOSE INPUTDCB           CLOSE INPUT IPL DCB.                  20130016
         FREEPOOL  INPUTDCB       FREE QAAM BUFFERS.                    20140016
NOTOPEN  EQU   *                                                        20160016
         B     IPLWARN            INDICATE IPL TEXT WAS NOT FOUND.      20360016
MOVETEXT EQU   *                                                        20700016
         OI    IPLTRK1,X'02'      INDICATE IPL TEXT WAS FOUND.          20720016
         BCTR  REG2,0                                                   20800016
         EX    REG2,MOVE1         MOVE TEXT DATA TO OUTPUT AREA.        20900016
         B     GETLOOP2           GET ANOTHER RECORD.                   21000016
MOVE1    EQU   *                                                        21100016
         MVC   0(1,REG6),16(REG1)     EXECUTE TO MOVE DATA TO OUTPUT.   21200016
TSTBLKSI EQU   *             THIS IS THE DCB EXIT ROUTINE.              21300016
         LH    REG0,DCBBLKSI      PICK UP BLOCK SIZE.                   21400016
         LTR   REG0,REG0          WAS BLOCK SIZE SPECIFIED.             21500016
         BCR   7,REGE             YES-RETURN TO OPEN.                   21600016
         MVI   DCBBLKSI+1,80      NO-DEFAULT TO 80.                     21700016
         BR    REGE               RETURN TO OPEN.                       21800016
CONVERT  EQU   *                                                        21900016
         STH   REG1,STRTRACK           SAVE STARTING RTA.               22000016
         SR    REG0,REG0                                                22100016
         LR    REG4,REG0          CLEAR HIGH ORDER DIVIDEND REGISTERS.  22200016
         DR    REG0,REGF          CONVERT LO EXTENT TO CYLS-TRKS.       22300016
         DR    REG4,REGF          CONVERT HI EXTENT TO CYLS-TRKS.       22400016
         SR    REG4,REG0          GET DIFFERENCE IN EXCESS TRKS.        22500016
         SR    REG5,REG1          GET DIFFERENCE IN CYLINDERS.          22600016
         LTR   REG5,REG5               IS CYLINDER ZERO.                22700016
         BZ    STOREXT            YES-THEN EXTENT IS CONVERTED.         22800016
         LTR   REG0,REG0          WAS BEGINNING EXTENT CYL ALIGNED.     22900016
         BZ    STOREXT            YES-THEN EXTENT IS CONVERTED.         23000016
         AR    REG4,REGF          ADD TRACK CONSTANT.                   23100016
         BCTR  REG5,0                  DECREMENT NO OF CYLINDERS.       23200016
STOREXT  EQU   *                                                        23300016
         STH   REG5,FULLCYLS      STORE NUMBER OF CYLINDERS.            23400016
         STC   REG4,EXTRACKS      STORE NUMBER OF EXCESS TRACKS.        23500016
         MVC   12(5,REG6),STRTRACK INSERT FORMAT 5 EXTENT.              23600016
         LA    REG6,5(REG6)       POINT TO NEXT EXTENT.                 23700016
         BR    REGE                    RETURN.                          23800016
CLOSE1   EQU   *             THIS IS THE EODAD EXIT ROUTINE.            23900016
         DROP  REG6                                                     24000016
         CLOSE INPUTDCB           CLOSE INPUT IPL DCB.                  24008016
         FREEPOOL  INPUTDCB       FREE QSAM BUFFERS.                    24012016
         MVC   FIPLPTR+1(3),FBUFFPTR+1 SET UP POINTER TO IPL TEXT.      24016016
         TM    IPLTRK1,X'02'      WAS AN IPL TEXT RECORD FOUND.         24018016
         BZ    IPLWARN         NO-INDICATE IPL TEXT WAS NOT FOUND.      24020016
         B     TESTDEV                                                  24024016
IPLWARN  EQU   *                                                        24032016
         LA    REG1,26                                                  24040016
         BAL   REG5,MSGLINK       GET PROPER MESSAGE.                   24048016
         MVC   0(8,REG1),DDNAME2  INSERT PROPER DDNAME.                 24056016
         BAL   REG5,MSGPRINT      PRINT PORPER MESSAGE.                 24064016
         XI    SEQSW,IPLDD        TURN OFF IPL INDICATOR.               24072016
         OI    IPLTRK1,IPLDD      SET NONIPLABLE DEVICE INDICATOR.      24080016
         LA    REG1,RCOUNT1N      POINT TO NON-IPL RECORD.              24084016
         B     FINISH                  ABNORMAL TERMINATION      A32162 24092020
         AIF   ('&LIB' EQ 'LIB2').X227324                       XL03912 24096003
         USING DATACELL,REG6                                            24100016
DA2321   EQU   *                                                        24200016
         MVC   VOLSERNO(6),DCELVOLI INSERT VOLUME SERIAL INTO LABEL.    24300016
         MVC   SEEKADDR+1(2),DCELBBNR  SET UP BIN NUBER INTO IOB.       24400016
         B     NUSERIAL                                                 24500016
VOL2321  EQU   *                                                        24600016
         MVC   VOLSERNO(6),DCELVOLI   INSERT SERIAL NUMBER.             24700016
         B     STARTCHP           WRITE TRACK ZERO.                     24800016
         DROP  REG6                                                     24900016
.X227324 ANOP                                                   XL03912 24950003
         USING UCBOB,REG6                                               25000016
*                                                                       25100016
**********************************************************************  25200016
*                                                                       25300016
EXCPLOOP EQU   *                                                        25400016
         EXCP  WKAIOB             INITIATE EXCP.                        25500016
         LTR   REG9,REG9          IS THERE ANOTHER COPY                 25600016
         BZ    WAITLOOP           NO-WAIT FOR I/O COMPLETION            25700016
         LA    REG7,CIOBLOCK      GET POINTER TO COPY DCB               25800016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK.       25900016
         B     EXCPLOOP           LOOP UNTIL ALL I/O IS STARTED.        26000016
WAITLOOP EQU   *                                                        26100016
         LA    REG7,FBLOCKS       RESET CONTROL BLOCKS POINTER.         26200016
         L     REG9,COPYPTR       POINT TO 1ST COPY BLOCK.              26300016
WAITCOPY EQU   *                                                        26400016
         TM    WKAECB,COMPLETE    IS I/O COMPLETE.                      26500016
         BO    BYWAIT1            YES-BYPASS WAIT ECB.                  26600016
         WAIT  ,ECB=WKAECB        WAIT FOR I/O COMPLETION.              26700016
BYWAIT1  EQU   *                                                        26800016
         CLI   WKAECB,X'7F'       WAS I/O SUCCESSFUL                    26900016
         BNE   IOERROR1           NO-PREPARE FOR ERROR EXIT             27000016
         LTR   REG9,REG9          IS THERE ANOTHER COPY.                27100016
         BCR   8,REG5             RETURN AFTER ALL I/O IS COMPLETED.    27200016
         LA    REG7,CIOBLOCK      YES-POINT TO NEXT COPY CONTROL BLKS.  27300016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY BLOCK        27400016
         B     WAITCOPY           LOOP UNTIL ALL I/O IS COMPLETE.       27500016
*                                                                       27600016
**********************************************************************  27700016
*                                                                       27800016
STRTEXCP EQU   *                                                        27900016
         L     REG9,COPYPTR                                             28000016
         LA    REG7,FBLOCKS       POINT TO FUNCTION DCB                 28100016
         TM    SEQSW,NEWVOLID     WAS NEW VOLUME SERIAL REQUESTED.      28200016
         BO    VOLOKAY            KEEP SAME SERIAL FOR ALL COPIES.      28300016
         BAL   REG5,EXCPIPL       WRITE TRACK ZERO SERIALLY.            28400016
NOIPLOOP LTR   REG9,REG9          WAS THIS THE LAST COPY.               28500016
         BZ    BUILDF4            YES-CONSTRUCT AND WRITE VTOC.         28600016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O BLOCKS.             28700016
         L     REG6,CUCBPTR       GET COPY UCB POINTER.                 28800016
         AIF   ('&LIB' EQ 'LIB2').X227325                       XL03912 28850003
         CLI   UCBID,X'FF'        IS THIS A 2321 .                      28900016
         BNZ   VOL2321            YES-GET SERIAL FROM SUBUCB.           29000016
.X227325 ANOP                                                   XL03912 29050003
         MVC   VOLSERNO(6),SRTEVOLI    MOVE IN SERIAL NUMBER.           29100016
STARTCHP EQU   *                                                        29200016
         BAL   REG5,EXCPIPL       WRITE EACH COPY SERIALLY.             29300016
         L     REG9,CCOPYPTR      GET POINTER TO NEXT COPY.             29400016
         B     NOIPLOOP           LOOP UNTIL ALL COPIES.ARE FINISH.     29500016
VOLOKAY  EQU   *                                                        29600016
         BAL   REG5,EXCPLOOP      START CHANNEL PROGRAM EXECUTION.      29700016
         AIF   ('&LIB' EQ 'LIB2').X227326                        XM3645 29750003
WAITCMPL EQU   *                                                        29800016
         L     REG6,TUCBPTR       GET BASE REGISTER FOR UCB.            29900016
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               30000016
         BZ    BUILDF4            NO-CONSTRUCT FORMAT 4 DSCB.           30100016
         CLI   UCBTBYT4,X'01'     IS THIS A 2311 DEVICE.                30200016
         BE    IPLON1             YES-BUILD CHNL PRGM FOR IPL ON TRK1.  30300016
         CLI   UCBTBYT4,X'03'     IS THIS A 2303 DEVICE.                30400016
         BNE   BUILDF4            NO-CONSTRUCT FORMAT 4 DSCB.           30500016
*                                                                       30600016
**********************************************************************  30700016
*                                                                       30800016
*        THE CHANNEL PROGRAN THAT WRITES IPL ON TRACK ONE IS            30900016
*              CONSTRUCTED HERE.                                        31000016
*                                                                       31100016
**********************************************************************  31200016
*                                                                       31300016
IPLON1   EQU   *                                                        31400016
         LM    REG0,REG1,CCW1FMT   PICK UP CCW ONE.                     31460016
         LM    REG2,REG5,CCW2     GET CCWS TWO THRU FIVE.               31520016
         XC    SEEKADDR+3(5),SEEKADDR+3 C6EAR SEEK ADDRESS IN IOB.      31600016
         MVI   SEEKADDR+6,1       SET SEEK ADRESS FOR TRACK ONE.        31700016
         LA    REG6,SEEKADDR+3                                          31900016
         ALR   REG0,REG6          SET UP SEARCH ARG ADDR IN CCW.        32000016
         ALR   REG2,REG7               SET UP CORRECT TIC ADDRESS.      32100016
         L     REG6,FIPLPTR       GET POINTER TO IPL TEXT.              32200016
         LA    REG6,0(REG6)       CLEAR HIGH ORDER BIT IN REG.          32230016
         MVC   0(8,REG6),IPLCOUNT  SET UP IPL COUNT FIELD.              32260016
         ALR   REG4,REG6          POINT TO IPL RECORD FROM WCKD CCW.    32300016
         LA    REG6,3625                                                32330016
         ALR   REG5,REG6     SET UP LENGTH OF IPL TEXT IN CCWS.         32360016
         STM   REG0,REG5,CCMND1   STORE UPDATED CCWS IN WORKAREA.       32400016
         LA    REG6,CCMND4-CCMND1 GET DISPLACEMENT OF CW4 IN WORKAREA.  32500016
         ALR   REG2,REG6          UPDATE ADDRESS IN TIC CCW.            32600016
         STM   REG0,REG5,CCMND4   STORE UPDATED CCWS FOR WRITE CHECK.   32700016
         MVI   CCMND6,X'1E'       MODIFY OP TO READ COUNT KEY AND DATA. 32800016
         MVI   CCMND6+4,X'30'     SET SKIPAND SILI FLAGS ON.            32900016
         LA    REG7,FBLOCKS       GET POINTER TO FUNCTION BLOCK.        32920016
CARNIV1  EQU   *                                                 S20201 32921020
         TM    SEQSW+D1,RPSS       DO WE HAVE CARNY             XM4389  32922003
         BZ    NOTCARN1            NO                            S20201 32923020
         LA    REG0,SETSECCW       YES DO SET SECTOR             S20201 32924020
         ST    REG0,CCWPTR         PUT IN IOB                    S20201 32925020
         LA    REG0,CCMND1         GET CHAN PROG                 S20201 32926020
         ST    REG0,TEMP           STORE IN TIC PTR              S20201 32927020
         MVC   TICADD(K3),TEMP+K1                                S20201 32928020
         ST    REG0,TEMP           SET IT IN TIC                 S20201 32929020
         B     COPY1               PROCESS COPIES                S20201 32930020
NOTCARN1 EQU   *                                                 S20201 32931020
         LA    REG9,CCMND1        GET POINTER TO  CCW.                  32940016
         ST    REG9,CCWPTR        STORE CWW POINTER INTO IOB.           32960016
COPY1    EQU   *                                                 S20201 32980020
         L     REG9,COPYPTR       POINT TO FIRST COPY BLOCK.            33000016
IPLOOP   EQU   *                                                        33100016
         LTR   REG9,REG9          IS THIS THE LAST COPY.                33200016
         BZ    WRITEIPL           YES-BRANCH AND WRITE IPL RECORD.      33300016
         MVC   CIOBLOCK+72(44),FBLOCKS+72                               33400016
         LA    REG7,CIOBLOCK      POINT TO COPY CONTROL BLOCKS.         33500016
         LA    REG0,WKAECB                                              33600016
         ST    REG0,ECBADD        UPDATE ECB POINTER IN IOB.            33700016
         ST    REG7,DCBADD        UPDATE DCB POINTER IN IOB.            33800016
         L     REG9,CCOPYPTR      GET ADDRESS OF NEXT COPY BLOCK.       33900016
         B     IPLOOP             LOOP UNTIL FINISH.                    34000016
WRITEIPL EQU   *                                                        34100016
         OI    IPLTRK1,1          SET IPL ON TRACK ONE INDICATOR.       34150016
         LA    REG7,FBLOCKS       POINT TO THE CNTRL BLKS IN FUNCBLKS.  34200016
         L     REG9,COPYPTR       GET ADDRESS OF FIRST COPY BLOCK.      34300016
         BAL   REG5,EXCPLOOP      START CHANNEL PROGRAM EXECUTION.      34400016
         B     BLIPLRCD           CONSTRUCT AND WRITE BOOTSTRAP RECORD. 34500016
.X227326 ANOP                                                    XM3645 34550003
BUILDF4  EQU   *                                                        34600016
         LA    REG7,FBLOCKS       POINT TO PRIMARY CNTRL BLKS.          34620016
         MVC   SEEKADDR+3(4),VVTOCPTR  INSERT VTOC ADDRESS INTO IOB.    34650016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        34700016
         L     REG6,FBUFFPTR      GET POINTER TO BUFFER AREA.           34800016
         SR    REG0,REG0                                                34900016
         IC    REG0,DSCBTRK       GET NUMBER OF DSCBS/TRACK.            35000016
         LA    REG1,148                                                 35100016
         MR    REG0,REG0          COMPUTE SIZE NECCESSARY FOR DSCBS.    35200016
         AR    REG1,REG6          GET  ADDRESS OF FIRST CCW.            35300016
         LA    REG1,16(REG1)                                            35320016
         SRL   REG1,3                                                   35340016
         SLL   REG1,3             ALIGN CCWS ON DOUBLE WORD BOUNDARY.   35360016
CARNIV2  EQU   *                                                 S20201 35364020
         TM    SEQSW+D1,RPSS       ARE WE CARNY                 XM4389  35368003
         BZ    NOTCARN2                                          S20201 35372020
         LA    REG0,SETSECCW       YES SET SECTOR CMD            S20201 35376020
         ST    REG0,CCWPTR         INT IOB                       S20201 35380020
         ST    REG1,TEMP                                         S20201 35384020
         MVC   TICADD(K3),TEMP+K1                                S20201 35388020
         B     CARNY2              CONT PROCESS                  S20201 35392020
NOTCARN2 EQU   *                                                 S20201 35396020
         ST    REG1,CCWPTR        STORE CCW  ADDRESS INTO I/OB          35400016
CARNY2   EQU   *                                                 S20201 35450020
         LM    REG2,REG5,CCW1FMT  PICK UP DUMMY CCWS.                   35500016
         LA    REG0,SEEKADDR+3                                          35600016
         ALR   REG2,REG0          SET UP SEARCH ID EQ ADDRESS.          35700016
         ALR   REG4,REG1          SET UP TRANSFER IN CHANNEL ADDRESS.   35800016
         STM   REG2,REG5,0(REG1)  STORE UPDATED CCWS IN WORKAREA.       35900016
         SR    REG0,REG0                                                36000016
         LR    REG2,REG6          GET POINTER TO FIRST DSCB.            36100016
         IC    REG0,DSCBTRK       GET NO OF DSCBS/TRACK.                36200016
         LM    REG3,REG4,CCW3FMT  GET DUMMY CCW (WRITE COUNT-KEY-DATA)  36300016
         LA    REG1,16(REG1)      UPDATE CCW POINTER.                   36400016
CCWLOOP1 EQU   *                                                        36500016
         ALR   REG3,REG2          SET UP ADRESS OF PROPER DSCB.         36600016
         STM   REG3,REG4,0(REG1)  STORE UPDATED CCWS.                   36700016
         LA    REG2,148           GET CCW ADDRESS INCREMENT.            36800016
         LA    REG1,8(REG1)       UPDATE CCW POINTER.                   36900016
         BCT   REG0,CCWLOOP1      LOOP UNTIL ALL WRITE CCWS ARE BUILT.  37000016
         LM    REG3,REG4,CCW4FMT  GET DUMMY READ R0 CCW.                37100016
         STM   REG3,REG4,0(REG1)  STORE READ R0 CCW.                    37200016
         IC    REG0,DSCBTRK       GET NUMBER OF DSCBS/TRACK.            37300016
         LM    REG3,REG4,CCW5FMT  GET WRITE CHECK DUMMY CCW.            37400016
         MVC   0(5,REG6),SEEKADDR+3 INSERT VTOC ADDRESS IN RCD CNT.     37500016
         MVC   5(3,REG6),DSCBCNT  MOVE KEY AND DATA LENGTH TO R1 CNT.   37600016
         B     CCWSTART           BYPASS FIRST UPDATE.                  37700016
CCWLOOP2 EQU   *                                                        37800016
         MVC   148(8,REG6),0(REG6)  INSERT NEXT RECORD COUNT.           37900016
         ALR   REG6,REG2               UPDATE DSCB POINTER.             37950016
CCWSTART EQU   *                                                        38000016
         IC    REGF,4(REG6)                                             38100016
         LA    REGF,1(REGF)       INCREMENT RECORD NUMBER.              38200016
         STC   REGF,4(REG6)       STORE UPDATED CCHHR .                 38300016
         STM   REG3,REG4,8(REG1) STORE WRITE CHECK CWW.                 38400016
         XC    8(140,REG6),8(REG6) CLEAR DSCB AREA.                     38500016
         LA    REG1,8(REG1)       UPDATE CCW POINTER.                   38700016
         BCT   REG0,CCWLOOP2      LOOP UNTIL DSCBS/CCWS ARE BUILT       38800016
         LM    REG3,REG4,CCW6FMT   GET READ R0 CCW.                     38820016
         STM   REG3,REG4,8(REG1)       READ R0 CCW.                     38860016
         L     REG6,FBUFFPTR       RESET BUFFER ADDRESS.                38900016
         DROP  REG6                                                     39000016
         USING BUFFER,REG6                                              39100016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        39200016
         MVI   8(REG6),4                                                39300016
         MVC   9(43,REG6),8(REG6) SET UP FORMAT 4 DSCB KEY.             39400016
         MVI   DS4IDFMT,X'F4'     INSERT IDENTIFIER.                    39500016
         MVC   DS4HPCHR(5),148(REG6)  SET UP HIGH PRIME CCHHR.          39600016
         MVC   DS4HCCHH(6),FALTDATA SET UP ALTERNATE DATA IN DSCB.      39700016
         MVI   DS4NOEXT,1         SET UP NUMBER IF EXTENTS IN VTOC.     39800016
         MVC   DS4DEVCT(14),CYLNO      SET UP DEVICE CONSTANTS.         39900018
         MVC   DS4VTOCE+2(8),MBBCCHH1  SET UP VTOC EXTEMTS.             40000016
         MVI   DS4VTOCE,1         SET UP EXTENT TYPE.                   40100016
         IC    REG0,DSCBTRK                                             40200016
         MH    REG0,WKBUFPTR+2    COMPUTE NO OF DSCBS IN VTOC.          40300016
         BCTR  REG0,0             SUBTRACT 1 FOR FORMAT 4 DSCB.         40400016
         BCTR  REG0,0             SUBTRACT 1 FOR FORMAT 5 DSCB.         40500016
         STH   REG0,DS4DSREC      STORE NO OF AVAILABLE DSCBS IN VTOC.  40600016
         LA    REG6,148(REG6)     UPDATE DSCB POINTER TO THE FORMAT 5.  40700016
         MVI   8(REG6),5                                                40800016
         MVC   9(3,REG6),8(REG6)  SET UP FORMAT 5 KEY IDENTIFICATION.   40900016
         MVI   52(REG6),X'F5'     SET UP FORMAT IDENTIFIER.             41000016
         TM    SEQSW+D1,SS1VAL    SS/1 CONVERSION              @Y30LSFY 41050003
         BZ    SETD5              NO                           @Y30LSFY 41060003
*        FORMAT 5 DSCB WILL INDICATE ONLY TRACKS 3-19 ARE FREE @Y30LSFY 41070003
         MVC   STRTRACK(L5),SS1AVEXT SET AVAIL. EXTENT         @Y30LSFY 41080003
         MVC   D12(L5,REG6),STRTRACK INSERT FORMAT 5 EXTENT    @Y30LSFY 41090003
         B     NOHIRTA            SKIP EXTENT CONSTRUCTION     @Y30LSFY 41092003
SETD5    EQU   *                                               @Y30LSFY 41094003
         LA    REG1,1             ASSUME TRACK 1 IS AVAILABLE.          41100016
         TM    SEQSW,IPLDD        WAS IPL TEXT REQUESTED.               41200016
         BZ    TRKAVAIL           NO- THEN TRACK 1 IS AVAILABLE.        41300016
         AIF   ('&LIB' EQ 'LIB2').X227327                       XL03912 41310003
         USING UCBOB,REG5                                               41330016
         L     REG5,TUCBPTR       GET POINTER TO UCB.                   41360016
         CLI   UCBTBYT4,1         IS THIS AN IPLABLE 2311.              41400016
         BE    UPTRACK            YES- THEN TRK 1 IS NOT AVAILBLE.      41500016
         CLI   UCBTBYT4,3         IS THIS AN IPLABLE 2303.              41600016
         BNE   TRKAVAIL           NO-THEN TRACK 1 IS AVAILABLE.         41700016
         USING BUFFER,REG6                                              41730016
UPTRACK  EQU   *                                               @ZA01205 41740002
         LA    REG1,2             MAKE TRACK THE 1ST AVAILABLE.@ZA01205 41750002
.X227327 ANOP                                                   XL03912 41760003
TRKAVAIL EQU   *                                                        42000016
         LH    REG5,RTAVTOCS+2    GET BEGINNING RTA OF VTOC.            42100016
         LH    REGF,TRKCYL        GET TRACK CONSTANT.                   42200016
         CR    REG1,REG5          DOES VTOC START AT BEGINNING OF VOL.  42400016
         BNL   NOLORTA            YES-BYPASS LOW EXTENT CONVERSION.     42500016
         BAL   REGE,CONVERT       NO-CONVERT RTA TO DSCB FORMAT.        42600016
NOLORTA  EQU   *                                                        42700016
         LH    REG1,RTAVTOCE+2    GET ENDING RTA OF VTOC.               42800016
         LH    REG5,RTAVTOCS      GET RTA OF LAST PRIMARY TRACK.        42900016
         CR    REG1,REG5          IS LAST TRACK ALLOCATED TO VTOC.      43000016
         BNL   NOHIRTA            YES-BYPASS HIGH EXTENT CONVERSION.    43100016
         LA    REG1,1(REG1)       UPDATE RTA TO 1ST AVAILABLE.          43200016
         LA    REG5,1(REG5)       UPDATE RTA TO 1ST ALTERNATE           43300016
         BAL   REGE,CONVERT       CONVERT RTA TO DSCB FORMAT.           43400016
NOHIRTA  EQU   *                                                        43500016
         LA    REG7,FBLOCKS       GET POINTER TO PRIMARY I/O BLOCKS.    43600016
         L     REG9,COPYPTR       GET FIRST COPY BLOCK POINTER .        43700016
         L     REG2,CCWPTR        GET PTR TO CCW FROM FUNCBLK.          43750016
         BAL   REG5,EXCPIPL       WRITE FIRST TRACK SERIALLY.           43800016
WRITEF4  EQU   *                                                        43900016
         LTR   REG9,REG9          WAS THIS LAST COPY.                   44000016
         BZ    NEXTRK             YES-WRITE OTHERS TRKS IN PARALLEL     44100016
         L     REG6,FBUFFPTR      RESTORE BUFFER AREA BASE.             44150016
         MVC   DS4HCCHH(6),CALTDATA INSERT ALTERNATE DATA INFO.         44200016
         LA    REG7,CIOBLOCK  POINT TO COPY I/O CONTROL BLOCK.          44300016
         ST    REG2,CCWPTR        STORE PTR TO CCW IN COPY BLOCK.       44350016
         MVC   SEEKADDR+3(4),VVTOCPTR  INSERT CCHH INTO IOB SEEKADDR.   44370016
         BAL   REG5,EXCPIPL   INITIATE I/O ON TRK 1 OF COPY DEVICE.     44400016
         L     REG9,CCOPYPTR      GET NEXT COPY POINTER.                44600016
         B     WRITEF4   LOOP UNTIL ALLL ARE COMPLETED.                 44700016
TTRCONV  EQU   *                                                   O122 44710019
         L     REGF,FBUFFPTR            POINTER TO BUFFER          O122 44720019
         USING CVT,REGF                                            O122 44730019
         STM   REG9,REG2,12(REGD)       SAVE REGS FOR CONVERT RTN  O122 44750019
         LR    REG3,REGD                SAVE PTR TO SAVE AREA      O122 44760019
         LA    REG2,8(REGF)             POINT TO MBBCCHHR AREA     O122 44770019
         LA    REG1,DDEB                POINT TO DUMMY DEB         O122 44780019
         L     REGF,CVTPTR              GET ADDRESS OF CVT         O122 44790019
         L     REGF,CVTPCNVT            GET ENTRY PT TO CONVERT RTNO122 44800019
         BALR  REGE,REGF                LINK TO CONVERT RTN        O122 44810019
         LM    REG9,REG2,12(REG3)       RESTORE MY REGISTERS       O122 44820019
         BR    REG5                     RETURN TO CALLING RTN      O122 44830019
NEXTRK   EQU   *                                                   O122 44840019
         LA    REG7,FBLOCKS             PTR TO I/O BLOCKS.       XM1383 44842002
         LA    REG0,1                   PUT A 1 IN REG 0           O122 44850019
         AH    REG0,RTAVTOCS+2          COMPUTE TTR OF NEXT TRACK  O122 44860019
         STH   REG0,RTAVTOCS+2          SAVE UPDATED TTR IN WORK   O122 44870019
*                                          AREA                    O122 44880019
         SLL   REG0,16                  POSITION TT IN HIGH ORDER  O122 44890019
*                                          BYTES                   O122 44900019
         BAL   REG5,TTRCONV             SET SEEK ADDRESS           O122 44910019
         MVC   SEEKADDR+3(5),11(REGF)   INSERT CCHHR INTO IOB      O122 44920019
         XC    8(140,REGF),8(REGF)   CLEAR FORMAT 4 DSCB AREA.          45000016
         XC    156(140,REGF),156(REGF) CLEAR FORMAT 5 DSCB AREA.        45050016
UPCOUNT2 EQU   *                                                        45100016
         SR    REG1,REG1          CLEAR REG1.                           45150016
         L     REGE,IODEVCON      GET ADDRESS OF CONSTANT TABLE.        45200016
         IC    REG1,DSCBTRK       GET NO OF DSCB PER TRACK.             45300016
UPCOUNT1 EQU   *                                                        45400016
         MVC   0(4,REGF),SEEKADDR+3    UP CCHH IN DSCB                  45500016
         LA    REGF,148(REGF)     POINT TO NEXT DSCB IN CORE.           45600016
         BCT   REG1,UPCOUNT1    LOOP UNTIL PTRS ARE UPDATED.            45700016
         CLC   RTAVTOCS+2(2),RTAVTOCE+2 IS THIS END OF VTOC.            45800016
         BH    FINISH      YES PREPARE TO RETURN TO MONITOR.            45900016
         LA    REG7,FBLOCKS   GET PRIMARY BLOCK POINTRR.                46000016
         L     REG9,COPYPTR       POINT TO FIRST COPY.                  46100016
         LR    REGF,REG7     SAVE PTR TO FUNCTION I/O BLOCKS.           46108016
CCHHLOOP EQU   *                                                        46116016
         LTR   REG9,REG9          IS THIS THE LAST COPY BLOCK.          46124016
         BZ    EXCPLINK           YES- LINK TO EXCP.                    46132016
         LA    REG7,CIOBLOCK      POINT TO COPY I/O BLOCK.              46140016
         MVC   SEEKADDR+3(4),SEEKADDR+3-IHADCB(REGF) PUT CCHH IN COPY.  46148016
         L     REG9,CCOPYPTR      GET NEXT COPY BLOCK POINTER.          46156016
         B     CCHHLOOP           LOOP UNTIL COPIES ARE COMPLETE.       46164016
EXCPLINK EQU   *                                                        46172016
         LR    REG7,REGF          RESTORE FUNCTION I/O BLOCK PTR.       46180016
         L     REG9,COPYPTR            POINT TO FIRST COPY BLOCK.       46188016
         BAL   REG5,EXCPLOOP     WRITE ALL COPIES IN PARALLEL.          46200016
         B     NEXTRK             LOOP UNTIL VTOC IS FINISH.            46230016
FINISH   EQU   *                                                        46260016
         LA    REGF,8             SET UP ABNORMAL COMPLETION CODE.      46290016
         TM    IPLTRK1,IPLDD      IS NONIPLABLE BIT SET.                46320016
         BO    RETOKAY            YES-RETURN WITH A CODE 4.             46350016
         SR    REGF,REGF                                                46400016
RETOKAY  EQU   *                                                        46450016
         B     EXITFINL                                                 46500016
MSGLINK  EQU   *                                                        46600016
         LINK  EP=IEHDMSGB        GET PROPER MESSAGE.                   46700016
         BR    REG5                                                     46800016
MSGPRINT EQU   *                                                        46900016
         LINK  EP=IEHDPRNT                                              47000016
         BR    REG5                                                     47100016
SYNADERR EQU   *                                                        47200016
         SYNADAF ACSMETH=EXCP,PARM1=WKAIOB                              47300016
         MVC   MESS+22(78),49(REG1)    SET MSG IN OUTPUT BUFFER. SM4350 47370021
         SYNADRLS                                                       47450016
         BR    REG5                                                     47500016
NOIPLDS  EQU   *                                                        47540016
         LA    REG1,13                                                  47550016
         BAL   REG5,MSGLINK       BUILD I/O ERROR MESSAGE IN BUFFER.    47560016
         SYNADAF   ACSMETH=QSAM                                         47580016
         MVC   MESS+22(78),49(REG1)    SET MSG IN OUTPUT BUFFER. SM4350 47610021
         SYNADRLS                                                       47640016
         BAL   REG5,MSGPRINT      PRINT I/O ERROR MSG.                  47660016
         B     IPLMSG2            PRINT NEXT MSG,CLOSE DCB AND EXIT.    47680016
MSGZERO  EQU   *                                                        47700016
         LA    REG1,28            PICK UP MESSAGE NUMBER.               47710016
         BAL   REG5,MSGLINK       GET MESSAGE INTO OUTPUT BUFFER.       47720016
         MVC   0(8,REG1),DDNAME2  ASSUME THIS IS A PRIMARY FUNCTION.    47730016
         LA    REG0,FBLOCKS       GET POINTER TO PRIMARY I/O BLOCKS.    47740016
         CR    REG0,REG7          TEST FOR PRIMARY.                     47750016
         BE    EXIT               EXIT IF THIS WAS A PRIMARY FUNCTION.  47760016
         MVC   0(8,REG1),DDNAME3  GET DDNAME FROM COPY BLOCK.           47770016
         B     EXIT               EXIT                                  47780016
*                                 CONSTANTS                             47800016
RPSS     EQU   X'40'                    INDIC RPS ON DASD VOL   XM4389  47802003
D3350    EQU   X'0B'                   3350 DEVICE TYPE        @VS40037 47804003
FACTPACK EQU   9                                                 S20201 47810020
ZEUS1    EQU   6                                                 S20201 47820020
ZEUS2    EQU   7                                                 S20201 47830020
D1       EQU   1                                                 S20201 47860020
D2       EQU   2                  DISPLACEMENT CONSTANT        @Y30LSFY 47860403
D3       EQU   3                  DISPLACEMENT CONSTANT        @Y30LSFY 47860803
SS1VAL   EQU   X'01'              SS/1 CONVERSION              @Y30LSFY 47862003
L4       EQU   4                  LENGTH CONSTANT              @Y30LSFY 47862403
L5       EQU   5                  LENGTH CONSTANT              @Y30LSFY 47864003
L6       EQU   6                  LENGTH CONSTANT              @Y30LSFY 47864403
L8       EQU   8                  LENGTH CONSTANT              @Y30LSFY 47864803
D12      EQU   12                 DISPLACEMENT CONSTANT        @Y30LSFY 47866003
SS1AVEXT DC    X'0003000011'      TRACKS 3-19 AVAIL.           @Y30LSFY 47868003
F1       DC    F'1'                                              S20201 47870020
TEMP     DC    F'0'                                              S20201 47880020
         DC    C'MAINTENANCE AREA'                                      47880402
MAINT    DS    50F                      MAINT AREA              XL02912 47880802
         AIF   ('&LIB' EQ 'LIB1').X0005                          X02912 47882002
WIN      EQU   X'0A'                                             XM5465 47882403
ONE      EQU   1                                                 XM5465 47882803
IPLMAX   DC    F'6496'                  MAX IPLTXT RECORD SIZE   X02912 47884002
.X0005   ANOP                                                    X02912 47886002
K1       EQU   D1                                                S20201 47890020
K3       EQU   3                                                 S20201 47900020
K8       EQU   8                       2314 DEVICE TYPE         SA54550 47902021
ZERO     EQU   X'0000'                                           S20201 47910020
DEV2321  EQU   X'05'                   2321 DEVICE TYPE                 47912000
*                                                                       47920020
*   CARNIVAL CCW'S                                                      47930020
*                                                                       47940020
SETSECCW CCW   X'23',F1,X'40',1                                  M6129  47950020
TICCW    EQU   *                                                 S20201 47960020
         DC    X'08'                                             S20201 47970020
TICADD   DC    AL3(0)                                            S20201 47980020
         DC    F'0'                                              S20201 47990020
RCOUNT1N DC    F'0'                                                     48000016
         DC    X'01'                                                    48100016
         DC    X'04'                   KEY LENGTH.               A34946 48150020
         DC    AL2(CC1COUNT-4)     DATA LENGTH                   S20201 48200020
         DC    CL4'IPL1'              KEY DATA.                  A34946 48250020
REC1PSWN DC    X'000600000000000F'     WAIT STATE PSW (NON-IPL)         48300016
RD1CCWIN DC    X'0300000000000001'     NOP CCW.                         48400016
RD1CCW2N DC    X'0000000000000000'     DUMMY CCW.                       48500016
RCOUNT1I DC    F'0'               COUNT FIELD FOR RECORD 1 (IPL)        48600016
         DC    X'01'                                             M2888  48620020
         DC    X'04'                   KEY LENGTH.               A34946 48650020
         DC    AL2(CC1COUNT-4)          DATA LENGTH.             S20201 48700020
         DC    CL4'IPL1'               KEY DATA.                 A34946 48750020
REC1PSWI DC    X'0000000000000000'     PSW (IPL)                        48900016
RD1CCW1I DC    X'06003A9860000060'       READ RECORD 2.                 49000016
RD1CCW2I DC    X'08003A9800000000'    TIC TO CCW JUST READ IN.          49100016
RCOUNT2N DC    F'0'               COUNT FIELD FOR RECORD 2.             49200016
         DC    X'02'                                                    49300016
         DC    X'04'                   KEY LENGTH.               A34946 49350020
         DC    AL2(CC4COUNT)           DATA LENGTH.              A34946 49400020
         DC    CL4'IPL2'               KEY DATA.                 A34946 49450020
RCD2CCW1 DC    X'07003AB840000006'     SEEK TO IPL TRACK.               49500016
RCD2CCW2 DC    X'31003ABE40000005'     SEARCH FOR IPL RECORD.           49600016
RCD2CCW3 DC    X'08003AA000000000'                                      49700016
         AIF   ('&LIB' EQ 'LIB2').X0006                          X02912 49750002
RCD2CCW4 DC    X'0600000020000E29'     READ IPL RECORD INTO CORE.       49800016
         AGO   .X0007                                            X02912 49802002
.X0006   ANOP                                                    X02912 49804002
RCD2CCW4 DC    X'0600000020001960'     READ IPL REC 3 INTO CORE. X02912 49806002
.X0007   ANOP                                                    X02912 49808002
RCOUNT3N DC    F'0'                COUNT FIELD REC 3             S20201 49810020
         DC    X'03'                                             S20201 49820020
         DC    X'04'               KEY FIELD                     S20201 49830020
         DC    AL2(CC3COUNT-4)    DATA LENGTHAND COUNT FIELD     S20201 49840020
         DC    C'VOL1'             KET FIELD REC 3               S20201 49850020
         DC    C'VOL1'             START OF DATA FIELD           S20201 49860020
INPUTDCB EQU   *                                                        49900016
         DCB   DSORG=PS,MACRF=GL,RECFM=FB,LRECL=80,EXLST=LIST,         *50000016
               SYNAD=NOIPLDS,EODAD=CLOSE1                               50100016
LIST     EQU   *                                                        50200016
         DC    X'85'                                                    50300016
         DC    AL3(TSTBLKSI)                                            50400016
IPLCOUNT DC    F'1'                                                     50500016
         DC    X'01'                                                    50600016
         DC    AL3(3625)                                                50700016
CCW1     EQU   *                                                        50800016
         DC    X'31'                                                    50900016
         DC    AL3(ZEROS-WORKAREA)                                      51000016
         DC    X'40000005'                                              51100016
CCW2     EQU   *                                                        51200016
         DC    X'08'                                                    51300016
         DC    AL3(CCMND1-IHADCB)                                       51400016
         DC    F'0'                                                     51450016
CCW3     EQU   *                                                        51500016
         DC    X'1D'                                                    51600016
         DC    AL3(0)                                                   51700016
         DC    X'60000008'                                         9581 51800017
CCW4     EQU   *                                                        51900016
         DC    X'1E'                                                    52000016
         DC    AL3(0)                                                   52100016
         DC    X'30000000'                                              52200016
CCW1FMT  DC    X'31'               DUMMY CCWS TO CONSTRUCT VTOC.        52300016
         DC    AL3(0)                                                   52400016
         DC    X'40000005'                                              52500016
CCW2FMT  DC    X'08'                                                    52600016
         DC    AL3(0)                                                   52700016
         DC    F'0'                                                     52800016
CCW3FMT  DC    X'1D'                                                    52900016
         DC    AL3(0)                                                   53000016
         DC    X'40000094'                                              53100016
CCW4FMT  DC    X'16'                                                    53200016
         DC    AL3(0)                                                   53300016
         DC    X'70000005'                                              53400016
CCW5FMT  DC    X'1E'                                                    53500016
         DC    AL3(0)                                                   53600016
         DC    X'50000094'                                              53700016
CCW6FMT  DC    X'1A'                                                    53800016
         DC    AL3(0)                                                   53900016
         DC    X'30000005'                                              54000016
DSCBCNT  DC    X'2C0060'                                                54100016
TEXTCARD DC    C'TXT'                                                   54200016
         DS    0D                                                  O122 54203019
CCWA     DC    X'31'                    SEARCH FOR FORMAT 4 DSCB   O122 54206019
         DC    AL3(0)                                              O122 54209019
         DC    X'40000005'                                         O122 54212019
CCWB     DC    X'08'                    TIC TO SEARCH              O122 54215019
         DC    AL3(0)                                              O122 54218019
         DC    F'0'                                                O122 54221019
CCWC     CCW   X'0E',8,X'20',144 READ DATA FORMAT 4    PTMFIX           54224003
CCW01    EQU   *                        READ HOME ADDRESS          O122 54227019
         DC    X'1A'                                               O122 54230019
         DC    AL3(ALTHA-BUFFREAD)                                 O122 54233019
         DC    X'40000005'                                         O122 54236019
CCW02    EQU   *                        READ RECORD ZERO           O122 54239019
         DC    X'16'                                               O122 54242019
         DC    AL3(ALTR0-BUFFREAD)                                 O122 54245019
         DC    X'20000008'                                         O122 54248019
CCWSRCH  DC    X'31'                    SEARCH ON RECORD 3         O122 54251019
         DC    AL3(0)                                              O122 54254019
         DC    X'40000005'                                         O122 54257019
CCWBCK   DC    X'08'                    TIC TO SEARCH              O122 54260019
         DC    AL3(COMND1-BUFFREAD)                                O122 54263019
         DC    F'0'                                                O122 54266019
CCWRD    DC    X'06'                    READ DATA OF VOLUME LABEL  O122 54269019
         DC    AL3(VOLABEL-BUFFREAD)                               O122 54272019
         DC    X'10000050'                                         O122 54275019
         AIF   ('&LIB' EQ 'LIB2').X227328                       XL03912 54276003
SCC2321  DC    X'00F60000'              INCREMENT TO NEXT SUBCELL  O122 54278019
STC2321  DC    X'0000FB00'              INCREMENT TO NEXT STRIP    O122 54281019
.X227328 ANOP                                                   XL03912 54282003
HA1      DC    H'1'                     ONE                        O122 54284019
HA32     DC    H'32'                    32                         O122 54287019
HA24     DC    H'24'                    24                         O122 54290019
*                                                                       54300016
CVT      DSECT                                                          54330016
         CVT   SYS=MIN                                                  54360016
         DCBD  DSORG=PS           DATA CONTROL BLOCK.                   54400016
         ORG   IHADCB+72                                                54450016
*                                                                       54500016
*                                                                       54600016
WKAECB   DS    F                  EVENT CONTROL BLOCK.                  54700016
*                                                                       54800016
*                                                                       54900016
WKAIOB   DS    F                  INPUT/OUTPUT BLOCKS.                  55000016
IOBSENS1 EQU   WKAIOB+3                 SENSE BYTE 1 OF IOB        O122 55030019
NOREC    EQU   X'08'                    NO RECORD FOUND            O122 55060019
ECBADD   DS    F                  EVENT CONTROL BLOCK POINTER.          55100016
         DS    F                                                        55200016
CSWORD   DS    F                  CHANNEL STATUS WORD.                  55300016
IOBCSWST EQU   WKAIOB+12                IOB STATUS                 O122 55330019
UE       EQU   X'01'                    UNIT EXCEPTION             O122 55360019
CCWPTR   DS    F                  CHANNEL PROGRAM POINTER.              55400016
DCBADD   DS    F                  DATA CONTROL BLOCK POINTER            55500016
         DS    F                                                        55550016
BLKERRCT DS    F                                                        55600016
SEEKADDR DS    2F                                                       55700016
         DS    F                                                        55800016
*                                                                       55900016
*                                                                       56000016
CCOMMAND DS    0D                 CHANNEL COMMAND WORDS                 56100016
CCMND1   DS    D                                                        56200016
CCMND2   DS    D                                                        56300016
CCMND3   DS    D                                                        56400016
CCMND4   DS    D                                                        56500016
CCMND5   DS    D                                                        56600016
CCMND6   DS    D                                                        56700016
CCMND7   DS    D                                                        56800016
CCMND8   DS    D                                                        56900016
CCMND9   DS    D                                                        57000016
CCMNDA   DS    D                                                        57100016
CCMNDB   DS    D                                                        57200016
CCMNDC   DS    D                                                        57300016
         EJECT                                                 @Y30LSFY 57400003
WORKAREA DSECT                                                          57500016
RCD1CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 1  C'00001024'.    57600016
RECORD1  DS    CL24               RECORD NUMBER 1 IPL/NON-IPL.          57700016
IPLKEY1  DC    CL4'IPL1'                                         S20201 57750020
RCD2CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 2  C'00002032'.    57800016
RECORD2  DS    CL32               RECORD NUMBER 2.                      57900016
IPLKEY2  DC    CL4'IPL2'                                         S20201 57950020
IPLSEEK  DS    CL6                      SEEK ADDRESS FOR IPL RECORD.    58000016
IPLSURCH DS    CL5                                                      58100016
         DS    CL5                                                      58150016
RCD3CNT  DC    CL8'CCHHRKDL'      COUNT FIELD RECORD 3  C'00003080'.    58200016
VOLLABEL DS    0CL84               VOL LABEL REC 3               S20201 58260020
VOLKEY   DC    CL4'VOL1'           KEY FOR REC 3                 S20201 58320020
VOLIDENT DC    C'VOL'                  VOLUME LABEL IDENTIFIER.         58400016
VOLNUMBR DS    XL1                     VOLUME LABEL NUMBER.             58500016
VOLSERNO DS    CL6                     VOLUME SERIAL NUMBER.            58600016
VOLSECTY DS    XL1                     VOLUME SECURITY INDICATOR.       58700016
VVTOCPTR DS    CL10                    VTOC POINTER C'CCHHRRESVR'.      58800016
VOLRESV1 DS    CL10                    RESERVED FOR MANUFACTURERS USE.  58900016
VOLRESV2 DS    CL10                    RESERVED                         59000016
VOLOWNER DS    CL10                    OWNER NAME AND ADDRESS CODE      59100016
VOLRESV3 DS    CL29                    RESERVED                         59200016
VOLEND   EQU   *                                                        59300016
CC1COUNT EQU   RCD2CNT-RECORD1         RECORD 1 DATA LENGTH.            59900016
CC2COUNT EQU   RCD3CNT-RECORD2         RECORD 2 DATA LENGTH.            60000016
CC3COUNT EQU   VOLEND-VOLKEY      RECORD 3 LENGTH                S20201 60070020
CC4COUNT EQU   144                                                 9581 60150017
CC3      EQU   CC3COUNT+8                                               60200016
         ORG   WORKAREA+188                                      S20201 60400020
UNASGBT  DS    CL1                     USED BY IEHDANAL        @Y30LSFY 60450003
         DS    CL3                     RESERVED                @Y30LSFY 60500003
SAVEAREA  DS    0F                                                      60600016
PL1WORD  DS    F                  THIS WORD IS USED BY PL/1.            60700016
OLDSAPTR DS    F                  POINTER TO PREVIOUS SAVE AREA.        60800016
NEWSAPTR DS    F                  POINTER TO NEXT SAVE AREA.            60900016
RETADREG DS    F                  (REG14)-RETURN ADDRESS REGISTER.      61000016
ENTRYPTR DS    F                  (REG15)-ENTRY POINT REGISTER.         61100016
REG0TO12 DS    13F                REGISTERS 0 THROUGH 12.               61200016
SAVEVTOC DS    8F                                                       61300016
ANALTEMP DS    F                       USED                    @Y30LSFY 61310003
SAVCCHHR DS    F                         BY                    @Y30LSFY 61320003
SAVCCWPT DS    F                           IEHDANAL            @Y30LSFY 61330003
         DS    0D                                                S20201 61350020
PRGSAVE  DS    10F                                                      61400016
RTAVTOCS DS    F                                                        61500016
RTAVTOCE DS    F                                                        61600016
         ORG   *-16                                                     61700016
DDEB     DS    0F                 FAKE DEB FOR CONVERT ROUTINE.         61800016
         ORG   *+16                                                     61900016
DEXTNTNO DS    CL1                DUMMY EXTNT NUMBER.                   62000016
MBBCCHH1 DS    CL7                SAVE AREA FOR VTOC EXTENT.            62100016
MBBCCHH2 DS    CL8                                                      62200016
DUCBPTR  DS    F                  FAKE UCB POINTER.                     62300016
HALFWD   DS    H                  HALF WORD WORK SPACE.                 62400016
DEXTNTS  DS    HL4                DUMMY STARTING CCHH(000000)           62500016
DEXTNTE  DS    HL4                DUMMY ENDING CCHH.                    62600016
DEXTNTR  DS    H                  DUMMY NO TRACKS.                      62700016
WKBUFPTR DS    F                                                        62800016
WKBUFSI  DS    F                                                        62900016
PARMLST  DS    0F                                                       63000016
PARMUCB  DS    F                                                        63100016
PARMDCB  DS    F                                                        63200016
PARMCCHH EQU   PARMDCB                                                  63300016
PARMALTD DS    F                                                        63400016
STRTRACK DS    H                                                        63480016
FULLCYLS DS    H                                                        63560016
EXTRACKS DS    C                                                        63640016
ZEROS    DS    CL5                                                      63720016
IPLTRK1  DS    CL1                                                      63800016
WKAEND   DS    0D                                                       63900016
SAVEREGD EQU   SAVEVTOC+4                                               64000016
SIZE     EQU   WKAEND-RCD1CNT                                           64100016
*                                                                       64200016
**********************************************************************  64300016
BUFFREAD DSECT                                                     O122 64304019
         DS    0F                                                  O122 64308019
ALTHA    DS    CL5                      AREA TO READ HOME ADDRESS  O122 64312019
         DS    CL3                                                 O122 64316019
ALTR0    DS    2F                       AREA TO READ RECORD ZERO   O122 64320019
TRKSW    DS    CL1                      SWITCH FOR ALTERNATE       O122 64324019
*                                          TRACKS                  O122 64328019
TRKCLR   EQU   X'00'                    CLEAR SWITCH               O122 64332019
TRKFND   EQU   X'01'                    FIRST ALTERNATE TRACK HAS  O122 64336019
*                                          BEEN FOUND              O122 64340019
TRYCOPY  EQU   X'10'                    PRIMARY COPY DONE          O122 64344019
SKADDR   DS    1F                       SAVE AREA FOR SEEK ADDR    O122 64348019
SAVECCHH DS    1F                       SAVE AREA FOR CCHH         O122 64352019
ALTINFO  DS    1F                       ALTERNATE TRACK INFO       O122 64356019
NOALT    DS    CL1                      NUMBER OF ALTERNATES       O122 64360019
         DS    0D                                                  O122 64364019
COMND1   DS    1D                       QUICK DASDI CHANNEL        O122 64368019
COMND2   DS    1D                          PROGRAM AREA            O122 64372019
COMND3   DS    1D                                                  O122 64376019
VOLABEL  DS    1F                       FOR VOLUME LABEL           O122 64380019
BUFFER   DSECT                                                          64400016
F4COUNT  DS    CL8                                                      64430016
         ORG   F4COUNT+52                                               64460016
         IECSDSL1 (4)                                                   64500016
F5COUNT  DS    CL8                                                      64550016
         IECSDSL1 (5)                                                   64600016
F0COUNT  DS    CL8                                                      64650016
         ORG   BUFFER                                                   64700016
IPL1CNT  DC    CL8'CCHHRKDL'                                            64800016
         DS    CL3625                                                   64900016
KENUCB   DSECT                                                          64950016
         IEFUCBOB                                                       65000016
         IEHDBLKS                                                       65100016
         IEHDWORK                                                       65200016
         END                                                            65300016
