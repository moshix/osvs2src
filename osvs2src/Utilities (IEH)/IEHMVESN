 TITLE 'IEHMVSSN-WRAPUP,CLOSE OF FROM,TO DSETS--IEHMOVE LOAD MOD VESN'  00010017
*TITLE--IEHMVSSN-WRAPUP,CLOSE OF FROM,TO DSETS--IEHMOVE LOAD MOD VESN   00020017
*FUNCTION/OPERATION: TO COMPLETE THE JOB OF MOVING OR COPYING A DATA  * 00040000
*SET, IEHMVSSN FIRST CLOSES THE 'FROM' AND 'TO' DATA SETS AND THEN    * 00060000
*PASSES CONTROL TO ANOTHER WRAP UP ROUTINE DEPENDING UPON THE TYPE OF * 00080000
*OPERATION PERFORMED AND UPON THE RESULTS OF THAT OPERATION           * 00100000
*ENTRY POINTS: IEHMVESN                                               * 00120000
*INPUT: NONE                                                          * 00140000
*OUTPUT: NONE                                                         * 00160000
*EXTERNAL ROUTINES: IEHMVSSU                                          * 00180000
*EXITS - NORMAL  IEHMVESP, IEHMVESQ,                                  * 00200002
*        ERRORS: IEHMVESO, IEHMVSSK                                   * 00220000
*TABLES/WORK AREAS: IEHMVV00                                          * 00240000
*ATTRIBUTES: REENTRANT                                                * 00260000
*********************************************************************   00280000
**                                                                      00300000
**                            IEHMVSSN                                  00320000
**                                                                      00340000
*********************************************************************   00360000
*                                                                       00380000
IEHMVSSN CSECT                                                     8650 00392013
*A008366-008382                                                @ZA01745 00392203
*D008366-008381                                                @ZA01745 00392403
*A009050-009260                                                 YA01457 00392602
*D009050-009300                                                 YA01457 00393202
*A032140,083800                                                  S21042 00394021
*A008900,014200,014800,D015000-015200,A015950,D016000            A43752 00398021
*A021400,D021500-021600,A030280,030520,032000,D032200-038600     A43752 00398421
*C038800,A083310                                                 A43752 00398821
*A009300,D009350                                                 A41754 00399221
*C034500,034560                                                  A38758 00399321
*A044600                                                          19030 00399621
*D034100-034300,034700,035100                                    A26597 00399721
*A023500                                                        YL026VC 00399802
*C030300                                                        YL026VC 00399902
*C2000,41600                                                     Y02918 00400102
*D41800-42000,42800,47800-50000                                  Y02918 00400302
*A025100-025200,028000-029004,030040-030060                    @Z40CSJH 00400704
*A041300-041320,047800-047900,026600-026980,028000-029004      @Z40CSJH 00400804
*A083370                                                       @Z40CSJH 00400904
A0       EQU   0                                                        00401002
A1       EQU   1                                                        00420000
A2       EQU   2                                                        00440000
A3       EQU   3                                                        00460000
A4       EQU   4                                                        00480000
A5       EQU   5                                                        00500000
A6       EQU   6                                                        00520000
A7       EQU   7                                                        00540000
A8       EQU   8                                                        00560000
A9       EQU   9                                                        00580000
A10      EQU   10                                                       00600000
A11      EQU   11                                                       00620000
A12      EQU   12                                                       00640000
A13      EQU   13                                                       00660000
A14      EQU   14                                                       00680000
A15      EQU   15                                                       00700000
IEHMVESN SAVE  (2,12),T,ESN-WRAP-UP---                                  00720000
         ENTRY IEHMVESN                                                 00740000
         EXTRN IEHMVMSN                                                 00760000
         LR    A9,A15                  SET BASE REGISTER                00780000
         USING IEHMVESN,A9                                              00800000
         USING  IEHMVV,A12                                              00820021
         IEHPRE ,TFC                                                    00820421
* THIS RTN FINDS AND SAVES THE VOL SER NBR AND FILE SEQ NBR      A43752 00820821
* FOR THE TO-VOLUMELIST ROUTINE.                                 A43752 00821221
* FOR OPEN TO-DATA SETS THE UCB ADDRESS IS FOUND IN THE          A43752 00821621
* LAST EXTENTDESCRIPTION OF THE DEB                              A43752 00822021
* FOR CLOSED DATASETS OR DATASETS WITHOUT A DCB THE UCB ADDRESS  A43752 00822421
* IS FOUND IN THE TIOT                                           A43752 00822821
* ALWAYS THE VOL SER NBR IS STORED IN THE COMMUNICATIONS AREA    A43752 00823221
* AT IEHMVV82+26                                                 A43752 00823621
* IN SOME CASES THE VOL SER NBR HAS BEEN SAVED IN IEHMVV82+26    A43752 00824021
* EARLIER ( I.E. BY MODULES IEHMVSTA OR IEHMVETG )               A43752 00824421
         CLI   IEHMVV72+11,X'FF'       UL TRACK MISSING(SSX)     A43752 00824821
         BE    TIOTUCB                 YES GET UCB ADDR VIA TIOT A43752 00825221
         TM    IEHMVV20+4,X'08'        MODEL DSCB                A43752 00825621
         BO    TIOTUCB                                           A43752 00826021
         L     A2,IEHMVV31             GET TO DCB ADDR           A43752 00826421
         TM    48(A2),X'10'            IS THE DCB OPEN           A43752 00826821
         BO    DEBUCB                  YES GET UCB ADDR VIA DEB  A43752 00827221
         TM    IEHMVV82+24,X'80'       VOL FROM STA OR ETG       A43752 00827621
         BO    CONTINUE                YES VOL SER ALREADY FOUND A43752 00828021
TIOTUCB  DS    0H                      NO GET UCB VIA TIOT       A43752 00828421
         L     A4,IEHMVV31+8           DDNAME IN TIOT            A43752 00828821
         LA    A4,12(A4)               UCB ADDR IN TIOT          A43752 00829221
         B     SAVEUCB                 SAVE UCB ADDRESS          A43752 00829621
DEBUCB   DS    0H                                                A43752 00830021
         L     A4,44(A2)               DEB ADDR                  A43752 00830421
         SR    A2,A2                   CLEAR FOR INSERT          A43752 00830621
         IC    A2,16(A4)               NBR OF EXTENTS            A43752 00830821
         TM    28(A4),X'04'            DA DEVICE                 A43752 00831221
         BO    OFFS16                  YES FIND LAST EXTENT      A43752 00831621
         LA    A4,28(A4)               SCAN THE EXTENTS   T      A43752 00832021
NEXTEXT1 LA    A4,4(A4)                JUMP TO NEXT EXTENT       A43752 00832421
         BCT   A2,NEXTEXT1             SCAN FURTHER              A43752 00832821
         B     SAVEUCB                 STORE UCB ADDR            A43752 00833221
OFFS16   DS    0H                                                A43752 00833621
         LA    A4,16(A4)               JUMP TO NEXT EXTENT       A43752 00834021
NEXTEXT2 LA    A4,16(A4)               JUMP                      A43752 00834421
         BCT   A2,NEXTEXT2             SCAN FURTHER              A43752 00834821
SAVEUCB  L     A4,0(A4)                GET UCB ADDR              A43752 00835221
         LR    A3,A4                   BASE THE UCB              A43752 00835621
         USING IEFUCBOB,A3             WITH REG 3                A43752 00836121
         L     A4,IEHMVV23+4           ADDRESS OF ACTIVE       @ZA01745 00836603
*                                      TO VOLUME               @ZA01745 00837003
         MVC   IEHMVV82+26(6),4(A4)    SAVE VOL SER NBR        @ZA01745 00837403
         CLI   3(A4),X'05'             2321 DEVICE             @ZA01745 00837803
         BE    CONTINUE                YES                     @ZA01745 00838203
STOREVOL MVC   IEHMVV82+26(6),SRTEVOLI                           A43752 00838621
         MVC   IEHMVV82+24(2),SRTEFSEQ SAVE LOGICAL FILE SEQ NBR A43752 00839121
CONTINUE NI    IEHMVV82+24,X'7F'       CLEAR THE SWITCH          A43752 00839621
         TM    IEHMVV20+2,MIDABRT  TEST FOR MID ABORT BIT ON     PTM504 00840317
         BZ    *+14                 IF NOT, BYPASS NEXT 2 INSTR  PTM504 00840617
         MVI   UDCBIHLE,DEACTIVE    IF SO, DEACTIVATE ALL USER   PTM504 00840917
         MVC   UDCBIHLE+1(15),UDCBIHLE  LABEL EXITS SINCE ONLY   PTM504 00841217
*                                  CODING FOR OTLE EXISTS IN ESN PTM504 00841517
         TM    IEHMVV20+4,X'08'        IS MODEL DSCB SWITCH ON     2695 00842017
         BC    1,NOFREEA     SEE IF FROM DCB OPEN                A25571 00844018
         CLI   UDCBITLE,DEACTIVE       IS ITLE INACTIVE            UL0H 00846017
         BE    SETLABSW                YES, CONTINUE               UL0H 00848017
         MVC   UDCBOTLE(4),XXOTLE      NO, SET UP OTLE LIST ADDR   UL0H 00850017
         MVI  UDCBITLE,DEACTIVE  DEACTIVATE INPUT TRAILER LABEL  A21645 00851018
SETLABSW DS    0H                                                  UL0H 00852017
         MVC   IEHMVV72+4(4),IEHMVV72  INITIALIZE 1ST LABEL PTR    UL0H 00854017
         CLI   IEHMVV72+14,X'FF'       DID EOV REQUEST OUTPUT      UL0H 00856017
         BNE   WRAPUP                  NO, CLOSE DATA SETS         UL0H 00858017
*                                                                  UL0H 00860017
* OUTPUT MESSAGE - NO USER LABELS MOVED/COPIED. NO LABEL TRACK     UL0H 00862017
*                                                                  UL0H 00864017
         LA    A8,IEHMVV00+1           LOCATION FOR MESSAGE STORE  UL0H 00866017
         LA    A15,20                  GET MESSAGE CONSTANT        UL0H 00868017
         ST    A14,SAVE14              SAVE REG14                  UL0H 00870017
         BAL   A14,MSGCLEAR            CLEAR AREA, MOVE IN MSG     UL0H 00872017
         L     A14,SAVE14              RESTORE REG 14              UL0H 00874017
         BAL   A2,LINEPR               GO PRINT MESSAGE            UL0H 00876017
WRAPUP   DS    0H                                                  UL0H 00878017
         L     A2,IEHMVV30             LOAD ADDR OF 'FROM' DCB          00880017
         CLOSE ((A2))                  CLOSE THE 'FROM' DATA SET        00882017
         CLI   IEHMVV72+11,X'FF'       NO U.L. TRK FLG SET BY SSX  UL0H 00884017
         BE    CHECK                   YES, SKIP CLOSE OF 'TO' DATAUL0H 00886017
         TM    IEHMVV20+4,X'08'   IS IT A MODEL DSCB             A25571 00886618
         BO    NOFREE         YES, BYPASS CLOSE OF TO DATA SET   A25571 00887218
*                                      SET - WAS NEVER OPENED      UL0H 00888017
         L     A2,IEHMVV31             LOAD ADDR OF 'TO' DCB            00890017
         CLI   17(2),X'81'             IS TO VOLUME 2400        YA01457 00905002
         BE    TEST                     YES , GO TO TEST        YA01457 00907002
         CLI   17(2),X'83'             IS TO VOLUME 3420        YA01457 00910002
         BNE   NOLEAVE                  NO , GO TO NOLEAVE      YA01457 00912002
TEST     TM    IEHMVV20,VOLUME         MOVE/COPY VOLUME         YA01457 00915002
         BO    LEAVE                    YES , GO TO LEAVE       YA01457 00920002
         TM    IEHMVV20,DSGROUP        MOVE/COPY DSGROUP        YA01457 00922002
         BO    LEAVE                    YES , GO TO LEAVE       YA01457 00925002
NOLEAVE  CLOSE ((2))                   CLOSE NO LEAVE              8650 00932021
         TM    IEHMVV82+16,X'80' BDAM DATA SET                   A41754 00934021
         BNO   CHECK                    NO CONTINUE              A41754 00934121
         NI    IEHMVV82+16,X'7F'       CLEAR THE SWITCH          A41754 00934221
         L     A1,IEHMVV82+16    YES, GET BDAM-AREA              A41754 00934421
         LA    A1,0(A1)                 CLEAR HIGH ORDER BYTE    A41754 00934821
         L     A0,IEHMVV82+20    GET SIZE OF CORE                A41754 00934921
         FREEMAIN R,LV=(0),A=(1)        RELEASE THE AREA         A41754 00935021
         B     CHECK                                               8650 00940013
NOFREEA  TM    IEHMVV10-4,FROMOP                                PTM2138 00941018
         BZ    NOFREE                                           PTM2138 00942018
         NI    IEHMVV10-4,X'7F'                                 PTM2138 00943018
         B     WRAPUP                                           PTM2138 00944018
LEAVE    CLOSE ((2),LEAVE)             CLOSE WITH LEAVE            8650 00945013
CHECK    CLI   IEHMVV74+4,X'FF'         I/O ERR IN U.L. EXIT RTN   UL0H 00946017
         BE    IOERRMSG                 YES, TELL USER             UL0H 00947017
ERMSGRET DS    0H                                                  UL0H 00948017
         LA    A10,IEHMVV00+8          SET UP ADDRESSIBILITY TO    UL0H 00949017
         USING IEFJFCBN,A10            THE JFCB                    UL0H 00950017
         MVI   UDCBIHLE,DEACTIVE                                   UL0H 00951017
         MVI   UDCBOHLE,DEACTIVE                                   UL0H 00952017
         MVI   UDCBITLE,DEACTIVE                                   UL0H 00953017
         MVI   UDCBOTLE,DEACTIVE                                   UL0H 00954017
         NI    JFCBLTYP,X'F7'           CLEAR SUL INDICATOR SET AT UL0H 00955017
         DROP  A10                                                      00956017
*                                       U.L. TRK ALLOCATION TIME   UL0H 00957017
         TM    IEHMVV20+1,UNLOAD        UNLOAD                     UL0H 00958017
*                                          IF YES FREE BUFFERS          00960000
         BZ    NOFREE                     IF NOT ---                    00980000
         TM    IEHMVV20+1,LOAD          IS THIS A LOAD/UNLOAD           01000000
         BO    NOFREE                                                   01020000
         L     A1,IEHMVV31             LOAD ADDR OF TO DCB              01040000
         FREEPOOL  (1)                                                  01060000
NOFREE   DS    0H                                                       01080000
*********************************************************************** 01100000
**        V O L U M E   L I S T   F O R M A T                         * 01120000
*********************************************************************** 01140000
*********************************************************************** 01160000
**                      **                              **            * 01180000
** DEVICE  TYPE         **   VOLUME SERIAL NUMBER       ** SEQUENCE # * 01200000
**  (4 BYTES)           **       (6 BYTES)              **  (2 BYTES) * 01220000
**                      **                              **            * 01240000
*********************************************************************** 01260000
*********************************************************************** 01280000
**                                                                      01300000
**                                                                      01320000
********************************************************************    01340000
**                                                                      01360000
**       HANDLES THE ESTABLISHMENT OF A CORRECT ACTIVE VOL PTR          01380000
**                                                                      01400000
********************************************************************    01420000
         SR    A8,A8                                             A43752 01430021
         SR    A4,A4                                                    01440000
         IC    A4,IEHMVV23+4      LOAD NO OF ACTIVE VOLUMES             01460000
         L     A1,IEHMVV23+4      ADDR OF ACTIVE VOL ID                 01480000
         NI    IEHMVV20+4,X'FD'        CLEAR VOLSWITCH INDIC     A43752 01510021
*                                                                       01545013
*                                                                       01550013
*                                                                       01555013
CHECKVOL CLC   IEHMVV82+26(6),4(A1)    VOL SWITCH OCCURRED       A43752 01560021
         BE    ACTVOLOK                NO                        A43752 01570021
*                                                                       01590013
*                                                                       01595013
         OI    IEHMVV20+4,X'02'         INDICATE VOLUMESWITCH    A43752 01595421
         LA    A8,1(A8)                 COUNT NUMBER OF SWITCHES A43752 01595821
         LA    A1,OFFSVL(A1)            BUMP ACTIVE POINTER      A43752 01597021
         BCT   A4,CHECKVOL                                              01620000
         LA    A4,OFFSVL                VOLUMELIST ENTRYLENGTH   A43752 01630021
         SR    A1,A4              BACK UP ACTIVE PTR WITHIN LIST        01660000
         LA    A4,1                    SET VOL CNT TO 1          A43752 01680021
         BCTR  A8,0                    REDUCE NBR OF VOL'S IN MSGA43752 01684021
         LTR   A8,A8                   ONLY ONE ACT TO VOL       A43752 01688021
         BNZ   *+8                     NO CONTINUE               A43752 01692021
         NI    IEHMVV20+4,X'FD'        YES  DON'T HANDLE VOLSW   A43752 01696021
         MVC   4(6,A1),IEHMVV82+26     MOVE IN VOL SER NBR       A43752 01700021
ONMAIN   XC    SEQ(2,A1),SEQ(A1)       SEQ NBR ZERO              A43752 01748021
         CLI   2(A1),X'20'             TO DEVICE DA              A43752 01768021
         BE    ACTVOLOK                YES CONTINUE              A43752 01788021
         MVC   SEQ(2,A1),IEHMVV82+24   USE LOG FILE SEQ NBR      A43752 01808021
ACTVOLOK ST    A1,IEHMVV23+4      STORE PTR TO ACTIVE PTR               01860000
         STC   A4,IEHMVV23+4      STORE NO. OF VOLUMES IN LIST          01880000
         STC   A8,IEHMVV23             SAVE NBR OF VOLSWITCHES   A43752 01890021
         TM    IEHMVV20,DSGROUP         TEST FOR GROUP OPERATION        01900000
         BO    UPSEQ                      IF SO ---                     01920000
         TM    IEHMVV20,VOLUME          TEST FOR VOLUME OPERATION       01940000
         BO    UPSEQ                     IF SO ---                      01960000
         B     SEQON                                                    01980000
UPSEQ    L     A1,IEHMVV23+4           LOAD ADDR OF ACTIVE VOL ID       02000000
         CLI   2(A1),TAPEOUT            IS OUTPUT ON TAPE               02020000
********************************************************************    02040000
**                                                                      02060000
**       HANDLES UPING THE SEQ NO IN THE ACTIVE VOL LIST FOR TAPE OUT   02080000
**                                                                      02100000
********************************************************************    02120000
         BNE   SEQON                     IF NOT ---                     02140000
         TM    IEHMVV20+4,X'02'         VOLUME SWITCH            A43752 02142021
         BNO   CONTIN1                  NO CONTINUE              A43752 02144021
         SR    A7,A7                    YES GET FILE SEQ NBR     A43752 02146021
MOREVOL  LA    A7,OFFSVL(A7)                                     A43752 02150021
         BCT   A8,MOREVOL               FIND START OF LIST       A43752 02160021
         LR    A5,A1                    ADDR ACTIVE VOLUME       A43752 02170021
         SR    A5,A7                    ADDR START OF LIST       A43752 02172021
         MVC   DTCRT(2),SEQ(A5)         GET SEQ NUMBER           A43752 02174021
         B     CONTIN2                                           A43752 02176021
CONTIN1  MVC   DTCRT(2),SEQ(A1)         GET SEQ NUMBER           A43752 02178021
CONTIN2  LH    A2,DTCRT                                          A43752 02178421
         LA    A2,1(A2)                BUMP SEQ NO BY ONE               02180000
         LA    A3,1                                                     02200000
         CR    A3,A2              WAS SEQ UPED TO 1                     02220000
         BNE   *+8                    IF NOT --- DONE                   02240000
         LA    A2,1(A2)             OTHERWISE BUMP IT TO 2              02260000
         STH   A2,DTCRT                 REPLACE THE SEQUENCE       DT0I 02270018
         MVC   SEQ(2,A1),DTCRT                NUMBER               DT0I 02280018
SEQON    DS    0H                                                       02300000
********************************************************************    02350004
**                                                                      02400004
**       HANDLES THE CONSTRUCTION OF A TO CVOL PTR IF ONE DID NOT EXIST 02450004
**                                                                      02500004
**        LINES 023000-029179 WERE REACTIVATED IN              @Z40CSJH 02510004
**        SUPPORT OF THE MVS EXTENDED CVOL FUNCTION            @Z40CSJH 02520004
********************************************************************    02550004
         TM    IEHMVV20+1,CVOL         WAS CVOL SPECIFIED               02600004
         BO    GOTCVOL                      IF SO ---                   02650004
         TM    IEHMVV20+5,X'20'        DSGRP(NAME) SPECIFIED   @Z40CSJH 02660004
         BO    GOTCVOL                 BR IF YES               @Z40CSJH 02670004
         TM    IEHMVV20,X'01'          FROM VOL SPECIFIED      @Z40CSJH 02680004
         BO    GOTCVOL                 BR IF YES               @Z40CSJH 02690004
         TM    IEHMVV20,X'20'          DSNAME SPECIFIED        @Z40CSJH 02692004
         BO    GOTCVOL                 YES-BYPASS SYSRES       @Z40CSJH 02694004
         TM    IEHMVV20,X'08'          PDS SPECIFIED           @Z40CSJH 02696004
         BO    GOTCVOL                 YES-BYPASS SYSRES       @Z40CSJH 02698004
         L     WORK2,CVTSTRT            OTHERWISE -- FIND SYSRES UCB    02700004
         L     WORK2,CVTILK2(WORK2)       TO GET ASSUMED VOLUME ID      02750004
VON      ICM   WORK3,3,0(WORK2)        GET UCB @               @Z40CSJH 02800004
         N     WORK3,CLEARMSK          SAVE 16 BITS            @Z40CSJH 02850004
         TM    0(WORK2),X'FF'          IS IT LAST PTR          @Z40CSJH 02900004
         BC    1,GOTCVOL               BRANCH IF YES           @Z40CSJH 02900404
         LTR   WORK3,WORK3             CHECK FOR PTR V 0                02902004
         BZ    NOTAUCB                                                  02902404
         TM    UCBTBYT3,DAUCB          IS THIS UCB FOR DA               02902804
         BZ    NOTAUCB                                                  02903204
         TM    SRTESTAT,SYSRUCB        IS THIS A UCB FOR SYSRES         02903604
         BO    VFIND                                                    02903704
NOTAUCB  DS    0H                                                       02903804
         LA    WORK2,2(WORK2)          BUMP THE UCB PTR TABLE PTR       02903904
         B     VON                                                      02908904
VFIND    MVC   IEHMVV24(4),IEHMVV10    SET CVOL LIST PTR                02910904
         L     WORK2,IEHMVV10          LOAD ADDR OF PERM WK AREA        02912904
         MVC   0(4,WORK2),UCBTYP       MOVE DEVICE TYPE                 02914904
         MVC   4(6,WORK2),SRTEVOLI     MOVE VOLUME ID                   02915204
         DROP  A3                                                       02915604
         LA    WORK2,12(WORK2)         BUMP WK AREA PTR BY AMOUNT OF    02915704
         ST    WORK2,IEHMVV10              CORE USED AND STOR           02915804
         OI    IEHMVV20+1,CVOL          TURN ON CVOL BIT                02915904
         B     GOTCVOL                                                  02917904
*******************************************************************2695 02922004
*                                                                 *2695 02924004
* VSSX HAS JUST ALLOCATED A MODEL DSCB.  NO DCB WAS CREATED, AND  *2695 02925004
* THUS VESN MUST BYPASS READING JFCB TO GET VOLID OF 'TO' VOLUME. *2695 02930004
*                                                                 *2695 02935004
*******************************************************************2695 02940004
*                                                                  UL0H 02945004
*                                O R                               UL0H 02950004
*                                                                  UL0H 02955004
*******************************************************************UL0H 02960004
*                                                                  UL0H 02965004
* VESN WAS ENTERED FROM VSSX.  VSSX FOUND USER LABELS IN CORE,    *UL0H 02970004
* BUT NO USER LABEL TRACK WAS ALLOCATED FOR LABELS ON THE 'TO'    *UL0H 02975004
* DATA SET.  A DCB WAS THEREFORE NEITHER CREATED OR OPENED FOR    *UL0H 02980004
* THE 'TO' DATA SET, AND READING OF THE JFCB MUST BE BYPASSED.    *UL0H 02985004
*                                                                  UL0H 02990004
*******************************************************************UL0H 02995004
         DS    0F                                                       03000017
CLEARMSK DC    X'0000FFFF'                                     @Z40CSJH 03004004
GOTCVOL  DS    0H                                              @Z40CSJH 03006004
*********************************************************************** 03012017
*                                                                       03016017
** HANDLES THE BUILDING OF A LIST OF VOLS USED BY THE DS JUST MOVED     03020017
*                                                                       03024017
*********************************************************************** 03028017
LISTVOL  L     A3,IEHMVV10              GET ADDR PERM WORKAREA  YL026VC 03030002
         L     A6,IEHMVV23+4            GET ADDR OF VOLUMELIST   A43752 03030421
         TM    IEHMVV20+4,X'08'        MODEL DSCB INDICATOR ON     2695 03032017
         BC    1,NORDJFCB              YES, BYPASS READ OF JFCB    2695 03036017
         CLI   IEHMVV72+11,X'FF'       DID WE COME HERE FROM VSSX  UL0H 03040017
         BE    NORDJFCB                YES, SKIP READ OF JFCB OF   UL0H 03044017
*                                      'TO' VOL. IT HAS NO DCB AND UL0H 03048017
*                                      WAS NEVER OEPNED.           UL0H 03052017
         LA    A1,IEHMVV00+8      ADDR TO READ JFCB INTO                03080000
         ST    A1,IEHMVV00        BUILD EXIT LIST FOR OPEN              03100000
         MVI   IEHMVV00,ALLOW           INDICATES CORE SET FOR EXT LST  03120000
         L     A1,IEHMVV31             ADDR OF TO DCB                   03140000
         LA    A2,IEHMVV00        ADDR OF EXIT LIST                     03160000
         ST    A2,DCBEXLST(A1)          STORE EXIT LIST ADDR INTO DCB   03180000
         LR    A2,A1                                                    03200000
         RDJFCB ((A2))                                                  03210021
NORDJFCB LA    A10,IEHMVV00+8           SET UP ADDRESSABILITY    A43752 03212021
         USING IEFJFCBN,A10             FOR THE JFCB             A43752 03214021
         MVC   IEHMVV82+4(3),JFCBDSL1  MOVE DSCBTTR TO SAVEAREA  S21042 03216002
         TM    IEHMVV20+4,X'02'         VOLUME SWITCH OCCURRED   A43752 03220021
         BO    VOLSWTCH                 YES MORE ENTRIES TO MAKE A43752 03230021
         XC    12(2,A3),12(A3)          NO CLEAR FILE SEQ NBR    A43752 03240021
         MVC   2(10,A3),0(A6)           COPY VOLLIST ENTRY       A43752 03250021
         LA    A4,1                                              A43752 03260021
         STH   A4,0(A3)                 PWA COUNT IS 1           A43752 03270021
         CLI   2(A6),X'20'              TOVOL DA                 A43752 03280021
         BE    TESTBITS                 YES FILE SEQ NBR ZERO    A43752 03290021
         MVC   12(2,A3),JFCBFLSQ        NO GET FILE SEQ NBR      A43752 03300021
         B     CONTIN3                                           A43752 03310021
VOLSWTCH SR    A7,A7                                             A43752 03320021
         SR    A8,A8                                             A43752 03330021
         IC    A8,IEHMVV23              GET NBR OF SWITCHES      A43752 03340021
NEXTVOL  LA    A7,OFFSVL(A7)                                     A43752 03350021
         BCT   A8,NEXTVOL                                        A43752 03360021
         SR    A6,A7                    POINT TO FIRST VOLUME    A43752 03370021
         IC    A8,IEHMVV23              GET NBR OF SWITCHES      A43752 03380021
         LA    A8,1(A8)                 NBR OF VOLUMES USED      A43752 03390021
         STH   A8,0(A3)                 STORE PWA COUNT          A43752 03392021
PWALOOP  MVC   2(10,A3),0(A6)           COPY VOLLIST ENTRY       A43752 03392421
         XC    12(2,A3),12(A3)          CLEAR FILE SEQ NBR       A43752 03392821
         LA    A6,OFFSVL(A6)            BUMP LIST POINTER        A43752 03392921
         LA    A3,12(A3)                BUMP PWA POINTER         A43752 03393021
         BCT   A8,PWALOOP                                        A43752 03395021
         L     A3,IEHMVV10             POINT TO FIRST VOL        A43752 03395421
         CLI   4(A3),X'20'             TO DA                     A43752 03395621
         BE    TESTBITS                YES ALL SEQ NBRS ZERO     A43752 03395821
         MVC   12(2,A3),JFCBFLSQ        GIVE FILE SEQ NBR        A43752 03396021
CONTIN3  TM    JFCBLTYP,X'0A'          UNLABELED TAPE            A43752 03496021
         BNZ   TESTBITS                NO  IT'S SL OR SUL        A43752 03596021
         DROP  A10                                               A43752 03696021
         MVI   IEHMVV74+12,X'FF'  TURN NL TAPE SWITCH ON         A19476 03942018
WORK2    EQU   2                                                        03960000
WORK3    EQU   3                                                        03980000
TESTBITS DS    0H                                                       04000000
         NI    IEHMVV20+4,X'FD'        SET VOLUME SWITCH OFF    A43752  04010021
         BO    PREABORT                   IF SO ---                     04040000
         TM    IEHMVV20+2,MIDABRT       TEST FOR MID ABORT BIT ON       04060000
         BO    MIDMSG                     IF SO ---                     04080000
         TM    IEHMVV20,MCCATLG         TEST FOR M/C CATALOG   @Z40CSJH 04130004
         BO    COPYGRP                    IF SO ---            @Z40CSJH 04132004
         TM    IEHMVV20,MORC            TEST FOR MOVE OR COPY           04140000
         BO    MOVESET                    IF A MOVE OPERATION    Y02918 04160002
         B     COPYSET                    IF NOT ---                    04220000
MIDMSG   NOP   0(0)                                                     04300000
         OI    IEHMVV41+13,X'02'   SET RET CODE = 8                     04320000
         LA    A8,IEHMVV00+1       ******                               04340000
         LA    A15,4                    *                               04360000
         BAL   A14,MSGCLEAR             *                               04380000
         BAL   A14,MSGDS                *    WRITE MESSAGE-             04400000
         LA    A15,16                   *                               04420000
         BAL   A14,MSG                  *       'DS XX NOT M/C'         04440000
         BAL   A2,LINEPR           ******                               04460000
         SR    A15,A15                  *                         19030 04465019
         BAL   A14,MSGVOL               *                         19030 04470019
         BAL   A2,LINEPR           ******                         19030 04475019
         B     MIDABORT                                                 04480000
RETURN   IEHPOST ,TC                                                    04500000
         L     14,12(0,13)             RESTORE FINAL WRAP RETURN        04520000
         TM    IEHMVV20,X'04'          TEST FOR M/C CATALOG             04540000
         BO    WRAPCAT                    IF SO ---                     04560000
         XCTL  (2,12),EP=IEHMVESH       GO TO CONTINUE REST OF GROUP    04580000
WRAPCAT  TM    IEHMVV20+2,X'20'        TEST FOR END OF INPUT            04600000
         BO    END                        IF SO ---                     04620000
         XCTL  (2,12),EP=IEHMVEST         IF NOT --- GO TO SCAN CARDS   04640000
END      XCTL  (2,12),EP=IEHMVESK      GO TO FINAL WRAP UP              04660000
MIDABORT XCTL  EP=IEHMVESO                           - MIDABORT ******* 04680000
PREABORT OI    IEHMVV20+2,EOI           TURN ON END OF INPUT SWITCH     04700000
         B     MIDABORT                                                 04720000
COPYSET  XCTL  EP=IEHMVESP                           - COPY SING DS *** 04740000
MOVESET  XCTL  EP=IEHMVESQ                           - MOVE SING DS *** 04760000
*********************************************************************** 04770004
**       LINES 048100-050192 WERE REACTIVATED IN               @Z40CSJH 04780004
**       SUPPORT OF THE MVS EXTENDED CVOL FUNCTION             @Z40CSJH 04790004
*********************************************************************** 04800004
COPYGRP  NOP   0(0)                                                     04810004
         LA    A8,IEHMVV00+1       ******                               04860004
         LA    A15,8                    *                               04910004
         BAL   A14,MSGCLEAR             *                               04960004
         BAL   A14,MSGDS                *                               05010004
         LA    A15,12                   *    WRITE MESSAGE -            05012004
         BAL   A14,MSG                  *                               05014004
         BAL   A2,LINEPR                *       'DS XX COPIED TO VOL X' 05016004
         SR    A15,A15                  *                               05018004
         BAL   A14,MSGVOL               *                               05018404
         BAL   A2,LINEPR           ******                               05018804
         B     RETURN                                                   05019204
*                                                                       05020000
*********************************************************************   05040000
**                                                                      05060000
**                            MESSAGE MOVER                             05080000
**                                                                      05100000
**       THIS SUBROUTINE IS LINKED TO IN ORDER TO MOVE MESSAGES         05120000
**       FROM THE MESSAGE CSECT TO THE PRINT AREA (IEHMVV00)            05140000
**       THE LINKAGE IS AS FOLLOWS:          A8= LOCATION FOR MSG       05160000
**                                 A14= RETURN ADDR                     05180000
**                       A15= DISPLACEMENT OF ADCON OF CORRECT MSG      05200000
**       WHEN THIS ROUTINE IS DONE A8  WILL POINT ONE SPACE PAST        05220000
**       THE MOVED MESSAGE --- ALL REGISTERS ARE TRANSPARENT            05240000
**       EXCEPT REGISTERS A1 AND A15 -- THE PRINT AREA IS CLEARED       05260000
**       IF THE INSTRUCTION 'MSGCLEAR' IS LINKED TO                     05280000
**                                                                      05300000
*********************************************************************   05320000
*                                                                       05340000
MSGCLEAR MVI   IEHMVV00,BLANK           CLEAR THE PRINT AREA            05360000
         MVC   IEHMVV00+1(120),IEHMVV00                                 05380000
MSG      L     A1,MSGAD                 GET ADDR OF MSG CSECT           05400000
         AR    A1,A15                   ADD DISP OF CORRECT ADCON       05420000
         L     A1,0(A1)                 LOAD ADDR OF MSG-1              05440000
         IC    A15,0(A1)               LOAD LENGTH OF MSG               05460000
         EX    A15,MSGMOVE              EXECUTE MOVE                    05480000
         AR    A8,A15                   CALC ADDR OF END OF MSG         05500000
         LA    A8,2(A8)                BUMP REG TO END OF MSG +1        05520000
         BR    A14                      RETURN                          05540000
MSGMOVE  MVC   0(1,A8),1(A1)           MOVE MSG                         05560000
*                                                                       05580000
*********************************************************************   05600000
**                                                                      05620000
**                            DATA SET NAME MOVER                       05640000
**                                                                      05660000
**       THIS SUBROUTINE IS LINKED TO IN ORDER TO MOVE DATA SET         05680000
**       NAMES INTO A MESSAGE THE LINKAGE IS AS FOLLOWS:                05700000
**                                           A8= LOCATION FOR NAME      05720000
**                                 A14= RETURN ADDR                     05740000
**                       A15= CODE TO DEFINE WHICH DS NAME              05760000
**                             IF A15=0 ---MOVE 'TO' DS NAME            05780000
**                             IF A15= NOT 0 --- MOVE 'FROM' DS NAME    05800000
**       WHEN THIS ROUTINE IS DONE A8 WILL POINT ONE SPACE PAST         05820000
**       THE MOVED NAME                                                 05840000
**                                                                      05860000
*********************************************************************   05880000
*                                                                       05900000
MSGDS    LTR   A15,A15                  TEST FOR A15=0                  05920000
         BZ    TODS                       IF SO BRANCH                  05940000
         L     A15,IEHMVV21             GET ADDR OF 'FROM' DS NAME      05960000
         B     DSMOVE                                                   05980000
TODS     L     A15,IEHMVV21+4           GET ADDR OF 'TO' DS NAME        06000000
DSMOVE   MVC   0(44,A8),0(A15)          MOVE DS NAME TO PRINT AREA      06020000
CHKEND   CLI   0(A8),BLANK              CHECK FOR END OF NAME           06040000
         BE    NAMEEND                    IF REACHED BRANCH ---         06060000
         LA    A8,1(A8)                 BUMP POINTER TO PRINT AREA      06080000
         B     CHKEND                                                   06100000
NAMEEND  LA    A8,1(A8)                 ALLOW FOR SPACE AFTER NAME      06120000
         BR    A14                      RETURN                          06140000
*                                                                       06160000
********************************************************************    06180000
**                                                                      06200000
**                            MESSAGE WRITE CALLER                      06220000
**                                                                      06240000
**       THIS ROUTINE WILL BE LINKED TO WHENEVER A LINE OF OUTPUT       06260000
**       IS TO BE WRITTEN ON 'SYSPRINT' IT WILL HAVE NO PARAMETERS      06280000
**       AND ASSUME THAT THE LINE TO BE WRITTEN IS LOCATED AT IEHMVV00  06300000
**       AFTER THE WRITE IS COMPLETE, CONTROL WILL BE PASSED BACK VIA   06320000
**       A2  UNLESS A PERMINANT I/O ERROR WAS ENCOUNTERED               06340000
**                                                                      06360000
********************************************************************    06380000
*                                                                       06400000
LINEPR   ST    A3,IEHMVV00+128         SAVE REG 3                       06420000
         LA    A3,IEHMVV00             LOAD ADDR OF PRINT AREA          06440000
         LINK EP=IEHMVESU              GO TO MSG WTR                    06460000
         L     A3,IEHMVV00+128                                          06480000
         B     *+4(A15)                 CHECK RETURN CODE               06500000
         B     0(A2)                         =0  OK WRITE               06520000
         IEHPOST ,TC                                                    06540000
         L     14,12(0,13)              RESTORE REG 14                  06560000
         XCTL  (2,12),EP=IEHMVESK                                       06580000
*                                                                       06600000
*********************************************************************   06620000
**                                                                      06640000
**                            VOLUME LIST MOVER                         06660000
**                                                                      06680000
**       THIS ROUTINE IS LINKED TO  IN ORDER TO MOVE A VOLUME LIST      06700000
**       TO THE PRINT AREA PLUS 20 BYTES(IEHMVV00+20)                   06720000
**       THE LINKAGE IS AS FOLLOWS                                      06740000
**                                 A14= RETURN ADDRESS                  06760000
**       THE FORMAT OF THE LIST IS AS FOLLOWS                           06780000
**         FOR DIRECT ACCESS --- 123 7986 A1763 IBM403                  06800000
**         FOR TAPE          --- 24,0001 7987,0007                      06820000
**         FOR UNIT RECORD   --- UNIT RECORD EQUIP -- UNIT = HR         06840000
**                                                                      06860000
**                            A15= CODE TO DEFINE WHICH VOL LIST        06880000
**                                 IF A15=0 --- 'TO' VOL LIST           06900000
**                                 IF A15= NOT ZERO --- 'FROM' VOL LIST 06920000
*********************************************************************   06940000
*                                                                       06960000
MSGVOL   MVI   IEHMVV00,BLANK          CLEAR PRINT AREA                 06980000
         ST    A14,SAVE14               SAVE RETURN ADDR                07000000
         SR    A0,A0                    CLEAR A0                        07020000
         MVC   IEHMVV00+1(120),IEHMVV00                                 07040000
         LTR   A15,A15                  CHECK WHICH LIST TO MOVE        07060000
         BZ    TOVOL                      IF 'TO' LIST ---              07080000
         L     A1,IEHMVV22              LOAD ADDR OF FROM VOL LIST      07100000
         IC    A0,IEHMVV22              LOAD NO OF VOLUMES IN FROM LIST 07120000
         B     MOVEVOL                                                  07140000
TOVOL    L     A1,IEHMVV10             LOAD ADDR OF TO VOL LIST         07160000
         LH    A0,0(A1)                LOAD COUNT OF VOLUMES            07180000
         LA    A1,2(A1)                BUMP PTR TO START OF VOL IDS     07200000
MOVEVOL  TM    2(A1),UNITREC            TEST FOR VOL = UNIT RECORD      07220000
         BO    UNITVOL                    IF SO ---                     07240000
         CLI   IEHMVV74+12,X'FF'  WAS OUTPUT ON NL TAPE          A19476 07260018
         BE    UNITVOL                    IF SO ---                     07280000
         LA    A15,IEHMVV00+20          LOAD ADDR OF PRINT AREA+20      07300000
CHKLIST  MVC   0(6,A15),4(A1)           MOVE VOL ID                     07320000
         LA    A15,6(A15)               BUMP REG PAST VOL ID            07340000
         MVC   DTCRT(2),SEQ(A1)        PICK UP THE                 DT0I 07350018
         LH    A14,DTCRT                    SEQUENCE NUMBER        DT0I 07360018
         LTR   A14,A14                  CHECK IF TAPE                   07380000
         BZ    SETBLNK                    IF NOT TAPE ---               07400000
         MVI   0(A15),COMMA             MOVE COMMA TO VOLUME LIST       07420000
         CVD   A14,IEHMVV00+128         CONVERT TO DEC                  07440000
         UNPK  1(4,A15),IEHMVV00+128(8) UNPACK                          07460000
         OI    4(A15),PLUS              RESET SIGN                      07480000
         LA    A15,5(A15)               BUMP REG PAST SEQ NO            07500000
SETBLNK  LA    A15,1(A15)               LEAVE SPACE IN VOL LIST         07520000
         LA    A1,12(A1)                                                07540000
         BCT   A0,CHKLIST               LOOP IF MORE VOL ID.S           07560000
         L     A14,SAVE14               RESTORE REG A14                 07580000
         BR    A14                      RETURN                          07600000
SAVE14   DS    F                                                        07620000
UNITVOL  L     A15,MSGAD                LOAD ADDR OF MSG CSECT          07640000
         L     A15,0(A15)               LOAD ADDR OF FIRST MSG          07660000
         MVC   IEHMVV00+20(26),1(A15)      MOVE MSG TO PRINT            07680000
         MVI   IEHMVV74+12,X'00'  TURN NL TAPE SWITCH OFF        A19476 07690018
         BR    A14                      RETURN                          07700000
MOVEGRP EQU   MOVESET                               - MOVE DS GROUP **  07720000
MSGAD    DC    A(IEHMVMSN)                                              07721017
*******************************************************************UL0H 07722017
*                                                                  UL0H 07723017
*   U S E R   L A B E L   E X I T   R O U T I N E                  UL0H 07724017
*                                                                  UL0H 07725017
*******************************************************************UL0H 07726017
XXOTLE   DC    X'04'                   OUTPUT TRAILER LABEL        UL0H 07727017
         DC    AL3(OTLR)               ROUTINE EXIT IN DCB EXLST   UL0H 07728017
OTLR     DS    0H                                                  UL0H 07729017
OFFSET1  EQU   OTLR-IEHMVESN                                       UL0H 07730017
         LA    A8,OFFSET1                                          UL0H 07731017
         SR    A15,A8                                              UL0H 07732017
         LR    A9,A15                  RESET ADDRESSABILITY        UL0H 07733017
         CLC   IEHMVV72(4),ALLZEROS    LABELS IN GOTTEN CORE       UL0H 07734017
         BE    IGNORE                  NO, IGNORE LABEL REQUEST    UL0H 07735017
         CLI   IEHMVV72+12,X'00'       LABEL CTR AT ZERO           UL0H 07735517
         BE    RELCORE                 YES, FREE LABEL CORE        UL0H 07736017
         L     A8,0(A1)                LOAD PTR TO CLOSE LBL BUFF  UL0H 07736517
         LTR   A8,A8                   BUFFER ADDRESS ZERO         UL0H 07737017
         BZ    IGNORE                  YES, RETURN TO CLOSE        UL0H 07737517
IOERR    DS    0H                                                  UL0H 07738017
         CLI   8(A1),X'80'             PERM I/O ERR FROM PARM LIST UL0H 07739017
         BNE   PROVIDE                 NO, PROVIDE A LABEL         UL0H 07740017
         OI    IEHMVV74+4,X'FF'         YES, SET FLAG TO OUTPUT    UL0H 07743017
*                                        MSG AFTER OPEN/CLOSE/EOV  UL0H 07746017
         BR    A14                     RETURN TO CLOSE             UL0H 07750017
PROVIDE  DS    0H                                                  UL0H 07751017
         L     A11,IEHMVV72+4          GET ADDR OF CURRENT LBL     UL0H 07752017
         L     A15,0(0,A1)             GET CLOSE LABEL BUFF ADDR   UL0H 07753017
         MVC   0(80,A15),0(A11)        MOVE LABEL TO OUTPUT BUFFER UL0H 07754017
         LA    A11,80(A11)             UPDATE PTR TO NEXT LABEL    UL0H 07755017
         ST    A11,IEHMVV72+4          SAVE ADDRESS                UL0H 07756017
         SR    A11,A11                 REDUCE                      UL0H 07757017
         IC    A11,IEHMVV72+12            USER                     UL0H 07758017
         BCTR  A11,0                         LABEL                 UL0H 07759017
         STC   A11,IEHMVV72+12                  COUNT              UL0H 07760017
         LA    A15,8                   RETURN CODE OF 8 FOR        UL0H 07761017
         BR    14                      ANOTHER LABEL               UL0H 07762017
*                                                                  UL0H 07763017
RELCORE  DS    0H                                                  UL0H 07764017
         L     A11,IEHMVV72            GET ADDR OF GOTTEN CORE     UL0H 07765017
         FREEMAIN  R,LV=640,A=(11)     FREE GOTTEN CORE            UL0H 07766017
         XC    IEHMVV72(8),IEHMVV72    RESET POINTERS              UL0H 07767017
IGNORE   DS    0H                      RETURN CODE OF ZERO TO      UL0H 07768017
         SR    A15,A15                 CLOSE TO IGNORE LABELS      UL0H 07769017
         BR    A14                     RETURN TO CLOSE             UL0H 07770517
*                                                                       07771017
IOERRMSG DS    0H                                                       07771917
         OI    IEHMVV74+4,X'00'         CLEAR I/O ERROR FLAG       UL0H 07772817
         LA    A8,IEHMVV00+1            LOCATION FOR MESSAGE STORE UL0H 07773717
         LA    A15,24                   CONSTANT FOR MESSAGE IN MSNUL0H 07774617
         ST    A14,SAVE14               SAVE REG 14                UL0H 07775517
         BAL   A14,MSGCLEAR             CLEAR AREA, MOVE MSG IN    UL0H 07776417
         L     A14,SAVE14               RESTORE REG 14             UL0H 07777317
         BAL   A2,LINEPR                PUT MESSAGE OUT      IN    UL0H 07778217
         B     ERMSGRET                 RETURN TO INLINE PROCESSINGUL0H 07779117
*                                                                       07780000
*  E Q U A T E S                                                        07800000
*                                                                       07820000
*                                                                       07840000
FROMOP  EQU  X'80'                                               A25571 07850018
UNLOAD   EQU   X'01'                                                    07860000
LOAD     EQU   X'02'                                                    07880000
TAPEOUT  EQU   X'80'                                                    07900000
DSGROUP  EQU   X'10'                                                    07920000
VOLUME   EQU   X'02'                                                    07940000
CVOL     EQU   X'40'                                                    07960000
CVTSTRT  EQU   16                       PTR TO CVT                      07980000
CVTILK2  EQU   40                       PTR TO UCB LOOKUP TABLE         08000000
ALLOW    EQU   X'87'                                                    08020000
UNLBLED  EQU   X'02'                                                    08040000
UNLBLSW  EQU   X'FF'                                                    08060000
PREABRT  EQU   X'01'                                                    08080000
MIDABRT  EQU   X'40'                                                    08100000
MCCATLG  EQU   X'04'                                                    08120000
MORC     EQU   X'80'                                                    08140000
BLANK    EQU   X'40'                                                    08160000
UNLABEL  EQU   X'FF'                                                    08180000
COMMA    EQU   C','                                                     08200000
PLUS     EQU   X'F0'                                                    08220000
DAUCB    EQU   X'20'                                                    08240000
SYSRUCB  EQU   X'02'                                                    08260000
DCBEXLST EQU   36                                                       08280000
EOI      EQU   X'20'                                                    08300000
UNITREC  EQU   X'08'                                                    08320000
USERLABL EQU   X'0A'                                               UL0H 08325017
DEACTIVE EQU   X'00'                                                    08330017
SEQ      EQU   10                                                       08331018
OFFSVL   EQU   17                       VOLUMELIST ENTRYLENGTH   A43752 08331121
UCBSAVE  DS    1H                       UCB ADDR FROM DEB        A43752 08331221
DTCRT    DS    1H                                                       08332018
ALLZEROS DC    F'0'                                                     08335017
PATCH    DS    10F                     PATCH AREA              @Z40CSJH 08337004
         IEHMVV                                                         08340000
         ORG   IEHMVV70                                            UL0H 08346017
         IEHDCBXL                                                  UL0H 08352017
IEFJFCBN DSECT                                                          08360000
         IEFJFCBN                                                       08380000
JFCBDSL1 EQU   JFCBDSNM+53                                       S21042 08390002
IEFUCBOB DSECT                                                          08400000
         IEFUCBOB                                                       08420000
         END                                                            08440000
