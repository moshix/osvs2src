*TITLE B'I                                                            * 00020000
*'IEHMVSRA-IEHMOVE   BPAM/SAM RELOAD'                              2365 00030014
         TITLE 'IEHMVSRA-IEHMOVE   BPAM/SAM RELOAD'                2365 00040014
*                                                                     * 00060000
*                                                                     * 00080000
*FUNCTION/OPERATION:                                                  * 00100000
*   THIS ROUTINE RESTORES DATA SETS WHICH HAVE BEEN 'UNLOAD' TO THEIR * 00120000
*ORIGINAL FORM (BPAM/SAM) AND PLACES THEM UPON THE ALLOCATED DEVICES. * 00140000
*FOR BPAM IF THE INPUT IS A NORMAL RECORD IT IS WRITTEN OUT ON THE    * 00160000
*ALLOCATED DEVICE, IF THE INPUT IS A NOTE LIST THE TTR'S IN IT ARE    * 00180000
*UPDATED TO REFLECT THE NEW LOCATIONS, IF THE INPUT IS A DIRECTORY    * 00200000
*ENTRY ANY TTR'S IN IT ARE UPDATED. FOR BSAM THE INPUT IS WRITTEN OUT * 00220000
*OUT ON THE ALLOCATED DEVICE.                                         * 00240000
*                                                                     * 00260000
*                                                                     * 00280000
*                                                                     * 00300000
*ENTRY POINTS:                                                        * 00320000
*        IEHMVERA - ONLY ENTRY, L  15, A (IEHMVERA) BALR 15,15        * 00340000
*INPUT:                                                               * 00360000
*   RECORDS READ BY IEHMVSRK WHICH HAVE CONTROL INFORMATION APPENDED  * 00380000
*TO THEM AND MAY CONTAIN LOCATION DEPENDENT INFORMATION.              * 00400000
*OUTPUT:                                                              * 00420000
*   INPUT RECORDS WITH CONTROL INFORMATION REMOVED AND LOCATION       * 00440000
*DEPENDENT INFORMATION UPDATED.                                       * 00460000
*EXTERNAL ROUTINES:                                                   * 00480000
*        'IEHMVSRK - BREAD' READS 'UNLOADED DATA SET AND FORMATS THE  * 00500000
*RECORDS WHICH ARE PASSED TO IEHMVSRA.                                * 00520000
*EXITS - NORMAL                                                       * 00540000
*   PRINT MESSAGE, FREEMAIN AND TRANSFER CONTROL TO IEHMVESN WHEN     * 00560000
*THE ENTIRE DATA SET HAS BEEN 'LOADED'.                               * 00580000
*ERRORS:                                                              * 00600000
*   SET ABORT INDICATOR, PRINT MESSAGE, FREEMAIN, AND TRANSFER CONTROL* 00620000
*TO IEHMVESN WHEN ANY ERROR OCCURS.                                   * 00640000
*TABLES/WORK AREAS:                                                   * 00660000
*   TABLE OF MESSAGE TEXTS, VARIABLE SIZE WORK AREA FOR INPUT         * 00680000
*ATTRIBUTES:                                                          * 00700000
*   READ ONLY, REENTRANT, REUSABLE                                    * 00720000
REG0     EQU   0                                                        00740000
REG1     EQU   1                                                        00760000
REG2     EQU   2                                                        00780000
REG3     EQU   3                                                        00800000
REG4     EQU   4                                                        00820000
REG5     EQU   5                                                        00840000
REG6     EQU   6                                                        00860000
REG7     EQU   7                                                        00880000
REG8     EQU   8                                                        00900000
REG9     EQU   9                                                        00920000
REG10    EQU   10                                                       00940000
REG11    EQU   11                                                       00960000
REG12    EQU   12                                                       00980000
REG13    EQU   13                                                       01000000
REG14    EQU   14                                                       01020000
REG15    EQU   15                                                       01040000
         SPACE 2                                                   2365 01050014
***** THIS ROUTINE TRANSFORMS PARTITIONED DATA SETS THAT HAVE BEEN **** 01060000
*****  'UNLOADED'INTO PROPERLY FORMATTED PDS AND 'LOADS' THEM ON   **** 01080000
*****  A SPECIFIED DIRECT ACCESS DEVICE.                           **** 01100000
IEHMVSRA CSECT                                                          01102003
*C015080                                                       @ZA13724 01102499
*A014480-015080                                                @ZA07335 01102604
*D014480-015440                                                @ZA07335 01103204
*A043170-043190                                                @ZA03361 01104003
*C043800                                                       @ZA03361 01106003
         SPACE 2                                                   2365 01110014
*A036831-036833                                                @YA01704 01112602
*D016050-016070                                                @YA01704 01113202
*A016050-016070,036805-036980,083060-083120                     YA01221 01114000
*C014050                                                        YA01221 01116000
*A026200,038800,065350,082800                                    A44326 01120122
* 012920,053600-053800,055240-055280,080100                      A34119 01120421
* 054000-054600                                                  A34119 01120821
* 015610,015700                                                  A37919 01121221
*                                                                A31964 01122020
* 058000,022800,036400                                          PTM3039 01126020
* 12820-12940,55450-55550,67800,68840-68960,75860-72920          A26493 01129020
* 79600,80060-80120,    014000                                   A26493 01132020
* 080000                                                         A26581 01135020
* 044200,044400                                                  PM2166 01138020
*                                                                A22318 01141020
* 015600,016000                                                  00GM0I 01144020
* 014600-015400                                                  A23094 01147020
*2633066400                                                        3606 01150020
         EXTRN IEHMVERK                                                 01153020
         ENTRY IEHMVERA                                                 01160000
IEHMVERA SAVE  (14,12),T,IEHMVSRA-OZ13724                      @ZA13724 01180099
         BALR  REG10,0                                                  01200000
         USING *,REG10                                                  01220000
         USING IEHMVV,REG12                                             01240000
         USING PDSLWORK,REG9                                            01260000
         USING PDSIO,REG8                                               01280000
*****  CHECK FOR VALID RECORD FORMAT AND BLOCKSIZE  *****               01282019
         L     REG3,IEHMVV30+8         COMPARE RECORD FORMATS OF A26493 01284019
         L     REG4,IEHMVV31           FROM DSCB AND TO DCB      A26493 01286019
         CLC   DCBRECFM(1,REG4),DS1RECFM(REG3)                   A26493 01288019
         BNE   PDSLFMT                 NO -- ISSUE MESSAGE       A26493 01290019
         CLC   DCBBLK(2,REG4),DS1BLK(REG3)  BLKSIZE EQU          A34119 01292021
         BNE   PDSLFMT                 NO -- ISSUE MESSAGE       A26493 01294019
***** INITIALIZATION PROCEDURE *****                                    01300000
         SR    REG3,REG3                                                01320000
         L     REG4,IEHMVV31           DCB ADDR                         01340000
         IC    REG3,16(0,REG4)         INSERT KEY LENGTH                01360000
         LA    REG3,6(0,REG3)          LENGTH OF RECORD INFO FIELD      01380000
         LA    REG0,276            BASIC SIZE OF WORKAREA--FOUR YA01221 01405000
*                                    BYTES ADDED IN RLS18 FOR    PM2166 01410018
*                                    STORING TRACK BALANCE.      PM2166 01415018
         TM    26(REG4),X'02'          DSORG=PO                         01420000
         BZ    PDSLIN                  NO                               01440000
         LH    REG2,62(REG4)        INCREASE WORKAREA PDSLWORK @ZA07335 01448004
*                                   BY THE BLKSIZE IN CASE OF  @ZA07335 01478004
         AR    REG0,REG2            NOTELIST RECORDS           @ZA13724 01508099
         AR    REG0,REG3                OF WORKAREA---PDSLWORK.  A23094 01552018
PDSLIN   LR    REG8,REG0               SAVE SIZE OF 'PDSLWORK'   A37919 01554021
         GETMAIN R,LV=(0)                                        A37919 01556021
         LR    REG9,REG1               SAVE WORK AREA ADDR              01580000
         ST    REG8,PDSLSTM1       SAVE SIZE OF 'PDSLWORK'       00GM01 01600018
         TM    IEHMVV20+2,PDSABORT     INVALID LRECL/BLKSIZE?    A34119 01602021
         BO    PDSLFMT2                YES RETURN TO MSGRTN      A34119 01604021
         MVC   PDSTRKBL(2),18(REG4) SAVE INITIAL TRACK BALANCE.  PM2166 01610018
         LA    REG1,PDSNOTE            ADDR OF NOTE LIST AREA           01620000
         AR    REG1,REG3               ADD LGTH OF RECORD INFO AND KEY  01640000
         ST    REG1,PDSLAD3            SAVE ADDR OF NOTE LIST PROPER    01660000
         LH    REG0,62(0,REG4)         BLOCK SIZE                       01680000
         AR    REG0,REG3               TOTAL IO AREA                    01700000
         ST    REG0,PDSLSTM2           SAVE SIZE OF AREA                01720000
         GETMAIN R,LV=(0)              GET STORAGE FOR IO AREA          01740000
         LR    REG8,REG1               ADDR OF MAIN STORAGE ACQUIRED    01760000
         AR    REG1,REG3               ADD LGTH OF RECORD INFO AND KEY  01780000
         MVI   PDSLSW,X'C0'            INITIALIZE INDICATOR             01800000
         IEHPRE (14,1),TF                                               01820000
         MVI   PDSPTR,X'00'                                             01840000
         MVC   PDSPTR+1(11),PDSPTR     CLEAR WORK AREA                  01860000
         L     REG1,IEHMVV31           DCB ADDR                         01880000
         LA    REG3,PDSLSYNX           SYNAD                            01900000
         ST    REG3,PDSLSTR            SAVE SYNAD                       01920000
         MVC   57(3,REG1),PDSLSTR+1    PUT IN DCB                       01940000
***** GET AN UNLOADED RECORD *****                                      01960000
PDSGET   SR    REG0,REG0               ZERO PARAM REGISTER              01980000
         LA    REG1,PDSREC             ADDR OF INPUT AREA               02000000
         L     REG15,ADBREAD           ADDR OF READING RTN              02020000
         BALR  REG14,REG15             GO TO GET RECORD                 02040000
***** ACT ON RETURN CODE FROM BREAD *****                               02060000
         B     PDSLMSG                 GO TO MSG RTN                    02080000
***** END OF INPUT PROCEDURE *****                                      02100000
PDSLEOI  TM    PDSREC+2,X'02'          SEQUENTIAL ACCESS METHOD         02120000
         BO    PDSLEOD                 YES                              02140000
         TM    PDSLSW,X'40'            ENTRY ALREADY STOWED             02160000
         BO    PDSLEOD                 YES                              02180000
         LA    REG11,PDSLEOD           RETURN ADDR FROM MSG RTN         02200000
         B     PDSL26                  GO TO STOW DIRECTORY ENTRY       02220000
***** DETERMINE TYPE OF RECORD *****                                    02240000
PDSLRET  LH    REG2,PDSREC             LENGTH OF RECORD                 02260000
         STH   REG2,IEHMVV10-2                                  PTM3039 02280019
         TM    PDSREC+2,X'22'          PDS MEMBER OR SAM RECORD         02300000
         BM    PDSL1                   YES                              02320000
         TM    PDSREC+2,X'10'          IS THIS A NOTE LIST              02340000
         BO    PDSL2                   YES                              02360000
         TM    PDSREC+2,X'08'          IS THIS A DIRECTORY ENTRY        02380000
         BO    PDSL3                   YES                              02400000
         TM    PDSREC+2,X'04'          DOES THIS INDICATE N L POSITION  02420000
         BO    PDSL4B                  YES                              02440022
         LA    REG15,12(0,0)           RETURN CODE                      02460000
         B     PDSLMSG                 ABORT-NO RECORD TYPE             02480000
***** PROCESS A RECORD WHICH IS A MEMBER OF A PDS *****                 02500000
PDSL1    LA    REG3,PDSREC+6           ADDR OF RECORD                   02520000
         BAL   REG11,PDSL15            GO TO WRITE RECORD               02540000
         TM    PDSREC+2,X'02'          SAM RECORD                       02560000
         BO    PDSGET                  YES                              02580000
         LTR   REG7,REG7               POINTERS IN DIRECTORY ENTRY      02600000
         BH    PDSL11                  YES                              02620000
PDSL13   DS    0H                                                A44326 02630022
         TM    PDSLSW,X'04'            NOTE LIST EXCHANGE        A44326 02632022
         BO    PDSL2E                  YES RETURN                A44326 02634022
         TM    PDSLSW,X'80'            ANY POINTERS IN NOTE LIST        02640022
         BO    PDSGET                  NO                               02660000
PDSL18   DS    0H                                                A44326 02730022
         LR    REG3,REG5               INIT SCAN CNTR            A44326 02780022
         L     REG4,PDSLAD3            GET NL ADDR               A44326 02830022
PDSL18A  DS    0H                                                A44326 02880022
         TM    0(REG4),X'80'           TTR UPDATED               A44326 02930022
         BO    PDSL18D                 YES GET NEXT TTRX         A44326 02980022
         CLI   2(REG4),X'00'           TTRX ZERO                 A44326 03030022
         BE    PDSL18B                 YES FLAG THIS TTR         A44326 03032022
         CLC   PDSREC+3(3),0(REG4)     TTR'S EQUAL               A44326 03034022
         BNE   PDSL18C                 NO GET NEXT TTRX          A44326 03036022
         BAL   REG11,PDSL12            YES NOTE THIS TTR         A44326 03038022
         IC    REG1,3(0,REG4)          ZERO LAST BYTE            A44326 03038422
         ST    REG1,PDSLSTR            SAVE NEW PTR              A44326 03038822
         MVC   0(4,REG4),PDSLSTR       UPDATE TTRX               A44326 03039222
PDSL18B  DS    0H                                                A44326 03039622
         OI    0(REG4),X'80'           FLAG THIS TTRX            A44326 03039722
         BCT   REG5,PDSL18C            GET NEXT TTR IF ANY       A44326 03039822
         L     REG4,PDSLAD3            GO TO BEGIN OF NL         A44326 03039922
PDSL18E  DS    0H                                                A44326 03043222
         NI    0(REG4),X'7F'           RESTORE TTRX              A44326 03045222
         LA    REG4,4(REG4)            JUMP TO NEXT TTRX         A44326 03045622
         BCT   REG6,PDSL18E            IF ANY                    A44326 03046022
         OI    PDSLSW,X'80'            INDIC NL UPDATED          A44326 03046422
         B     PDSGET                  GET NEXT RECORD           A44326 03046522
PDSL18C  DS    0H                                                A44326 03046622
         BCT   REG3,PDSL18D            GET NEXT TTR IF ANY       A44326 03049922
         B     PDSGET                  GET NEXT RECORD           A44326 03051922
PDSL18D  DS    0H                                                A44326 03052322
         LA    REG4,4(REG4)            JUMP TO NEXT TTRX         A44326 03052722
         B     PDSL18A                 AND CHECK IT              A44326 03053122
***** PROCESS A RECORD WHICH IS A NOTE LIST *****                       03053422
PDSL2    DS    0H                                                A44326 03056722
         TM    PDSLSW,X'08'            NOTE LIST IN CORE         A44326 03060022
         BNO   PDSL2C                  NO CONTINUE               A44326 03070022
         MVC   PDSNTTR(3),PDSREC+3     YES SAVE NEW NL TTR       A44326 03080022
         OI    PDSLSW,X'04'            SET RET SW                A44326 03082022
         B     PDSL4                   WRITE OLD NL FIRST        A44326 03084022
PDSL2E   DS    0H                                                A44326 03088822
         NI    PDSLSW,X'FB'            RESET EXCH SWITCH         A44326 03089222
         MVC   PDSREC+3(3),PDSNTTR     RESTORE NEW NL TTR        A44326 03089622
PDSL2C   DS    0H                                                A44326 03089722
         OI    PDSLSW,X'08'            INDIC NOTE LIST IN CORE   A44326 03089822
         L     REG1,IEHMVV31           DCB ADDR                  A44326 03090022
         NI    PDSLSW,X'7F'            CLEAR INDICATOR           A44326 03140022
         LH    REG5,PDSPTRNO           ORG NBR TTRN'S            A44326 03190022
         LA   REG11,PDSDIR+12                                    A44326 03200022
FINDN    CLC   0(3,REG11),PDSREC+3     TTRN FOUND                A44326 03210022
         BE    TTRNFND                 YES SAVE BYTE N           A44326 03212022
         LA    REG11,4(REG11)          NO GO TO NEXT TTRN        A44326 03214022
         BCT   REG5,FINDN              IF ANY                    A44326 03216022
TTRNFND  DS    0H                                                A44326 03218022
        IC     REG5,3(REG11)           SAVE NBR OF POINTERS      A44326 03218422
         LH    REG2,PDSREC             GET RECORD LENGTH         A44326 03218522
         LA    REG2,6(0,REG2)          ADD 6 TO GET FULL RECORD LENGTH  03218822
         LA    REG0,256(0,0)           PUT 256 IN REG 0                 03220000
         LA    REG1,PDSNOTE            ADDR OF NOTE LIST AREA           03240000
         LA    REG3,PDSREC             ADDR OF RECORD                   03260000
PDSL2A   CLR   REG2,REG0               LENGTH GREATER THAN 256          03280000
         BNH   PDSL2B                  NO                               03300000
         MVC   0(256,REG1),0(REG3)     MOVE MOVE NEXT 256 BYTES OF REC  03320000
         AR    REG3,REG0               INCREASE ADDR BY 256             03340000
         SR    REG2,REG0               DECREASE LGTH BY 256             03360000
         AR    REG1,REG0     INCREASE ADDRESS BY 256               3606 03370016
         B     PDSL2A                                                   03380000
PDSL2B   BCTR  REG2,0                  SUBTRACT 1 FROM LGTH             03400000
         EX    REG2,PDSL10             HAVE RECORD MOVED                03420000
         LR    REG6,REG5               SAVE NBR OF TTRX'S        A44326 03450022
         L     REG1,PDSLAD3            START OF NL               A52050 03453022
MAKEZERO DS    0H                                                A52050 03456022
         NI    0(REG1),X'7F'           CLEAR FIRST BIT           A52050 03459022
         LA    REG1,4(REG1)            POINT TO NEXT NOTE        A52050 03459622
         BCT   REG6,MAKEZERO           IF ANY                    A52050 03459722
         LR    REG6,REG5               SAVE NBR OF TTRX'S        A52050 03459822
         B     PDSGET                  GET ANOTHER RECORD               03460000
***** PROCESS A RECORD WHICH IS A DIRECTORY ENTRY *****                 03480000
PDSL3    MVC   IEHMVV00(74),PDSREC+6   SAVE DIRECTORY ENTRY             03500000
         TM    PDSLSW,X'40'            DIRECTORY ENTRY ALREADY STOWED   03520000
         BO    PDSL3A                  YES                              03540000
         BAL   REG11,PDSL26            GO TO STOW DIRECTORY ENTRY       03560000
PDSL3A   NI    PDSLSW,X'BF'            INDICATE NOT FIRST ENTRY         03580000
         TM    PDSREC+17,X'80'         IS THIS AN ALIAS ENTRY           03600000
         BO    PDSL7                   YES                              03620000
         LH    REG2,IEHMVV10-2                                  PTM3039 03640019
         BCTR  REG2,0                  SUBTRACT 1 FROM LGTH             03660000
         EX    REG2,PDSL6              HAVE RECORD MOVED                03680000
         TM    IEHMVV20+3,X'08'        PREALLOCATION            YA01221 03680500
         BZ    PDSL3B                  NO CONTINUE              YA01221 03681000
*  THIS ROUTINE WILL CHECK THE OUTPUT DATA SET'S DIRECTORY      YA01221 03681500
*  TO SEE WHETHER THE MEMBER ALREADY EXISTS                     YA01221 03682000
*  IN SUCH A CASE THE MEMBER WILL BE SKIPPED                    YA01221 03682500
         MVC   BLDLIST+4(8),PDSDIR     GET THE NAME             YA01221 03683000
         XC    BLDLIST(4),BLDLIST      CLEAR THE FIELD         @YA01704 03683102
         MVI   BLDLIST+1,X'01'         INDIC ONE ENTRY         @YA01704 03683202
         MVI   BLDLIST+3,X'0E'         LENGTH OF THE ENTRY     @YA01704 03683302
         L     REG7,IEHMVV31           ADDR OUTPUT DCB          YA01221 03683500
         BLDL  (REG7),BLDLIST                                   YA01221 03684000
         LTR   REG15,REG15             DUPLICATE NAME           YA01221 03684500
         BNZ   PDSL3B                  NO CONTINUE              YA01221 03685000
PDSL3C   DS    0H                      YES SKIP THE FILE        YA01221 03685500
         SR    REG0,REG0               INDIC: NOT FIRST ENTRY   YA01221 03686000
         LA    REG1,PDSREC             ADDR INPUT AREA          YA01221 03686500
         L     REG15,ADBREAD           ADDR OF READER           YA01221 03687000
         BALR  REG14,REG15             GO TO READ               YA01221 03687500
         B     PDSL3D(REG15)           USE THE BRANCH TABLE     YA01221 03688000
PDSL3D   DS    0H                                               YA01221 03688500
         B     PDSL3E                  RC=0  CHECK THE RECORD   YA01221 03689000
         B     PDSL3F                  RC=4  END OF FILE        YA01221 03689500
         B     PDSLMSG                 RC=8  ERROR              YA01221 03690000
         B     PDSLMSG                 RC=12 ERROR              YA01221 03690500
PDSL3E   DS    0H                      CHECK THE RECORD         YA01221 03691000
         TM    PDSREC+2,X'08'          NEW MEMBER               YA01221 03691500
         BZ    PDSL3C                  NO SKIP ANOTHER RECORD   YA01221 03692000
         LA    REG15,20                CODE FOR MSG IEH319I     YA01221 03692500
         BAL   REG11,PDSLMSG           INDIC DUP MEMBER FOUND   YA01221 03693000
         OI    PDSLSW,X'40'            SKIP THE STOW            YA01221 03693500
         B     PDSL3                   PROCESS NEXT MEMBER      YA01221 03694000
PDSL3F   DS    0H                      END OF DATA              YA01221 03694500
         LA    REG15,20                CODE FOR MSG IEH319I     YA01221 03695000
         BAL   REG11,PDSLMSG           INDIC DUP MEMBER FOUND   YA01221 03695500
         L     REG7,IEHMVV31           ADDR OUTPUT DCB          YA01221 03696000
         OI    48(REG7),X'80'          INDIC LAST OPERATION     YA01221 03696500
*  WAS A WRITE TO HAVE THE TTRLL FIELD OF THE LABEL UPDATED     YA01221 03697000
         B     PDSLEOD                 GO TO TERMINATION        YA01221 03697500
PDSL3B   DS    0H                      CONTINUE PROCESSING      YA01221 03698000
         SR    REG7,REG7                                                03700000
         IC    REG7,PDSDIR+11          'C' BYTE FROM DIRECTORY ENTRY    03720000
         SRL   REG7,5                  NUMBER OF POINTERS PUT IN LOW    03740000
*                                        ORDER END OF REGISTER          03760000
         STH   REG7,PDSPTRNO           NUMBER OF POINTERS               03780000
         B     PDSGET                  GET ANOTHER RECORD               03800000
***** PUT OUT A NOTE LIST AND UPDATE POINTER IN DIRECTORY ENTRY *****   03820000
PDSL4B   DS    0H                                                A44326 03830022
         NI    PDSLSW,X'F7'            CLEAR NL IN CORE INDIC    A44326 03840022
PDSL4    DS    0H                                                A44326 03870022
         TM    PDSLSW,X'80'            ALL TTRX'S UPDATED        A44326 03890022
         BO    PDSL4A                  YES CONTINUE              A44326 03892022
         B     BADNOTE                 NO WRITE WARNING MSG      A44326 03894022
PDSL4A   DS    0H                                                A44326 03896022
         LA    REG3,PDSNOTE+6          ADDR OF RECORD                   03898022
         LH    REG2,PDSNOTE            LENGTH OF NOTE LIST              03898422
         MVC   PDSREC+3(3),PDSNOTE+3   SAVE TTR OF NOTE LIST            03898822
         LA    REG11,PDSL11            ADDR OF UPDATE RTN               03900000
         B     PDSL15                  GO TO WRITE NOTE LIST            03920000
***** PROCESS AN ALIAS DIRECTORY ENTRY *****                            03940000
PDSL7    MVC   IEHMVV00+8(3),PDSDIR+8  PUT TTR OF MEMBER IN ENTRY       03960000
         CLI   PDSPTRNO+1,X'00'        ANY POINTERS IN DIRECTORY        03980000
         BE    PDSL7A                  NO                               04000000
         LH    REG1,PDSPTRNO           NUMBER OF POINTERS               04020000
         SLL   REG1,2                  MULT BY 4 TO GET LGTH OF UPDATE  04040000
         BCTR  REG1,0                  SUBTRACT 1 FROM LGTH             04060000
         EX    REG1,PDSL21             HAVE POINTERS UPDATED            04080000
PDSL7A   OI    PDSLSW,X'40'            INDICATE ENTRY STOWED            04100000
         LA    REG11,PDSGET            RETURN ADDR FROM STOW            04120000
         LA    REG2,IEHMVV00           ADDR OF DIRECTORY ENTRY          04140000
         MVC   PDSDIR(8),IEHMVV00      PUT ALIAS NAME IN DIRECTORY      04160000
PDSL8    L     REG1,IEHMVV31                                       2365 04210014
         LA    REG1,0(0,REG1)          CLEAR HIGH ORDER BYTE            04260000
         STOW  (1),(2),A               PUT OUT DIRECTORY ENTRY          04280000
*****  ACT ON RETURN CODE FROM STOW  *****                              04287018
         LA    REG3,4              TO TEST FOR DUP NAME.         A22318 04294018
         CLR   REG15,REG3          IS RET CODE 4 (DUP NAME) ?    A22318 04301018
         BNE   NOTDUP              NO.                           A22318 04308018
*                                  YES. DUP MEMBER NAME IN TO DS A22318 04315018
         TM    IEHMVV20+3,X'08'        PREALLOCATED            @ZA03361 04317003
         BO    PRE                     YES BRANCH AROUND       @ZA03361 04319003
         L     REG1,IEHMVV31       'TO' DCB ADDR                 22318  04322018
         MVC   0(3,REG1),PDSDIR+8  SET RELAD FIELD IN TO DCB.    A22318 04329018
         MVI   PDSDIR+11,X'00'     ZERO 'C' BYTE OF STOW LIST    A22318 04336018
*                                     AND USE TTR RETURNED       A22318 04343018
*                                     BY STOW FOR BLOCK ADDR     A22318 04350018
*                                     IN POINT. POINT TO         A22318 04357018
*                                     RECOVER SPACE WHERE        A22318 04364018
*                                     DUP MEMBER WRITTEN.        A22318 04371018
         LA    REG0,PDSDIR+8       POINT R0 TO STOW LIST TTR.    A22318 04378018
         POINT (1),(0)             RECOVER DUP NAME SPACE.       A22318 04379018
PRE      L     REG1,IEHMVV31                                   @ZA03361 04380003
         MVC   18(2,REG1),PDSTRKBL RESTORE TRACK BALANCE STORED  PM2166 04381018
*                                    FROM LAST SUCCESSFUL STOW   PM2166 04382018
         OI    48(REG1),X'80'      SET DCBOFLGS TO INDICATE LAST PM2166 04383018
*                                    I/O OPERATION WAS A WRITE.  PM2166 04384018
*                                    THIS WILL FORCE A MERGE TO  PM2166 04385018
*                                    THE DSCB AT CLOSE TIME IF   PM2166 04386018
*                                    LAST MEMBER IS A DUP.       PM2166 04387018
         LR    REG15,REG3          RESTORE STOW RET CODE         A22318 04392018
         B     STOWRCDE            GO TEST STOW RET CODE         PM2166 04395018
NOTDUP   L     REG1,IEHMVV31       'TO' DCB ADDR.                PM2166 04397018
         MVC   PDSTRKBL(2),18(REG1) SAVE TRACK BALANCE AFTER     PM2166 04399018
*                                    SUCCESSFUL STOW.            PM2166 04401018
STOWRCDE LA    REG15,16(REG15)     ADD 16 TO STOW RET CODE.      PM2166 04403018
******************************************************************21919 04403121
*                                                                *21919 04403221
*   THE RETURN CODES X'14',X'18' AND X'1C' OF THE STOW MACRO     *21919 04403321
*   GIVE THE MESSAGE:                                            *21919 04403421
*         IEH326I I/O ERROR ENCOUNTERED IN OUTPUT DATA SET       *21919 04403521
*   THIS MESSAGE IS THE GOOD ONE FOR RETURN CODE X'10'           *21919 04403621
*   THE ABOVE MENTIONED RETURN CODES ARE CAUSED BY               *21919 04403721
*   X'14' I/O REQUESTS AGAINST THE SAME DCB ARE STILL            *21919 04403821
*   OUTSTANDING                                                  *21919 04403921
*   X'18' THE DCB IS NOT OPEN                                    *21919 04404021
*   X'1C' CONDITIONAL GETMAIN WITHIN STOW WAS UNSUCCESSFUL       *21919 04404121
*                                                                *21919 04404221
******************************************************************21919 04404321
         CL    REG15,PDSMAXCD     INVALID RETURN CODE?                  04404421
         BH    PDSLABT            YES, GO AND ABORT JOB           21919 04404521
         LA    REG0,32            IN REG0 SAME CONTENTS AS IN     21919 04404621
*                                 REG15 IN CASE OF I/O ERROR      21919 04404721
         CR    REG15,REG0         NEW OR OLD RETURN CODE?         21919 04404821
         BNH   PDSLMSG            OLD RETURN CODE, THEN BRANCH    21919 04404921
         LR    REG15,REG0         NOW R15 INDICATES I/O ERROR     21919 04405021
         B     PDSLMSG             GO TO ACT ON STOW R. C.       A22318 04406018
***** COMPARE TTR OF MEMBER RECORD JUST READ WITH POINTERS IN *****     04460000
*****  DIRECTORY ENTRY. IF DIRECTORY ENTRY POINTS TO THIS     *****     04480000
*****  RECORD UPDATE THE POINTER TO NEW TTR.                  *****     04500000
PDSL11   LA    REG4,PDSDIR+12          ADDR OF POINTERS                 04520000
         LH    REG3,PDSPTRNO           NUMBER OF POINTERS               04540000
         SR    REG2,REG2                                                04560000
PDSL11A  CLC   PDSREC+3(3),0(REG4)     COMPARE TTR TO POINTER           04580000
         BE    PDSL16                                                   04600000
         LA    REG4,4(0,REG4)          ADDR OF NEXT POINTER             04620000
         LA    REG2,4(0,REG2)          DISPLACEMENT OF POINTER          04640000
         BCT   REG3,PDSL11A            COUNT POINTERS COMPARED          04660000
         B     PDSL13                  IF ALL POINTERS COMPARED         04680000
***** UPDATE POINTER IN DIRECTORY ENTRY *****                           04700000
PDSL16   BAL   REG11,PDSL12            GO TO GET TTR OF RECORD WRITTEN  04720000
         IC    REG1,3(0,REG4)          4TH BYTE OF POINTER              04740000
         ST    REG1,PDSPTR(REG2)       SAVE UPDATED POINTER             04760000
         BCTR  REG7,0                  COUNT POINTER                    04780000
         B     PDSL13                                                   04800000
***** WRITE A MEMBER OR A NOTE LIST *****                               04820000
PDSL15   STM   REG4,REG5,IEHMVV00      SAVE REGISTERS                   04840000
         L     REG4,IEHMVV31+4         DECB ADDR                        04860000
         SR    REG0,REG0                                                04880000
         L     REG1,IEHMVV31           DCB ADDR                         04900000
         IC    REG0,16(0,REG1)         INSERT KEY LENGTH                04920000
         SR    REG2,REG0               SUBTRACT KEY LENGTH              04940000
         L     REG5,IEHMVV31           DCB ADDR                         04960000
         LA    REG4,0(0,REG4)          CLEAR HIGH                       04980000
         LA    REG5,0(0,REG5)           ORDER BYTE                      05000000
         STH   REG2,62(0,REG1)         PUT COUNT IN DCB BLKSIZE    6778 05020000
         WRITE (REG4),SF,(REG5),(REG3),(REG2),MF=E                      05040000
         L     REG1,IEHMVV31+4         DECB ADDR                        05060000
         LA    REG1,0(0,REG1)          CLEAR HIGH ORDER BYTE            05080000
         CHECK (1)                                                      05100000
         LM    REG4,REG5,IEHMVV00      RESTORE REGISTERS                05120000
         BR    REG11                                                    05140000
***** GET TTR OF RECORD JUST WRITTEN                                    05160000
PDSL12   L     REG1,IEHMVV31           DCB ADDR                         05180000
         LA    REG1,0(0,REG1)          CLEAR HIGH ORDER BYTE            05200000
         NOTE  (1)                     GET TTR OF RECORD JUST WRITTEN   05220000
         BR    REG11                                                    05240000
PDSLABT  OI    IEHMVV20+2,PDSABORT     INDICATE ABORTION                05260000
***** END OF LOAD PROCEDURE **                                          05280000
PDSLEOD  L     REG0,PDSLSTM2                                     A26943 05310019
         FREEMAIN R,LV=(0),A=(8)                                        05340000
         L     REG1,IEHMVV30     LOAD DCB-ADDRESS                A34119 05400021
         L     REG7,IEHMVV30+4   LOAD DECB-ADDRESS               A34119 05410021
         LH    REG0,62(REG1)     LOAD CORE LEN                   A34119 05420021
         L     REG7,12(REG7)     LOAD CORE-ADDR.                 A34119 05430021
         FREEMAIN R,LV=(0),A=(7)                                        05480000
FREEM440 L     REG0,PDSLSTM1                                     A34119 05482021
         FREEMAIN  R,LV=(0),A=(9)                                A34119 05484021
PDSLPOST IEHPOST  ,T                                             A26493 05490019
         L     REG14,12(0,REG13)       RESTORE REG14                    05500000
         XCTL  (2,12),EP=IEHMVESN                                       05520000
*****  INVALID RECORD FORMAT OR BLOCKSIZE  *****                        05522019
PDSLFMT  LA    REG0,252                SPACE FOR MSG             A34119 05524021
         LR    REG8,REG0               SAVE THE SPACE            A34119 05526021
         OI    IEHMVV20+2,PDSABORT     INDICATE ABORTION         A34119 05528021
         B     PDSLIN                  GETMAIN MSGAREA           A34119 05528421
PDSLFMT2 LA    REG15,36                INDICATE MSG              A34119 05528821
         LA    REG11,FREEM440          RETURN ADDRESS            A34119 05529221
         IEHPRE                                                         05530019
         B     PDSLMSG                                           A26493 05532019
***** I/O ERROR EXIT ROUTINE *****                                      05540000
PDSLSYNX LA    REG15,32(0,0)           RETURN CODE                      05560000
         B     PDSLMSG                 GO TO MSG RTN                    05580000
***** INTERPRET RETURN CODE *****                                       05600000
PDSLMSG  CL    REG15,PDSMAXCD          CODE VALID                       05620000
         BH    PDSLABT                 NO                               05640000
         L     REG3,PDSLTAB1(REG15)    ACCESS TABLE USING RETURN CODE   05660000
         LA    REG15,PDSLTAB1(REG15)   ADDR OF ACTION CODE              05680000
         TM    0(REG15),X'03'          ACTION CODE-WRITE MESSAGE        05700000
         BZ    0(0,REG3)               NO, GO TO ADDR TAKEN FROM TABLE  05720000
         BO    PDSLMSGA                GO TO WRITE MSG THEN CONTINUE    05740000
         OI    IEHMVV20+2,PDSABORT     INDICATE ABORTION                05760000
         LA    REG11,PDSLEOD           EXIT ADDR                        05780000
PDSLMSGA MVI   PDSMSGAR,X'40'          CLEAR                    PTM3039 05800019
         MVC   PDSMSGAR+1(120),PDSMSGAR MSG AREA                        05820000
***** GENERATE MESSAGE *****                                            05840000
         SR    REG2,REG2                                                05860000
         IC    REG2,0(0,REG3)          GET MSG LENGTH                   05880000
         LA    REG1,PDSMSGAR+1         ADDR OF MSG AREA                 05900000
         EX    REG2,PDSLMOV            PUT MSG IN OUTPUT AREA           05920000
         TM    0(REG15),X'80'          ACTION CODE-PUT NAME IN MESSAGE  05940000
         BZ    PDSLMSGD                NO                               05960000
         LA    REG1,2(REG2,REG1)       ADDR WHERE NEXT SEGMENT PLACED   05980000
         LA    REG3,2(REG2,REG3)       ADDR OF NEXT MSG SEGMENT         06000000
         IC    REG2,0(0,REG3)          GET MSG LENGTH                   06020000
         EX    REG2,PDSLMOV            PUT SEGMENT IN MSG AREA          06040000
         LA    REG1,2(REG2,REG1)       ADDR WHERE NAME PLACED           06060000
         TM    0(REG15),X'40'          ACTION CODE-USE DATA SET NAME    06080000
         BO    PDSLMSGB                YES                              06100000
         MVC   0(8,REG1),PDSDIR        PUT MEMBER NAME IN MSG           06120000
         LA    REG1,9(0,REG1)          ADDR WHERE NEXT SEGMENT PLACED   06140000
         B     PDSLMSGC                                                 06160000
PDSLMSGB L     REG15,IEHMVV21          ADDR OF DATA SET NAME            06180000
         MVC   0(44,REG1),0(REG15)     PUT DS NAME IN MSG               06200000
         LA    REG1,45(0,REG1)         ADDR WHERE NEXT SEGMENT PLACED   06220000
PDSLMSGC LA    REG3,2(REG2,REG3)       ADDR OF NEXT MSG SEGMENT         06240000
         IC    REG2,0(0,REG3)          GET MSG LENGTH                   06260000
         EX    REG2,PDSLMOV            PUT SEGMENT IN MSG AREA          06280000
PDSLMSGD LA    REG3,PDSMSGAR           ADDR OF MSG OUTPUT AREA          06300000
         LINK  EP=IEHMVESU             GO TO MSG WRITER                 06320000
         LTR   REG15,REG15             MSG WRITTEN                      06340000
         BNE   PDSLABT                 NO                               06360000
         BR    REG11                                                    06380000
PDSL26   LA    REG2,PDSDIR             ADDR OF DIRECTORY ENTRY          06400000
         CLI   PDSPTRNO+1,X'00'        ANY POINTERS IN DIR ENTRY        06420000
         BE    PDSL8                   NO                               06440000
CKTTRN   LTR   REG7,REG7           HAVE ALL DIRECTORY TTRNS BEEN A31964 06460020
*                                      UPDATED ?                 A31964 06465020
         BNZ   BADTTRN             NO.                           A31964 06470020
TTRNS    LH    REG1,PDSPTRNO       NO OF POINTERS TO UPDATE.     A31964 06475020
         SLL   REG1,2                  MULT BY 4 TO GET LGTH OF UPDATE  06480000
         BCTR  REG1,0                  SUBTRACT 1 FROM LGTH             06500000
         EX    REG1,PDSL27         HAVE POINTERS UPDATED.        A31964 06510020
         LA    REG2,PDSDIR         ADDR OF DIRECTORY ENTRY       A31964 06520020
         B     PDSL8                                             A31964 06530020
BADNOTE  LA    REG15,40            IEH328I NOTELIST TTR BAD.     A31964 06531020
         L     REG3,PDSLTAB1(REG15)   ADDR OF IEH328I.           A31964 06532020
         LA    REG15,PDSLTAB1(REG15) POINT TO ACTION CODE X'03'  A31964 06533020
         BAL   REG11,PDSLMSGA      HAVE MESSAGE PRINTED.         A31964 06535020
         OI    PDSLSW,X'80'            CLEAR THE SWITCH          A44326 06537022
         L     REG11,PDSLAD3           FIND BEGIN OF NL          A44326 06537422
BADNOTE1 DS    0H                                                A44326 06537822
         NI    0(REG11),X'7F'          CLEAR TTRX FLAG           A44326 06538222
         LA    REG11,4(REG11)          GO TO NEXT TTRX           A44326 06538622
         BCT   REG6,BADNOTE1           IF ANY                    A44326 06538722
         B     PDSL4A                  RETURN                    A44326 06538822
BADTTRN  LA    REG15,44            IEH327I BAD TTRN.             A31964 06539020
         L     REG3,PDSLTAB1(REG15)  ADDR OF IEH327I.            A31964 06540020
         LA    REG15,PDSLTAB1(REG15) POINT TO ACTION CODE X'03'  A31964 06541020
         LR    REG4,REG11         SAVE RETURN ADDRESS                   06542020
         BAL   REG11,PDSLMSGA        HAVE MESSAGE PRINTED.       A31964 06543020
         LR    REG11,REG4         RESTORE RETURN ADDRESS                06544020
         B     TTRNS               UPDATE DIRECTORY TTRNS.       A31964 06545020
***** ADDRESS CONSTANTS *****                                           06560000
ADBREAD  DC    V(IEHMVERK)                                              06580000
***** OPERATIONS TO BE PERFORMED THRU THE EXECUTE INSTRUCTION *****     06600000
PDSL6    MVC   PDSDIR(1),IEHMVV00      SAVE DIRECTORY ENTRY             06620000
PDSL10   MVC   0(1,REG1),0(REG3)       SAVE NOTE LIST              3606 06640016
PDSL21   MVC   IEHMVV00+12(1),PDSDIR+12 UPDATE POINTERS IN ALIAS ENTRY  06660000
PDSL27   MVC   PDSDIR+12(1),PDSPTR     UPDATE POINTERS IN DIRECTORY     06680000
PDSLMOV  MVC   0(1,REG1),1(REG3)       PUT MSG IN OUTPUT AREA           06700000
***** CONSTANTS *****                                                   06720000
PDSLK4   DC    H'4'                                                     06740000
PDSLK8   DC    H'8'                                                     06760000
PDSMAXCD DC    F'44'                                             A31964 06780020
         DS    0F                                                       06800000
PDSLMSK1 DC    X'01000000'                                              06820000
PDSALIAS DC    CL7'(ALIAS)'                                             06840000
PDSLK12  DC    H'12'                                                    06860000
PDSABORT EQU   X'40'                                                    06880000
DCBRECFM EQU   36                                                A26493 06884019
DS1RECFM EQU   84                                                A26493 06888019
DCBBLK   EQU   62                                                A26493 06892019
DS1BLK   EQU   86                                                A26493 06896019
***** TABLE OF MESSAGE ADDRESSES, ROUTINE ADDRESSES AND ACTION CODES ** 06900000
PDSLTAB1 DS    0F                                                       06920000
         DC    AL1(0)                  INPUT RECORD READ                06940000
         DC    AL3(PDSLRET)                                             06960000
         DC    AL1(0)                  END OF INPUT                     06980000
         DC    AL3(PDSLEOI)                                             07000000
         DC    AL1(1)                  I/O ERROR ON INPUT               07020000
         DC    AL3(M389)                                                07040000
         DC    X'C1'                   NOT UNLOADED FORMAT              07060000
         DC    AL3(M313)                                                07080000
         DC    X'83'                   MEMBER LOADED                    07100000
         DC    AL3(MCOP)                                                07120000
         DC    X'83'        DUP NAME                                    07140000
         DC    AL3(M319)                                                07160000
         DC    AL1(0)                  INVALID CODE                     07180000
         DC    AL3(PDSLABT)                                             07200000
         DC    X'81'                   NO SPACE IN DIRECTORY            07220000
         DC    AL3(M321)                                                07240000
         DC    AL1(1)                  I/O ERROR ON OUTPUT              07260000
         DC    AL3(M326)                                                07280000
         DC    X'03'                   INVALID RECFM OR BLKSIZE  A26493 07286019
         DC    AL3(M440)                                         A26493 07292019
         DC    X'03'               CODE=40  MESSAGE=IEH328I      A31964 07293020
         DC    AL3(M441)                                         A31964 07294020
         DC    X'03'               CODE=44  MESSAGE=IEH327I      A31964 07295020
         DC    AL3(M442)                                         A31964 07296020
***** TABLE OF MESSAGE SEGMENTS. EACH SEGMENT IS PRECEDED BY ITS LENGTH 07300000
MSGTAB   CSECT                                                          07320000
M313     DC    AL1(6)                                                   07340000
         DC    CL7'IEH313I'                                             07360000
M313A    DC    AL1(M313B-M313A-2)                                       07380000
         DC    CL8'DATA SET'                                            07400000
M313B    DC    AL1(M319-M313B-2)                                        07420000
         DC    CL32'HAS INCORRECT FORMAT FOR UNLOADE'                   07440000
         DC    CL11'D DATA SET.'                                        07460000
M319     DC    AL1(6)                                                   07480000
         DC    CL7'IEH319I'                                             07500000
M319A    DC    AL1(M319B-M319A-2)                                       07520000
         DC    CL6'MEMBER'                                              07540000
M319B    DC    AL1(M321-M319B-2)                                        07560000
         DC    CL32'NOT MOVED/COPIED. DUPLICATE NAME'                   07580000
         DC    CL20' IN OUTPUT DATA SET.'                               07600000
M321     DC    AL1(6)                                                   07620000
         DC    CL7'IEH321I'                                             07640000
M321A    DC    AL1(M321B-M321A-2)                                       07660000
         DC    CL6'MEMBER'                                              07680000
M321B    DC    AL1(M326-M321B-2)                                        07700000
         DC    CL32'NOT MOVED/COPIED. OUTPUT DIRECTO'                   07720000
         DC    CL11'RY IS FULL.'                                        07740000
M326     DC    AL1(MCOP-M326-2)                                         07760000
         DC    CL32'IEH326I I/O ERROR ENCOUNTERED IN'                   07780000
         DC    CL18' OUTPUT DATA SET.'                                  07800000
MCOP     DC    X'0000'                                                  07820000
MCOPA    DC    AL1(MCOPB-MCOPA-2)                                       07840000
         DC    CL6'MEMBER'                                              07860000
MCOPB    DC    AL1(MLEND-MCOPB-2)                                       07880000
         DC    CL22'HAS BEEN MOVED/COPIED.'                             07900000
MLEND    DC    AL1(M389-MLEND-2)                                        07920000
         DC    CL24'LOAD ROUTINE TERMINATED.'                           07940000
M389     DC    AL1(M440-M389-2)                                  A26493 07960019
         DC    CL32'IEH389I I/O ERROR ENCOUNTERED IN'                   07980000
         DC    CL16' INPUT DATA SET.'                            A26581 07990019
M440     DC    AL1(M441-M440-2)                                  A31964 08000020
         DC    CL41'IEH440I  RECFM OR BLKSIZE IS INCONSISTENT'   A34119 08010021
M441     DC    AL1(M442-M441-2)                                  A31964 08011020
         DC    CL38'IEH328I  A TTR IN THE NOTELIST RECORD '      A31964 08012020
         DC    CL21'HAS NOT BEEN UPDATED.'                       A31964 08013020
M442     DC    AL1(MTERM-M442-2)                                 A31964 08014020
         DC    CL41'IEH327I A TTR IN THE USER DATA FIELD OF '    A31964 08015020
         DC    CL35'THE DIRECTORY HAS NOT BEEN UPDATED.'         A31964 08016020
MTERM    DS    0C                                                       08020000
***** DEFINE INPUT AND OUTPUT AREAS AND WORK AREAS *****                08040000
PDSIO    DSECT                                                          08060000
PDSREC   DS    100F                                                     08080000
PDSLWORK DSECT                                                          08100000
PDSTRKBL DS    H         TRACJ BALANCE STORED HERE AFTER EVERY   A22318 08104018
*                          SUCCESSFUL STOW.  RESTORED FROM HERE  A22318 08108018
*                          TO DCB AFTER DUP NAME STOW.           A22318 08112018
         DS    H         UNUSED                                  A22318 08116018
PDSLSTM1 DS    F                                                        08120000
PDSLSTM2 DS    F                                                        08140000
PDSLAD3  DS    F                                                        08160000
PDSDIR   DS    19F                                                      08180000
PDSMSGAR DS    121C                                                     08200000
PDSPTR   DS    3F                                                       08220000
PDSPTRNO DS    H                                                        08240000
PDSLSW   DS    C                                                        08260000
PDSLSTR  DS    F                                                        08280000
PDSNTTR  DS    F                       NEW NOTE LIST TTR         A44326 08290022
PDSNOTE  DS    F                                                        08300000
         DS    H                                                YA01221 08306000
BLDLIST  DS    CL18                                             YA01221 08312000
         IEHMVV                                                         08320000
         END                                                            08340000
         IEHMVV                                                         08360000
