         TITLE 'IEHMVSSX-BUILD DCB AND GO TO DADSM'                     00010032
*TITLE--IEHMVSSX--RENAME AND REBLOCK FOR IEHMOVE LOAD MODULE ESV-  UL0H 00020032
*FUNCTION/OPERATION: THIS MODULE HANDLES RENAMING OF DATA SETS AND THE* 00040000
*ALLOCATION OF THE TO DATA SET. IT ALSO HANDLES REBLOCKING PARAMETERS * 00060000
*AND PREALLOCATED DATA SETS                                           * 00080000
*ENTRY POINTS: IEHMVESX                                               * 00100000
*INPUT: MOVE/COPY COMMUNICATIONS TABLE                                * 00120000
*OUTPUT: NONE                                                         * 00140000
*EXTERNAL ROUTINES: IEHMVSTC                                          * 00160000
*EXITS-NORMAL RETURN TO CALLING RETURN-IEHMVSRY                       * 00180000
*ERRORS: UNABLE TO ALLOCATE TO DATA SET                               * 00200000
*TABLES/WORK AREAS: MOVE/COPY COMMUNICATIONS TABLE                    * 00220000
*ATTRIBUTES: REUSEABLE                                                * 00240000
*NOTES: PART OF LOAD MODULE IEHMVESV                                  * 00260000
*                                                                       00280000
*                                                                       00320000
*                                                                       00340000
*        PURPOSE    THIS ROUTINE CONSTRUCTS THE PROPER DCB'S AND        00360000
*                   ACQUIRES SPACE ALLOCATION FOR THE TO DATASET.       00380000
*                                                                       00400000
*        CHART SX                                                       00420000
*                                                                       00440000
*                                                                       00460000
*        INSERT THE CALLING SEQUENCE                                    00461037
IEHMVSSX CSECT                                                          00462037
*A075300                                     @XA21512-@YA20602-@ZA30700 00462199
*C077060-077140                                                @ZA31059 00463099
*C034227,034304,038544                       @XA19907-@YA19884-@ZA28198 00463299
*D034312-034384,038520-038540                @XA19907-@YA19884-@ZA28198 00463399
*A065760-065768,065784,067800-067804                           @ZA24602 00463499
*C067805                                                       @ZA24602 00463599
*A067800-067880                              @ZA18362-@XA16955-@YA15387 00463699
*C067900                                     @ZA18362-@XA16955-@YA15387 00463799
*C056900                                     @ZA16483-@XA16944-@YA15376 00463899
*A046225-046227                              @ZA13789-@XA16035-@YA14040 00463999
*C034384,046200,046228                       @ZA13789-@XA16035-@YA14040 00464037
*D034301-034302                              @ZA13789-@XA16035-@YA14040 00465037
*A023263-023342                                                @ZA11963 00467037
*C023350,023418                                                @ZA11963 00470037
*A034301-034302                                                @ZA10937 00470732
*C034384,046200                                                @ZA11931 00471037
*A019614,020900-020960,080981                                  @ZA07399 00472037
*C020400,020800,021000-021200,021600                           @ZA07399 00473037
*C006000,034130-034140                                         @ZA07359 00475037
*A056830-056860                                                @ZA06516 00476037
*A034220-034304                                                @ZA04412 00477037
*D034220-034306                                                @ZA04412 00480637
*A065987-066001                                                @ZA04409 00482037
*C038804                                                       @ZA03353 00483037
*A046200-046244                                                @ZA01734 00483737
*D046200                                                       @ZA01734 00484437
*A067720-067760                                                @ZA01727 00485137
*D062945-062955                                                @ZA01727 00486837
*A062802-062812,062945-062955                                  @ZA01244 00488037
*A038804-038810                                                @ZA01243 00489037
*D038804-038809                                                @ZA01243 00490037
*A034346-034347                                                @ZA01238 00491037
*A056900                                                       @ZA01234 00492037
*C044950,054150                                                @ZM30153 00493037
*A033250                                                       @ZA01233 00494037
*A044920,054144                                                @ZM30153 00495037
*D033250-033550                                                @ZA01233 00496037
*A058150-058190                                                @YA02601 00497037
*D058150                                                       @YA02601 00498037
*A023086-023087                                                @YA02577 00499037
*A034306-034384,081405                                         @YA02566 00500202
*A079135                                                       @YA01681 00501037
*C023065,023075                                                @YA01681 00502037
*C079137                                                       @YA01720 00502837
*A023252-023298,080980-080982                                   YA01684 00503237
*A053850-054510                                                 YA01675 00505037
*D053850-054400                                                 YA01675 00506037
*A022920,023050-023090,033733-033787,035300-035320,035450-035730YA01193 00507037
*A038498-038514,038800-038804,041900-042260,042550-042570       YA01193 00508037
*A043345-043346,081810-081820                                   YA01193 00509037
*C034400-034520,034700-035000,042650-043050,043344              YA01193 00510037
*D023050,035300,035450-035700,038498-038500,038800-038803       YA01193 00511037
*D041900-042300,042550                                          YA01193 00512037
*A008600                                                        YA01219 00513037
*C066670                                                        YA01219 00514037
*A019600-019800,066790-066820,081400-081440                     OY01172 00515037
*D019800                                                        OY01172 00516037
*A034240-034400                                                 OY01179 00516837
*C054000-054200                                                  A45176 00517637
*D022420,023300-023900,028650-029050                            OY01192 00518437
*A029650-033910                                                 OY01178 00519237
*C023050                                                        OY01175 00520337
*C044650,044700                                                 OY01178 00521337
*A014040,079138                                                 OY01175 00523037
*D029650-034120                                                 OY01178 00524037
*A013950,022402-022432,023300-023450,029300                     OY01192 00525037
*D065800-067042                                                  A45147 00525937
*C059370                                                         A45147 00526937
*A013660,013720,059370-059395,065800-066940                      A45147 00527937
*                                                                A44334 00528937
*023450,023550,023650                                            S21042 00529937
*063400-063600,066000,066400,066630,077060,077180                S21042 00530937
*                                                               PTM6813 00531937
*066600                                                          A36065 00532937
*007800-009000,009400-010800,011600-011800,012200-012400,013920- S20201 00533937
*-017600,022400-051200,066750,067600,071800,072200,081200-084400 S20201 00534937
*085860,085920                                                   S20201 00535937
*  ALL CODE FLAGGED S20201 WAS ADDED OR CHANGED FOR              S20201 00536937
*  MERLIN/ZEUS SUPPORT                                           S20201 00537937
*                                                                A30639 00538937
*                                                                A30084 00540019
* 027870-027880                                                  A25571 00560518
*1600022200                                                        0659 00561017
*2572 005400                                                            00562017
*1600                                                              2695 00565017
*1600036300-036500,038804-038972                                   3919 00570017
*1600                                                           PTM1219 00575017
*036800,042200,042600                                             19030 00575719
*--ANY STATEMENTS FLAGGED 19030 PERTAIN TO VARIABLE SPANNED RECORD--    00576419
*--SUPPORT FOR BDAM DATA SETS                                           00577119
*037000-037200                                                   A27060 00577819
*                                                                A27710 00578519
*066200                                                          A27312 00579219
*                                                                       00580000
*       VS2 RELEASE2 SU32                                      @G32DSFS 00583032
*058202-058204,077060-077140                                   @ZM44439 00586099
*058190-058393,067260-067312                                   @G32DSFS 00589032
*                                                                       00592032
*                                                                       00595032
IEHMVESX SAVE  (14,12),T,IEHMVSSX-OZ30700-SU32                 @ZA30700 00600099
         ENTRY IEHMVESX                                                 00620000
         LR    BASE,LINK                                                00640000
         USING IEHMVESX,BASE                                            00660000
    IEHPRE  (14,1),TFC,                                                 00680000
*                                                                       00700000
*                                                                       00720000
         USING IEHMVV,MCTABLE                                           00740000
*                                                                       00760000
         EXTRN IEHMVETC                                          S20201 00810020
*                                                                S20201 00860020
MOVE     EQU   X'80'                   KEYWORD 'MOVE' SPECIFIED YA01219 00860402
PDS      EQU   X'08'                                                    00920000
EXPAND   EQU   X'04'                                                    01100000
LOAD     EQU   X'02'                                                    01120000
UNLOAD   EQU   X'01'                                                    01140000
PHONYTO  EQU   X'10'                                                    01200000
RENAME   EQU   X'04'                                                    01260000
PREALBIT EQU   X'08'                                                    01280000
PREALLOC EQU   X'20'                                                    01300000
CATALOGF EQU   X'04'                                                    01320000
VBLOCKED EQU   X'10'                                                    01340000
FBLOCKED EQU   X'20'                                                    01360000
VOLUME   EQU   X'02'                                             A45147 01366021
PSBIT    EQU   X'40'                                             A45147 01372021
PDSBIT   EQU   X'02'                                                    01380000
LABALLO  EQU   X'40'                   FLAG DSCB FOR U.L. TRK ALLO UL0H 01390017
MODLDSCB EQU   X'08'                   MODEL-DSCB INDICATOR      A45176 01395022
DUMP     EQU   X'01'                                             S20201 01396020
BDAM     EQU   X'20'                                             S20201 01402020
X22      EQU   X'22'                                            OY01175 01405002
*                                                                S20201 01408020
***      REGISTER EQUATIONS ****                                 S20201 01414020
*                                                                S20201 01420020
R0       EQU   0                                                 S20201 01426020
PASSA    EQU   R0                                                S20201 01432020
*                                                                S20201 01438020
R1       EQU   1                                                 S20201 01444020
PASSB    EQU   R1                                                S20201 01450020
*                                                                S20201 01456020
R2       EQU   2                                                 S20201 01462020
*                                                                S20201 01468020
R3       EQU   3                                                 S20201 01474020
*                                                                S20201 01480020
R4       EQU   4                                                 S20201 01486020
ACCE     EQU   R4                                                S20201 01492020
*                                                                S20201 01498020
R5       EQU   5                                                 S20201 01504020
ACCO     EQU   R5                                                S20201 01510020
*                                                                S20201 01516020
R6       EQU   6                                                 S20201 01522020
M6       EQU   R6                                                S20201 01528020
*                                                                S20201 01534020
R7       EQU   7                                                 S20201 01540020
*                                                                S20201 01546020
R8       EQU   8                                                 S20201 01552020
*                                                                S20201 01558020
R9       EQU   9                                                 S20201 01564020
*                                                                S20201 01570020
R10      EQU   10                                                S20201 01576020
*                                                                S20201 01582020
R11      EQU   11                                                S20201 01588020
BASE     EQU   R11                                               S20201 01594020
*                                                                S20201 01600020
R12      EQU   12                                                S20201 01606020
MCTABLE  EQU   R12                                               S20201 01612020
*                                                                S20201 01618020
R13      EQU   13                                                S20201 01624020
SAVE     EQU   13                                                S20201 01630020
*                                                                S20201 01636020
R14      EQU   14                                                S20201 01642020
RETURN   EQU   R14                                               S20201 01648020
*                                                                S20201 01654020
R15      EQU   15                                                S20201 01660020
LINK     EQU   R15                                               S20201 01666020
*                                                                S20201 01672020
*                                                                S20201 01678020
*                                                                S20201 01684020
         EJECT                                                          01690020
         L     R0,WALENGTH             GET LENGTH FOR GETMAIN    S20201 01696020
         GETMAIN  R,LV=(R0)            GET WORK AREA             S20201 01702020
         LR    R10,R1                  ESTABLISH ADDRESSABILITY  S20201 01708020
         USING WORKAREA,R10            TO WORKAREA               S20201 01714020
*                                                                S20201 01720020
*                                                                       01780000
         TM    IEHMVV20+3,RENAME   TEST RENAME BIT                      01800000
         BO    NOV                                                      01820000
         L     ACCE,IEHMVV22       ADDRESS OF FROM VOLUME LIST          01840000
         L     ACCO,IEHMVV23+4     ADDRESS OF ACTIVE TO VOLUME          01860000
         CLC   4(6,ACCE),4(ACCO)   COMPARE VOLUME ID OF TO & FROM VOLS  01880000
         BE    ENAMEX                                                   01900000
         MVC   IEHMVV21+4(4),IEHMVV21 SET ADDR OF TO & FROM DS NAMES =  01920000
         B     NOV                                                      01940000
ENAMEX   DS    0H                                                       01960000
         TIME  ,                                                OY01172 01961002
         ST    R0,SAVEREG0             SAVE REG0               @ZA07399 01961537
         XC    DW,DW                                            OY01172 01962002
         STH   R1,DW+6                                          OY01172 01963002
         CVB   R4,DW                                            OY01172 01964002
         STH   R4,DW+6                                          OY01172 01965002
         MVC   TIMEDATE+1(2),DW+6                               YA01172 01965502
         SR    R0,R0                                            OY01172 01966002
         SLDL  R0,16                                            OY01172 01967002
         SLL   R1,12                                            OY01172 01968002
         SRDL  R0,28                                            OY01172 01969002
         STH   R1,DW+6                                          OY01172 01970002
         CVB   R4,DW                                            OY01172 01971002
         STC   R4,TIMEDATE                                      OY01172 01972002
         L     R2,IEHMVV30+8                                    OY01172 01973002
         MVC   DSCBDATE(3),56(R2)                               OY01172 01974002
         CLC   TIMEDATE(3),DSCBDATE                             OY01172 01975002
         BNL   GOON                                             OY01172 01976002
         B     MSGNOMOV                                         OY01172 01977002
GOON     L     ACCE,IEHMVV10                                    OY01172 01978002
         LA    ACCO,44(ACCE)                                            02000000
         ST    ACCO,IEHMVV10                                            02020000
         ST    ACCE,IEHMVV21+4     SAVE ADDR OF DS NAME AREA   @ZA07399 02040037
         OI    IEHMVV20+2,PHONYTO  TURN PHONYTO BIT ON                  02060000
         MVC   0(8,ACCE),DUNAME   **TEMP.T TO DS NAME AREA     @ZA07399 02080037
         L     R0,SAVEREG0         RELOAD REG0                 @ZA07399 02084037
         ST    R0,DV               STORE CLOCK TIME            @ZA07399 02088037
         OI    DV+3,X'0F'          SET SIGN BYTE               @ZA07399 02092037
         UNPK  8(7,ACCE),DV(4)     UNPACK                      @ZA07399 02096037
         MVI   15(ACCE),C' '       MOVE BLANKS INTO DS NAME    @ZA07399 02100037
         MVC   16(29,ACCE),15(ACCE) AREA                       @ZA07399 02120037
         B     NOV                                                      02140000
DUNAME   DC    CL8'**TEMP.T'                                   @ZA07399 02160000
NOV      DS    0H                                                       02180000
*                                                                       02200000
*                                                                       02220000
         NI    IEHMVV20+4,X'F7'   TURN OFF MODEL DSCB SWITCH       0659 02230017
         L     R2,IEHMVV30+8           ADDRESS OF FROM DSCB      S20201 02235020
         USING FT1DSCB,R2              ESTABLISH ADDRESSABILITY  S20201 02240020
         LA    R3,DEVCHAR              ESTABLISH ADDRESSABILITY  A45176 02240222
         USING UNITCHAR,R3             FROM-DEV CHARACTERISTICS  A45176 02240422
         L     R4,IEHMVV30+12          PTR TO FROM-DDNAME        A45176 02240622
         LA    R4,0(R4)                ZERO HIGH-ORDER BYTE      A45176 02240822
         XC    0(40,R3),0(R3)          ZERO BOTH DEVTYPE AREAS   A45176 02241022
         DEVTYPE (R4),(R3),DEVTAB      GET FROM-DEVTYPE          A45176 02241222
         CLC   DS1EXT1+2(8),ZEROS      CHECK FOR MODEL-DSCB      A45176 02241422
         BNE   NOTMOD                  NO MODEL-DSCB             A45176 02241622
         CLC   DS1SCALO+1(3),ZEROS     CHECK FOR MODEL-DSCB      A45176 02241822
         BNE   NOTMOD                  NO MODEL DSCB             A45176 02242022
         CLI   DEVTYPE+2,DASD          TEST FROM-DEVICE DASD     A45176 02242222
         BE    SETMOD                  YES, MUST BE MODEL DSCB   A45176 02242422
         TM    IEHMVV20+1,LOAD         DATA SET TO BE LOADED     A45176 02242622
         BNO   NOTMOD                  NO, MUST BE TAPE INPUT    A45176 02242822
SETMOD   OI    IEHMVV20+4,MODLDSCB     INDICATE MODEL-DSCB       A45176 02243022
         B     AFTERSCK                                          A45176 02243222
NOTMOD   DS    0H                                                S21042 02244021
         TM    DS1DSORG,PDSBIT         IS THIS A PDS             S20201 02245020
         BO    YPDS                    *B IF YES                 S20201 02250020
AFTERSCK MVC   IEHMVV00(100),0(R2)     MOVE DSCB                 S20201 02255020
         LR    R2,MCTABLE              TEMPORARY ADDRESS THE     S20201 02260020
*                                      MOVED DSCB WITH R2        S20201 02265020
         XC    DS1LSTAR(10),DS1LSTAR   BLANK OUT                 S20201 02270020
         XC    DADDQ+4(83),DADDQ+4                               S20201 02275020
         L     R2,IEHMVV30+8           RE-ADDRESS FROM DSCB      S20201 02280020
         MVC   DADPQ-IECSDSL1(4,MCTABLE),DADPQ COPY PRIM QUANT   S20201 02285020
*                                      INTO NEW DSCB             S20201 02290020
         MVI   UNLOADSW,X'00'          SWITCH INITIALY OFF      YA01193 02292002
         L     R3,IEHMVV23+4           PTR TO TO VOLLIST         S20201 02295020
         CLI   2(R3),DASD              TO DEVICE DIRECT ACCESS   S20201 02300020
         BE    SETVOLSR                IF SO, CALCULATE SPACE   YA01193 02305002
*                                      IF NOT TO DIRECT ACCESS, YA01193 02305502
         TM    IEHMVV20+1,UNLOAD         AND NOT TO BE UNLOADED,YA01193 02306002
         BNO   YTAPE2                  BYPASS SPACE-CALC.      @YA01681 02306502
         TM    IEHMVV20+1,LOAD+UNLOAD  FOR A LOAD-UNLOAD        YA01193 02307002
         BO    YTAPE2                  NO SPACE-VALUE REQ.     @YA01681 02307502
         OI    UNLOADSW,X'80'          INDICATE SPACE ONLY REQRDYA01193*02308002
                                         FOR UNLOAD-INFORMATION YA01193 02308502
         TM    IEHMVV20+4,MODLDSCB     TEST IF MODEL-DSCB      @YA02577 02308602
         BO    YTAPE2                  YES                     @YA02577 02308702
SETVOLSR EQU   *                                                YA01193 02309002
         LA    R3,4(R3)                BUMP TO VOLSER            S20201 02310020
         MVC   DS1DSSN-DS1DSNAM(6,MCTABLE),0(R3)                 S20201 02315020
*                                      UPDATE DS SERIAL IN NEW   S20201 02320020
*                                      DSCB                      S20201 02325020
****************************************************************        02325202
*                                                              *        02325402
*  IF COPY, PUT IN CURRENT DATE AS CREATION DATE IN TO-DSCB    *        02325602
*  IF MOVE, KEEP THE OLD CREATION DATE IN TO-DSCB              *        02325802
*                                                              *        02326002
****************************************************************        02326202
         L     R4,IEHMVV22             ADDR OF FROM VOL LIST   @ZA11963 02326337
         LA    R4,0(R4)                CLEAR HIGH ORDER BYTE   @ZA11963 02329037
         TM    2(R4),X'80'             FROM TAPE               @ZA11963 02330037
         BNO   NOTAPE                  NO, BRANCH              @ZA11963 02330837
         TM    IEHMVV20+1,LOAD         LOAD FUNCTION           @ZA11963 02331637
         BO    NOTAPE                  YES, BRANCH             @ZA11963 02332437
         MVI   52(R12),X'01'           SET VOL SEQ = 1         @ZA11963 02333237
         B     TIME                    GET CURRENT DATE        @ZA11963 02334037
NOTAPE   TM    IEHMVV20,X'80'          MOVE OPERATION          @ZA11963 02335037
         BO    MOVE1                   BRANCH IF YES            YA01684 02336037
         ST    R1,SAVEREG1             SAVE REG1 FOR TIME MACRO YA01684 02337037
TIME     TIME  ,                       GET CURRENT DATE        @ZA11963 02340037
         XC    DV,DV                   CLEAR CONVERSION AREA    YA01684 02342037
         LR    R4,R1                   GET DATE IN REG4         YA01684 02345037
         STH   R1,DV+6                 STORE 'DDDC'             YA01684 02347037
         CVB   R1,DV                   CONVERT IT TO BINARY     YA01684 02349037
         STH   R1,DV+6                 STORE IT IN ALIGNED AREA YA01684 02351037
         MVC   54(2,R12),DV+6          MOVE IT INTO NEW DSCB    YA01684 02353037
         SRDL  R4,4                    PUT X'F' INTO REG5       YA01684 02355037
         SRL   R4,12                   REMOVE 'DDD' FROM REG4   YA01684 02357037
         SLDL  R4,4                    PUT 'YYF' INTO REG4      YA01684 02359037
         STH   R4,DV+6                 STORE 'YYF' INTO AREA    YA01684 02361037
         CVB   R1,DV                   CONVERT IT TO BINARY     YA01684 02363037
         STC   R1,53(R12)              STORE IT INTO NEW DSCB   YA01684 02365037
         L     R1,SAVEREG1             RESET REG1               YA01684 02367037
MOVE1    EQU   *                                                YA01684 02369037
         L     R4,IEHMVV21+4           PTR TO NEW DSNAME         A45176 02371037
         MVC   IEHMVV00(44),0(R4)      PUT IN NEW DSCB           A45176 02373037
         TM    IEHMVV20+4,MODLDSCB     TEST FOR MODEL-DSCB       A45176 02375037
         BO    CALLALLO                BRANCH TO ALLOCATE IF ONE A45176 02377037
         EJECT                                                          02395020
REGUPROC EQU   *                                                 S20201 02400020
*****************************************************************S20201 02405020
*                                                                S20201 02410020
*   SPACE ALLOCATION ALGORITHM -                                 S20201 02415020
*                                                                S20201 02420020
*     THE FOLLOWING SECTION OF CODE DETERMINES THE NUMBER OF     S20201 02425020
*     BYTES OF AUXILIAIRY STORAGE NEEDED FOR THE TO DATASET.     S20201 02430020
*     FROM THIS NUMBER,THE NUMBER OF TRACKS NEEDED CAN BE        S20201 02435020
*     DERIVED                                                    S20201 02440020
*                                                                S20201 02445020
*     FOR BDAM DATASETS,ALL EXTENTS (MAX 16) WILL BE TAKEN INTO  S20201 02450020
*     ACCOUNT                                                    S20201 02455020
*                                                                S20201 02460020
*     FOR NON-BDAM DATASETS ONLY THE PRIMARY ALLOCATION,WHICH    S20201 02465020
*     EXISTS IN UP TO 5 EXTENTS,WILL BE USED TO DETERMINE THE    S20201 02470020
*     NUMBER OF TRACKS IN THE FROM DATASET. AS SOON AS AN EXTENT S20201 02475020
*     IS FOUND THAT CORRESPONDS TO THE SECONDARY ALLOCATION      S20201 02480020
*     AMOUNT,WE STOP COUNTING THE NUMBER OF TRACKS AND CYLINDERS S20201 02485020
*     IN THE FROM DATASET, EXCEPT WHEN THIS EXTENT IS THE FIRST. S20201 02490020
*         THIS WILL GIVE THE USER THE ABILITY TO RECLAIM UNUSED  S20201 02495020
*     SPACE IN A PDS,(CAUSED BY REPLACING MEMBERS) MERELY BY     S20201 02500020
*     MOVING THE DATASET THUS GETTING ONLY THE ORIGINAL          S20201 02505020
*     PRIMARY ALLOCATION BACK.                                   S20201 02510020
*                                                                S20201 02515020
*     ONCE WE HAVE ACCUMULATED THE NUMBER OF TRACKS OCCUPIED     S20201 02520020
*     BY THE FROM DATASET,WE MULTIPLY THIS NUMBER BY THE TRACK-  S20201 02525020
*     CAPACITY OF THE FROM DEVICE,GIVING US THE APPROXIMATE      S20201 02530020
*     NUMBER OF BYTES IN THE FROM DATASET                        S20201 02535020
*                                                                S20201 02540020
*     DIVIDING THIS NUMBER BY THE SUM OF KEYLENGTH,BLOCKSIZE AND S20201 02545020
*     DEVICE OVERHEAD WILL GIVE US THE APPROXIMATE NUMBER OF     S20201 02550020
*     RECORDS IN THE FROM DATASET.                               S20201 02555020
*          SOMETIMES,LIKE IN THE CASE OF THE SYS1.SYSJOBQE DATA- S20201 02560020
*     SET OR IN USER DEFINED ACCESS METHODS,THE BLOCKSIZE AND    S20201 02565020
*     KEYLENGTHWILL NOT BE DEFINED IN THE FROM DATASETS' DSCB.   S20201 02570020
*     FOR THESE SITUATIONS,THE BLOCKSIZE IS DEFAULTED TO FIT THE S20201 02575020
*     THE AVERAGE BLOCKSIZE OF AN AVERAGE JOB QUEUE.             S20201 02580020
*                                                                S20201 02585020
*     IT SHOULD BE NOTED,HOWEVER,THAT THIS NUMBER OF RECORDS     S20201 02590020
*     IS IN NO WAY REALISTIC FOR DATASETS WITH UNDEFINED OR VAR- S20201 02595020
*     IABLE RECORD FORMATS. THE BLKSIZE GIVEN IN THE DSCB OF     S20201 02600020
*     THESE DATASETS IS THE MAXIMUM SIZE,SO THE NUMBER OF        S20201 02605020
*     RECORDS WILL BE TO LOW. THIS WOULD ONLY IMPACT THE RESULT  S20201 02610020
*     WHEN THE 'TO' DEVICE OVERHEAD IS NOT THE SAME AS THE'FROM' S20201 02615020
*     OVERHEAD. THEREFORE WE NEUTRALIZE THIS DIFFERENCE BY       S20201 02620020
*     MULTIPLYING THE SUM OF MAXIMUM BLOCKSIZE,KEYLENGTH AND     S20201 02625020
*     OVERHEAD BY THE QUOTIENT OF 'FROM' AND 'TO' OVERHEAD,PRIOR S20201 02630020
*     TO DIVIDING THE NUMBER OF BYTES BY IT.    WHEN WE ARE      S20201 02635020
*     COPYING TO A DEVICE WITH A BIGGER OVERHEAD,THE RESULTING   S20201 02640020
*     AVERAGE BLOCKSIZE WILL BE SMALLER THAN THE ORIGINAL MAXI-  S20201 02645020
*     MUM,THUS BOOSTING UP THE RESULTING NUMBER OF RECORDS,AND   S20201 02650020
*     THUS THE RESULTING NMBR OF TRACKS,WHICH SHOULD BE ENOUGH   S20201 02655020
*     TO MAKE UP FOR THE DIFFERENCE IN OVERHEAD.                 S20201 02660020
*        WHEN WE ARE COPYING BETWEEN THE SAME TYPES OF DEVICES,  S20201 02665020
*     THE AVERAGE BLOCKLENGTH WILL BE THE SAME AS THE MAXIMUM    S20201 02670020
*     BLOCKLENGTH ,WHICH CAN'T DO ANY HARM,AS THE OVERHEAD ARE   S20201 02675020
*     EQUAL TO.                                                  S20201 02680020
*        WHEN COPYING TO A DEVICE WITH A SMALLER OVERHEAD,THE    S20201 02685020
*     AVERAGE BLOCKSIZE WILL BE GREATER THAN THE MAX BLOCKSIZE,  S20201 02690020
*     WHICH RESULTS IN A LOWER NUMBER OF TRACKS FOR THE NEW DATA S20201 02695020
*     SET THAN IT WOULD HAVE BEEN WITH THE MAX BLOCKSIZE.        S20201 02700020
*                                                                S20201 02705020
*     THE NUMBER OF RECORDS THUS DERIVED,IS MULTIPLIED BY THE    S20201 02710020
*     SUM OF KEYLENGTH,BLOCKSIZE AND DEVICE OVERHEAD OF THE 'TO' S20201 02715020
*     DATASET,TAKING INTO CONSIDERATION ANY DE-BLOCKING          S20201 02720020
*     CONSTRAINTS,POSED UPON THE OPERATION DUE TO TRACK CAPACITY S20201 02725020
*     INCOMPATABILITY.(ALSO THE NUMBER OF RECORDS IS ADJUSTED    S20201 02730020
*     INCASE OF DE-BLOCKING).   THE PRODUCT OF THIS MULTIPLI-    S20201 02735020
*     CATION IS THE APPROXIMATE NUMBER OF BYTES IN THE NEW DATA- S20201 02740020
*     SET.                                                       S20201 02745020
*                                                                S20201 02750020
*     DIVIDING THIS NUMBER OF BYTES BY THE TRACK CAPACITY OF     S20201 02755020
*     THE 'TO' DEVICE ,WILL GIVE USE THE DESIRED NUMBER OF TRACKSS20201 02760020
*     TO BE USED IN ALLOCATION.                                  S20201 02765020
*                                                                S20201 02770020
*     THE SAME PROCEDURE IS FOLLOWED FOR THE SECONDARY ALLOCATIONS20201 02775020
*     AMOUNT,AFTER CONVERTING THE AMOUNT TO TRACKS IF APPROPRIATES20201 02780020
*                                                                S20201 02785020
*     NOTE: THIS ALGORITHM WAS REVISED AND REWRITTEN IN ITS ENTI-S20201 02790020
*     RETY FOR RELEASE 20.2 RECORD READY SUPPORT                 S20201 02795020
*                                                                S20201 02800020
*****************************************************************S20201 02805020
         SPACE 2                                                        02810020
         TM    IEHMVV20+1,LOAD         IS DATASET BEING LOADED   S20201 02815020
         BO    CALLALLO                *B IF YES-USE F1 DSCB OF  S20201 02820020
*                                      ORIGINAL DATASET TO ALLOC-S20201 02825020
*                                      ATE THE NEW DATASET       S20201 02830020
*                                                                S20201 02835020
         TM    DS1DSORG,ISAM           IS THIS AN ISAM DATASET   S20201 02840020
         BO    GOODALLO                *B IF YES LIKE ALL IS OK  S20201 02845020
*                                                                S20201 02850020
ISAM     EQU   X'80'                                             S20201 02855020
*                                                                S20201 02860020
         L     R4,IEHMVV31+8           GET PTR TO'TO'DDNAME      S20201 02910020
         LA    R4,0(R4)                ZERO HI-BYTE              S20201 02915020
         DEVTYPE (R4),DEVCHAR2,DEVTAB   GET ANOTHER 5 WORDS      S20201 02920020
         MVI   DEFSW,X'00'             CLEAR SWITCH              S20201 02925020
         LA    R3,DEVCHAR              ADDRESS FROM DEVTYPE      A45176 02930022
         CLI   DEVTYPE+2,DASD          FROM DEVICE DA            S20201 02940020
         BNE   GETDEFLT                 USE DEFAULT ALLOCATION   A44334 02945021
*                                      PRIMARY ALLOCATION AMOUNT S20201 02950020
         XC    SECALLO,SECALLO         ZERO SAVE AREA FOR SECON- S20201 02955020
*                                      DARY ALLOCATION           S20201 02960020
         CLC   DS1PTRDS(5),ZEROS       TEST FOR FORMAT3-DSCB    OY01178 02965002
         BE    DSCBNOF3                IF NO,SKIP F3-ROUTINE    OY01178 02970002
         MVC   CAMLIST(4),CAMLST1      MOVE SEEK MODE BYTES     OY01178 02975002
         LA    R14,DS1PTRDS            PTR TO F3 CCHHR ADDRESS  OY01178 02980002
         L     R15,IEHMVV22+4          PTR TO FROM VOLUME LIST  OY01178 02985002
         LA    R15,4(R15)              PTR TO FROM-VOLUME SERNR OY01178 02995002
         LA    R0,FT3DSCB              PTR TO OBTAINAREA        OY01178 03000002
         STM   R14,R0,CAMLIST+4        STORE PTRS IN CAMLIST    OY01178 03005002
         LA    R1,CAMLIST              PTR TO CAMLIST           OY01178 03010002
         OBTAIN (R1)                   OBTAIN FORMAT3-DSCB      OY01178 03015002
         LTR   R15,R15                 TEST F3-DSCB FOUND       OY01178 03025002
         BNZ   BALLO                   MSG,IF NOT               OY01178 03030002
         MVC   EXTENTS(30),DS1EXT1     MOVE 3 F1-EXTENTS        OY01178 03035002
         MVC   EXTENTS+70(91),EXTENTS+71 ELIMINATE F3-INDICATOR OY01178 03040002
         B     DSCBSECA                                         OY01178 03045002
DSCBNOF3 MVC   EXTENTS(31),DS1EXT1     MOVE EXTENTS+ZERO BYTE   OY01178 03055002
DSCBSECA EQU   *                                                OY01178 03060002
*                                                               OY01178 03065002
*  COMPUTE NUMBER OF TRACKS OF 'FROM' SELONDARY ALLOCATION      OY01178 03070002
*                                                               OY01178 03075002
         TM    DS1SCALO,X'80'          TEST TYPE OF SEC ALLOC   OY01178 03085002
         BZ    DSCBSCAN                FOR ABS/BLKS SEC ALLOC=0 OY01178 03090002
         MVC   SECSAVE+1(3),DS1SCALO+1 GET SEC ALLOC QUANTITY   OY01178 03095002
         MVI   SECSAVE,X'00'                                    OY01178 03100002
         TM    DS1SCALO,X'40'          TEST ALLOCATION IN       OY01178 03105002
         BZ    DSCBBDAM                CYLINDERS OR TRACKS      OY01178 03115002
         L     R4,SECSAVE              IF IN CYLINDERS,         OY01178 03120002
         MH    R4,TRPCYL               MULTIPLY BY NR OF        OY01178 03125002
         ST    R4,SECSAVE              TRACKS PER CYLINDER.     OY01178 03130002
DSCBBDAM TM    DS1DSORG,BDAM           TEST FOR BDAM DATA SET   OY01178 03135002
         BO    DSCBSCAN                IF NOT BDAM,USE          OY01178 03145002
         MVC   SECALLO(4),SECSAVE      THIS VALUE TO COMPARE    OY01178 03150002
DSCBSCAN EQU   *                                                OY01178 03155002
*                                                               OY01178 03160002
*  SCAN EXTENTS TO DEFINE TOTAL 'FROM' PRIMARY ALLOCATION.      OY01178 03165002
*  WHEN AN EXTENT IS SMALLER THAN OR EQUAL TO THE SECONDARY     OY01178 03175002
*  ALLOCATION,IT WILL BE CONSIDERED AS A SECONDARY ALLOCATION,  OY01178 03180002
*  EXCEPT FOR THE FIRST EXTENT. THE SUM OF THE SPACES USED BY   OY01178 03185002
*  THE OTHER EXTENTS WILL BE CONSIDERED AS PRIMARY ALLOCATION.  OY01178 03190002
*  NOTE: FOR BDAM DATA SETS,OR IF THE ALLOCATION WAS 'ABS' OR   OY01178 03195002
*  'BLK',ALL EXTENTS WILL BE USED AS PRIMARY (BECAUSE'SECALLO'  OY01178 03205002
*  HAS BEEN SET TO ZERO).                                       OY01178 03210002
*                                                               OY01178 03215002
         LA    R15,EXTENTS                                      OY01178 03220002
         MVI   FIRSTEXT,X'FF'          INDICATE FIRST EXTENT    OY01178 03225002
         SR    R7,R7                   PRIMARY ALLOC INIT ZERO  OY01178 03235002
         TM    EXTENTS,X'40'           TEST FIRST EXT USER LABELOY01178 03240002
         BNO   DSCBNOUL                IF USER LABEL TRACK,     OY01178 03245002
DSCBEXTS LA    R15,10(R15)             SKIP THIS EXTENT         OY01178 03250002
DSCBNOUL CLI   0(R15),X'00'            CHECK EXTENT USED        OY01178 03255002
         BE    DSCBCONV                IF NOT,NO MORE EXTENTS   OY01178 03265002
         TM    DEVCHAR+17,X'02'        TEST FOR 2321            OY01178 03270002
         BO    DEV2321                 SPECIAL ROUTINE FOR 2321 OY01178 03275002
         LH    R6,6(R15)               GET UPPER CC             OY01178 03280002
         SH    R6,2(R15)               SUBTRACT LOWER CC        OY01178 03285002
         MH    R6,TRPCYL               CONVERT CYLS TO TRACKS   OY01178 03295002
         AH    R6,8(R15)               ADD UPPER TT             OY01178 03300002
         SH    R6,4(R15)               SUBTRACT LOWER TT        OY01178 03305002
         LA    R6,1(R6)                ADD ONE FOR FIRST TRACK  OY01178 03310002
*                                                               OY01178 03315002
BACK2321 AR    R7,R6                   ADD EXTENT TO PRIMARY   @ZA01233 03325002
         MVI   FIRSTEXT,X'00'          RESET FIRST EXTENT SWITCHOY01178 03360002
         B     DSCBEXTS                SCAN NEXT EXTENT         OY01178 03365002
DSCBCONV ST    R7,PRIME                SAVE TOTAL PRIMARY ALLOC OY01178 03370002
         TM    IEHMVV20+1,UNLOAD       TEST FOR UNLOAD          YA01193 03370202
         BNO   CONVDSCB                IF NOT, GO AROUND        YA01193 03370402
         L     R1,IEHMVV10             ELSE, - RESERVE SPACE IN YA01193 03370602
         MH    R7,TRLENGTH               THE PERMANENT WORK AREAYA01193 03370802
         ST    R7,0(R1)                - SET NBR BYTES IN PRIME YA01193 03371002
         XC    4(4,R1),4(R1)           - ZERO FOR SEC IF TRK-CYLYA01193 03371202
         TM    DS1SCALO,X'80'          TEST TYPE OF SEC ALLOC   YA01193 03371402
         BZ    SETPTR                  USE ZERO, OR             YA01193 03371602
         L     R7,SECSAVE              CALCULATE NBR OF SECOND. YA01193 03371802
         MH    R7,TRLENGTH               BYTES                  YA01193 03372002
         ST    R7,4(R1)                  AND SAVE               YA01193 03372202
SETPTR   ST    R1,IEHMVV85             SAVE POINTER TO BE       YA01193*03372402
                                         PASSED TO IEHMVSSY     YA01193 03372602
         LA    R1,8(R1)                UPDATE POINTER TO THE    YA01193 03372802
         ST    R1,IEHMVV10               PERMANENT WORK AREA    YA01193 03373002
         TM    UNLOADSW,X'80'          IF SPACE ONLY NEEDED IN  YA01193 03373202
         BO    YTAPE1                    UNLOADED DATA SET, SKIPYA01193*03373402
                                         REST OF CALCULATIONS   YA01193 03373602
CONVDSCB EQU   *                                                YA01193 03373802
         TM    DS1DSORG,BDAM           TEST FOR BDAM            OY01178 03375002
         BNO   GETBLKSZ                                         OY01178 03385002
         MVC   SECALLO+1(3),SECSAVE+1  IF BDAM GET SEC ALLOC    OY01178 03390002
         TM    DS1RECFM,X'40'          RECFM V OR U            @ZA07359 03413037
         BO    FINISH                  YES TRACK INTEGRITY     @ZA07359 03417037
GETBLKSZ CLC   DEVCHAR+2(1),DEVCHAR2+2 TEST DEV CLASS          @ZA04412 03422037
         BNE   NOTEQUAL                NOT EQUAL               @ZA28198 03422799
         CLI   DEVCHAR+3,X'09'         FROM 3330-1             @ZA04412 03423437
         BE    TESTTO                  YES                     @ZA04412 03424137
         CLI   DEVCHAR+3,X'0D'         FROM 3330-11            @ZA04412 03424837
         BNE   EQUAL                   TEST IF EQUAL           @ZA04412 03425537
TESTTO   CLI   DEVCHAR2+3,X'09'        TO 3330-1               @ZA04412 03426237
         BE    FINISH                  YES                     @ZA04412 03426937
         CLI   DEVCHAR2+3,X'0D'        TO 3330-11              @ZA04412 03427637
         BE    FINISH                  YES                     @ZA04412 03428337
EQUAL    CLC   DEVCHAR+3(1),DEVCHAR2+3 TO AND FROM EQUAL       @ZA04412 03429037
         BE    FINISH                  YES                     @ZA04412 03429737
NOTEQUAL EQU   *                       NO                      @ZA28198 03430499
* CLACULATE NUMBER OF BYTES (DATA + GAPS) REQUIRED FOR A NORMAL YA01193 03440002
* RECORD (IN R1), AND FOR THE LAST RECORD ON A TRACK (IN R8)    YA01193 03442002
         SR    R1,R1                                            YA01193 03444002
         IC    R1,DS1KEYL              KEYLENGTH                YA01193 03446002
         AH    R1,DS1BLKL                        + BLKSIZE      YA01193 03448002
         BNZ   SETR8                   IF NOT ZERO, USE THESE   YA01193 03450002
         LH    R1,DEFBLK               ELSE, SET DEFAULT VALUE  YA01193 03452002
*                                      TO SUIT JOBQUEUE          S20201 03460020
         MVI   DEFSW,X'FF'             INDICATE DEFAULT USED     S20201 03465020
SETR8    LR    R8,R1                   USE SAME VALUE FOR LAST  YA01193 03470002
         TM    OVHIND,X'01'            TEST FOR TOLERANCE FACTORYA01193 03475002
         BZ    ADDOVH1                 BRANCH AROUND IF NOT     YA01193*03480002
                                                      APPLICABLEYA01193 03485002
         LH    R5,TOLERANC             GET TOLERANCE FACTOR     YA01193 03490002
         MR    R0,R5                   (BLKSIZE + KEYLEN) * TOL YA01193 03495002
         SRDA  R0,9                    DIVIDE BY 512            YA01193 03500002
ADDOVH1  TM    OVHIND,X'08'            2-BYTE OVERHEAD           S20201 03510020
         BO    BIGOVHD1                *B IF YES                 S20201 03515020
         SR    R6,R6                   CLEAR FOR INSERT          S20201 03520020
         IC    R6,OVHCNT               GET ONE BYTE OVH          S20201 03525020
         AR    R1,R6                   ADD FOR NORMAL RECORD    YA01193 03530002
         IC    R6,OVHCNT+1             FOR LAST RECORD          YA01193 03531002
         B     ADD2                                             YA01193 03532002
BIGOVHD1 LH    R6,OVHCNT               GET TWO BYTES OVERHEAD    S20201 03535020
ADD1     AR    R1,R6                   ADD OVERHEAD TO BLKSIZE   S20201 03540020
ADD2     AR    R8,R6                   ADD OVHD FOR LAST RECORD YA01193 03545002
         CLI   DS1KEYL,X'00'           TEST FOR KEY             YA01193 03549002
         BNE   ENDOVHD                 IF WITH KEY NO ADJUSTMENTYA01193 03553002
         SR    R6,R6                   IF WITHOUT KEY,          YA01193 03557002
         IC    R6,KEYOVHD              - GET OVERHEAD FOR KEY   YA01193 03561002
         SR    R1,R6                   - SUBTRACT FOR NORMAL    YA01193 03565002
         SR    R8,R6                   - SUBTRACT FOR LAST REC. YA01193 03569002
ENDOVHD  EQU   *                                                YA01193 03573002
*                                                                S20201 03580020
         CLI   DEFSW,X'FF'             WAS DEFAULT BLKSIZE USED  S20201 03585020
         BE    NOADJUST                *B IF YES-SKIP RECFM CHECKS20201 03590020
*                                                                S20201 03595020
*                                                                S20201 03600020
         TM    DS1RECFM,X'40'          CHECK RECFM               S20201 03605020
         BZ    NOADJUST                *B IF FIXED(BLOCKED)      S20201 03610020
         TM    DS1RECFM,X'48'          CHECK RECFM               S20201 03615020
         BO    NOADJUST                *B IF VARIABLE SPANNED    S20201 03620020
         CLI   DEVTYPE+2,DASD          FROM DEVICE DA            S20201 03621020
         BNE   NOADJUST                *B IF NOT                 S20201 03622020
*                                                                S20201 03625020
*                                      ADJUST THE TOTAL MAXIMUM  S20201 03630020
*                                      BLOCKSIZE FOR VARIABLE    S20201 03635020
*                                      AND UNDEFINED RECORDS     S20201 03640020
*                                                                S20201 03645020
         TM    OVHIND,X'08'            2-BYTE OVERHEAD           S20201 03650020
         BO    BIGOVHD3                *B IF YES                 S20201 03655020
         XR    R0,R0                   CLEAR FOR INSERT          S20201 03660020
         IC    R0,OVHCNT               GET 1-BYTE OVERHEAD       S20201 03665020
         MR    R0,R0                   GET 1-ST PART OF ADJUST-  S20201 03670020
*                                      MENT DONE:MULTIPLY        S20201 03675020
         B     PART2                   *B TO DO SECOND PART      S20201 03680020
BIGOVHD3 MH    R1,OVHCNT               MULTIPLY WITH 2-BYTE OVHD S20201 03685020
PART2    LA    R3,DEVCHAR2             TEMPORARY ADDRESS 'TO'    S20201 03690020
*                                      DEVICE CHARACTERISTICS    S20201 03695020
         XR    R0,R0                   CLEAR FOR DIVIDE          S20201 03700020
         TM    OVHIND,X'08'            2-BYTE OVERHEAD           S20201 03705020
         BO    BIGOVHD4                *B IF YES                 S20201 03710020
         XR    R5,R5                   CLEAR FOR INSERT          S20201 03715020
         IC    R5,OVHCNT               GET 1-BYTE OVERHEAD       S20201 03720020
         B     DIVIDE                  *B TO DIVIDE              S20201 03725020
BIGOVHD4 LH    R5,OVHCNT               GET 2-BYTE OVERHEAD       S20201 03730020
DIVIDE   DR    R0,R5                   DIVIDE BY 'TO' OVHD       S20201 03735020
         LTR   R0,R0                   ANY REMAINDER             S20201 03740020
         BZ    *+8                     *B IF NOT                 S20201 03745020
         LA    R1,1(R1)                ADD ONE FOR REMAINDER     S20201 03750020
         LA    R3,DEVCHAR              RE-ADDRESS FROM DEVICE    S20201 03755020
*                                      CHARACTERISTICS           S20201 03760020
NOADJUST EQU   *                                                 S20201 03765020
*                                                                S20201 03770020
*                                      R1 CONTAINS THE AVERAGE   S20201 03775020
*                                      NUMBER OF BYTES THAT A    S20201 03780020
*                                      BLOCK NEEDS IN THE FROM   S20201 03785020
*                                      DATASET                   S20201 03790020
         TM    DS1RECFM,X'20'          TRACKOVERFLOW             A44334 03792021
         BO    MIXED                   YES CONTINUE              A44334 03794021
         TM    DS1RECFM,X'80'          FIXED LENGTH              A44334 03821021
         BZ    MIXED                   NO, CONTINUE              A44334 03823021
* FOR A FIXED LENGTH DATASET THE NUMBER OF RECORDS PER TRACK     A44334 03825021
* IS CALCULATED AND MULTIPLIED WITH THE NUMBER OF TRACKS TO      A44334 03827021
* FIND THE EXACT NUMBER OF BLOCKS IN THE FROM DATASET            A44334 03829021
         L     R6,PRIME                CALCULATE THE NUMBER      A44334 03831021
         BAL   R9,FROMRECS             OF RECORDS IN THE         A44334 03833021
         ST    R5,PRIME                PRIMARY ALLOCATION        A44334 03835021
         L     R6,SECALLO              YES, CALCULATE THE NUMBER A44334 03839421
         BAL   R9,FROMRECS             OF RECORDS IN THE         A44334 03839821
         B     STORESEC                SECONDARY ALLOCATION      A44334 03839921
MIXED    DS    0H                      STANDARD CALCULATION      A44334 03840021
         L     R4,PRIME                GO TO MULTIPLY TRACKS     A44334 03842021
         BAL   R9,NOFIXED              WITH TRACKCAP AND DIVIDE  A44334 03844021
         ST    R5,PRIME                BY REAL BLOCKSIZE         A44334 03844421
         L     R4,SECALLO              GET NBR OF SECONDARY      A44334 03845021
         BAL   R9,NOFIXED              TRACKS TO CALCULATE NBR   A44334 03847021
         B     STORESEC                OF SECONDARY BLOCKS       A44334 03849021
FROMRECS DS    0H                                                A44334 03849421
         LH    R5,TRLENGTH             GET TRACK LENGTH         YA01193 03849802
         SR    R5,R8                   ADJUST FOR LAST RECORD   YA01193 03850202
         AR    R5,R1                   (REPLACE BY NORMAL)      YA01193 03850602
         SR    R4,R4                   PREPARE FOR DIVIDE       YA01193 03851002
         DR    R4,R1                   NBR OF BLOCKS PER TRACK   A44334 03851402
         LA    R5,1(R5)                ADD ONE                 @ZA28198 03852099
         MR    R4,R6                   FIND SUM OF BLOCKS        A44334 03854821
         BR    R9                      RETURN TO SAVE THE NBR    A44334 03854921
NOFIXED  DS    0H                                                A44334 03855021
         MH    R4,TRACKCAP             CALC TOTAL NBR OF BYTES   A44334 03857021
         SRDA  R4,32                   NBR OF BYTES FOR THE      A44334 03859021
*                                      DS AS A DOUBLE LENGTH     A44334 03859421
*                                      SIGNED INTEGER            A44334 03859821
         DR    R4,R1                   FIND NBR OF BLOCKS        A44334 03859921
         LTR   R5,R5                   ZERO ALLOCATION           A44334 03860021
         BNZ   NOREM                   NO, CONTINUE              A44334 03862021
         LTR   R4,R4                   YES TEST FOR REMAINDER    A44334 03864021
         BZ    NOREM                   NO, ZERO ALLOCATION       A44334 03864421
         LA    R5,1(R5)                YES ALLOCATE MINIMUM      A44334 03864821
NOREM    BR    R9                      RETURN TO SAVE AMOUNT     A44334 03864921
GETDEFLT EQU   *                                                YA01193 03880002
         TM    UNLOADSW,X'80'          IF SPACE OMLY NEEDED IN  YA01193 03880102
         BO    YTAPE1                    UNLOADED D.S., DEFAULTSYA01193*03880202
                                       ARE SET IN IEHMVSSY      YA01193 03880302
         MVI   IEHMVV10-4,X'04'        RELEASE UNUSED SPACE    @ZA03353 03880437
         LH    R1,DEVCHAR2+12          TRACKCAPACITY FOR TO    @ZA01243 03880502
*                                       DEVICE                 @ZA01243 03880602
         SLL   R1,16                   CLEAR HIGH ORDER BYTES  @ZA01243 03880702
         SRL   R1,16                                           @ZA01243 03880802
         L     R5,DEFAULT1             DEFAULT PRIMARY ALLOC   @ZA01243 03880902
         AR    R5,R1                   ADD TRACKCAPACITY       @ZA01243 03881002
         BCTR  R5,0                     MINUS ONE TO ROUND UP    A44334 03881221
         SR    R4,R4                    CLEAR TO DIVIDE          A44334 03881521
         DR    R4,R1                    GIVES NUMBER TRKS PRIME  A44334 03881821
         ST    R5,PRIME                 SAVE PRIME ALLOCATION    A44334 03882121
         L     R5,DEFAULT2              DEFAULT SECONDARY ALLOC  A44334 03882421
         AR    R5,R1                    ADD TRACKCAPACITY        A44334 03882721
         BCTR  R5,0                     MINUS ONE TO ROUND UP    A44334 03883021
         SR    R4,R4                    CLEAR TO DIVIDE          A44334 03883321
         DR    R4,R1                    DIVIDED BY TRACKCAPACITY A44334 03883621
*                                       GIVES NUMBER TRACKS SEC  A44334 03883921
         ST    R5,SECALLO               SAVE SECONDARY ALLOC     A44334 03884221
         MVI   DS1SCALO-IECSDSL1(MCTABLE),X'80'                  S20201 03885020
*                                      INDICATE THAT IT WILL BE  S20201 03890020
*                                      ALLOCATED IN UNITS        S20201 03895020
*                                      OF TRACKS                 S20201 03900020
         B     FINISH                                            A44334 03902021
STORESEC ST    R5,SECALLO              SAVE NMBR OF BLOCKS SECONDS20201 03940020
*                                                                S20201 03945020
*                                                                S20201 03950020
         LA    R3,DEVCHAR2             ADDRESS 'TO' DEVICE       S20201 03955020
*                                      CHARACERISTICS FROM NOW ONS20201 03960020
*                                                                S20201 03965020
         TM    IEHMVV10-4,FBLOCKED     FIXED DEBLOCKING FORCED   S20201 03970020
         BZ    TESTVB                  *B IF NOT                 S20201 03975020
         LH    R4,DS1LRECL             YES-USE LRECL AS NEW      S20201 03980020
*                                      BLOCK LENGTH              S20201 03985020
         B     TESTDEF                                           S20201 03990020
TESTVB   TM    IEHMVV10-4,VBLOCKED     VARIABLE DEBLOCKING FORCEDS20201 03995020
         BZ    GETBLK                  *B IF NOT                 S20201 04000020
         LH    R4,IEHMVV10-10          YES-USE MAX LRECL AS NEW  S20201 04005020
*                                      BLOCK LENGTH              S20201 04010020
         B     TESTDEF                                           S20201 04015020
GETBLK   LH    R4,DS1BLKL              USE OLD BLOCKSIZE         S20201 04020020
TESTDEF  LTR   R4,R4                   WAS IT DEFINED            S20201 04025020
         BNZ   GETBF                   *B IF YES                 S20201 04030020
         LH    R4,DEFBLK               NO-USE ARBITRARY DEFAULT  S20201 04035020
*                                      TO SUIT JOBQUEUE          S20201 04040020
GETBF    EQU   *                                                 S20201 04045020
*                                      DETERMINE THE DE-BLOCKING S20201 04050020
*                                      FACTOR (NEEDED TO BE ABLE S20201 04055020
*                                      TO CALCULATE THE NEW NMBR S20201 04060020
*                                      OF RECORDS AFTER DE-      S20201 04065020
*                                      BLOCKING)                 S20201 04070020
*                                                                S20201 04075020
         LH    R1,DS1BLKL              GET ORIGINAL BLKSIZE      S20201 04080020
         LTR   R1,R1                   WAS IT DEFINED            S20201 04085020
         BNZ   CLEAR0                  *B IF YES                 S20201 04090020
         LH    R1,DEFBLK               NO-GET ARBITRARY DEFAULT  S20201 04095020
*                                      TO SUIT JOBQUEUE          S20201 04100020
CLEAR0   SR    R0,R0                   CLEAR FOR DIVIDE          S20201 04105020
         DR    R0,R4                   GET DEBLOCKING FACTOR     S20201 04110020
         LTR   R0,R0                   ANY REMAINDER             S20201 04115020
         BZ    XMIT                    *B IF NOT                 S20201 04120020
         LA    R1,1(R1)                ADD ONE FOR REMAINDER     S20201 04125020
*                                                                S20201 04130020
*                                      R1 HAS THE DEBLOCKING     S20201 04135020
*                                      FACTOR=THE NUMBER TO MUL- S20201 04140020
*                                      TIPLY THE NUMBERS OF REC- S20201 04145020
*                                      ORDS WITH                 S20201 04150020
*                                                                S20201 04155020
XMIT     LR    R5,R1                   R5 DOES,TOO               S20201 04160020
         M     R0,PRIME                MULTIPLY PRIME AMOUNT     S20201 04165020
         ST    R1,PRIME                SAVE NEW NUMBER OF RECS   S20201 04170020
         LR    R1,R5                   GET MULTIPLICAND BACK     S20201 04175020
         M     R0,SECALLO              MULTIPLY SECONDARY AMNT   S20201 04180020
         ST    R1,SECALLO              SAVE                      S20201 04185020
         SR    R1,R1                                            YA01193 04190002
         IC    R1,DS1KEYL              KEYLENGTH                YA01193 04194002
         AR    R1,R4                             + BLKSIZE      YA01193 04198002
         LR    R8,R1                   USE SAME FOR LAST RECORD YA01193 04202002
         TM    OVHIND,X'01'            TEST FOR TOLERANCE FACTORYA01193 04206002
         BZ    ADDOVH2                 BRANCH AROUND IF NOT     YA01193*04210002
                                                      APPLICABLEYA01193 04214002
         LH    R5,TOLERANC             GET TOLERANCE FACTOR     YA01193 04218002
         MR    R0,R5                   (BLKSIZE + KEYLEN) * TOL YA01193 04222002
         SRDA  R0,9                    DIVIDE BY 512            YA01193 04226002
ADDOVH2  TM    OVHIND,X'08'            2-BYTE OVERHEAD           S20201 04235020
         BO    BIGOVHD2                *B IF YES                 S20201 04240020
         SR    R6,R6                   CLEAR FOR INSERT          S20201 04245020
         IC    R6,OVHCNT               GET ONE BYTE OVHD         S20201 04250020
         AR    R1,R6                   ADD OVHD FOR NORMAL RECRDYA01193 04255002
         IC    R6,OVHCNT+1             FOR LAST RECORD          YA01193 04256002
         B     ADD3                      GO TO ADD OVERHEAD     YA01193 04257002
BIGOVHD2 LH    R6,OVHCNT               GET 2 BYTES OVHD          S20201 04260020
         AR    R1,R6                   ADD OVHD FOR NORMAL RECRDYA01193 04265002
ADD3     AR    R8,R6                   ADD OVHD FOR LAST RECORD YA01193 04270002
         CLI   DS1KEYL,X'00'           TEST FOR KEY             YA01193 04275002
         BNE   ENDOVHD2                IF WITH KEY NO ADJUSTMENTYA01193 04280002
         SR    R6,R6                   IF WITHOUT KEY,          YA01193 04285002
         IC    R6,KEYOVHD              - GET OVERHEAD FOR KEY   YA01193 04290002
         SR    R1,R6                   - SUBTRACT FOR NORMAL    YA01193 04295002
         SR    R8,R6                   - SUBTRACT FOR LAST RECRDYA01193 04300002
ENDOVHD2 EQU   *                                                YA01193 04305002
*                                                                S20201 04310020
         TM    DS1RECFM,X'20'          TRACKOVERFLOW             A44334 04312021
         BO    NORMPROC                YES NORMAL PROCEDURE      A44334 04314021
         TM    DS1RECFM,X'80'          FIXED RECORDS             A44334 04314421
         BZ    NORMPROC                NO, NORMAL PROCEDURE      A44334 04314821
* FOR RECFM=F OR FB THE NUMBER OF RECEIVING TRACKS IS CALCULATED A44334 04314921
* BY DIVIDING THE NUMBER OF RECORDS IN THE DATASET BY THE NUMBER A44334 04315021
* OF RECORDS PER RECEIVING TRACK                                 A44334 04317021
         L     R7,PRIME                 GET NUMBER OF BLOCKS     A44334 04319021
         BAL   R9,BLKTRK               FIND NBR OF TRACKS        A44334 04319421
         TM    DS1DSORG,X'02'          PARTITIONED DATASET       A44334 04319821
         BZ    *+8                     NO  CONTINUE              A44334 04319921
         LA    R7,1(R7)                 YES ADD 1 FOR DIRECTORY  A44334 04320021
         ST    R7,PRIME                 NBR OF TRACKS REQUIRED   A44334 04322021
         L     R7,SECALLO              GET NBR OF BLOCKS         A44334 04324021
         BAL   R9,BLKTRK               CALCULATE SECONDARY       A44334 04324421
         ST    R7,SECALLO               ALLOCATION IN TRACKS     A44334 04324821
         B     FINISH                  CONTINUE                  A44334 04324921
NORMPROC DS    0H                                                A44334 04325021
         L     R5,PRIME                GET NBR OF BLOCKS         A44334 04327021
         BAL   R9,NORMCALC             FIND NBR OF TRACKS        A44334 04329021
         ST    R5,PRIME                FOR PRIMARY ALLOCATION    A44334 04329421
         L     R5,SECALLO              GET NBR OF BLOCKS         A44334 04329821
         BAL   R9,NORMCALC             FIND NBR OF TRACKS        A44334 04329921
         ST    R5,SECALLO              FOR SECONDARY ALLOCATION  A44334 04330021
         B     FINISH                  CONTINUE                  A44334 04332021
BLKTRK   DS    0H                      TRACK CALC FOR F OR FB    A44334 04334021
         LH    R5,TRLENGTH             GET TRACK LENGTH         YA01193 04334402
         SR    R5,R8                   ADJUST FOR LAST RECORD   YA01193 04334502
         AR    R5,R1                   (REPLACE BY NORMAL)      YA01193 04334602
         SR    R4,R4                   PREPARE FOR DIVIDE        A44334 04334821
         DR    R4,R1                   NBR OF BLOCKS PER TRACK   A44334 04334921
         LTR   R5,R5                   LET THIS NUMBER BE        A44334 04335021
         BNZ   *+8                     ONE AT LEAST              A44334 04337021
         LA    R5,1(R5)                                          A44334 04339021
         SR    R6,R6                    PREPARE FOR DIVIDE       A44334 04339421
         DR    R6,R5                    NUMBER OF TRACKS REQUIRE A44334 04340321
         LTR   R6,R6                    ANY REMAINDER            A44334 04341221
         BCR   8,R9                     NO,CONTINUE              A44334 04342121
         LA    R7,1(R7)                 ADD ONE FOR REMAINDER    A44334 04343021
         BR    R9                      RETURN TO STORE AMOUNT    A44334 04344021
NORMCALC DS    0H                                                A44334 04367021
         LH    R0,TRACKCAP             GET TRACKCAPACITY         A44334 04369021
         MR    R4,R1                   GET NUMBER OF BYTES       S20201 04370020
         DR    R4,R0                   GET NMBR OF TRACKS        S20201 04375020
         LTR   R4,R4                   ANY REMAINDER             S20201 04380020
         BZ    *+8                     *B IF NOT                 S20201 04385020
         LA    R5,1(R5)                ADD ONE FOR REMAINDER     S20201 04390020
         BR    R9                      RETURN TO STORE AMOUNT    A44334 04392021
*                                                                S20201 04410020
*                                                                S20201 04415020
*                                                                S20201 04420020
*                                                                S20201 04425020
DEV2321  EQU   *                                                 S20201 04430020
*        BUILD A FAKE DEB FOR USE BY THE RESIDENT CCHH TO TTR    S20201 04435020
*        CONVERSION ROUTINE                                      S20201 04440020
*                                                                S20201 04445020
         MVI   CONVINP,X'00'           CLEAR CONVERSION-         S20201 04450020
         MVC   CONVINP+1(31),CONVINP   WORKAREA                  S20201 04455020
         MVI   CONVINP,X'01'           SET M=1                   S20201 04460020
         MVC   CONVINP+7(4),6(R15)     INPUT CCHH FOR CONVERSIONOY01178 04465002
         MVC   DEBSTRCC(8),2(R15)      SET FAKE'S EXTENTS       OY01178 04470002
         MVI   DEBUCBAD+14,X'7F'       SET NUMBER OF TRACKS-     S20201 04475020
         MVI   DEBUCBAD+15,X'FF'       HIGH                      S20201 04480020
         L     R1,IEHMVV30+12          PTR TO TIOT ENTRY         S20201 04485020
         L     R1,12(0,R1)             PTR TO SUB-UCB            S20201 04490020
         SR    R8,R8                    CLEAR REGISTER         @ZM30153 04492003
         ICM   R8,3,0(R1)               BACK                   @ZM30153 04495003
         SLL   R8,4                    TO                        S20201 04500020
         LA    R8,56(R8)               MAIN                      S20201 04505020
         SR    R1,R8                   UCB                       S20201 04510020
         ST    R1,DEBUCBAD             STORE IN FAKE DEB         S20201 04515021
         STM   R10,R13,CONVSAVE        SAVE BASE REGISTERS       S20201 04520020
         STM   R2,R5,CONVSVE2          SAVE DATA REGISTERS       S20201 04525020
         ST    R15,SAVE15              SAVE EXTENT PTR           S20201 04530020
         LA    R2,CONVINP+4            INPUT CCHH FOR CONVERSION S20201 04535020
         LA    R1,CONVSAVE             PTR TO FAKED DEB          S20201 04540020
         L     R15,CVTPTR              PTR TO CVT                S20201 04545020
         USING CVT,R15                 ESTABLISH ADDRESSABILITY  S20201 04550020
         L     R15,CVTPRLTV            EP TO CONVERT RTN         S20201 04555020
         DROP R15                                                S20201 04560020
         BALR  R14,R15                 BRANCH TO CONVERT ROUTINE S20201 04562021
         LM    R10,R13,0(R1)           RESTORE BASES             S20201 04565020
         LM    R2,R5,CONVSVE2          RESTORE DATA REGS         S20201 04570020
         L     R15,SAVE15              RESTORE EXTENT PTR        S20201 04575020
         SRL   R0,16                   SHIFT OUT RN OF TTRN      S20201 04580020
         LR    R6,R0                   GET TT IN PROPER REG      S20201 04585020
         LA    R6,1(R6)                UP IT BY ONE              S20201 04590020
         B     BACK2321                *B TO REGULAR PROCEDURE   S20201 04595020
*                                                                S20201 04600020
*                                                                S20201 04605020
*                                                                S20201 04610020
FINISH   LR    R2,MCTABLE              ADDRESS THE NEW DSCB      S20201 04615020
         TM    DS1SCALO,X'C0'          ALLOCATED IN CYLS       @ZA13789 04620037
         BNO   NOCYL                   NO                      @ZA01734 04620437
         XR    R4,R4                   CLEAR REG4              @ZA01734 04620837
         L     R5,PRIME                PRIMARY FROM ALLOC      @ZA01734 04621237
         LH    R1,DEVCHAR2+10          TO DEV TRACK CAPACITY   @ZA01734 04621637
         DR    R4,R1                   DIV PRIMARY WITH        @ZA01734 04622037
*                                      TO TRACK CAPACITY       @ZA01734 04622437
         LTR   R4,R4                   ANY REMAINDER           @ZA13789 04622537
         BZ    AROUND                  NO, BRANCH              @ZA13789 04622637
         LA    R5,1(R5)                ADD ONE FOR REMAINDER   @ZA13789 04622737
AROUND   MH    R5,DEVCHAR2+10          MULT R5 WITH TO DEV     @ZA13789 04622837
*                                      TRACK CAPACITY          @ZA01734 04623237
         ST    R5,PRIME                NEW PRIMARY ALLOC       @ZA01734 04623637
NOCYL    LR    R2,MCTABLE              ADDRESS THE NEW DSCB    @ZA10937 04623837
         MVC   DADPQ(4),PRIME          PUT PRIMARY QUANTITY    @ZA01734 04624037
*                                      IN TO DSCB              @ZA01734 04624437
         L     R5,SECALLO              GET SEC ALLOC AMOUNT      S20201 04625020
         TM    DS1SCALO,X'80'          TEST ALLOC TYPE           S20201 04630020
         BZ    CALLALLO                *B IF ABSOLUTE OR BLOCKS  S20201 04635020
         TM    DS1SCALO,X'40'          TEST IF CYLS              S20201 04640020
         BZ    SETQ                    *B IF NOT-SET TRACKS      S20201 04645020
         XR    R4,R4                   CLEAR FOR DIVIDE          S20201 04650020
         LH    R1,TRPCYL               GET TRACKS PER CYL        S20201 04655020
         DR    R4,R1                   DIVIDE TO GET CYLS        S20201 04660020
         LTR   R4,R4                   ANY REMAINDER             S20201 04665020
         BZ    *+8                     *B IF NOT                 S20201 04670020
         LA    R5,1(R5)                ADD ONE FOR REMAINDER     S20201 04675020
         ST    R5,SECALLO              SET CYLS BACK             S20201 04680020
SETQ     MVC   DS1SCALO+1(3),SECALLO+1 SET IN NEW DSCB           S20201 04685020
*                                                                S20201 04690020
*                                                                S20201 04695020
*                                                                       05140000
CALLALLO DS    0H                                                       05160000
*                                                                       05180000
         LR    R2,MCTABLE              ADDRESS THE NEW DSCB      S20201 05190021
         TM    IEHMVV10-4,FBLOCKED ANY FIXED BLOCK REBLOCKING           05200000
         BO    CCHBLK                                                   05220000
         TM    IEHMVV10-4,VBLOCKED ANY VARIABLE BLOCKED REBLOCKING      05240000
         BZ    RTNXX               IF NO BRANCH AROUND REBLOCKING ROUTN 05260000
         MVC   DS1BLKL(2),IEHMVV10-10   MOVE IN MAX LRECL AS NEW        05280000
         B     RTNXX                       BLOCKING FACTOR              05300000
CCHBLK   MVC   DS1BLKL(2),DS1LRECL MOVE IN LRECL FFORMAT AS BLOCK FACTR 05320000
RTNXX    DS    0H                                                       05340000
*                                                                       05360000
*                                                                       05380000
****************************************************************        05385002
*                                                              *        05386002
*  TEST IF 'TO'-VOLUME IS MOUNTED, IF NOT PRINT FOLLOWING MSG  *        05387002
*  IEH416I DATA SET XXX NOT MOVED/COPIED BECAUSE UNABLE TO     *        05390002
*  ALLOCATE TO DATA SET                                        *        05392002
*                                                              *        05395002
****************************************************************        05396002
*                                                                       05397002
*                                                                       05401002
         L     R1,IEHMVV31+8           GET PTR TO DDNAME (TIOT) YA01675 05403002
         BCTR  R1,R0                   BACK 2 BYTES TO POINT TO YA01675 05404002
         BCTR  R1,R0                   NO. OF DEVICES REQUESTED YA01675 05407002
         SR    R7,R7                   GET NO OF DEVICES        YA01675 05409002
         IC    R7,0(R1)                REQUESTED.               YA01675 05411002
         LA    R1,14(R1)               STEP TO FIRST DEV. ENTRY YA01675 05412002
         L     R8,IEHMVV23+4           ADDRESS OF 'TO'-VOL LIST YA01675 05413002
FINDUCB  EQU   *                                                YA01675 05414002
         SR    R6,R6                    CLEAR REGISTER         @ZM30153 05414403
         ICM   R6,3,2(R1)               LOAD(SUB-) UCB ADDRESS @ZM30153 05415003
         CLI   3(R8),X'05'             TEST IF UNIT IS 2321     YA01675 05416002
         BE    SUBUCB                  IF 2321 USE SUBUCB       YA01675 05417002
         CLC   28(6,R6),4(R8)          ELSE, COMPARE UCB-VOLSER YA01675*05418002
                                       WITH 'TO'-VOLSER.        YA01675 05419002
         BE    UCBFOUND                IF FOUND, VOL IS MOUNTED YA01675 05420002
NEXTUCB  EQU   *                                                YA01675 05421002
         LA    R1,4(R1)                POINT TO NEXT DEV. ENTRY YA01675 05422002
         BCT   R7,FINDUCB              IF AN UCB TO COMPARE     YA01675 05423002
         B     BALLO                   IF LAST, VOL NOT MOUNTED YA01675 05424002
SUBUCB   EQU   *                                                YA01675 05425002
         CLC   4(6,R6),4(R8)           COMPARE VOLSER IN SUBUCB YA01675*05440002
                                       WITH 'TO'-VOLSER.        YA01675 05443002
         BNE   NEXTUCB                 IF NOT EQUAL BRANCH      YA01675 05446002
****************************************************************        05449002
UCBFOUND EQU   *                                                YA01675 05452002
         ST    R6,IEHMVV31             STORE (SUB-) UCB ADDRESS YA01675 05455002
         LA    R1,IEHMVV31                                              05460000
DDUCB    EQU   14                                                       05480000
*                                                                       05500000
*                                                                       05520000
DIRECT   LA    R0,IEHMVV00             GET ADDRESS OF DSCB         2695 05540017
*                                                                       05560000
*                                                                       05580000
         LA    ACCE,2048           MAKE SIGN NEGATIVE                   05600000
         SLL   ACCE,20             PLACE A ONE IN HIGH ORDER BIT        05620000
         OR    R0,ACCE            ONE BIT INFORMS ALLOCATE THAT ENTRY   05640000
*                                 WAS MADE FROM A UTILITY PROGRAM       05660000
*                                                                       05680000
         TM    IEHMVV20+3,X'04'        RENAME SPEC.            @ZA06516 05683037
         BNO   *+8                     NO BRANCH AROUND        @ZA06516 05686037
         NI    IEHMVV00+93,X'EB'  TURN OFF SECUR BITS          @ZA16483 05690037
         TM    IEHMVV20+1,UNLOAD                                        05700000
         BO    OKUN                                                     05720000
NOWTRY   DS    0H                                                       05740000
         TM    IEHMVV20+4,X'08'        MODEL DSCB INDICATOR ON     2695 05746017
         BC    1,NOWTRY1               YES, BYPASS MOVING NO.EXT'S 2695 05752017
         MVI   DS1NOEPV,X'01'     MOVE NO OF EXTENTS ON VOL INTO DSCB   05760000
NOWTRY1  DS    0H                                                  UL0H 05765017
         L     ACCO,IEHMVV30+8         GET FROM DSCB ADDRESS       UL0H 05770017
         CLI   105(ACCO),X'40'         U.L. TRK FOR FROM DATA SET  UL0H 05775017
         BE    TRKALLO                  YES, ASK FOR U.L. TRK      UL0H 05776017
*                            FROM DEVICE MAY HAVE BEEN U.L. TAPE   UL0H 05777017
         CLC   IEHMVV72(4),ZEROS        WERE HEADER LABELS SAVED   UL0H 05778017
         BNE   TRKALLO                  YES, ASK FOR U.L. TRK      UL0H 05779017
         B     ALLO                     NO, NORMAL ALLOCATE        UL0H 05780017
TRKALLO  DS    0H                                                  UL0H 05782017
         MVI   DS1EXT1,LABALLO         YES, ALLOCATE U.L. TRACK    UL0H 05785017
*                                      FOR 'TO' DATA SET           UL0H 05790017
ALLO     DS    0H                                                       05795019
         TM    IEHMVV10-4,X'08'    IS THE DATA SET UNMOVABLE     A99999 05800019
         BZ    ALLO1               NO.                           A99999 05805019
         OI    DS1DSORG,X'01'      TURN DSCB UNMOVABLE BIT ON.   A99999 05810019
         TM    IEHMVV20+3,X'08'    PREALLOCATED DATA SET ?       S21042 05812021
         BO    DUPNAME+6           YES, BYPASS ALLOCATION        S21042 05814021
ALLO1    TM    82(R12),X'02'           'TO' DATA SET A PDS     @YA02601 05815002
         BNO   ALLO2                   NO ALLOCATE             @YA02601 05815502
         CLC   112(4,R12),ZEROS        YES ANY DIR BLOCKS      @YA02601 05816002
         BNE   ALLO2                   YES ALLOCATE            @YA02601 05816502
         CLC   108(4,R12),ZEROS        NO PRIM QUANTITY ZERO   @YA02601 05817002
         BE    ALLO2                   YES ALLOCATE            @YA02601 05817502
         MVI   IEHMVV61,X'34'          NO PRINT MSG IEH432I    @YA02601 05818002
         B     DIFMES                  GO AND PRINT            @YA02601 05818502
ALLO2    EQU   *                                               @G32DSFS 05819032
**                                                             @G32DSFS 05819632
** IF COPYAUTH IS SPECIFIED ,BUT THE FROM DATA SET IS NOT      @G32DSFS 05819732
** RACF DEFINED THEN NO MODEL WILL BE DONE. HOWEVER            @G32DSFS 05819832
** IF ADSP IS SPECIFIED THEN A RACF DEFINE WILL                @G32DSFS 05819932
** BE DONE. IF NEITHER, GO TO ALLOCATE WITHOUT RACF ACTION.    @G32DSFS 05820032
**                                                             @G32DSFS 05820132
         TM    IEHMVV20+3,X'08'    PREALLOCATED DATA SET ?     @ZM44439 05820232
         BO    DUPNAME+6           YES, BYPASS ALLOCATION      @ZM44439 05820432
         TM    IEHMVV20+5,COPYAUTH     COPYAUTH SPECIFIED      @G32DSFS 05820632
         BZ    ADSPCHK                 NO,BR TO ADSP CHECK     @G32DSFS 05820832
         TM    DS1DSIND,DS1RACDF       IS FROM D.S. RACF DEF   @G32DSFS 05821032
         BO    AUTHCHK                 YES,CHECK AUTHORIZATION @G32DSFS 05821232
**                                                             @G32DSFS 05821432
** CHECK THE JSCB FOR AUTO DATA SET PROTECT                    @G32DSFS 05821632
**                                                             @G32DSFS 05821832
ADSPCHK  EQU   *                       CHECK FOR ADSP          @G32DSFS 05822032
         USING CVT,R15                                         @G32DSFS 05822232
         L     R15,CVTPTR              PTR TO CVT              @G32DSFS 05822432
         L     R15,CVTTCBP             PTR TO TCB WORDS        @G32DSFS 05822632
         L     R15,4(R15)              CURRENT TCB PTR         @G32DSFS 05822832
         USING TCB,R15                                         @G32DSFS 05823032
         L     R15,TCBJSCB             PTR TO JSCB             @G32DSFS 05823232
         USING IEZJSCB,R15                                     @G32DSFS 05823432
         L     R15,JSCBACT             CURRENT JSCB            @G32DSFS 05823632
         NI    NEWDSCB1(R12),X'FF'-DS1RACDF RESET RACF IND.    @G32DSFS 05823832
         TM    JSCBFBYT,JSCBADSP       AUTO DATA SET PROTECT   @G32DSFS 05824032
         BZ    ALLO2B                  NO,GO TO ALLOCATE       @G32DSFS 05824232
         DROP  R15                                             @G32DSFS 05824432
**                                                             @G32DSFS 05824632
** RACF DEFINE                                                 @G32DSFS 05824832
**                                                             @G32DSFS 05825032
DEFINE   EQU   *                       RACF DEFINE             @G32DSFS 05825232
         L     R7,TODS                 SET TO DATA SET AND     @G32DSFS 05825432
         L     R15,TOVOL               VOLUMN ADDR.-4          @G32DSFS 05825632
         LA    R15,4(R15)              ACTIVE TO VOL           @G32DSFS 05825832
         MVC   RACDEF(LRACDEF),MRACDEF MOVE PARM LIST          @G32DSFS 05826032
         RACDEF ENTITY=((R7)),VOLSER=((R15)),MF=(E,RACDEF)     @G32DSFS 05826232
         OI    NEWDSCB1(R12),DS1RACDF  DSCB1 RACF DEFINED      @G32DSFS 05826432
         LTR   R15,R15                 WAS DEFINE SUCCESSFUL   @G32DSFS 05826632
         BZ    ALLO2A                  YES,BR TO ALLOCATE      @G32DSFS 05826832
         CH    R15,RACRET16            VALID RETURN CODE       @G32DSFS 05827032
         BH    BALLO1                  NO BR,UNABLE TO ALLO MSG@G32DSFS 05827232
DIFMESA  EQU   *                       RET=8,NOT AUTHORIZED    @G32DSFS 05827432
         SRL   R15,2                   DIVIDE RET CODE BY 4    @G32DSFS 05827632
         LA    R15,RACFMSGT-1(R15)     ADDR OF ERROR CODE      @G32DSFS 05827832
         MVC   IEHMVV61(1),0(R15)      ERROR CODE TO WORK AREA @G32DSFS 05828032
         B     DIFMES                  BRANCH TO ERROR MSG     @G32DSFS 05828232
**                                                             @G32DSFS 05828432
** CHECK FOR ALTER AUTHORIZATION TO THE MODEL DATA SET         @G32DSFS 05828832
**                                                             @G32DSFS 05828932
AUTHCHK  EQU   *                                               @G32DSFS 05829032
         L     R7,FROMDS               SET FROM DATA SET AND-  @G32DSFS 05829132
         L     R15,FROMVOL             VOLUME -4               @G32DSFS 05829232
         LA    R15,4(R15)              FIRST TO VOL PTR        @G32DSFS 05829332
         MVC   RACHECK(LRACHECK),MRACHECK MOVE PARM LIST       @G32DSFS 05829432
         RACHECK ATTR=ALTER,ENTITY=((R7)), AUTHORIZATION CHECK @G32DSFS*05829532
               VOLSER=((R15)),MF=(E,RACHECK)                   @G32DSFS 05829632
         LTR   R15,R15                 RET = 0,SUCCESSFUL      @G32DSFS 05829732
         BZ    RACMODEL                YES,DO MODEL            @G32DSFS 05829832
         CH    R15,RACRET16            VALID RETURN CODE       @G32DSFS 05829932
         BH    BALLO1                  NO,UNABLE TO ALLO MSG   @G32DSFS 05830032
         CH    R15,RACRET4             DS NOT RACF DEFINED     @G32DSFS 05830132
         BNE   DIFMESA                 NO,ISSUE ERROR MSG      @G32DSFS 05830332
         LA    R15,16                  YES,FORCE MODEL DATA-   @G32DSFS 05830532
         B     DIFMESA                 SET NOT DEFINED MSG.    @G32DSFS 05830732
**                                                             @G32DSFS 05830932
** DO RACF MODEL                                               @G32DSFS 05831032
**                                                             @G32DSFS 05831132
RACMODEL EQU   *                                               @G32DSFS 05831232
         L     R7,FROMDS               ADDR OF FROM DATA SET   @G32DSFS 05831332
         L     R2,FROMVOL              ADDR OF FROM VOLUMN -4  @G32DSFS 05831432
         LA    R2,4(R2)                FIRST FROM VOL PTR      @G32DSFS 05831532
         L     R15,TOVOL               ADDR OF ACTIVE 'TOVOL'-4@G32DSFS 05831632
         LA    R15,4(R15)              TO VOL PTR              @G32DSFS 05831732
         L     R14,TODS                ADDR OF TO DATA SET     @G32DSFS 05831832
         MVC   RACDEF(LRACDEF),MRACDEF MOVE PARM LIST          @G32DSFS 05831932
         RACDEF TYPE=DEFINE,MENTITY=((R7)),MVOLSER=((R2)),     @G32DSFS*05832032
               VOLSER=((R15)),ENTITY=((R14)),MF=(E,RACDEF)     @G32DSFS 05832132
         L     R2,IEHMVV30+8           RESTORE FROM DSCB1 ADDR @G32DSFS 05832232
         OI    NEWDSCB1(R12),DS1RACDF  SET RACF DEFINED        @G32DSFS 05832332
         LTR   R15,R15                 WAS MODEL SUCCESSFUL    @G32DSFS 05832432
         BZ    ALLO2A                  YES,BR TO ALLOCATE      @G32DSFS 05832532
         CH    R15,RACRET16            VALID RETURN CODE       @G32DSFS 05832632
         BH    BALLO1                  RET CODE GT. 16-INVALID @G32DSFS 05832732
         B     DIFMESA                 RET=8,BR TO ERROR MSG   @G32DSFS 05833132
**                                                             @G32DSFS 05833532
** GO TO DADSM ALLOCATE                                        @G32DSFS 05838032
**                                                             @G32DSFS 05838132
ALLO2A   EQU   *                       RESTORE REGS 1 AND 0    @G32DSFS 05838232
         LA    R1,IEHMVV31             RESTORE UCB ADDR REG1   @G32DSFS 05838332
         LA    R0,IEHMVV00             GET ADDRESS OF DSCB     @G32DSFS 05838432
*                                                                       05838532
* TURN ON HIGH ORDER BIT OF REGISTER 0 TO INFORM DADSM         @G32DSFS 05838632
* ALLOCATE THAT ENTRY WAS FROM A UTILITY PROGRAM               @G32DSFS 05838732
*                                                                       05838832
         LA    ACCE,2048               MAKE SIGN NEGATIVE      @G32DSFS 05838932
         SLL   ACCE,20                 SHIFT TO HI ORDER BYTE  @G32DSFS 05839032
         OR    R0,ACCE                 SET BIT IN REG 0        @G32DSFS 05839132
ALLO2B   EQU   *                       NO RACF ACTION          @G32DSFS 05839232
         SVC   32                      ALLOCATION SVC          @G32DSFS 05839332
         LA    RETURN,4                                                 05839532
         SR    LINK,RETURN                                              05840000
         BZ    DUPNAME                                                  05860000
         BM    GOODALLO                                                 05880000
         BP    BALLO                                                    05900000
*                                                                       05906017
*                                                                       05912017
DUPNAME  DS    0H                  PREALLOCATED DATA SET                05920000
         MVC   IEHMVV82+4(3),DS1DSNAM+62 SAVE TTR                S21042 05922021
         TM    IEHMVV20+4,X'08'        MODEL DSCB INDICATOR ON     2695 05925017
         BC    1,DUPMODL               YES, GIVE MSG FOR DUPLICATE 2695 05930017
*                                      NAME ON 'TO' VOLUME         2695 05935017
         TM    DS1DSORG,X'20'          A BDAM DATASET            S20201 05936020
         BNO   DUPNAMES                FROM-DS NOT BDAM          A45147 05937021
         TM    IEHMVV20+1,UNLOAD       FROM-DS BDAM, TEST UNLOAD A45147 05937521
         BNO   BDAMDUP                 CANNOT COPY BDAM IN PREAL A45147 05938021
*                                      DS - NOT ABLE TO TEST FOR A45147 05938521
*                                      EMPTY OR NOT              A45147 05939021
DUPNAMES DS    0H                                                A45147 05939521
         NI    IEHMVV10-4,X'CF'    TURN OFF 2 SWITCHES IN COM REGION    05940000
         TM    IEHMVV20,CATALOGF                                        05960000
     BO   GOODALLO                                                      05980000
         TM    IEHMVV20,PDS        PDS FUNCTION                         06000000
         BO    TSTOB                                             A36065 06020021
         TM    IEHMVV20+2,PHONYTO      PHONY NAME USED                  06040000
         BZ    TSTOB                   NO GO TO OBTAIN TO DS NAME       06060000
         L     ACCE,IEHMVV21+4         YES CREATE NEW PHONY NAME        06080000
         LA    ACCO,43(0,ACCE)                                          06100000
UNDOTR   DS    0H                                                       06120000
         CLI   0(ACCO),C' '                                             06140000
         BNE   UNDOTHIS                                                 06160000
         BCT   ACCO,UNDOTR                                              06180000
UNDOTHIS DS    0H                                                       06200000
         MVI   1(ACCO),C'.'                                             06220000
         MVI   2(ACCO),C'M'                                             06240000
         MVC   IEHMVV00(44),0(ACCE)                                     06260000
         B     CALLALLO                                                 06280000
************************************************************   @ZA01244 06280202
*                                                          *   @ZA01244 06280402
*   WAY OUT IF FOUND DUPLICATE NAME ON TO-VOL AND FROM     *   @ZA01244 06280602
*   DATA SET IS A MODELDSCB.                               *   @ZA01244 06280802
*                                                          *   @ZA01244 06281002
************************************************************   @ZA01244 06281202
DUPMODL  IC    ACCE,IEHMVV61           SAVE CURRENT CODE IN REG    2695 06282017
         MVI   IEHMVV61,X'28'          MOVE IN MSG CODE FOR DUPE   2695 06284017
*                                      NAME ON TO VOLUME WHEN      2695 06286017
*                                      FROM DSET IS MODEL DSCB     2695 06288017
         NI    IEHMVV10-4,X'BF'        TURN OFF SWITCH FOR CLOSE   2695 06290017
*                                      OF 'TO' DCB (NOT OPEN)      2695 06292017
         OI    IEHMVV10-4,X'80'        TURN ON SW TO CLOSE FROM    2695 06294017
         B     DIFMES                  GO TO PREABORT ROUTINE      2695 06296017
TSTOB    DS    0H                                                       06300000
         TM    IEHMVV20+3,X'08'        PREALLOCATED DATA SET ?   S21042 06310021
         BO    GETDSCB                 YES, BYPASS OBTAIN        S21042 06312021
         L     ACCO,IEHMVV31+8         GET PTR TO 'TO' DDNAME    S21042 06314021
         LA    ACCO,0(ACCO)            CLEAR HIGH ORDER BYTE     S21042 06315021
         DEVTYPE (ACCO),INFO,DEVTAB    GET DEVICE CHARACTERISTICSS21042 06316021
         L     ACCO,IEHMVV82+4         GET TTR OF 'TO' DSCB      S21042 06318021
         SRL   ACCO,8                  MOVE R TO RIGHTMOST BYTE  S21042 06318421
         STC   ACCO,CCHHR+4            SAVE R                    S21042 06318821
         SRL   ACCO,8                  MOVE TT TO RIGHTMOST BYTESS21042 06319221
         SR    ACCE,ACCE               CLEAR REG FOR DIVISION    S21042 06319621
         LH    R6,TRCYL                PICK UP NR OF TRKS/CYL    S21042 06319721
         DR    ACCE,R6                 DIVIDE TT BY TRKS/CYL     S21042 06319821
         STH   ACCO,CCHHR              SAVE CC                   S21042 06319921
         STH   ACCE,CCHHR+2            SAVE HH                   S21042 06326621
         LA    ACCO,CCHHR              GET ADDR OF CCHHR         S21042 06328621
         XC    IEHMVV00(4),IEHMVV00    SET UP TO OBTAIN                 06333321
         MVI   IEHMVV00,X'C0'          +INDICATE                 S21042 06340021
         MVI   IEHMVV00+1,X'80'        +SEEK MODE                S21042 06350021
         ST    ACCO,IEHMVV00+4         SET UP PTR TO CCHHR       S21042 06360021
         L     ACCO,IEHMVV23+4                                          06380000
         LA    ACCO,4(ACCO)            SET UP VOL SERIAL                06400000
         ST    ACCO,IEHMVV00+8                                          06420000
         LA    ACCO,IEHMVV00+16                                         06440000
         ST    ACCO,IEHMVV00+12        WORK AREA                        06460000
         OBTAIN   IEHMVV00                                              06480000
         LTR   LINK,LINK               DSCB FOUND                S21042 06500021
         BZ    GOTDSCB                 YES                       S21042 06520021
         B     BALLO                   DSCB NOT FOUND            S21042 06540021
GETDSCB  EQU   *                                                 S21042 06570021
         L     R1,IEHMVV82+12          GET PTR TO DSCB SAVE AREA S21042 06572021
         MVC   IEHMVV00+60(96),16(R1)  MOVE DSCB TO WORK AREA    S21042 06574021
         TM    IEHMVV20+5,X'01'        GETMAIN DONE BY SRV     @ZA24602 06576099
         BNO   GOTDSCB                 NO,SKIP FREEMAIN        @ZA24602 06576899
         FREEMAIN R,LV=120,A=(1)       FREE SAVE AREA            S21042 06577699
         NI    IEHMVV20+5,X'FE'        INDICATE FREEMAIN DONE  @ZA24602 06578499
GOTDSCB  EQU   *                       CHECK PREALLOCATED DATA   A45147 06580021
*                                      SET WITH FROM-DS, TO      A45147 06583021
*                                      ALLOW MOVE-COPY/UNLOAD    A45147 06586021
         TM    DS1DSORG+16-DS1DSNAM(MCTABLE),BDAM  TEST TO-DS DA A45147 06589021
         BO    ACINCOMP                UNABLE TO DETERMINE BDAM  A45147 06592021
*                                      DS EMPTY OR NOT, MSG411   A45147 06595021
         L     ACCO,IEHMVV30+8         LOAD FROM-DSCB ADDRESS    A45147 06598021
         CLI   DS1DSORG-DS1DSNAM(ACCO),X'00' DSORG UNDEFINED   @ZA04409 06598737
         BNE   *+8                     NO GO ON                @ZA04409 06599437
         MVI   DS1DSORG-DS1DSNAM(ACCO),X'40' SET DEFAULT PS    @ZA04409 06600137
         TM    DS1DSORG-DS1DSNAM(ACCO),PSBIT  TEST FROM-DSORG    A45147 06601021
         BO    PSORUNLD                IF PS, CHECK TO-DS PS     A45147 06604021
         TM    IEHMVV20+1,UNLOAD       IF UNLOAD,CHECK TO-DS PS  A45147 06607021
         BNO   FROMPDS                 FROM-DS NOT PS OR BDAM    A45147 06610021
*                                      MUST BE PDS (NO UNLOAD)   A45147 06613021
*                                                                A45147 06616021
PSORUNLD EQU   *                       FROM-DS PS OR TO UNLOAD   A45147 06619021
         TM    DS1DSORG+16-DS1DSNAM(MCTABLE),PDSBIT+BDAM+ISAM    A45147 06622021
*                                       TEST TO-DSORG            A45147 06625021
         BNZ   ACINCOMP                IF NOT PS, MSG411         A45147 06628021
*                                      IF PS COPY IF TO-DS EMPTY A45147 06631021
         CLC   DS1LSTAR+16-DS1DSNAM(3,MCTABLE),NOTUTST           A45147 06634021
         BE    PREALLO                 IF EMPTY, USE DS TO COPY  A45147 06637021
         MVI   IEHMVV61,X'30'          IF NOT EMPTY, MSG428      A45147 06640021
         B     DIFMES                                            A45147 06643021
FROMPDS  EQU   *                       FROM-DS IS PO (NO UNLOAD) A45147 06646021
         CLC   DS1LSTAR+16-DS1DSNAM(3,MCTABLE),NOTUTST           A45147 06649021
         BNE   PSORPDS                 IF TO-DS NOT EMPTY TEST   A45147 06652021
*                                      FOR PS OR PDS             A45147 06655021
         MVI   IEHMVV61,X'2E'          TO-DS EMPTY, MSG424 'NO   A45147 06658021
         B     DIFMES                  DIRECTORY' - NOT COPIED   A45147 06661021
PSORPDS  EQU   *                                                 A45147 06664021
         TM    IEHMVV20,MOVE+VOLUME    CHECK FOR MOVE-VOLUME    YA01219 06667002
         BO    DUPPDS                   IF SO, PDS NOT MERGED    A45147 06670021
         TM    DS1DSORG+16-DS1DSNAM(MCTABLE),PDSBIT              A45147 06673021
         BO    PREALLO                 TO-DS PDS, MOVE/COPY      A45147 06676021
*                                      TO-DS NOT PDS, MSG411     A45147 06679021
MSGNOMOV MVI   IEHMVV61,X'32'                                   OY01172 06680002
         B     DIFMES                                           OY01172 06681002
ACINCOMP EQU   *                                                 A45147 06682021
         MVI   IEHMVV61,X'14'          MSG411 'ACCESS METHOD NOT A45147 06685021
         B     DIFMES                  COMPATIBLE'               A45147 06688021
DUPPDS   MVI   IEHMVV61,X'2C'           MSG 423 DUPLICATE PDS    A45147 06691021
         B     DIFMES                                            A45147 06694021
BDAMDUP  DS    0H                                                A27312 06705019
         MVI   IEHMVV61,X'2A'     SET UP DUP NAME MSG            A27312 06710019
         B     DIFMES                                            A27312 06715019
**                                                             @G32DSFS 06726032
** IF THE ALLOCATION FAILED FOR A RACF DEFINED DATA SET,       @G32DSFS 06726832
** A RACF DELETE WILL BE DONE                                  @G32DSFS 06727632
**                                                             @G32DSFS 06728432
BALLO    DS    0H                                                       06729232
         TM    NEWDSCB1(R12),DS1RACDF  WAS D.S. RACF DEFINED   @G32DSFS 06729432
         BZ    BALLO1                                          @G32DSFS 06729632
         L     R7,TODS                 ADDR OF TO DATA SET     @G32DSFS 06729832
         L     R15,TOVOL               ADDR OF TO VOLUMN -4    @G32DSFS 06730032
         LA    R15,4(R15)              PTR TO 'TOVOL'          @G32DSFS 06730332
         MVC   RACDEF(LRACDEF),MRACDEF MOVE PARM LIST          @G32DSFS 06730632
         RACDEF TYPE=DELETE,ENTITY=((R7)),VOLSER=((R15)),      @G32DSFS*06730932
               MF=(E,RACDEF)                                   @G32DSFS 06731232
         NI    NEWDSCB1(R12),X'FF'-DS1RACDF RESET RACF DEFINED @G32DSFS 06732032
BALLO1   EQU   *                                               @G32DSFS 06734032
         MVI   IEHMVV61,X'1E'                                           06740000
DIFMES   TM    IEHMVV20+3,DUMP         DUMP TO BE GIVEN INSTEAD  S20201 06746020
*                                      OF MESSAGE                S20201 06752020
         BZ    ABORT                   *B IF NOT GIVE MSG        S20201 06758020
         ABEND 4095,DUMP                                         S20201 06764020
ABORT    EQU   *                                                 S20201 06770020
         L     R0,WALENGTH             LENGTH OF AREA TO       @ZA01727 06772037
*                                      BE FREED                @ZA01727 06774037
         FREEMAIN R,LV=(R0),A=(R10)                            @ZA01727 06776037
         TM    IEHMVV20+5,X'01'        GETMAIN DONE BY SRV     @ZA24602 06780099
         BNO   DONTFREE                NO,SKIP FREEMAIN        @ZA24602 06780199
         L     R1,IEHMVV82+12    GET POINTER TO DSCB SAVE AREA @ZA24602 06780299
         FREEMAIN R,LV=120,A=(1)       ISSUE FREEMAIN          @ZA24602 06780399
         NI    IEHMVV20+5,X'FE'        INDICATE FREEMAIN DONE  @ZA24602 06780499
DONTFREE L     ACCO,IEHMVV22+4     ADDRESS OF ACTIVE FROM VOL  @ZA18362 06780599
         LA    ACCO,0(ACCO)            CLEAR HIGH ORDER BYTE   @ZA18362 06781000
         CLI   2(ACCO),X'80'           FROM DEVICE TAPE        @ZA18362 06782000
         BNE   PREAB1                  NO, BRANCH              @ZA18362 06783000
         L     ACCO,IEHMVV30           ADDRESS OF FROM DCB     @ZA18362 06784000
         LA    ACCO,0(ACCO)            CLEAR HIGH ORDER BYTE   @ZA18362 06785000
         TM    48(ACCO),X'10'          FROM DCB OPEN           @ZA18362 06786000
         BNO   PREAB1                  NO, BRANCH              @ZA18362 06787000
         OI    IEHMVV10-4,X'80'        SET TO CLOSE IN SRY     @ZA18362 06788000
PREAB1   L     LINK,PREAB                                      @ZA18362 06789000
         BR    LINK                GO TO PREABORT ROUTINE               06800000
OKUN     DS    0H                                                       06820000
         LR    ACCE,PASSA                                               06840000
     MVI   DS1DSORG,X'00'                                               06860000
         MVC   DS1DSORG+1(12),DS1DSORG  ZERO DSORG FIELD OF DSCB        06880000
         B     NOWTRY                                                   06900000
NOTUTST   DC   X'000000'                                                06920000
*                                                                       06940000
*                                                                       06960000
         DS    0H                                                       06980000
*                                                                       07000000
YPDS     DS    0H                                                       07020000
         TM    IEHMVV20+1,LOAD     LOAD CONDITION                       07040000
         BO    YLOAD               YES                                  07060000
*                                  NO                                   07080000
         L     15,BERT             GO TO DIRECTORY DEPHONKER            07100000
         BALR  14,15                                                    07120000
         LH    ACCE,IEHMVV25       GET DIRECTORY COUNT                  07140000
         LTR   15,15         ERROR FROM DIRECTORY DEPHONKER        7491 07160000
         BNZ   DIFMES                  *B IF YES                 S20201 07200020
AFTERB   DS    0H                                                       07240000
         TM    IEHMVV20,PDS        PDS KEYWORD                          07260000
         BO    YPDSS                    YES, GO TO USE EXPAND           07280000
AFTERPDS DS    0H                                                       07300000
         TM    IEHMVV20+1,UNLOAD   UNLOAD CONDITION                     07320000
         BO    YUNLOAD             YES, GO TO CONSTRUCT UNLOAD DSCB     07340000
         ST    ACCE,DADDQ-DS1DSNAM(0,MCTABLE)  REQUEST DIRECTORY S20201 07350020
*                                              SPACE             S20201 07360020
         B     AFTERSCK                                                 07380000
YLOAD    DS    0H                                                       07400000
         LH    ACCE,IEHMVV25       DIRECTORY COUNT                      07420000
         B     AFTERB                                                   07440000
YPDSS    DS    0H                                                       07460000
         AH    ACCE,IEHMVV25+2          GET EXPAND                      07480000
         B     AFTERPDS                                                 07500000
YUNLOAD  DS    0H                                                       07520000
         MVI   IEHMVV10-4,X'04'        RELEASE UNUSED SPACE    @ZA30700 07530099
         STH   ACCE,IEHMVV25                                            07540000
         B     AFTERSCK                                                 07560000
ZEROS    DC    2F'0'                   DOUBLE WORD OF HEX ZEROS    2695 07580017
DEACTIVE EQU   X'00'                                               UL0H 07584017
ACTIVOHL EQU   X'02'                                               UL0H 07588017
ACTIVITL EQU   X'03'                                               UL0H 07592017
ACTIVOTL EQU   X'04'                                               UL0H 07596017
BERT     DC    A(IEHMVETC)                                              07600000
ADMSG    DC    A(MSG)                                                   07620000
         EXTRN MSG                                                      07640000
PREALLOS DS    0H                                                       07660000
         MVC   DS1RECFM(1),IEHMVV00+84  SAVE RECFM IN FROM DSCB    UL0H 07665017
         MVC   IEHMVV31(1),DS1RECFM      AND IN 1ST BYTE OF TO     UL0H 07670017
*                                         DCB POINTER              UL0H 07675017
         B     PREALLOX                 INDICATE PREALLOCATION     UL0H 07690017
PREALLO  DS    0H                                                       07700000
         TM    IEHMVV20,PDS            TEST FOR PDS              A36065 07702021
         BO    PREALLOS                                          A36065 07704021
         MVC   IEHMVV74(1),DS1EXT1+16   SAVE UL TRK INDIC TO BE@ZA31059 07706099
*                                        DESTROYED IN MSG WRITE    UL0H 07710099
         MVC   IEHMVV31(1),DS1RECFM+16  SAVE RECFM IN 1ST BYTE @ZA31059 07714099
*                                       OF  POINTER TO TO DCB      UL0H 07724032
PREALLOX OI    IEHMVV20+3,PREALBIT        TURN ON PREALLOCATE BIT  UL0H 07730017
         IC    ACCE,IEHMVV61                                            07740000
         MVI   IEHMVV61,X'03'                                           07760000
         L     LINK,ADMSG                                               07780000
         BALR  RETURN,LINK         GO TO MESSAGE WRITER                 07840000
         STC   ACCE,IEHMVV61                                            07860000
         CLI   IEHMVV74,LABALLO         U.L. TRK FOR 'TO' DATA SET UL0H 07875717
         BE    YTAPE                    YES, ACTIVATE EXITS        UL0H 07876417
         B     GOODALLB                 NO, CHECK FURTHUR          UL0H 07877217
GOODALLO DS    0H                                                  UL0H 07878017
         MVC   IEHMVV82+4(3),DS1DSNAM+62 SAVE TTR                S21042 07880021
         CLI   DS1EXT1,LABALLO          U.L. TRK FOR 'TO' DATA SET UL0H 07881017
         BE    YTAPE                   YES, ACTIVATE EXITS         UL0H 07884017
*                                                                       07885017
GOODALLB DS    0H                                                  UL0H 07886017
         CLC   IEHMVV72(4),ZEROS        WERE HEADER LABELS SAVED   UL0H 07912217
         BE    NORMEXIT                 NO, NORMAL EXIT            UL0H 07912817
         B     RELCORE                  YES, FREE CORE AND GIVE MSGUL0H 07913417
YTAPE2   NI    IEHMVV20+4,X'F7'        SET MODEL DSCB SW OF    @YA01681 07913502
YTAPE1   NOP   0(0)                                            @YA01720 07913702
YTAPE    DS    0H                                                  UL0H 07914002
         CLC   IEHMVV72(4),ZEROS        WERE HEADER LABELS SAVED   UL0H 07915017
         BE    TAPEPRO                  NO, CONTINUE               UL0H 07916017
         MVI   UDCBOHLE,ACTIVOHL       ACTIVATE EXIT LIST          UL0H 07917017
TAPEPRO  DS    0H                                                  UL0H 07920017
         MVI   UDCBITLE,ACTIVITL       ACTIVATE EXIT LIST          UL0H 07923017
NORMEXIT LA    PASSB,3                                             UL0H 07926017
         EJECT                                                          07940000
PROCEED  DS    0H                                                       07960000
         L     R0,WALENGTH             LENGTH TO FREE            S20201 07970020
         FREEMAIN R,LV=(R0),A=(R10)                              S20201 07980020
*                                                                       08000000
       IEHPOST  (14,1),TFC,                                             08020000
         RETURN (14,12),T                                               08030017
*                                                                  UL0H 08044017
*   DIRECT ACCESS OUTPUT DEVICE AND NO LABEL TRACK ALLOCATED       UL0H 08048017
*                                                                  UL0H 08052017
RELCORE  DS    0H                                                  UL0H 08056017
         L     M6,IEHMVV72             GET ADDR OF GOTTEN CORE     UL0H 08060017
         FREEMAIN  R,LV=640,A=(M6)     FREE GOTTEN CORE            UL0H 08064017
SETFLGS  MVI   IEHMVV72+11,X'FF'       SET FLAG TO SHOW MSG        UL0H 08068017
*                                      REQUEST IS FROM VSSX        UL0H 08072017
         MVI   IEHMVV72+10,X'FF'       SET DA+NLT FLAG TO SHOW     UL0H 08076017
*                                      U.L. TRK NOT ALLOCATED      UL0H 08080017
         MVI   IEHMVV72+14,X'FF'       SET FLAG FOR VESN TO PUT    UL0H 08084017
*                                      OUT NO U.L. TRK MESSAGE     UL0H 08088017
         B     PROCEED                 RETURN TO VSRY FOR ROUTING  UL0H 08092017
*                                                                  UL0H 08096017
SAVEREG1 DS    F                       SAVE AREA FOR REG1       YA01684 08098002
SAVEREG0 DS    F                       SAVE AREA FOR REG0      @ZA07399 08098137
DV       DS    D                       CONVERSION AREA          YA01684 08098202
INFO     DS    0CL20                   +                         S21042 08098421
         DS    CL10                    +DEVICE TYPE              S21042 08098821
TRCYL    DS    CL2                     +CHARACTERISTICS          S21042 08099221
         DS    CL8                     +                         S21042 08099621
CCHHR    DS    CL5                     ABS ADDR OF 'TO' DSCB     S21042 08099721
PREAB    DC    A(PREABORT)                                         UL0H 08100017
         EXTRN  PREABORT                                           UL0H 08104017
WALENGTH DC    A(ENDWA-WORKAREA)       DEFINE WORKAREA LENGTH    S20201 08112020
DEFAULT1 DC    F'72500'                DEFAULT PRIMARY           S20201 08120020
DEFAULT2 DC    F'36250'                DEFAULT SECONDARY         S20201 08128020
DEFBLK   DC    H'160'                  ARBITRARY DEFAULT         S20201 08136020
HW1      DC    H'1'                                              S20201 08140021
CONST    DC    F'2'                                            @YA02566 08140502
DW       DS    D                                                OY01172 08141002
TIMEDATE DS    3C                                               OY01172 08142002
DSCBDATE DS    3C                                               OY01172 08143002
CAMLST1  CAMLST SEEK,0,0,0             OPTION BYTES FOR SEEK     S20201 08144020
*** RACF VERSION 2 EQUATES AND DECLARES                        @G32DSFS 08144432
RACFMSGT EQU   *                       RACF MESSAGE TABLE      @G32DSFS 08144832
         DC    X'36'                   PREVIOUSLY DEFINED      @G32DSFS 08145232
         DC    X'38'                   UNAUTHORIZED            @G32DSFS 08145632
         DC    X'1E'                   INVALID RET CODE        @G32DSFS 08146032
         DC    X'3A'                   MODEL NOT RACF DEFINED  @G32DSFS 08146432
ENDTAB   EQU *                         END RACF MSG TABLE      @G32DSFS 08146832
COPYAUTH EQU   X'10'                   COPYAUTH KEYWORD        @G32DSFS 08148032
DS1RACDF EQU   X'40'                   DSCB1 RACF BIT          @G32DSFS 08148432
RACRET4  DC    H'4'                    RACF RETURN CODE 4      @G32DSFS 08148832
RACRET16 DC    H'16'                   RACF RETURN CODE 16     @G32DSFS 08149232
MRACDEF  RACDEF DSTYPE=N,CLASS='DATASET',    RACDEF PARM LIST  @G32DSFS*08149632
               MF=L                                            @G32DSFS 08150032
LRACDEF  EQU   *-MRACDEF                                       @G32DSFS 08150432
MRACHECK RACHECK CLASS='DATASET',MF=L        RACHECK PARM LIST @G32DSFS 08150832
LRACHECK EQU   *-MRACHECK                                      @G32DSFS 08151232
         DC    CL50'CE PATCH AREA - 50 BYTES'                    S20201 08152020
         EJECT                                                          08160020
WORKAREA DSECT                                                   S20201 08168020
DEFSW    DS    CL1                                               S20201 08176020
FIRSTEXT DS    CL1                     X'FF',WHEN SCAN OF EXT1  OY01178 08180002
UNLOADSW DS    XL1                     X'80' WHEN SPACE QUANTITYYA01193*08181002
                                         ONLY REQUIRED FOR UNLD.YA01193 08182002
DEVCHAR  DS    5F                                                S20201 08184020
DEVCHAR2 DS    5F                                                S20201 08192020
SECSAVE  DS    F                       TO SAVE SECALLO FOR BDAM OY01178 08196002
SECALLO  DS    F                                                 S20201 08200020
PRIME    DS    F                                                 S20201 08208020
* THE NEXT SEVEN WORDS ARE BEING REUSED BY RACDEF AND RACHECK  @G32DSFS 08212032
ALIGN    DS    2F                                                S20201 08216020
RACDEF   EQU   ALIGN                   REUSE CAMLIST AREA      @G32DSFS 08218032
RACHECK  EQU   RACDEF                  REUSE CAMLIST AREA      @G32DSFS 08220032
CAMLIST  DS    4F                                                S20201 08224020
CONVSVE2 DS    4F                                                S20201 08232020
SAVE15   DS    F                                                 S20201 08240020
CONVSAVE DS    4F                                                S20201 08248020
CONVINP  DS    4F                                                S20201 08256020
DEBUCBAD DS    F                                                 S20201 08264020
         DS    H                                                 S20201 08272020
DEBSTRCC DS    CL8                                               S20201 08280020
         DS    H                                                 S20201 08288020
         DS    H                                                OY01178 08290002
EXTENTS  DS    CL26                                             OY01178 08292002
FT3DSCB  DS    CL350                                             S20201 08296020
ENDWA    EQU   *                                                 S20201 08304020
         EJECT                                                          08312020
UNITCHAR DSECT                                                   S20201 08320020
DEVTYPE  DS    F                                                 S20201 08328020
         DS    H                                                 S20201 08336020
TRACKCAP DS    H                                                 S20201 08344020
CYLPDEV  DS    H                                                 S20201 08352020
TRPCYL   DS    H                                                 S20201 08360020
TRLENGTH DS    H                                                 S20201 08368020
OVHCNT   DS    H                                                 S20201 08376020
KEYOVHD  DS    C                                                 S20201 08384020
OVHIND   DS    C                                                 S20201 08392020
TOLERANC DS    H                                                 S20201 08400020
         EJECT                                                 @G32DSFS 08402032
         IECDSECS TCB,JSCB,EXPAND=YES                          @G32DSFS 08404032
         EJECT                                                          08408020
CVT      DSECT                                                   S20201 08416020
         CVT                                                            08424020
         IEHMVV                                                         08460000
FROMVOL  EQU   IEHMVV22                ADDR OF FROMVOL -4      @G32DSFS 08461032
TOVOL    EQU   IEHMVV23+4              ADDR OF TOVOL -4        @G32DSFS 08462032
FROMDS   EQU   IEHMVV21                ADDR OF FROM DATA SET   @G32DSFS 08464032
TODS     EQU   IEHMVV21+4              ADDR OF TO DATA SET     @G32DSFS 08465032
         ORG   IEHMVV70                                                 08466020
         IEHDCBXL                                                       08472020
FT1DSCB  DSECT                                                   S20201 08482020
         IECSDSL1 (1)                                                   08500000
         ORG   DS1EXT1+3                                                08520000
DADPQ    DS    F                                                        08540000
DADDQ    DS    F                                                        08560000
DASD     EQU   X'20'                                                    08580000
NEWDSCB1 EQU   DS1DSIND-DS1DSNAM       OFFSET TO RECEIVING DSCB@G32DSFS 08600032
         END                                                            11600032
