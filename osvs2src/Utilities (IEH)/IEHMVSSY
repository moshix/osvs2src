 TITLE 'IEHMVSSY-ROUTING AND ERRORS FOR IEHMOVE LOAD MODULE ESY'        00010017
 TITLE 'IEHMVSSY-ROUTING AND ERRORS FOR IEHMOVE LOAD MODULE ESY'        00020017
*TITLE -IEHMVSSY                                                        00030017
*FUNCTION/OPERATION: MODULE IEHMVSSY HANDLES THE WRITING OF THE FIRST * 00040000
*RECORDS OF AN UNLOADED DATA SET AND MAKES THE DECISION OF WHICH IS   * 00060000
*TO BE GIVEN CONTROL TO DO THE ACTUAL MOVE/COPY OPERATION             * 00080000
*THIS CSECT HANDLES ABNORMAL CLOSES IF PREABORT IS DEMANDED AS THE    * 00083017
*RESULT OF ERRORS.  NO USER LABELS ARE PROCESSED DURING THESE ABNORMAL* 00086017
*TERMINATIONS.  FOR VARIABLE SPANNED RECORDS, THIS MODULE WILL IDEN-  * 00089017
*TIFY THIS FORMAT AND USE THIS ANALYSIS TO DETERMINE THE NEXT MODULE  * 00092017
*TO BE GIVEN CONTROL.                                                 * 00095017
*ENTRY POINTS: IEHMVESY                                               * 00100000
*INPUT: MOVE/COPY COMMUNICATIONS TABLE                                * 00120000
*OUTPUT: UNLOADED DATA SET HEADER RECORDS                             * 00140000
*EXTERNAL ROUTINES: BALR TO IEHMVSRM FOR UNLOADED WRITES              * 00148017
*                   LINK TO IEHMVLSU FOR MESSAGE WRITING              * 00156017
*                   BALR TO IEHMVSRX TO BUILD DCB'S                   * 00164017
*                   XCTL TO IEHMVESK FOR I/O ERRORS                   * 00172017
*EXITS-NORMAL DETERMINED AT EXECUTION TIME FROM TYPE OF REQUEST       * 00180000
*ERRORS: NONE                                                         * 00200000
*TABLES/WORKAREAS: MOVE/COPY COMMUNICATIONS TABLE                     * 00220000
*ATTRIBUTES: REUSEABLE                                                * 00240000
*NOTES: PART OF LOAD MODULE-IEHMVESY                                  * 00260000
*                                                                       00280002
*                                                                       00290002
IEHMVSSY CSECT                                                 @YA01681 00300002
*                                                                       00310002
*D017450-017550,019630-019750                                  @YA02612 00312002
*A024860-024920,030650-030750                                  @YA02605 00315002
*A072340-072370,110700                                         @YA01681 00320002
*D072340                                                       @YA01681 00330002
*                                                                       00340102
*D035400-047400,115600-116120                                   YA01193 00340202
*A035400-044400                                                 YA01193 00340302
*C053200                                                         A44360 00340421
*                                                                A30505 00341019
*                                                                A29052 00342019
*086200                                                          A18773 00345018
*3387000200,001600,003500,069400,069800,076800,077600,077760,078800VS0H 00350017
*019690,021200,028000,057850-058300,059300-059700                 19030 00352019
*--ANY STATEMENTS FLAGGED 19030 PERTAIN TO VARIABLE SPANNED RECORD--    00354019
*--SUPPORT FOR BDAM DATA SETS                                           00356019
*                                                                       00360000
*                                                                       00380000
IEHMVESY SAVE  (14,12),T,SSY-V2-L1                                      00400000
         ENTRY IEHMVESY                                                 00420000
*                                                                       00440000
*              REGISTERS                                                00460000
*                                                                       00480000
PASSA    EQU   0                                                        00500000
PASSB    EQU   1                                                        00520000
R0       EQU   0                                                        00525013
R1       EQU   1                                                        00530013
R15      EQU   15                                                       00535013
R2       EQU   2                                                        00540000
R3       EQU   3                                                        00560000
ACCE     EQU   4                                                        00580000
ACCO     EQU   5                                                        00600000
BASE     EQU   6                                                        00620000
R7       EQU   7                                                        00640000
R8       EQU   8                                                        00660000
R9       EQU   9                                                        00680000
R10      EQU   10                                                       00700000
R11      EQU   11                                                       00720000
MCTABLE  EQU   12                                                       00740000
SAVE     EQU   13                                                       00760000
RETURN   EQU   14                                                       00780000
LINK     EQU   15                                                       00800000
*                                                                       00820000
ANYSEL   EQU   X'02'                                                    00840000
BLANK    EQU   C' '                                                     00860000
BLOCKED  EQU   X'10'                                                    00880000
DSGROUP  EQU   X'10'                                                    00900000
FIXED    EQU   X'80'                                                    00920000
FVOLUME  EQU   X'80'                                                    00940000
NOTMOVE  EQU   X'80'                                                    00960000
ODD      EQU   X'01'                                                    00980000
ONES     EQU   X'FF'                                                    01000000
UDSORG   EQU   X'04'                                                    01020000
UNLOADM  EQU   X'7F'                                                    01040000
UNMOVE   EQU   X'08'                                                    01060000
U        EQU   X'C0'              RECFM UNDEFINED                  9373 01070013
F        EQU   X'80'              RECFM FIXED                      9373 01080013
V        EQU   X'40'              RECFM VAR                        9373 01090013
FB       EQU   X'90'              RECFM FIXED BLOCKED              9373 01100013
VB       EQU   X'50'              RECFM VAR BLOCKED                9373 01110013
VS       EQU   X'48'              RECFM VARIABLE SPANNED           VS0H 01113017
VBS      EQU   X'58'              RECFM VARIABLE BLOCKED SPANNED   VS0H 01116017
VOLUME   EQU   X'02'                                                    01120000
ZERO     EQU   X'00'                                                    01140000
DEACTIVE EQU   X'00'                                               UL0H 01150017
*                                                                       01160000
BASESET  BALR   BASE,0                                                  01180000
    USING  *,BASE                                                       01200000
BB       DS    0H                                                       01220000
         USING IEHMVV,MCTABLE                                           01240000
*                                  PROCESS                              01260000
*                                       CALL BUILD DCB AND GO TO DADSM  01280000
    IEHPRE  (14,1),TFC,                                                 01300000
*                                                                       01320000
         L     LINK,BUILDDCB            GET ADDRESS                     01340000
         BALR  RETURN,LINK              BRANCH                          01360000
*                                                                       01380000
*                                                                       01400000
*                                                                       01420000
*                                  SET UP TO SEARCH DSORG TABLE         01440000
         L     ACCE,IEHMVV30+8          GET ADDR OF DSCB                01460000
         LA    ACCO,DSORGTAB                                            01480000
*                                                                       01500000
*                                  TURN OFF UNMOVEABLE                  01520000
DSLOOP   DS    0H                                                       01540000
         CLC   0(2,ACCO),FILETYPE(ACCE) COMPARE DSORG WITH TABLE        01560000
*                                                                       01580000
         BE    EQDSORG                  EQUAL                           01600000
         LA    ACCO,4(ACCO)             INCREMENT COMPARE               01620000
         CLI   0(ACCO),ONES                                             01640000
         BNE   DSLOOP                   NO                              01660000
*                                       YES, ERROR CONDITION            01680000
*        MESSAGE                                                        01700000
         MVI   IEHMVV61,UDSORG                                          01720000
         B     PREAB1                                                   01740000
*                                                                       01760000
*                                                                       01780000
EQDSORG  DS    0H                                                       01800000
         LA    R3,PATIS                TEST FOR ISAM ORGANIZATION       01820000
         CR    R3,ACCO                 BY CHECKING POINTER TO           01840000
         BNE   *+12                    DSORG TABLE - BRANCH IF NOT      01860000
         MVI   IEHMVV61,32             PRINT A MESSAGE IF IT IS ISAM    01880000
         B     PREAB1                  AND SKIP THE DATASET             01900000
         SR    R3,R3                    GET XCTL TABLE DISPLACEMENT     01920000
         IC    R3,3(0,ACCO)                                             01940000
*                                                                       01960000
         TM    IEHMVV20,CATALOG         CATALOG FUNCTION                01980000
         BO    TCAT                     YES                             02000000
*                                       NO                              02020000
*                                                                       02040000
         TM    IEHMVV20+2,ANYSEL                                        02060000
         BO    SELECT                                                   02080000
*                                                                       02100000
TST20    TM    IEHMVV20+1,BOTH     BOTH LOAD AND UNLOAD           19030 02120019
         BO    YESBOTH                  YES                             02140000
*                                       NO                              02160000
         TM    IEHMVV20+1,LOAD          ONLY LOAD                       02180000
         BO    YESLOAD                  YES                             02200000
*                                       NO                              02220000
         TM    IEHMVV20+1,UNLOAD        UNLOAD ONLY                     02240000
         BO    YESUNLD                  YES                             02260000
         B     XCTLEXEC                 NO                              02280000
*                                                                       02300000
SELECT   DS    0H                                                       02320000
         LA    R3,GOSELECT(0,0)                                         02340000
    B  XCTLEXEC                                                         02360000
GOSELECT EQU    30                                                      02380000
TCAT     DS    0H                                                       02400000
         L     ACCE,IEHMVV23+4          TO DEVICE DIRECT ACCESS         02420000
         CLI   2(ACCE),DASD                                             02440000
         BE    OKCAT                    YES                             02460000
         OI    IEHMVV20+1,UNLOAD        NO, UNLOAD                      02480000
         TM    IEHMVV20+5,X'40'        UNLOAD REQUEST          @YA02605 02486002
         BO    *+12                    YES DO NOT PRINT MSG    @YA02605 02492002
         MVI   IEHMVV61,X'01'           INDICATE MESSAGE                02500000
     BAL   RETURN,MSG                                                   02520000
         TM    IEHMVV20+1,LOAD          LOAD ALSO                       02540000
         BO    LUCAT                    YES                             02560000
         LA    R3,DAVEBRCE              NO                              02580000
DAVEBRCE EQU   28                                                       02600000
         B     UNCAT                                                    02620000
OKCAT    DS    0H                                                       02640000
         LA    R3,DAVEBRCE              SET UP TO GO TO CATALOG         02660000
         TM    IEHMVV20+1,LOAD          LOAD CONDITION                  02680000
    BZ   *+8                                                            02700000
         LA    R3,LOADCAT               YES, SET UP XCTL ROUTE          02720000
LOADCAT  EQU   26                                                       02740000
         B     XCTLEXEC                                                 02760000
*                                                                       02780000
YESBOTH  TM    26(ACCE),X'20'      TEST FOR BDAM DSORG            19030 02790019
         BC    1,*+8               IT IS BDAM WE'RE SET FOR 'STL' 19030 02800019
         LA    R3,LUDIS(0,0)       SET TO XCTL TO 'ERA'           19030 02810019
LUCAT    EQU   YESBOTH                                                  02820000
LUDIS    EQU   24                                                       02840000
         CLI   IEHMVV61,ZERO       IS THERE A MESSAGE TO BE PRINTED3826 02846018
         BE    *+8                 NO SKUP MESSAGE WRITER          3826 02852018
         BAL   RETURN,MSG               GO TO MSG WRITER                02860000
         B     XCTLEXEC                                                 02880000
YESLOAD  EQU   *                                                        02900000
         LA    R3,LOADDIS(R3)           SET UP XCTL TAB FOR LOAD        02920000
LOADDIS  EQU   4                                                        02940000
         B     XCTLEXEC                                                 02960000
YESUNLD  DS    0H                                                       02980000
         CLI   IEHMVV61,ZERO       IS THERE A MESSAGE ?          A29052 02986019
         BE    UNWRITE             NO.                           A29052 02992019
         BAL   RETURN,MSG                                               03000000
UNWRITE  DS    0H                                                       03020000
         LA    R3,UNLDDIS(R3)           SET UP XCTL TABLE FOR UNLOAD    03040000
UNCAT    DS    0H                                                       03060000
         TM    IEHMVV20+5,X'40'        UNLOAD REQUEST          @YA02605 03065002
         BNO   *+8                     NO BRANCH AROUND        @YA02605 03070002
         NI    IEHMVV41+13,X'FE'       YES RESET RETURN CODE   @YA02605 03075002
*                                                                       03080000
*                                                                       03100000
***** WRITE FIRST RECORD OF UNLOADED DATA SET *****                     03120000
         LA    REG0,1(0,0)                                              03140000
         LNR   REG0,REG0               SET UP REGISTER FOR BWRITE RTN   03160000
         LA    REG1,UNLREC1            ADDR OF RECORD                   03180000
         BAL   REG2,UNLWRT                                              03200000
***** WRITE DSCB ON UNLOADED DATA SET *****                             03220000
         L     REG2,IEHMVV30+8         DSCB ADDR                        03240000
         LR    REG1,MCTABLE                                             03260000
         USING UNLDLLI,REG1                                             03280000
         MVC   IECSDSL1(140),0(REG2)   COPY THE DSCB INTO RECORD        03300000
         MVC   UNLDLLI(3),UNLKDS       SET UP LLI IN RECORD             03320000
         MVC   UNLDDIR(2),IEHMVV25     COPY THE DIRECTORY QUANTITY      03340000
         MVI   UNLDFLAG,X'00'          SET THE OLD UNLOAD FLAG          03360000
         SPACE 1                                                        03380000
         L     ACCO,IEHMVV30+12        GET THE 'FROM' DDNAME            03400000
         LA    ACCO,0(ACCO)            STRIP OFF HI-ORDER BYTE    S2021 03410020
         DEVTYPE (ACCO),DEVCHAR,DEVTAB GET THE 'FROM' CHARACTERISTICS   03420000
         LR    REG1,MCTABLE                                             03440000
         MVC   UNLDDEVT(4),DEVCHAR      SAVE ORIGINAL DEVICE TYPE       03460000
         CLI   DEVCHAR+2,X'20'         TEST 'FROM' DEVICE FOR D.A.      03480000
         BNE   PATCH2                  BRANCH IF NOT D.A.               03500000
         MVI   UNLDFLAG,X'40'          SET THE NEW UNLOAD FLAG          03520000
         L     ACCO,IEHMVV85           GET PTR TO INFORMATION   YA01193*03540002
                                         PASSED FROM IEHMVSSX   YA01193 03840002
         MVC   UNLDSIZE(8),0(ACCO)     SET PRIM. AND SEC. SIZE  YA01193 04140002
         XC    UNLDSPAR(42),UNLDSPAR   ZERO OUT UNUSED BYTES    YA01193 04440002
         SPACE 3                                                        04760000
PATCH2   DS    0H                                                       04780000
         LR    REG1,MCTABLE             WRITE OUT HEADER RECORD         04800000
         LA    REG0,1                                                   04820000
         TM    IEHMVV10-4,UNMOVE                                        04840000
    BZ   AZBY                                                           04860000
       OI    145(REG1),X'80'        SET UNLOAD UNMOVEABLE SWITCH        04880000
AZBY     DS    0H                                                       04900000
         LA    REG0,0(0,0)                                              04920000
         BAL   REG2,UNLWRT                                              04940000
UNLRET   DS    0H                                                       04960000
         B     THISUN                                                   04980000
UNLWRT   L     REG15,ADBWRT            ADDR OF BWRITE RTN               05000000
         BALR  REG14,REG15                                              05020000
         LTR   REG15,REG15             IO ERROR                         05040000
         BH    UNLIO                                                    05060000
         BR    REG2                                                     05080000
UNLIO    EQU   *                                                        05100000
         MVI   IEHMVV61,X'06'                                           05120000
         B     PREAB1                                                   05140000
***** CONSTANTS *****                                                   05160000
UNLREC1  DC    FL2'75'                                                  05180000
         DC    X'0E'                                                    05200000
         DC    CL32'THIS IS AN UNLOADED DATA SET PRO'                   05220000
         DC    CL8'DUCED BY'                                            05240000
         DC    X'80'                                                    05260000
         DC    CL32'THE IBM UTILITY, SYSMOVE.OMMBRLD'                   05280000
         DC    CL2'WB'                                                  05300000
UNLKDS   DC    X'00C500'                                         A44360 05320021
ADBWRT   DC    A(IEHMVERM)                                              05340000
         EXTRN IEHMVERM                                                 05360000
         ENTRY UNLREC1                                                  05380000
***** REGISTER DESIGNATION *****                                        05400000
REG0     EQU   0                                                        05420000
REG1     EQU   1                                                        05440000
REG2     EQU   2                                                        05460000
REG12    EQU   12                                                       05480000
REG14    EQU   14                                                       05500000
REG15    EQU   15                                                       05520000
THISUN   EQU   *                                                        05540000
UNLDDIS  EQU   2                                                        05560000
         B     XCTLEXEC                                                 05580000
*                                                                       05600000
*                                                                       05620000
XCTLEXEC EQU   *                                                        05640000
*                                                                       05660000
*                                                                       05700000
XCTLREEN DS    0H                                                       05720000
*                                                                       05740000
         LA    R3,XCTLTAB(R3)                                           05760000
         CLI   0(R3),ONES          XCTL OR BRANCH                       05780000
         BE    BRTO                    BRANCH, NOT XCTL            VS0H 05782017
         B     XCTLPRE             XCTL TO MODULE                 19030 05802019
*                                                                  VS0H 05835017
XCTLPRE  MVC   ENTMOD(2),0(R3)          SETUP XCTL NAME                 05840000
XCTL     DS    0H                                                       05860000
       IEHPOST (14,1),TFC,                                         9373 05870013
*                                                                       05880000
         L     14,12(0,13)                                              05900000
         XCTL  (2,12),EPLOC=MODNAME                                     05920000
BRTO     DS    0H                                                       05980000
*                                            IN THIS LOAD MODULE        06000000
         SR    ACCE,ACCE                                                06020000
         IC    ACCE,1(R3)                                               06040000
         L     LINK,BRANCHTO(ACCE)                                      06060000
         BALR  RETURN,LINK              GO TO ROUTINE                   06080000
*                                                                       06100000
         LA    ACCO,BRANCHTO(ACCE)                                      06120000
         MVC   ENTMOD(2),6(ACCO)                                        06140000
         B     XCTL                     BRANCH TO XCTL ROUTINE          06160000
BUILDDCB DC    A(IEHMVESX)                                              06180000
         EXTRN IEHMVESX                                                 06200000
FILETYPE EQU   X'52'                                                    06220000
PS       EQU   X'02'                                                    06240000
BOTH     EQU   X'03'                                                    06260000
         DS    0D                                                       06280000
MODNAME  DC    CL6'IEHMVE'                                              06300000
ENTMOD   DS    CL2                                                      06320000
         DS    0F                                                       06340000
DSORGTAB DS    0H                                                       06360000
         DC    X'4000'                  PHYSICAL SEQUENCIAL             06380000
         DC    H'0'                                                     06400000
         DC    X'0000'                                                  06420000
         DC    H'0'                                                     06440000
         DC    X'2000'                  BDAM                            06460000
         DC    H'6'                                                     06480000
PATIS    DC    X'8000'                 ISAM DSORG                       06500000
         DC    H'0'                                                     06520000
         DC    X'0200'                  PDS                             06540000
         DC    H'18'                                                    06560000
         DC    X'FFFF'                  END OF TABLE                    06580000
         DS    0D                                                       06600000
XCTLTAB  DS    0H                                                       06620000
         DC    X'FF00'             BSAM NORMAL                          06640000
      DC   CL2'RD'                      SAM UNLOAD                      06660000
         DC    CL2'RA'                  SAM LOAD                        06680000
         DC    CL2'TL'                  BDAM NORMAL                     06700000
     DC    CL2'TL'                      BDAM UNLOAD                     06720000
     DC   CL2'TL'                       BDAM LOAD                       06740000
         DC    3XL2'0'                 SPACE FOR ISAM - NEVER USED      06760000
         DC    X'FF08'             PDS  NORMAL                          06780000
         DC    CL2'RD'                  PDS UNLOAD                      06800000
         DC    CL2'RA'                  PDS  LOAD                       06820000
    DC   CL2'TJ'     LOAD-UNLOAD                                        06840000
         DC    CL2'TA'                  CATALOG                         06860000
         DC    CL2'SC'                  CATALOG AND UNLOAD CATALOG      06880000
         DC    CL2'TG'                  SELECT                          06900000
         DC    CL2'TJ'        BSAM U                   CODE=32          06920000
         DC    C'TJ'                   BSAM V, VS NORMAL CODE=34   VS0H 06940017
   DC   X'FF10'    BSAM  VB  REBLOCK    CODE=36                         06960000
         DC    C'SM'                   BSAM VB OR VBS    CODE=38   VS0H 06980017
         DC    CL2'TJ'        BSAM F   NORMAL          CODE=40          07000000
         DC    X'FF18'        BSAM,FB,REBLOCK     CODE=42               07020000
         DC    CL2'TJ'        BSAM FB  NO REBLOCK      CODE=44          07040000
*                                                                  VS0H 07044017
*THE FOLLOWING ENTERIES ARE CURRENTLY UNUSED.  PDS ROUTINES USE THEVS0H 07048017
* SAME ROUTINES AS BSAM AND USE TABLE OFFSETS 32 THRU 44 ABOVE     VS0H 07052017
*                                                                  VS0H 07056017
         DC    CL2'TJ'        PDS  U                   CODE=46          07060000
         DC    CL2'TJ'        PDS  V   NORMAL          CODE=48          07080000
    DC   X'FF10'    PDS   VB  REBLOCK  CODE=50                          07100000
         DC    CL2'TJ'        PDS  VB  NO REBLOCK      CODE=52          07120000
         DC    CL2'TJ'        PDS  F   NORMAL          CODE=54          07140000
         DC    X'FF18'         PDS,FB,REBLOCK    CODE=56                07160000
         DC    CL2'TJ'        PDS  FB  NO REBLOCK      CODE=58          07180000
         DS    0F                                                       07200000
BRANCHTO DS    0H                                                       07201017
         DC    A(SAM)                                                   07202017
         DC    CL4'  SK'                                                07203017
         DC    A(PDS)                                                   07204017
         DC    CL4'  SK'                                                07205017
         DC    A(SMBIT)                                                 07206017
         DC    CL4'  SM'                                                07207017
         DC    A(SLBIT)                                                 07208017
         DC    CL4'  SL'                                                07209017
*                                                                       07210017
BUILDREQ DS    0H                                                       07214017
LOAD     EQU   X'02'                                                    07218017
UNLOAD   EQU   X'01'                                                    07222017
EOF      EQU   X'20'                                                    07226017
SAM      EQU   *                                                   9373 07230017
PDS      L     R2,IEHMVV30+8           GET FROM DSCB ADDRESS   @YA01681 07234002
         CLC   107(8,R2),ZEROS         CHECK FOR MODEL-DSCB    @YA01681 07234502
         BNE   NODSCB                  NO MODEL-DSCB           @YA01681 07235002
         CLC   95(3,R2),ZEROS          CHECK FOR MODEL-DSCB    @YA01681 07235502
         BNE   NODSCB                  NO MODEL DSCB           @YA01681 07236002
         L     R2,IEHMVV22+4           ADDRESS OF FROM VOLLIST @YA01681 07236102
         CLI   2(R2),X'20'             FROM DEVICE DA          @YA01681 07236202
         LA    R3,44                   SET UP XCTL TO ETJ      @YA01681 07236502
         BE    XCTLREEN                YES MUST BE MODEL DSCB  @YA01681 07236702
NODSCB   L     ACCE,IEHMVV30           FROM DCB ADDRESS        @YA01681 07237002
         L     ACCO,IEHMVV31           TO DCB ADDR                 9373 07238017
         TM    36(ACCE),U              FROM U RECFM                9373 07242017
         BO    FROMU                   YES                         9373 07246017
         TM    36(ACCO),U              TO U RECFM                  9373 07250017
         BO    TOISU                   YES                         9373 07254017
         TM    36(ACCE),FB             FROM FB RECFM               9373 07258017
         BC    12,ISFROMF              NO                          9373 07262017
         TM    36(ACCO),FB             TO FB RECFM                 9373 07266017
         BC    12,FBTOF                NO                          9373 07270017
         CLC   82(2,ACCE),82(ACCO)     LRECL EQUAL                 9373 07274017
         BNE   FMERR                   NO IT IS AN ERROR           9373 07278017
         CLC   62(2,ACCE),62(ACCO)     BLKSIZE EQUAL               9373 07282017
         BNE   ESLMOD                  NO GO TO REBLOCK            9373 07286017
         LA    R3,44                    SET UP FOR FB MOD ETJ      VS0H 07290017
         B     XCTLREEN                GO SET UP XCTL TO ETJ       VS0H 07294017
ETJMOD   LA    R3,32                   SET UP FOR IEHMVETJ         9373 07298017
         B     XCTLREEN                                            9373 07302017
FBTOF    TM    36(ACCO),F              TO F RECFM                  9373 07306017
         BC    12,FMERR                NO IT IS AN ERROR           9373 07310017
         CLC   62(2,ACCO),82(ACCE)     TO BLK EQU FROM LRECL       9373 07314017
         BNE   FMERR                   NO IT IS AN ERROR           9373 07318017
ESLMOD   CLI   16(ACCE),ZERO       FROM KEYLENGTH ZERO ?         A30505 07319019
         BNE   FMERR               NO--CAN'T REBLOCK KEYED DS    A30505 07320019
         CLI   16(ACCO),ZERO       IS TO KEYLENGTH ZERO ?        A30505 07321019
         BNE   FMERR               NO- CAN'T REBLOCK KEYED DS.   A30505 07322019
         LA    R3,42               SET UP FOR ESL.               A30505 07323019
         B     XCTLREEN                                                 07324019
ISFROMF  TM    36(ACCE),F              FROM F RECFM                9373 07330017
         BC    12,ISFRMVBS             NO                          VS0H 07335017
         TM    36(ACCO),FB             TO FB RECFM                 9373 07340017
         BC    12,FTOF                 NO                          9373 07345017
         CLC   62(2,ACCE),82(ACCO)     FROM BLK EQU TO LRECL       9373 07350017
         BE    ESLMOD                  YES                         9373 07355017
         B     FMERR                   NO IT IS AN ERROR           9373 07360017
FTOF     TM    36(ACCO),F              TO F RECFM                  9373 07365017
         BC    12,FMERR                NO IT IS AN ERROR           9373 07370017
         CLC   62(2,ACCE),62(ACCO)     BLKS EQUAL                  9373 07375017
         BNE   FMERR                   NO IT IS AN ERROR           9373 07380017
         LA    R3,40                    SET UP F TO F MOD ETJ      VS0H 07385017
         B     XCTLREEN                GO SET UP XCTL TO ETJ       VS0H 07390017
ISFRMVBS DS    0H                                                  VS0H 07395017
         TM    36(ACCE),VBS             FROM VBS RECFM             VS0H 07400017
         BC    12,ISFROMVB              NO                         VS0H 07405017
         TM    36(ACCO),VBS             TO VBS RECFM               VS0H 07410017
         BC    12,FMERR                 NO IT IS AN ERROR          VS0H 07415017
         CLC   82(2,ACCE),82(ACCO)      LRECL EQUAL                VS0H 07420017
         BNE   FMERR                    NO IT IS AN ERROR          VS0H 07425017
         CLC   62(2,ACCE),62(ACCO)      BLKSIZE EQUAL              VS0H 07430017
         BNE   FMERR                    NO IT IS AN ERROR          VS0H 07435017
         LA    R3,38                   SET UP FOR VBS/VBS (ESM)    VS0H 07440017
         LA    R3,34               SET UP FOR ETJ                A30505 07442019
         B     XCTLREEN                GO GIVE CONTROL TO ESM      VS0H 07445017
ISFROMVB TM    36(ACCE),VB             FROM VB RECFM               9373 07450017
         BC    12,ISFROMVS             NO                          VS0H 07454017
         TM    36(ACCO),VB             TO VB RECFM                 9373 07458017
         BC    12,VBTOV            NO                                   07459019
         CLC   62(2,ACCE),62(ACCO)   BLKSIZES EQUAL ?            A30505 07460019
         BE    ETJMOD              NO REBLOCKING GO TO ETJ       A30505 07461019
         B     ESMMOD              IF REBLOCKING CHECK FOR KEYS  A30505 07462019
         LA    R3,38                   SET UP FOR VB TO VB--ESM    VS0H 07466017
         B     XCTLREEN                GO SET UP TO PASS CONTROL   VS0H 07470017
ESMMOD   CLI   16(ACCE),ZERO       IS FROM KEYLENGTH ZERO.       A30505 07471019
         BNE   FMERR               NO-- CAN'T REBLOCK KEYED DS.  A30505 07472019
         CLI   16(ACCO),ZERO       IS TO KEYLENGHT ZERO?         A30505 07473019
         BNE   FMERR               NO--CAN'T REBLOCK KEYED DS.   A30505 07474019
         LA    R3,38               SET UP TO REBLOCK IN ESM.     A30505 07475019
         B     XCTLREEN                                                 07476019
VBTOV    TM    36(ACCE),V              TO V RECFM                  9373 07482017
         BO    ESMMOD                  YES                         9373 07492017
         B     FMERR                   NO IT IS AN ERROR           9373 07502017
ISFROMVS DS    0H                                                  VS0H 07512017
         TM    36(ACCE),VS              FROM VS RECFM              VS0H 07522017
         BC    12,ISFROMV               NO                         VS0H 07532017
         TM    36(ACCO),VS              TO VS RECFM                VS0H 07542017
         BC    12,FMERR                 NO IT IS AN ERROR          VS0H 07552017
         CLC   82(2,ACCE),82(ACCO)      LRECL EQUAL                VS0H 07562017
         BNE   FMERR                    NO IT IS AN ERROR          VS0H 07572017
         CLC   62(2,ACCE),62(ACCO)      BLKSIZE EQUAL              VS0H 07582017
         BNE   FMERR                    NO IT IS AN ERROR          VS0H 07592017
VSETJMOD LA    R3,34                    SET UP FOR VS TO VS MOD ETJVS0H 07602017
         B     XCTLREEN                GO SET UP TO PASS CONTROL   VS0H 07632017
ISFROMV  TM    36(ACCE),V              FROM V RECFM                9373 07662017
         BC    12,FMERR                NO                          9373 07682017
         TM    36(ACCO),VB             TO VB RECFM                 9373 07702017
         BO    ESMMOD                  YES                         9373 07722017
         TM    36(ACCO),V              TO V RECFM                  9373 07742017
         BO    VSETJMOD                SET UP FOR VS/VS MOD VETJ   VS0H 07762017
         B     FMERR                   NO IT IS AN ERROR           9373 07782017
FROMU   TM    36(ACCO),U               TO U RECFM                  9373 07802017
         BC    12,FMERR                NO IT IS AN ERROR           9373 07822017
         B     ETJMOD                  YES                         9373 07842017
TOISU    CLC   62(2,ACCO),62(ACCE)     TO BLK EQU OR GRTR FROM     9373 07862017
         BL    FMERR                   NO IT IS AN ERROR           9373 07882017
         B     ETJMOD                  YES                         9373 07902017
ZZW      DC    X'0000'                                                  07922017
FMERR    MVI   IEHMVV61,X'24'          SET ERROR MESSAGE CODE      9373 07942017
         B     PREAB1                                              9373 07962017
SMBIT    DS    0H                                                       08060000
    OI   IEHMVV20+4,X'20'    INDICATE SM RETURN                         08080000
   BR   RETURN                                                          08100000
SLBIT    DS    0H                                                       08120000
         OI    IEHMVV20+4,BLANK                                         08140000
    BR   RETURN                                                         08160000
         TITLE 'PRE ABORT ROUTINE'                                      08180000
PREABORT DS    0H                                                       08200000
         ENTRY PREABORT                                                 08220000
*                                                                       08240000
   BALR   BASE,0                                                        08260000
    USING   *,BASE                                                      08280000
   L   BASE,B                                                           08300000
    USING   BB,BASE                                                     08320000
*                                                                       08440000
   IEHPOST  (14,1),TFC,                                                 08460000
PREAB1   DS    0H                                                       08480000
    BALR   BASE,0                                                       08500000
     USING   *,BASE                                                     08520000
    L    BASE,B                                                         08540000
   USING   BB,BASE                                                      08560000
         TM    IEHMVV10-4,FVOLUME  FROM VOLUME TO BE CLOSED        9373 08563013
         BO    CLOSEF              YES                             9373 08566013
FCLOSE   TM    IEHMVV10-4,BLANK    TO VOLUME TO BE CLOSED          9373 08569013
         BO    CLOSET              YES                             9373 08572013
TCLOSE   DS    0H                                                  9373 08575013
    BAL   RETURN,MSG                                                    08580000
    IEHPOST  (14,1),TFC,                                                08600000
         MVI   IEHMVV41+13,X'04'       SET RETURN CODE           A18773 08620018
         OI    IEHMVV20+2,BLANK   TURN ON MIDABORT                      08640000
         TM    IEHMVV20,VOLUME     VOLUME OPERATION                     08660000
    BO   SINGLE                                                         08680000
         MVC   IEHMVV00(6),MODNAME                                      08700000
         MVI   IEHMVV00+6,C'S'     ADD S TO MODULE NAME                 08720000
         TM    IEHMVV20,DSGROUP    DSGROUP OPERATION                    08740000
         BO    GODSG                                                    08760000
         TM    IEHMVV20+2,EOF                                           08780000
         BO    GOHOME                                                   08800000
         MVI   IEHMVV00+7,C'T'     ADD T TO MODULE NAME                 08820000
ALLDONE  DS    0H                                                       08840000
         XCTL  (2,12),EPLOC=(12)                                        08860000
SINGLE   MVC   IEHMVV00(6),MODNAME                                      08880000
         MVI   IEHMVV00+6,C'S'                                          08900000
         MVI   IEHMVV00+7,C'Z'                                          08920000
         B     ALLDONE                                                  08940000
*                                                                       08960000
GOHOME   MVI   IEHMVV00+7,C'K'                                          08980000
         B     ALLDONE                                                  09000000
GODSG    DS    0H                                                       09020000
         MVI   IEHMVV00+7,C'H'                                          09040000
         B     ALLDONE                                                  09060000
CLOSEF   DS    0H                                                       09080000
         L     ACCE,IEHMVV30       ADDRESS OF FROM DCB                  09100000
         MVI   IEHMVV70+8,DEACTIVE     DEACTIVATE INPUT TRLR EXIT  UL0H 09110017
         CLOSE ((ACCE))                                                 09120000
         B     FCLOSE                                                   09140000
CLOSET   DS    0H                                                       09160000
         L     ACCE,IEHMVV31       ADDRESS OF TO DCB                    09180000
         MVI   IEHMVV70+12,DEACTIVE    DEACTIVATE OUTPUT TRLR EXIT UL0H 09190017
         CLOSE ((ACCE))                                                 09200000
         B     TCLOSE                                                   09220000
CATALOG  EQU   X'04'                                                    09240000
DASD     EQU   X'20'                                                    09260000
         TITLE 'MESSAGE HANDLER'                                        09280000
MSG      DS    0H                                                       09300000
         STM   REG0,REG15,200(REG12) STORE REGISTERS                    09320000
    DROP   BASE                                                         09340000
         BALR  REG15,0                                                  09360000
         USING *,REG15                                                  09380000
   L   BASE,B                                                           09400000
         DROP  REG15                                                    09420000
    USING   BB,BASE                                                     09440000
         LR    R7,RETURN                                                09460000
         MVI   IEHMVV00,ONES                                            09480000
         MVI   IEHMVV00+1,BLANK                                         09500000
         MVC   IEHMVV00+2(120),IEHMVV00+1                               09520000
         TM    IEHMVV61,ODD                                             09540000
*                                       MESSAGE                         09560000
         BO    NORMMES                       NORMAL MESSAGE             09580000
*                                            DATA SET MESSAGE           09600000
*                                                                       09620000
         MVC   IEHMVV00+1(4),IEH4       SET UP MSG NUMBER               09640000
         LA    ACCE,127                                                 09660000
         SR    ACCO,ACCO           MAKE HIGH ORDER BIT OF FIRST BYTE    09680000
         IC    ACCO,IEHMVV61               ZERO                         09700000
         NR    ACCO,ACCE                                                09720000
         L     R3,AIEH4DD          ADDR OF CODE                         09740000
         LA    ACCO,0(R3,ACCO)     SET UP MESSAGE DIAGNOSTIC CODE       09760000
    MVC  IEHMVV00+5(2),0(ACCO)                                          09780000
         MVI   IEHMVV00+7,X'C9'                                         09800000
         L     ACCE,MSGH                SET UP MSG HEADER               09820000
         LA    ACCO,7                                                   09840000
         BAL   R8,MSGMOVE                                               09860000
*                                                                       09880000
         L     ACCE,IEHMVV21            SET UP DSNAME                   09900000
         LA    ACCO,43                                                  09920000
         BAL   R8,MSGMOVE                                               09940000
         TM    IEHMVV61,NOTMOVE    UNLOAD MSG OR NOT MOVED              09960000
         BO    MSGUNLD                       UNLOAD MSG                 09980000
         LA    ACCE,2                        NOT MOVED                  10000000
MSGAA    DS    0H                                                       10020000
         BAL   R8,MSGDMOVE              SET UP FINAL PART               10040000
         SR    ACCE,ACCE                                                10060000
         IC    ACCE,IEHMVV61                 OF MSG                     10080000
         BAL   R8,MSGDMOVE                                              10100000
PRINTMES SR    REG0,REG0           TO PRINT A NORMAL MSG                10120000
         LA    3,IEHMVV00                                               10140000
         LINK  EP=IEHMVESU                                              10160000
         B     MSGCHECK(LINK)           CHECK RETURNS                   10180000
MSGCHECK B     GOODMSG                  GOOR WRITE                      10200000
         XCTL  EP=IEHMVESK              I/O ERROR                       10220000
*                                                                       10240000
GOODMSG  LR    RETURN,R7                                                10260000
         MVI   IEHMVV61,ZERO       MOVE ZERO INTO MSG INDICATOR         10280000
         LM    REG0,REG15,200(REG12)                                    10300000
         BR    RETURN                                                   10320000
MSGUNLD  DS    0H                                                       10340000
         NI    IEHMVV61,UNLOADM    TURN OFF UNLOAD MSG BIT              10360000
         LA    ACCE,0                                                   10380000
         B     MSGAA                                                    10400000
MSGDMOVE DS    0H                                                       10420000
    SLL   ACCE,1                                                        10440000
         L     R3,ADMSG            LOAD ADDRESS OF MESSAGESTART         10460000
         LH    ACCO,2(R3,ACCE)                                          10480000
         LH    ACCE,0(R3,ACCE)                                          10500000
         A     ACCE,MSGH                                                10520000
MSGMOVE  DS    0H                                                       10540000
         LA    R9,IEHMVV00+121                                          10560000
MSGLOOP  CLI   0(R9),BLANK         FIND LAST NONBLANK                   10580000
         BNE   MSGPL                         CHARACTER IN               10600000
         BCT   R9,MSGLOOP                    MSG AREA                   10620000
MSGPL    DS    0H                                                       10640000
         EX    ACCO,MSMOVE         MOVE MSG INTO PRINTOUT AREA          10660000
         BR    R8                  BRANCH BACK TO FINISH MSG            10680000
NORMMES  DS    0H                                                       10700000
         SR    ACCE,ACCE                                                10720000
         IC    ACCE,IEHMVV61            GET MESSAGE CODE                10740000
         LA    ACCE,1(0,ACCE)                                           10760000
         SLL   ACCE,1                   CALCULATE MESSAGE POINTER       10780000
*                                                                       10800000
         L     R3,ANORMALM         LOAD ADDR OF NORMAL MSG              10820000
         L     ACCE,0(R3,ACCE)     GET MSG PTR                          10840000
         SR    ACCO,ACCO                                                10860000
         IC    ACCO,0(ACCE,0)           GET MESSAGE LENGTH              10880000
         LA    ACCE,1(0,ACCE)                                           10900000
         EX    ACCO,NORMM               MOVE MESSAGE TO PRINT AREA      10920000
         B     PRINTMES                 GO TO PRINT MESSAGE             10940000
NORMM    MVC   IEHMVV00+1(1),0(ACCE)                                    10960000
B        DC    A(BB)                                                    10980000
         ENTRY MSG                                                      11000000
IEH4     DC    CL4'IEH4'                                                11020000
MSMOVE   MVC   2(1,R9),0(ACCE)                                          11040000
MSGH     DC    A(MSGHEAD)               POINTER TO MESSAGES             11060000
ZEROS    DC    2F'0'                                           @YA01681 11070002
ADMSG    DC    A(MSGSTART)                                              11080000
ANORMALM DC    A(NORMALM)                                               11100000
AIEH4DD  DC    A(IEH4DD)                                                11120000
         EXTRN MSGSTART                                                 11140000
         EXTRN NORMALM                                                  11160000
         EXTRN IEH4DD                                                   11180000
         EXTRN MSGHEAD                                                  11200000
         IEHMVV                                                         11220000
         SPACE                                                          11240000
DEVCHAR  EQU   IEHMVV00+200            SPACE FOR DEVICE CHARACTER DATA  11260000
         SPACE 3                                                        11280000
UNLDREC  DS    0D                      DEFINE THE HEADER RECORD         11300000
         DS    XL1   (PHONY BYTE)      FOR UNLOADED DATASETS            11320000
UNLDLLI  DS    XL3                     LENGTH FIELD                     11340000
         SPACE 2                                                        11360000
F1DSCB   DS    0F                                                       11370013
         IECSDSL1  (1)                 DEFINE A FORMAT 1 DSCB           11380000
         SPACE 2                                                        11400000
UNLDDIR  DS    XL2                     DIRECTORY QUANTITY               11420000
UNLDFLAG DS    XL1                     UNLOAD CONTROL FLAG              11440000
UNLDSIZE DS    XL4                      PRIM ALLOC OF DS (IN BYTES)     11460000
UNLDSSIZ DS    XL4                      SEC ALLOCATION OF DS (IN BYTES) 11480000
UNLDSPAR DS    XL42                     UNUSED SPARE BYTES              11500000
UNLDDEVT DS    XL4                      FROM DEVICE TYPE                11520000
         SPACE 1                                                        11540000
         END   IEHMVESY                                                 11620000
