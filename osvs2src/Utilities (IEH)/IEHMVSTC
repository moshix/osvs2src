*TITLE                                                                * 00020000
*   'IEHMVSTC - PDS DIRECTORY SCANNER'                                * 00040000
*FUNCTION/OPERATION:                                                  * 00060000
*   THIS ROUTINE READS A SPECIFIED PDS DIRECTORY AND WRITES THE       * 00080000
*   DIRECTORY RECORDS ON A WORK FILE FOR THE USE OF THE               * 00100000
*   MOVE/COPY/UNLOAD PDS FUNCTIONS.  IF ANY MEMBERS ARE TO EXCLUDED OR* 00120000
*    REPLACED EACH MEMBER NAME READ IS COMPARED TO THE MEMBER NAMES IN* 00140000
*    A FILE OF EXCLUDES AND REPLACES AND IF IT MATCHES THE ENTRY IS   * 00160000
*   NOT PUT ON THE OUTPUT WORK FILE.                                  * 00180000
*ENTRY POINTS:                                                        * 00200000
*        IEHMVETC - ONLY ENTRY POINT L 15, A (IEHMVETC) BALR 14,15    * 00220000
*INPUT:                                                               * 00240000
*   1.  SPECIFIED PDS DIRECTORY ENTRIES FROM A DIRECT ACCESS DEVICE.  * 00260000
*   2.  WORK FILE (SYSUT2) OF EXCLUDES/REPLACES FROM DIRECT ACCESS    * 00280000
*   DEVICE.                                                           * 00300000
*OUTPUT:                                                              * 00320000
*   WORK FILE (SYSUT3) OF MEMBERS TO MOVED/COPIED/UNLOADED TO DIRECT  * 00340000
*   ACCESS DEVICE.                                                    * 00360000
*EXITS - NORMAL                                                       * 00380000
*   FREEMAIN AND RETURN TO CALLING ROUTINE                            * 00400000
*ERRORS:                                                              * 00420000
*   FREEMAIN AND TRANSFER CONTROL TO IEHMVESN WHEN I/O ERROR OCCURS.  * 00440000
*TABLES/WORK AREAS:                                                   * 00460000
*   136 BYTE WORK AREA.                                               * 00480000
*ATTRIBUTES:                                                          * 00500000
*   READ ONLY,REENTRANT,REUSABLE.                                     * 00520000
*D036300                                                       @ZA11965 00520499
*C036100                                                       @ZA04392 00521099
*A019100                                                       @ZA01234 00522002
*A036300                                                       @YA02535 00525002
*A018900                                                        OY01177 00530016
*A034900                                                         YM5090 00532000
*C036100                                                       @ZA28365 00534099
*A035400,035700,036000                                         @ZA28365 00535099
*A067260-067360                                                @ZA28914 00537099
R0       EQU   0                                                        00540000
R1       EQU   1                                                        00560000
R2       EQU   2                                                        00580000
R3       EQU   3                                                        00600000
R4       EQU   4                                                        00620000
R5       EQU   5                                                        00640000
R6       EQU   6                                                        00660000
R7       EQU   7                                                        00680000
R8       EQU   8                                                        00700000
R9       EQU   9                                                        00720000
R10      EQU   10                                                       00740000
R11      EQU   11                                                       00760000
R12      EQU   12                                                       00780000
R13      EQU   13                                                       00800000
R14      EQU   14                                                       00820000
R15      EQU   15                                                       00840000
CVTPCNVT EQU   28                                                       00860000
CVTPRLTV EQU   32                                                       00880000
SEVENT   EQU   17                      BYTES TO CORRECT TIC      S20201 00882020
NINE1    EQU   9                       BYTES TO CORRECT CCW      S20201 00884020
RPS      EQU   4                       BYTES TO BYTE IN IEHMVV   S20201 00886020
CODE     EQU   136                     BYTES IN CCW CHAIN        S20201 00888020
CCWCLR   EQU   187                     BYTES TO CLEAR IN STCP    S20201 00890020
RECLN    EQU   91                      LENGTH OF RECORD AND KEY  S20201 00892020
EXCLUDE  EQU   C'E'                                                     00900000
ERMASK   EQU   X'C0'                                                    00920000
EXCREP   EQU   X'04'                                                    00940000
DSGROUP  EQU   X'10'                                                    00960000
FIRSTIME EQU   X'FF'                                                    00980000
* THIS IS THE ROUTINE TO BREAK UP A PDS DIRECTORY SO THAT THE PDS MAY   01000000
*              BE COPIED WITHOUT MISSING AN ENTRY                       01020000
*2039 0350-0358,0366-0370,0816-0818,0908-0918                      7491 01040000
*                                                                       01060000
IEHMVSTC CSECT                                                          01080000
*C062000                                                         A48801 01082022
*  ALL CODE FLAGGED S20201 WAS ADDED OR CHANGED FOR              S20201 01086020
*  MERLIN/ZEUS SUPPORT                                           S20201 01092020
         ENTRY IEHMVETC                                                 01100000
IEHMVETC SAVE  (14,12),T,IEHMVSTC-OZ28914                      @ZA28914 01120000
         LR    11,15                                                    01140000
         USING IEHMVETC,11                                              01160000
         USING IEHMVV,12                                                01180000
*                                                                       01200000
         IEHPRE ,FT           SETS UP NEW SAVE AREA                     01220000
*                                                                       01240000
         SR    R10,R10                                                  01260000
         L     R3,IEHMVV41         ADDR OF SYSUT2 DCB                   01280000
         LA    R3,0(0,R3)          CLEAR HIGH ORDER BYTE                01300099
         L     R4,IEHMVV42         ADDR OF SYSUT3 DCB                   01310099
         LA    R4,0(0,R4)          CLEAR HIGH ORDER BYTE                01320099
         USING OUTDCB,4                                                 01330099
         MVC   57(3,R4),ERRAD          PUT SYNAD IN UT3 DCB             01340099
         TM    IEHMVV20,DSGROUP    DSGROUP OPERATION                    01400000
         BO    POINT3                  YES                              01420000
         TM    IEHMVV20+2,EXCREP   ANY EXCLUDES OR REPLACES             01440000
         BZ    POINT3                  NO                               01460000
         POINT (R3),TTRA1              REPOSITION SYSUT2                01480000
POINT3   POINT (R4),TTRA1              REPOSITION SYSUT3                01500000
         MVC   57(3,R3),ERRAD          PUT SYNAD IN UT2 DCB             01520099
*                                                                       01540000
         MVC   OPAREA(SW2-DOPEN+1),DOPEN   REENTRANT OPEN AND DCB SETUP 01560000
         L     R9,IEHMVV30+12      ADDR OF 'FROM' DDNAME                01580000
         MVC   INDCB+40(8),0(R9)   PUT DDNAME IN DCB                    01600000
         GETMAIN  R,LV=650                                       S20201 01620020
         LR    R5,R1                                                    01640000
         USING STCP,R5                                                  01660000
         MVI   MODJFCB,X'00'           CLEAR                            01680000
         MVC   MODJFCB+1(175),MODJFCB   MODEL JFCB                      01700000
         LA    R1,MODJFCB              ADDR OF MODEL JFCB               01720000
         ST    R1,EXLIST               PUT IN EXIT LIST                 01740000
         LA    R1,EXLIST               EXIT LIST ADDR                   01760000
         ST    R1,INDCB+36         PUT IN DCB                           01780000
         MVI   INDCB+36,X'81'                                           01800000
         MVI   EXLIST,X'87'                                             01820000
         L     R1,IEHMVV21             ADDR OF DS NAME                  01840000
         MVC   MODJFCB(44),0(R1)       PUT DS NAME IN JFCB              01860000
         MVI   MODJFCB+44,X'40'                                         01880000
         MVI   MODJFCB+52,X'08'        DON'T WRITE BACK JFCB    OY01177 01890016
         MVI   MODJFCB+117,X'01'       NO OF VOLS                       01900000
         MVI   MODJFCB+87,X'C0'        INDICATE NEW DATA SET   @ZA01234 01910002
         L     R1,IEHMVV22+4           ADDR OF VOL ID                   01920000
         MVI   MODJFCB+124,X'40'                                        01940000
         MVC   MODJFCB+118(6),4(R1)    PUT VOL ID IN JFCB               01960000
         MVC   MODJFCB+53(3),IEHMVV82  MOVE TTR9IN JFCB          S21042 01970021
         OPEN  (INDCB),TYPE=J,MF=(E,OPAREA)                             01980000
***** INITIALIZE CHANNEL PROGRAM AND IOB ******                         02000000
         MVI   EXIOB,X'00'             CLEAR                            02020000
         MVC   EXIOB+1(CCWCLR),EXIOB   AREA                      S20201 02040020
         LA    R1,EXECB                ADDR OF ECB                      02060000
         ST    R1,EXIOB+4              PUT IN IOB                       02080000
         LA    R1,EXCPENT              ADDR OF CHANNEL PROGRAM          02100000
         ST    R1,EXIOB+16             PUT IN IOB                       02120000
         ST    R1,EXCPENT+8            PUT IN CHAN PROG                 02140000
         LA    R1,CHANID+3             ADDR OF MBBCCHHR OF FIRST RECORD 02160000
         ST    R1,EXCPENT              PUT IN CHAN PROG                 02180000
         LA    R1,EXCP3                TIC ADDR                         02200000
         ST    R1,EXCP2+8              PUT IN CHAN PROG                 02220000
         LA    R1,SW3                                                   02240000
         ST    R1,EXCP2+16                                              02260000
         LA    R1,EXCPLAD              ADDR OF CCHHR OF LAST RECORD     02280000
         ST    R1,EXCP3                PUT IN CHAN PROG                 02300000
         LA    R1,EXCP2                TIC ADDR                         02320000
         ST    R1,EXCP3+8              PUT IN CHAN PROG                 02340000
         MVI   NEWIOB,X'00'            CLEAR SWITCH                     02360000
         LA    R1,EXCP2A               TIC ADDR                         02380000
         ST    R1,EXCP2A+8             PUT IN CHAN PROG                 02400000
         LA    R1,EXCP2A               TIC TO SEARCH ID EQ       S20201 02406020
         ST    R1,EXCP2B                                         S20201 02412020
         OC    EXCPENT(CODE),CHPROG   PUT CODES AND LNGTH IN CCWSS20201 02422020
* HOUSEKEEP FOR THE RUN                                                 02440000
         MVC   CHANID(8),5(R3)          PUT START CCHHR IN IOB          02460000
         MVC   EXCPLAD(5),IEHMVV41+8    PUT END CCHHR IN TEST SLOT      02480000
         ST    R3,UT2DCB                STORE DCB ADDRESS IN IOB        02500000
         NI    IEHMVV20+2,X'7F'        CLEAR ALIAS INDICATOR            02520000
*                                                                       02540000
ABLE     READ  INPUT,SF,INDCB,INAREA,MF=E                               02560000
         CHECK INPUT                                                    02580000
*                                                                       02600000
         LA    R10,1(R10)     STEP RECORD COUNTER                       02620000
*                                                                       02640000
         TM    IEHMVV20+2,X'02'       SELECTS SPECIFIED                 02660000
         BO    ABLE                    YES                              02680000
*        TEST TO SEE IF ALL ENTRIES PROCESSED. IF YES-READ TO CT RCDS   02700000
         TM    SWITCH,X'FF'                                             02720000
         BC    1,ABLE                                                   02740000
*                                                                       02760000
*        SET UP BASE ADDRESS FOR BLOCK AND SAVE KEY                     02780000
         LA    R9,INAREA                                                02800000
         MVC   KEY(8),0(R9)                                             02820000
*                                                                       02840000
*        GET ENTRY NAME ADDRESS                                         02860000
         LA    R9,10(R9)                                                02880000
*                                                                       02900000
*        COMPARE ENTRY NAME WITH KEY                                    02920000
REPEAT   CLC   KEY(8),0(R9)                                             02940000
         BE    DOG            EQUAL - LAST ENTRY FOR THIS RECORD        02960000
*                                                                       02980000
*        SET UP FOR WRITE                                               03000000
PROC     LR    R8,R9                                                    03020000
         SH    R8,NINE                                                  03040000
*        COMPUTE LENGTH OF RECORD TO BE WRITTEN IN R7                   03060000
         LH    R7,10(0,R9)                                              03080000
         LA    R6,X'1F'                                                 03100000
         NR    R7,R6                                                    03120000
         AR    R7,R7                                                    03140000
         LA    R7,17(0,R7)   DATA LENGTH IS IN R7                       03160000
*                                                                       03180000
* TEST IF MEMBER IS TO BE EXCLUDED OR REPLACED                          03200000
         TM    IEHMVV20+2,EXCREP                                        03220000
         BZ    PROC2               BRANCH IF NO                         03240000
         MVC   EXECB(4),DEXECB                                          03260000
         ST    R9,NAMEADD          STORE ADDRESS OF ENTRY NAME          03280000
         MVC   EXCP2+1(3),NAMEADD+1                                     03300000
         MVC   EXCP2A+1(3),NAMEADD+1                                    03320000
         MVI   SW3,X'00'           CLEAR EXCLUDE SWITCH                 03340000
         TM    IEHMVV20+RPS,X'04'      RPS BIT ON TEST           S20201 03340920
         BZ    PROC1                   NO - USE EXISTING CCWS    S20201 03341820
         LA    R1,EXCP3A               NEW FIRST CCW (SET SECTOR)S20201 03342720
         ST    R1,EXIOB+16             PUT IT IN THE IOB         S20201 03343620
         LA    R1,EXCPENT              GET PRESENT FIRST CCW     S20201 03344520
         ST    R1,NAMEADD              AND PUT IN TIC ADDRESS    S20201 03345420
         MVC   EXCP3A+NINE1(3),NAMEADD+1                         S20201 03346320
         LA    R1,EXCP3B               GET READ SECTOR CCW       S20201 03347220
         ST    R1,NAMEADD              AND PUT IT IN THE CCW     S20201 03348120
         MVC   EXCP2B+1(3),NAMEADD+1   AFTER THE READ            S20201 03349020
         LA    R1,EXCP2A               GET SEARCH AFTER READ     S20201 03349920
         ST    R1,NAMEADD              AND PUT IN TIC AFTER      S20201 03350820
         MVC   EXCP3B+SEVENT(3),NAMEADD+1  SET SECTOR            S20201 03351720
         LA    R1,SECTOR               GET ADDR TO PUT SECTOR    S20201 03352620
         ST    R1,NAMEADD              VALUE AND PUT IN          S20201 03353520
         MVC   EXCP3B+1(3),NAMEADD+1   CCW FOR READ              S20201 03354420
         MVC   EXCP3B+9(3),NAMEADD+1   AND SET SECTORS           S20201 03355320
         LA    R1,EXCP3+18             GET A BYTE OF ZERO        S20201 03356220
         ST    R1,NAMEADD              FOR 0 SECTOR VALUE        S20201 03357120
         MVC   EXCP3A+1(3),NAMEADD+1   PUT IN SET SECTOR CCW     S20201 03358020
         MVC   NAMEADD+1(3),EXCP2+1    PUT NAME BACK IN DSECT    S20201 03358920
PROC1    LA    R1,EXIOB                                          S20201 03368920
         EXCP  (1)                     SEARCH SYSUT2                    03380000
         L     R1,EXIOB+4                                               03400000
         WAIT  ECB=(1)                                                  03420000
         L     R3,IEHMVV41             DCB ADDR                         03440000
         TM    44(R3),ERMASK                                            03460000
         BZ    EXOK                BRANCH IF NO ERRORS                  03480000
         NI    44(R3),X'FF'-ERMASK SET PERM ERROR OFF            YM5090 03490000
*                                                                       03500000
ERROR    MVI   IEHMVV61,X'20'  SET 61 TO WRITE I/O ERR WORK FILE   7491 03520000
*                              MSG IEH417I                     @ZA28365 03540099
         B     ERROR2A                                             7491 03550099
ERROR1   MVI   IEHMVV61,X'22'  SET 61 TO WRITE I/O ERR FROM DA SET 7491 03560099
*                              MSG IEH418I                     @ZA28365 03570099
         B     ERROR2A                                             7491 03580099
ERROR2   MVI   IEHMVV61,X'24'  SET 61 TO WRITE I/O ERR SYSPRINT    7491 03590099
*                              MSG IEH419I                     @ZA28365 03600099
ERROR2A  OI    IEHMVV20+2,X'40'        INDICATE ABORTION       @ZA28365 03610099
         CLOSE (INDCB),MF=(E,OPAREA)                                    03640000
         FREEMAIN  R,LV=650,A=(5)                                S20201 03660020
         IEHPOST ,T                                                     03680000
         LA    15,4            SET RETURN CODE ERROR               7491 03700000
         RETURN (14,12),T,RC=(15)                                  7491 03720000
*                                                                       03740000
EXOK     TM    SW3,X'FF'                                                03760000
         BZ    PROC2               NO MATCH - BRANCH TO PROCESS ENTRY   03780000
         TM    IEHMVV20+1,X'01'                                         03800000
         BZ    PROC3               EXCLUDE ENTRY IF NOT UNLOAD MODE     03820000
         TM    SW3,EXCLUDE                                              03840000
         BO    PROC3               BRANCH IF IT WAS AN E TO EXCLUDE     03860000
*                                                                       03880000
*        WILL RECORD FIT ON THIS TRACK                                  03900000
PROC2    L     R1,IEHMVV42             GET THE DEVICE OVERHEAD FOR      03920000
         USING IHADCB,R1               THE LAST RECORD ON A TRACK       03940000
         L     R1,DCBDVTBL             BY GOING TO THE DEVICE           03960000
         USING UNITABLE,R1             CHARACTERISTICS TABLE FOR        03980000
         SR    R6,R6                   SYSUT3 -- THEN CHECK TO SEE      04000000
         TM    UNITFLAG,X'08'          IF 2-BYTE OVERHEAD        S20201 04004000
         BZ    ONEBYTE                 NO-GET 1 BYTE AND CONTINUES20201 04008020
         LH    R6,UNITOVHI             GET 2 BYTE OVERHEAD       S20201 04012020
         B     ADDREC                  TEST REC ON TRACK         S20201 04016020
ONEBYTE  IC    R6,UNITOVHL             CHECK TO SEE IF REC.      S20201 04026020
ADDREC   LA    R6,RECLN(0,R6)          (4 BYTE KEY+87 BYTE OF    S20201 04036020
*                                      DATA) WILL FIT            S20201 04046020
         TM    NEWIOB,FIRSTIME                                          04060000
         BZ    BAKER                   YES                              04080000
         CH    R6,OUTDCB+18                                             04100000
         BL    BAKER         BRANCH IF RECORD WILL FIT                  04120000
*                                                                       04140000
*        ZERO TRACK BALANCE                                             04160000
         SR    R6,R6                                                    04180000
         STH   R6,OUTDCB+18                                             04200000
*                                                                       04220000
*        COMPUTE NEXT TRACK ADDRESS                                     04240000
         L     R1,OUTDCB+44        SET UP FOR CONVERT ROUTINE           04260000
         LA    R2,OUTDCB+5                                              04280000
         LR    R3,R13                                                   04300000
         STM   R9,R13,72(R13)      STORE REGISTERS                      04320000
         L    R15,16(0,0)                                               04340000
         L    R15,CVTPRLTV(R0,R15)                                      04360000
         BALR  R14,R15             BRANCH TO CONVERT CCHHR TO TTR       04380000
*                                                                       04400000
         LR    R15,R0              SET UP FOR NEXT TRACK                04420000
         SRL   R15,16                                                   04440000
         LA    R15,1(R0,R15)                                            04460000
         SLL   R15,16                                                   04480000
         LR    R0,R15                                                   04500000
         LA    R2,1(R0,R8)                                              04520000
         L     R15,16(R0,R0)                                            04540000
         L     R15,CVTPCNVT(R0,R15)                                     04560000
         BALR  R14,R15             BRANCH TO CONVERT TTR TO CCHHR       04580000
*                                                                       04600000
*        RESET REGS                                                     04620000
         LM    R9,R13,72(R3)                                            04640000
*                                                                       04660000
*        MAKE FIELD R A ONE                                             04680000
         MVI   8(R8),X'01'                                              04700000
         B     CHARLIE                                                  04720000
*                                                                       04740000
*        RECORD WILL FIT. MOVE CCHHR TO OUT AREA                        04760000
BAKER    MVC   1(8,R8),OUTDCB+5                                         04780000
*                                                                       04800000
*        ADD ONE TO FIELD R                                             04820000
         LA    R8,1(0,R8)                                               04840000
         LH    R1,6(0,R8)                                               04860000
         LA    R1,1(0,R1)                                               04880000
         STH   R1,6(0,R8)                                               04900000
         BCTR  R8,0                                                     04920000
*                                                                       04940000
*        MOVE TTR INTO KEY FIELD                                        04960000
CHARLIE  MVC   1(3,R8),8(R9)                                            04980000
*                                                                       05000000
*        MOVE ALIAS BIT STATUS TO OUTPUT AREA AND WORK FILE CONTROL     05020000
         MVC   0(1,R8),11(R9)                                           05040000
         NI    0(R8),X'80'                                              05060000
*                                                                       05080000
*        PUT RECORD IN OUTPUT AREA                                      05100000
         OC    IEHMVV20+2(1),0(R8)                                      05120000
         MVC   WRAREA(91),0(R8)                                         05140000
         LR    R8,R5                                                    05160000
         MVC   RENAME(8),9(R5)         PUT NAME IN RECORD               05180000
*                                                                       05200000
*        WRITE THE RECORD                                               05220000
         WRITE OUTPUT,SF,OUTDCB,(R8),87,MF=E                            05240000
         CHECK OUTPUT                                                   05260000
         MVI   NEWIOB,X'FF'            INDICATE WRITE DONE              05280000
*                                                                       05300000
*        IS THIS LAST ENTRY OF INPUT RECORD                             05320000
PROC3    TM    EORSW,X'FF'                                              05340000
         BC    1,EASY                                                   05360000
*                                                                       05380000
*        NO - HOUSEKEEP FOR NEXT ENTRY                                  05400000
         SH    R7,FIVE                                                  05420000
         AR    R9,R7                                                    05440000
*                                                                       05460000
*        BRANCH FOR NEXT ENTRY                                          05480000
         B     REPEAT                                                   05500000
*                                                                       05520000
*        IT IS LAST ENTRY - CLEAR SWITCH AND GO READ NEXT RECORD        05540000
EASY     MVI   EORSW,X'00'                                              05560000
         B     ABLE                                                     05580000
*                                                                       05600000
*                                                                       05620000
*        ENTRY NAME IS EQUAL TO KEY                                     05640000
*        IS IT ALL F'S                                                  05660000
DOG      CLC   RECTERM(8),0(R9)                                         05680000
         BE    FOX                                                      05700000
*                                                                       05720000
*        NO IT IS NOT - SET EORSW ON AND CONTINUE PROCESSING            05740000
         MVI   EORSW,X'FF'                                              05760000
         B     PROC                                                     05780000
*                                                                       05800000
*        IT IS EQUAL - SET SWITCH ON AND GO TO READ NEXT RECORD         05820000
FOX      MVI   SWITCH,X'FF'                                             05840000
         B     ABLE                                                     05860000
*                                                                       05880000
*                                                                       05900000
*        END OF DATA ROUTINE                                            05920000
*        STORE RECORD COUNT - CLOSE - END PGM                           05940000
ENDIN    STH   R10,IEHMVV25                                             05960000
         TM    IEHMVV20+2,X'02'       SELECTS SPECIFIED                 05980000
         BO    NOTWRITE                YES                              06000000
*                                                                       06020000
* WRITE OUT DUMMY LAST RECORD                                           06040000
         WRITE OUTPUT,SF,OUTDCB,ENDREC,5,MF=E                           06060000
         CHECK OUTPUT                                                   06080000
*                                                                       06100000
* PUT CCHHR OF RECORD JUST WRITTEN INTO IEHMVV                          06120000
         MVC   IEHMVV42+8(5),OUTDCB+8                                   06140000
NOTWRITE EQU   *                                                        06160000
         CLOSE (INDCB),MF=(E,OPAREA)                                    06180000
         TM    IEHMVV20+2,EXCREP   ANY EXCLUDES OR REPLACES      A48801 06200022
         BZ    ENDB                     NO, SKIP EXCLUDE WRAPUP         06220000
RDEX     L     R3,IEHMVV41             DCB ADDR                         06240000
         MVI   44(R3),X'00'                                             06260000
         L     R2,IEHMVV41+4           DECB ADDR                        06280000
         READ  (2),SF,(3),INAREA,'S',MF=E                               06300000
         L     R2,IEHMVV41+4           DECB ADDR                        06320000
         CHECK (2)                                                      06340000
         CLC   IEHMVV41+8(5),8(R3)     LAST RECORD                      06360000
         BE    ENDB                    YES                              06380000
         CLI   INAREA+8,X'FF'          THIS NAME EXCLUDED               06400000
         BE    RDEX                    YES                              06420000
         L     R2,M320AD               MSG ADDR                         06440000
         BAL   R4,MSGMOVE                                               06460000
         LA    R1,2(R3,R1)             LOCATION OF NAME IN MSG          06480000
         MVC   0(8,R1),INAREA          PUT NAME IN MSG                  06500000
         LA    R1,9(0,R1)              LOCATION OF NEXT PART IN MSG     06520000
         LA    R2,2(R3,R2)             ADDR OF NEXT MSG SEGMENT         06540000
         IC    R3,0(0,R2)              GET LENGTH OF SEGMENT            06560000
         EX    R3,MOVEMSG              PUT MSG IN AREA                  06580000
         LA    R1,2(R3,R1)             LOCATION OF DSNAME IN MSG        06600000
         L     R2,IEHMVV21             ADDR OF DS NAME                  06620000
         MVC   0(44,R1),0(R2)          PUT NAME IN MSG                  06640000
         LA    R4,RDEX                 RETURN ADDR                      06660000
         B     MSGMOVEB                GO TO WRITE MSG                  06680000
ENDB     IEHPOST ,T                                                     06700000
         FREEMAIN R,LV=600,A=(5)                                        06720000
         XC    57(3,R3),57(R3)  CLEAR SYNAD ADDR IN SYSUT2 DCB @ZA28914 06726099
         MVI   59(R3),X'01'     SET LAST BYTE HEX 01           @ZA28914 06732000
         XC    57(3,R4),57(R4)  CLEAR SYNAD ADDR IN SYSUT3 DCB @ZA28914 06734000
         MVI   59(R4),X'01'     SET LAST BYTE HEX 01           @ZA28914 06736000
         LA    R15,0                                                    06740000
         RETURN (14,12),T,RC=(15)                                       06760000
*        MESSAGE MOVING ROUTINE                                         06780000
MSGMOVE  MVI   MSGAREA,X'00'                                            06800000
         MVC   MSGAREA+1(120),MSGAREA                                   06820000
MSGMOVEA SR    R3,R3                   CLEAR REG THREE                  06840000
         IC    R3,0(R2)                INSERT MSG LENGTH                06860000
         LA    R1,MSGAREA+1            ADDR OF MSG AREA                 06880000
         EX    R3,MOVEMSG              PUT MSG IN AREA                  06900000
         CLI   4(R1),C'2'              DOES MSG NEED NAME               06920000
         BE    0(0,R4)                 YES                              06940000
MSGMOVEB LA    3,MSGAREA               ADDR OF MSG OUTPUT AREA          06960000
         LINK  EP=IEHMVESU             GO TO MSG WRITER                 06980000
         LTR   R15,R15                                                  07000000
         BNE   ERROR2                  NO                               07020000
         BR    R4                                                       07040000
DOPEN    OPEN  (,(INPUT)),MF=L                                          07060000
*                                                                       07080000
DIDCB    DCB   DSORG=PS,MACRF=R,                                       B07100000
               DDNAME=DIRINPT,DEVD=DA,KEYLEN=8,                        B07120000
               SYNAD=ERROR1,                                           *07140000
               RECFM=F,                                                B07160000
               BLKSIZE=256,EODAD=ENDIN                                  07180000
*                                                                       07200000
SW1      DC    X'00'                                                    07220000
SW2      DC    X'00'                                                    07240000
ERRAD    DC    AL3(ERROR)                                               07260000
*                                                                       07280000
* CHANNEL PROGRAM FOR SEARCHING FOR EXCLUDES AND REPLACES               07300000
         DS    0D                                                       07320000
CHPROG   DC    X'31'                   SEARCH ID EQUAL FIRST RECORD     07340000
         DC    AL3(0)                                                   07360000
         DC    X'40'                                                    07380000
         DC    X'000005'                                                07400000
         DC    X'08'               IF NOT KEEP SEARCH GOING             07420000
         DC    AL3(0)                                                   07440000
         DC    X'40000001'                                              07460000
         DC    X'A9'                   NOW SEARCH KEY EQUAL TO NAME     07480000
         DC    AL3(0)                                                   07500000
         DC    X'60000008'                                              07520000
         DC    X'08'               IF NOT SEARCH ID                     07540000
         DC    AL3(0)                                                   07560000
         DC    X'40000001'                                              07580000
         DC    X'06'               KEY EQUAL READ DATA                  07600000
         DC    AL3(0)                                                   07620000
         DC    X'60000001'                                              07640000
         DC    X'08'                   IF RPS, GO SET SECTOR     S20201 07645020
         DC    AL3(0)                                            S20201 07650020
         DC    X'40000001'                                       S20201 07655020
         DC    X'29'                   SEARCH KEY EQUAL TO NAME         07660000
         DC    AL3(0)                                                   07680000
         DC    X'60000008'                                              07700000
         DC    X'08'              IF NOT GO BACK TO SEARCH KEY          07720000
         DC    AL3(0)                                                   07740000
         DC    X'40000001'                                              07760000
         DC    X'05'              INDICATE NAME MATCHED                 07780000
         DC    AL3(RECTERM)                                             07800000
         DC    X'20000001'                                              07820000
         DC    X'B1'                   SEARCH ID EQUAL TO LAST RECORD   07840000
         DC    AL3(0)                                                   07860000
         DC    X'40000005'                                              07880000
         DC    X'08'               IF NOT EQUAL GO BACK TO SEARCH KEY   07900000
         DC    AL3(0)                                                   07920000
         DC    X'40000001'                                              07940000
         DC    X'03'               END SEARCH NO MATCH FOUND            07960000
         DC    AL3(0)                                                   07980000
         DC    X'00000001'                                              08000000
         DC    X'23'                   SET SECTOR                S20201 08001020
         DC    AL3(0)                                            S20201 08002020
         DC    X'40000001'                                       S20201 08003020
         DC    X'08'                   SEARCH FOR RECORD         S20201 08004020
         DC    AL3(0)                                            S20201 08005020
         DC    X'40000001'                                       S20201 08006020
         DC    X'22'                   READ SECTPR               S20201 08007020
         DC    AL3(0)                                            S20201 08008020
         DC    X'40000001'                                       S20201 08009020
         DC    X'23'                   SET SECTOR                S20201 08010020
         DC    AL3(0)                                            S20201 08011020
         DC    X'40000001'                                       S20201 08012020
         DC    X'08'                   RETURN TO OLD CCWS        S20201 08013020
         DC    AL3(0)                                            S20201 08014020
         DC    X'40000001'                                       S20201 08015020
DEXECB   DC    F'0'                                                     08020000
         DS    0H                                                       08040000
NINE     DC    X'0009'                                                  08060000
FIVE     DC    X'0005'                                                  08080000
RECTERM  DC    X'FFFFFFFFFFFFFFFF'                                      08100000
ENDREC   DC    X'00BEB000'                                              08120000
         DC    C'DUMMY'                                                 08140000
TTRA1    DC    A(256)                                                   08160000
M320AD   DC    A(M320)                                                  08180000
MOVEMSG  MVC   0(1,R1),1(R2)           MOVE A MSG TO THE OUTPUT AREA    08200000
*                                                                       08220000
         IEHMVV                                                         08240000
         ORG   IEHMVV00                                                 08260000
OPAREA   OPEN  (,(INPUT)),MF=L                                          08280000
*                                                                       08300000
INDCB    DCB   DSORG=PS,MACRF=R,                                       B08320000
               DDNAME=DIRINPT,DEVD=DA,KEYLEN=8,                        B08340000
               RECFM=F,                                                B08360000
               BLKSIZE=256,EODAD=ENDIN                                  08380000
*                                                                       08400000
SWITCH   DS    CL1                                                      08420000
EORSW    DS    CL1                                                      08440000
         DS    0F                                                       08460000
INAREA   DS    CL264                                                    08480000
KEY      DS    CL8                                                      08500000
         READ  INPUT,SF,INDCB,INAREA,MF=L                               08520000
         WRITE OUTPUT,SF,OUTDCB,MF=L                                    08540000
*                                                                       08560000
STCP     DSECT                                                          08580000
WRAREA   DS    CL83                                                     08600000
RENAME   DS    CL8                                                      08620000
MSGAREA  DS    CL121                                                    08640000
EXIOB    DS    5F                                                       08660000
UT2DCB   DS    3F                                                       08680000
CHANID   DS    2F                                                       08700000
EXECB    DS    F                                                        08720000
NAMEADD  DS    F                                                        08740000
EXCPENT  DS    2D                                                       08760000
EXCP2    DS    6F                                                       08780000
EXCP2B   DS    2F                                                S20201 08790020
EXCP2A   DS    6F                                                       08800000
EXCP3    DS    6F                                                       08820000
EXCP3A   DS    4F                                                S20201 08826020
EXCP3B   DS    6F                                                S20201 08832020
SW3      DS    C                                                        08840000
EXCPLAD  DS    5C                                                       08860000
STIOBAD  DS    6C                                                       08880000
NEWIOB   DS    C                                                        08900000
SECTOR   DS    C                                                 S20201 08910020
MODJFCB  DS    44F                                                      08920000
         DS    0F                                                       08940000
EXLIST   DC    X'87'                                                    08960000
         DC    AL3(0)                                                   08980000
OUTDCB   DSECT                                                          09000000
***** TABLE OF MESSAGES. EACH MESSAGE IS PRECEDED BY ITS LENGTH *****   09020000
MSGSECT  CSECT                                                          09040000
M320     DC    AL1(M321-M320-2)                                         09060000
         DC    CL14'IEH320I MEMBER'                                     09080000
M321     DC    AL1(MEND-M321-2)                                         09100000
         DC    CL21'NOT FOUND IN DATA SET'                              09120000
MEND     DS    0C                                                       09140000
         EJECT                                                          09160000
         DCBD  DSORG=PS,DEVD=DA                                         09180000
         EJECT                                                          09200000
UNITABLE DSECT                                                          09220000
UNITSICC DS    H                       DEFINE THE VARIOUS DEVICE        09240000
UNITSIHH DS    H                        CHARACTERISTICS                 09260000
UNITTRLN DS    H                                                        09280000
UNITOVHI DS    CL1                                                      09300000
UNITOVHL DS    CL1                                                      09320000
UNITOVHK DS    CL1                                                      09340000
UNITFLAG DS    CL1                                                      09360000
UNITTOLR DS    CL1                                                      09380000
         END                                                            09400000
