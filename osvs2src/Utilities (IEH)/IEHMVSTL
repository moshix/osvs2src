*FUNCTION/OPERATION: MOVE OR COPY, UNLOAD AND LOAD DATA SETS USING    * 00040000
*BASIC DIRECT ACCESS METHOD (BDAM). THE BDAM DATASETS MUST USE        * 00060000
*RELATIVE TRACK OR RELATIVE RECORD ACCESS METHODS. THE MODULE DOES A  * 00080000
*GETMAIN FOR A WORKAREA AND BUFFER. READS BDAM DATASET USING BDAM READ* 00100000
*MACRO WRITES BDAM DATASET USING BSAM WRITE CREATE MODE.              * 00120000
*ENTRY POINTS: IEHMVETL ONLY ENTRY POINT                              * 00140000
*INPUT: AT ENTRY TO THIS MODULE REG 13 POINTS TO SAVEAREA AND REG 12  * 00160000
*POINTS TO COMMUNICATION TABLE FOR MOVE COPY PROGRAM.                 * 00180000
*OUTPUT: REG. ARE THE SAME AS INPUT.                                  * 00200000
*EXTERNAL ROUTINES: IEHMVLSU, IEHMVSRM, IEHMVSRK                      * 00220000
*EXITS - NORMAL XCTL TO IEHMVSSN                                      * 00240000
*ERRORS: XCTL TO IEHMVSSN                                             * 00260000
*TABLES/WORK AREAS: IEHMVV IS COMMUNICATION TABLE WRKBUF IS WORKAREA  * 00280000
*DSECT                                                                * 00300000
IEHMVSTL CSECT                                                          00310022
*C047400                                                       @ZA01710 00310302
*A078500                                                       @ZA01249 00310602
*D078500-078610                                                @ZA01249 00311202
*A078500-078610                                                  A52005 00312022
*D078608                                                         A52005 00320022
*C047400                                                         A45172 00320122
*A042740-042784,043100,043120                                    A50933 00320222
*D060800,064050-064150                                           A44346 00320421
*A060700-060900                                                  A44346 00320821
*                                                                 19030 00332019
*        ALL STATEMENTS FLAGGED 19030 PERTAIN TO THE BDAM-VRE     19030 00334019
*        LINE ITEM. BDAM-VRE IS SUPPORT FOR SPANNED RECORDS IN    19030 00336019
*        DIRECT DATA SETS WITH VARIABLE RECORD FORMAT             19030 00338019
*                                                                       00340000
*                                                                A27313 00354019
* 063200-063400                                                  MBVRE1 00356019
*089644,089680-089681,089716-089720                             PTM3086 00358019
*044200                                                          A32036 00359020
*                                                                A37878 00359521
* 078600-079000                                                  A41754 00359621
*047200-047600                                                   A38749 00359921
RG0      EQU   0                                                        00360000
RG1      EQU   1                                                        00380000
RG2      EQU   2                                                        00400000
RG3      EQU   3                                                        00420000
RG4      EQU   4                                                        00440000
RG5      EQU   5                                                        00460000
RG6      EQU   6                                                        00480000
RG7      EQU   7                                                        00500000
RG8      EQU   8                                                        00520000
RG9      EQU   9                                                        00540000
BAL9     EQU   9                                                        00560000
BASE10   EQU   10                                                       00580000
RG11     EQU   11                                                       00600000
BASE12   EQU   12                                                       00620000
RET14    EQU   14                                                       00640000
LINK15   EQU   15                                                       00660000
RTCD15   EQU   15                                                       00680000
KEY      EQU   16                                                       00700000
BLKLH    EQU   62                                                       00720000
DSORG    EQU   26                                                       00740000
IOBBD    EQU   28                                                       00760000
CSWCT    EQU   14                                                       00780000
IOFLG    EQU   44                                                       00800000
UPTTI    EQU   X'80'                                                    00820000
UGTLN    EQU   X'40'                                                    00840000
INVL1    EQU   X'21'                                                    00860000
TEST2    EQU   X'10'                                                    00880000
IOER     EQU   X'08'                                                    00900000
EOFM     EQU   X'04'                                                    00920000
UNEX     EQU   X'02'                                                    00940000
GOOD     EQU   X'00'                                                    00960000
FIXED    EQU   X'80'                                                    00980000
VARBL    EQU   X'40'                                                    01000000
UNKNW    EQU   X'C0'                                                    01020000
RECFM    EQU   36                                                       01040000
IOBBS    EQU   68                                                       01060000
SYNAD    EQU   57                                                       01080000
IFLGS    EQU   44                                                       01100000
OFFSET   EQU   46                                                       01120000
LODE     EQU   X'02'                                                    01140000
BLANK    EQU   C' '                                                     01160000
DONE     EQU   X'00'                                                    01180000
CAPREC   EQU   X'02'                                                    01200000
UNLODE   EQU   X'01'                                                    01220000
MIDABORT EQU   X'40'                                                    01240000
DEACTIVE EQU   X'00'                                               UL0H 01250017
*********************************************************************** 01260000
*                                                                       01280000
*                       THIS MODULE WILL MOVE OR COPY A BDAM            01300017
*                        DATASET WHICH ADDRESSES RECORDS USING          01320000
*                        RELATIVE TRACK OR RELATIVE RECORD NOTATION     01340000
*                                                                       01360000
*********************************************************************** 01380000
IEHMVETL SAVE  (14,12),T,ETL-10-4-65-KCD                                01400000
         USING IEHMVETL,BASE10                                          01420000
         USING IEHMVV,BASE12            COMMUNICATIONS REGION           01440000
         USING WRKBUF,RG11              WORK AREA                       01460000
         ENTRY IEHMVETL                                                 01480000
         EXTRN M01                                                      01500000
         EXTRN M02                                                      01520000
         EXTRN M03                                                      01540000
         EXTRN M04                                                      01560000
         EXTRN M05                                                      01580000
         EXTRN M06                                                      01600000
         EXTRN M07                                                 UL0H 01602017
         EXTRN M08                                               A27313 01602519
         LR    BASE10,LINK15           LOAD  BASE REGISTER         VS0H 01603017
*                                                                  UL0H 01604017
*  ACTIVATE USER INPUT TRAILER LABEL ROUTINE EXIT IF REQUIRED.     UL0H 01606017
*                                                                  UL0H 01608017
         CLI   UDCBITLE,DEACTIVE       IS ITLE INACTIVE            UL0H 01610017
         BE    NEXTCODE                YES, CONTINUE               UL0H 01612017
         MVC   UDCBITLE(4),XXITLE      ACTIVATE DCB EXLIST ENTRY PTM504 01614017
NEXTCODE DS    0H                                                  UL0H 01616017
         L     RG2,IEHMVV31            ADDRESS OF TO DCB                01640000
         MVC   SYNAD(3,RG2),SYNBSM      MOVE ADDR OF OUTPUT ERROR RTN   01660000
         IEHPRE (14,1),TF                                               01680000
         TM    IEHMVV20+1,LODE          IS THIS A LOAD SITUATION        01700000
         BZ    *+12                                                     01720000
         L     RG2,IEHMVV31             SUPPLY ADDRESS OF 'TO'DCB       01740000
         B     *+8                                                      01760000
         L     RG2,IEHMVV30             SUPPLY ADDRESS OF 'FROM' DCB    01780000
         SR    RG3,RG3                                                  01800000
         LA    RG4,123        AMOUNT NEEDED FOR WORKAREA          19030 01820019
         IC    RG3,KEY(0,RG2)      INSERT KEY LENGTH FROM DCB           01840000
         LH    RG5,BLKLH(0,RG2)    LOAD BLKSIZE FROM DCB                01860000
         LR    RG0,RG4                  DETERMINE AMOUNT OF             01880000
         AR    RG0,RG3                  SPACE NEEDED IN                 01900000
         AR    RG0,RG5                  GETMAIN AREA                    01920000
         LR    RG4,RG0             SAVE GETMAIN AMOUNT          PTM2137 01930018
         GETMAIN  R,LV=(0)         GET MAIN FOR WORKAREA AND BUFFERS    01940000
         LR    RG11,RG1                                                 01960000
        MVI   0(RG11),X'00'           CLEAR WORK AREA                   01980000
         MVC   1(122,RG11),0(RG11)                                19030 02000019
         ST    RG4,GOTEN          STORE GETMAIN AMOUNT          PTM2137 02020018
         LA    RG4,123        SIZE OF WKAREA DISPLACEMENT         19030 02040019
         AR    RG1,RG4                                                  02060000
         ST    RG1,KEYADR          STORE ADDRESS OF KEY BUFFER          02080000
         AR    RG1,RG3                                                  02100000
         ST    RG1,BUFADR          STORE ADDRESS OF DATA BUFFER         02120000
         LA    RG1,INDECB         ADDR OF INPUT DECB              19030 02124019
         ST    RG1,IEHMVV30+4     SAVE DECB ADDR IN IEHMVV DSECT  19030 02128019
         LA    RG1,DECBOUT        ADDR OF OUTPUT DECB             19030 02132019
         ST    RG1,IEHMVV31+4     SAVE DECB ADDR IN IEHMVV DSECT  19030 02136019
         STH   RG3,KEYLGN          STORE LENGTH OF KEY                  02140000
         STH   RG5,BLKSIZ          STORE LENGTH OF DATA RECORD          02160000
         B     FRSTUPDT                                                 02180000
*********************************************************************** 02200000
*                                                                       02220000
*                                THE UPDAT ROUTINE WILL BUMP THE        02240000
*                             TTI IN THE BLKREF FIELD BY ADDING ONE     02260000
*                             TO THE  I  UNTIL A NO RECORD FOUND        02280000
*                             CONDITION IS RETURNED FROM READ           02300000
*                                                                       02320000
*********************************************************************** 02340000
UPDAT00  DS    0H                                                       02360000
         L     RG2,IEHMVV30             FROM DCB                        02380000
         TM    RECFM(RG2),X'C0'   TEST FOR UNDEFINED RCD FRMT      6429 02386017
         BO    *+12               RECORD FORMAT IS 'U' TYPE        6429 02392017
         TM    RECFM(RG2),FIXED         FORMAT= F ?                     02400000
         BO    CONT1                                                    02420000
         LH    RG8,TTIR     LOAD TT FROM BLKREF AND ADD                 02440000
         LA    RG8,1(0,RG8)         ONE TO IT STORE UPDATED TT BACK     02460000
         STH   RG8,TTIR             IN BLKREF  RESET IREC TO ZERO       02480000
FRSTUPDT SR    RG8,RG8                                                  02500000
         STH   RG8,IREC                SET RECORD NUMBER TO ZERO        02520000
CONT1    DS    0H                                                       02540000
         TM    IEHMVV20+1,LODE          IS THIS A LOAD SITUATION        02560000
         BO    FIRSTON        YES,TURN ON FSTR0SW                 19030 02580019
         L     RG2,IEHMVV30             FROM DCB                        02600000
         TM    RECFM(RG2),X'C0'   TEST FOR UNDEFINED RCD FRMT      6429 02606017
         BO    *+12               RECORD FORMAT IS 'U' TYPE        6429 02612017
         TM    RECFM(RG2),FIXED                                         02620000
         BO    READ1                                                    02640000
         TM    RECFM(RG2),X'48'  IS RECFM VS                      19030 02646019
         BO    VREPROC        YES,GO PROCESS VS                   19030 02652019
         L     RG8,TTIR                 SET UP TO READ R ZERO RECORDS   02660000
         ST    RG8,BLKREF              OF NEXT  TRACK                   02680000
         L     RG2,IEHMVV30             ADDR OF FROM DCB                02700000
         LA    RG3,INDECB                                               02720000
         SR    RG4,RG4                                                  02740000
         LA    RG5,CCHH                INPUT AREA FOR R ZERO RECORD     02760000
         READ  (3),DIF,(2),(5),8,(4),BLKREF,MF=E                        02780000
         BAL   RET14,CHLIOER     CHECK FOR I/O ERROR ON LABELS    UL0H  02790017
         WAIT  1,ECB=INDECB            WAIT FOR COMPLETION OF READ      02800000
         CLI   EXCD01,DONE              IS OPERATION COMPLETE           02820000
         BNE   ARWEDONE                                                 02840000
         SR    RG6,RG6                                                  02860000
         IC    RG6,R0                  PLACE RECORD COUNT IN REG 6      02880000
UPDAT01  DS    0H                                                       02900000
         L     RG2,IEHMVV30                                             02920000
         TM    RECFM(RG2),VARBL   RECORD FORMAT U OR V?          A21645 02940018
         BZ    READ1              NO,MUST BE FIXED?              A21645 02960018
         SR    RG8,RG8                                                  02980000
         IC    RG8,IREC            PICK UP OLD RECORD NUMBER            03000000
         LA    RG8,1(0,RG8)        ADD ONE TO RECORD NUMBER             03020000
         STC   RG8,IREC            STORE CURRENT RECORD NUMBER          03040000
READ1    MVC   BLKREF(4),TTIR                                           03060000
READ     LA    RG3,INDECB     ADDRESS OF DECB                           03080000
         L     RG2,IEHMVV30        ADDRESS OF DCB                       03100000
         L     RG4,KEYADR          ADDRESS OF KEY BUFFER                03120000
         L     RG5,BUFADR          ADDRESS OF DATA BUFFER               03140000
         TM    IEHMVV20+1,LODE          IS THIS A LOAD SITUATION        03160000
         BC    1,LOAD              SURE IS                              03180000
         TM    RECFM(RG2),X'C0'   TEST FOR UNDEFINED RCD FRMT      6429 03186017
         BO    *+12               RECORD FORMAT IS 'U' TYPE        6429 03192017
         TM    RECFM(RG2),FIXED                                         03200000
         BO    CONT2                                                    03220000
         LTR   RG6,RG6                 HAVE ALL RECORDS BEEN READ       03240000
         BZ    FRMT01                  YES SIR                          03260000
CONT2    DS    0H                                                       03280000
         READ  (3),DIF,(2),(5),'S',(4),BLKREF,MF=E                      03300000
         BAL   RET14,CHLIOER     CHECK FOR I/O ERROR ON LABELS    UL0H  03310017
         WAIT  1,ECB=INDECB                                             03320000
*                                  TEST EXCEPTION CONDITION BITS        03340000
         TM    RECFM(RG2),X'C0'   TEST FOR UNDEFINED RCD FRMT      6429 03346017
         BO    CONT3              RECFM  IS  U  TYPE             A21645 03353018
         TM    RECFM(RG2),FIXED                                         03360000
         BZ    CONT3                                                    03380000
         L     RG6,TTIR                 ADD ONE TO RELATIVE BLOCK       03400000
         A     RG6,ONEO                 ADDRESS.                        03420000
         ST    RG6,TTIR                                                 03440000
         B     CONT4                                                    03460000
FIRSTON  OI    FSTR0SW,X'01'  TURN ON FSTR0SW TO INDCT FIRSTIN    19030 03464019
         B     LOAD           GO LOAD DATA SET                    19030 03468019
*                                                                       03472019
*                                                                       03476019
CONT3    DS    0H                                                       03480000
         BCTR  RG6,0            SUBT 1 FROM RECORD COUNT                03500000
CONT4    DS    0H                                                       03520000
         CLI   EXCD01,GOOD      IF EXCD IS ZERO WRITE THE RECORD READ   03540000
         BE    FRMT02                                                   03560000
ARWEDONE TM    EXCD01,UPTTI            THIS SHOULD NEVER HAPPEN         03580000
         BO    UNEXPLND                PRINT UNEXPLAINED ERROR MSG      03600000
*                                FORMAT BEFOR UPDATING TTI              03620000
         TM    EXCD01,UGTLN     IF EXCD IS 40                           03640000
         BO    LENERR                 WRITE ERROR MSG,                  03660000
*                                                                       03680000
         TM    EXCD01,EOFM      IF EXCD IS 04 CHECK FORMAT,IF FORMAT U  03700000
         BO    FRMTO3                                            A27588 03720019
*                                MESSAGE.                               03740000
         TM    EXCD01,IOER      IF EXCD IS 08 A I/O ERROR HAS BEEN      03760000
         BO    PRMERR            ENCOUNTERED                            03780000
*                                WRITE ERROR MSG                        03800000
         TM    EXCD01,INVL1     IF EXCD IS 20,01,21 PRINT INVALID       03820000
         BC    5,INVALD          RETURN MSG                             03840000
*                                                                       03860000
         TM    EXCD01,UNEX      IF EXCD IS 02 PRINT ERROR MSG           03880000
         BO    UNEXPLND                                                 03900000
         TM    EXCD01,TEST2     IF EXCD IS 10 TEST EXCEPTION CODE       03920000
         BO    TSTX2             BYTE 2                                 03940000
         B     UNCORECT           GO PRINT MESSAGE               A27313 03960019
TSTX2    TM    EXCD02,TEST2     IF  EXCD02 IS 10 GO TO END OF JOB       03980000
         BO    FINISHED                                                 04000000
         B     INVALD           IF  EXCD02 IS OTHER THAN 10 PRINT       04020000
*********************************************************************** 04040000
*                                                                       04060000
*                            WRITIT WILL WRITE THE RECORD IN THE NEW    04080000
*                              DATASET CHECK RETURN CODES AND CHECK FOR 04100000
*                              ERRORS AFTER WRITING GOOD RECORD WILL    04120000
*                              GO TO UPDATE ROUTINE                     04140000
*                                                                       04160000
*********************************************************************** 04180000
WRIT01   L     RG2,IEHMVV31             ADDR OF 'TO'DCB                 04200000
         LA    RG2,0(0,RG2)        CLEAR HIGH ORDER BYTE                04220000
         TM    IEHMVV20+1,UNLODE        IS THIS AN UNLOAD SITUATION     04240000
         BC    1,UNLOAD            SURE IS                              04260000
         TM    RECFM(RG2),X'48'    IS RECFM VS                    19030 04266019
         BO    LNTHCHK             YES, CHECK FOR ZERO LENGTH     19030 04272019
         CLI   16(RG2),X'00'      TEST FOR KEY                   A50933 04274022
         BE    WRIT02             IF NO KEY, WRITE               A50933 04276022
         CLI   INPUT,X'FF'        CHECK FOR DUMMY RECORD         A50933 04278022
         BE    WRTDUMMY           IF SO, WRITE A DUMMY RECORD    A50933 04278422
WRIT02   WRITE DECBOUT,SF,(2),INPUT,(5),MF=E                            04280000
         BR    RG9                                                      04300000
WRTDUMMY WRITE DECBOUT,SD,(2),INPUT,(5),MF=E                     A50933 04310022
         BR    RG9                                               A50933 04312022
*                                                                       04320000
*                                                                       04340000
GETLGNTH L     RG2,IEHMVV30             ADDR OF FROM DCB                04360000
*                                                                       04380000
         SR    RG5,RG5            SUBTRACT RESIDUAL COUNT FROM   A32036 04400020
         AH    RG5,BLKLH(0,RG2)   CSW FROM BLKSIZE TO COMPUTE    A32036 04420020
*                                 THE LENGTH                     A32036 04440020
         L     RG3,IOBBD(0,RG2)        *OF THE RECORD READ              04460000
         SH    RG5,CSWCT(0,RG3)                                  A27588 04480019
         L     RG2,IEHMVV31             ADDR OF 'TO' DCB                04500000
         LA    RG2,0(0,RG2)             CLEAR HIGH ORDER BYTE           04520000
         BR    RG9                      BRANCH TO WRITE ROUTINE         04540000
*                                                                       04560000
FRMT02   L     RG2,IEHMVV30             ADDR OF 'FROM' DCB              04580000
         TM    RECFM(RG2),UNKNW    IS THIS A FORMAT U DATASET           04600000
         BO    GETL                  YES GO TO COMPUTE LENGTH           04620000
         LH    RG5,BLKLH(0,RG2)        LOAD BLOCK SIZE IN REG 5         04640000
         BAL   RG9,WRIT01                                               04660000
         B     BACK01(15)                                               04680000
         SPACE 3                                                        04700000
WRITEOK  LH    RG5,LLI                 LOAD LENGTH OF UNLOAD REC A38749 04720021
         SR    RG1,RG1                                           A38749 04730021
         IC    RG1,KEYLGN+1            GET KEYLENGTH           @ZA01710 04740002
         LA    RG1,8(RG1)              AND ADD 8 FOR MBBCCHHR    A38749 04750021
         SR    RG5,RG1                 SUBTRACT GIVES INIT BLKSZ A38749 04760021
         TM    LLI+2,CAPREC             IS THIS A CAPACITY RECORD       04780000
         BO    WRIT03                  IT IS FOR A FACT                 04800000
         BAL   RG9,WRIT01     NO PRINT ERROR MESSAGE                    04820000
         B     BACK01(15)                                               04840000
GETL     BAL   RG9,GETLGNTH                                             04860000
         BAL   RG9,WRIT01                                               04880000
         B     BACK01(15)                                               04900000
BACK01   B     CHEK01              TEST ROUTINES TO TEST REG 15 RETURN  04920000
         B     TRKFUL                                                   04940000
         B     CHEK01                                                   04960000
         EX    0,*                   CODES FROM WRITE CREATE            04980000
FRMT01   L     RG2,IEHMVV30             ADDRESS OF 'FROM' DCB           05000000
         TM    RECFM(RG2),VARBL         IS FORMAT V OR U                05020000
         BO    WRIT03                    YES                            05040000
         B     UPDAT00                   NO MUST BE F                   05060000
*                                                                       05080000
*                                                                       05100000
TRKFUL   TM    RECFM(RG2),VARBL         IS FORMAT V OR U                05120000
         BO    UNEXPLND                 IF V OR U FORMAT,IT INDICATES-- 05140000
*                                       NO ROOM ON CURRENT TRACK TO     05160000
*                                       WRITE BLOCK; USER MUSTWRITE CAP 05180000
*                                       ACITY RECORD BEFORE REISSUING   05200000
*                                       THIS REQUEST                    05220000
*                                                                       05240000
         B     CHEK01                   IF F FORMAT, IT INDICATES--     05260000
*                                       BLOCK WILL BE WRITTEN - THE CUR 05280000
*                                       RENT TRACK WILL THEN BE FULL -  05300000
*                                       THEREFORE, BRANCH TO CHECK RTN  05320000
*                                                                       05340000
*********************************************************************** 05360000
*                                                                       05380000
*                                  THIS ROUTINE FOR FORMATS V AND U     05400000
*                               WRITES A CAPACITY RECORD IN R 0  AND    05420000
*                               THEN GOES TO UPDATE TTI TO NEXT TRACK   05440000
*                                                                       05460000
*********************************************************************** 05480000
WRIT03   L     RG2,IEHMVV31             ADDR OF 'TO' DCB                05500000
         BCTR  RG6,0                   SUBTRACT ONE                     05520000
         TM    IEHMVV20+1,UNLODE        IS THIS AN UNLOAD SITUATION     05540000
         BO    UNLD01                  YES IT IS                        05560000
         TM    RECFM(RG2),X'48'    IS THE RECFM VS                19030 05570019
         BO    VSR0TST             YES                            19030 05580019
R0WRITE  WRITE DECBOUT,SZ,(RG2),MF=E   WRITE CAPACITY RECORD      19030 05590019
         CHECK DECBOUT                                                  05600000
         TM    RECFM(RG2),X'48'    IS RECFM VS                    19030 05606019
         BO    UPDATWRT            YES,GO UPDATE NEXT WRITE PTR   19030 05612019
         B     UPDAT00                                                  05620000
*                                  THIS IS THE CHECK ROUTINE FOR        05640000
*                               WRITE A RECORD AND RETURNS TO UPDAT01   05660000
CHEK01   CHECK DECBOUT                                                  05680000
         B     UPDAT01                                                  05700000
FRMTO3   L     RG2,IEHMVV30            ADDRESS OF THE FROM DCB   A27588 05730019
         TM    RECFM(RG2),UNKNW        IS RECFM UNDEFINED?       A27588 05760019
         BO    UNDEF                   YES -                     A27588 05790019
         LH    RG5,BLKLH(0,RG2)        PUT BLKSIZE IN REG2       A27588 05820019
         B     WRTEOF                                            A27588 05850019
UNDEF    BAL   RG9,GETLGNTH            GO CALCULATE BLK LENGTH   A27588 05880019
         B     WRTEOF                                            A27588 05910019
*********************************************************************** 05940000
*                                                                       05960000
*                                  THIS ROUTINES WRITES AN EOF MARK     05980000
*                               RESETS  ERROR FLAGS IN  DCB AND RESET   06000000
*                               THE UNAVAILABLE SWITCH IN THE IOB       06020000
*                                                                       06040000
*********************************************************************** 06060000
WRTEOF   TM    RECFM(RG2),FIXED         IS REC. FRMT. FIXED      A44346 06070021
         BO    FINISHED                 STOP COPYING             A44346 06080021
         L     RG2,IEHMVV31             ADDRESS OF TO-DCB        A44346 06090021
         MVC   SYNAD(3,RG2),SYNEOF      MOVE ADDR OF EOFRET IN DCB      06100000
         LH    RG8,BLKLH(0,RG2)         SAVE BLOCKSIZE FROM DCB         06120000
         STH   RG8,BLKOUT                                               06140000
         SR    RG5,RG5                                           A28895 06160019
         STH   RG5,BLKLH(0,RG2)   SET BLKSIZE TO ZERO.           A28895 06180019
         BAL   RG9,WRIT01                                               06200000
*                                                                       06240000
EOFRET   STM   14,4,12(13)              SAVE REGISTERS                  06260000
         L     RG2,IEHMVV31             LOAD ADDR OF 'TO' DCB           06280000
         MVI   IFLGS(RG2),GOOD          RESET I/O ERR FLAGS             06300000
         MVC   SYNAD(3,RG2),SYNBSM      RESTORE ORIGINAL SYNAD ROUTINE  06360000
         LH    RG8,BLKOUT               LOAD DCB BLOCKSIZE              06380000
         STH   RG8,BLKLH(0,RG2)         RESTORE BLOCKSIZE IN DCB        06400000
         B     UPDAT01                                                  06420000
*                                                                       06440000
PRMERR   B     INPUTERR                                                 06460000
*                                                                       06480000
INPUTERR BAL   RG9,CLEAR           CLEAR PRINT BUFFER                   06500000
         L     RG1,IEHMVV21        ADDR OF FROM DATA SET NAME           06520000
         L     RG8,AM04                 LOAD MESSAGE ADDRESS            06540000
         IC    RG7,0(RG8)                                               06560000
         L     RG8,0(RG8)                                               06580000
         B     MESG01                   I/O ERROR ON INPUT              06600000
NOTUNLD  BAL   RG9,CLEAR           CLEAR PRINT BUFFER                   06620000
         L     RG1,IEHMVV21        ADDR OF FROM DATA SET NAME           06640000
         L     RG8,AM05                 LOAD ADDRESS OF MESSAGE         06660000
         IC    RG7,0(RG8)                                               06680000
         L     RG8,0(RG8)                                               06700000
         B     MESG02                   NOT AN UNLOADED DATA SET        06720000
OUTPTERR BAL   RG9,CLEAR      CLEAR PRINT BUFFER                        06740000
         L     RG1,IEHMVV21+4      ADDR OF 'TO' DATA SET NAME           06760000
         L     RG8,AM06                 LOAD MESSAGE ADDRESS            06780000
         IC    RG7,0(RG8)                                               06800000
         L     RG8,0(RG8)                                               06820000
         B     MESG01                                                   06840000
*                                                                       06860000
CLEAR    MVI   0(12),BLANK              CLEAR PRINT BUFFER              06880000
         MVC   1(120,12),0(12)                                          06900000
         BR    RG9                                                      06920000
*                                                                       06940000
MESG01   EX    7,MOVER                  MOVE MESSAGE TO BUFFER          06960000
         MVC   50(44,12),0(1)           MOVE DATASET NAME TO BUFFER     06980000
         B     MESG03                                                   07000000
UNCORMSG EX    RG7,MOVER     MOVE MSG TO BUFFER                  A27313 07005019
         MVC   62(44,BASE12),0(RG1) MOVE DATA SET NAME TO BUFFER A27313 07010019
         B     MESG03             GO PRINT MESSAGE               A27313 07015019
MESG02   EX    7,MOVER                  MOVE MESSAGE TO BUFFER          07020000
         MVC   18(44,12),0(1)           MOVE DATASET NAME TO BUFFER     07040000
MESG03   LR    RG1,RG3                 SAVE REG 3                       07060000
         LR    RG3,BASE12                                               07080000
         LINK  EP=IEHMVESU                                              07100000
         LR    RG3,RG1                 RESTORE REG 3                    07120000
         B     ABORT                                                    07140000
*                                                                       07160000
UNCORECT BAL   RG9,CLEAR          CLEAR PRINT BUFFER             A27313 07162019
         L     RG8,AM08           LOAD ADDRESS OF MSG            A27313 07164019
         IC    RG7,0(RG8)         INSERT LENGTH                  A27313 07166019
         L     RG8,0(RG8)         CLEAR OUT HIGH ORDER BYTE      A27313 07168019
         L     RG1,IEHMVV21       ADDR OF PRINT BUFFER           A27313 07170019
         B     UNCORMSG      GO SET UP MSG                       A27313 07172019
*                                                                       07180000
SYNRET   B     OUTPTERR                 GO TO OUTPUT ERROR ROUTINE      07200000
*                                                                       07220000
INVALD   EX    0,*                      LOOP DUMP                       07240000
*                                                                       07260000
*                                                                       07280000
UNEXPLND BAL   RG9,CLEAR                WRITE MESSAGE                   07300000
         L     RG8,AM03                 LOAD MESSAGE START ADDR         07320000
         IC    RG7,0(RG8)                                               07340000
         L     RG8,0(RG8)                                               07360000
        L     RG1,IEHMVV21            ADDR OF PRINT BUFFER              07380000
         B     MESG01                   UNEXPLAINED ERROR DURING READ   07400000
*                                                                       07420000
*                                                                       07440000
ABORT    OI    IEHMVV20+2,MIDABORT      SET BIT AND TERMINATE           07460000
         B     GETOUT                                                   07480000
*                                                                       07500000
MOVER    MVC   1(1,12),0(RG8)                                           07520000
*                                                                       07540000
*                                                                       07560000
LENERR   BAL   RG9,CLEAR                CLEAR PRINT BUFFER              07580000
         L     RG8,AM02                 LOAD ADDRESS OF MESSAGE         07600000
         IC    RG7,0(RG8)                                               07620000
         L     RG8,0(RG8)                                               07640000
        L     RG1,IEHMVV21            ADDR OF PRINT BUFFER              07660000
         B     MESG01                   WRONG LENGTH RECORD             07680000
LASTR    L     RG2,IEHMVV31  ADDR OF TO DCB                       19030 07680919
         TM    RECFM(RG2),X'48'  IS RECFM VS                      19030 07681819
         BNO   GETOUT        NO - GO TO FREE CORE                 19030 07682719
         TM    IEHMVV20+1,LODE  IS THIS A LOAD SITUATION          19030 07683619
         BZ    GETOUT        NO - GO TO FREE CORE                 19030 07684519
*                                                                       07685419
*    TEST TO SEE IF TRACK IS FULL OF DATA - IF SO, DATA MGMT      19030 07686319
*    WILL HAVE ADVANCED WRTTR TO NEXT TRACK AND WILL HAVE         19030 07687219
*    WRITTEN THE R0 ON PRIOR TRACK                                19030 07688119
*                                                                       07689019
         CLI   LSTWRTI,X'01' WAS LAST WRITE A DATA RECORD         19030 07689919
         BNE   FINAL         NO - GO WRITE LAST R0                19030 07690819
         CLI   WRTTR+2,X'01' IS NEXT WRITE SET FOR R1             19030 07691719
         BC    8,LOADEND     YES - BYPASS R0 WRITE                19030 07692619
FINAL    BAL   RG9,WRTR01    WRITE LAST R0 FOR LOAD               19030 07693519
LOADEND  TM    SWITCH,X'08'  IS THIS END OF EXTENT                19030 07694419
         BO    GETOUT        YES                                  19030 07695319
         BAL   RG9,WRTR01    LOOP TO WRITE R0 RECORDS             19030 07696219
         B     LOADEND       TO END OF EXTENT                     19030 07697119
*                                                                       07698019
FINISHED TM    IEHMVV20+1,UNLODE        IS THIS AN UNLOAD SITUATION     07700000
         BZ    LASTR         NOT UNLOAD SITUATION                 19030 07720019
         LA    RG0,10                   YES, SET UP PARAMETER           07740000
         L     LINK15,BWRITE            ADDR OF BWRITE ROUTINE          07760000
         BALR  RET14,LINK15             LINK TO MODULE IEHMVERM         07780000
         B     *+4(15)                  RESULTING CONDITION CODE        07800000
         B     GETOUT                   DETERMINES WHICH BRANCH         07820000
         B     OUTPTERR                 IS TAKEN                        07840000
GETOUT   ST    RG11,IEHMVV82+16        SAVE AREA-ADDR. FOR ESN @ZA01249 07850002
         MVI   IEHMVV82+16,X'80' INDICATION FOR ESN              A41754 07861221
         MVC   IEHMVV82+20(4),GOTEN SAVE LENGTH OF AREA          A41754 07861621
*  IEHMVESN WILL FREEMAIN IEHMVESL'S WORKAREA AFTER CLOSE        A41754 07862021
*  BECAUSE THE CLOSEROUTINES USE THE DECB                        A41754 07864021
         IEHPOST (14,1),T                                               07920000
         XCTL  (2,12),EP=IEHMVESN                                       07940000
*                                                                       07960000
*THIS ROUTINE WILL SET UP THE OUTPUT TO CONFORM TO THE BWRITE FORMAT.   07980000
*PRECEDING EVERY RECORD WILL BE ELEVEN BYTES OF DATA,THE FIRST THREE TO 08000000
*BE USED BY BWRITE AND THE NEXT EIGHT BYTES TO BE USED BY BDAM LOAD ROU 08020000
*TINE.                                                                  08040000
*THESE ELEVEN BYTES BREAK DOWN INTO:                                    08060000
*      LL= LENGTH OF RECORD (BLKSIZE+KEY+8FOR MBBCCHHR)                 08080000
*       I= INDICATOR FOR UNLOAD PDS AND IN BDAM WILL EQUAL ZERO         08100000
*MBBCCHHR= USED WHEN LOADING BY ABSOLUTE DISK ADDRESS                   08120000
UNLD01   OI    LLI+2,X'02'                                              08140000
         LA    RG5,8                   CAPACITY RECORD SHOULD BE READ   08160000
UNLOAD   DS    0H                                                       08180000
         LR    RG3,RG5        RG5= BLKSIZE                              08200000
         AH    RG3,KEYLGN     ADD KEY LENGTH IF ANY                     08220000
         LA    RG3,08(0,RG3)  MBBCCHHR= 8 BYTES                         08240000
         STH   RG3,LLI        STORE LENGTH IN LL BYTES                  08260000
         MVC   MBBCCHHR(8),BLKREF  USED WHEN LOADING BY ABSOLUTE DISK A 08280000
         LA    RG1,LLI        PASS BWRITE ADDRESS OF INPUT              08300000
         SR    RG0,RG0        OTHER THAN FIRST TIME SWITCH              08320000
         L     LINK15,BWRITE  ADDRESS OF BWRITE ROUTINE                 08340000
         BALR  RET14,LINK15   GO TO BWRITE ROUTINE                      08360000
         B     *+4(LINK15)    CHECK RETURN CODE FROM BWRITE             08380000
         B     GDRETRN                                                  08400000
         B     OUTPTERR       I/O ERROR DETECTED                        08420000
*                                                                       08440000
GDRETRN  SR RG8,RG8                                                     08460000
         STC   RG8,LLI+2               RESET R0 INDICATOR               08480000
         L     RG2,IEHMVV30             FROM DCB.                       08500000
         TM    RECFM(RG2),X'C0'   TEST FOR UNDEFINED RCD FRMT      6429 08506017
         BO    *+12               RECORD FORMAT IS 'U' TYPE        6429 08512017
         TM    RECFM(RG2),FIXED                                         08520000
         BO    READ1                                                    08540000
         TM    RECFM(RG2),X'48'    IS RECFM VS                    19030 08546019
         BO    TESTRD        YES                                  19030 08552019
         LTR   RG6,RG6                 HAVE ALL RECORDS BEEN READ       08560000
         BP    UPDAT01                  NO                              08580000
         BZ    WRIT03                                                   08600000
         BM    UPDAT00                                                  08620000
VREPROC  L     RG2,IEHMVV30        ADDR OF FROM DCB               19030 08620219
         MVC   SYNAD(3,RG2),SYNVRE1 PUT INPUT SYNAD ADDR          19030 08620419
*                                  INTO FROM DCB                  19030 08620619
         L     RG2,IEHMVV31       ADDR OF TO DCB                  19030 08620819
         MVC   SYNAD(3,RG2),SYNBSM  PUT OUTPUT SYNAD ADDR         19030 08621019
*                                  INTO 'TO' DCB                  19030 08621219
R0READ   LA    RG3,INDECB         DECB ADDRESS                    19030 08621419
         L     RG2,IEHMVV30       FROM DCB                        19030 08621619
         L     RG4,KEYADR    LOAD ADDR OF KEY BUFFER              19030 08621819
         L     RG5,BUFADR         BUFFER ADDR                     19030 08622019
         READ  (RG3),DIRU,(RG2),(RG5),8,0,TTIR,NXTRD,MF=E         19030 08622219
         CHECK (RG3)                                              19030 08622419
         OC    EXCD01(1),EXCD01   WAS THE READ SUCCESSFULL        19030 08622619
         BC    4,INPUTCHK         NO, GO CHECK INDICATOR BITS     19030 08622819
         B     CHKR0              GO CHECH FOR UNLOAD             19030 08623019
*                                                                       08623219
TTRUPDT  MVC   TTIR(3),NXTRD      UPDATES TTIR                    19030 08623419
VREREAD1 OC    IREC(1),IREC       R0 RECORD                       19030 08623619
         BC    8,R0READ      YES                                  19030 08623819
         LA    RG3,INDECB         DECB ADDR                       19030 08624019
         L     RG2,IEHMVV30        LOAD ADDR OF FROM DCB          19030 08624219
         L     RG4,KEYADR          LOAD ADDR OF KEY BUFFER        19030 08624419
         L     RG5,BUFADR          LOAD ADDR OF DATA BUFFER       19030 08624619
*                                                                 19030 08624819
*        READ DATA RECORD                                         19030 08625019
*                                                                 19030 08625219
         READ  (RG3),DIRU,(RG2),(RG5),'S',(RG4),TTIR,NXTRD,MF=E   19030 08625419
         BAL   RET14,CHLIOER       CHECK FOR I/O ERROR ON U/L     19030 08625619
         CHECK (RG3)                                              19030 08625819
         OC    EXCD01(1),EXCD01   WAS THE READ SUCCESSFULL        19030 08626019
         BC    4,INPUTCHK         NO, GO CHECK INDICATOR BITS     19030 08626219
CHKUNLD1 TM    IEHMVV20+1,UNLODE   CHECK FOR UNLOAD               19030 08626419
         BNO   CHKTT2              NOT UNLOAD-CHECK TT            19030 08626619
         MVC   BLKREF(4),TTIR      YES UNLOAD-PUT TTR IN BLKREF   19030 08626819
         L     RG5,BUFADR         GET ADDR OF DATA PORTION OF RECD19030 08627019
         MVC   RECSIZE(2),0(RG5)  MOVE RECORD SIZE TO RECORD SAVE 19030 08627219
         LH    RG5,RECSIZE        LOAD SIZE OF RECORD JUST READ   19030 08627419
         B     UNLOAD              GO TO UNLOAD DATA RECORD       19030 08627619
*                                                                       08627819
CHKR0    TM    IEHMVV20+1,UNLODE  IS THIS AN UNLOAD SITUATION     19030 08628019
         BO    R0SETTR            YES, SET UP FOR UNLOAD OF R0 RCD19030 08628219
         CLI   4(RG5),X'00'  ANY RCDS ON THIS TRK                 19030 08628419
         BE    CHKTT1             NO,                             19030 08628619
         B     TTRUPDT            GO READ DATA RECORD             19030 08628819
*                                                                       08629019
R0SETTR  MVC   BLKREF(4),TTIR     MOVE TTR OF RCD TO BLKREF       19030 08629219
         B     UNLD01             GO UNLOAD R0 RECORD             19030 08629419
*                                                                       08629619
CHKTT1   CLC   TTIR(2),WRTTR       COMPARE READ AND WRITE TT      19030 08629819
         BE    EQUAL         GO TO CHECK RECORD COUNT             19030 08630019
         BAL   RG9,WRTR01    GO TO WRITE R0 RECORD                19030 08630219
         B     CHKTT1        COMPARE TT AGAIN                     19030 08630419
*                                                                       08630619
EQUAL    L     RG5,BUFADR    LOAD DATA BUFFER ADDR                19030 08630819
         CLI   4(RG5),X'00'        DOES TRACK REC CNT = 0         19030 08631019
         BNE   LOADTEST           NO, TEST LOAD CONDITION         19030 08631219
         OC    NXTRD(3),NXTRD     IS THIS THE LAST RECORD OF INPUT19030 08631419
         BC    8,LOADTEST         YES, PRACESS END OF DATA        19030 08631619
         BAL   RG9,WRTR01    GO TO WRITE R0 RECORD                19030 08631819
LOADTEST TM    IEHMVV20+1,LODE     IS THIS A LOAD                 19030 08632019
         BO    LOAD                YES-GO TO LOAD                 19030 08632219
         MVC   TTIR(3),NXTRD       SET TTR TO NEXT RECORD         19030 08632419
EXTNTEND OC    NXTRD(3),NXTRD     CHECK TTR FOR ZEROS             19030 08632619
         BC    4,VREREAD1          IF NOT 0 GO TO READ DATA       19030 08632819
         L     RG2,IEHMVV31        LOAD ADDR OF TO DCB            19030 08633019
         WRITE DECBOUT,SZ,(RG2),MF=E   WRITE R0 RECORD            19030 08633219
         STC   RTCD15,SWITCH      SAVE RETURN CODE                19030 08633419
         CHECK DECBOUT                                            19030 08633619
         TM    SWITCH,X'08'       IS THIS THE END OF EXTENT       19030 08633819
         BNO   EXTNTEND           NO, LOOP TO WRITE R0 RECORDS    19030 08634019
*                                 TO THE END OF THE EXTENT        19030 08634219
         B     GETOUT              GO TO FREEMAIN                 19030 08634419
*                                                                       08634619
CHKTT2   CLC   TTIR(2),WRTTR       COMPARE READ AND WRITE TT      19030 08634819
         BE    WRITEVS             TT EQUAL-GO TO WRITE DATA      19030 08635019
         BAL   RG9,WRTR01          TT NOT EQUAL-WRITE R0          19030 08635219
         B     CHKTT2              GO TO CHECK TT AGAIN           19030 08635419
*                                                                       08635619
*********************************************************************** 08640000
*                                                                       08660000
*THIS ROUTINE WILL RE-LOAD (PERFORM THE MOVE/COPY) AN UNLOADED DATA SET 08680000
*ITS INPUT CAN ONLY BE THAT WHICH WAS PREVIOUSLY UNLOADED.              08700000
*                                                                       08720000
*********************************************************************** 08740000
LOAD     LA    RG1,LLI        ADDRESS OF WHERE RECORD IS TO GO          08760000
         SR    RG0,RG0        OTHER THAN FIRST CALL TO BREAD            08780000
         L     LINK15,BREAD   ADDRESS OF BREAD ROUTINE                  08800000
         BALR  RET14,LINK15   GO TO BREAD(LOAD) ROUTINE                 08820000
         B     *+4(LINK15)    CHECK RETURN CODE FROM BREAD              08840000
         B     GOODREAD                                                 08860000
         B     FINISHED       END OF FILE                               08880000
         B     INPUTERR       I/O ERROR                                 08900000
         B     NOTUNLD        THIS IS NOT AN UNLOADED DATA SET          08920000
GOODREAD MVC   BLKREF(8),MBBCCHHR                                       08940000
         B     WRITEOK                                                  08960000
WRITEVS  L     RG2,IEHMVV31        LOAD ADDR OF TO DCB            19030 08960119
         LA    RG2,0(0,RG2)        CLEAR HIGH ORDER BYTE          19030 08960219
         WRITE DECBOUT,SFR,(RG2),INPUT,,WRTTR,MF=E  WRITE DATA    19030 08960319
         MVI   LSTWRTI,X'01'       SET LAST WRITE SW TO DATA      19030 08960419
         CHECK DECBOUT                                            19030 08960519
         B     LOADTEST            GO TO TEST FOR LOAD            19030 08960619
*                                                                       08960719
WRTR01   L     RG2,IEHMVV31        LOAD ADDR  OF TO DCB           19030 08960819
         WRITE DECBOUT,SZ,(RG2),MF=E  WRITE R0 RECORD             19030 08960919
         STC   RTCD15,SWITCH SAVE RETURN CODE                     19030 08961019
         CHECK DECBOUT                                            19030 08961119
         LH    RG8,WRTTR           LOAD TTR ON NEXT WRITE         19030 08961219
         LA    RG8,1(0,RG8)        ADD ONE TO TT                  19030 08961319
         STH   RG8,WRTTR          STORE TT FOR NEXT WRITE         19030 08961419
         BR    RG9                                                19030 08961519
TESTRD   OC    NXTRD(3),NXTRD      HAVE ALL RCD BEEN READ         19030 08961619
         BC    8,FINISHED  SET CODE FOR END OF UNLOADED DATA SET  19030 08961719
*                          AND GO TO WRAPUP                       19030 08961819
         TM    IEHMVV20+1,LODE     IS THIS A LODE SITUATION       19030 08961919
         BO    LOAD                YES                            19030 08962019
         MVC   TTIR(4),NXTRD       GET TTR OF NEXT RECORD TO READ 19030 08962119
         B     VREREAD1            GO READ NEXT RECORD            19030 08962219
*                                                                       08962319
VSR0TST  CLI   FSTR0SW,X'01'  IS THIS FIRST R0 TO BE PROCESSED    19030 08962419
         BNE   TSTLSWTI       NO,TEST LAST WRITE INDICATOR        19030 08962519
         MVI   FSTR0SW,X'00'  TURN OFF FIRST R0 SWITCH            19030 08962619
         B     LOAD           GO GET NEXT RECORD                  19030 08962719
*                                                                       08962819
TSTLSWTI CLI   LSTWRTI,X'01'  WAS LAST WRITE A DATA RECORD        19030 08962919
         BNE   R0WRITE        NO,GO WRITE R0 RECORD               19030 08963019
         CLI   WRTTR+2,X'01'      IS NEXT WRITE SET FOR R0        19030 08963119
         BNE   R0WRITE            NO, GO WRITE R0 RECORD          19030 08963219
         MVI   LSTWRTI,X'00'  SET LAST WRITE INDICATOR TO R0      19030 08963319
         B     LOAD           CONTINUE LOADING PROCEEDURE         19030 08963419
*                                                                       08963519
UPDATWRT LH    RG8,WRTTR      GET TRACK NUMBER                    19030 08963619
         LA    RG8,1(0,RG8)   ADD ONE TO TRACK COUNT              19030 08963719
         STH   RG8,WRTTR      UPDATE TTR FOR NEXT WRITE           19030 08963819
         MVI   LSTWRTI,X'00'  SET LAST WRITE INDICATOR TO R0      19030 08963919
         B     LOAD           CONTINUE LOADING                    19030 08964019
*                                                                       08964119
LNTHCHK  SR    RG1,RG1            CLEAR REGISTER ONE            PTM3086 08964219
         IC    RG1,KEYLGN+1       GET LENGTH OF KEY BEING USED  PTM3086 08964319
         SR    RG5,RG1            SUBTRACT KEYLENGTH FROM 'LL'    19030 08964519
         LTR   RG5,RG5        IS DATA LENGTH ZREO                 19030 08964619
         BC    8,LASTEOF      YES,WRITE IMBEDDED EOF              19030 08964719
         AR    RG5,RG1        RESTORE RECORD SIZE FOR WRITE DATA  19030 08964819
         B     WRITEVS        GO WRITE VS DATA RECORD             19030 08964919
SYNVRE1  DC    AL3(SYNREAD)        SYNAD RTN FOR VRE INPUT        19030 08965019
*        THIS IS THE INPUT SYNAD ROUTINE FOR VS RECORDS.THE CODE  19030 08965119
*        CHECKS FOR ERRORS AFTER THE READ CHECK IS ISSUED         19030 08965219
SYNREAD  BR    RET14              RETURN TO CHECK ROUTINE         19030 08965319
INPUTCHK TM    EXCD01,X'04'       IS THIS END OF FILE             19030 08965419
         BO    EOFCHEK            YES, CHECK FOR IMBEDDEED EOF    19030 08965519
         TM    EXCD01,X'08'       DID AN I/O ERROR OCCUR          19030 08965619
         BO    INPUTERR           YES PRINT MSG                   19030 08965719
         TM    EXCD01,X'80'       WAS THE RECORD FOUND            19030 08965819
         BO    UNEXPLND           NO, PRINT MSG AND ABORT         19030 08965919
         TM    EXCD01,X'40'       IS THIS A RECORD LENGTH CHECK   19030 08966019
         BO    LENERR             YES, PRINT MSG                  19030 08966119
         B     UNCORECT      AN UNCORRECTABLE ERROR OCCURED       19030 08966219
*                                                                       08966319
EOFCHEK  DS    0H                 THIS ROUTIN IS ENTERED WHEN     19030 08966419
*                                 AN EOF MARK IS READ ON THE      19030 08966519
*                   INPUT DATA SET.-THERE IS A POSSIBILITY OF     19030 08966619
*                   THERE BEING AN IMBEDDED END OF FILE WITHIN    19030 08966719
*                   THE DATA SET.- THE ONLY WAY OF KNOWING IF IT  19030 08966819
*                   IS AN IMBEDDED EOF OR THE ACTUAL END OF THE   19030 08966919
*                   DATA SET IS BY TESTING THE NEXT READ ADDRESS  19030 08967019
*                   FOR A TTR OF ZERO.-THE TTR OF ZERO'S IS AN    19030 08967119
*                   INDICATOR FROM DATA MANAGMENT THAT THE LAST   19030 08967219
*                   RECORD HAS BEEN READ.-IF THE TTR IS NOT ZERO  19030 08967319
*                   THEN A ZERO LENGTH RECORD MUST BE WRITTEN TO  19030 08967419
*                   THE OUTPUT DATA SET TO MAKE AN EOF MARK       19030 08967519
         TM    IEHMVV20+1,UNLODE  IS THIS A UNLOAD SITUATION    PTM3086 08967619
         BO    SETZERO            YES, SET UNLOAD RCD LNTH TO 0 PTM3086 08967719
         OC    NXTRD(3),NXTRD     IS THIS THE LAST RECORD       PTM3086 08967819
         BC    8,TESTTRK         YES, GO SEE IF TRKS ARE EQUAL  PTM3086 08967919
TRKCMPR  CLC   TTIR(2),WRTTR      ARE TR'S EQUAL                  19030 08968219
         BE    LASTEOF            YES, GO WRITE EOF               19030 08968319
         BAL   RG9,WRTR01         WRITE R0 FOR LAST TRK           19030 08968419
         B     TRKCMPR            GO COMPARE TRKS                 19030 08968519
LASTEOF  OC    KEYLGN(2),KEYLGN   IS KEYLENGTH ZERO             PTM3086 08968619
         BNZ   SETLNZRO           NO, SET DATA LNTH TO ZERO     PTM3086 08968719
         L     RG2,KEYADR         GET ADDRESS OF KEY            PTM3086 08968819
         XC    0(3,RG2),0(RG2)    CLEAR KEY AND RECORD LNTH     PTM3086 08968919
         L     RG2,IEHMVV31       ADDR OF TO DCB                PTM3086 08969019
         OI    KEY(RG2),X'01'     SET KEY TO ONE                PTM3086 08969119
ZROLNWRT L     RG2,IEHMVV31        ADDR OF 'TO' DCB             PTM3086 08969219
         WRITE DECBOUT,SFR,(RG2),INPUT,,WRTTR,MF=E ZERO LEN REC PTM3086 08969319
         CHECK DECBOUT                                          PTM3086 08969419
         OI    LSTWRTI,X'01'      SET LST WRT INDCTR TO DATA    PTM3086 08969519
         MVC   KEY(1,RG2),KEYLGN+1  RESET KEY LENGTH IN DCB     PTM3086 08969619
         TM    IEHMVV20+1,LODE     IS THIS A LOAD SITUATION     PTM3086 08969719
         BO    LOAD               YES,GO LOAD NEXT RCD          PTM3086 08969819
         TM    FSTR0SW+1,X'01'     IS LAST EOF WRITTEN          PTM3086 08969919
         BO    LSTWRT              YES TEST FOR LAST R0 WRITE   PTM3086 08970019
         CLI   NXTRD+2,X'00'      IS NEXT READ A R0             PTM3086 08970119
         BNE   LOADTEST           GO PROCESS NEXT RECORD        PTM3086 08970219
GOWRITSZ BAL   RG9,WRTR01         GO WRITE R0                   PTM3086 08970319
         OI    LSTWRTI,X'00'      INDICATE LAST WRITE WAS R0    PTM3086 08970419
         B     LOADTEST           GO PROCESS NEXT RECORD        PTM3086 08970519
SETLNZRO L     RG2,BUFADR         GET ADDRESS OF DATA BUFFER    PTM3086 08970619
         XC    0(2,RG2),0(RG2)    SET DATA LENGTH TO ZERO       PTM3086 08970719
         B     ZROLNWRT           GO WRITE ZERO LNTH RECORD     PTM3086 08970819
TESTTRK  CLC   TTIR(2),WRTTR      ARE THE TRKS EQUAL            PTM3086 08970919
         BE    SETLAST            YES, PROCESS LAST RECORD      PTM3086 08971019
         BAL   RG9,WRTR01         GO WRITE R0 FOR LAST TRK      PTM3086 08971119
         B     TESTTRK            CHECK TRACK EQUALITY          PTM3086 08971219
SETLAST  OI    FSTR0SW+1,X'01'    INDICATE RETURN TO LSTWRT     PTM3086 08971319
         B     LASTEOF            GO WRITE LAST LAST EOF        PTM3086 08971419
         B     LASTEOF             GO WRITE LAST ZERO LNTH RCD    19030 08972119
*                                                                       08972219
LSTWRT   CLI   WRTTR+2,X'01'      IS NEXT WRITE AN R0             19030 08972319
         BE    GETOUT             YES,DATA MNGMNT WROTE R0        19030 08972419
         L     RG2,IEHMVV31       ADDR OF 'TO' DCB                19030 08972519
         WRITE DECBOUT,SZ,(RG2),MF=E  WRITE LAST R0               19030 08972619
         CHECK DECBOUT                                            19030 08972719
         B     GETOUT               WRAPUP                        19030 08972819
*                                                                       08972919
SETZERO  SR    RG5,RG5                                            19030 08973019
         B     UNLOAD                                             19030 08973119
SYNBSM   DC    AL3(SYNRET)                                              08980000
SYNEOF   DC    AL3(EOFRET)                                              09000000
XXITLE   DC    X'03'                                               UL0H 09004017
         DC    AL3(ITLR)                                           UL0H 09008017
ZEROS    DC    F'0'                                                UL0H 09012017
UTL1DEF  DC    CL4'UTL1'                                           UL0H 09016017
BWRITE   DC    A(IEHMVERM)                                              09020000
         EXTRN IEHMVERM                                                 09040000
BREAD    DC    A(IEHMVERK)                                              09060000
         EXTRN IEHMVERK                                                 09080000
         DS    0H                                                       09100000
ONEO     DC    X'00000100'                                              09120000
*                                                                  UL0H 09124017
*              USER   INPUT   TRAILER   LABEL   EXIT   ROUTINE     UL0H 09128017
*                                                                  UL0H 09132017
ITLR     DS    0H                                                  UL0H 09136017
OFFSET1  EQU   ITLR-IEHMVETL                                       UL0H 09140017
         LA    RG3,OFFSET1             SET UP                      UL0H 09144017
         SR    RTCD15,RG3              ADDRESSABILITY              UL0H 09148017
         LR    BASE10,RTCD15           FOR EXIT ROUTINE            UL0H 09152017
         L     RG3,0(RG1)              GET ADDR OF LABEL BUFFER    UL0H 09161017
         LTR   RG3,RG3                 ANY LABELS PRESENT          UL0H 09161217
         BNZ   IOERR                   YES, GO CHK IF I/O ERROR    UL0H 09161417
NOLABEL  DS    0H                                                  UL0H 09161617
         SR    RTCD15,RTCD15           NO LABELS,RETURN CODE ZERO  UL0H 09161817
         BR    RET14                   RETURN TO EOV               UL0H 09162017
*                                                                  UL0H 09162217
IOERR    DS    0H                                                  UL0H 09162417
         TM    8(RG1),X'80'            I/O ERR FLAG ON IN PARAMS   UL0H 09162617
         BC    14,TRKAVAIL             NO, CHECK IF U.L. TRACK     UL0H 09162817
*                                      WAS ALLOCATED FOR LABELS    UL0H 09163017
*                                                                  UL0H 09163217
LABERR   DS    0H                                                  UL0H 09163417
*                                                                  UL0H 09163617
* I/O ERROR ENCOUNTERED READING USER INPUT TRAILER LBLS, GIVE MSG  UL0H 09163817
*                                                                  UL0H 09164017
         OI    IEHMVV74+4,X'FF'   SET LABEL I/O ERROR FLAG         UL0H 09164417
         BR    RET14              RETURN TO EEOV                        09164817
*                                                                  UL0H 09165417
TRKAVAIL DS    0H                                                  UL0H 09165617
         CLI   IEHMVV72+10,X'FF'       DA + NLT FLAG ON            UL0H 09165817
         BNE   CORAVAIL                NO, IS CORE ALREADY GOTTEN  UL0H 09166017
*                                                                  UL0H 09166217
* VESN WILL OUTPUT MESSAGE NO USER LBLS MOVED/COPIED. NO U.L. TRK  UL0H 09166417
*                                                                  UL0H 09166617
         MVI   IEHMVV72+14,X'FF'       TELL VESN TO PUT OUT MSG    UL0H 09166817
CANCEL   MVI   UDCBITLE,X'00'          DEACTIVATE INPUT, OUTPUT    UL0H 09167017
         MVI   UDCBOTLE,X'00'          TRAILER LBL EXITS IN DCB    UL0H 09167217
         OI    IEHMVV20+2,X'40'        SET FLAG FOR VESN MESSAGE   UL0H 09167417
*                                      DATA SET(S) NOT MOVED OR    UL0H 09167617
*                                      COPIED, ERROR SITUATION     UL0H 09167817
         B     NOLABEL                 RETURN TO EOV               UL0H 09168017
*                                                                  UL0H 09168217
CORAVAIL DS    0H                                                  UL0H 09168417
         CLC   IEHMVV72(4),ZEROS       ANY CORE AVAILABLE ALREADY  UL0H 09168617
         BNE   INITIAL                 YES, INITIALIZE POINTERS    UL0H 09168817
*                                                                  UL0H 09169017
         GETMAIN  R,LV=640             NO, GETMAIN TO SAVE LABELS  UL0H 09169217
*                                                                  UL0H 09169417
         ST    RG1,IEHMVV72+4          SAVE GOTTEN CORE ADDRESS    UL0H 09169917
*                                                                  UL0H 09170417
INITIAL  DS    0H                                                  UL0H 09170917
         CLC   0(4,RG3),UTL1DEF        FRST LABEL IN GROUP         UL0H 09171417
         BNE   SAVLABEL                NO, BYPASS 1ST LABEL SETUP  UL0H 09171917
         MVC   IEHMVV72+4(4),IEHMVV72  NO, SET PTR TO LBL SAVEAREA UL0H 09172417
         MVI   IEHMVV72+12,X'00'       INITIALIZE LBL CTR TO ZERO  UL0H 09172917
*                                                                  UL0H 09173417
SAVLABEL DS    0H                                                  UL0H 09173917
         L     RG1,IEHMVV72+4          GET ADDR OF CURRENT LBL AREAUL0H 09174417
         MVC   0(80,RG1),0(RG3)        SAVE LABEL IN GOTTEN CORE   UL0H 09174917
         LA    RG1,80(RG1)             UP PTR TO NEXT LOCATION     UL0H 09175417
         ST    RG1,IEHMVV72+4          AND SAVE ADDRESS            UL0H 09175917
         SR    RG1,RG1                 INCREMENT                   UL0H 09176417
         IC    RG1,IEHMVV72+12            LABEL                    UL0H 09176917
         LA    RG1,1(RG1)                    COUNTER               UL0H 09177417
         STC   RG1,IEHMVV72+12                  BY 1, AND SAVE     UL0H 09177917
         LA    RTCD15,4                SET RC=4 FOR MORE LABELS    UL0H 09178417
         BR    RET14                   RETURN TO EOV PROCESSING    UL0H 09178917
CHLIOER  TM    IEHMVV74+4,X'FF'   TEST LABEL I/O ERROR FLAG        UL0H 09179017
         BCR   12,RET14           NOT ON - RETURN.                 UL0H 09179117
         BAL   RG9,CLEAR          BLANK OUT PRINT BUFFER           UL0H 09179217
         L     RG8,AM07           LOAD ADDRESS OF MSG ADDRESS      UL0H 09179317
         IC    RG7,0(RG8)         LOAD MSG LENGTH                  UL0H 09179417
         L     RG8,0(RG8)         LOAD ACTUAL MSG ADDRESS          UL0H 09179517
         EX    7,MOVER            MOVE MSG TO PRINT BUFFER         UL0H 09179617
         B     MESG03             GO TO MESSAGE WRITER             UL0H 09179717
AM01     DC    A(M01)                                                   09180000
AM02     DC    A(M02)                                                   09200000
AM03     DC    A(M03)                                                   09220000
AM04     DC    A(M04)                                                   09240000
AM05     DC    A(M05)                                                   09260000
AM06     DC    A(M06)                                                   09280000
AM07     DC    A(M07)                                              UL0H 09290017
AM08     DC    A(M08)             ADDRESS OF UNCORRECTABLE ERROR A27313 09295019
*                                                                       09300000
*                                                                       09320000
*                                                                       09340000
         SPACE 3                                                        09360000
WRKBUF   DSECT                                                          09380000
CCHH     DS    F                                                        09400000
R0       DS    CL1                     COUNT OF NUMBER OF RECORDS       09420000
COUNT    DS    CL2                     ON TRACK                         09440000
         DS    CL1                                                      09460000
SWITCH   DS    H   FOR VS RECORDS THIS IS USED TO SAVE THE        19030 09470019
*                  RETURN CODE FROM THE WRITE R0 MACRO. ITS       19030 09480019
*                  CONTENTS WILL BE TESTED FOR END OF EXTENT      19030 09490019
BLKOUT   DS    H                   WORK AREA 64 BYTES                   09500000
KEYLGN   DS    H                                                        09520000
BLKSIZ   DS    H                                                        09540000
KEYADR   DS    F                                                        09560000
BUFADR   DS    F                                                        09580000
NXTRD    DS    F             FEEDBACK FROM READ                   19030 09581019
WRTTR    DS    F             FEEDBACK FROM WRITE                  19030 09582019
RECSIZE  DS    F             SAVE AREA FOR RECORD SIZE            19030 09583019
FSTR0SW  DS    H             FIRST R0 SW  0=OFF  1=ON             19030 09584019
*                            SECOND BYTE USED AS INDICATOR        19030 09585019
*                            01= LAST EOF WAS WRITTEN             19030 09586019
*                            00= IMBEDDED EOF WAS WRITTEN         19030 09587019
LSTWRTI  DS    H             LAST REC WRITTEN  0=R0  1=DATA       19030 09588019
*                            SECOND BYTE USED AS INDICATOR        19030 09589019
*                            01= KEY WAS CHANGED FOR EOF WRITE    19030 09590019
*                            00= KEY WAS NOT CHANGED              19030 09591019
INDECB   DS    CL1                                                      09600000
EXCD01   DS    CL1                                                      09620000
EXCD02   DS    CL2                                                      09640000
         DS    7F                 INPUT DECB EXTENSION            19030 09660019
DECBOUT  DS    6F                 OUTPUT DECB                     19030 09680019
BLKREF   DS    2F                                                       09700000
TTIR     DS    H                                                        09720000
IREC     DS    H                                                        09740000
GOTEN    DS    F                                                        09760000
LLI      DS    CL3            LENGTH AND INDICATOR FOR BWRITE           09780000
MBBCCHHR DS    CL8            USED WHEN LOADING WITH ABSOLUTE DISK ADDR 09800000
INPUT    DS    CL1            READ IN AREA                              09820000
         IEHMVV                                                         09840000
         ORG   IEHMVV70                                            UL0H 09846017
         IEHDCBXL                                                  UL0H 09852017
*                                                                       09860000
*                                                                       09880000
         END   IEHMVSTL                                           19030 09890019
