TKBA     TITLE 'IGTKBA -- VPSS ISSUE STARTIO REQUEST'                   00070000
*/* * START OF SPECIFICATIONS ************************************** */ 00140000
*/*                                                                  */ 00210000
*/*   MODULE-NAME = IGTKBA                                           */ 00280000
*/*                                                                  */ 00350000
*/*   DESCRIPTIVE-NAME = VPSS STARTIO DRIVER                         */ 00420000
*/*                                                                  */ 00490000
*/*   COPYRIGHT = NONE                                               */ 00560000
*/*                                                                  */ 00630000
*/*   STATUS = RELEASE 1, MODIFICATION LEVEL 0.                      */ 00700000
*/*                                                                  */ 00770000
*/*   FUNCTION = TO SCHEDULE A VPSS I/O REQUEST TO IOS.  THIS        */ 00840000
*/*       INCLUDES SELECTING THE "BEST" 3838 SUBCHANNEL FOR          */ 00910000
*/*       THE I/O, COMPLETING THE IOSB/SRB, AND PASSING THE          */ 00980000
*/*       I/O REQUEST (DESIGNATED BY THE SRB) TO IOS.  AS            */ 01050000
*/*       AUXILARY FUNCTIONS, SMF DATA IS MAINTAINED, PAGES          */ 01120000
*/*       ARE FIXED IF REQUIRED, AND THE USER PLACED IN THE          */ 01190000
*/*       WAIT STATE IF SYNCHRONOUS PROCESSING IS USED.              */ 01260000
*/*                                                                  */ 01330000
*/*   NOTES = THE GENERAL INTERFACE SPECIFICATIONS ARE DETERMINED    */ 01400000
*/*       BY VS/2 (MVS) IOS INTERFACES AS DOCUMENTED IN THE IOS      */ 01470000
*/*       DESIGN NOTEBOOK AND THE SUPERVISOR SRL.                    */ 01540000
*/*                                                                  */ 01610000
*/*     DEPENDENCIES = THE FOLLOWING ARE THE INTERFACES TO THE       */ 01680000
*/*                    SYSTEM ROUTINES --                            */ 01750000
*/*                                                                  */ 01820000
*/*         SETLOCK --                                               */ 01890000
*/*           PURPOSE: BRANCH ENTERED FROM A SUPERVISOR STATE,       */ 01960000
*/*                    KEY-0 ROUTINE DESIRING TO ACQUIRE OR          */ 02030000
*/*                    RELEASE A SYSTEM LOCK.                        */ 02100000
*/*           LINKAGE: BALR (USING MACRO SETLOCK)                    */ 02170000
*/*           INPUT:                                                 */ 02240000
*/*             USE MACRO SETLOCK                                    */ 02310000
*/*           OUTPUT:                                                */ 02380000
*/*             REGISTERS 0-10, 15 UNCHANGED. REGISTERS 11-14        */ 02450000
*/*             ARE DESTROYED. REGISTER 13 HAS THE RETURN CODE--     */ 02520000
*/*             (0) OK, (4/8) ERROR.                                 */ 02590000
*/*                                                                  */ 02660000
*/*         PGFIX  (IEAVPSIB) --                                     */ 02730000
*/*           PURPOSE: BRANCH ENTERED FROM A SUPERVISOR STATE,       */ 02800000
*/*                    KEY-0 ROUTINE DESIRING A PAGE SERVICES        */ 02870000
*/*                    FUNCTION.                                     */ 02940000
*/*           LINKAGE: BALR - ADDRESS IN CVTVPSIB                    */ 03010000
*/*           INPUT:                                                 */ 03080000
*/*             LOCAL LOCK HELD                                      */ 03150000
*/*             R0   - ECB ADDRESS OR ZERO                           */ 03220000
*/*             R1,R2- IF BYTE 0 BIT 0 OF R1=1, THEN R1 CONTAINS     */ 03290000
*/*                    A POINTER TO A VIRTUAL SUBAREA LIST (VSL)     */ 03360000
*/*                    AND R2 IS IRRELEVANT (THE VSL MUST ALREADY    */ 03430000
*/*                    BE IN FIXED STORAGE).                         */ 03500000
*/*                    IF BYTE 0 BIT 0 OF R1=0, THEN R1 AND R2       */ 03570000
*/*                    FORM A VSL ENTRY.                             */ 03640000
*/*             R4   - TCB ASSOCIATED WITH PAGE FIX REQUEST.         */ 03710000
*/*                    IF ZERO, NO TCB SO DO NOT BUILD FOE'S         */ 03780000
*/*             R14  - RETURN ADDRESS                                */ 03850000
*/*             R15  - ENTRY POINT OF IEAVPSIB                       */ 03920000
*/*           OUTPUT:                                                */ 03990000
*/*             LOCAL LOCK STILL HELD.                               */ 04060000
*/*             REGISTERS 0-14 ARE UNCHANGED.                        */ 04130000
*/*             REGISTER 15 HAS RETURN CODE (SAME AS PGFIX/PGFREE    */ 04200000
*/*             SVC REQUESTS).                                       */ 04270000
*/*             ECB POINTED TO BY REGISTER 0 (IF ANY) IS POSTED.     */ 04340000
*/*                                                                  */ 04410000
*/*         SUSPEND -- IEAVETCL                                      */ 04480000
*/*           PURPOSE: BRANCH ENTERED FROM A SUPERVISOR STATE,       */ 04550000
*/*                    KEY-0 ROUTINE DESIRING TO 'SUSPEND' AN        */ 04620000
*/*                    RB.                                           */ 04690000
*/*           LINKAGE: BALR - USING MACRO SUSPEND                    */ 04760000
*/*           INPUT:                                                 */ 04830000
*/*             R1   - SUSPEND INDICATORS                            */ 04900000
*/*             R14  - RETURN ADDRESS (SET BY MACRO)                 */ 04970000
*/*             R15  - ADDRESS OF SUSPEND PROCESSOR (SET BY MACRO)   */ 05040000
*/*           OUTPUT:                                                */ 05110000
*/*             REGISTER 0 CONTAINS THE ADDRESS OF THE SUSPENDED TCB */ 05180000
*/*             REGISTER 1 CONTAINS THE ADDRESS OF THE SUSPENDED RB  */ 05250000
*/*             REGISTERS 2-10 ARE RETURNED UNCHANGED.               */ 05320000
*/*             REGISTER 11-15 ARE DESTROYED AND ARE UNPREDICTABLE   */ 05390000
*/*                                                                  */ 05391000
*/*         RESUME  -- IEAVRSME                                      */ 05392000
*/*           PURPOSE: BRANCH ENTERED FROM A SUPERVISOR STATE,       */ 05393000
*/*                    KEY-0 ROUTINE DESIRING TO 'RESUME' AN         */ 05394000
*/*                    RB.                                           */ 05395000
*/*           LINKAGE: BALR - USING MACRO RESUME                     */ 05396000
*/*           INPUT:                                                 */ 05397000
*/*             R4   - ADDRESS OF TCB TO 'RESUME'                    */ 05398000
*/*             R5   - ADDRESS OF RB TO 'RESUME'                     */ 05399000
*/*             R14  - RETURN ADDRESS (SET BY MACRO)                 */ 05400000
*/*             R15  - ADDRESS OF RESUME PROCESSOR  (SET BY MACRO)   */ 05401000
*/*           OUTPUT:                                                */ 05402000
*/*             REGISTERS 2-10 UNCHANGED.                            */ 05403000
*/*             REGISTERS 0-1, 11-15 ARE UNPREDICTABLE.              */ 05404000
*/*                                                                  */ 05405000
*/*         PGFREE -- IEAVPSIB                                       */ 05406000
*/*           PURPOSE: BRANCH ENTERED FROM A SUPERVISOR STATE,       */ 05407000
*/*                    KEY-0 ROUTINE DESIRING A PAGE SERVICES        */ 05408000
*/*                    FUNCTION.                                     */ 05409000
*/*           LINKAGE: BALR - ADDRESS IN CVTVPSIB                    */ 05410000
*/*           INPUT:                                                 */ 05411000
*/*             LOCAL LOCK HELD                                      */ 05412000
*/*             R0   - ECB ADDRESS OR ZERO                           */ 05413000
*/*             R1,R2- IF BYTE 0 BIT 0 OF R1=1, THEN R1 CONTAINS     */ 05414000
*/*                    A POINTER TO A VIRTUAL SUBAREA LIST (VSL)     */ 05415000
*/*                    AND R2 IS IRRELEVANT (THE VSL MUST BE IN      */ 05416000
*/*                    FIXED STORAGE).                               */ 05417000
*/*                    IF BYTE 0 BIT 0 OF R1=0, THEN R1 AND R2       */ 05418000
*/*                    FORM A VSL ENTRY.                             */ 05419000
*/*             R4   - TCB ASSOCIATED WITH THE PGFIX REQUEST.        */ 05420000
*/*                    IF ZERO, NO FOE(S) BUILT.                     */ 05421000
*/*             R14  - RETURN ADDRESS                                */ 05422000
*/*             R15  - ADDRESS OF PAGE SERVICES (IEAVPSIB)           */ 05423000
*/*           OUTPUT:                                                */ 05424000
*/*             LOCAL LOCK STILL HELD.                               */ 05425000
*/*             REGISTERS 0-14 ARE UNCHAGED.                         */ 05426000
*/*             REGISTER 15 HAS THE RETURN CODE (SAME AS PGFREE      */ 05427000
*/*             SVC REQUESTS).                                       */ 05428000
*/*             SPECIFIED PAGE(S) HAVE THE FIX COUNTS REDUCED.       */ 05429000
*/*                                                                  */ 05460000
*/*     RESTRICTIONS = THE SUSPEND (IF ANY) MUST BE ISSUED PRIOR     */ 05530000
*/*         TO THE STARTIO REQUEST TO INSURE THE SUSPEND OCCURS      */ 05600000
*/*         PRIOR TO THE RESUME.  ALSO, THE LOCAL LOCK MUST BE       */ 05670000
*/*         OWNED PRIOR TO TRANSLATING THE CCW AND IDAL ADDRESSES    */ 05740000
*/*         TO REAL ADDRESSES AND NOT RELEASED BEFORE ISSUING THE    */ 05810000
*/*         STARTIO REQUEST.  THIS INSURES THAT THE USER IS NOT      */ 05880000
*/*         SWAPPED OUT, THUS CHANGING THE VIRTUAL TO REAL MAPPING.  */ 05950000
*/*         HOLDING THE LOCAL LOCK INSURES THAT PURGE (AND THUS      */ 06020000
*/*         SWAP) DOES NOT COMPLETE BEFORE THE I/O.                  */ 06090000
*/*                                                                  */ 06160000
*/*     REGISTER-CONVENTIONS = NONE                                  */ 06230000
*/*                                                                  */ 06300000
*/*     PATCH-LABEL = APPATCH                                        */ 06370000
*/*                                                                  */ 06440000
*/*   MODULE-TYPE = CSECT                                            */ 06510000
*/*                                                                  */ 06580000
*/*     PROCESSOR = VS/2 ASSEMBLER                                   */ 06650000
*/*                                                                  */ 06720000
*/*     MODULE SIZE = SEE END OF SOURCE LISTING                      */ 06790000
*/*                                                                  */ 06860000
*/*     ATTRIBUTES = RE-ENTRANT                                      */ 06930000
*/*                                                                  */ 07000000
*/*   ENTRY-POINT = IGTKBA                                           */ 07070000
*/*                                                                  */ 07140000
*/*     PURPOSE = VPSS STARTIO DRIVER                                */ 07210000
*/*                                                                  */ 07280000
*/*     LINKAGE = BRANCHED TO BY IGTKAA (WHICH WAS INDIRECTLY        */ 07350000
*/*               ENTERED BY SVC 111).  THIS ROUTINES EXECUTES       */ 07420000
*/*               IN KEY-0, SUPERVISOR STATE, ENABLED, UNDER         */ 07490000
*/*               AN SVRB.                                           */ 07560000
*/*                                                                  */ 07630000
*/*     INPUT = THE FOLLOWING REGISTERS ARE INITIALIZED ON ENTRY --  */ 07700000
*/*         REGISTER  1 - APRL ADDRESS                               */ 07770000
*/*         REGISTER  2 - DEB ADDRESS                                */ 07840000
*/*         REGISTER  3 - CVT ADDRESS                                */ 07910000
*/*         REGISTER  4 - ADDRESS OF TCB WHICH ISSUED THE REQUEST    */ 07980000
*/*         REGISTER 11 - ADDRESS OF VPSS DEB EXTENSION              */ 08050000
*/*         REGISTER 12 - ADDRESS OF THE VPSS APCT                   */ 08120000
*/*         REGISTER 15 - ADDRESS OF THIS ROUTINE (IGTKBA)           */ 08190000
*/*         NOTE: REGISTER 14 DOES NOT CONTAIN RETURN ADDRESS        */ 08260000
*/*         ROUTINE IS ENTERED IN KEY-0, SUPERVISOR STATE,           */ 08330000
*/*              UNLOCKED, TASK MODE, ENABLED.                       */ 08400000
*/*                                                                  */ 08470000
*/*     OUTPUT = REGISTER 15 IS SET TO INDICATE IF THE REQUEST       */ 08540000
*/*         WAS SUCCESSFUL.  REGISTERS 0 AND 1 ARE UNPREDICATABLE.   */ 08610000
*/*         REGISTER 2-14 RETURN TO THE SVC CALLER UNCHANGED.        */ 08680000
*/*         NO LOCKS MAY BE OWNED ON EXIT.                           */ 08750000
*/*                                                                  */ 08820000
*/*   EXIT-NORMAL = EXIT IS TO THE BRANCH ENTRY FOR SVC-3 (EXIT).    */ 08890000
*/*                 IF ASYNCHRONOUS PROCESSING (WAIT/POST) IS USED,  */ 08960000
*/*                 CONTROL RETURNS TO IEAVEXP1. OTHERWISE           */ 09030000
*/*                 (SUSPEND/RESUME) CONTROL RETURNS TO IEAVEXPR.    */ 09100000
*/*                                                                  */ 09170000
*/*   EXIT-ERROR = RETURN TO ISSUER VIA SVC-3 BRANCH ENTRY.          */ 09240000
*/*                SET REGISTER 15 = 8, AND INDICATE IN THE APRL     */ 09250000
*/*                THAT THE REQUEST FAILED.  THE ECB COMPLETION      */ 09260000
*/*                CODE IS SET TO HEX '40' TO INDICATE A STARTIO     */ 09270000
*/*                FAILURE RATHER THAN A 3838 ERROR.                 */ 09280000
*/*                                                                  */ 09310000
*/*   EXTERNAL-REFERENCES = THE FOLLOWING SYSTEM ROUTINES AND        */ 09380000
*/*                         CONTROL BLOCKS ARE USED.                 */ 09450000
*/*                                                                  */ 09520000
*/*     ROUTINES =                                                   */ 09590000
*/*         SETLOCK                                                  */ 09660000
*/*         PGFIX                                                    */ 09730000
*/*         SUSPEND                                                  */ 09800000
*/*         IOS STARTIO INTERFACE                                    */ 09870000
*/*         IEAVEXIT                                                 */ 09940000
*/*         PGFREE                                                   */ 09950000
*/*         RESUME                                                   */ 09960000
*/*         IGTUKA (FRR/ESTAE EXIT ROUTINE)                          */ 09970000
*/*                                                                  */ 10010000
*/*     DATA-AREAS =                                                 */ 10080000
*/*         VSL      - R, M  (VIRTUAL STORAGE LIST)                  */ 10150000
*/*         ECB      - M     (EVENT CONTROL BLOCK)                   */ 10220000
*/*         APES     -       C (IGTUKA INTERFACE BLOCK)              */ 10250000
*/*                                                                  */ 10290000
*/*     CONTROL-BLOCKS =                                             */ 10360000
*/*         PSA      - R                                             */ 10430000
*/*         CVT      - R                                             */ 10500000
*/*         PVT      - R                                             */ 10530000
*/*         IOCOM    - R                                             */ 10570000
*/*         ASCB     - R                                             */ 10580000
*/*         ASXB     - R, M                                          */ 10590000
*/*         FRRS     - R, M                                          */ 10600000
*/*         IOSB     - R, M                                          */ 10640000
*/*         SRB      - R                                             */ 10710000
*/*         TCB      - R                                             */ 10780000
*/*         RB       - R                                             */ 10810000
*/*         DEB      - R                                             */ 10850000
*/*         APIO     - R, M                                          */ 10920000
*/*         APUB     - R, M                                          */ 10990000
*/*         APRL     - R, M                                          */ 11060000
*/*         APCT     - R                                             */ 11130000
*/*         APDS     - R, M                                          */ 11200000
*/*         APDX     - R, M                                          */ 11270000
*/*         APMF     - R, M                                          */ 11340000
*/*         APVU     - R, M                                          */ 11370000
*/*         APXL     - R                                             */ 11410000
*/*                                                                  */ 11480000
*/*   TABLES =                                                       */ 11550000
*/*         APCC                                                     */ 11560000
*/*         APCM                                                     */ 11570000
*/*                                                                  */ 11620000
*/*   MACROS =                                                       */ 11690000
*/*       SUSPEND                                                    */ 11760000
*/*       STARTIO                                                    */ 11830000
*/*       MODESET                                                    */ 11900000
*/*       SETLOCK                                                    */ 11970000
*/*       RESUME                                                     */ 11980000
*/*       SETFRR                                                     */ 11990000
*/*       ABEND                                                      */ 12000000
*/*       IGTXEPLG                                                   */ 12040000
*/*                                                                  */ 12110000
*/*   CHANGE-ACTIVITY = NONE                                         */ 12180000
*/*                                                                  */ 12250000
*/*   MESSAGES = NONE                                                */ 12320000
*/*                                                                  */ 12390000
*/*   ABEND-CODES = NONE                                             */ 12460000
*/*                                                                  */ 12530000
*/* * END OF SPECIFICATIONS **************************************** */ 12600000
         EJECT ,                                                        12670000
IGTKBA   CSECT ,                   ISSUE STARTIO REQUEST                12740000
         USING *,R15               INPUT BASE                           12810000
         B     STARTUP             SKIP IN-CORE ID                      12880000
         DC    YL1(COREIDE-*-1)    * ID LENGTH                          12950000
         DC    C'IGTKBA'           * MODULE NAME                        13020000
         DC    C' &SYSDATE '       * ASSEMBLY DATE                      13090000
COREIDE  EQU   *                   * END OF ID                          13160000
         SPACE 3                                                        13230000
STARTUP  DS    0H                  START OF CODE                        15260000
         SPACE 2                                                        15330000
*********************************************************************** 17360000
**                                                                   ** 17430000
** VERIFY INPUT AND ESTABLISH RECOVERY ENVIRONMENT                   ** 17500000
**                                                                   ** 17570000
*********************************************************************** 17640000
         SPACE 2                                                        17710000
*                                                                       17780000
** INPUT REGISTERS                                                      17850000
*                                                                       17920000
         USING FLC,*-*             LOW CORE (0-4095) NEEDS NO BASE      17990000
         USING DEBBASIC,RDEBPTR    DEB (BASIC SECTION)                  18060000
         USING CVTMAP,RCVTPTR      CVT                                  18130000
         USING TCB,RTCBPTR         USER'S TCB                           18200000
         USING ASCB,RASCBPTR       CURRENT ASCB                         18270000
         USING APRL,R1             VPSS APRL                            18340000
         USING APDX,RXAPDX         VPSS DEB EXTENSION                   18410000
         SPACE 2                                                        18480000
*                                                                       18550000
** ESTABLISH NEW BASE AND SAVE VOLITILE POINTERS                        18620000
*                                                                       18690000
         LA    RCODE,0(,R15)       NEW BASE. HI-BIT SHOWS IF            18760000
*                                  * ASYNCHRONOUS I/O (=1).             18830000
         LR    RAPRLPTR,R1         SAVE APRL ADDRESS                    18900000
         LR    RAPDXPTR,RXAPDX     SAVE APDX ADDRESS                    18970000
         DROP  R1,RXAPDX,R15,RTCBPTR,RASCBPTR NOT NEEDED                19040000
         USING IGTKBA,RCODE        TELL ASSEMBLER                       19110000
         USING APRL,RAPRLPTR       * OF THE NEW                         19180000
         USING APDX,RAPDXPTR       * BASE REGISTERS                     19250000
*                                                                       19320000
** CURRENTLY ASSIGNED REGISTERS:                                        19390000
**      R2         DEBBASIC                                             19460000
**      R3         CVTMAP                                               19530000
**      R4         APRL                                                 19600000
**      R5         APDX                                                 19670000
**      R6         BASE REGISTER                                        19740000
*                                                                       19810000
         EJECT ,                                                        19880000
*                                                                       19950000
** SWITCH TO THE USER'S PROTECT KEY. INITIALIZE THE USER'S              20020000
** ECB COMPLETION CODE. THEN SAVE REQUIRED APRL VALUES                  20090000
** BEFORE RETURNING TO KEY 0.                                           20160000
*                                                                       20230000
         MODESET KEYADDR=DEBPROTG, SWITCH TO USER KEY                  *20300000
               WORKREG=7           * (KEY OF OPEN REQUESTOR)           *20370000
                                   * KEEP APRL KEY IN REG 7             20390000
         MVI   APRLECBC,ECBNORM    NORMAL I/O COMPLETION CODE           20440000
         TM    APRLOPT0,APRLASY    ASYNCHRONOUS (WAIT/POST) REQUEST ?   20510000
         BZ    RESUME1             * NO--SUSPEND/RESUME. LEAVE POSTED   20580000
         MVI   APRLECBC,0          SHOW NOT YET POSTED                  20650000
         O     RCODE,CASYNCH       SHOW ASYNCHROUS I/O REQUEST          20720000
*                                  * (BASE REGISTER NEGATIVE)           20790000
RESUME1  EQU   *                   SYNCHRONOUS/ASYNCHROUS DETERMINED    20860000
         L     RAPIONUM,APRLAPIO   APIO INDEX INTO APDX                 20930000
         MODESET EXTKEY=ZERO       RESUME NORMAL KEY                    21000000
         DROP  RDEBPTR             FINISHED WITH DEBBASIC               21070000
*                                                                       21140000
** CURRENTLY ASSIGNED REGISTERS:                                        21210000
**      R2         APDXAPIO INDEX VALUE (APRLAPIO)                      21280000
**      R3         CVTMAP                                               21350000
**      R4         APRL                                                 21420000
**      R5         APDX                                                 21490000
**      R6         BASE REGISTER                                        21560000
**      R7         USER PROTECT KEY (FROM DEB)                          21590000
*                                                                       21630000
         SPACE 3                                                        21700000
*                                                                       21770000
** OBTAIN THE LOCAL LOCK. THIS IS REQUIRED FOR ALL                      21840000
** FURTHER PROCESSING (UNTIL THE I/O ISSUED).                           21910000
** REGISTERS DESTROYED: 11,12,13,14.                                    21980000
*                                                                       22050000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND, GET THE LOCAL LOCK     *22120000
               RELATED=STARTIO     * REQUIRED BY STARTIO.               22190000
         LTR   RAPIOPTR,R13        LOCK ACQUIRED ?  (CLEAR RAPIOPTR)    22260000
         BNZ   ERRORA              * NO--ERROR                          22330000
         SPACE 3                                                        22400000
*                                                                       22470000
** ESTABLISH RECOVERY ENVIRONMENT AND RECOVERY WORKAREA                 22540000
** REGISTER 'RFRRSTK' SET TO ADDRESS 6-WORD RECOVERY-TRACING AREA       22610000
*                                                                       22680000
** REGISTERS DESTROYED: R11, R12 (SEE WRKREGS OPTION)                   22750000
*                                                                       22820000
         SETFRR A,FRRAD=CXSTAEAD,  PROVIDE RECOVERY RTN - XSTAE        *22890000
               PARMAD=(RFRRSTK),   * PUT 6-WORD WORKAREA IN RFRRSTK    *22960000
               CLEAR=NO,           * DO NOT CLEAR DSECT                *23030000
               WRKREGS=(R11,R12),  * WORK REGS (DESTROYED BY SETLOCK)  *23100000
               RELATED=(DFRRSTK)   * DFRRSTK IS 6-WORD DSECT            23170000
         USING DFRRSTK,RFRRSTK     RECOVERY TRACING DSECT               23240000
         ST    RAPIOPTR,DFRRAPIO   SHOW NO APIO IN RECOVERY             23310000
         ST    RAPRLPTR,DFRRAPRL   SAVE APRL ADDRESS (IN CASE ERROR     23380000
*                                  * MUST BE REPORTED TO USER)          23450000
         STC   R7,DFRRKEY          SAVE APRL PROTECTION KEY             23460000
*                                  * DONE WITH REGISTER 7               23470000
         MVI   DFRRCODE,CERRN99    SET DEFAULT ERROR CODE               23480000
         L     R0,APDXAPCT         SAVE ADDRESS OF THE APCT             23520000
         ST    R0,DFRRAPCT         * IN THE RECOVERY WORKAREA           23590000
         DROP  RAPRLPTR            DON'T NEED REGISTER POINTER          23660000
*                                                                       23730000
** CURRENTLY ASSIGNED REGISTERS:                                        23800000
**      R2         APDXAPIO INDEX VALUE (APRLAPIO)                      23870000
**      R3         CVTMAP                                               23940000
**      R5         APDX                                                 24010000
**      R6         BASE REGISTER                                        24080000
**      R8         DFRRSTK                                              24150000
**      R9         APIO (CURRENTLY 0)                                   24220000
*                                                                       24290000
         SPACE 3                                                        24360000
*                                                                       24430000
** FIND THE APIO FOR THIS REQUEST. REGISTER 'RAPIONUM'                  24500000
** HAS THE APDX INDEX VALUE.                                            24570000
*                                                                       24640000
         CH    RAPIONUM,APDXIOCT   MUST NOT EXCEED APDX LIMIT           24710000
         BH    ERRORB              * ELSE IS ERROR                      24780000
         AR    RAPIONUM,RAPIONUM   MAKE RAPIONUM = OFFSET INTO APDX     24850000
         BNP   ERRORB              IS ERROR IF NEGATIVE OR ZERO INDEX   24920000
         AR    RAPIONUM,RAPIONUM   RAPIONUM = 4*INDEX                   24990000
*                                                                       25060000
** RAPIOPTR SET TO ZERO FROM SETLOCK ABOVE                              25130000
*                                                                       25200000
         A     RAPIOPTR,APDXAPIO-L'APDXAPIO(RAPIONUM) POINT TO APIO     25270000
         BZ    ERRORB              APIO EXIST ?                         25340000
*                                  * NO -- ERROR                        25410000
         USING APIO,RAPIOPTR       TELL ASSEMBLER OF BASE TO APIO       25480000
*                                                                       25550000
** CURRENTLY ASSIGNED REGISTERS:                                        25620000
**      R3         CVTMAP                                               25690000
**      R5         APDX                                                 25720000
**      R6         BASE REGISTER                                        25760000
**      R8         DFRRSTK                                              25900000
**      R9         APIO (INCLUDES IOSB AND SRB)                         25970000
*                                                                       26040000
*                                                                       26110000
         SPACE 2                                                        26180000
*                                                                       26250000
** INSURE VALID APIO (SYSTEM ERROR IF NOT)                              26320000
** TERMINATE REQUEST IF INVALID. THIS CHECK                             26390000
** MINIMIZES EFFECT OF STORAGE OVERLAY.                                 26460000
*                                                                       26530000
         L     R0,CAPIOID          LOAD CONTROL BLOCK ID (='APIO')      26600000
         C     R0,APIOID           INSURE CONTROL BLOCK OK              26640000
         BNE   ERRORG              * ERROR IF NOT (APDX OR APIO)        26740000
         SPACE 3                                                        26810000
*                                                                       26880000
** SEE IF APIO CURRENTLY IN-USE (I/O OUTSTANDING).                      26950000
** IF SO, IS ERROR. OTHERWISE, MARK IN USE NOW.                         27020000
*                                                                       27090000
         CLI   APIOACTV,0          APIO IN-USE ?                        27160000
         BNE   ERRORC              * YES -- IS ERROR                    27230000
         L     R0,APIOFLGA         CLEAR THE APIO PROCESSING            27300000
         N     R0,CAPIOFLG         * FLAGS (LEAVE IGTKCA-SET FLAGS)     27370000
         ST    R0,APIOFLGA         * USED FOR I/O & RECOVERY            27440000
         ST    RAPIOPTR,DFRRAPIO   SAVE APIO ADDRESS FOR RECOVERY       27510000
         MVI   APIOACTV,X'FF'      SHOW APIO "OWNED"                    27580000
         LH    R15,APIONBRI        INCREMENT NUMBER OF I/O              27650000
         LA    R15,1(,R15)         * REQUESTS AGAINST                   27700000
         STH   R15,APIONBRI        * THIS APIO.                         27750000
         EJECT ,                                                        27930000
*********************************************************************** 28000000
**                                                                   ** 28070000
** UPDATE SMF STATISTICS.  DATA KEPT IN TWO RECORDS.  THE STANDARD   ** 28140000
** TYPE-4 SMF RECORD CONTAINS THE NUMBER OF I/O REQUESTS USING THE   ** 28210000
** DD-STATEMENT (EQUIVALENT TO THE "NORMAL" EXCP I/O COUNTS).  THE   ** 28280000
** SECOND RECORD TYPE KEEPS SPECIALIZED 3838-VPSS STATISTICS.  THIS  ** 28350000
** RECORD IS POINTED TO BY THE APDX.                                 ** 28420000
**                                                                   ** 28490000
*********************************************************************** 28560000
         SPACE 3                                                        28630000
*                                                                       28700000
** UPDATE THE ASSOCIATED I/O STATISTICS IN THE                          28770000
** STANDARD TYPE-4 SMF RECORD (AS FOR EXCP).                            28840000
*                                                                       28910000
** FOLLOWING REGISTERS FOR SMF ROUTINE (IEASMFEX -- SC102):             28980000
**    0 - TCB ADDRESS                                                   29050000
**    1 - NUMBER OF I/O REQUESTS (ALWAYS 1)                             29120000
**    3 - DEB ADDRESS                                                   29190000
**    7 - UCB ADDRESS (ALWAYS 0)                                        29260000
**   14 - RETURN ADDRESS                                                29330000
**   15 - ENTRY POINT                                                   29400000
** REGISTERS DESTROYED BY THIS PROCESSING: 0, 1, 7, 10-15               29470000
*                                                                       29540000
         MVI   DFRRCODE,CERRN01    SET ERROR CODE                       29570000
         L     R0,PSATOLD          CURRENT TCB                          29610000
         LA    R1,1                INCREMENT I/O COUNT BY 1             29680000
         SR    R7,R7               UCB ADDRESS IN TCT IS 0              29750000
         L     R15,CVTSMFEX        SMF COUNT RTN (IEASMFEX) ADDRESS     29820000
         L     R3,APDXDEB          ASSOCIATED DEB                      *29890000
                                   * NOTE: R3->CVT LOST                 29960000
         CALL  (15)                UPDATE I/O COUNT                     30030000
         MVI   DFRRCODE,CERRN99    SET DEFAULT ERROR CODE               30060000
         L     RCVTPTR,FLCCVT      RE-ESTABLISH CVT ADDRESS             30100000
         SPACE 5                                                        30170000
*                                                                       30240000
** UPDATE THE ASSOCIATED I/O STATISTICS                                 30310000
** IN THE VPSS SMF RECORD (APMF)                                        30380000
** NOTE: SINCE LOCAL LOCK OWNED, APMF UPDATE SERIALIZED.                30450000
**       THEREFORE 'COMPARE-AND-SWAP' NOT REQUIRED                      30520000
**       FOR THE I/O COUNTERS (APMFIXXX).                               30590000
** REGISTERS DESTROYED: 0, 1, 15                                        30660000
*                                                                       30730000
         L     RAPMFPTR,APDXAPMF   POINT TO SMF RECORD                  30800000
         USING APMF,RAPMFPTR       TELL ASSEMBLER                       30870000
         LA    R0,1                COUNT INCREMENT                      30940000
         LTR   RCODE,RCODE         SYNCHRONOUS/ASYNCHRONOUS I/O         31010000
         BP    UPDAPMF1            * BRANCH IF SYNCHRONOUS              31080000
         L     R1,APMFIASY         INCREMENT SYNCHRONOUS I/O COUNT      31150000
         AR    R1,R0                                                    31220000
         ST    R1,APMFIASY                                              31290000
         B     UPDAPMF2            SKIP SYNCH                           31360000
UPDAPMF1 EQU   *                   HERE IF SYNCHRONOUS I/O              31430000
         L     R1,APMFISYN         UPDATE COUNT                         31500000
         AR    R1,R0                                                    31570000
         ST    R1,APMFISYN                                              31640000
UPDAPMF2 EQU   *                   SYNCHRONOUS/ASYNCHRONOUS COUNTED     31710000
         SPACE ,                                                        31780000
         TM    APIOFLG0,APIOFXED   PGFIX AT TRANSLATE OR I/O ?          31850000
         BO    UPDAPMF3            * BRANCH IF AT TRANSLATE             31920000
         TM    APIOFLG0,APIORXLT   RE-TRANSLATION OF CCWS REQUESTED ?   31940000
         BO    UPDAPMF5            * YES -- GO COUNT IT        @ZA26916 31960000
         L     R1,APMFIFXI         UPDATE NUMBER OF I/O                 31990000
         AR    R1,R0                                                    32060000
         ST    R1,APMFIFXI                                              32130000
         B     UPDAPMF4            SKIP RE-TRANSLATION COUNT   @ZA26916 32140000
UPDAPMF5 EQU   *                   HERE IF RE-TRANSLATE OF CCW @ZA26916 32150000
         L     R1,APMFIFXR         UPDATE I/O COUNT            @ZA26916 32160000
         AR    R1,R0                                           @ZA26916 32170000
         ST    R1,APMFIFXR                                     @ZA26916 32180000
         B     UPDAPMF4            SKIP PGFIX AT XLTE                   32200000
UPDAPMF3 EQU   *                   HERE IF PGFIX AT TRANSLATE           32270000
         L     R1,APMFIFXX         UPDATE I/O COUNT                     32340000
         AR    R1,R0                                                    32410000
         ST    R1,APMFIFXX                                              32480000
UPDAPMF4 EQU   *                   PGFIX AT TRANSLATE/STARTIO COUNTED   32550000
         DROP  RAPMFPTR            FINISHED WITH APMF                   32620000
         DROP  RAPDXPTR            FINISHED WITH APDX                   32690000
*                                                                       32760000
** CURRENTLY ASSIGNED REGISTERS:                                        32830000
**      R3         CVTMAP                                               32900000
**      R6         BASE REGISTER                                        32970000
**      R8         DFRRSTK                                              33040000
**      R9         APIO (INCLUDES IOSB AND SRB)                         33110000
*                                                                       33180000
         EJECT ,                                               @ZA26916 33180500
*********************************************************************** 33181000
**                                                                   ** 33181500
** IF RE-TRANSLATION MODE (APIORXLT=1), LOOP THRU THE USER'S         ** 33182000
** CHANNEL PROGRAM AND UPDATE THE ACTUAL CHANNEL PROGRAM.            ** 33182500
** ALSO UPDATE THE VSL, IDAL AND APXL TABLES.                        ** 33183000
**                                                                   ** 33183500
*********************************************************************** 33184000
         SPACE 2                                               @ZA26916 33184500
         TM    APIOFLG0,APIOFXED   PAGES FIXED BY TRANSLATE CALL ?      33185000
         BO    NOPGFIX             * YES -- NO NEED TO FIX NOW @ZA26916 33185500
*                                  * ALSO CANNOT BE RE-TRANSLATE MODE   33186000
         TM    APIOFLG0,APIORXLT   RE-TRANSLATION REQUIRED ?   @ZA26916 33186500
         BZ    NOXLTE              * NO -- SKIP PROCESSING     @ZA26916 33187000
*                                                              @ZA26916 33187500
** RE-TRANSLATION REQUIRED. LOOP THRU THE USER'S CHANNEL       @ZA26916 33188000
** PROGRAM AND DO THE FOLLOWING FOR EACH CCW:                  @ZA26916 33188500
**   1 - SAVE DATA TRANSFER COUNT IN THE PROTECTED CCW         @ZA26916 33189000
**   2 - BUILD APXL ENTRIES TO CONSTRUCT IDAL ENTRIES FOR      @ZA26916 33189500
**       THIS I/O                                              @ZA26916 33190000
**   3 - ADD A VSL ENTRY FOR EACH BUFFER                       @ZA26916 33190500
** AT THE END, ADJUST THE 'LAST-ENTRY' POINTERS                @ZA26916 33191000
*                                                              @ZA26916 33191500
** FOLLOWING REGISTERS USED DURING THIS PROCESSING:            @ZA26916 33192000
**    0 - MASK OF X'00FFF800' TO ROUND DOWN TO 2K BOUNDARY     @ZA26916 33192500
**    1 - POINTER TO USER I/O BUFFER                           @ZA26916 33193000
**    2 - I/0 TRANSFER COUNT FROM USER CCW                     @ZA26916 33193500
**    3 - MASK OF X'0000FFFF' TO CLEAR FLAGS FROM CCW COUNT    @ZA26916 33194000
**    4 - POINTER TO IDAL SLOT                                 @ZA26916 33194500
**    5 - POINTER TO APXL SLOT WHICH POINTS TO 1ST IDAL SLOT EACH CCW   33195000
**    7 - POINTER TO AVAILABLE APXL ENTRY                      @ZA26916 33195500
**   11 - POINTER TO AVAILABLE VSL ENTRY                       @ZA26916 33196000
**   12 - POINTER TO USER CCW                                  @ZA26916 33196500
**   13 - POINTER TO PROTECTED CCW                             @ZA26916 33197000
**   14 - USER'S PROTECT KEY (FROM DEB)                        @ZA26916 33197500
**   15 - WORK REGISTER                                        @ZA26916 33198000
*                                                              @ZA26916 33198500
** FOLLOWING REGISTERS DESTROYED BY THIS LOOP:                 @ZA26916 33199000
**   0, 1, 2, 3, 4, 5, 7, 11, 12, 13, 14, 15.                  @ZA26916 33199500
*                                                              @ZA26916 33200000
         L     R0,CRND2KDN         ROUND ADDR TO 2K (IDAL BOUNDARY)     33200500
         L     R3,CLRCOUNT         CLEAR CCW TRANSFER COUNT    @ZA26916 33201000
         L     R15,APIOAPXL        POINT TO APXL               @ZA26916 33201500
         L     R5,APXLIDAL-APXL(,R15) POINTER TO IDAL SLOTS IN APXL     33202000
         L     R7,APXLFREE-APXL(,R15) 1ST AVAILABLE APXL SLOT  @ZA26916 33202500
         L     R11,APIOPGFF        1ST AVAILABLE PGFIX SLOT    @ZA26916 33203000
         L     R12,APIOUCCW        ADDRESS OF USER'S CHANNEL PROGRAM    33203500
         L     R13,APIOCCW         ADDRESS OF PROTECTED CHANNEL PROGRAM 33204000
         IC    R14,DFRRKEY         USER'S PROTECT KEY (FROM DEB)        33204500
         LA    R12,2*CCWLN(,R12)   SKIP PROCESS & WRITE OF CIT IN       33205000
         LA    R13,2*CCWLN(,R13)   * BOTH USER & PROTECTED CHAN. PGM    33205500
*                                                              @ZA26916 33206000
** LOOP THRU PROTECTED CHANNEL PROGRAM UNTIL REACHING          @ZA26916 33206500
** THE NOP. NOTE -- AT LEAST 1 CCW MUST REQUIRE TRANSLATION.   @ZA26916 33207000
**                                                             @ZA26916 33207500
*                                                              @ZA26916 33208000
XLTE01   EQU   *                   PROCESS NEXT CCW            @ZA26916 33208500
         MVI   DFRRCODE,CERRN14    SET ERROR CODE (PGM CHECK ON CCW)    33209000
**       MODESET KEYADDR=(R14)     SWITCH TO USER'S KEY        @ZA26916 33209500
         SPKA  0(R14)              * MODESET EQUIVALENT        @ZA26916 33210000
         LM    R1,R2,CCW-CCW(R12)  R1=ADDR, R2=LENGTH OF BUFFER@ZA26916 33210500
         MODESET EXTKEY=ZERO       RESUME STANDARD KEY         @ZA26916 33211000
         MVI   DFRRCODE,CERRN99    RESET STANDARD ERROR CODE   @ZA26916 33211500
         LA    R1,0(,R1)           CLEAR OP-CODE               @ZA26916 33212000
         NR    R2,R3               CLEAR FLAGS                 @ZA26916 33212500
         STH   R2,CCWBCNT-CCW(,R13) SAVE UPDATED COUNT         @ZA26916 33213000
         ST    R1,VSLSTRT-VSL(,R11) START OF PGFIX             @ZA26916 33213500
         LA    R2,0(R1,R2)         R2 = ADDR END OF BUFFER + 1 @ZA26916 33214000
         ST    R2,VSLEND-VSL(,R11) END OF PGFIX                @ZA26916 33214500
         CR    R2,R1               END POINT > START POINT ?   @ZA26916 33215000
         BNH   ERRORH              * NO - 0 COUNT OR WRAP-AROUND        33215500
*                                                              @ZA26916 33216000
** BUILD APXL ENTRIES FOR IDALS                                @ZA26916 33216500
*                                                              @ZA26916 33217000
         L     R4,APXLADDV-APXL(,R5) POINT TO IDAL AREA FOR THIS CCW    33217500
XLTE05   EQU   *                   LOOP POINT                  @ZA26916 33218000
         ST    R1,APXLADDV-APXL(,R7) ADDRESS TO CONVERT        @ZA26916 33218500
         ST    R4,APXLADDL-APXL(,R7) ADDR IDAL ENTRY           @ZA26916 33219000
         LA    R7,APXLLN1(,R7)     NEXT APXL ENTRY             @ZA26916 33219500
         LA    R4,4(,R4)           NEXT IDAL ENTRY             @ZA26916 33220000
         LA    R1,CXIOLN(,R1)      SET R1 = NEXT 2K            @ZA26916 33220500
         NR    R1,R0               * BOUNDARY                  @ZA26916 33221000
         CR    R1,R2               IF MORE TO PROCESS          @ZA26916 33221500
         BL    XLTE05              * CONTINUE LOOP             @ZA26916 33222000
*                                                              @ZA26916 33222500
** PROCESS NEXT CCW                                            @ZA26916 33223000
*                                                              @ZA26916 33223500
         LA    R5,APXLLN1(,R5)     NEXT APXL -> IDAL ENTRY     @ZA26916 33224000
         LA    R11,VSLLEN(,R11)    NEXT AVAILABLE VSL ENTRY    @ZA26916 33224500
         LA    R12,CCWLN(,R12)     POINT TO NEXT CCW           @ZA26916 33225000
         LA    R13,CCWLN(,R13)     * USER & PROTECTED COPIES   @ZA26916 33225500
         CLI   CCWOP-CCW(R13),CCWOPNOP REACHED NOP ?           @ZA26916 33226000
         BNE   XLTE01              * NO -- CONTINUE TRANSLATION@ZA26916 33226500
*                                                              @ZA26916 33227000
** COMPLETE END POINTERS FOR VSL AND APXL TABLES.              @ZA26916 33227500
** CURRENTLY:                                                  @ZA26916 33228000
**   R7  -> NEXT AVAILABLE APXL SLOT                           @ZA26916 33228500
**   R11 -> NEXT AVAILABLE VSL SLOT                            @ZA26916 33229000
*                                                              @ZA26916 33229500
         LA    R0,VSLLEN           SET R11 =                   @ZA26916 33230000
         SR    R11,R0              * ADDRESS OF LAST VSL USED  @ZA26916 33230500
         ST    R11,APIOPGFL        SAVE ITS ADDRESS            @ZA26916 33231000
         OI    VSLFLAG2-VSL(R11),VSLAST SHOW LAST ENTRY        @ZA26916 33231500
         LA    R0,APXLLN0+APXLLN1  SET R7 = ADDRESS OF LAST APXL        33232000
         SR    R7,R0               * USED MINUS HEADER LENGTH  @ZA26916 33232500
         L     R15,APIOAPXL        SAVE THIS ADDRESS IN THE    @ZA26916 33233000
         ST    R7,APXLLAST-APXL(,R15) * APXL FOR VIRT->REAL CONVERSION  33233500
         SPACE ,                                               @ZA26916 33234000
*                                                              @ZA26916 33234500
** RE-TRANSLATION COMPLETE                                     @ZA26916 33235000
*                                                              @ZA26916 33235500
         L     RCVTPTR,CVTPTR      RESTORE CVT POINTER         @ZA26916 33236000
         SPACE 3                                               @ZA26916 33236500
NOXLTE   EQU   *                   NO RE-TRANSLATION REQUIRED  @ZA26916 33237000
         SPACE 2                                               @ZA26916 33237500
*                                                              @ZA26916 33238000
** CURRENTLY ASSIGNED REGISTERS:                               @ZA26916 33238500
**      R3         CVTMAP                                      @ZA26916 33239000
**      R6         BASE REGISTER                               @ZA26916 33239500
**      R8         DFRRSTK                                     @ZA26916 33240000
**      R9         APIO (INCLUDES IOSB AND SRB)                @ZA26916 33240500
*                                                              @ZA26916 33241000
         EJECT ,                                                        33250000
*********************************************************************** 33320000
**                                                                   ** 33390000
** IF PAGES WHERE NOT FIXED AT CHANNEL PROGRAM TRANSLATION BY        ** 33460000
** IGTKCA, THEY MUST BE FIXED NOW.  USE A SHORT TERM PGFIX SINCE     ** 33530000
** THE PAGES WILL BE UNFIXED BY THE VPSS TERMINATION ROUTINE         ** 33600000
** (IGTKBC) WHICH RUNS AS AN SRB WHEN THE I/O COMPLETES.             ** 33670000
**                                                                   ** 33810000
*********************************************************************** 33880000
         SPACE 2                                                        33950000
*                                                                       34160000
** PGFIX REQUIRED.  LOOP THRU THE VSL PGFIX ENTRIES TO FIX              34210000
** THE REQUIRED PAGES USING THE REGISTER FORMAT OF PGFIX.  THIS         34440000
** VERSION IS USED RATHER THAN THE LIST FORM TO ELIMINATE THE           34510000
** PARAMETER LIST CHECKING BY PGFIX.  THE REGISTER FORMAT PATH          34580000
** LENGTH IS SHORTER THAN THE LIST FORMAT IN IEAVPSIB.                  34650000
*                                                                       34720000
** FOLLOWING INPUT REQUIRED FOR PGFIX:                                  34790000
**    0 - ECB TO POST WHEN PGFIX COMPLETE (NOT USED FOR WAIT)           34860000
**    1 - 1ST HALF OF VSL ENTRY (BIT-0 = 0 SHOWS REGISTER FORMAT)       34930000
**    2 - 2ND HALF OF VSL ENTRY (REGISTER FORMAT)                       35000000
**    4 - TCB ADDRESS (=0 TO SHOW NO FOE ACCOUNTING)                    35070000
**   14 - RETURN ADDRESS                                                35140000
**   15 - ADDRESS OF PGFIX ENTRY POINT (IEAVPSIB CONTAINED IN CVTVPSIB) 35210000
*                                                                       35280000
** OUTPUT FROM IEAVPSIB:                                                35350000
**    0-14 - UNCHANGED                                                  35420000
**    15 - RETURN CODE                                                  35490000
*                                                                       35560000
** FOLLOWING REGISTERS DESTROYED BY THIS LOOP:                          35630000
**    0, 1, 2, 4, 5, 11, 12, 13, 14, 15.                                35700000
*                                                                       35770000
         MVI   DFRRCODE,CERRN02    SET ERROR CODE                       35800000
         L     RVSLPTR,APIOPGFX    FIRST VSL ENTRY                      35840000
         L     RVSLEND,APIOPGFL    LAST VSL ENTRY                       35910000
         LA    RVSLINCR,VSLLEN     LENGTH OF VSL ENTRY                  35980000
         ST    RVSLPTR,DFRRVSL     RECOVERY - SHOW ONE IN ERROR         36010000
         LA    R0,APIOSAVE         ECB TO POST (NOT USED FOR WAIT)      36050000
         MVI   APIOSAVE,0          SHOW ECB NOT WAITED ON               36120000
         SR    RTCBPTR,RTCBPTR     NO FOE ACCOUNTING WANTED             36190000
         L     RPGFXFLG,CPGFXFLG   SHOWS SHORT-TERM PGFIX               36220000
         OI    APIOFLG3,APIOPGIP   PGFIX IN PROGRESS                    36260000
         USING VSL,RVSLPTR         TELL ASSEMBLER OF VSL POINTER        36330000
*                                                                       36400000
** LOOP THRU VSL ENTRIES                                                36470000
*                                                                       36540000
PGFIX1   EQU   *                   FIRST/NEXT VSL ENTRY                 36610000
         LM    R1,R2,VSLSTRT       START, END+1                         36680000
         ST    RVSLPTR,DFRRVSL     RECOVERY - SHOW ONE IN ERROR         36710000
         OR    R1,RPGFXFLG         SHOW SHORT-TERM PGFIX                36750000
         L     R15,CVTVPSIB        ADDRESS OF IEAVPSIB                  36890000
         CALL  (15)                CALL IEAVPSIB TO FIX PAGES           36960000
*                                                                       37030000
** REGISTER 15 HAS RETURN CODE --                                       37100000
**   00 - ALL PAGES NOW FIXED                                           37170000
**   04 - INVALID VSL CONTENTS                                          37240000
**   08 - PAGE-IN IN PROCESS                                            37310000
**   12 - INVALID VSL                                                   37380000
*                                                                       37450000
** IF CODE=8, REFERENCE EACH PAGE. WHEN COMPLETE,                       37520000
** ONE CAN BE SURE ALL PAGES HAVE BEEN PAGED-IN AND                     37590000
** THUS ARE NOW FIXED. A WAIT CAN NOT BE ISSUED SINCE THE               37660000
** LOCAL LOCK IS OWNED AND MUST NOT BE GIVEN UP.                        37730000
*                                                                       37800000
         LTR   R15,R15             PAGE FIX COMPLETE ?                  37870000
         BZ    PGFIX3              * YES -- SKIP FORCE-IN PROCESSING    37940000
         C     R15,CPGFIXIP        PAGE FIX IN PROGRESS ?               38010000
         BNE   ERRORD              * NO -- GO TO TERMINATION PROCESS    38080000
*                                                                       38150000
** REFERENCE EACH PAGE IN THE VSL ENTRY.                                38220000
** WHEN THIS LOOP IS COMPLETE, ALL PAGES                                38290000
** HAVE BEEN BROUGHT INTO STORAGE, AND                                  38360000
** THEREFORE ARE NOW PAGE FIXED.                                        38430000
*                                                                       38500000
         N     R1,CRNDPGDN         CLEAR HI-FLAGS AND ROUND DOWN        38570000
*                                  * TO PAGE BOUNDARY                   38640000
         LA    R2,0(,R2)           CLEAR FLAGS FROM END ENTRY           38710000
         L     R15,CPGSIZE         PAGE SIZE                            38780000
PGFIX2   EQU   *                   FIRST/NEXT PAGE IN VSL ENTRY         38850000
         CLI   0(R1),*-*           FORCE PAGE INTO STORAGE              38920000
*                                  * ABOVE PAGE NOW FIXED               38990000
         AR    R1,R15              NEXT PAGE                            39060000
         CR    R1,R2               END OF ENTRY ?                       39130000
         BL    PGFIX2              * NO--GO REFERENCE THIS PAGE         39200000
*                                                                       39270000
** VSL ENTRY PROCESSED. CONTINUE WITH                                   39340000
** NEXT VSL ENTRY (IF ANY).                                             39410000
*                                                                       39480000
PGFIX3   EQU   *                   CHECK FOR MORE VSL ENTRIES           39550000
         BXLE  RVSLPTR,RVSLINCR,PGFIX1 PROCESS ALL ENTRIES              39620000
*                                                                       39690000
** ALL PAGES NOW IN-CORE. PAGE FIX COMPLETE                             39760000
*                                                                       39830000
         MVI   DFRRCODE,CERRN99    RESET ERROR CODE                     39860000
         DROP  RVSLPTR             FINISHED WITH VSL POINTER            39970000
         XI    APIOFLG3,APIOPGFS+APIOPGIP RESET PGFIX-IN-PROGRESS       42140000
*                                  * SHOW PGFREE REQUIRED (RECOVERY)    42160000
         SPACE 2                                                        42210000
NOPGFIX  EQU   *                   PAGES NOW FIXED (SHORT OR LONG)      42280000
         SPACE 2                                                        42350000
*                                                                       42420000
** CURRENTLY ASSIGNED REGISTERS:                                        42490000
**      R3         CVTMAP                                               42560000
**      R6         BASE REGISTER                                        42630000
**      R8         DFRRSTK                                              42700000
**      R9         APIO (INCLUDES IOSB AND SRB)                         42770000
*                                                                       42840000
         EJECT ,                                                        42910000
*********************************************************************** 42980000
**                                                                   ** 43050000
** FIND A SUITABLE SUBCHANNEL FOR THIS I/O REQUEST.                  ** 43120000
** PROCESS DEPENDS ON WHETHER THE REQUEST IS FOR AN                  ** 43190000
** EXCLUSIVE OR SHARED SUBCHANNEL.                                   ** 43260000
**                                                                   ** 43330000
*********************************************************************** 43400000
         SPACE 2                                                        43470000
         TM    APIOFLG2,APIOEXCL   EXCLUSIVE PORT ?            @ZA26916 43540000
         BZ    SHAREFND            * NO -- GO PROCESS SHARED REQUEST    43610000
*                                                                       43680000
** EXCLUSIVE SUBCHANNEL REQUEST. APIO ALREADY HAS                       43750000
** A POINTER TO THE DESIRED APUB (AND UCB). VERIFY                      43820000
** THAT THE SUBCHANNEL IS STILL AVAILABLE. IF NOT,                      43890000
** GO TO TERMINATION PROCESSING.                                        43960000
*                                                                       44030000
         L     RAPUBPTR,APIOAPUB   POINT TO ASSOCIATED APUB             44100000
         USING APUB,RAPUBPTR       TELL ASSEMBLER                       44170000
         L     R1,APUBIOFG         I/O FLAGS                            44240000
         N     R1,CLRXIOF          CLEAR NON-EXCLUSIVE FAIL BITS        44310000
         BZ    PORTSET             * IF EXC-FAIL BITS OFF, APUB OK      44380000
         N     R1,CLRXIPL          OTHER THAN RE-IPL'ED BIT ON ?        44383000
         BNZ   ERRORE              * YES -- LOGICAL ERROR               44386000
*                                  * PORT SHOULD HAVE BEEN AVAILABLE    44389000
*                                                                       44392000
** BOX RE-IPLED; EXCLUSIVE USER HAS LOST DATA.                          44395000
** GIVE USER I/O ERROR & RESET ERROR BIT.                               44398000
** USER SHOULD NOW KNOW BOX LOST DATA.                                  44401000
** NOT NEEDED FOR SHARED USER SINCE EACH                                44404000
** I/O SELF CONTAINED.                                                  44407000
*                                                                       44410000
         L     R1,APUBIOFG         RELOAD INITIAL FLAGS                 44413000
EXCCS    EQU   *                   COMPARE-AND-SWAP RETRY               44416000
         LR    R0,R1               SET R0 = APUBIOFG                    44419000
         N     R0,CLRXIPL          * WITH RE-IPL FLAG OFF.              44422000
         CS    R1,R0,APUBIOFG      TRY UPDATE                           44425000
         BNZ   EXCCS               RETRY IF CS FAILED                   44428000
         B     ERRORJ              GO TO RETURN ERROR TO USER           44431000
         DROP  RAPUBPTR            LOWER CODE DOES NOT HAVE POINTER     44450000
         EJECT ,                                                        44590000
SHAREFND EQU   *                   USER HAS SHARED ALLOCATION           44660000
*                                                                       44730000
** SHARED SUBCHANNEL REQUEST.                                           44800000
*                                                                       44870000
** SHARED SUBCHANNEL REQUEST. SCAN LIST AND DETERMINE "BEST"            44940000
** SUBCHANNEL FOR THIS I/O REQUEST.  THE FOLLOWING CRITERIA             45010000
** ARE CHECKED:                                                         45080000
**   1.  SUBCHANNEL REGION MUST BE SUFFICIENT TO HOLD REQUEST.          45150000
**   2.  "SHARED-SUBCHANNEL I/O PROHIBITED FLAGS" IN THE APUB           45220000
**       MUST BE ZERO.                                                  45290000
** IF THESE CONDITIONS MET, THE SUBCHANNEL IS ACCEPTABLE.  NOW          45360000
** SCAN THE FOLLOWING OPTIONAL CRITERIA:                                45430000
**   3.  "I/O NON-SUGGESTED FLAGS" IN THE APUB SHOULD BE ZERO.          45500000
**   4.  THE CURRENT ACTIVITIY ON THE SUBCHANNEL (SEE LATER             45570000
**       PROCESSING OF 'APIOTMES' FIELD) IS LESS THAN PREVIOUS          45640000
**       SUBCHANNELS.  IF THE ACTIVITY IS 0, AND ONLY 1-3838            45710000
**       IS IPL'ED, USE THIS SUBCHANNEL.  NO FUTHER CHECKING            45780000
**       IS REQUIRED.                                                   45850000
**   5.  THE CURRENT ACTIVITIY ON THE ENTIRE 3838 IS LESS               45920000
**       THAN PROCESSING ON THE PREVIOUSLY CHECKED 3838'S.              45990000
*                                                                       46060000
*                                                                       46130000
** FOLLOWING REGISTERS DESTROYED BY THIS PROCESSING:                    46200000
**       0, 11, 12, 14, 15                                              46270000
** REGISTERS SET BY THIS PROCESSING:                                    46290000
**       5 - ADDRESS OF THE SELECTED APUB                               46310000
*                                                                       46340000
         L     APCTPTR,APIOAPCT    POINT TO THE APCT                    46410000
         USING APCT,APCTPTR        * TELL THE ASSEMBLER                 46480000
         LA    RAPUBPTR,CAPUB      FAKE APUB (NO I/O ALLOWED)           46550000
         L     RXAPUB,APCTUBIS     ADDRESS APUB I/O QUEUE               46620000
SHAREA   EQU   *                   FIRST/NEXT APUB                      46690000
         LTR   RXAPUB,RXAPUB       END OF APUB CHAIN ?                  46760000
         BZ    SHAREY              * YES -- RAPUBPTR POINTS TO          46830000
*                                  *        SELECTED APUB               46900000
         USING APUB,RXAPUB         CHECK THIS APUB                      46970000
*                                                                       47040000
** SEE IF THIS APUB CAN PROCESS THE REQUEST                             47110000
*                                                                       47180000
         LH    R0,APUBRGN          INSURE APUB REGION IS AT LEAST       47250000
         C     R0,APIORGN          * AS LARGE AS APDS REQUIREMENT       47320000
         BL    SHARES              * IF NOT, APUB CANNOT BE USED        47390000
         L     R0,APUBIOFG         I/O PROCESSING FLAGS                 47460000
         N     R0,CLRSIOF          CLEAR SHARED FLAGS. GOOD APUB ?      47530000
         BZ    SHAREG              * YES -- APUB NOW ACCEPTABLE         47600000
         L     R0,APUBIOFG         MAY BE ONLY WARNING FLAGS            47670000
         N     R0,CLRSIOFR         CLEAR ALL BUT PROHIBITED FLAGS       47740000
         BNZ   SHARES              SKIP IS ANY OF THESE FLAGS ON.       47810000
*                                  ONLY WARNING FLAGS SET               47880000
         TM    APUBIOF1-APUB(RAPUBPTR),X'FF' PREVIOUS BEST CHOICE       47950000
*                                  * HAVE WARNINGS ?                    48020000
         BZ    SHARES              * NO -- SKIP THIS NEW APUB           48090000
SHAREG   EQU   *                   RXAPUB->APUB IS ACCEPTABLE           48160000
*                                                                       48230000
** APUB POINTED TO BY RXAPUB IS ACCEPTABLE.                             48300000
** SET RAPUBPTR TO BETTER CHOICE.                                       48370000
** NOTE:R0 CURRENTLY 0.                                                 48440000
*                                                                       48510000
         A     R0,APUBIOCT         NUMBER OF OUTSTANDING I/O'S          48580000
*                                  * WEIGHTED BY ELASPED I/O TIME       48650000
         BNZ   SHAREK              IF SUBCHANNEL FREE AND ONLY 1-3838,  48720000
         CLI   APCTCTUB,1          * THIS IS BEST SUBCHANNEL,           48790000
         BH    SHAREK              * SO TERMINATE SCAN                  48860000
         TM    APUBIOF1,X'FF'      * UNLESS WARNINGS SET.               48930000
         BNZ   SHAREM              * THEN IS BEST SO FAR.               49000000
         LR    RAPUBPTR,RXAPUB     POINT TO SELECTED APUB               49070000
         B     SHAREY              TERMINATE APUB SCAN LOOP             49140000
SHAREK   EQU   *                   I/O IS PROGRESS OR                   49210000
*                                  * MORE THAN 1-3838.                  49280000
         C     R0,APUBIOCT-APUB(,RAPUBPTR) COMPARE NUMBER OF            49350000
*                                  OUTSTANDING I/O'S                    49420000
         BH    SHARES              DONOT USE IF MORE THAN CURRENT BEST  49490000
         BL    SHAREM              USE IS LESS THAN CURRENT BEST        49560000
*                                  * IF EQUAL, COMPARE ENTIRE 3838      49630000
*                                  WORKLOAD                             49700000
         L     R14,APUBMSTR        SUBCHANNEL-0 FOR CURRENT APUB        49770000
         L     R0,APUBIOCT-APUB(,R14) I/O CURRENT FOR 3838              49840000
         L     R14,APUBMSTR-APUB(,RAPUBPTR) I/O COUNT FOR BEST 3838     49910000
         C     R0,APUBIOCT-APUB(,R14) IF NEW 3838 HAS LESS I/O          49980000
         BNL   SHARES              * THAN CURRENT BEST, USE NEW ONE.    50050000
SHAREM   EQU   *                   NEW UNIT SELECTED                    50120000
*                                                                       50190000
** NEW APUB IS "BETTER" UNIT                                            50260000
*                                                                       50330000
         LR    RAPUBPTR,RXAPUB     SAVE CURRENT "BEST" ADDRESS          50400000
SHARES   EQU   *                   FIND NEXT APUB                       50470000
*                                                                       50540000
** RAPUBPTR CONTAINS "BEST" APUB CHOICE, SO FAR.                        50610000
*                                                                       50680000
         L     RXAPUB,APUBNXIO     NEXT APUB (IF ANY)                   50750000
         B     SHAREA              CONTINUE APUB SCAN                   50820000
SHAREY   EQU   *                                                        50890000
*                                                                       50960000
** RAPUBPTR POINTS TO SELECTED APUB (OR CAPUB IF                        51030000
** NO SUBCHANNEL.  UPDATE THE APIO TO POINT TO                          51100000
** THIS APUB/UCB.  THEN INSURE THAT THE APUB IS                         51170000
** STILL VALID (MAY BE CAPUB OR VARIED OFFLINE SINCE                    51240000
** NOT ENQUEUED ON THE APUB MAJOR/MINOR).  IF NOT                       51310000
** VALID AND NOT THE FAKE APUB, JUST RETRY THE LOOP.                    51380000
** IF THE FAKE APUB (CAPUB) IS THE 'BEST', IT IS AN ERROR.              51450000
*                                                                       51520000
         DROP  RXAPUB              FINIHSED WITH TEMPORARY SCANNER      51590000
         USING APUB,RAPUBPTR       POINT TO SELECTED APUB               51660000
         ST    RAPUBPTR,APIOAPUB   SAVE APUB/UCB ADDRESSES              51730000
         L     R0,APUBUCB          * IN THE APIO (INCLUDES IOSB).       51800000
         ST    R0,IOSUCB           SAVE APIO ADDRESS IN UCB             51870000
         L     R0,APUBIOFG         INSURE SELECTED SUBCHANNEL STILL OK  51940000
         N     R0,CLRSIOFR         CLEAR ALL BUT PERMANENT FAILURE      52010000
         BZ    SHARESET            IF ZERO, SUBCHANNEL OK               52080000
         LA    R0,CAPUB            SEE IF FAK APUB ('CAPUB')            52150000
         CR    RAPUBPTR,R0         * IF NO -- RETRY THE ENTIRE LOOP     52220000
         BNE   SHAREFND            * IF YES -- IS ERROR                 52290000
         B     ERRORE              FORCE ERROR CONDITION                52360000
SHARESET EQU   *                   BEST APUB FOUND SET IN APIO          52430000
         DROP  APCTPTR             FINISHED WITH POINTER                52500000
         SPACE 4                                                        52570000
PORTSET  EQU   *                   APUB SELECTED                        52640000
*                                                                       52710000
** SUBCHANNEL SELECTED (SHARED AND EXCLUSIVE).                          52780000
** APIO NOW POINTS TO THE ASSOCIATED APUB AND UCB.                      52850000
*                                                                       52920000
** CURRENTLY ASSIGNED REGISTERS:                                        52990000
**      R3         CVTMAP                                               53060000
**      R5         APUB                                                 53130000
**      R6         BASE REGISTER                                        53200000
**      R8         DFRRSTK                                              53270000
**      R9         APIO (INCLUDES IOSB AND SRB)                         53340000
         EJECT ,                                                        53410000
*********************************************************************** 53480000
**                                                                   ** 53550000
** CONVERT THE VIRTUAL ADDRESSES IN THE IOSB,                        ** 53620000
** CCWS AND IDALS TO REAL ADDRESSES. THE APXL                        ** 53690000
** IS USED FOR THIS CONVERSION. SINCE THE LOCAL LOCK                 ** 53760000
** IS OWNED AND KEPT UNTIL THE STARTIO IS ISSUED                     ** 53830000
** SRM/ASM WILL NOT "MOVE" THE PAGES AROUND IN                       ** 53900000
** STORAGE. (NOTE: A PAGE BEING "FIXED" DOES NOT                     ** 53970000
** PREVENT IT FROM BEING MOVED IN MVS.)                              ** 54040000
**                                                                   ** 54110000
*********************************************************************** 54180000
         SPACE 2                                                        54250000
         L     R1,APIOAPXL         POINT TO TRANSLATE TABLE             54320000
         L     R15,APXLLAST-APXL(,R1) LAST ENTRY MINUS HEADER LENGTH    54390000
         LA    R14,APXLLN1         ENTRY LENGTH                         54460000
         USING APXL-APXLLN0,R1     ALLOW FOR HEADER                     54530000
XLTEL1   EQU   *                   TRANSLATE LOOP                       54600000
         LM    RTEMPB,RTEMPC,APXLADDR VIRTUAL/STORE ADDRESSES           54670000
         LRA   RTEMPB,0(,RTEMPB)   FIND REAL ADDRESS                    54740000
         BNZ   ERRORF              IF NOT FOUND, IS ERROR               54810000
         STCM  RTEMPB,B'0111',1(RTEMPC) PLACE IN LOW 3-BYTES            54880000
         BXLE  R1,R14,XLTEL1       CONTINUE LOOP                        54950000
*                                                                       55020000
** ALL ADDRESSES CONVERTED TO REAL                                      55090000
*                                                                       55160000
*                                                                       55230000
** CURRENTLY ASSIGNED REGISTERS:                                        55300000
**      R3         CVTMAP                                               55370000
**      R5         APUB                                                 55440000
**      R6         BASE REGISTER                                        55510000
**      R8         DFRRSTK                                              55580000
**      R9         APIO (INCLUDES IOSB AND SRB)                         55650000
         EJECT ,                                                        55720000
*********************************************************************** 55790000
**                                                                   ** 55860000
** UPDATE THE I/O STATISTICS IN THE APUB.                            ** 55930000
** NOTE: APUB ERROR STATISTICS ARE ONLY APPROXIMATE.                 ** 56000000
**                                                                   ** 56070000
*********************************************************************** 56140000
         SPACE 2                                                        56210000
*                                                                       56280000
** INCREMENT THE NUMBER OF ACTIVE I/O REQUESTS FOR                      56350000
** THE SELECTED 3838 SUBCHANNEL.  USE THE PREVIOUS                      56420000
** EXECUTION'S ELAPSED TIME AS A WEIGHT.  ALTOUGH THIS                  56490000
** TIME IS NOT REPEATABLE (SYSTEM ACTIVITY, DATA DEPENDENCIES),         56560000
** IT IS THE BEST GUESS OF NEW EXECUTION TIME. THIS HELPS               56630000
** DISTRIBUTE THE PROCESSING LOAD ACROSS SUBCHANNELS AND                56700000
** MULTIPLE 3838'S.                                                     56770000
*                                                                       56840000
** REGISTERS DESTROYED BY THESE ROUTINES: 0, 1, 14, 15                  56910000
*                                                                       56980000
         OI    APIOFLG3,APIOIOCT   SHOW APIO INCLUDED IN APUBIOCT       57050000
         L     R14,APIOXTME        LAST EXECUTION ELAPSED-I/O TIME      57120000
         SPACE 1                                                        57190000
         L     R1,APUBIOCT         CURRENT ACTIVITY ON SUBCHANNEL       57260000
IOCOUNT1 EQU   *                   'CS' FAIL RETRY POINT                57330000
         LR    R0,R1               INCREMENT COUNT BY PREVIOUS          57400000
         AR    R0,R14              * EXECUTION'S ELAPSED TIME           57470000
         CS    R1,R0,APUBIOCT      SAVE UPDATED COUNT                   57540000
         BNZ   IOCOUNT1            RETRY IF 'CS' FAILED                 57610000
*                                                                       57680000
** PERFORM THE SAME PROCESSING FOR THE MASTER (SUBCHANNEL-0)            57750000
** APUB OF THE SELECTED 3838.  THIS IS USED TO BALANCE THE              57820000
** LOAD ACROSS MULTIPLE 3838'S.                                         57890000
*                                                                       57960000
         L     R15,APUBMSTR        ADDRESS OF ASSOCIATED SUBCHANNEL 0   58030000
         USING APUB,R15            TEMPORARY CHANGE IN BASE REGISTER    58100000
         L     R1,APUBIOCT         CURRENT 3838 LOAD (ENTIRE 3838)      58170000
IOCOUNT3 EQU   *                   'CS' FAIL RETRY POINT                58240000
         LR    R0,R1               INCREMENT COUNT BY PREVIOUS          58310000
         AR    R0,R14              * EXECUTIONS'S ELAPSED TIME          58380000
         CS    R1,R0,APUBIOCT      SAVE UPDATED COUNT                   58450000
         BNZ   IOCOUNT3            RETRY IF 'CS' FAILED                 58520000
         DROP  R15                 FINISHED WITH SUBCHANNEL-0           58590000
*                                                                       58660000
** UPDATE NUMBER OF I/O REQUESTS ISSUED                                 58730000
** IN THIS ERROR DETECTION CYCLE. IF THE                                58800000
** CYCLE LIMIT HAS BEEN EXCEEDED, RESET THE                             58870000
** ERROR COUNTERS TO 0 AND SET THE NUMBER OF                            58940000
** I/O REQUESTS THIS CYCLE TO 1.                                        59010000
*                                                                       59080000
** NOTE THAT THE ERROR COUNTS ARE ONLY APPROXIMATE.                     59150000
** SERIALIZATION IS NOT USED TO CLEAR THE APUBERRS                      59220000
** COUNTS.  THEREFORE AN ERROR MAY NOT BE COUNTED.                      59290000
** THE ADDITION OF SERIALIZTION (CMS LOCK) WOULD                        59360000
** SERIOUSLY DEGRADE PERFORMACE.  THE LOSS OF AN                        59430000
** OCCASIONAL ERROR COUNT UPDATE SHOULD NOT AFFECT                      59500000
** RELIABILITY.                                                         59570000
*                                                                       59640000
         L     R15,APUBAPCT        POINT TO APCT                        59710000
         L     R1,APUBERRT         CURRENT I/O COUNT                    59780000
CTAPUB1  EQU   *                   COMPARE-AND-SWAP RETRY POINT         59850000
         LA    R0,1(,R1)           INCREMENT COUNT                      59920000
         CH    R0,APCTERTT-APCT(,R15) CYCLE LIMIT EXCEEDED ?            59990000
         BL    CTAPUB2             * YES -- RESET ERROR COUNTS          60060000
         LA    R0,1                RESET NUMBER I/O REQUEST THIS CYCLE  60130000
         XC    APUBERRS,APUBERRS   CLEAR ERROR COUNTS                   60200000
CTAPUB2  EQU   *                   SKIP RESET POINT                     60270000
         CS    R1,R0,APUBERRT      SAVE I/O COUNT                       60340000
         BNZ   CTAPUB1             IF CS FAILED, RETRY LOOP             60410000
         SPACE 1                                                        60480000
         DROP  RAPUBPTR            FINISHED WITH APUB                   60550000
*                                                                       60620000
** CURRENTLY ASSIGNED REGISTERS:                                        60690000
**      R3         CVTMAP                                               60760000
**      R6         BASE REGISTER                                        60830000
**      R8         DFRRSTK                                              60900000
**      R9         APIO (INCLUDES IOSB AND SRB)                         60970000
         EJECT ,                                                        61040000
*********************************************************************** 61110000
**                                                                   ** 61180000
** PERFORM PROCESSING RELATED TO SYNCHRONOUS/ASYNCHRONOUS I/O.       ** 61250000
** THIS INCLUDES DETERMINING THE EXIT ADDRESS.                       ** 61320000
** 'RCODE' (BASED REGISTER) IS NEGATIVE IF ASYNCHRONOUS, AND         ** 61390000
** POSITIVE IF SYNCHRONOUS.                                          ** 61460000
**                                                                   ** 61530000
*********************************************************************** 61600000
         SPACE 2                                                        61670000
         LTR   RCODE,RCODE         SYNCHRONOUS I/O ?                    61740000
         BP    SYNCH               * YES -- GO PROCESS                  61810000
*                                                                       61880000
** ASYSNCHRONOUS PROCESSING WANTED (WAIT/POST)                          61950000
*                                                                       62020000
** APIOSYNC ALREADY ZET TO 0 (SHOWS ASYNCHRONOUS PROCESSING).           62090000
** SET REGISTER 13 TO THE ADDRESS OF THE STANDARD BRANCH                62160000
** ENTRY ADDRESS TO TYPE-2 SVC EXIT.  REGISTER 13 IS USED               62230000
** SINCE IT IS THE ONLY REGISTER NOT DESTROYED BY THE                   62300000
** 'STARTIO' MACRO.                                                     62370000
*                                                                       62440000
** FOLLOWING REGISTERS DESTROYED: NONE                                  62510000
** REGISTER 13 SET TO EXIT ADDRESS (BIT-0 MUST BE 0).                   62580000
*                                                                       62650000
*                                  APIOSYNC OFF = ASYNCHRONOUS          62720000
         L     R13,CVTEXPRO        USE NORMAL EXIT WHICH ATTEMPTS       62790000
*                                  * TO DISPATCH NEXT HIGHER RB.        62860000
         B     SYNCHSET            SKIP SYNCHRONOUS PROCESSING CODE     62930000
         SPACE 5                                                        63000000
SYNCH    EQU   *                   SYNCHRONOUS I/O                      63070000
*                                                                       63140000
** SYSNCHRONOUS PROCESSING WANTED (SUSPEND/RESUME)                      63210000
*                                                                       63280000
** SET APIOSYNC = 1 (SHOWS SYNCHRONOUS PROCESSING).                     63350000
*                                                                       63560000
         OI    APIOFLG0,APIOSYNC   SHOW SYNCHRONOUS PROCESSING          63630000
*                                                                       63980000
** SUSPEND THE PREVIOUS RB (USER).  THE SUSPEND MUST BE                 64050000
** ISSUED PRIOR TO THE STARTIO. (ACTUALLY -- BEFORE                     64120000
** THE RESUME).  THEN SET REGISTER 13 TO THE ADDRESS                    64190000
** OF THE FORCE-DISPATCH SVC EXIT ROUTINE.  SINCE THE                   64260000
** PREVIOUS RB HAS BEEN "SUSPENDED" THERE IS NO REASON                  64330000
** TO CHECK FOR DISPATCHABILITY.                                        64400000
*                                                                       64470000
** FOLLOWING REGISTERS DESTROYED: 11,12,13,14,15.                       64540000
** FOLLOWING REGISTERS SET BY RESUME:                                   64610000
**       0 = ADDRESS OF SUSPENDED TCB.                                  64680000
**       1 = ADDRESS OF SUSPENDED RB.                                   64750000
** REGISTER 13 SET TO EXIT ADDRESS (BIT-0 MUST BE 0).                   64820000
*                                                                       64890000
         MVI   DFRRCODE,CERRN03    SET ERROR CODE                       64920000
         SUSPEND RB=PREVIOUS       SUSPEND CALLER'S RB                  64960000
         STM   R0,R1,APIOTR        SAVE SUSPENDED TCB/RB                65030000
*                                  * IN APIOTCB/APIORB.                 65100000
         MVI   DFRRCODE,CERRN99    RESET DEFAULT CODE                   65130000
         L     R13,CVTEXP1         FORCE DISPATCH SEARCH SINCE          65170000
*                                  * PREVIOUS RB NON-DISPATCHABLE       65240000
*                                  * (SUSPENDED - RESUME NOT ISSUED)    65310000
         OI    APIOFLG3,APIORSME   SHOW RESUME REQUIRED (RECOVERY)      65380000
         SPACE 5                                                        68110000
SYNCHSET EQU   *                   APIO UPDATED                         68180000
*                                                                       68250000
** APIO UPDATED FOR SYNCHRONOUS/ASYNCHRONOUS PROCESSING                 68320000
*                                                                       68390000
*                                                                       68460000
** CURRENTLY ASSIGNED REGISTERS:                                        68530000
**      R3         CVTMAP                                               68600000
**      R6         BASE REGISTER                                        68670000
**      R8         DFRRSTK                                              68740000
**      R9         APIO (INCLUDES IOSB AND SRB)                         68810000
**      R13        EXIT ADDRESS                                         68880000
*                                                                       69020000
         EJECT ,                                                        69090000
*********************************************************************** 69160000
**                                                                   ** 69230000
** CONTROL BLOCKS BUILT.  CANCEL THE RECOVERY ENVIRONMENT.           ** 69300000
** KEEP THE LOCAL LOCK.                                              ** 69370000
**                                                                   ** 69440000
*********************************************************************** 69510000
         SPACE 2                                                        69580000
*                                                                       69650000
** CANCEL THE FRR. THE LOCAL LOCK STILL HELD TO PREVENT                 69720000
** CANCELLATION, DETACH, ETC.                                           69790000
*                                                                       69860000
** REGISTERS DESTROYED: R14,R15  (SEE WRKREGS OPTION)                   69930000
*                                                                       70000000
         DROP  RFRRSTK             DONE WITH RECOVERY DSECT             70070000
         SETFRR D,                 DELETE RECOVERY ENVIRONMENT         *70140000
               WRKREGS=(R14,R15),  * (PREPARATION FOR EXIT)            *70210000
               RELATED=(DFRRSTK,EXIT,CALLDISP)                          70280000
*                                                                       70350000
** CURRENTLY ASSIGNED REGISTERS:                                        70420000
**      R3         CVTMAP                                               70490000
**      R6         BASE REGISTER                                        70560000
**      R9         APIO (INCLUDES IOSB AND SRB)                         70630000
**      R13        EXIT ADDRESS                                         70700000
         EJECT ,                                                        70840000
*********************************************************************** 70910000
**                                                                   ** 70980000
** APIO/IOSB/SRB CONSTRUCTED.  SCHEDULE THE I/O REQUEST.             ** 71050000
**                                                                   ** 71120000
*********************************************************************** 71190000
         SPACE 2                                                        71260000
*                                                                       71330000
** SRB ADDRESS IS IN THE APIO AT LABEL APIOSRB.                         71400000
** SAVE THE TOD CLOCK.  THIS IS USED FOR 3838                           71470000
** LOAD BALANCE PROCESSING.  THEN ISSUE THE                             71540000
** STARTIO.                                                             71610000
*                                                                       71680000
** REGISTERS DESTROYED:  ALL BUT REGISTER 13.                           71750000
*                                                                       71820000
         STCK  APIOSAVE+2          SAVE TOD CLOCK.                      71890000
         L     R1,APIOSAVE+4       SET APIOTMES TO START TIME.  USE     71960000
         LA    R1,0(,R1)           * BITS 24-43 OF THE TOD CLOCK.       72030000
         SRL   R1,4                * BITS 0-11 = 0                      72100000
         ST    R1,APIOTMES         * BITS 12-31 = BITS 24-43 OF TOD CLK 72170000
*                                  * (BIT 19 = APRROX 1 SEC)            72240000
         SPACE 2                                                        72310000
         LA    R1,APIOSRB          POINT TO SRB                         72380000
         STARTIO SRB=(1),TCB=SRB   ISSUE I/O REQUEST. SRB POINTS TO TCB 72450000
         SPACE 3                                                        72520000
*                                                                       72590000
** CURRENTLY ASSIGNED REGISTERS:                                        72660000
**      R13        EXIT ADDRESS                                         72730000
*                                                                       72870000
         EJECT ,                                                        72940000
*********************************************************************** 73010000
**                                                                   ** 73080000
** I/O PROCESSING COMPLETE.  PERFORM EXIT LOGIC                      ** 73150000
**                                                                   ** 73220000
*********************************************************************** 73290000
         SPACE 2                                                        73360000
         BR    R13                 EXIT                                 73430000
         SPACE 5                                                        82530000
*********************************************************************** 82600000
**                                                                   ** 82670000
** PROCESSING COMPLETE.  ALL RESOURCES RELEASED                      ** 82740000
**                                                                   ** 82810000
*********************************************************************** 82880000
         EJECT ,                                                        82950000
*********************************************************************** 83020000
**                                                                   ** 83090000
**                           ERROR EXITS                             ** 83160000
**                                                                   ** 83170000
**  SET ERROR CODE IN 'DFRRCODE' AND THEN ABEND.  THIS FORCES        ** 83180000
**  CONTROL TO 'XSTAE' TO LOG THE ERROR AND BACK-OUT ANY             ** 83190000
**  UPDATES.                                                         ** 83200000
**                                                                   ** 83230000
*********************************************************************** 83300000
         SPACE 2                                                        83370000
         USING DFRRSTK,RFRRSTK     FRR ESTABLISHED DURING               83390000
*                                  * DRIVER PROCESSING                  83410000
         DS    0H                  INSURE ALIGNMENT                     83440000
ERRORA   EQU   *                   SETLOCK FAILED                       83510000
         L     R1,APDXAPCT-APDX(,RAPDXPTR) FRR NOT ESTABLISHED          83580000
         L     R1,APCTABND-APCT(,R1) * ABEND TO SHOW LOCK NOT AVAILABLE 83600000
         ABEND (1)                 * LOGS PROBLEM (SYSTEM)              83620000
         SPACE ,                                                        83640000
ERRORB   EQU   *                   INVALID APIO SPECIFIED               83720000
         MVI   DFRRCODE,CERRN04    SHOW ERROR                           83790000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        83820000
         SPACE ,                                                        83850000
ERRORC   EQU   *                   APIO ALREADY ACTIVE                  83930000
         MVI   DFRRCODE,CERRN05    SHOW ERROR                           84000000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84030000
         SPACE ,                                                        84060000
ERRORD   EQU   *                   PGFIX FAILED                         84140000
         MVI   DFRRCODE,CERRN02    SHOW ERROR                           84210000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84250000
         SPACE ,                                                        84290000
ERRORE   EQU   *                   CANNOT FIND USABLE PORT              84330000
*                                  (UNALLOCATION MUST LEAVE ONE AROUND) 84370000
         MVI   DFRRCODE,CERRN06    SHOW ERROR                           84410000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84450000
         SPACE ,                                                        84490000
ERRORF   EQU   *                   'LRA' INSTRUCTION FAILED             84630000
         MVI   DFRRCODE,CERRN08    SHOW ERROR                           84700000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84730000
         SPACE ,                                                        84760000
         SPACE 2                                                        84840000
ERRORG   EQU   *                   APIO OVERLAID                        84910000
         MVI   DFRRCODE,CERRN09    SHOW ERROR                           84980000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84982000
         SPACE ,                                               @ZA26916 84982400
ERRORH   EQU   *                   0 COUNT OR WRAP-AROUND      @ZA26916 84982800
         MVI   DFRRCODE,CERRN15    SHOW ERROR                  @ZA26916 84983200
         B     ERRORZ              GO TO COMMON ERROR EXIT CODE@ZA26916 84983600
         SPACE ,                                                        84984000
ERRORJ   EQU   *                   3838 FOR EXCLUSIVE USER RE-IPL'ED    84986000
         MVI   DFRRCODE,CERRN07    SHOW ERROR                           84988000
         B     ERRORZ              GO TO COMMON ERROR EXIT LOGIC        84990000
         SPACE 2                                                        84992000
ERRORZ   EQU   *                   COMMON ERROR EXIT LOGIC              84994000
         L     R1,DFRRAPCT         FIND APCT                            84996000
         L     R1,APCTABND-APCT(,R1) ABEND CODE/DUMPT                   84998000
         ABEND (1)                 TAKE DUMP                            85000000
*                                                                       85002000
** CONTROL PASSES TO 'XSTAE' VIA RTM/1.                                 85004000
*                                                                       85006000
         DROP  RFRRSTK             FINISHED WITH RECOVERY POINTER       85008000
         EJECT ,                                                        85010000
XSTAE    EQU   *                                                        85012000
         SPACE ,                                                        85014000
*********************************************************************** 85016000
**                                                                   ** 85018000
**     ABEND OCCURRED.  THIS FRR EXIT GAINS CONTROL FROM RTM/1.      ** 85020000
**     THIS ROUTINE WILL BUILD AN 'APES' (THE STANDARD VPSS          ** 85022000
**     ERROR RECOVERY INTERFACE), AND THEN PASS CONTROL TO 'IGTUKA'  ** 85024000
**     FOR PROCESSING (STANDARD VPSS RECOVERY ROUTINE).  THIS        ** 85026000
**     TECHNIQUE ALLOWS THE USE OF THE STANDARD VPSS RECOVERY        ** 85028000
**     PROCESSING WITHOUT THE OVERHEAD OF BUILDING THE APES ON       ** 85030000
**     NON-ERROR CALLS.  CONTROL WILL BE PASSED TO IGTUKA AS IF      ** 85032000
**     IT WERE DEFINED AS THE INITIAL FRR PROGRAM.                   ** 85034000
**                                                                   ** 85036000
**     THE APVU WORKAREA IS USED BY THIS ROUTINE.  ALTHOUGH THIS     ** 85038000
**     REQUIRES THE CMS LOCK, THERE SHOULD BE NO PROBLEM SINCE       ** 85040000
**     THIS PROCESSING IS SELDOM REQUIRED.                           ** 85042000
**                                                                   ** 85044000
**     CONTROL WILL BE RETURNED TO 'XSTAE2' WHEN IGTUKA COMPLETES    ** 85046000
**     RECOVERY (AFTER LOGGING THE ERROR).                           ** 85048000
**                                                                   ** 85050000
*********************************************************************** 85052000
         SPACE 2                                                        85054000
         PUSH  USING               REGISTERS DESTROYED ON ENTRY         85056000
         DROP  ,                   TO FRR.  ONLY THE FOLLOWING          85058000
*                                  REGISTERS OK --                      85060000
         USING XSTAE,R15           BASE REGISTER                        85062000
         USING SDWA,R1             DIAGNOSITC WORKAREA                  85064000
*                                  R0 -> 200 BYTE WORKAREA              85066000
         USING FLC,*-*             ABSOLUTE ADDRESSING                  85068000
         DROP  R15                 DONE WITH BASE                       85070000
         LR    R15,R0              PUT WORKAREA ADDR IN USEFULL         85072000
*                                  REGISTER                             85074000
         STM   R0,R15,0(R15)       SAVE INPUT REGISTERS                 85076000
         LR    RFRRSAVE,R0         KEEP IN STABLE REGISTER              85078000
         BALR  R15,*-*             *** MUST PRECEDE 'LA'                85080000
         LA    RCODE,*-IGTKBA      *** MUST FOLLOW 'BALR'               85082000
         LCR   RCODE,RCODE         RE-ESTABLISH BASE REGISTER           85084000
         AR    RCODE,R15           TO STANDARD ADDRESS                  85086000
         LR    RSDWAPTR,R1         KEEP SDWA ADDRESS IN STABLE REGISTER 85088000
         DROP  R1                  FINISHED WITH TEMPORARY REGS         85090000
         USING SDWA,RSDWAPTR       STANDARD POINTER                     85092000
         USING IGTKBA,RCODE        STANDARD BASE                        85094000
         L     RFRRSTK,SDWAPARM    POINT TO DFRRSTK                     85096000
         USING DFRRSTK,RFRRSTK     TELL ASSEMBLER                       85098000
*                                                                       85100000
** INSURE APCT ADDRESS IN RECOVERY WORKAREA OK.                         85102000
** IF NOT, THEN JUST CONTINUE THE ABEND SINCE                           85104000
** THE REQUIRED POINTERS ARE NOT YET SAVED IN THE                       85106000
** 6-WORD RECOVERY WORKAREA.                                            85108000
*                                                                       85110000
         L     APCTPTR,DFRRAPCT    POINT TO APCT                        85112000
         USING APCT,APCTPTR        TELL THE ASSEMBLER                   85114000
         SRL   APCTPTR,2           INSURE APCTPTR CONTAINS              85116000
         SLL   APCTPTR,2           FULLWORD-ALIGNED ADDRESS             85118000
         LRA   R0,APCT             INSURE ADDRESS IN REAL MEMORY        85120000
         BNZ   XSTAE1A             (APCT FIXED).                        85122000
         L     R0,CAPCTID          INSURE REALLY APCT. IF NOT,          85124000
         C     R0,APCTID           CONTINUE THE ABEND.                  85126000
         BNE   XSTAE1A             * (MUST BE EARLY IN PROCESSING)      85128000
         DROP  APCTPTR             SETLOCK WILL DESTROY APCTPTR         85130000
*                                                                       85132000
** OBTAIN THE CMS LOCK.  THIS IS REQUIRED TO USE                        85134000
** THE APVU WORKAREA (APVUWORK).  THE CMS LOCK                          85136000
** MUST BE MAINTAINED THROUGHOUT THE RECOVERY                           85138000
** PROCESS SINCE THE 'APES' IS CONSTRUCTED IN                           85140000
** 'APVUWORK'.                                                          85142000
*                                                                       85144000
** REGISTERS DESTROYED: 11, 12, 13, 14                                  85146000
** REGISTERS SET: R13 SET TO SETLOCK RETURN CODE                        85148000
*                                                                       85150000
         SETLOCK OBTAIN,TYPE=CMS,  GET THE CMS LOCK                    *85152000
               MODE=UNCOND,        * REQUIRED TO USE THE WORKAREA      *85154000
               RELATED=APVU        * IN THE APVU (APVUWORK).            85156000
         LTR   R13,R13             CHECK SETLOCK RETURN CODE            85158000
         BNZ   XSTAE1A             IF FAIL, QUIT                        85160000
         SPACE 2                                                        85162000
*********************************************************************** 85164000
**                                                                   ** 85166000
**     BUILD AN 'APES' IN 'APVUWORK'.  THIS WORKAREA IS MAPPED BY    ** 85168000
**     THE LOCAL DSECT 'DVUDSECT'.  SET RETRY REGISTERS TO THE       ** 85170000
**     FOLLOWING:                                                    ** 85172000
**              3 - ADDRESS OF THE CVT (CVTMAP)                      ** 85174000
**              6 - ADDRESS OF IGTKBA (BASE REGISTER)                ** 85176000
**              7 - ADDRESS OF DVUDSECT (APVUWORK)                   ** 85178000
**              8 - ADDRESS OF DFRRSTK (6-WORD FRR WORKAREA)         ** 85180000
**              9 - ADDRESS OF APIO (INCLUDES IOSB AND SRB)          ** 85182000
**             12 - ADDRESS OF APCT                                  ** 85184000
**             15 - ADDRESS OF THE RETRY ROUTINE (XSTAE2)            ** 85186000
**     NOTE THAT DEPENDING UPON WHERE THE ERROR OCCURRED, CERTAIN    ** 85188000
**     VALUES MAY BE INVALID.  DETERMINATION OF THIS IS A            ** 85190000
**     REQUIREMENT OF THE RETRY ROUTINE.                             ** 85192000
**                                                                   ** 85194000
*********************************************************************** 85196000
         SPACE ,                                                        85198000
         L     APCTPTR,DFRRAPCT    POINT TO APCT                        85200000
         USING APCT,APCTPTR        TELL ASSEMBLER                       85202000
         L     RVUWORK,APCTAPVU    POINT TO WORKAREA IN                 85204000
         LA    RVUWORK,APVUWORK-APVU(,RVUWORK) * APVU (APVUWORK).       85205000
         USING DVUDSECT,RVUWORK    TELL THE ASSEMBLER                   85206000
         LA    R0,APES             INITIALIZE APES WITH                 85210000
         LA    R1,APESLN           * STANDARD HEADER INFORMATION.       85212000
         LA    R14,CAPES           * INITIALIZE REMAINDER OF APES       85214000
         LA    R15,L'CAPES         * TO ZEROS (FOR DEBUGGING).          85216000
         MVCL  R0,R14              NOTE: APES > 256 BYTES               85218000
         LA    R1,APES             SET 1ST WORD OF 6-WORD FRR           85220000
         ST    R1,DFRRAPES         * AREA TO @ APES                     85222000
         ST    R1,APESADDR         * THIS IS IGTUKA REQUIREMENT.        85224000
         LA    R1,APESREGZ         INITIALIZE POINTER TO                85226000
         ST    R1,APESREGP         * RETRY REGISTER VALUES.             85228000
*                                  * INITIALIZE ADDITIONAL RETRY REGS   85230000
         L     RCVTPTR,FLCCVT      CVT ADDRESS                          85232000
         L     RAPIOPTR,DFRRAPIO   APIO ADDRESS (IF ANY)                85234000
         LA    R15,XSTAE2          SET RETRY POINT                      85236000
         STM   R0,R15,APESREGZ     SAVE RETRY REGISTERS                 85238000
*                                                                       85240000
** SET DUMP/RECORDING OPTIONS IN THE APES.                              85242000
** USE 'DFRRCODE' TO INDEX INTO 'MERRTBL'                               85244000
** TO SET 'APESFLG0'.                                                   85246000
*                                                                       85248000
         SR    R1,R1               CLEAR HI BYTES                       85250000
         ICM   R1,B'0001',DFRRCODE GET ERROR CODE                       85252000
         BZ    XSTAE1B             IF OUTSIDE OF RANGE                  85254000
         CLI   DFRRCODE,CERRN99    * 0 < DFRRCODE <= CERRN99            85256000
         BNH   XSTAE1C             * USE CERRN99                        85258000
XSTAE1B  EQU   *                   * (IE SET TO                         85260000
         LA    R1,CERRN99          *  'UNEXPECTED ERROR')               85262000
XSTAE1C  EQU   *                   R1 = ERROR INDEX                     85264000
         STC   R1,APESCODE         SAVE ERROR CODE IN APES              85266000
         SLL   R1,3                SET MERRTBL INDEX (ENTRY = 8-BYTES)  85268000
         IC    R1,XESFLG0-APESMV+MERRTBL-APESMVLN(R1) PUT APESFLG0      85270000
*                                  * IN APES (ENTRY 0 IS ERR # 1)       85272000
         STC   R1,APESFLG0         (DUMP/LOG REQUIREMENTS)              85274000
         SPACE 2                                                        85276000
*********************************************************************** 85278000
**                                                                   ** 85280000
**     APES BUILT.  ISSUE SETFRR TO RESET THE RETRY ADDRESS TO       ** 85282000
**     'IGTUKA'.  RECURSION PROCESSING WILL THEN GO DIRECTLY TO      ** 85284000
**     THE STANDARD VPSS RECOVERY ROUTINE (OK SINCE THE APES         ** 85286000
**     IS NOW CONSTRUCTED).  THE 6-WORD RECOVERY AREA WILL NOT       ** 85288000
**     BE MODIFIED.  THEN PASS CONTROL TO 'IGTUKA' TO PROCESS THIS   ** 85290000
**     INITIAL ERROR.  REGISTERS 0-14 ARE THE SAME AS WHEN THIS      ** 85292000
**     ROUTINE WAS ENTERED.  REGISTER 15 IS SET TO THE ADDRESS OF    ** 85294000
**     'IGTUKA'.  THEREFORE IT APPEARS TO 'IGTUKA' THAT IT WAS THE   ** 85296000
**     INITIAL RECOVERY ROUTINE.  CONTROL WILL BE RETURNED TO        ** 85298000
**     'XSTAE2' WHEN RECOVERY IS COMPLETE.                           ** 85300000
**                                                                   ** 85302000
*********************************************************************** 85304000
         SPACE ,                                                        85306000
*                                                                       85308000
** ISSUE SETFRR TO CHANGE EXIT TO 'IGTUKA'.                             85310000
*                                                                       85312000
** REGISTERS DESTROYED: 14, 15 (SEE WRKREGS OPTIONS)                    85314000
*                                                                       85316000
         SETFRR R,FRRAD=APCTZUKA,  REPLACE CURRENT FRR WITH ENTRY      *85318000
               WRKREGS=(R14,R15),  * TO IGTUKA.  DO NOT CLEAR          *85320000
               RELATED=(DFRRSTK)   * 6-WORD WORKAREA -- DFRRSTK         85322000
         SPACE ,                                                        85324000
         L     R15,APCTZUKA        GO TO STANDARD RECOVERY ROUTINE      85326000
         LM    R0,R14,0(RFRRSAVE)  * PASS SAME REGISTERS AS ON          85328000
         BR    R15                 * INPUT EXCEPT R15 -> NEW EXIT       85330000
*                                  * ROUTINE (IGTUKA)                   85332000
         SPACE ,                                                        85334000
*                                                                       85336000
** CONTROL DOES NOT RETURN HERE                                         85338000
** BUT PASSES TO 'XSTAE2'.                                              85340000
*                                                                       85342000
         SPACE 5                                                        85344000
*                                                                       85346000
** INVALID INPUT TO FRR -- CANNOT LOCATE APCT                           85348000
** RETURN TO RTM/1 TO PERCOLATE THE ERROR                               85350000
*                                                                       85352000
         SPACE ,                                                        85354000
XSTAE1A  EQU   *                   UNABLE TO RECOVER                    85356000
         LM    R0,R15,0(RFRRSAVE)  RE-LOAD INPUT REGISTERS              85358000
         BR    R14                 RETURN TO RTM                        85360000
         SPACE ,                                                        85362000
         POP   USING               RESTORE INITIAL USING STATUS         85364000
         EJECT ,                                                        85366000
XSTAE2   EQU   *                   RECOVERY LOGIC                       85368000
         SPACE ,                                                        85370000
*********************************************************************** 85372000
**                                                                   ** 85374000
**     IGTKBA RECOVERY ROUTINE.  THIS ROUTINE GAINS CONTROL FROM     ** 85376000
**     IGTUKA TO RELEASE RESOURCES ACQUIRED BY IGTKBA PRIOR TO THE   ** 85378000
**     FAILURE AND TO INDICATE THE FAILURE TO THE USER.  TO          ** 85380000
**     MAXIMIZE RECOVERY, RECURSION RECOVERY IS PROVIDED TO FREE     ** 85382000
**     AS MANY ACQUIRED RESOURCES AS POSSIBLE.  TO PROVIDE THIS      ** 85384000
**     BACK-OUT CAPABILITY WHILE PREVENTING ENDLESS LOOPS, THE       ** 85386000
**     FOLLOWING IS DONE FOR EACH RESOURCE TO BE RELEASED:           ** 85388000
**          1.  RESET THE APPROPRIATE "BACK-OUT REQUIRED" INDICATOR  ** 85390000
**          2.  SHOW RECOVERY COMPLETE (THUS ALLOWING RECURSION)     ** 85392000
**          3.  PERFORM THE ACTUAL BACK-OUT.                         ** 85394000
**     IF A FAILURE OCCURS FREEING A RESOURCE, THE NEXT PASS THRU    ** 85396000
**     THIS LOGIC WILL BYPASS FREEING THE SAME RESOURCE.             ** 85398000
**                                                                   ** 85400000
*********************************************************************** 85402000
         SPACE 2                                                        85404000
*                                                                       85406000
**     FOLLOWING REGISTERS INITIALIZED ON ENTRY:                        85408000
**              3 - ADDRESS OF THE CVT (CVTMAP)                         85410000
**              6 - ADDRESS OF IGTKBA (BASE REGISTER)                   85412000
**              7 - ADDRESS OF DVUDSECT (APVUWORK)                      85414000
**              8 - ADDRESS OF DFRRSTK (6-WORD FRR WORKAREA)            85416000
**              9 - ADDRESS OF APIO (INCLUDES IOSB AND SRB)             85418000
**             12 - ADDRESS OF APCT                                     85420000
**             15 - ADDRESS OF THE RETRY ROUTINE (XSTAE2)               85422000
**     NOTE THAT DEPENDING UPON WHERE THE ERROR OCCURRED, CERTAIN       85424000
**     VALUES MAY BE INVALID.                                           85426000
*                                                                       85428000
         SPACE 2                                                        85430000
         PUSH  USING               SAVE USING STATUS                    85432000
         DROP  ,                   RESET ALL REGISTER DEFINITIONS       85434000
         USING CVTMAP,RCVTPTR      TELL ASSEMBLER OF                    85436000
         USING IGTKBA,RCODE        * BASE REGISTERS                     85438000
         USING DVUDSECT,RVUWORK    * FOR THE RETRY                      85440000
         USING DFRRSTK,RFRRSTK     * ROUTINE                            85442000
         USING APIO,RAPIOPTR                                            85444000
         USING APCT,APCTPTR                                             85446000
         USING FLC,*-*             ABSOLUTE ADDRESSING 0-4095           85448000
         DROP  APCTPTR             REG 12 IS LOCALLY DESTROYED          85450000
         SPACE ,                                                        85452000
         MVI   APESCODE,CERRN99    SET "UNEXPECTED ERROR" INDICATOR     85454000
         OI    APESFLG0,APESFDMP+APESFREC+APESFSDP SET STANDARD         85456000
*                                  * LOGGING/DUMPING INDICATORS         85458000
         LTR   RAPIOPTR,RAPIOPTR   APIO EXIST ?                         85460000
         BZ    NREC20              * NO -- JUST GO FLAG APRL SINCE      85462000
*                                  * RESOURCES ARE TIED TO AN APIO.     85464000
         L     R0,CAPIOID          INSURE VALID APIO                    85466000
         C     R0,APIOID           * SKIP PROCESSING IF NOT             85468000
         BNE   NREC20              * (PREVENTS STORAGE OVERLAY)         85470000
         CLI   APIOACTV,0          APIO ACTIVE ?                        85472000
         BE    NREC20              * IF NOT, ALSO SKIP                  85474000
         SPACE ,                                                        85476000
*                                                                       85478000
** IF SUSPEND ISSUED (APIORSME = 1), ISSUE RESUME                       85480000
*                                                                       85482000
         TM    APIOFLG3,APIORSME   RESUME REQUIRED ?                    85484000
         BZ    NREC01Z             * NO -- TRY NEXT RESOURCE            85486000
         NI    APIOFLG3,X'FF'-APIORSME RESET RESUME-REQUIRED INDICATOR  85488000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85490000
         MVI   APESCODE,CERRN11    SET ERROR INDICATOR                  85492000
*                                                                       85494000
** FOLLOWING REGISTERS DESTROYED: 0, 1, 4, 5, 11, 12, 13, 14, 15        85496000
*                                                                       85498000
         LM    R4,R5,APIOTR        R4 = TCB, T5 = RB                    85500000
         RESUME TCB=(4),RB=(5)     SET WAIT COUNT TO ZERO               85502000
         MVI   APESCODE,CERRN99    RESET STANDARD ERROR ID              85504000
         SPACE ,                                                        85506000
NREC01Z  EQU   *                   RESUME ISSUED IF REQUIRED            85508000
         SPACE 2                                                        85510000
*                                                                       85512000
** IF APUB I/O COUNT INCLUDES THIS APIO,                                85514000
** ADJUST THE COUNTS SINCE THE I/O WILL NOT BE                          85516000
** ISSUED.                                                              85518000
*                                                                       85520000
         TM    APIOFLG3,APIOIOCT   APUB I/O COUNTS INCLUDE THIS APIO ?  85522000
         BZ    NREC02Z             * NO -- TRY NEXT RESOURCE            85524000
         NI    APIOFLG3,X'FF'-APIOIOCT RESET COUNT-INCLUDED INDICATOR   85526000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85528000
         MVI   APESCODE,CERRN12    SET ERROR INDICATOR                  85530000
         MODESET EXTKEY=SCHED      GO TO APUB KEY                       85532000
*                                                                       85534000
** FOLLOWING REGISTERS DESTROYED: 0, 1, 14, 15                          85536000
*                                                                       85538000
         L     R14,APIOXTME        I/O VALUE TO SUBTRACT                85540000
         L     R15,APIOAPUB        APUB WHICH WAS TO PROCESS I/O        85542000
         USING APUB,R15            TELL ASSEMBLER                       85544000
         L     R0,CAPUBID          INSURE REALLY AT APUB                85546000
         C     R0,APUBID           * (ERROR IF NOT)                     85548000
         BNE   NREC02Y             * PREVENT STORAGE OVERLAY            85550000
         L     R1,APUBIOCT         CURRENT I/O COUNT                    85552000
NREC02B  EQU   *                   COMPARE-AND-SWAP RETRY POINT         85554000
         LR    R0,R1               SET R0 = NEW I/O COUNT               85556000
         SR    R0,R14              * I.E. REMOVE THIS I/O COUNT         85558000
         BNP   NREC02Y             DO NOT LET COUNT GO NEGATIVE         85560000
         CS    R1,R0,APUBIOCT      UPDATE COUNT IF POSSIBLE             85562000
         BNZ   NREC02B             RETRY IF CS FAILED                   85564000
         SPACE ,                                                        85566000
         L     R15,APUBMSTR        POINT TO MASTER APUB                 85568000
         L     R0,CAPUBID          INSURE REALLY AT APUB                85570000
         C     R0,APUBID           * (ERROR IF NOT)                     85572000
         BNE   NREC02Y             * PREVENT STORAGE OVERLAY            85574000
         L     R1,APUBIOCT         CURRENT I/O COUNT                    85576000
NREC02C  EQU   *                   COMPARE-AND-SWAP RETRY POINT         85578000
         LR    R0,R1               SET R0 = NEW I/O COUNT               85580000
         SR    R0,R14              * I.E. REMOVE THIS I/O COUNT         85582000
         BNP   NREC02Y             DO NOT LET COUNT GO NEGATIVE         85584000
         CS    R1,R0,APUBIOCT      UPDATE COUNT IF POSSIBLE             85586000
         BNZ   NREC02C             RETRY IF CS FAILED                   85588000
         SPACE ,                                                        85590000
NREC02Y  EQU   *                   APUB ERROR DETECTED                  85592000
         MODESET EXTKEY=ZERO       RESUME STANDARD KEY                  85594000
         MVI   APESCODE,CERRN99    RESET STANDARD ERROR ID              85596000
         SPACE ,                                                        85598000
NREC02Z  EQU   *                   I/O COUNTS DECREMENTED IF REQUIRED   85600000
         SPACE 2                                                        85602000
*                                                                       85604000
** IF PGFIX COMPLETED BY IGTKBA (APIOPGFS=1)                            85606000
** OR ABEND OCCURED WHILE IGTKBA PROCESSING VSL                         85608000
** ENTRIES (APIOPGIP=1), ISSUE PGFREE.  TREAT                           85610000
** A COMPLETED PGFIX AS PGFIX IN PROGRESS AND                           85612000
** SET THE FAILING ENTRY POINTER (DFRRVSL)                              85614000
** AS IF PROCESSING THE ENTRY PAST THE END OF                           85616000
** THE LIST (DFRRVSL POINTS TO FAILING ENTRY,                           85618000
** SO THIS INDICATES ALL PREVIOUS ENTRIES ARE FIXED).                   85620000
*                                                                       85622000
** REGISTERS DESTROYED BY ROUTINE: 0, 1, 2, 4, 14, 15                   85624000
*                                                                       85626000
         TM    APIOFLG3,APIOPGIP+APIOPGFS PGFIX DONE OR IN PROGRESS ?   85628000
         BZ    NREC03Z             * NO -- TRY NEXT RESOURCE            85630000
         TM    APIOFLG3,APIOPGFS   PGFIX COMPLETE ?                     85632000
         BZ    NREC03B             * NO -- GOTO IN-PROGRESS PROCESSING  85634000
         L     R15,APIOPGFL        SET FAILING ENTRY ADDRESS TO         85636000
         LA    R15,VSLLEN(,R15)    LAST ENTRY + 1                       85638000
         ST    R15,DFRRVSL         THEN ACT AS IF                       85640000
         XI    APIOFLG3,APIOPGIP+APIOPGFS * PGFIX IN PROGRESS           85642000
NREC03B  EQU   *                   PGFIX IN PROGRESS PROCESSING         85644000
*                                                                       85646000
** WORK FROM LAST FIXED ENTRY BACK TO INITIAL ENTRY.                    85648000
** BACK-UP DFRRVSL TO PREVENT ENDLESS RECURSION.                        85650000
** SHOW RECOVERY SUCCESSFUL WHEN DFRRVSL RESET.                         85652000
*                                                                       85654000
         L     R15,DFRRVSL         ADDRESS OF NEXT VSL                  85656000
         LA    R0,VSLLEN           SET R15 TO LAST PROCESSED ENTRY      85658000
         SR    R15,R0              * (IE PREVIOUS VSL ENTRY)            85660000
         ST    R15,DFRRVSL         SAVE FOR RECURSION                   85662000
         C     R15,APIOPGFX        REACHED START OF VSL ?               85664000
         BL    NREC03D             * YES -- PGFREE COMPLETE             85666000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85668000
         MVI   APESCODE,CERRN13    SET ERROR INDICATOR                  85670000
         LM    R1,R2,VSLSTRT-VSL(R15) BEGIN/END OF PGFIX AREA           85672000
         O     R1,CPGFRFLG         SHOW SHORT-TERM PGFREE               85674000
         O     R2,CSETHIBT         SHOW END-OF-LIST                     85676000
         SR    R4,R4               NO TCB (SHORT TERM - NO FOE)         85678000
         LA    R0,APIOSAVE         PGFIX ECB                            85680000
         L     R15,CVTVPSIB        CALL BRANCH ENTRY                    85682000
         CALL  (15)                * PGFIX/PGFREE SERVICES              85684000
         B     NREC03B             GO PROCESS NEXT ENTRY                85686000
NREC03D  EQU   *                   ALL VSL ENTRIES PROCESSED            85688000
         NI    APIOFLG3,X'FF'-APIOPGIP-APIOPGFS CLEAR PGFIX DONE FLAG   85690000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85692000
         MVI   APESCODE,CERRN99    RESET STANDARD ERROR CODE            85694000
         SPACE ,                                                        85696000
NREC03Z  EQU   *                   PGFIX COMPLETE OR NOT REQUIRED       85698000
         SPACE 2                                                        85700000
*                                                                       85702000
** MARK APIO INACTIVE.  WHEN THIS OCCURS, THE                           85704000
** APIO CANNOT BE REFERENCED AGAIN.                                     85706000
*                                                                       85708000
         SPACE ,                                                        85710000
         CLI   APIOACTV,0          APIO ACTIVE ?                        85712000
         BE    NREC04Z             * NO -- SKIP RESET                   85714000
         MVI   APESCODE,CERRN09    SET ERROR CODE                       85716000
         SR    R0,R0               CLEAR APIO POINTER TO PREVENT        85718000
         ST    R0,DFRRAPIO         * RE-USE OF DEACTIVATED APIO         85720000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85722000
         MVI   APIOACTV,0          INACTIVATE APIO                      85724000
         MVI   APESCODE,CERRN99    RESET STANDARD ERROR CODE            85726000
         SPACE ,                                                        85728000
NREC04Z  EQU   *                   APIO NOW DEACTIVATED                 85730000
*                                  * AND THEREFORE CANNOT BE REFERENCED 85732000
         DROP  RAPIOPTR            * TELL ASSEMBLER                     85734000
         EJECT ,                                                        85736000
NREC20   EQU   *                   RESOURCES FREED -- FLAG APRL         85738000
*                                                                       85740000
         SPACE 2                                                        85742000
*********************************************************************** 85744000
**                                                                   ** 85746000
**     RECOVERY HAS FREED SYSTEM RESOURCES.  UPDATE THE APRL TO      ** 85748000
**     INDICATE THE INITIAL ERROR (APESCOD1 CONTAINS THIS VALUE).    ** 85750000
**     SET ECB COMPLETION CODE TO '40' TO INDICATE ERROR DETECTED    ** 85752000
**     BY IGTKBA (RATHER THAN 3838).                                 ** 85754000
**                                                                   ** 85756000
*********************************************************************** 85758000
         SPACE 2                                                        85760000
         L     RAPRLPTR,DFRRAPRL   ADDRESS OF APRL                      85762000
         LTR   RAPRLPTR,RAPRLPTR   ANY EXIST ?                          85764000
         BZ    NREC20Z             * NO -- SKIP UPDATE                  85766000
         SR    R1,R1               CLEAR REGISTER                       85768000
         ST    R1,DFRRAPRL         PREVENT RECURSION                    85770000
         NI    APESFLG1,X'FF'-APESFPRV SHOW RECOVERY COMPLETE           85772000
         USING APRL,RAPRLPTR                                            85774000
         ICM   R1,B'0001',APESCOD1 INITIAL ERROR CODE                   85776000
         BZ    NREC20Z             SKIP IF NO ERROR (?)                 85778000
         SLL   R1,3                INDEX INTO MERRTBL                   85780000
         LA    R1,MERRTBL-APESMVLN(R1) * FOR ERROR VALUES               85782000
         USING APESMV,R1           TELL ASSEMBLER                       85784000
         MVI   DFRRCODE,CERRN10    SET ERROR CODE                       85786000
         MODESET KEYADDR=DFRRKEY,  SWITCH TO APRL (USER)               *85788000
               WORKREG=15          * KEY                                85790000
         MVI   APRLECBC,ECBPOST    RETURN CODE = X'40'                  85792000
         LH    R0,APESMVMS         MESSAGE NUMBER                       85794000
         STH   R0,APRLMSGN         * MOVE TO USER'S APRL                85796000
         LH    R0,APESMVKW         KEYWORD (IF ANY)                     85798000
         STH   R0,APRLVALN         * MOVE TO USER'S APRL                85800000
         IC    R0,XESRLRCN         RETURN CODE NUMBER                   85802000
         STC   R0,APRLRCN          * MOVE TO USER'S APRL                85804000
         MVI   APRLRCC,APCCI       SHOW I/O ERROR                       85806000
         IC    R0,XESRLRCT         SET RETURN CODE TYPE                 85808000
         STC   R0,APRLRCT          * (LOGICAL, CONTROL BLOCK, I/O)      85810000
         DROP  R1,RAPRLPTR         DONE WITH POINTERS                   85812000
         MODESET EXTKEY=ZERO       RESUME STANDARD KEY                  85814000
         MVI   DFRRCODE,CERRN99    RESET ERROR CODE                     85816000
NREC20Z  EQU   *                   APRL UPDATED TO INDICATE ERROR       85818000
         EJECT ,                                                        85820000
*********************************************************************** 85822000
**                                                                   ** 85824000
**     RECOVERY PROCESSING COMPLETE.  CANCEL THE RECOVERY UMBRELLA   ** 85826000
**     AND RELEASE THE OWNED LOCKS (CMS AND LOCAL).  THEN EXIT       ** 85828000
**     TO THE CALLER VIA SVC 3 (TYPE-2 EXIT).  SET REGISTER          ** 85830000
**     15 TO 'APCCRERR' TO INDICATE THAT PROCESSING FAILED.          ** 85832000
**                                                                   ** 85834000
*********************************************************************** 85836000
         SPACE 2                                                        85838000
*                                                                       85840000
** CANCEL THE RECOVERY ENVIRONMENT                                      85842000
** REGISTERS DESTROYED: 14, 15 (SEE WRKREGS OPTIONS)                    85844000
*                                                                       85846000
         SETFRR D,                 CANCEL RECOVERY ENVIRONEMENT        *85848000
               WRKREGS=(R14,R15),  * NOTE -- ALL CRITICAL RESOURCES    *85850000
               RELATED=(DFRRSTK)   * MUST BE RELEASED SINCE NO RECOVERY 85852000
*                                                                       85854000
** RELEASE THE OWNED LOCKS (CMS AND LOCAL)                              85856000
** REGISTERS DESTROYED: 11, 12, 13, 14                                  85858000
*                                                                       85860000
         SETLOCK RELEASE,TYPE=CMS, CANNOT USE APVU WHEN CMS LOCK       *85862000
               RELATED=APVU        * RELEASED                           85864000
         SETLOCK RELEASE,TYPE=LOCAL, RECOVERY MUST BE COMPLETE SINCE   *85866000
               RELATED=SETFRR      * FRR GONE                           85868000
         LA    R15,APCCRERR        SET ERROR INDICATOR                  85870000
         L     R14,FLCCVT          EXIT TO TYPE-2 SVC EXIT              85872000
         L     R14,CVTEXPRO-CVTMAP(,R14) *  VIA BRANCH ENTRY            85874000
         BR    R14                 * SINCE IN KEY-0, SUPERVISOR STATE.  85876000
         SPACE 2                                                        85878000
*********************************************************************** 85880000
**                                                                   ** 85882000
**     CONTROL DOES NOT RETURN HERE BUT RATHER PASSES BACK TO THE    ** 85884000
**     USER (NEXT HIGHER RB) VIA SVC 3.                              ** 85886000
**                                                                   ** 85888000
*********************************************************************** 85890000
         SPACE 2                                                        85892000
         POP   USING               RESTORE USING STATUS                 85894000
         EJECT ,                                                        85960000
*********************************************************************** 86030000
**                                                                   ** 86100000
** CONSTANTS                                                         ** 86170000
**                                                                   ** 86240000
*********************************************************************** 86310000
         SPACE 2                                                        86380000
CXSTAEAD DC    A(XSTAE)            ADDRESS OF RECOVERY ROUTINE          86450000
CASYNCH  DC    A(X'80000000')      SHOW ASYNCHRONOUS I/O REQUESTED      86520000
*                                  * (WAIT/POST)                        86590000
CSETHIBT EQU   CASYNCH,4,C'F'      SET END-OF-LIST INDICATOR IN         86660000
*                                  * PGFIX REGISTER FORM.               86730000
CPGFXFLG DC    A(X'40000000')      SHOW PGFIX WANTED (SET IN VSLFLAG1)  86800000
CPGFRFLG DC    A(X'20000000')      SHOW SHORT TERM PGFREE WANTED        86830000
CPGFIXIP DC    F'8'                RETURN CODE FROM PGFIX (IEAVPISB)    86870000
*                                  * INDICATING PAGE-IN IN PROGRESS     86940000
CPGSIZE  DC    A(4096)             PAGE SIZE                            87010000
CRNDPGDN DC    A(X'00FFF000')      ROUND ADDRESS DOWN TO PAGE BOUNDARY  87080000
*                                  * AND CLEAR HI-ORDER BYTE            87150000
CRND2KDN DC    A(X'00FFF800')      ROUND DOWN TO IDAL BOUNDARY (2K)     87180000
CLRXIOF  DC    A(X'FF0000FF')      CLEAR ALL BUT EXCLUSIVE-PROHIBITED   87220000
*                                  * INDICATORS FROM APUBIOFG           87290000
CLRXIPL  DC    A(X'FFFFFF7F')      CLEAR RE-IPL BIT                     87320000
CLRSIOF  DC    A(X'FFFFFF00')      CLEAR ALL BUT SHARED NOT-RECOMMENDED 87360000
*                                  * INDICATORS FROM APUBIOFG           87430000
CLRSIOFR DC    A(X'FF00FF00')      CLEAR ALL BUT SHARED-PROHIBITED      87500000
*                                  * INDICATORS FROM APUBIOFG           87570000
CAPIOFLG DC    A(X'B0008800')      CLEAR APIOFLGA BITS EXCEPT  @ZA26916 87640000
*                                  * ONES SET BY IGTKCA                 87710000
CLRCOUNT DC    A(X'0000FFFF')      CLEAR FLAGS FROM CCW XFER COUNT      87730000
*                                  * (NOTE -- CANNOT USE HALFWORD)      87750000
CAPIOID  DC    A(APIOIDC)          APIO ID FIELD                        87780000
CAPCTID  DC    A(APCTIDC)          APCT ID FIELD                        87800000
CAPUBID  DC    A(APUBIDC)          APUB ID FIELD                        87820000
         EJECT ,                                               @ZA26916 87823000
*********************************************************************** 87826000
**                                                                   ** 87829000
** EQUATES                                                           ** 87832000
**                                                                   ** 87835000
*********************************************************************** 87838000
         SPACE 2                                               @ZA26916 87841000
CXIOLN   EQU   X'800'              DATA TRANSFERRED BY 1 IDAL SLOT      87844000
         EJECT ,                                                        87850000
*********************************************************************** 87920000
**                                                                   ** 87990000
** RECOVERY WORKAREA FORMAT (MAXIMUM 6 WORDS)                        ** 88060000
**                                                                   ** 88130000
*********************************************************************** 88200000
DFRRSTK  DSECT ,                   RECOVERY WORKAREA (6-WORD MAX)       88270000
DFRRAPES DS    A                   ADDRESS OF APES (MUST BE FIRST WORD) 88340000
DFRRAPIO DS    A                   ADDRESS OF APIO BEING PROCESSING     88410000
DFRRAPRL DS    A                   ADDRESS OF INPUT APRL                88480000
DFRRAPCT DS    A                   ADDRESS OF APCT                      88550000
DFRRFLGS DS    0A                  FLAGS                                88620000
DFRRCODE DS    1X'00'              CURRENT CERRNXX ERROR INDEX          88630000
*                                  * SEE MERRTBL FOR MEANING            88640000
DFRRKEY  DS    1X'00'              APRL KEY (FROM DEB)                  88650000
         DS    1X                  *** RESERVED ***                     88660000
         DS    1X                  *** RESERVED ***                     88670000
DFRRVSL  DS    A                   VSL BEING PROCESSED                  88680000
         SPACE ,                                                        88690000
         NOPR  ((*-DFRRSTK)/(6*4+1)*16) 6-WORD MAX                      88700000
         EJECT ,                                               @ZA26916 88702000
*********************************************************************** 88704000
**                                                                   ** 88706000
** CHANNEL COMMAND WORD (CCW) FORMAT                                 ** 88708000
**                                                                   ** 88710000
*********************************************************************** 88712000
         SPACE 2                                               @ZA26916 88714000
CCW      DSECT ,                   CCW FORMAT                  @ZA26916 88716000
CCWOP    DC    01HL1'00'           OP CODE                     @ZA26916 88718000
CCWOPWR  EQU   X'01'               WRITE OP-CODE               @ZA26916 88720000
CCWOPRD  EQU   X'02'               READ OP-CODE                @ZA26916 88722000
CCWOPNOP EQU   X'03'               NO-OP OP-CODE               @ZA26916 88724000
CCWOPPRC EQU   X'0F'               PROCESS OP-CODE             @ZA26916 88726000
CCWDATA  DC    01AL3(*-*)          DATA ADDRESS                @ZA26916 88728000
CCWFLAGS DC    01BL1'00000000'     FLAGS                       @ZA26916 88730000
CCWFCD   EQU   X'80'               DATA CHAINED                @ZA26916 88732000
CCWFCC   EQU   X'40'               COMMAND CHAINED             @ZA26916 88734000
CCWFSLI  EQU   X'20'               SUPPRESS INCORRECT LENGTH   @ZA26916 88736000
CCWFSKIP EQU   X'10'               SKIP STORAGE TRANSFER       @ZA26916 88738000
CCWFPCI  EQU   X'08'               PGM CONTROLLED INTERRUPT    @ZA26916 88740000
CCWFIDA  EQU   X'04'               CCWDATA->IDAW RATHER THAN DATA       88742000
CCWFB6   EQU   X'02'               *** RESERVED ***            @ZA26916 88744000
CCWFB7   EQU   X'01'               *** RESERVED ***            @ZA26916 88746000
         DC    01BL1'00000000'     *** RESERVED ***            @ZA26916 88748000
CCWBCNT  DC    01H'0'              BYTE COUNT TO TRANSFER      @ZA26916 88750000
         SPACE ,                                               @ZA26916 88752000
CCWLN    EQU   *-CCW               LENGTH OF CCW               @ZA26916 88754000
         SPACE 5                                               @ZA26916 88756000
IGTKBA   CSECT ,                   RESUME PROGRAM CSECT        @ZA26916 88758000
         SPACE 2                                                        88760000
         EJECT ,                                                        88830000
*********************************************************************** 88836000
**                                                                   ** 88842000
**     APVUWORK OVERLAY.  CONTAINS 'APES' AND OTHER WORKAREAS        ** 88848000
**     USED BY THE RECOVERY ROUTINES.  THIS AREA IS NOT AVAILABLE    ** 88854000
**     DURING NORMAL PROCESSING (CMS LOCK REQUIRED TO USE APVUWORK). ** 88860000
**                                                                   ** 88866000
*********************************************************************** 88872000
         SPACE 2                                                        88878000
DVUDSECT DSECT ,                   APVUWORK OVERLAY                     88884000
         SPACE ,                                                        88890000
         IGTXAPES DSECT=NO         RECOVERY WORKAREA                    88896000
         SPACE 5                                                        88902000
XESFLG0  EQU   APESMV+4,1,C'X'     APESFLG0 VALUE                       88908000
XESRLRCN EQU   APESMV+5,1,C'H'     APRLRCN VALUE                        88914000
XESRLRCT EQU   APESMV+6,1,C'H'     APRLRCT VALUE                        88920000
         SPACE ,                                                        88926000
DVUDSECT DSECT ,                   RESUME WORKAREA                      88932000
         NOPR  ((*-DVUDSECT)/(APVUHDLN+1)*16) DO NOT EXCEED APVUWORK    88938000
*                                  * ASSEMBLY ERROR IF DOES             88944000
         SPACE ,                                                        88950000
IGTKBA   CSECT ,                   RESUME CSECT                         88956000
         EJECT ,                                                        88962000
*********************************************************************** 88968000
**                                                                   ** 88974000
**     'CERRN__' VALUES.  USED TO INDEX INTO 'MERRTBL' TABLE TO      ** 88980000
**     DETERMINE ERROR CONDITION DETECTED AND THE DESIRED            ** 88986000
**     RECOVERY MESSAGES AND PROCESSING OPTIONS.                     ** 88992000
**     NOTE THAT ENTRY 0 DOES NOT EXIST, AND 'CERRN99' MUST BE THE   ** 88998000
**     HIGHEST ENTRY ('UNEXPECTED ABEND').                           ** 89004000
**                                                                   ** 89010000
*********************************************************************** 89016000
         SPACE 2                                                        89022000
CERRN01  EQU   01                  SMF FAILURE                          89028000
CERRN02  EQU   02                  PGFIX FAILURE                        89034000
CERRN03  EQU   03                  SUSPEND FAILURE                      89040000
CERRN04  EQU   04                  INVALID APRL (USER ERROR)            89046000
CERRN05  EQU   05                  APIO ACTIVE (USER ERROR)             89052000
CERRN06  EQU   06                  CANNOT FIND PORT                     89058000
CERRN07  EQU   07                  EXCLUSIVE PORT RE-IPLED              89064000
CERRN08  EQU   08                  'LRA' INSTRUCTION FAILED AFTER PGFIX 89070000
CERRN09  EQU   09                  APIO OVERLAID                        89076000
CERRN10  EQU   10                  ABEND REFERENCING APRL               89082000
CERRN11  EQU   11                  RESUME FAILED                        89088000
CERRN12  EQU   12                  APUB UPDATE ERROR                    89094000
CERRN13  EQU   13                  PGFREE ERROR                         89100000
CERRN14  EQU   14                  PGM CHECK REFERENCING USER CCW       89106000
CERRN15  EQU   15                  USER CCW COUNT BAD (RETRANS)@ZA26916 89108000
CERRN99  EQU   16                  UNEXPECTED ABEND            @ZA26916 89110000
         EJECT ,                                                        89112000
*********************************************************************** 89118000
**                                                                   ** 89124000
**     APESMV TABLE LOOKUP.  EACH 'CERRN__' INDEXES INTO THIS        ** 89130000
**     TABLE TO LOCATE THE APPRORIATE ERROR CONDITIONS.              ** 89136000
**     THE TABLE FORMAT IS:                                          ** 89142000
**          0-1  - MESSAGE NUMBER (REQUIRED BY IGTUKA)               ** 89148000
**          2-3  - KEYWORD NUMBER (REQUIRED BY IGTUKA)               ** 89154000
**          4    - DESIRED APESFLG0 (LOG/DUMP) OPTIONS               ** 89160000
**          5    - APRLRCN VALUE (SPECIFIC ERROR NUMBER)             ** 89166000
**          6    - APRLRCT VALUE (RETURN CODE TYPE)                  ** 89172000
**          7    - RESERVED                                          ** 89178000
**                                                                   ** 89184000
*********************************************************************** 89190000
         SPACE 2                                                        89196000
MERRTBL  DS    0Y                  FIRST ENTRY IS NUMBER 1              89202000
*                                  * SO ALLOW FOR 0-TH ENTRY            89208000
         SPACE ,                                                        89214000
*                                  01 - SMF FAILURE                     89220000
         DC    Y(APCMI160)         SUPV SERV FAIL                       89226000
         DC    Y(APCMK070)         SMF                                  89232000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89238000
         DC    YL1(APCCI160)       ERROR = 160                          89244000
         DC    YL1(APCCTLOG)       LOGICAL ERROR                        89250000
         DC    YL1(*-*)            RESERVED                             89256000
         SPACE ,                                                        89262000
*                                  02 - PGFIX FAILURE                   89268000
         DC    Y(APCMI161)         SUPV SERV FAIL                       89274000
         DC    Y(APCMK057)         PGFIX                                89280000
         DC    YL1(APESFDMP)       SYSUDUMP                             89286000
         DC    YL1(APCCI161)       ERROR = 161                          89292000
         DC    YL1(APCCTLOG)       LOGICAL ERROR                        89298000
         DC    YL1(*-*)            RESERVED                             89304000
         SPACE ,                                                        89310000
*                                  03 - SUSPEND FAILURE                 89316000
         DC    Y(APCMI162)         SUPV SERV FAIL                       89322000
         DC    Y(APCMK071)         SUSPEND                              89328000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89334000
         DC    YL1(APCCI162)       ERROR = 162                          89340000
         DC    YL1(APCCTLOG)       LOGICAL ERROR                        89346000
         DC    YL1(*-*)            RESERVED                             89352000
         SPACE ,                                                        89358000
*                                  04 - INVALID APRL                    89364000
         DC    Y(APCMI163)         BAD CNTRL BLOCK                      89370000
         DC    Y(APCMK052)         APRL                                 89376000
         DC    YL1(APESFDMP)       SYSUDUMP                             89382000
         DC    YL1(APCCI163)       ERROR = 163                          89388000
         DC    YL1(APCCTICB)       INVALID CONTROL BLOCK                89394000
         DC    YL1(*-*)            RESERVED                             89400000
         SPACE ,                                                        89406000
*                                  05 - APIO ACTIVE                     89412000
         DC    Y(APCMI164)         APIO ACTIVE                          89418000
         DC    Y(APCMK000)         NO KEYWORD                           89424000
         DC    YL1(APESFDMP)       SYSUDUMP                             89430000
         DC    YL1(APCCI164)       ERROR = 164                          89436000
         DC    YL1(APCCTICB)       INVALID CONTROL BLOCK                89442000
         DC    YL1(*-*)            RESERVED                             89448000
         SPACE ,                                                        89454000
*                                  06 - CANNOT FIND PORT TO USE         89460000
         DC    Y(APCMI165)         NO PORT AVAIL                        89466000
         DC    Y(APCMK000)         NO KEYWORD                           89472000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89478000
         DC    YL1(APCCI165)       ERROR = 165                          89484000
         DC    YL1(APCCTLOG)       LOGIC ERROR                          89490000
         DC    YL1(*-*)            RESERVED                             89496000
         SPACE ,                                                        89502000
*                                  07 - 3838 RE-IPLED FOR EXCL USER     89508000
         DC    Y(APCMI166)         EXCL PORT REIPL                      89514000
         DC    Y(APCMK000)         NO KEYWORD                           89520000
         DC    YL1(APESFREC)       EREP                                 89526000
         DC    YL1(APCCI166)       ERROR = 166                          89532000
         DC    YL1(APCCTPIO)       PHYSICAL ERROR                       89538000
         DC    YL1(*-*)            RESERVED                             89544000
         SPACE ,                                                        89550000
*                                  08 - 'LRA' FAILED AFTER PGFIX        89556000
         DC    Y(APCMI167)         LOGIC ERROR                          89562000
         DC    Y(APCMK000)         NO KEYWORD                           89568000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89574000
         DC    YL1(APCCI167)       ERROR = 167                          89580000
         DC    YL1(APCCTLOG)       LOGIC ERROR                          89586000
         DC    YL1(*-*)            RESERVED                             89592000
         SPACE ,                                                        89598000
*                                  09 - APIO OVERLAID                   89604000
         DC    Y(APCMI168)         BAD CONTRL BLOCK                     89610000
         DC    Y(APCMK045)         APIO                                 89616000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89622000
         DC    YL1(APCCI168)       ERROR = 168                          89628000
         DC    YL1(APCCTICB)       INVALID CONTROL BLOCK                89634000
         DC    YL1(*-*)            RESERVED                             89640000
         SPACE ,                                                        89646000
*                                  10 - PGM CHK REFERENCING APRL        89652000
         DC    Y(APCMI169)         PGM CHK REF                          89658000
         DC    Y(APCMK052)         APRL                                 89664000
         DC    YL1(APESFDMP)       SYSUDUMP                             89670000
         DC    YL1(APCCI169)       ERROR = 169                          89676000
         DC    YL1(APCCTICB)       INVALID CONTROL BLOCK                89682000
         DC    YL1(*-*)            RESERVED                             89688000
         SPACE ,                                                        89694000
*                                  11 - FAILURE DOING RESUME            89700000
         DC    Y(APCMI170)         SUPV SERV FAIL                       89706000
         DC    Y(APCMK072)         RESUME                               89712000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89718000
         DC    YL1(APCCI170)       ERROR = 170                          89724000
         DC    YL1(APCCTLOG)       LOGIC ERROR                          89730000
         DC    YL1(*-*)            RESERVED                             89736000
         SPACE ,                                                        89742000
*                                  12 - ABEND REFERENCING APUB          89748000
         DC    Y(APCMI171)         PGM CHK REF                          89754000
         DC    Y(APCMK035)         APUB                                 89760000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89766000
         DC    YL1(APCCI171)       ERROR = 171                          89772000
         DC    YL1(APCCTICB)       INVALID CONTROL BLOCK                89778000
         DC    YL1(*-*)            RESERVED                             89784000
         SPACE ,                                                        89790000
*                                  13 - PGFREE FAILURE                  89796000
         DC    Y(APCMI172)         SUPV SERV FAIL                       89802000
         DC    Y(APCMK058)         RESUME                               89808000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89814000
         DC    YL1(APCCI172)       ERROR = 172                          89820000
         DC    YL1(APCCTLOG)       LOGIC ERROR                          89826000
         DC    YL1(*-*)            RESERVED                             89832000
        SPACE ,                                                @ZA26916 89832300
*                                  14 - ABEND REFERENCING USER CCW      89832600
         DC    Y(APCMI173)         PGM CHK REF                 @ZA26916 89832900
         DC    Y(APCMK061)         CCW                         @ZA26916 89833200
         DC    YL1(APESFDMP)       SYSUDUMP                    @ZA26916 89833500
         DC    YL1(APCCI173)       ERROR = 173                 @ZA26916 89833800
         DC    YL1(APCCTLOG)       LOGICAL ERROR               @ZA26916 89834100
         DC    YL1(*-*)            RESERVED                    @ZA26916 89834400
        SPACE ,                                                @ZA26916 89834700
*                                  15 - BAD CCW COUNT (RETRANS)@ZA26916 89835000
         DC    Y(APCMI174)         BAD CNTRL BLOCK             @ZA26916 89835300
         DC    Y(APCMK061)         CCW                         @ZA26916 89835600
         DC    YL1(APESFDMP)       SYSUDUMP                    @ZA26916 89835900
         DC    YL1(APCCI174)       ERROR = 174                 @ZA26916 89836200
         DC    YL1(APCCTLOG)       LOGICAL ERROR               @ZA26916 89836500
         DC    YL1(*-*)            RESERVED                    @ZA26916 89836800
         SPACE ,                                                        89838000
*                                  99 - ALL OTHER ABENDSSUME            89844000
         DC    Y(APCMI189)         UNEXPECTED ABEND                     89850000
         DC    Y(APCMK000)         NO KEYWORD                           89856000
         DC    YL1(APESFDMP+APESFREC+APESFSDP) SYSUDUMP + EREP + SDUMP  89862000
         DC    YL1(APCCI189)       ERROR = 189                          89868000
         DC    YL1(APCCTLOG)       LOGIC ERROR                          89874000
         DC    YL1(*-*)            RESERVED                             89880000
         EJECT ,                                                        89886000
*********************************************************************** 89892000
**                                                                   ** 89898000
**       VPSS DSECTS                                                 ** 89904000
**                                                                   ** 89910000
*********************************************************************** 89916000
         SPACE 2                                                        89922000
         IGTXDSCT IGTXAPRL         VPSS ACB REQUEST BLOCK               89928000
         IGTXDSCT IGTXAPUB         VPSS UNIT BLOCK                      89934000
         IGTXDSCT IGTXAPXL         VPSS TRANSLATE TABLE                 89940000
         IGTXDSCT IGTXAPCT         VPSS CONTROL TABLE                   89946000
         IGTXDSCT IGTXAPIO         VPSS I/O BLOCK                       89952000
         IGTXDSCT IGTXAPCC         VPSS RETURN CODES                    89958000
         IGTXDSCT IGTXAPCM         VPSS MESSAGE CODES                   89964000
         IGTXDSCT IGTXAPDX         VPSS DEB EXTENSION                   89970000
         IGTXDSCT IGTXAPDS         VPSS DATA SET DECRIPTION             89976000
         IGTXDSCT IGTXAPMF         VPSS SMF RECORD                      89982000
         IGTXDSCT IGTXAPVU         VPSS USAGE TABLE                     89988000
         EJECT ,                                                        90028000
         PRINT NOGEN                                                    90160000
         IHAPSA ,                  FIXED LOW CORE                       90230000
         PRINT GEN                                                      90300000
         EJECT ,                                                        90370000
         CVT   DSECT=YES           COMMUNICATIONS VECTOR TABLE          90440000
         EJECT ,                                                        90510000
         PRINT NOGEN                                                    90580000
         IHAPVT ,                  PAGING VECTOR TABLE                  90650000
         PRINT GEN                                                      90720000
         EJECT ,                                                        90790000
         PRINT NOGEN                                                    90860000
         IECDIOCM ,                I/O COMMUNICATIONS TABLE             90930000
         PRINT GEN                                                      91000000
         EJECT ,                                                        91070000
         PRINT NOGEN                                                    91140000
         IHAASCB ,                 ADDRESS SPACE CONTROL BLOCK          91210000
         PRINT GEN                                                      91280000
         EJECT ,                                                        91350000
         PRINT NOGEN                                                    91420000
         IHAASXB ,                 ADDRESS SPACE EXTENSION              91490000
         PRINT GEN                                                      91560000
         EJECT ,                                                        91630000
         PRINT NOGEN                                                    91700000
         IHAFRRS ,                 FUNCTIONAL RECOVERY ROUTINE STACKS   91770000
         PRINT GEN                                                      91840000
         EJECT ,                                                        91910000
         IKJTCB ,                  TASK CONTROL BLOCK                   91980000
         EJECT ,                                                        92050000
         PRINT NOGEN                                                    92120000
         IHARB ,                   REQUEST BLOCK                        92190000
         PRINT GEN                                                      92260000
         EJECT ,                                                        92330000
         IEZDEB ,                  DATA EXTENT BLOCK                    92400000
         PRINT NOGEN                                                    92410000
         IHASDWA ,                 SYSTEM DIAGNOSTIC WORKAREA           92420000
         PRINT GEN                                                      92430000
         EJECT ,                                                        92470000
         PRINT NOGEN                                                    92540000
         IHAVSL ,                  VIRTUAL STORAGE LIST (PGFIX)         92610000
         PRINT GEN                                                      92680000
         EJECT ,                                                        92750000
         PRINT NOGEN                                                    92820000
         IHAECB ,                  EVENT CONTROL BLOCK                  92890000
         PRINT GEN                                                      92960000
         EJECT ,                                                        93030000
*********************************************************************** 93100000
**                                                                    * 93170000
**       MAKE IOSB PART OF APIO CONTROL BLOCK                         * 93240000
**                                                                    * 93310000
*********************************************************************** 93380000
         SPACE 2                                                        93450000
IOSB     DSECT ,                   APIO/IOSB DSECT                      93520000
         IECDIOSB ,                I/O SUPERVISOR BLOCK (IN APIO)       93590000
         SPACE 2                                                        93660000
IOSB     DSECT ,                   APIO/IOSB DSECT                      93730000
         ORG   IOSB                APIO STARTS WITH THE IOSB            93800000
         IGTXAPIO DSECT=NO,LIST=YES APIO IS PART OF IOSB DSECT          93870000
         EJECT ,                                                        93940000
         IHASRB ,                  SRB LOCATED AT APIOSRB               94010000
         EJECT ,                                                        94080000
IGTKBA   CSECT ,                   RESUME CSECT CODE                    94150000
         IGTXEPLG ,                DSECTS/REGISTERS                     94220000
RTEMPA   EQU   R15                 WORK REGISTER                        94290000
RTEMPB   EQU   R11                 WORK REGISTER                        94360000
RTEMPC   EQU   R12                 WORK REGISTER                        94430000
RDEBPTR  EQU   R2                  DEB ADDRESS (SET ON INPUT)           94500000
RAPIONUM EQU   R2                  APRL SPECIFIED APIO INDEX            94570000
RIONBR   EQU   R2                  HOLDS APIONBR ACROSS 'CALLDISP'      94640000
*                                  * AND I/O EXECUTION                  94710000
RCVTPTR  EQU   R3                  CVT (SET ON INPUT)                   94780000
RTCBPTR  EQU   R4                  CURRENT TCB ADDRESS (SET ON INPUT)   94850000
RAPRLPTR EQU   R4                  VPSS APRL ADDRESS                    94920000
RFRRSAVE EQU   R4                  FRR POINT TO INPUT REGISTER SAVEAREA 94950000
RAPUBPTR EQU   R5                  APUB FOR THIS I/O REQUEST            94990000
RAPDXPTR EQU   R5                  VPSS DEB EXTENSION                   95060000
RSDWAPTR EQU   R5                  FRR POINT TO SDWA                    95090000
RPGFXFLG EQU   R5                  HOLDS PGFIX INDICATOR                95110000
RCODE    EQU   R6                  BASE REGISTER FOR CODE               95130000
RASCBPTR EQU   R7                  CURRENT ASCB ADDRESS (SET ON INPUT)  95200000
RVUWORK  EQU   R7                  FRR WORKAREA POINTER (IN APVU)       95230000
RFRRSTK  EQU   R8                  RECOVERY WORKAREA (DFRRSTK) BASE     95270000
RAPIOPTR EQU   R9                  VPSS APIO/IOSB/SRB BASE              95340000
RXAPDX   EQU   R11                 VPSS DEB EXTENSION (SET ON INPUT)    95410000
RXAPUB   EQU   R11                 SHARED APUB SELECT SCANNER           95480000
RVSLPTR  EQU   R11                 PSI (PGFIX) LIST SCAN REGISTER       95550000
RVSLINCR EQU   R12                 VSL ENTRY SIZE                       95620000
RVSLEND  EQU   R13                 LAST VSL ENTRY ADDRESS               95690000
*                                  * NOTE: RVSLINCR/RVSLEND MUST BE     95760000
*                                  * EVEN/ODD REGISTER PAIR (BXLE)      95830000
RAPMFPTR EQU   R15                 VPSS SMF RECORD (APMF)               95900000
         EJECT ,                                                        95970000
*********************************************************************** 96040000
**                                                                    * 96110000
**       FAKE APUB. USED BY SHARED-APUB SCAN ROUTINE.  THIS           * 96180000
**       APUB SKELETON IS USED AS INITIAL COMPARISION.  IT            * 96250000
**       IS CONSTRUCTED TO INSURE THAT ANY SELECTABLE APUB            * 96320000
**       IS BETTER THAN THIS APUB.  ALSO, IF NO APUB IS               * 96390000
**       AVAILABLE, THIS APUB WILL FAIL THE FINAL SHARED TEST         * 96460000
**                                                                    * 96530000
*********************************************************************** 96600000
         SPACE 2                                                        96670000
CAPUB    DS    0D                  INSURE ALIGNMENT                     96740000
         DC    01XL(APUBLN)'00'    UN-USED FIELDS ZERO                  96810000
         ORG   CAPUB+(APUBID-APUB) NEXT FIELD                           96880000
         DC    01CL4'APUB'         IN-CORE ID                           96950000
         ORG   CAPUB+(APUBMSTR-APUB) NEXT FIELD                         97020000
         DC    01A(CAPUB)          SUBCHANNEL-0 APUB (RE-USE THIS APUB) 97090000
         ORG   CAPUB+(APUBIOCT-APUB) NEXT FIELD                         97160000
         DC    01A(X'7FFFFFFE')    MORE OUTSTANDING I/O THAN REAL APUB  97230000
         ORG   CAPUB+(APUBMSTP-APUB) NEXT FIELD                         97300000
         DC    01A(CAPUB)          SUBCHANNEL-0 APUB (RE-USE THIS APUB) 97370000
         ORG   CAPUB+(APUBIOFG-APUB) NEXT FIELD                         97440000
         DC    01A(X'FFFFFFFF')    INSURE I/O NOT ALLOWED               97510000
         ORG   ,                   END OF APUB                          97580000
         EJECT ,                                                        97583000
*********************************************************************** 97586000
**                                                                   ** 97589000
**     USED TO INITIALIZE APES HEADER (REMAINDER IS SET TO 0).       ** 97592000
**                                                                   ** 97595000
*********************************************************************** 97598000
         SPACE 2                                                        97601000
CAPES    DC    XL(APESSDWA-APES)'00' INITIALIZE FIELDS TO ZERO @ZA25360 97604000
         ORG   APESID-APES+CAPES   GO TO FIELD TO COMPLETE              97607000
         DC    A(APESIDC)          ID FIELD (='APES')                   97610000
         ORG   APESAPMV-APES+CAPES GO TO FIELD TO COMPLETE              97613000
         DC    A(MERRTBL)          ERROR INDICATOR TABLE                97616000
         ORG   APESMXCD-APES+CAPES GO TO FIELD TO COMPLETE              97619000
         DC    AL1(CERRN99)        MAXIMUM ERROR INDEX                  97622000
         ORG   APESMOD-APES+CAPES  GO TO FIELD TO COMPLETE              97625000
         DC    CL8'IGTKBA'         MODULE IN CONTROL                    97628000
         ORG   APESPROC-APES+CAPES GO TO FIELD TO COMPLETE              97631000
         DC    CL8'IGTKBA'         MODULE IN CONTROL                    97634000
         ORG   APESFRR-APES+CAPES  GO TO FIELD TO COMPLETE              97637000
         DC    CL8'XSTAE2'         FRR IN CONTROL                       97640000
         ORG   ,                   RESET LOCATION COUNTER               97643000
         SPACE 5                                                        97650000
         END   ,                   MODULE END                           97720000
