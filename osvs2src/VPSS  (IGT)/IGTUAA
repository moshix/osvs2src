TUAA     TITLE 'IGTUAA -- GET INITIAL SAVEAREA/WORKAREA'                00300000
IGTUAA   CSECT ,                   GET INITIAL SAVEAREA - WORKAREA      00600000
*/* * START OF SPECIFICATIONS ************************************** */ 00900000
*/*                                                                  */ 01200000
*/*   MODULE-NAME = IGTUAA                                           */ 01500000
*/*                                                                  */ 01800000
*/*   DESCRIPTIVE-NAME = GET INITIAL SAVEAREA/WORKAREA               */ 02100000
*/*                      (IGTYGSV MACRO SUPPORT)                     */ 02400000
*/*                                                                  */ 02700000
*/*   COPYRIGHT = NONE                                               */ 03000000
*/*                                                                  */ 03300000
*/*   STATUS = RELEASE 1, MODIFICATION LEVEL 0.                      */ 03600000
*/*                                                                  */ 03900000
*/*   FUNCTION = THIS ROUTINE WILL PROVIDE AN INITIAL SAVEAREA-      */ 04200000
*/*       WORKAREA FOR THE CALLING ROUTINE.  SINCE THIS IS THE       */ 04500000
*/*       INITIAL SAVEAREA, A VPSS STORAGE MANAGEMENT CONTROL        */ 04800000
*/*       BLOCK MUST BE ACQUIRED.  THIS ROUTINE SUPPORTS THE         */ 05100000
*/*       IGTYGSV MACRO WITH INITIAL=YES SPECIFIED.                  */ 05400000
*/*       STORAGE MANAGEMENT IS LIFO (LAST ACQUIRED STORAGE MUST     */ 05700000
*/*       BE INITIALLY RELEASED STORAGE).                            */ 06000000
*/*                                                                  */ 06300000
*/*   NOTES =                                                        */ 06600000
*/*     THIS MACRO MUST SUPPORT PARAMETERS GENERATED BY THE          */ 06900000
*/*     GETMAIN R,LV= MACRO (USED FOR PL/S WITH STACK OPTION)        */ 07200000
*/*                                                                  */ 07500000
*/*     DEPENDENCIES =                                               */ 07800000
*/*        WORD-2 OF THE SAVEAREA POINTED TO BY INPUT REGISTER       */ 08100000
*/*        13 (THE FORWARD SAVEAREA CHAIN POINTER) MUST BE           */ 08400000
*/*        AVAILABLE FOR TEMPORARY STORAGE BY THIS ROUTINE.          */ 08700000
*/*        THIS ROUTINE ASSUMES MACRO IGTYGSV INITIAL=YES HAS        */ 09000000
*/*        ESTABLISHED THE INPUT PARAMETERS.                         */ 09300000
*/*                                                                  */ 09600000
*/*     RESTRICTIONS =                                               */ 09900000
*/*        SINCE THIS ROUTINE MAY BE ENTERED IN EITHER PROBLEM OR    */ 10200000
*/*        SUPERVISOR STATE AND IN ANY KEY, THIS PROGRAM MAY NOT     */ 10500000
*/*        ISSUE PRIVLEDGED INSTRUCTIONS OR UPDATE SYSTEM CONTROL    */ 10800000
*/*        BLOCKS.                                                   */ 11100000
*/*                                                                  */ 11400000
*/*     REGISTER-CONVENTIONS = STANDARD VPSS CONVENTIONS             */ 11700000
*/*                                                                  */ 12000000
*/*     PATCH-LABEL = APPATCH                                        */ 12300000
*/*                                                                  */ 12600000
*/*   MODULE-TYPE = CSECT                                            */ 12900000
*/*                                                                  */ 13200000
*/*     PROCESSOR = VS/2 ASSEMBLER                                   */ 13500000
*/*                                                                  */ 13800000
*/*     MODULE SIZE = SEE END OF ASSEMBLER LISTING                   */ 14100000
*/*                                                                  */ 14400000
*/*     ATTRIBUTES = RE-ENTRANT.                                     */ 14700000
*/*                                                                  */ 15000000
*/*   ENTRY-POINT = IGTUAA                                           */ 15300000
*/*                                                                  */ 15600000
*/*     PURPOSE = SAME AS FUNCTION                                   */ 15900000
*/*                                                                  */ 16200000
*/*     LINKAGE = ENTERED UNLOCKED, TASK MODE, ENABLED. MAY BE       */ 16500000
*/*               IN ANY KEY AND EITHER PROBLEM OR SUPERVISOR        */ 16800000
*/*               STATE.                                             */ 17100000
*/*                                                                  */ 17400000
*/*     INPUT = THE FOLLOWING REGISTERS ARE INITIALIZED ON ENTRY     */ 17700000
*/*             (SET BY MACRO IGTYGSV INITIAL=YES) --                */ 18000000
*/*         REGISTER  0 - BYTE-0 CONTAINS THE SUBPOOL TO CONTAIN     */ 18300000
*/*                       THE REQUESTED STORAGE. BYTES 1-3 CONTAIN   */ 18600000
*/*                       THE REQUIRED SAVEAREA/WORKAREA LENGTH.     */ 18900000
*/*         REGISTER  1 - AMOUNT OF STORAGE TO BE AVAILABLE FOR      */ 19200000
*/*                       LOWER LEVEL SAVEAREA/WORKAREAS (MACRO      */ 19500000
*/*                       DEFAULTS TO 0).                            */ 19800000
*/*         REGISTER 12 - ADDRESS OF THE APCT.                       */ 20100000
*/*         REGISTER 13 - ADDRESS OF CURRENT SAVEAREA.  WORD 2       */ 20400000
*/*                       (FORWARD CHAIN) IS USED FOR TEMPORARY      */ 20700000
*/*                       STORAGE.                                   */ 21000000
*/*         REGISTER 14 - RETURN ADDRESS                             */ 21300000
*/*         REGISTER 15 - ADDRESS OF THIS ROUTINE (IGTUAA).          */ 21600000
*/*                                                                  */ 21900000
*/*     OUTPUT = AN APSM IS CONSTRUCTED TO DESCRIBE THE ACQUIRED     */ 22200000
*/*              STORAGE.  AN APSC AND APSV ARE INITIALIZED FOR      */ 22500000
*/*              THE NEW SAVEAREA/WORKAREA.                          */ 22800000
*/*                                                                  */ 23100000
*/*   EXIT-NORMAL = THE FOLLOWING REGISTERS ARE RETURNED TO THE      */ 23400000
*/*                 CALLER --                                        */ 23700000
*/*                 REGISTER  0 - UNPREDICTABLE                      */ 24000000
*/*                 REGISTER  1 - ADDRESS OF NEW SAVEAREA            */ 24300000
*/*                 REGISTER 2-13 - SAME AS ON INPUT                 */ 24600000
*/*                 REGISTER 14 - RETURN ADDRESS                     */ 24900000
*/*                 REGISTER 15 - UNPREDICTABLE                      */ 25200000
*/*                                                                  */ 25500000
*/*   EXIT-ERROR  = NONE.                                            */ 25800000
*/*                                                                  */ 26100000
*/*   EXTERNAL-REFERENCES = THE FOLLOWING ROUTINES AND               */ 26400000
*/*                         CONTROL BLOCKS ARE USED.                 */ 26700000
*/*                                                                  */ 27000000
*/*     ROUTINES = NONE.                                             */ 27300000
*/*                                                                  */ 27600000
*/*     DATA-AREAS = NONE                                            */ 27900000
*/*                                                                  */ 28200000
*/*     CONTROL-BLOCKS =                                             */ 28500000
*/*         APCT     - R                                             */ 28800000
*/*         APSC     - R,       C                                    */ 29100000
*/*         APSM     - R,       C                                    */ 29400000
*/*         APSV     - R,       C                                    */ 29700000
*/*                                                                  */ 30000000
*/*   TABLES = NONE                                                  */ 30300000
*/*                                                                  */ 30600000
*/*   MACROS =                                                       */ 30900000
*/*       IGTXEPLG                                                   */ 31200000
*/*       GETMAIN                                                    */ 31500000
*/*                                                                  */ 31800000
*/*   CHANGE-ACTIVITY = NONE                                         */ 32100000
*/*                                                                  */ 32400000
*/*   MESSAGES = NONE                                                */ 32700000
*/*                                                                  */ 33000000
*/*   ABEND-CODES = NONE                                             */ 33300000
*/*                                                                  */ 33600000
*/* * END OF SPECIFICATIONS **************************************** */ 33900000
         SPACE 3                                                        34200000
         COPY  IGTXSYSO            DEFINE SCP CHARACTERISTICS           34500000
         EJECT ,                                                        34800000
         USING APCT,APCTPTR        VPSS CONTROL TABLE                   35100000
         USING APSV,APSVPTR        VPSS SAVE AREA                       35400000
         USING IGTUAA,APENTRY      BASE REGISTER FOR IGTUAA             35700000
         B     STARTUP             SKIP IDENTIFIER                      36000000
         DC    YL1(COREIDE-*-1)    LENGTH OF ID                         36300000
         DC    C'IGTUAA'           CSECT NAME                           36600000
         DC    C' &SYSDATE'        ASSEMBLY DATE                        36900000
COREIDE  EQU   *                   END OF ID                            37200000
         SPACE 2                                                        37500000
STARTUP  DS    0H                  START OF CODE                        37800000
*                                                                       38100000
** SAVE INPUT REQUIREMENTS                                              38400000
*                                                                       38700000
         ST    RCORESZ,SVUSP       BYTE-0 = SUBPOOL FOR GETMAIN         39000000
         AL    RCORESZ,CEXTRA      ADD EXTRA STORAGE REQUIREMENTS       39300000
*                                  * FOR THE APSC, THE APSM             39600000
*                                  * HEADER AND FOR THE                 39900000
*                                  * REGISTER SAVE AREA                 40200000
         N     RCORESZ,CRND8       ROUND TO DOUBLEWORD BOUNDARY         40500000
         STH   RCORESZ,SVUREQ      SAVE ACTUAL USER REQUIREMENTS        40800000
*                                                                       41100000
** DETERMINE GETMAIN SIZE.  USE MAXIMUM OF:                             41400000
**       A)  R0+R1 (MINIMUM+EXTRA), AND                                 41700000
**       B)  APCTSMIN.                                                  42000000
*                                                                       42300000
         AR    RCORESZ,REXTRASZ    GET USER + EXTRA STORAGE             42600000
         C     RCORESZ,APCTSMIN    IF LESS THAN APCT                    42900000
         BNL   GETCORE             * SPECIFIED MINIMUM,                 43200000
         L     RCORESZ,APCTSMIN    * THEN USE APCT VALUE                43500000
*                                                                       43800000
** GET THE REQUIRED STORAGE                                             44100000
*                                                                       44400000
GETCORE  EQU   *                   * GET REQUIRED STORAGE               44700000
         A     RCORESZ,CARNDPGE    ROUND REQUIREMENTS                   45000000
         N     RCORESZ,CRNDPGE     * TO PAGE INCREMENTS.                45300000
         STCM  RCORESZ,BYTE2,SVAREQ SAVE NUMBER OF 256-BYTE BLOCKS      45600000
         AIF   ('&VPSSSYS' NE 'MVS').VS1A IF MVS SYSTEM USE SVC 120     45900000
         BALR  RTEMPB,*-*          ESTABLISH TEMPORARY BASE             46200000
         USING *,RTEMPB            TELL ASSEMBLER                       46500000
         IC    R15,SVUSP           SUBPOOL IN LOW REG 15                46800000
         GETMAIN RU,               UNCONDITIONALLY OBTAIN STORAGE      *47100000
               LV=(0),             * LENGTH IN REGISTER 0              *47400000
               SP=(15),            * SUBPOOL IN REG 15                 *47700000
               BNDRY=PAGE          * START ON PAGE BOUNDARY             48000000
         DROP  RTEMPB              TEMPORARY BASE CLOBBERED             48300000
         AGO   .SYSA               * SKIP VS1 GETMAIN REQUEST           48600000
.VS1A    ANOP  ,                   GENERATE VS1 SYSTEM GETMAIN          48900000
         ICM   RCORESZ,BYTE0,SVUSP PLACE SUBPOOL IN HI-BYTE             49200000
         GETMAIN R,LV=(0)          GET REQUESTED STORAGE                49500000
.SYSA    ANOP  ,                   GETMAIN REQUEST GENERATED            49800000
*                                  * REG 1 -> ACQUIRED AREA             50100000
         BALR  APENTRY,*-*         RE-ESTABLISH BASE REGISTER           50400000
         USING *,APENTRY                                                50700000
*                                                                       51000000
** CONSTRUCT APSM                                                       51300000
*                                                                       51600000
         USING APSM,APSMPTR        USE TO CONSTRUCT APSM                51900000
         L     RTEMPA,CID          FILL IN STORAGE IDENTIFIER           52200000
         ST    RTEMPA,APSMID       * ('APSM')                           52500000
         SR    RTEMPA,RTEMPA       SET FOLLOWING INDICATORS TO 0:       52800000
         ST    RTEMPA,APSMNEXT     * NO 'NEXT' APSM                     53100000
         ST    RTEMPA,APSMPREV     * NO 'PREVIOUS' APSM                 53400000
         ST    RTEMPA,APSMAPSV     * NO 'PREVIOUS' APSM OWNED           53700000
*                                  * BY THIS APSV                       54000000
         LA    RTEMPA,APSMSAVE     POINT APSM TO STORAGE                54300000
         ST    RTEMPA,APSMREGS     * MANAGEMENT REGISTER SAVEAREA       54600000
         SR    RTEMPA,RTEMPA       CLEAR REGISTER FOR CHAR INSERT       54900000
         ICM   RTEMPA,BYTE0,SVUSP  LENGTH AND SUBPOOL OF                55200000
         ICM   RTEMPA,BYTE2,SVAREQ * THIS GETMAIN. USED FOR FREEMAIN    55500000
         ST    RTEMPA,APSMSIZE     * AND FUTURE GETMAINS.               55800000
*                                                                       56100000
** CONSTRUCT APSC                                                       56400000
*                                                                       56700000
         USING APSC-APSMLN1,APSMPTR TELL ASM WHERE APSC IS              57000000
         SH    RTEMPA,CAPSMLN1     SET APSCMXSZ TO MAXIMUM SIZE         57300000
         STH   RTEMPA,APSCMXSZ     * (APSM NOT COUNTED)                 57600000
         LH    RTEMPA,SVUREQ       SET APSCCRSZ TO CURRENT SA-WA        57900000
         SH    RTEMPA,CAPSMLN1     * SIZE (APSM NOT COUNTED).           58200000
         STH   RTEMPA,APSCCRSZ     *                                    58500000
         SR    RTEMPA,RTEMPA       SHOW NO PREVIOUS APSC EXISTS         58800000
         ST    RTEMPA,APSCAPSC     * FOR THIS APSC.                     59100000
*                                                                       59400000
** CONSTRUCT APSV                                                       59700000
*                                                                       60000000
         DROP  APSVPTR             TO PREVENT ASM FROM USING            60300000
         USING APSV-APSMLN1-APSCLN,APSMPTR TELL ASM OF APSC LOCATION    60600000
         ST    APSMPTR,APSVAPSM    POINT TO CURRENT APSM                60900000
         ST    APSMPTR,APSVFREE    FREE APSM AT SUBROUTINE TERMINATION  61200000
         LA    APSCPTR,APSMLN1(,APSMPTR) SKIP HEADER AND REGISTERS      61500000
*                                  NOW POINTING AT APSC                 61800000
         USING APSV-APSCLN,APSCPTR TELL ASM OF APSV LOCATION            62100000
         ST    APSCPTR,APSVAPSC    SAVE POINTER TO CURRENT APSC         62400000
         LA    RNEWAPSV,APSCLN(,APSCPTR) POINT TO NEW                   62700000
*                                  * SAVEAREA/WORKAREA                  63000000
         BR    APRETURN            RETURN ITS ADDRESS TO CALLER         63300000
         EJECT ,                                                        63600000
********************************************************************* * 63900000
**                                                                    * 64200000
**       CONSTANTS                                                    * 64500000
**                                                                    * 64800000
********************************************************************* * 65100000
         SPACE 2                                                        65400000
CAPSMLN1 DC    Y(APSMLN1)          LENGTH OF INITIAL APSM               65700000
*                                  * (INCLUDES REGISTER SAVEAREA)       66000000
CEXTRA   DC    A(APSCLN+APSMLN1+7) ALLOW FOR INITIAL APSM, THE APSC     66300000
*                                  * AND FOR ROUNDING                   66600000
CRND8    DC    A(X'00007FF8')      ROUND TO DOUBLEWORD,                 66900000
*                                  * ELIMINATE SUBPOOL                  67200000
         AIF   ('&VPSSSYS' NE 'MVS').VS1B IF MVS PAGE = 4K              67500000
CARNDPGE DC    A(X'00000FFF')      ROUND UPWARD TO 4K BOUNDARY          67800000
CRNDPGE  DC    A(X'00007000')      ROUND TO 4K BOUNDARY                 68100000
         AGO   .SYSB               SKIP VS1 VALUES                      68400000
.VS1B    ANOP  ,                   GENERATE VS1 VALUES                  68700000
CARNDPGE DC    A(X'000007FF')      ROUND UPWARD TO 2K BOUNDARY          69000000
CRNDPGE  DC    A(X'00007800')      ROUND TO 2K BOUNDARY                 69300000
.SYSB    ANOP  ,                   PAGE ROUND VALUES GENERATED          69600000
CID      DC    CL4'APSM'           CONTROL BLOCK ID. MUST BE            69900000
*                                  * ON FULLWORD BOUNDARY.              70200000
         SPACE 5                                                        70500000
********************************************************************* * 70800000
**                                                                    * 71100000
**       BYTE EQUATES FOR ICM/CLM/STCM                                * 71400000
**                                                                    * 71700000
********************************************************************* * 72000000
         SPACE 2                                                        72300000
BYTE0    EQU   B'1000'             USE BYTE 0                           72600000
BYTE1    EQU   B'0100'             USE BYTE 1                           72900000
BYTE2    EQU   B'0010'             USE BYTE 2                           73200000
BYTE3    EQU   B'0001'             USE BYTE 3                           73500000
         SPACE 5                                                        73800000
********************************************************************* * 74100000
**                                                                    * 74400000
**       DEFINE REQUESTED VPSS DSECTS                                 * 74700000
**                                                                    * 75000000
********************************************************************* * 75300000
         SPACE 2                                                        75600000
         IGTXDSCT IGTXAPCT         CONTROL TABLE                        75900000
         IGTXDSCT IGTXAPSC         STORAGE MANAGEMENT CONTROL WORD      76200000
         IGTXDSCT IGTXAPSM         STORAGE MANAGEMENT CONTROL BLOCK     76500000
         IGTXDSCT IGTXAPSV         SAVEAREA/WORKAREA                    76800000
         EJECT ,                                                        77100000
         IGTXEPLG ,                REGISTERS & DSECTS                   77400000
RCORESZ  EQU   R0                  REQUESTED DYNAMIC STORAGE SIZE       77700000
RTEMPA   EQU   R0                  TEMPORARY VALUE HOLDER               78000000
RTEMPB   EQU   R1                  TEMPORARY BASE (MVS ONLY)            78300000
REXTRASZ EQU   R1                  EXTRA DYNAMIC STORAGE SIZE           78600000
*                                  * WHICH MUST BE ALLOCATED FOR        78900000
*                                  * FUTURE SAVEAREAS/WORKAREAS         79200000
RNEWAPSV EQU   R1                  RETURN POINTER TO USER'S             79500000
*                                  * ACQUIRED AREA                      79800000
         SPACE 5                                                        80100000
********************************************************************* * 80400000
**                                                                    * 80700000
**       RE-DEFINE APSVNEXT FOR TEMPORARY WORKAREA                    * 81000000
**                                                                    * 81300000
********************************************************************* * 81600000
         SPACE 2                                                        81900000
SVUSP    EQU   APSVNEXT+0,1,C'X'   SUBPOOL FOR SA-WA                    82200000
SVAREQ   EQU   APSVNEXT+1,1,C'X'   ACTUAL GETMAIN SIZE (IN 256-BYTES)   82500000
SVUREQ   EQU   APSVNEXT+2,2,C'H'   USER REQUESTED LENGTH                82800000
         SPACE 5                                                        83100000
         END   ,                                                        83400000
